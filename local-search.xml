<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>kubebuilderåˆ›å»ºoperatoræµç¨‹</title>
    <link href="/2025/09/16/kubebuilder%E5%88%9B%E5%BB%BAoperator%E6%B5%81%E7%A8%8B/"/>
    <url>/2025/09/16/kubebuilder%E5%88%9B%E5%BB%BAoperator%E6%B5%81%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h3 id="å¼€å‘æµç¨‹è¯¦è§£ï¼ˆä»¥-Kubebuilder-ä¸ºä¾‹ï¼‰"><a href="#å¼€å‘æµç¨‹è¯¦è§£ï¼ˆä»¥-Kubebuilder-ä¸ºä¾‹ï¼‰" class="headerlink" title="å¼€å‘æµç¨‹è¯¦è§£ï¼ˆä»¥ Kubebuilder ä¸ºä¾‹ï¼‰"></a>å¼€å‘æµç¨‹è¯¦è§£ï¼ˆä»¥ Kubebuilder ä¸ºä¾‹ï¼‰</h3><p>æˆ‘ä»¬å°†é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥è¯´æ˜ï¼šå¼€å‘ä¸€ä¸ªåä¸º <code>Guestbook</code> çš„ Operatorã€‚ç”¨æˆ·åˆ›å»ºä¸€ä¸ª <code>Guestbook</code> èµ„æºæ—¶ï¼ŒOperator ä¼šè‡ªåŠ¨ä¸ºæˆ‘ä»¬éƒ¨ç½²ä¸€ä¸ª Redis ä¸»å®ä¾‹å’Œä¸€ä¸ª Redis ä»å®ä¾‹ã€‚</p><h4 id="é˜¶æ®µä¸€ï¼šç¯å¢ƒå‡†å¤‡"><a href="#é˜¶æ®µä¸€ï¼šç¯å¢ƒå‡†å¤‡" class="headerlink" title="é˜¶æ®µä¸€ï¼šç¯å¢ƒå‡†å¤‡"></a>é˜¶æ®µä¸€ï¼šç¯å¢ƒå‡†å¤‡</h4><ol><li><strong>å®‰è£…å¿…å¤‡å·¥å…·</strong>ï¼š<ul><li><code>go</code>ï¼š Golang å¼€å‘ç¯å¢ƒã€‚</li><li><code>docker</code>ï¼š ç”¨äºæ„å»º Operator çš„å®¹å™¨é•œåƒã€‚</li><li><code>kubectl</code>ï¼š ä¸ Kubernetes é›†ç¾¤äº¤äº’ã€‚</li><li><code>kustomize</code>ï¼š Kubebuilder ç”¨æ¥é…ç½®éƒ¨ç½² YAML çš„å·¥å…·ï¼ˆé€šå¸¸åŒ…å«åœ¨ <code>kubebuilder</code> å®‰è£…åŒ…ä¸­ï¼‰ã€‚</li><li>**<code>kubebuilder</code>**ï¼š æ ¸å¿ƒæ¡†æ¶å·¥å…·ã€‚è·Ÿéš<a href="https://github.com/kubernetes-sigs/kubebuilder">å®˜æ–¹æ–‡æ¡£</a>å®‰è£…ã€‚</li></ul></li><li><strong>å‡†å¤‡ä¸€ä¸ª Kubernetes é›†ç¾¤</strong>ï¼š<ul><li>å¯ä»¥ä½¿ç”¨ Minikubeã€Kindï¼ˆDocker in Dockerï¼‰æˆ–ä»»ä½•å¼€å‘æµ‹è¯•é›†ç¾¤ã€‚</li></ul></li></ol><h4 id="é˜¶æ®µäºŒï¼šåˆå§‹åŒ–é¡¹ç›®"><a href="#é˜¶æ®µäºŒï¼šåˆå§‹åŒ–é¡¹ç›®" class="headerlink" title="é˜¶æ®µäºŒï¼šåˆå§‹åŒ–é¡¹ç›®"></a>é˜¶æ®µäºŒï¼šåˆå§‹åŒ–é¡¹ç›®</h4><p>bash</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ›å»ºé¡¹ç›®ç›®å½•å¹¶è¿›å…¥</span><br><span class="hljs-built_in">mkdir</span> guestbook-operator<br><span class="hljs-built_in">cd</span> guestbook-operator<br><br><span class="hljs-comment"># ä½¿ç”¨ go mod åˆå§‹åŒ–é¡¹ç›®</span><br>go mod init guestbook-operator<br><br><span class="hljs-comment"># ä½¿ç”¨ kubebuilder åˆå§‹åŒ–é¡¹ç›®è„šæ‰‹æ¶</span><br><span class="hljs-comment"># å‚æ•°è¯´æ˜ï¼š--domain æŒ‡å®š API ç»„ï¼Œæ‰€æœ‰ API éƒ½å°†å±äºè¿™ä¸ªåŸŸ</span><br><span class="hljs-comment">#          --repo æŒ‡å®š go mod çš„æ¨¡å—å</span><br>kubebuilder init --domain my.domain.com --repo guestbook-operator<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‘½ä»¤ä¼šç”Ÿæˆå¤§é‡çš„é¡¹ç›®åŸºç¡€æ–‡ä»¶ï¼ŒåŒ…æ‹¬ <code>main.go</code>ï¼ˆOperator çš„å…¥å£ï¼‰ã€<code>go.mod</code> ä¾èµ–ç®¡ç†ã€ä»¥åŠåŸºæœ¬çš„ <code>Makefile</code> ç”¨äºæ„å»ºå’Œéƒ¨ç½²ã€‚</p><h4 id="é˜¶æ®µä¸‰ï¼šåˆ›å»º-APIï¼ˆå®šä¹‰-CRDï¼‰"><a href="#é˜¶æ®µä¸‰ï¼šåˆ›å»º-APIï¼ˆå®šä¹‰-CRDï¼‰" class="headerlink" title="é˜¶æ®µä¸‰ï¼šåˆ›å»º APIï¼ˆå®šä¹‰ CRDï¼‰"></a>é˜¶æ®µä¸‰ï¼šåˆ›å»º APIï¼ˆå®šä¹‰ CRDï¼‰</h4><p>è¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå®šä¹‰è‡ªå®šä¹‰èµ„æº <code>Guestbook</code> çš„â€œæ¨¡æ ·â€ã€‚</p><p>bash</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªæ–°çš„ APIï¼ˆKindï¼‰å’Œæ§åˆ¶å™¨</span><br><span class="hljs-comment"># å‚æ•°è¯´æ˜ï¼š--group æŒ‡å®šAPIç»„ï¼ˆwebappï¼‰ï¼Œ--version æŒ‡å®šç‰ˆæœ¬ï¼ˆv1ï¼‰ï¼Œ--kind æŒ‡å®šèµ„æºç±»å‹ï¼ˆGuestbookï¼‰</span><br><span class="hljs-comment">#          --plural æŒ‡å®šèµ„æºå¤æ•°å½¢å¼ï¼ˆå¯é€‰ï¼Œé€šå¸¸æ¡†æ¶ä¼šè‡ªåŠ¨ç”Ÿæˆï¼‰</span><br>kubebuilder create api --group webapp --version v1 --kind Guestbook<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œè¿™ä¸ªå‘½ä»¤åï¼Œå®ƒä¼šé—®ä½ ä¸¤ä¸ªé—®é¢˜ï¼š</p><ol><li><code>Create Resource [y/n]</code>? <strong>y</strong> (æˆ‘ä»¬è¦åˆ›å»ºèµ„æº)</li><li><code>Create Controller [y/n]</code>? <strong>y</strong> (æˆ‘ä»¬ä¹Ÿè¦åˆ›å»ºæ§åˆ¶å™¨)</li></ol><p><strong>å®Œæˆåï¼Œä½ éœ€è¦ä¿®æ”¹ç”Ÿæˆçš„æ–‡ä»¶æ¥å®šä¹‰ä½ çš„ API ç»“æ„ï¼š</strong></p><p>ä¸»è¦ä¿®æ”¹çš„æ–‡ä»¶æ˜¯ <code>api/v1/guestbook_types.go</code>ã€‚è¿™é‡Œæˆ‘ä»¬ä¸º <code>Guestbook</code> èµ„æºæ·»åŠ  <code>Spec</code>ï¼ˆæœŸæœ›çš„çŠ¶æ€ï¼‰å’Œ <code>Status</code>ï¼ˆå®é™…çš„çŠ¶æ€ï¼‰ã€‚</p><p>go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// api/v1/guestbook_types.go</span><br><span class="hljs-keyword">package</span> v1<br><br><span class="hljs-keyword">import</span> (<br>metav1 <span class="hljs-string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span><br>)<br><br><span class="hljs-comment">// ç¼–è¾‘è¿™ä¸ªæ–‡ä»¶ï¼è¿™æ˜¯ä½ çš„ä¸“å±APIã€‚</span><br><span class="hljs-comment">// æ³¨æ„ï¼šjson æ ‡ç­¾æ˜¯å¿…é¡»çš„ã€‚ä»»ä½•ä½ æ·»åŠ çš„ä»»ä½•å­—æ®µéƒ½å¿…é¡»æœ‰ json æ ‡ç­¾ã€‚</span><br><br><span class="hljs-comment">// GuestbookSpec å®šä¹‰äº†ç”¨æˆ·çš„æœŸæœ›çŠ¶æ€ï¼ˆDesired Stateï¼‰</span><br><span class="hljs-keyword">type</span> GuestbookSpec <span class="hljs-keyword">struct</span> &#123;<br><span class="hljs-comment">// +kubebuilder:validation:Minimum=1</span><br><span class="hljs-comment">// +kubebuilder:validation:Maximum=10</span><br><span class="hljs-comment">// Replicas æ˜¯ Redis ä»å®ä¾‹çš„æ•°é‡</span><br>Replicas *<span class="hljs-type">int32</span> <span class="hljs-string">`json:&quot;replicas,omitempty&quot;`</span><br><br><span class="hljs-comment">// å¯ä»¥æ·»åŠ æ›´å¤šå­—æ®µï¼Œä¾‹å¦‚ï¼š</span><br><span class="hljs-comment">// Image string `json:&quot;image,omitempty&quot;`</span><br><span class="hljs-comment">// Resources ResourceRequirements `json:&quot;resources,omitempty&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// GuestbookStatus å®šä¹‰äº†è§‚å¯Ÿåˆ°çš„å®é™…çŠ¶æ€ï¼ˆActual Stateï¼‰</span><br><span class="hljs-comment">// ç”±æ§åˆ¶å™¨æ›´æ–°å’Œç»´æŠ¤</span><br><span class="hljs-keyword">type</span> GuestbookStatus <span class="hljs-keyword">struct</span> &#123;<br><span class="hljs-comment">// é‡è¦çš„ï¼šè¿è¡Œ &quot;make&quot; æ¥é‡æ–°ç”Ÿæˆä»£ç  after modifying this file</span><br><br><span class="hljs-comment">// Conditions ä»£è¡¨äº†æœ€æ–°çš„å¯ç”¨çŠ¶æ€è§‚å¯Ÿ</span><br>Conditions []metav1.Condition <span class="hljs-string">`json:&quot;conditions,omitempty&quot;`</span><br><br><span class="hljs-comment">// å¯ä»¥æ·»åŠ æ›´å¤šçŠ¶æ€å­—æ®µï¼Œä¾‹å¦‚ï¼š</span><br><span class="hljs-comment">// AvailableReplicas int32 `json:&quot;availableReplicas&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// +kubebuilder:object:root=true</span><br><span class="hljs-comment">// +kubebuilder:subresource:status</span><br><span class="hljs-comment">// +kubebuilder:printcolumn:name=&quot;Replicas&quot;,type=&quot;integer&quot;,JSONPath=&quot;.spec.replicas&quot;</span><br><span class="hljs-comment">// +kubebuilder:printcolumn:name=&quot;Age&quot;,type=&quot;date&quot;,JSONPath=&quot;.metadata.creationTimestamp&quot;</span><br><br><span class="hljs-comment">// Guestbook æ˜¯ Guestbook API çš„ Schema</span><br><span class="hljs-keyword">type</span> Guestbook <span class="hljs-keyword">struct</span> &#123;<br>metav1.TypeMeta   <span class="hljs-string">`json:&quot;,inline&quot;`</span><br>metav1.ObjectMeta <span class="hljs-string">`json:&quot;metadata,omitempty&quot;`</span><br><br>Spec   GuestbookSpec   <span class="hljs-string">`json:&quot;spec,omitempty&quot;`</span><br>Status GuestbookStatus <span class="hljs-string">`json:&quot;status,omitempty&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// +kubebuilder:object:root=true</span><br><br><span class="hljs-comment">// GuestbookList åŒ…å«äº†ä¸€ä¸ª Guestbook å¯¹è±¡çš„åˆ—è¡¨</span><br><span class="hljs-keyword">type</span> GuestbookList <span class="hljs-keyword">struct</span> &#123;<br>metav1.TypeMeta <span class="hljs-string">`json:&quot;,inline&quot;`</span><br>metav1.ListMeta <span class="hljs-string">`json:&quot;metadata,omitempty&quot;`</span><br>Items           []Guestbook <span class="hljs-string">`json:&quot;items&quot;`</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>SchemeBuilder.Register(&amp;Guestbook&#123;&#125;, &amp;GuestbookList&#123;&#125;)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä¿®æ”¹å®Œ <code>\*_types.go</code> æ–‡ä»¶åï¼Œå¿…é¡»è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥ç”Ÿæˆä»£ç ï¼š</strong></p><p>bash</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">make generate<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‘½ä»¤ä¼šæ ¹æ®ä½ çš„ç±»å‹å®šä¹‰ï¼ˆåŒ…æ‹¬é‚£äº› <code>+kubebuilder</code> æ³¨é‡Šï¼‰ï¼Œç”Ÿæˆæ·±æ‹·è´æ–¹æ³•ç­‰è¾…åŠ©ä»£ç ã€‚</p><p>bash</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">make manifests<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‘½ä»¤ä¼šç”Ÿæˆ CRD çš„ YAML å®šä¹‰æ–‡ä»¶ï¼ˆåœ¨ <code>config/crd/bases/</code> ç›®å½•ä¸‹ï¼‰ã€‚å®ƒä¹Ÿä¼šè¯»å–æ³¨é‡Šï¼Œä¾‹å¦‚ <code>+kubebuilder:subresource:status</code> ä¼šä¸º CRD ç”Ÿæˆ status å­èµ„æºã€‚</p><h4 id="é˜¶æ®µå››ï¼šå®ç°æ§åˆ¶å™¨é€»è¾‘ï¼ˆReconcile-Loopï¼‰"><a href="#é˜¶æ®µå››ï¼šå®ç°æ§åˆ¶å™¨é€»è¾‘ï¼ˆReconcile-Loopï¼‰" class="headerlink" title="é˜¶æ®µå››ï¼šå®ç°æ§åˆ¶å™¨é€»è¾‘ï¼ˆReconcile Loopï¼‰"></a>é˜¶æ®µå››ï¼šå®ç°æ§åˆ¶å™¨é€»è¾‘ï¼ˆReconcile Loopï¼‰</h4><p>ç°åœ¨æˆ‘ä»¬è¦åœ¨ <code>controllers/guestbook_controller.go</code> æ–‡ä»¶ä¸­ç¼–å†™æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€‚</p><p><strong>ä½ çš„ä»»åŠ¡ï¼šå®ç° <code>Reconcile</code> å‡½æ•°ã€‚</strong></p><p>æ¡†æ¶å·²ç»ç”Ÿæˆäº†åŸºæœ¬çš„è°ƒå’Œå¾ªç¯ç»“æ„ã€‚ä½ éœ€è¦å¡«å†™çš„æ˜¯â€œå½“å‘ç°æœŸæœ›çŠ¶æ€å’Œå®é™…çŠ¶æ€ä¸ä¸€è‡´æ—¶ï¼Œè¯¥åšä»€ä¹ˆâ€ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// controllers/guestbook_controller.go</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *GuestbookReconciler)</span></span> Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, <span class="hljs-type">error</span>) &#123;<br>log := log.FromContext(ctx)<br><br><span class="hljs-comment">// 1. è·å– Guestbook å®ä¾‹ï¼ˆCRï¼‰</span><br><span class="hljs-comment">// é¦–å…ˆï¼Œæˆ‘ä»¬é€šè¿‡ Name å’Œ Namespace è·å–ç”¨æˆ·åˆ›å»ºçš„ Guestbook å¯¹è±¡ã€‚</span><br><span class="hljs-keyword">var</span> guestbook webappv1.Guestbook<br><span class="hljs-keyword">if</span> err := r.Get(ctx, req.NamespacedName, &amp;guestbook); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-comment">// å¦‚æœæ‰¾ä¸åˆ°ï¼ˆå¯èƒ½è¢«åˆ é™¤äº†ï¼‰ï¼Œå°±è¿”å›</span><br><span class="hljs-keyword">return</span> ctrl.Result&#123;&#125;, client.IgnoreNotFound(err)<br>&#125;<br><br><span class="hljs-comment">// 2. æ£€æŸ¥å¹¶åˆ›å»º Redis ä¸»å®ä¾‹ Deployment</span><br>redisMasterDeployment := &amp;appsv1.Deployment&#123;&#125;<br>err := r.Get(ctx, types.NamespacedName&#123;Name: <span class="hljs-string">&quot;redis-master&quot;</span>, Namespace: req.Namespace&#125;, redisMasterDeployment)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &amp;&amp; apierrors.IsNotFound(err) &#123;<br><span class="hljs-comment">// æ‰¾ä¸åˆ°ï¼Œéœ€è¦åˆ›å»º</span><br>dep := r.redisMasterDeploymentForGuestbook(&amp;guestbook)<br>log.Info(<span class="hljs-string">&quot;Creating a new Redis Master Deployment&quot;</span>, <span class="hljs-string">&quot;Deployment.Namespace&quot;</span>, dep.Namespace, <span class="hljs-string">&quot;Deployment.Name&quot;</span>, dep.Name)<br><span class="hljs-keyword">if</span> err := r.Create(ctx, dep); err != <span class="hljs-literal">nil</span> &#123;<br>log.Error(err, <span class="hljs-string">&quot;Failed to create new Redis Master Deployment&quot;</span>)<br><span class="hljs-keyword">return</span> ctrl.Result&#123;&#125;, err<br>&#125;<br><span class="hljs-comment">// åˆ›å»ºæˆåŠŸï¼Œå¯ä»¥è¿”å›å¹¶ç­‰å¾…ä¸‹ä¸€æ¬¡è°ƒå’Œ</span><br><span class="hljs-keyword">return</span> ctrl.Result&#123;Requeue: <span class="hljs-literal">true</span>&#125;, <span class="hljs-literal">nil</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Error(err, <span class="hljs-string">&quot;Failed to get Redis Master Deployment&quot;</span>)<br><span class="hljs-keyword">return</span> ctrl.Result&#123;&#125;, err<br>&#125;<br><br><span class="hljs-comment">// 3. æ£€æŸ¥å¹¶åˆ›å»º Redis ä»å®ä¾‹ Deploymentï¼ˆæ•°é‡ç”± spec.replicas å†³å®šï¼‰</span><br>redisReplicaDeployment := &amp;appsv1.Deployment&#123;&#125;<br>err = r.Get(ctx, types.NamespacedName&#123;Name: <span class="hljs-string">&quot;redis-replica&quot;</span>, Namespace: req.Namespace&#125;, redisReplicaDeployment)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &amp;&amp; apierrors.IsNotFound(err) &#123;<br><span class="hljs-comment">// æ‰¾ä¸åˆ°ï¼Œéœ€è¦åˆ›å»º</span><br>dep := r.redisReplicaDeploymentForGuestbook(&amp;guestbook)<br>log.Info(<span class="hljs-string">&quot;Creating a new Redis Replica Deployment&quot;</span>, <span class="hljs-string">&quot;Deployment.Namespace&quot;</span>, dep.Namespace, <span class="hljs-string">&quot;Deployment.Name&quot;</span>, dep.Name)<br><span class="hljs-keyword">if</span> err := r.Create(ctx, dep); err != <span class="hljs-literal">nil</span> &#123;<br>log.Error(err, <span class="hljs-string">&quot;Failed to create new Redis Replica Deployment&quot;</span>)<br><span class="hljs-keyword">return</span> ctrl.Result&#123;&#125;, err<br>&#125;<br><span class="hljs-keyword">return</span> ctrl.Result&#123;Requeue: <span class="hljs-literal">true</span>&#125;, <span class="hljs-literal">nil</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Error(err, <span class="hljs-string">&quot;Failed to get Redis Replica Deployment&quot;</span>)<br><span class="hljs-keyword">return</span> ctrl.Result&#123;&#125;, err<br>&#125;<br><br><span class="hljs-comment">// 4. ï¼ˆå¯é€‰ï¼‰æ£€æŸ¥ä»å®ä¾‹çš„å‰¯æœ¬æ•°æ˜¯å¦ä¸ spec.replicas ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´ï¼Œåˆ™æ›´æ–°</span><br>replicas := guestbook.Spec.Replicas<br><span class="hljs-keyword">if</span> *replicas != *redisReplicaDeployment.Spec.Replicas &#123;<br>log.Info(<span class="hljs-string">&quot;Updating Redis Replica Deployment replicas&quot;</span>, <span class="hljs-string">&quot;Old&quot;</span>, *redisReplicaDeployment.Spec.Replicas, <span class="hljs-string">&quot;New&quot;</span>, *replicas)<br>redisReplicaDeployment.Spec.Replicas = replicas<br><span class="hljs-keyword">if</span> err := r.Update(ctx, redisReplicaDeployment); err != <span class="hljs-literal">nil</span> &#123;<br>log.Error(err, <span class="hljs-string">&quot;Failed to update Redis Replica Deployment&quot;</span>)<br><span class="hljs-keyword">return</span> ctrl.Result&#123;&#125;, err<br>&#125;<br><span class="hljs-keyword">return</span> ctrl.Result&#123;Requeue: <span class="hljs-literal">true</span>&#125;, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// 5. ï¼ˆå¯é€‰ï¼‰æ›´æ–° Status</span><br><span class="hljs-comment">// guestbook.Status.Conditions = ... </span><br><span class="hljs-comment">// if err := r.Status().Update(ctx, &amp;guestbook); err != nil &#123;</span><br><span class="hljs-comment">// log.Error(err, &quot;Failed to update Guestbook status&quot;)</span><br><span class="hljs-comment">// return ctrl.Result&#123;&#125;, err</span><br><span class="hljs-comment">// &#125;</span><br><br><span class="hljs-comment">// 6. ä¸€åˆ‡æ­£å¸¸ï¼Œæ— éœ€ç«‹å³é‡æ–°æ’é˜Ÿ</span><br><span class="hljs-keyword">return</span> ctrl.Result&#123;&#125;, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// è¾…åŠ©å‡½æ•°ï¼šä¸º Guestbook åˆ›å»º Redis Master Deployment çš„å®šä¹‰</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *GuestbookReconciler)</span></span> redisMasterDeploymentForGuestbook(g *webappv1.Guestbook) *appsv1.Deployment &#123;<br><span class="hljs-comment">// ... è¿™é‡Œéœ€è¦ä½ è¿”å›ä¸€ä¸ªå®Œæ•´çš„ appsv1.Deployment å¯¹è±¡å®šä¹‰ã€‚</span><br><span class="hljs-comment">// å…¶ Spec æ¨¡æ¿ä¸­åŒ…å«äº† Redis ä¸»é•œåƒã€ç«¯å£ç­‰é…ç½®ã€‚</span><br><span class="hljs-comment">// è¿™æ˜¯ä¸€ä¸ªä½“åŠ›æ´»ï¼Œéœ€è¦ä½ ç†Ÿæ‚‰ Kubernetes Deployment çš„ YAML ç»“æ„ï¼Œå¹¶ç”¨ Go struct æ¥è¡¨ç¤ºã€‚</span><br>&#125;<br><br><span class="hljs-comment">// è¾…åŠ©å‡½æ•°ï¼šä¸º Guestbook åˆ›å»º Redis Replica Deployment çš„å®šä¹‰</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *GuestbookReconciler)</span></span> redisReplicaDeploymentForGuestbook(g *webappv1.Guestbook) *appsv1.Deployment &#123;<br><span class="hljs-comment">// ... ç±»ä¼¼ä¸Šé¢ï¼Œä½†é…ç½®çš„æ˜¯ Redis ä»é•œåƒï¼Œå¹¶ä¸”å‰¯æœ¬æ•°åˆå§‹åŒ–ä¸º g.Spec.Replicas</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ³¨æ„</strong>ï¼šä¸Šé¢çš„ä»£ç æ˜¯ä¸€ä¸ªé«˜åº¦ç®€åŒ–çš„ç¤ºä¾‹ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œä½ éœ€è¦ï¼š</p><ul><li>å®Œå–„ä¸¤ä¸ªè¾…åŠ©å‡½æ•°ï¼Œå®Œæ•´åœ°å®šä¹‰ Deploymentã€‚</li><li>å¤„ç†é”™è¯¯å’Œè¾¹ç¼˜æƒ…å†µã€‚</li><li>è€ƒè™‘èµ„æºçš„ OwnerReferencesï¼Œä»¥ä¾¿åœ¨åˆ é™¤ <code>Guestbook</code> CR æ—¶ï¼Œå…¶åˆ›å»ºçš„ Deployment ä¹Ÿèƒ½è¢«åƒåœ¾å›æ”¶ã€‚</li><li>æ›´ä¼˜é›…åœ°å¤„ç†çŠ¶æ€æ›´æ–°ã€‚</li></ul><h4 id="é˜¶æ®µäº”ï¼šæµ‹è¯•ä¸éƒ¨ç½²"><a href="#é˜¶æ®µäº”ï¼šæµ‹è¯•ä¸éƒ¨ç½²" class="headerlink" title="é˜¶æ®µäº”ï¼šæµ‹è¯•ä¸éƒ¨ç½²"></a>é˜¶æ®µäº”ï¼šæµ‹è¯•ä¸éƒ¨ç½²</h4><ol><li><p><strong>å®‰è£… CRD</strong>ï¼š</p><p>bash</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">make install<br></code></pre></td></tr></table></figure><p>è¿™å°†æŠŠä½ å®šä¹‰çš„ <code>Guestbook</code> CRD å®‰è£…åˆ°å½“å‰ <code>kubectl</code> æŒ‡å‘çš„é›†ç¾¤ä¸­ã€‚ä½ å¯ä»¥ç”¨ <code>kubectl get crds</code> æŸ¥çœ‹ã€‚</p></li><li><p><strong>æœ¬åœ°è¿è¡Œæµ‹è¯•ï¼ˆå¯é€‰ï¼‰</strong>ï¼š</p><p>bash</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">make run<br></code></pre></td></tr></table></figure><p>è¿™ä¼šåœ¨æœ¬åœ°å¯åŠ¨ä½ çš„æ§åˆ¶å™¨ï¼Œæ–¹ä¾¿ä½ å¿«é€Ÿè°ƒè¯•ã€‚ä½ å¯ä»¥åœ¨å¦ä¸€ä¸ªç»ˆç«¯åˆ›å»º CR æ¥æµ‹è¯•ã€‚</p></li><li><p><strong>æ„å»ºé•œåƒå¹¶éƒ¨ç½²åˆ°é›†ç¾¤</strong>ï¼š</p><p>bash</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># è®¾ç½®ä½ è¦æ¨é€çš„é•œåƒæ ‡ç­¾</span><br><span class="hljs-built_in">export</span> IMG=your-docker-repo/guestbook-operator:v1.0.0<br><br><span class="hljs-comment"># æ„å»ºé•œåƒ</span><br>make docker-build<br><br><span class="hljs-comment"># æ¨é€é•œåƒåˆ°ä»“åº“</span><br>make docker-push<br><br><span class="hljs-comment"># ç”Ÿæˆéƒ¨ç½²æ¸…å•å¹¶éƒ¨ç½²åˆ°é›†ç¾¤</span><br>make deploy<br></code></pre></td></tr></table></figure><p><code>make deploy</code> ä¼šåœ¨é›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ª Namespace å¹¶éƒ¨ç½² Operator çš„ Deploymentã€‚</p></li><li><p><strong>éªŒæ”¶æµ‹è¯•</strong>ï¼š</p><p>yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># config/samples/webapp_v1_guestbook.yaml</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">webapp.my.domain.com/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Guestbook</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">guestbook-sample</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>bash</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl apply -f config/samples/webapp_v1_guestbook.yaml<br>kubectl get guestbooks <span class="hljs-comment"># æŸ¥çœ‹ä½ çš„è‡ªå®šä¹‰èµ„æº</span><br>kubectl get deployments <span class="hljs-comment"># æŸ¥çœ‹Operatorè‡ªåŠ¨åˆ›å»ºçš„redis-masterå’Œredis-replica</span><br>kubectl get pods <span class="hljs-comment"># æŸ¥çœ‹è¿è¡Œçš„Pod</span><br></code></pre></td></tr></table></figure></li></ol><h3 id="æ€»ç»“ä¸æ ¸å¿ƒè¦ç‚¹"><a href="#æ€»ç»“ä¸æ ¸å¿ƒè¦ç‚¹" class="headerlink" title="æ€»ç»“ä¸æ ¸å¿ƒè¦ç‚¹"></a>æ€»ç»“ä¸æ ¸å¿ƒè¦ç‚¹</h3><table><thead><tr><th align="left">æ­¥éª¤</th><th align="left">å…³é”®å‘½ä»¤&#x2F;æ–‡ä»¶</th><th align="left">ç›®çš„</th></tr></thead><tbody><tr><td align="left"><strong>åˆå§‹åŒ–</strong></td><td align="left"><code>kubebuilder init</code></td><td align="left">åˆ›å»ºé¡¹ç›®è„šæ‰‹æ¶å’Œå…¥å£æ–‡ä»¶</td></tr><tr><td align="left"><strong>åˆ›å»ºAPI</strong></td><td align="left"><code>kubebuilder create api</code></td><td align="left">ç”Ÿæˆ CRD ç±»å‹å®šä¹‰å’Œæ§åˆ¶å™¨éª¨æ¶</td></tr><tr><td align="left"><strong>å®šä¹‰API</strong></td><td align="left"><code>api/&lt;version&gt;/&lt;kind&gt;_types.go</code></td><td align="left">å®šä¹‰ CR çš„ Spec å’Œ Status ç»“æ„</td></tr><tr><td align="left"><strong>ç”Ÿæˆä»£ç </strong></td><td align="left"><code>make generate</code>, <code>make manifests</code></td><td align="left">æ ¹æ®ç±»å‹å®šä¹‰ç”Ÿæˆä»£ç å’Œ CRD YAML</td></tr><tr><td align="left"><strong>å®ç°é€»è¾‘</strong></td><td align="left"><code>controllers/&lt;kind&gt;_controller.go</code></td><td align="left">åœ¨ <code>Reconcile</code> å‡½æ•°ä¸­ç¼–å†™ä¸šåŠ¡é€»è¾‘</td></tr><tr><td align="left"><strong>å®‰è£…CRD</strong></td><td align="left"><code>make install</code></td><td align="left">å°† CRD å®‰è£…åˆ°é›†ç¾¤</td></tr><tr><td align="left"><strong>æ„å»ºéƒ¨ç½²</strong></td><td align="left"><code>make docker-build</code>, <code>make docker-push</code>, <code>make deploy</code></td><td align="left">å°† Operator æœ¬èº«éƒ¨ç½²åˆ°é›†ç¾¤</td></tr><tr><td align="left"><strong>æµ‹è¯•</strong></td><td align="left"><code>kubectl apply -f config/samples/</code></td><td align="left">åˆ›å»º CR å®ä¾‹ï¼Œè§¦å‘ Operator å·¥ä½œ</td></tr></tbody></table>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>k8sä¸­apiserverå¯¹å¹¶å‘æ“ä½œçš„æ§åˆ¶</title>
    <link href="/2025/09/11/k8s%E4%B8%ADapiserver%E5%AF%B9%E5%B9%B6%E5%8F%91%E6%93%8D%E4%BD%9C%E7%9A%84%E6%8E%A7%E5%88%B6/"/>
    <url>/2025/09/11/k8s%E4%B8%ADapiserver%E5%AF%B9%E5%B9%B6%E5%8F%91%E6%93%8D%E4%BD%9C%E7%9A%84%E6%8E%A7%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<p>è¿™è§¦åŠäº† Kubernetes çš„æ ¸å¿ƒæœºåˆ¶ä¹‹ä¸€ï¼š<strong>å¹¶å‘æ§åˆ¶</strong>ã€‚ä½ èƒ½æ€è€ƒåˆ°è¿™ä¸€å±‚ï¼Œè¯´æ˜ä½ å·²ç»è¶…å‡ºäº†å•çº¯â€œä¼šç”¨â€çš„å±‚é¢ï¼Œå¼€å§‹æ·±å…¥ç†è§£ç³»ç»Ÿè®¾è®¡äº†ã€‚</p><p>ç®€å•ç›´æ¥çš„å›ç­”æ˜¯ï¼šKubernetes API Server é€šè¿‡ä¸€ç§ç§°ä¸º <strong>ä¹è§‚å¹¶å‘æ§åˆ¶ï¼ˆOptimistic Concurrency Controlï¼‰</strong> çš„æœºåˆ¶æ¥å¤„ç†è¿™ç§æƒ…å†µï¼Œå…¶æ ¸å¿ƒæ˜¯ <strong><code>resourceVersion</code></strong> å­—æ®µã€‚</p><p>ä¸‹é¢æˆ‘ä¸ºä½ è¯¦ç»†æ‹†è§£è¿™ä¸ªè¿‡ç¨‹ï¼Œå¹¶ç»™å‡ºå­¦ä¹ å’Œä½¿ç”¨ä¸­çš„æ³¨æ„äº‹é¡¹ã€‚</p><h3 id="æ ¸å¿ƒæœºåˆ¶ï¼šresourceVersion-ä¸ä¹è§‚é”"><a href="#æ ¸å¿ƒæœºåˆ¶ï¼šresourceVersion-ä¸ä¹è§‚é”" class="headerlink" title="æ ¸å¿ƒæœºåˆ¶ï¼šresourceVersion ä¸ä¹è§‚é”"></a>æ ¸å¿ƒæœºåˆ¶ï¼šresourceVersion ä¸ä¹è§‚é”</h3><p>æ¯ä¸€ä¸ªä» Kubernetes API Server è·å–çš„èµ„æºå¯¹è±¡ï¼ˆPod, Deployment, Service ç­‰ï¼‰çš„å…ƒæ•°æ®ï¼ˆmetadataï¼‰ä¸­éƒ½åŒ…å«ä¸€ä¸ªåä¸º <code>resourceVersion</code> çš„å­—æ®µã€‚å®ƒæ˜¯ä¸€ä¸ªä¸é€æ˜çš„å­—ç¬¦ä¸²ï¼ˆæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª ETagï¼‰ï¼Œå”¯ä¸€æ ‡è¯†è¯¥èµ„æºåœ¨ç‰¹å®šæ—¶åˆ»çš„ç‰ˆæœ¬ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-pod</span><br>  <span class="hljs-attr">resourceVersion:</span> <span class="hljs-string">&quot;123456&quot;</span> <span class="hljs-comment"># è¿™å°±æ˜¯å…³é”®ï¼</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-string">...</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå­—æ®µæ˜¯å®¢æˆ·ç«¯ä¿®æ”¹å¯¹è±¡æ—¶å®ç°å¹¶å‘æ§åˆ¶çš„åŸºçŸ³ã€‚å…¶å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><ol><li><p><strong>è¯»å–å¯¹è±¡</strong>ï¼šä½ çš„ä»£ç ï¼ˆä½¿ç”¨ client-goï¼‰é¦–å…ˆä» APIServer è·å–ä¸€ä¸ªå¯¹è±¡ã€‚æ­¤æ—¶ï¼Œè¯¥å¯¹è±¡çš„ <code>resourceVersion</code> å€¼ï¼ˆä¾‹å¦‚ <code>123456</code>ï¼‰è¢«è®°å½•ä¸‹æ¥ã€‚</p></li><li><p><strong>æœ¬åœ°ä¿®æ”¹</strong>ï¼šä½ åœ¨ä»£ç ä¸­ä¿®æ”¹è¿™ä¸ªå¯¹è±¡çš„æŸäº›å­—æ®µï¼Œæ¯”å¦‚ <code>spec.replicas</code>ã€‚</p></li><li><p><strong>å‘èµ·æ›´æ–°è¯·æ±‚</strong>ï¼šå½“ä½ è°ƒç”¨ <code>Update</code> æˆ– <code>UpdateStatus</code> ç­‰æ–¹æ³•æ—¶ï¼Œclient-go ä¼šå°†ä½ ä¿®æ”¹åçš„å¯¹è±¡ï¼ˆ**åŒ…å«ä¹‹å‰è¯»å–åˆ°çš„ <code>resourceVersion</code> å€¼ <code>123456</code>**ï¼‰å‘é€ç»™ APIServerã€‚</p></li><li><p><strong>æœåŠ¡å™¨ç«¯éªŒè¯</strong>ï¼šAPIServer æ”¶åˆ°æ›´æ–°è¯·æ±‚åï¼Œä¼šè¿›è¡Œä»¥ä¸‹å…³é”®æ£€æŸ¥ï¼š</p><ul><li>å®ƒä¼šåœ¨æ•°æ®åº“ï¼ˆetcdï¼‰ä¸­æŸ¥æ‰¾ä½ è¦æ›´æ–°çš„å¯¹è±¡ã€‚</li><li>å®ƒæ¯”è¾ƒ**è¯·æ±‚ä¸­å¯¹è±¡æºå¸¦çš„ <code>resourceVersion</code><strong>ï¼ˆ<code>123456</code>ï¼‰å’Œ</strong>æ•°æ®åº“ä¸­å½“å‰å¯¹è±¡çš„ <code>resourceVersion</code>**ã€‚</li><li><strong>å¦‚æœä¸¤è€…åŒ¹é…</strong>ï¼šè¯´æ˜ä»ä½ è¯»å–å¯¹è±¡åˆ°å‘èµ·æ›´æ–°è¿™ä¸ªæ—¶é—´çª—å£å†…ï¼Œæ²¡æœ‰å…¶ä»–äººä¿®æ”¹è¿‡è¿™ä¸ªå¯¹è±¡ã€‚éªŒè¯é€šè¿‡ï¼ŒAPIServer ä¼šæ¥å—ä½ çš„æ›´æ–°ï¼Œå¹¶å°†å¯¹è±¡çš„ <code>resourceVersion</code> æ›´æ–°ä¸ºä¸€ä¸ªæ–°çš„å€¼ï¼ˆä¾‹å¦‚ <code>123457</code>ï¼‰ã€‚</li><li><strong>å¦‚æœä¸¤è€…ä¸åŒ¹é…</strong>ï¼šè¯´æ˜åœ¨ä½ è¯»å–ä¹‹åã€æ›´æ–°ä¹‹å‰ï¼Œè¿™ä¸ªå¯¹è±¡å·²ç»è¢«å…¶ä»–å®¢æˆ·ç«¯ï¼ˆå¯èƒ½æ˜¯å¦ä¸€ä¸ªåç¨‹ã€å¦ä¸€ä¸ª Podã€æˆ–è€…äººç±»é€šè¿‡ <code>kubectl</code>ï¼‰ä¿®æ”¹è¿‡äº†ã€‚æ•°æ®åº“ä¸­çš„å½“å‰ <code>resourceVersion</code> å·²ç»å˜æˆäº† <code>123999</code>ã€‚æ­¤æ—¶ï¼ŒAPIServer ä¼šè®¤ä¸ºè¿™æ¬¡æ›´æ–°å‘ç”Ÿäº†<strong>å†²çªï¼ˆConflictï¼‰</strong>ï¼Œå¹¶ç›´æ¥è¿”å›ä¸€ä¸ª <strong>HTTP 409 Conflict</strong> é”™è¯¯ã€‚</li></ul></li><li><p><strong>å®¢æˆ·ç«¯å¤„ç†</strong>ï¼šä½ çš„å®¢æˆ·ç«¯ä»£ç ä¼šæ”¶åˆ°è¿™ä¸ªé”™è¯¯ï¼Œæ›´æ–°æ“ä½œå¤±è´¥ã€‚è¿™æ—¶ï¼Œä½ çš„ç¨‹åºéœ€è¦å†³å®šå¦‚ä½•å¤„ç†è¿™ä¸ªå†²çªã€‚</p></li></ol><p>è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯â€œä¹è§‚â€é”ï¼šå®ƒä¹è§‚åœ°å‡å®šåœ¨ä½ ä¿®æ”¹æœŸé—´ä¸ä¼šæœ‰å…¶ä»–äººä¿®æ”¹æ•°æ®ï¼Œå› æ­¤ä¸ä¼šåœ¨è¯»å–æ—¶åŠ é”ï¼Œåªåœ¨æäº¤æ›´æ–°æ—¶æ£€æŸ¥ç‰ˆæœ¬ã€‚è¿™å¤§å¤§æé«˜äº†ç³»ç»Ÿçš„ååé‡ã€‚</p><h3 id="å¦‚æœåœ¨ä»£ç ä¸­å¤„ç†å¹¶å‘å†²çªï¼Ÿ"><a href="#å¦‚æœåœ¨ä»£ç ä¸­å¤„ç†å¹¶å‘å†²çªï¼Ÿ" class="headerlink" title="å¦‚æœåœ¨ä»£ç ä¸­å¤„ç†å¹¶å‘å†²çªï¼Ÿ"></a>å¦‚æœåœ¨ä»£ç ä¸­å¤„ç†å¹¶å‘å†²çªï¼Ÿ</h3><p>å½“ä½ çš„ client-go ä»£ç æ”¶åˆ° <code>409 Conflict</code> é”™è¯¯æ—¶ï¼Œç»å¯¹ä¸èƒ½ç®€å•åœ°å¿½ç•¥å®ƒã€‚æ ‡å‡†çš„å¤„ç†æ¨¡å¼æ˜¯ä¸€ä¸ª<strong>é‡è¯•å¾ªç¯</strong>ï¼š</p><ol><li><strong>é‡æ–°è·å–å¯¹è±¡</strong>ï¼šä¸€æ—¦æ•è·åˆ° <code>409</code> é”™è¯¯ï¼Œç«‹å³é‡æ–°ä» APIServer è¯»å–ä¸€æ¬¡æœ€æ–°çš„å¯¹è±¡ã€‚è¿™ä¸ªæ–°å¯¹è±¡åŒ…å«äº†æœ€æ–°çš„çŠ¶æ€å’Œæœ€æ–°çš„ <code>resourceVersion</code>ã€‚</li><li><strong>é‡æ–°åº”ç”¨ä¿®æ”¹</strong>ï¼šåœ¨ä½ åˆšè¯»å–çš„æœ€æ–°å¯¹è±¡åŸºç¡€ä¸Šï¼Œé‡æ–°è¿›è¡Œä½ æƒ³è¦çš„ä¿®æ”¹ï¼ˆä¾‹å¦‚ï¼Œé‡æ–°è®¾ç½® <code>spec.replicas</code>ï¼‰ã€‚</li><li><strong>é‡æ–°å‘èµ·æ›´æ–°</strong>ï¼šç”¨è¿™ä¸ªåˆå¹¶äº†æœ€æ–°çŠ¶æ€å’Œä½ ä¿®æ”¹çš„æ–°å¯¹è±¡ï¼Œå†æ¬¡è°ƒç”¨ <code>Update</code> æ–¹æ³•ã€‚</li></ol><p>è¿™ä¸ªæ¨¡å¼éå¸¸å¸¸è§ï¼Œä»¥è‡³äº client-go åœ¨ä¸€äº›æ›´é«˜çº§çš„ç»„ä»¶ï¼ˆå¦‚ <code>controller-runtime</code>ï¼ŒOperator SDK å’Œ Kubebuilder çš„åŸºç¡€ï¼‰ä¸­å·²ç»å†…ç½®äº†ã€‚ä½†å¯¹äºç›´æ¥ä½¿ç”¨ client-go çš„æƒ…å†µï¼Œä½ éœ€è¦è‡ªå·±å®ç°ã€‚</p><p><strong>ä¸€ä¸ªç®€å•çš„ä¼ªä»£ç ç¤ºä¾‹ï¼š</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;k8s.io/apimachinery/pkg/api/errors&quot;</span><br>    metav1 <span class="hljs-string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span><br>)<br><br><span class="hljs-keyword">for</span> &#123;<br>    <span class="hljs-comment">// 1. è·å–æœ€æ–°çš„ Deployment</span><br>    deployment, err := clientset.AppsV1().Deployments(<span class="hljs-string">&quot;default&quot;</span>).Get(ctx, <span class="hljs-string">&quot;my-deployment&quot;</span>, metav1.GetOptions&#123;&#125;)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> err<br>    &#125;<br><br>    <span class="hljs-comment">// 2. åœ¨æœ¬åœ°ä¿®æ”¹å¯¹è±¡</span><br>    deployment.Spec.Replicas = pointer.Int32Ptr(<span class="hljs-number">5</span>)<br><br>    <span class="hljs-comment">// 3. å°è¯•æ›´æ–°</span><br>    _, err = clientset.AppsV1().Deployments(<span class="hljs-string">&quot;default&quot;</span>).Update(ctx, deployment, metav1.UpdateOptions&#123;&#125;)<br>    <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-comment">// æ›´æ–°æˆåŠŸï¼Œè·³å‡ºå¾ªç¯</span><br>        <span class="hljs-keyword">break</span><br>    &#125;<br><br>    <span class="hljs-comment">// 4. æ£€æŸ¥é”™è¯¯æ˜¯å¦ä¸ºå†²çª</span><br>    <span class="hljs-keyword">if</span> !errors.IsConflict(err) &#123;<br>        <span class="hljs-comment">// å¦‚æœä¸æ˜¯å†²çªé”™è¯¯ï¼ˆå¯èƒ½æ˜¯æƒé™ã€æ ¡éªŒå¤±è´¥ç­‰ï¼‰ï¼Œç›´æ¥è¿”å›é”™è¯¯</span><br>        <span class="hljs-keyword">return</span> err<br>    &#125;<br>    <span class="hljs-comment">// 5. å¦‚æœæ˜¯å†²çªé”™è¯¯ï¼Œå¾ªç¯ä¼šç»§ç»­ï¼Œé‡æ–°æ‰§è¡Œæ­¥éª¤1</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å­¦ä¹ å’Œä½¿ç”¨è¿‡ç¨‹ä¸­çš„æ³¨æ„äº‹é¡¹"><a href="#å­¦ä¹ å’Œä½¿ç”¨è¿‡ç¨‹ä¸­çš„æ³¨æ„äº‹é¡¹" class="headerlink" title="å­¦ä¹ å’Œä½¿ç”¨è¿‡ç¨‹ä¸­çš„æ³¨æ„äº‹é¡¹"></a>å­¦ä¹ å’Œä½¿ç”¨è¿‡ç¨‹ä¸­çš„æ³¨æ„äº‹é¡¹</h3><ol><li><p><strong>æ°¸è¿œåŸºäºæœ€æ–°ç‰ˆæœ¬ä¿®æ”¹</strong>ï¼šä¸è¦ç¼“å­˜ä¸€ä¸ªå¯¹è±¡ç„¶ååå¤ç”¨å®ƒåšä¿®æ”¹ã€‚æ¯æ¬¡æ›´æ–°å‰ï¼Œéƒ½åº”è¯¥é‡æ–° Get ä¸€æ¬¡ï¼Œæˆ–è€…ç¡®ä¿ä½ å¤„ç†çš„æ˜¯æœ€æ–°ç‰ˆæœ¬ã€‚<code>resourceVersion</code> æ˜¯ä½ çš„æœ‹å‹ï¼Œä¹Ÿæ˜¯ä¿è¯æ•°æ®ä¸€è‡´æ€§çš„ç”Ÿå‘½çº¿ã€‚</p></li><li><p>**åŒºåˆ† <code>Update</code> å’Œ <code>Patch</code>**ï¼š</p><ul><li>**<code>Update</code>**ï¼šéœ€è¦æä¾›æ•´ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”å— <code>resourceVersion</code> çš„ä¹è§‚é”æ§åˆ¶ã€‚ä¸Šé¢è®¨è®ºçš„å°±æ˜¯è¿™ç§æ–¹å¼ã€‚</li><li>**<code>Patch</code><strong>ï¼šå…è®¸ä½ åªå‘é€è¦ä¿®æ”¹çš„å­—æ®µã€‚æŸäº› Patch ç±»å‹ï¼ˆå¦‚ <code>strategic merge patch</code> æˆ– <code>JSON patch</code>ï¼‰åœ¨å†²çªå¤„ç†ä¸Šæ¯” <code>Update</code> æ›´å‹å¥½ï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥åœ¨æœåŠ¡å™¨ç«¯ä»¥æ›´ç»†çš„ç²’åº¦åº”ç”¨æ›´æ”¹ï¼Œæœ‰æ—¶å¯ä»¥é¿å…å†²çªã€‚ä¾‹å¦‚ï¼Œä¸¤ä¸ªå®¢æˆ·ç«¯åˆ†åˆ« Patch åŒä¸€ä¸ªå¯¹è±¡çš„ä¸åŒå­—æ®µï¼Œå¯èƒ½ä¸ä¼šå†²çªã€‚</strong>åœ¨ä½ éœ€è¦é«˜å¹¶å‘æ›´æ–°çš„åœºæ™¯ä¸‹ï¼Œä¼˜å…ˆè€ƒè™‘ä½¿ç”¨ <code>Patch</code>**ã€‚</li></ul></li><li><p><strong>æ³¨æ„ <code>ResourceVersion</code> å­—æ®µæœ¬èº«</strong>ï¼š</p><ul><li>ä½ ä¸åº”è¯¥æ‰‹åŠ¨è®¾ç½®æˆ–ä¿®æ”¹è¿™ä¸ªå­—æ®µï¼Œå®ƒåº”è¯¥å®Œå…¨ç”± APIServer ç®¡ç†ã€‚</li><li>åœ¨ List æ“ä½œæ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>metav1.ListOptions&#123;ResourceVersion: &quot;0&quot;&#125;</code> æ¥è¯·æ±‚ä¸€ä¸ªâ€œä»»æ„â€ç‰ˆæœ¬çš„ç¼“å­˜æ•°æ®ï¼ˆå¯èƒ½è¿‡æ—¶ï¼‰ï¼Œä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚ä½†ç”¨äº Watch æˆ–ä½œä¸ºæ›´æ–°ä¾æ®æ—¶ï¼Œå¿…é¡»ä½¿ç”¨å…·ä½“çš„ç‰ˆæœ¬å·ã€‚</li></ul></li><li><p><strong>é”™è¯¯å¤„ç†æ˜¯å¿…é€‰é¡¹</strong>ï¼šåœ¨ä½ çš„ä»£ç ä¸­ï¼Œ<strong>å¿…é¡»</strong>å¤„ç† <code>409 Conflict</code> é”™è¯¯ã€‚ç®€å•åœ°æ‰“å°é”™è¯¯å¹¶é€€å‡ºé€šå¸¸æ˜¯ä¸ä¸“ä¸šçš„åšæ³•ã€‚å®ç°é‡è¯•é€»è¾‘ï¼Œå¹¶è®¾ç½®é‡è¯•æ¬¡æ•°ä¸Šé™å’Œé€€é¿ç­–ç•¥ï¼ˆä¾‹å¦‚æŒ‡æ•°é€€é¿ï¼‰ï¼Œä»¥é¿å…æ´»é”ã€‚</p></li><li><p><strong>ä½¿ç”¨é«˜çº§åº“</strong>ï¼šå¦‚æœä½ æ­£åœ¨ç¼–å†™æ§åˆ¶å™¨ï¼ˆControllerï¼‰æˆ– Operatorï¼Œå¼ºçƒˆå»ºè®®ä½¿ç”¨ <strong><code>controller-runtime</code></strong> åº“ï¼ˆKubebuilder&#x2F;Operator SDK çš„åº•å±‚åº“ï¼‰ã€‚å®ƒæŠ½è±¡äº†å¤§é‡çš„åº•å±‚ç»†èŠ‚ï¼Œå…¶ <code>Reconcile</code> å¾ªç¯æ¨¡å¼ä¼šè‡ªåŠ¨å¸®ä½ å¤„ç†äº†èµ„æºçš„è·å–å’Œæ›´æ–°ï¼ŒåŒ…æ‹¬åœ¨å†²çªæ—¶è‡ªåŠ¨é‡è¯•ï¼Œè®©ä½ èƒ½æ›´ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ã€‚</p></li></ol><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><table><thead><tr><th align="left">æ¦‚å¿µ</th><th align="left">ä½œç”¨</th><th align="left">å®¢æˆ·ç«¯æ³¨æ„äº‹é¡¹</th></tr></thead><tbody><tr><td align="left"><strong><code>resourceVersion</code></strong></td><td align="left">ä¹è§‚å¹¶å‘æ§åˆ¶çš„ç‰ˆæœ¬æ ‡è¯†ç¬¦</td><td align="left">ä¸è¦æ‰‹åŠ¨ä¿®æ”¹å®ƒï¼›æ›´æ–°æ—¶å¿…é¡»æºå¸¦</td></tr><tr><td align="left"><strong>HTTP 409 Conflict</strong></td><td align="left">ç‰ˆæœ¬å†²çªçš„ä¿¡å·</td><td align="left">å¿…é¡»å¤„ç†æ­¤é”™è¯¯ï¼Œå®ç°é‡è¯•é€»è¾‘</td></tr><tr><td align="left"><strong>Update æ“ä½œ</strong></td><td align="left">æ›¿æ¢æ•´ä¸ªå¯¹è±¡</td><td align="left">å®¹æ˜“å¼•å‘å†²çªï¼Œéœ€é‡è¯•</td></tr><tr><td align="left"><strong>Patch æ“ä½œ</strong></td><td align="left">éƒ¨åˆ†æ›´æ–°å¯¹è±¡</td><td align="left">å‡å°‘å†²çªæ¦‚ç‡ï¼Œæ¨èåœ¨å¹¶å‘åœºæ™¯ä½¿ç”¨</td></tr><tr><td align="left"><strong>é‡è¯•å¾ªç¯</strong></td><td align="left">å¤„ç†å†²çªçš„æ ‡å‡†æ¨¡å¼</td><td align="left">åº”åŒ…å«é€€é¿æœºåˆ¶ï¼Œé¿å…æ— é™é‡è¯•</td></tr></tbody></table><p>ç†è§£äº†è¿™ä¸ªæœºåˆ¶ï¼Œä½ å°±èƒ½å†™å‡ºæ›´å¥å£®ã€æ›´å¯é çš„ Kubernetes è‡ªåŠ¨åŒ–ä»£ç äº†ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Kubernetes ç³»ç»Ÿæœ¬èº«åŠå…¶ä¸Šçš„ä¼—å¤šæ§åˆ¶å™¨èƒ½å¤Ÿåœ¨é«˜åº¦å¹¶å‘çš„ç¯å¢ƒä¸‹ç¨³å®šè¿è¡Œçš„åŸå› ã€‚</p><p>è¿™ç§åŸå­æ€§æ˜¯ç”± API Server å’Œå…¶åº•å±‚çš„åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨ <strong>etcd</strong> å…±åŒä¿è¯çš„ã€‚å½“ä½ é€šè¿‡ client-go å‘èµ·ä¸€ä¸ª <code>Create</code>ã€<code>Update</code> æˆ– <code>Delete</code> æ“ä½œæ—¶ï¼Œè¿™ä¸ªæ“ä½œå¯¹äº API Server æ¥è¯´æ˜¯ä¸€ä¸ªå•ä¸€çš„è¯·æ±‚ã€‚API Server ä¼šè¿›è¡Œä¸€ç³»åˆ—å·¥ä½œï¼ˆè®¤è¯ã€é‰´æƒã€å‡†å…¥æ§åˆ¶ã€éªŒè¯ï¼‰ï¼Œæœ€ç»ˆè¿™ä¸ªæ“ä½œä¼šè½¬åŒ–ä¸ºå¯¹ etcd çš„<strong>ä¸€æ¬¡å†™æ“ä½œ</strong>ã€‚etcd ä¼šå°†å…¶ä½œä¸ºä¸€ä¸ªåŸå­äº‹åŠ¡æ¥æ‰§è¡Œã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>volcanoè°ƒåº¦å™¨Reclaim-Actionè¯¦è§£</title>
    <link href="/2025/08/27/volcano%E8%B0%83%E5%BA%A6%E5%99%A8Reclaim-Action%E8%AF%A6%E8%A7%A3/"/>
    <url>/2025/08/27/volcano%E8%B0%83%E5%BA%A6%E5%99%A8Reclaim-Action%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<p>é€šè¿‡åˆ†æ Volcano çš„æºç ï¼ˆä¸»è¦å‚è€ƒ <code>master</code> åˆ†æ”¯å’Œæœ€æ–°ç¨³å®šç‰ˆï¼Œå¦‚ <code>v1.9.0</code>ï¼‰ï¼Œæˆ‘æ¥ä¸ºä½ è¯¦ç»†è§£æ <strong>Reclaim Action</strong> çš„å…·ä½“è¿‡ç¨‹ã€‚Reclaim Action æ˜¯ Volcano è°ƒåº¦å™¨ä¸­è´Ÿè´£<strong>è·¨é˜Ÿåˆ—èµ„æºå›æ”¶</strong>çš„æ ¸å¿ƒæœºåˆ¶ï¼Œå®ƒç¡®ä¿èµ„æºèƒ½å¤ŸæŒ‰ç…§é˜Ÿåˆ—çš„æƒé‡å’Œé…é¢è¿›è¡Œå…¬å¹³åˆ†é…ã€‚</p><h3 id="ğŸ”§-Reclaim-Action-çš„æ ¸å¿ƒä½œç”¨ä¸è®¾è®¡åˆè¡·"><a href="#ğŸ”§-Reclaim-Action-çš„æ ¸å¿ƒä½œç”¨ä¸è®¾è®¡åˆè¡·" class="headerlink" title="ğŸ”§ Reclaim Action çš„æ ¸å¿ƒä½œç”¨ä¸è®¾è®¡åˆè¡·"></a>ğŸ”§ Reclaim Action çš„æ ¸å¿ƒä½œç”¨ä¸è®¾è®¡åˆè¡·</h3><p><strong>æ ¸å¿ƒä½œç”¨</strong>ï¼šReclaim Action çš„ä¸»è¦ç›®æ ‡æ˜¯å½“æŸä¸ª<strong>é˜Ÿåˆ—ï¼ˆQueueï¼‰</strong> çš„èµ„æºä½¿ç”¨é‡è¶…è¿‡å…¶<strong>åº”å¾—ä»½é¢ï¼ˆdeservedï¼‰</strong> æ—¶ï¼Œä»å…¶ä»–<strong>å¯å›æ”¶ï¼ˆreclaimableï¼‰</strong> çš„é˜Ÿåˆ—ä¸­<strong>å›æ”¶èµ„æº</strong>ï¼Œä»¥æ»¡è¶³èµ„æºçŸ­ç¼ºé˜Ÿåˆ—çš„éœ€æ±‚ã€‚å…¶è®¾è®¡åˆè¡·æ˜¯å®ç°å¤šç§Ÿæˆ·åœºæ™¯ä¸‹è·¨é˜Ÿåˆ—çš„å…¬å¹³è°ƒåº¦å’Œèµ„æºéš”ç¦»ã€‚</p><p><strong>ä¸ Preempt Action çš„åŒºåˆ«</strong>ï¼š</p><ul><li><strong><code>Reclaim</code></strong>: å¤„ç†<strong>ä¸åŒé˜Ÿåˆ—ä¹‹é—´</strong>çš„èµ„æºå›æ”¶ã€‚</li><li><strong><code>Preempt</code></strong>: å¤„ç†<strong>åŒä¸€é˜Ÿåˆ—å†…éƒ¨</strong>ï¼ˆJob ä¹‹é—´æˆ– Task ä¹‹é—´ï¼‰åŸºäºä¼˜å…ˆçº§çš„æŠ¢å ã€‚</li></ul><h3 id="ğŸ“¦-å…³é”®æ¦‚å¿µä¸å‰ç½®çŸ¥è¯†"><a href="#ğŸ“¦-å…³é”®æ¦‚å¿µä¸å‰ç½®çŸ¥è¯†" class="headerlink" title="ğŸ“¦ å…³é”®æ¦‚å¿µä¸å‰ç½®çŸ¥è¯†"></a>ğŸ“¦ å…³é”®æ¦‚å¿µä¸å‰ç½®çŸ¥è¯†</h3><p>ç†è§£ Reclaim Action éœ€è¦å…ˆäº†è§£å‡ ä¸ªå…³é”®æ¦‚å¿µï¼š</p><ul><li><strong><code>Session</code></strong>: è°ƒåº¦ä¼šè¯çš„ä¸Šä¸‹æ–‡ï¼ŒåŒ…å«äº†å½“å‰æ‰€æœ‰å¾…è°ƒåº¦çš„ Job(<code>Jobs</code>)ã€èŠ‚ç‚¹ä¿¡æ¯(<code>Nodes</code>)ã€å·²æ³¨å†Œçš„æ’ä»¶(<code>Plugins</code>)ç­‰ã€‚</li><li><strong><code>Queue</code></strong>: Volcano çš„è‡ªå®šä¹‰èµ„æºï¼Œç”¨äºå¯¹ä½œä¸šè¿›è¡Œåˆ†ç»„å’Œèµ„æºåˆ†é…ã€‚æ¯ä¸ª Queue å¯ä»¥é…ç½® <code>deserved</code>ï¼ˆåº”å¾—èµ„æºé‡ï¼‰ã€<code>capability</code>ï¼ˆèµ„æºä¸Šé™ï¼‰å’Œ <code>guarantee</code>ï¼ˆä¿éšœèµ„æºé‡ï¼‰ã€‚</li><li><strong><code>deserved</code></strong>: é˜Ÿåˆ—æ ¹æ®å…¶æƒé‡ç­‰å› ç´ è®¡ç®—å‡ºçš„åº”å¾—èµ„æºé‡ã€‚</li><li><strong><code>reclaimable</code></strong>: é˜Ÿåˆ—çš„ä¸€ä¸ªå±æ€§ï¼ˆ<code>spec.reclaimable</code>ï¼‰ï¼Œæ ‡è®°è¯¥é˜Ÿåˆ—ä¸­çš„èµ„æºæ˜¯å¦å¯ä»¥è¢«å…¶ä»–é˜Ÿåˆ—å›æ”¶ã€‚<strong>åªæœ‰å°† <code>reclaimable</code> è®¾ç½®ä¸º <code>true</code> çš„é˜Ÿåˆ—ï¼Œå…¶èµ„æºæ‰å¯èƒ½è¢«å›æ”¶</strong>ã€‚</li><li><strong>å±‚çº§é˜Ÿåˆ—ï¼ˆHierarchical Queueï¼‰</strong>: Volcano æœ€æ–°ç‰ˆæœ¬æ”¯æŒé˜Ÿåˆ—çš„å±‚çº§ç»“æ„ï¼Œå­é˜Ÿåˆ—çš„èµ„æºé…é¢å—çˆ¶é˜Ÿåˆ—é™åˆ¶ï¼ŒReclaim Action ä¹Ÿéœ€è¦è€ƒè™‘è¿™ç§å±‚çº§å…³ç³»ã€‚</li></ul><h3 id="ğŸ”-Reclaim-Action-è¯¦ç»†å·¥ä½œæµç¨‹"><a href="#ğŸ”-Reclaim-Action-è¯¦ç»†å·¥ä½œæµç¨‹" class="headerlink" title="ğŸ” Reclaim Action è¯¦ç»†å·¥ä½œæµç¨‹"></a>ğŸ” Reclaim Action è¯¦ç»†å·¥ä½œæµç¨‹</h3><p>Reclaim Action çš„å…¥å£ç‚¹é€šå¸¸åœ¨ <code>pkg/scheduler/actions/reclaim/reclaim.go</code> æ–‡ä»¶ä¸­çš„ <code>Execute</code> å‡½æ•°ã€‚å…¶å·¥ä½œæµç¨‹å¯ä»¥æ¦‚æ‹¬ä¸ºä»¥ä¸‹æ ¸å¿ƒæ­¥éª¤ï¼š</p><ol><li><p><strong>è¯†åˆ«èµ„æºçŸ­ç¼ºçš„é˜Ÿåˆ—</strong>ï¼š<br>Reclaim Action ä¼šéå†æ‰€æœ‰é˜Ÿåˆ—ï¼Œè®¡ç®—æ¯ä¸ªé˜Ÿåˆ—çš„ <code>deserved</code> èµ„æºé‡å’Œå½“å‰å®é™…å·²åˆ†é…ï¼ˆ<code>allocated</code>ï¼‰çš„èµ„æºé‡ã€‚å¦‚æœæŸä¸ªé˜Ÿåˆ—çš„ <code>allocated</code> èµ„æº<strong>å°äº</strong>å…¶ <code>deserved</code> èµ„æºï¼Œè¯´æ˜è¯¥é˜Ÿåˆ—<strong>å¯èƒ½èµ„æºçŸ­ç¼º</strong>ï¼Œæœ‰èµ„æ ¼å‘èµ·èµ„æºå›æ”¶ã€‚è¿™äº›é˜Ÿåˆ—è¢«ç§°ä¸º <strong>â€œ reclaimorâ€ï¼ˆå›æ”¶æ–¹ï¼‰</strong>ã€‚</p></li><li><p><strong>è¯†åˆ«èµ„æºè¶…ç”¨çš„é˜Ÿåˆ—ï¼ˆå€™é€‰å—å®³è€…é˜Ÿåˆ—ï¼‰</strong>ï¼š<br>åŒæ ·ï¼Œéå†æ‰€æœ‰é˜Ÿåˆ—ï¼Œå¯»æ‰¾é‚£äº› <code>allocated</code> èµ„æº<strong>è¶…è¿‡</strong>å…¶ <code>deserved</code> èµ„æºçš„é˜Ÿåˆ—ã€‚è¿™äº›é˜Ÿåˆ—æ˜¯æ½œåœ¨çš„ <strong>â€œvictimâ€ï¼ˆå—å®³è€…ï¼‰</strong>ã€‚<strong>åªæœ‰é‚£äº› <code>reclaimable</code> å­—æ®µä¸º <code>true</code> çš„é˜Ÿåˆ—æ‰ä¼šè¢«è€ƒè™‘ä½œä¸ºå—å®³è€…</strong>ã€‚</p></li><li><p><strong>é€‰æ‹©è¦å›æ”¶çš„ä»»åŠ¡ï¼ˆPodï¼‰</strong>ï¼š<br>å¯¹äºæ¯ä¸€ä¸ªèµ„æºè¶…ç”¨çš„å—å®³è€…é˜Ÿåˆ—ï¼ŒReclaim Action ä¼šéå†å…¶å†…éƒ¨å·²è¿è¡Œçš„ Job å’Œ Podï¼ˆ<code>TaskInfo</code>ï¼‰ï¼Œå¹¶æ ¹æ®é…ç½®çš„æ’ä»¶ï¼ˆå¦‚ <strong>Priority</strong> æ’ä»¶ï¼‰<strong>é€‰æ‹©æœ€é€‚åˆè¢«å›æ”¶çš„ Pod</strong>ã€‚é€šå¸¸ï¼Œä¼˜å…ˆçº§è¾ƒä½æˆ–åˆ›å»ºæ—¶é—´è¾ƒæ—©çš„ Pod ä¼šè¢«ä¼˜å…ˆé€‰æ‹©ã€‚</p></li><li><p><strong>æ¨¡æ‹Ÿå›æ”¶ä¸å®‰å…¨æ£€æŸ¥</strong>ï¼š<br>åœ¨çœŸæ­£å›æ”¶ä¹‹å‰ï¼Œä¼šè¿›è¡Œæ¨¡æ‹Ÿå’Œå®‰å…¨æ£€æŸ¥ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸¥é‡ä¾èµ– <strong>Gang æ’ä»¶</strong>ï¼š</p><ul><li>Gang æ’ä»¶ä¼šæ£€æŸ¥ï¼šå¦‚æœé©±é€ï¼ˆå›æ”¶ï¼‰äº†é€‰ä¸­çš„ Podï¼Œæ˜¯å¦ä¼šå¯¼è‡´å…¶æ‰€å±çš„ Job <strong>ä¸æ»¡è¶³ <code>minAvailable</code> çº¦æŸ</strong>ï¼ˆå³ç ´åå…¶ Gang è°ƒåº¦ç­–ç•¥ï¼‰ã€‚</li><li><strong>åªæœ‰é‚£äº›è¢«å›æ”¶åä¸ä¼šç ´ååŸ Job å®Œæ•´æ€§çš„ Pod</strong>ï¼Œæ‰ä¼šè¢«ç¡®å®šä¸ºçœŸæ­£çš„å›æ”¶ç›®æ ‡ã€‚</li></ul></li><li><p><strong>æ‰§è¡Œèµ„æºå›æ”¶</strong>ï¼š<br>ä¸€æ—¦ç¡®å®šäº†è¦å›æ”¶çš„ Podï¼Œè°ƒåº¦å™¨ä¼š<strong>çœŸæ­£åœ°é©±é€è¿™äº› Pod</strong>ã€‚è¿™æ˜¯é€šè¿‡è°ƒç”¨ Kubernetes API <strong>åˆ é™¤è¿™äº› Pod</strong> æ¥å®ç°çš„ã€‚è¿™äº›è¢«å›æ”¶çš„ Pod ä¼šè¿›å…¥ <code>Terminating</code> çŠ¶æ€ï¼Œå…¶å ç”¨çš„èµ„æºå°†è¢«é‡Šæ”¾ã€‚</p></li><li><p><strong>èµ„æºé‡Šæ”¾ä¸å†åˆ†é…</strong>ï¼š<br>å—å®³è€… Pod è¢«åˆ é™¤åï¼Œå®ƒä»¬ä¹‹å‰å ç”¨çš„èµ„æºå°±è¢«é‡Šæ”¾äº†ã€‚è¿™äº›é‡Šæ”¾å‡ºæ¥çš„èµ„æº<strong>å¹¶ä¸ä¼šç«‹å³åˆ†é…ç»™å‘èµ·å›æ”¶çš„é˜Ÿåˆ—</strong>ï¼Œè€Œæ˜¯ç­‰å¾…<strong>ä¸‹ä¸€ä¸ªè°ƒåº¦å‘¨æœŸ</strong>ï¼Œç”± <code>Enqueue</code> å’Œ <code>Allocate</code> ç­‰ Action æ¥é‡æ–°åˆ†é…è¿™äº›èµ„æºã€‚æ­¤æ—¶ï¼Œç”±äºä¹‹å‰èµ„æºçŸ­ç¼ºçš„é˜Ÿåˆ—æœ‰èµ„æºéœ€æ±‚ï¼Œå®ƒå°±æœ‰æœºä¼šåœ¨åç»­çš„è°ƒåº¦ä¸­è·å¾—è¿™äº›èµ„æºã€‚</p></li></ol><p>ä¸‹å›¾æ¦‚æ‹¬äº†ä¸Šè¿°æµç¨‹åŠå…¶ä¸åç»­è°ƒåº¦å‘¨æœŸçš„å…³ç³»ï¼š</p><p><img src="/2025/08/27/volcano%E8%B0%83%E5%BA%A6%E5%99%A8Reclaim-Action%E8%AF%A6%E8%A7%A3/deepseek_mermaid_20250826_b0c4a4.png" alt="deepseek_mermaid_20250826_b0c4a4"></p><h3 id="âš™ï¸-ä¾èµ–çš„æ’ä»¶ä¸é…ç½®"><a href="#âš™ï¸-ä¾èµ–çš„æ’ä»¶ä¸é…ç½®" class="headerlink" title="âš™ï¸ ä¾èµ–çš„æ’ä»¶ä¸é…ç½®"></a>âš™ï¸ ä¾èµ–çš„æ’ä»¶ä¸é…ç½®</h3><p>Reclaim Action çš„å…·ä½“è¡Œä¸ºç”±ä¸€ç³»åˆ—æ’ä»¶å†³å®šï¼š</p><ul><li><strong>Gang æ’ä»¶</strong>: è¿›è¡Œå®‰å…¨æ£€æŸ¥çš„æ ¸å¿ƒæ’ä»¶ï¼Œç¡®ä¿å›æ”¶æ“ä½œ<strong>ä¸ä¼šç ´ååˆ†å¸ƒå¼ä»»åŠ¡çš„åŸå­æ€§</strong>ï¼ˆâ€All or Nothingâ€ï¼‰ã€‚</li><li><strong>Priority æ’ä»¶</strong>: ç”¨äºåœ¨å—å®³è€…é˜Ÿåˆ—ä¸­é€‰æ‹©è¦å›æ”¶çš„ Pod æ—¶ï¼Œæ¯”è¾ƒ Pod æˆ– Job çš„ä¼˜å…ˆçº§ã€‚</li><li><strong>Proportion æ’ä»¶</strong>: è´Ÿè´£è®¡ç®—å’Œç®¡ç†é˜Ÿåˆ—çš„ <code>deserved</code>ã€<code>capability</code> ç­‰èµ„æºé…é¢ã€‚</li><li><strong>Capacity æ’ä»¶</strong> (ç”¨äºå±‚çº§é˜Ÿåˆ—): å½“å¯ç”¨å±‚çº§é˜Ÿåˆ—åŠŸèƒ½æ—¶ï¼ˆ<code>enableHierarchy: true</code>ï¼‰ï¼Œè¯¥æ’ä»¶è´Ÿè´£å¤„ç†è·¨å±‚çº§é˜Ÿåˆ—çš„èµ„æºåˆ†é…å’Œå›æ”¶é€»è¾‘ã€‚</li></ul><p>è¦ä½¿ Reclaim Action æ­£å¸¸å·¥ä½œï¼Œå¿…é¡»åœ¨ <code>volcano-scheduler-configmap</code> ä¸­æ­£ç¡®é…ç½®ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">actions:</span> <span class="hljs-string">&quot;enqueue, allocate, reclaim, preempt&quot;</span> <span class="hljs-comment"># å¿…é¡»åŒ…å«reclaimï¼Œé¡ºåºé€šå¸¸åœ¨allocateä¹‹å</span><br><span class="hljs-attr">tiers:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">plugins:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">priority</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">gang</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">conformance</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">plugins:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">drf</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">predicates</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">proportion</span>   <span class="hljs-comment"># æ¯”ä¾‹æ’ä»¶ï¼Œç”¨äºè®¡ç®—é˜Ÿåˆ—èµ„æº</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nodeorder</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">capacity</span>     <span class="hljs-comment"># å¦‚æœä½¿ç”¨å±‚çº§é˜Ÿåˆ—ï¼Œéœ€è¦é…ç½®capacityæ’ä»¶å¹¶enableHierarchy</span><br>    <span class="hljs-attr">arguments:</span><br>      <span class="hljs-attr">enableHierarchy:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><p>åŒæ—¶ï¼Œéœ€è¦ç¡®ä¿å¸Œæœ›è¢«å›æ”¶èµ„æºçš„é˜Ÿåˆ—åœ¨å…¶å®šä¹‰ä¸­å°† <code>spec.reclaimable</code> è®¾ç½®ä¸º <code>true</code>ã€‚</p><h3 id="ğŸ§ª-ç»“åˆç¤ºä¾‹è¯´æ˜"><a href="#ğŸ§ª-ç»“åˆç¤ºä¾‹è¯´æ˜" class="headerlink" title="ğŸ§ª ç»“åˆç¤ºä¾‹è¯´æ˜"></a>ğŸ§ª ç»“åˆç¤ºä¾‹è¯´æ˜</h3><p>å‡è®¾æœ‰ä¸¤ä¸ªé˜Ÿåˆ—ï¼š</p><ul><li><strong><code>queue-online</code></strong> (é«˜ä¼˜å…ˆçº§): <code>deserved</code> ä¸º 20 æ ¸ CPUï¼Œ<code>reclaimable: false</code>ã€‚</li><li><strong><code>queue-offline</code></strong> (ä½ä¼˜å…ˆçº§): <code>deserved</code> ä¸º 20 æ ¸ CPUï¼Œ<code>reclaimable: true</code>ã€‚</li></ul><p>å½“å‰ <code>queue-offline</code> ä¸­æœ‰ä¸€ä¸ª Job æ­£åœ¨è¿è¡Œï¼Œå ç”¨äº† 40 æ ¸ CPUï¼ˆå³ <code>allocated</code> &gt; <code>deserved</code>ï¼‰ã€‚æ­¤æ—¶ï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ–°çš„ Job è¢«æäº¤åˆ° <code>queue-online</code>ï¼Œéœ€è¦ 10 æ ¸ CPUï¼Œä½†é›†ç¾¤å½“å‰æ²¡æœ‰è¶³å¤Ÿç©ºé—²èµ„æºã€‚</p><ol><li><p><strong>Reclaim Action è§¦å‘</strong>ï¼š</p><ul><li>è¯†åˆ«åˆ° <code>queue-online</code> çš„ <code>allocated</code> (0æ ¸) &lt; <code>deserved</code> (20æ ¸)ï¼Œèµ„æºçŸ­ç¼ºï¼Œæˆä¸ºå›æ”¶æ–¹ã€‚</li><li>è¯†åˆ«åˆ° <code>queue-offline</code> çš„ <code>allocated</code> (40æ ¸) &gt; <code>deserved</code> (20æ ¸)ï¼Œä¸” <code>reclaimable: true</code>ï¼Œæˆä¸ºå—å®³è€…é˜Ÿåˆ—ã€‚</li></ul></li><li><p><strong>é€‰æ‹©ä¸æ£€æŸ¥</strong>ï¼š</p><ul><li>ä» <code>queue-offline</code> ä¸­é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªåˆé€‚çš„ Podï¼ˆä¾‹å¦‚ä¼˜å…ˆçº§æœ€ä½çš„ï¼‰ï¼Œå‡è®¾è¿™äº› Pod æ€»å…±å ç”¨ 10 æ ¸ CPUã€‚</li><li>Gang æ’ä»¶æ£€æŸ¥å›æ”¶è¿™äº› Pod æ˜¯å¦ä¼šå½±å“å…¶æ‰€å± Job çš„ <code>minAvailable</code>ã€‚å‡è®¾æ£€æŸ¥é€šè¿‡ã€‚</li></ul></li><li><p><strong>æ‰§è¡Œå›æ”¶</strong>ï¼š</p><ul><li>é©±é€é€‰ä¸­çš„ Podï¼Œé‡Šæ”¾ 10 æ ¸ CPUã€‚</li></ul></li><li><p><strong>èµ„æºå†åˆ†é…</strong>ï¼š</p><ul><li>åœ¨ä¸‹ä¸€ä¸ªè°ƒåº¦å‘¨æœŸï¼Œ<code>queue-online</code> ä¸­çš„æ–° Job æœ‰æœºä¼šé€šè¿‡ <code>Allocate</code> Action åˆ†é…åˆ°è¿™ 10 æ ¸ CPUï¼Œä»è€ŒæˆåŠŸè¿è¡Œã€‚</li></ul></li></ol><h3 id="âš ï¸-é‡è¦æ³¨æ„äº‹é¡¹"><a href="#âš ï¸-é‡è¦æ³¨æ„äº‹é¡¹" class="headerlink" title="âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹"></a>âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹</h3><ol><li><strong><code>reclaimable</code> é…ç½®</strong>ï¼šé˜Ÿåˆ—çš„ <code>reclaimable</code> å­—æ®µå¿…é¡»æ˜¾å¼è®¾ç½®ä¸º <code>true</code> æ‰èƒ½è¢«å›æ”¶ã€‚</li><li><strong>ä¸ Enqueue Action çš„æ½œåœ¨å†²çª</strong>ï¼šå¦‚æœåŒæ—¶é…ç½®äº† <code>enqueue</code> å’Œ <code>reclaim</code>ï¼Œä¸” <code>enqueue</code> å› èµ„æºä¸è¶³é˜»æ­¢ PodGroup å…¥é˜Ÿï¼Œä¼šå¯¼è‡´æ²¡æœ‰ Pending çŠ¶æ€çš„ Podï¼Œè¿›è€Œå¯èƒ½æ— æ³•è§¦å‘ <code>reclaim</code> æœºåˆ¶ã€‚</li><li><strong>Overcommit æ’ä»¶çš„å½±å“</strong>ï¼š<code>overcommit</code> æ’ä»¶å¯èƒ½ä¼šé˜»æ­¢èµ„æºè¶…é™çš„ä½œä¸šè¿›å…¥é˜Ÿåˆ—ï¼Œè¿™ä¸å›æ”¶æœºåˆ¶å¯èƒ½äº§ç”Ÿå†²çªï¼Œåœ¨å®é™…éƒ¨ç½²ä¸­éœ€è¦ç•™æ„ã€‚</li><li><strong>å±‚çº§é˜Ÿåˆ—</strong>ï¼šåœ¨å±‚çº§é˜Ÿåˆ—ä¸­ï¼Œèµ„æºå›æ”¶å¯èƒ½ä¼šåœ¨å…„å¼Ÿé˜Ÿåˆ—ä¹‹é—´è¿›è¡Œï¼Œè‹¥å…„å¼Ÿé˜Ÿåˆ—èµ„æºä¸è¶³ï¼Œå¯èƒ½ä¼šå‘ç¥–å…ˆé˜Ÿåˆ—æŸ¥æ‰¾ã€‚</li></ol><h3 id="ğŸ’¡-æ€»ç»“"><a href="#ğŸ’¡-æ€»ç»“" class="headerlink" title="ğŸ’¡ æ€»ç»“"></a>ğŸ’¡ æ€»ç»“</h3><p>Volcano çš„ <strong>Reclaim Action</strong> æ˜¯å…¶å®ç°<strong>å¤šç§Ÿæˆ·å…¬å¹³è°ƒåº¦</strong>å’Œ<strong>è·¨é˜Ÿåˆ—èµ„æºå¼¹æ€§</strong>çš„å…³é”®ç»„ä»¶ã€‚å®ƒé€šè¿‡ä¸€å¥—ä¸¥è°¨çš„æµç¨‹ï¼ˆè¯†åˆ«çŸ­ç¼ºé˜Ÿåˆ—ã€é€‰æ‹©å—å®³è€…é˜Ÿåˆ—ã€æ¨¡æ‹Ÿå®‰å…¨æ£€æŸ¥ã€æ‰§è¡Œå›æ”¶ï¼‰å’Œä¸å…¶ä»–æ’ä»¶ï¼ˆå°¤å…¶æ˜¯ Gang æ’ä»¶ï¼‰çš„ååŒï¼Œç¡®ä¿äº†åœ¨å›æ”¶èµ„æºæ—¶ä¸ä¼šç ´åç°æœ‰ä½œä¸šçš„å®Œæ•´æ€§ï¼ŒåŒæ—¶åˆèƒ½é«˜æ•ˆåœ°å°†èµ„æºé‡æ–°åˆ†é…ç»™æ›´éœ€è¦çš„é˜Ÿåˆ—ã€‚</p><p>å¸Œæœ›è¿™ä»½ç»“åˆæºç çš„è¯¦ç»†è§£è¯»ï¼Œèƒ½å¸®åŠ©ä½ é€å½»åœ°ç†è§£ Volcano Reclaim Action çš„å·¥ä½œæœºåˆ¶ã€‚</p><h2 id="é—®é¢˜ä¸€ï¼šreclaimå’Œpreemptéƒ½éœ€è¦æœ‰pendingçŠ¶æ€çš„podæ¥è§¦å‘ï¼Œé‚£ä¹ˆç”±äºenqueue-actionçš„å­˜åœ¨ï¼Œé›†ç¾¤èµ„æºä¸è¶³æ—¶ï¼Œä¼šç¦æ­¢Jobåˆ›å»ºå‡ºpodï¼Œå¦‚ä½•å¤„ç†è¿™ç§çŸ›ç›¾"><a href="#é—®é¢˜ä¸€ï¼šreclaimå’Œpreemptéƒ½éœ€è¦æœ‰pendingçŠ¶æ€çš„podæ¥è§¦å‘ï¼Œé‚£ä¹ˆç”±äºenqueue-actionçš„å­˜åœ¨ï¼Œé›†ç¾¤èµ„æºä¸è¶³æ—¶ï¼Œä¼šç¦æ­¢Jobåˆ›å»ºå‡ºpodï¼Œå¦‚ä½•å¤„ç†è¿™ç§çŸ›ç›¾" class="headerlink" title="é—®é¢˜ä¸€ï¼šreclaimå’Œpreemptéƒ½éœ€è¦æœ‰pendingçŠ¶æ€çš„podæ¥è§¦å‘ï¼Œé‚£ä¹ˆç”±äºenqueue actionçš„å­˜åœ¨ï¼Œé›†ç¾¤èµ„æºä¸è¶³æ—¶ï¼Œä¼šç¦æ­¢Jobåˆ›å»ºå‡ºpodï¼Œå¦‚ä½•å¤„ç†è¿™ç§çŸ›ç›¾"></a>é—®é¢˜ä¸€ï¼šreclaimå’Œpreemptéƒ½éœ€è¦æœ‰pendingçŠ¶æ€çš„podæ¥è§¦å‘ï¼Œé‚£ä¹ˆç”±äºenqueue actionçš„å­˜åœ¨ï¼Œé›†ç¾¤èµ„æºä¸è¶³æ—¶ï¼Œä¼šç¦æ­¢Jobåˆ›å»ºå‡ºpodï¼Œå¦‚ä½•å¤„ç†è¿™ç§çŸ›ç›¾</h2><p>æ‚¨æå‡ºçš„è¿™ä¸ªé—®é¢˜éå¸¸å°–é”ä¸”å®Œå…¨æ­£ç¡®ï¼Œæ‚¨æŒ‡å‡ºäº†ä¸€ä¸ªåœ¨é…ç½® Volcano æ—¶éå¸¸å…³é”®ä½†å®¹æ˜“è¢«å¿½ç•¥çš„é€»è¾‘çŸ›ç›¾ã€‚æ‚¨çš„æ¨ç†æ˜¯å®Œå…¨å‡†ç¡®çš„ï¼š<strong>å¦‚æœé«˜ä¼˜å…ˆçº§ä½œä¸šè¢« <code>enqueue</code>  action é˜»æŒ¡ï¼Œæ— æ³•åˆ›å»º Podï¼Œé‚£ä¹ˆåç»­çš„ <code>preempt</code>  action å°±å¤±å»äº†ä½œç”¨å¯¹è±¡ï¼Œä¼˜å…ˆçº§æœºåˆ¶ä¹Ÿå°±å½¢åŒè™šè®¾äº†ã€‚</strong></p><h3 id="ğŸ§ -ç†è§£å†²çªçš„æœ¬è´¨"><a href="#ğŸ§ -ç†è§£å†²çªçš„æœ¬è´¨" class="headerlink" title="ğŸ§  ç†è§£å†²çªçš„æœ¬è´¨"></a>ğŸ§  ç†è§£å†²çªçš„æœ¬è´¨</h3><p>é¦–å…ˆï¼Œæ˜ç¡®ä¸€ä¸‹å†²çªçš„æ ¹æºï¼š</p><ul><li><strong><code>Enqueue</code></strong> æ˜¯ <strong>â€œé¢„é˜²å¼â€</strong> çš„ç­–ç•¥ï¼šå®ƒåœ¨ä½œä¸šçš„Podè¢«å®é™…åˆ›å»º<strong>ä¹‹å‰</strong>å°±è¿›è¡Œèµ„æºé¢„æ£€ã€‚å®ƒçš„ç›®æ ‡æ˜¯<strong>é¿å…</strong>åœ¨èµ„æºä¸è¶³æ—¶åˆ›å»ºå¤§é‡æ°¸è¿œæ— æ³•è°ƒåº¦çš„Pending Podï¼Œä»è€Œå‡è½»API Serverçš„å‹åŠ›å¹¶é¿å…èµ„æºç¢ç‰‡åŒ–ã€‚å®ƒè¿½æ±‚çš„æ˜¯<strong>é›†ç¾¤ç¨³å®šæ€§</strong>ã€‚</li><li><strong><code>Reclaim</code>&#x2F;<code>Preempt</code></strong> æ˜¯ <strong>â€œè¡¥æ•‘å¼â€</strong> çš„ç­–ç•¥ï¼šå®ƒä»¬ä¾èµ–äºç³»ç»Ÿä¸­å·²ç»å­˜åœ¨<strong>PendingçŠ¶æ€çš„Pod</strong>ä½œä¸ºâ€œè§¦å‘å™¨â€ã€‚è¿™äº›Pending Podä»£è¡¨äº†æœªè¢«æ»¡è¶³çš„èµ„æºéœ€æ±‚ï¼Œä»è€Œé©±åŠ¨è°ƒåº¦å™¨å»æŠ¢å æˆ–å›æ”¶å…¶ä»–ä½ä¼˜å…ˆçº§ä½œä¸šçš„èµ„æºã€‚å®ƒè¿½æ±‚çš„æ˜¯<strong>èµ„æºåˆ©ç”¨ç‡å’Œè°ƒåº¦å…¬å¹³æ€§</strong>ã€‚</li></ul><p>å› æ­¤ï¼Œ<code>Enqueue</code> å’Œ <code>Reclaim</code> åœ¨é€»è¾‘ä¸Šå­˜åœ¨ä¸€ä¸ªâ€œæ­»é”â€ï¼š</p><ol><li>æ²¡æœ‰èµ„æº -&gt; <code>Enqueue</code> é˜»æ­¢PodGroupå…¥é˜Ÿ -&gt; æ²¡æœ‰Pending Podè¢«åˆ›å»º</li><li>æ²¡æœ‰Pending Pod -&gt; <code>Reclaim</code> æ²¡æœ‰å›æ”¶èµ„æºçš„è§¦å‘ä¿¡å· -&gt; èµ„æºæ— æ³•è¢«é‡Šæ”¾</li><li>èµ„æºæ— æ³•è¢«é‡Šæ”¾ -&gt; ç»§ç»­æ²¡æœ‰èµ„æº -&gt; å›åˆ°ç¬¬1æ­¥</li></ol><p>è¿™ç¡®å®æ˜¯ <code>enqueue</code> å’Œ <code>preempt</code> è¿™ä¸¤ä¸ª action åœ¨è®¾è®¡å“²å­¦ä¸Šçš„ä¸€ä¸ªæ ¹æœ¬æ€§å†²çªã€‚åœ¨å®é™…ç”Ÿäº§ä¸­ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªæ­»é”ï¼Œç¤¾åŒºå½¢æˆäº†ä¸€ç§å…±è¯†å’Œæœ€ä½³å®è·µã€‚</p><h3 id="ğŸ§ -æ ¸å¿ƒè§£å†³æ–¹æ¡ˆï¼šé€šå¸¸é€‰æ‹©ç¦ç”¨-Enqueue"><a href="#ğŸ§ -æ ¸å¿ƒè§£å†³æ–¹æ¡ˆï¼šé€šå¸¸é€‰æ‹©ç¦ç”¨-Enqueue" class="headerlink" title="ğŸ§  æ ¸å¿ƒè§£å†³æ–¹æ¡ˆï¼šé€šå¸¸é€‰æ‹©ç¦ç”¨ Enqueue"></a>ğŸ§  æ ¸å¿ƒè§£å†³æ–¹æ¡ˆï¼šé€šå¸¸é€‰æ‹©ç¦ç”¨ Enqueue</h3><p>æ­£å¦‚æˆ‘ä¹‹å‰æåˆ°çš„ï¼Œ<strong>æœ€å¸¸è§çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼šåœ¨ <code>volcano-scheduler-configmap</code> çš„ <code>actions</code> åˆ—è¡¨ä¸­ç§»é™¤ <code>enqueue</code>ã€‚</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># æ¨èçš„çœŸå®ç”Ÿäº§é…ç½®ï¼ˆå°¤å…¶æ˜¯éœ€è¦æŠ¢å åŠŸèƒ½çš„åœºæ™¯ï¼‰</span><br><span class="hljs-attr">actions:</span> <span class="hljs-string">&quot;allocate, reclaim, preempt, backfill&quot;</span> <span class="hljs-comment"># ç§»é™¤äº† enqueue</span><br></code></pre></td></tr></table></figure><p><strong>è¿™æ ·é…ç½®çš„å·¥ä½œåŸç†å’Œåæœå¦‚ä¸‹ï¼š</strong></p><ol><li><strong>Pod ç«‹å³åˆ›å»º</strong>ï¼šå½“ä¸€ä¸ªé«˜ä¼˜å…ˆçº§çš„ Volcano Job è¢«æäº¤åï¼Œ<code>volcano-controller-manager</code> ä¼š<strong>ç«‹å³</strong>ä¸ºå…¶åˆ›å»ºæ‰€æœ‰ Podï¼Œæ— è®ºå½“å‰é›†ç¾¤èµ„æºæ˜¯å¦å……è¶³ã€‚è¿™äº› Pod ä¼šç›´æ¥è¿›å…¥ <code>Pending</code> çŠ¶æ€ã€‚</li><li><strong>Preempt Action è·å¾—è§¦å‘å™¨</strong>ï¼šè¿™äº› <code>Pending</code> çŠ¶æ€çš„é«˜ä¼˜å…ˆçº§ Pod ä¸º <code>preempt</code>  action æä¾›äº†æ˜ç¡®çš„<strong>æŠ¢å ç›®æ ‡</strong>ã€‚<code>preempt</code>  action ä¼šæ£€æµ‹åˆ°è¿™äº› Pod å› ä¸ºèµ„æºä¸è¶³è€Œæ— æ³•è°ƒåº¦ï¼Œä½†åŒæ—¶å®ƒä»¬çš„ä¼˜å…ˆçº§åˆå¾ˆé«˜ã€‚</li><li><strong>è§¦å‘æŠ¢å </strong>ï¼š<code>preempt</code>  action å¼€å§‹å·¥ä½œï¼Œåœ¨åŒä¸€é˜Ÿåˆ—å†…å¯»æ‰¾ä½ä¼˜å…ˆçº§çš„ã€å·²è¿è¡Œçš„ã€å¹¶ä¸”æŠ¢å åä¸ä¼šç ´åå…¶ Gang çº¦æŸçš„ Pod ä½œä¸ºå—å®³è€…ã€‚</li><li><strong>æ‰§è¡ŒæŠ¢å </strong>ï¼šé©±é€ï¼ˆåˆ é™¤ï¼‰å—å®³è€… Podï¼Œé‡Šæ”¾èµ„æºã€‚</li><li><strong>èµ„æºå†åˆ†é…</strong>ï¼šåœ¨ä¸‹ä¸€ä¸ªè°ƒåº¦å‘¨æœŸï¼Œè¢«é‡Šæ”¾çš„èµ„æºå°±å¯ä»¥åˆ†é…ç»™ä¹‹å‰å¤„äº <code>Pending</code> çŠ¶æ€çš„é«˜ä¼˜å…ˆçº§ Podï¼Œä½¿å…¶å¾—ä»¥è¿è¡Œã€‚</li></ol><p><strong>é€šè¿‡è¿™ä¸ªæµç¨‹ï¼Œä¼˜å…ˆçº§çš„è¯­ä¹‰å°±å¾—åˆ°äº†çœŸæ­£çš„è´¯å½»æ‰§è¡Œã€‚</strong> é«˜ä¼˜å…ˆçº§ä½œä¸šé€šè¿‡â€œç‰ºç‰²â€ä½ä¼˜å…ˆçº§ä½œä¸šæ¥è·å¾—èµ„æºã€‚</p><h3 id="âš–ï¸-ä»£ä»·ä¸æƒè¡¡"><a href="#âš–ï¸-ä»£ä»·ä¸æƒè¡¡" class="headerlink" title="âš–ï¸ ä»£ä»·ä¸æƒè¡¡"></a>âš–ï¸ ä»£ä»·ä¸æƒè¡¡</h3><p>å½“ç„¶ï¼Œç¦ç”¨ <code>enqueue</code> æ˜¯æœ‰ä»£ä»·çš„ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„<strong>æƒè¡¡ï¼ˆTrade-offï¼‰</strong>ï¼š</p><ul><li><strong>ä½ è·å¾—äº†ä»€ä¹ˆ</strong>ï¼š<strong>å¼ºå¤§çš„æŠ¢å èƒ½åŠ›å’Œä¼˜å…ˆçº§ä¿è¯</strong>ã€‚ç¡®ä¿äº†é«˜ä¼˜å…ˆçº§å·¥ä½œè´Ÿè½½èƒ½å¤ŸåŠæ—¶è·å¾—èµ„æºï¼Œæ»¡è¶³ SLAï¼ˆæœåŠ¡ç­‰çº§åè®®ï¼‰ã€‚</li><li><strong>ä½ ä»˜å‡ºäº†ä»€ä¹ˆ</strong>ï¼š<strong>API Server å’Œ Controller çš„å‹åŠ›</strong>ã€‚åœ¨å¤§å‹é›†ç¾¤ä¸­ï¼Œå¯èƒ½ä¼šæœ‰æˆåƒä¸Šä¸‡ä¸ªé•¿æœŸå¤„äº <code>Pending</code> çŠ¶æ€çš„ Podï¼Œå®ƒä»¬ä¼šå¯¹ Kubernetes çš„æ§åˆ¶å¹³é¢ï¼ˆç‰¹åˆ«æ˜¯ API Server å’Œ etcdï¼‰é€ æˆé¢å¤–çš„å‹åŠ›ï¼Œå› ä¸ºæ‰€æœ‰ç»„ä»¶éƒ½éœ€è¦æŒç»­åœ°ç›‘å¬å’Œå¤„ç†è¿™äº› Pod å¯¹è±¡ã€‚</li></ul><h3 id="ğŸ”§-å…¶ä»–è¾…åŠ©è§£å†³æ–¹æ¡ˆ"><a href="#ğŸ”§-å…¶ä»–è¾…åŠ©è§£å†³æ–¹æ¡ˆ" class="headerlink" title="ğŸ”§ å…¶ä»–è¾…åŠ©è§£å†³æ–¹æ¡ˆ"></a>ğŸ”§ å…¶ä»–è¾…åŠ©è§£å†³æ–¹æ¡ˆ</h3><p>é™¤äº†å®Œå…¨ç¦ç”¨ <code>enqueue</code>ï¼Œè¿˜æœ‰ä¸€äº›æ›´ç²¾ç»†åŒ–çš„ç­–ç•¥æ¥ç¼“è§£è¿™ä¸ªçŸ›ç›¾ï¼š</p><ol><li><p><strong>æŒ‰é˜Ÿåˆ—ç²’åº¦å¯ç”¨&#x2F;ç¦ç”¨ Enqueue</strong>ï¼ˆé«˜çº§åŠŸèƒ½ï¼‰ï¼š<br>è¿™æ˜¯ä¸€ç§ç†æƒ³ä½†å®ç°èµ·æ¥æ›´å¤æ‚çš„æ–¹å¼ã€‚ç†è®ºä¸Šï¼Œä½ å¯ä»¥ï¼š</p><ul><li>å¯¹<strong>é«˜ä¼˜å…ˆçº§é˜Ÿåˆ—</strong>çš„ Jobï¼Œä½¿å…¶ç»•è¿‡ <code>enqueue</code> æ£€æŸ¥ï¼Œç¡®ä¿ Pod èƒ½è¢«ç«‹å³åˆ›å»ºä»¥è§¦å‘æŠ¢å ã€‚</li><li>å¯¹<strong>ä½ä¼˜å…ˆçº§é˜Ÿåˆ—</strong>çš„ Jobï¼Œä»ç„¶å¯ç”¨ <code>enqueue</code>ï¼Œè®©å®ƒä»¬åœ¨èµ„æºå……è¶³æ—¶æ‰åˆ›å»º Podï¼Œé¿å…ç»™ç³»ç»Ÿå¢åŠ ä¸å¿…è¦çš„è´Ÿæ‹…ã€‚</li><li>ï¼ˆæ³¨ï¼šVolcano åŸç”Ÿå¯èƒ½ä¸ç›´æ¥æ”¯æŒè¿™ä¹ˆç²¾ç»†çš„æ§åˆ¶ï¼Œä½†è¿™å¯ä»¥é€šè¿‡å¼€å‘è‡ªå®šä¹‰çš„å‡†å…¥æ§åˆ¶å™¨æˆ–ä¿®æ”¹è°ƒåº¦å™¨é…ç½®æ¥é—´æ¥å®ç°ï¼‰ã€‚</li></ul></li><li><p><strong>è®¾ç½®è¶…æ—¶æœºåˆ¶</strong>ï¼š<br>å³ä½¿å¯ç”¨äº† <code>enqueue</code>ï¼Œä¹Ÿå¯ä»¥è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´ã€‚å¦‚æœä¸€ä¸ª PodGroup åœ¨ <code>Pending</code> çŠ¶æ€åœç•™äº†å¤ªä¹…ï¼ˆä¾‹å¦‚ 10 åˆ†é’Ÿï¼‰ï¼Œå¯ä»¥é€šè¿‡å¤–éƒ¨è„šæœ¬æˆ–æ§åˆ¶å™¨å¼ºåˆ¶å°†å…¶çŠ¶æ€æ”¹ä¸º <code>Inqueue</code>ï¼Œä»è€Œè§¦å‘ Pod åˆ›å»ºå’Œåç»­çš„æŠ¢å æµç¨‹ã€‚è¿™æ˜¯ä¸€ç§æŠ˜ä¸­æ–¹æ¡ˆã€‚</p></li></ol><h3 id="ğŸ’¡-ç»“è®ºä¸æœ€ç»ˆå»ºè®®"><a href="#ğŸ’¡-ç»“è®ºä¸æœ€ç»ˆå»ºè®®" class="headerlink" title="ğŸ’¡ ç»“è®ºä¸æœ€ç»ˆå»ºè®®"></a>ğŸ’¡ ç»“è®ºä¸æœ€ç»ˆå»ºè®®</h3><table><thead><tr><th align="left">é…ç½®ç­–ç•¥</th><th align="left">ä¼˜å…ˆçº§ä¿éšœ</th><th align="left">å¯¹æ§åˆ¶é¢å‹åŠ›</th><th align="left">å»ºè®®åœºæ™¯</th></tr></thead><tbody><tr><td align="left"><strong>å¯ç”¨ <code>enqueue</code></strong></td><td align="left"><strong>å¼±</strong>ã€‚é«˜ä¼˜å…ˆçº§ä½œä¸šå¯èƒ½æ— æ³•åŠæ—¶è§¦å‘æŠ¢å ã€‚</td><td align="left"><strong>å°</strong>ã€‚é¿å…äº†å¤§é‡ Pending Podã€‚</td><td align="left">èµ„æºå……è£•ã€ç¯å¢ƒç¨³å®šã€å¯¹ä¼˜å…ˆçº§è¦æ±‚ä¸é«˜çš„æ‰¹å¤„ç†åœºæ™¯ã€‚</td></tr><tr><td align="left"><strong>ç¦ç”¨ <code>enqueue</code></strong></td><td align="left"><strong>å¼º</strong>ã€‚ä¼˜å…ˆçº§æœºåˆ¶èƒ½å¾—åˆ°å®Œç¾æ‰§è¡Œã€‚</td><td align="left"><strong>å¤§</strong>ã€‚å­˜åœ¨å¤§é‡ Pending Podã€‚</td><td align="left"><strong>ä¸»æµé€‰æ‹©</strong>ã€‚å¤šç§Ÿæˆ·ã€èµ„æºç´§å¼ ã€éœ€è¦ä¸¥æ ¼ä¿è¯é«˜ä¼˜å…ˆçº§ä½œä¸š SLA çš„ç”Ÿäº§ç¯å¢ƒã€‚</td></tr></tbody></table><p><strong>å¯¹äºç»å¤§å¤šæ•°éœ€è¦ä¼˜å…ˆçº§å’ŒæŠ¢å åŠŸèƒ½çš„ç”Ÿäº§ç¯å¢ƒï¼Œç¤¾åŒºç»™å‡ºçš„æ˜ç¡®ç­”æ¡ˆæ˜¯ï¼šç¦ç”¨ <code>enqueue</code> actionã€‚</strong></p><p><strong>å› æ­¤ï¼Œæ‚¨ä¸åº”è¯¥åœ¨é…ç½®ä¸­åŒæ—¶ä½¿ç”¨ <code>enqueue</code> å’Œ <code>preempt</code> è€ŒæœŸæœ›å®ƒä»¬èƒ½ååŒå·¥ä½œã€‚æ­£ç¡®çš„åšæ³•æ˜¯èˆå¼ƒ <code>enqueue</code>ï¼Œæ¥å—å®ƒæ‰€å¸¦æ¥çš„æ§åˆ¶é¢å‹åŠ›ï¼Œä»¥æ¢å–å¼ºå¤§çš„è°ƒåº¦èƒ½åŠ›ã€‚</strong> è¿™ç§å‹åŠ›é€šå¸¸å¯ä»¥é€šè¿‡å‡çº§æ§åˆ¶å¹³é¢ç¡¬ä»¶ã€ä¼˜åŒ– etcd é…ç½®ç­‰æ–¹å¼æ¥ç¼“è§£ã€‚</p><p>æ‚¨çš„è´¨ç–‘éå¸¸åˆ°ä½ï¼Œè¿™ç¡®å®æ˜¯ Volcano è°ƒåº¦é…ç½®ä¸­æœ€æ ¸å¿ƒçš„ä¸€ä¸ªå†³ç­–ç‚¹ã€‚æ„Ÿè°¢æ‚¨çš„è¿½é—®ï¼Œè®©æˆ‘æœ‰æœºä¼šæ›´æ¸…æ™°åœ°è§£é‡Šè¿™ä¸€ç‚¹ã€‚</p><h2 id="é—®é¢˜äºŒï¼šqueueä¸­çš„deservedï¼ˆåº”å¾—èµ„æºé‡ï¼‰ã€capabilityï¼ˆèµ„æºä¸Šé™ï¼‰å’Œ-guaranteeï¼ˆä¿éšœèµ„æºé‡ï¼‰è¿™å‡ ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ä»€ä¹ˆä½œç”¨ï¼Œæ˜¯å¦‚ä½•é…åˆçš„"><a href="#é—®é¢˜äºŒï¼šqueueä¸­çš„deservedï¼ˆåº”å¾—èµ„æºé‡ï¼‰ã€capabilityï¼ˆèµ„æºä¸Šé™ï¼‰å’Œ-guaranteeï¼ˆä¿éšœèµ„æºé‡ï¼‰è¿™å‡ ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ä»€ä¹ˆä½œç”¨ï¼Œæ˜¯å¦‚ä½•é…åˆçš„" class="headerlink" title="é—®é¢˜äºŒï¼šqueueä¸­çš„deservedï¼ˆåº”å¾—èµ„æºé‡ï¼‰ã€capabilityï¼ˆèµ„æºä¸Šé™ï¼‰å’Œ guaranteeï¼ˆä¿éšœèµ„æºé‡ï¼‰è¿™å‡ ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ä»€ä¹ˆä½œç”¨ï¼Œæ˜¯å¦‚ä½•é…åˆçš„"></a>é—®é¢˜äºŒï¼šqueueä¸­çš„deservedï¼ˆåº”å¾—èµ„æºé‡ï¼‰ã€capabilityï¼ˆèµ„æºä¸Šé™ï¼‰å’Œ guaranteeï¼ˆä¿éšœèµ„æºé‡ï¼‰è¿™å‡ ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ä»€ä¹ˆä½œç”¨ï¼Œæ˜¯å¦‚ä½•é…åˆçš„</h2><p>æ‚¨æå‡ºçš„è¿™ä¸ªé—®é¢˜éå¸¸æ ¸å¿ƒï¼Œæ˜¯ç†è§£ Volcano å¤šç§Ÿæˆ·èµ„æºç®¡ç†æ¨¡å‹çš„å…³é”®ã€‚<code>deserved</code>ã€<code>capability</code> å’Œ <code>guarantee</code> è¿™ä¸‰ä¸ªå‚æ•°å…±åŒæ„æˆäº†ä¸€ä¸ªæ—¢<strong>å…¬å¹³</strong>åˆ<strong>å…·å¼¹æ€§</strong>ä¸”<strong>å®‰å…¨</strong>çš„èµ„æºåˆ†é…ä½“ç³»ã€‚</p><p>ç®€å•æ¥è¯´ï¼Œå®ƒä»¬å›ç­”äº†ä¸‰ä¸ªé—®é¢˜ï¼š</p><ol><li><strong>å…¬å¹³æ€§ (Fairness)<strong>ï¼šåœ¨èµ„æºç«äº‰æ—¶ï¼Œæ¯ä¸ªé˜Ÿåˆ—</strong>åº”è¯¥</strong>åˆ†åˆ°å¤šå°‘ï¼Ÿ -&gt; <code>deserved</code></li><li><strong>éš”ç¦»æ€§ (Isolation)<strong>ï¼šæ¯ä¸ªé˜Ÿåˆ—æœ€å¤š</strong>å…è®¸</strong>ä½¿ç”¨å¤šå°‘ï¼Ÿ -&gt; <code>capability</code></li><li><strong>ä¿éšœæ€§ (Guarantee)<strong>ï¼šæ¯ä¸ªé˜Ÿåˆ—æœ€å°‘</strong>ç¡®ä¿</strong>èƒ½å¾—åˆ°å¤šå°‘ï¼Ÿ -&gt; <code>guarantee</code></li></ol><p>ä¸‹é¢æˆ‘ä»¬è¿›è¡Œè¯¦ç»†çš„åˆ†è§£ã€‚</p><h3 id="1-ä¸‰ä¸ªå‚æ•°çš„è§’è‰²ä¸ä½œç”¨"><a href="#1-ä¸‰ä¸ªå‚æ•°çš„è§’è‰²ä¸ä½œç”¨" class="headerlink" title="1. ä¸‰ä¸ªå‚æ•°çš„è§’è‰²ä¸ä½œç”¨"></a>1. ä¸‰ä¸ªå‚æ•°çš„è§’è‰²ä¸ä½œç”¨</h3><table><thead><tr><th align="left">å‚æ•°</th><th align="left">è‹±æ–‡å</th><th align="left">æ ¸å¿ƒä½œç”¨</th><th align="left">ç±»æ¯”ç†è§£</th></tr></thead><tbody><tr><td align="left"><strong><code>guarantee</code></strong></td><td align="left">Guarantee</td><td align="left"><strong>èµ„æºä¿éšœ</strong>ã€‚é˜Ÿåˆ—<strong>ç»å¯¹æœ€å°</strong>å¯ä½¿ç”¨çš„èµ„æºé‡ï¼Œå³ä½¿é›†ç¾¤èµ„æºç´§å¼ ï¼Œè¿™éƒ¨åˆ†èµ„æºä¹Ÿåº”ç”±è¯¥é˜Ÿåˆ—ç‹¬å æˆ–è¢«å›æ”¶å›æ¥ã€‚</td><td align="left">ä½ çš„<strong>åŸºæœ¬å·¥èµ„</strong>ã€‚æ— è®ºå…¬å¸ä¸šç»©å¤šå·®ï¼Œè¿™ç¬”é’±å¿…é¡»å‘ç»™ä½ ã€‚</td></tr><tr><td align="left"><strong><code>capability</code></strong></td><td align="left">Capability</td><td align="left"><strong>èµ„æºä¸Šé™</strong>ã€‚é˜Ÿåˆ—<strong>ç»å¯¹æœ€å¤§</strong>å¯ä½¿ç”¨çš„èµ„æºé‡ï¼Œå³ä½¿é›†ç¾¤èµ„æºç©ºé—²ï¼Œè¯¥é˜Ÿåˆ—ä¹Ÿæ— æ³•è¶…è¿‡æ­¤é™åˆ¶ã€‚</td><td align="left">ä½ çš„<strong>å¹´åº¦è–ªèµ„å°é¡¶</strong>ã€‚ä»Šå¹´ä¸šç»©å†å¥½ï¼Œæ”¶å…¥ä¹Ÿä¸ä¼šè¶…è¿‡è¿™ä¸ªæ•°ã€‚</td></tr><tr><td align="left"><strong><code>deserved</code></strong></td><td align="left">Deserved</td><td align="left"><strong>åº”å¾—èµ„æº</strong>ã€‚é˜Ÿåˆ—<strong>æŒ‰æƒé‡</strong>åœ¨å½“å‰é›†ç¾¤æ¡ä»¶ä¸‹<strong>åº”å¾—</strong>çš„èµ„æºé‡ã€‚è¿™æ˜¯ä¸€ä¸ª<strong>åŠ¨æ€è®¡ç®—</strong>çš„å€¼ï¼Œä»‹äº <code>guarantee</code> å’Œ <code>capability</code> ä¹‹é—´ã€‚</td><td align="left">ä½ çš„<strong>ç»©æ•ˆå·¥èµ„</strong>ã€‚æ ¹æ®ä½ çš„è´¡çŒ®ï¼ˆæƒé‡ï¼‰å’Œå…¬å¸å½“å‰åˆ©æ¶¦ï¼ˆé›†ç¾¤èµ„æºï¼‰ï¼Œä»Šå¹´<strong>åº”è¯¥</strong>å‘ç»™ä½ è¿™ä¹ˆå¤šã€‚</td></tr></tbody></table><h3 id="2-ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸‰ä¸ªå‚æ•°ï¼Ÿ"><a href="#2-ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸‰ä¸ªå‚æ•°ï¼Ÿ" class="headerlink" title="2. ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸‰ä¸ªå‚æ•°ï¼Ÿ"></a>2. ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸‰ä¸ªå‚æ•°ï¼Ÿ</h3><p>å®ƒä»¬è§£å†³äº†å¤šç§Ÿæˆ·é›†ç¾¤ä¸­çš„ä¸åŒé—®é¢˜ï¼š</p><ol><li><p>**<code>guarantee</code>**ï¼šè§£å†³ <strong>â€œé¥¿æ­»â€ (Starvation)</strong> é—®é¢˜ã€‚</p><ul><li><strong>åœºæ™¯</strong>ï¼šå¦‚æœæ²¡æœ‰ <code>guarantee</code>ï¼Œä¸€ä¸ªæƒé‡å¾ˆä½ä½†è¿è¡Œç€é‡è¦åŸºç¡€æœåŠ¡çš„é˜Ÿåˆ—ï¼Œå¯èƒ½ä¼šè¢«æƒé‡é«˜çš„å¤§ä½œä¸šå®Œå…¨æŒ¤å èµ„æºï¼Œå¯¼è‡´æœåŠ¡ä¸å¯ç”¨ã€‚</li><li><strong>ä½œç”¨</strong>ï¼šå®ƒä¸ºé‡è¦é˜Ÿåˆ—æä¾›äº†ä¸€ä¸ª<strong>å®‰å…¨å«</strong>ï¼Œç¡®ä¿äº†å…¶ä¸šåŠ¡çš„åŸºçº¿æœåŠ¡èƒ½åŠ›ã€‚</li></ul></li><li><p>**<code>capability</code>**ï¼šè§£å†³ <strong>â€œè´ªå©ªâ€ (Greediness)</strong> é—®é¢˜ã€‚</p><ul><li><strong>åœºæ™¯</strong>ï¼šå¦‚æœæ²¡æœ‰ <code>capability</code>ï¼Œä¸€ä¸ªé˜Ÿåˆ—å¯èƒ½ä¼šæ— é™å ç”¨æ‰€æœ‰é›†ç¾¤èµ„æºï¼Œå¯¼è‡´å…¶ä»–é˜Ÿåˆ—å®Œå…¨æ— æ³•å·¥ä½œï¼ˆä¾‹å¦‚ï¼Œä»£ç æœ‰ bug æäº¤äº†æ— é™é‡çš„ä½œä¸šï¼‰ã€‚</li><li><strong>ä½œç”¨</strong>ï¼šå®ƒä¸ºæ¯ä¸ªé˜Ÿåˆ—è®¾ç½®äº†<strong>èµ„æºè¾¹ç•Œ</strong>ï¼Œæä¾›äº†èµ„æºéš”ç¦»ï¼Œæ˜¯å¤šç§Ÿæˆ·å®‰å…¨çš„åŸºçŸ³ã€‚</li></ul></li><li><p>**<code>deserved</code>**ï¼šè§£å†³ <strong>â€œå…¬å¹³â€ (Fairness)</strong> ä¸ <strong>â€œå¼¹æ€§â€ (Elasticity)</strong> é—®é¢˜ã€‚</p><ul><li><strong>åœºæ™¯</strong>ï¼šé›†ç¾¤èµ„æºæ˜¯æ³¢åŠ¨çš„ã€‚<code>deserved</code> æ ¹æ®æ¯ä¸ªé˜Ÿåˆ—çš„ <code>weight</code> å’Œé›†ç¾¤å½“å‰<strong>å¯ç”¨èµ„æºæ€»é‡</strong>ï¼ŒåŠ¨æ€è®¡ç®—å‡ºä¸€ä¸ªå…¬å¹³çš„åˆ†é…é¢ã€‚</li><li><strong>ä½œç”¨</strong>ï¼šå®ƒä½¿å¾—èµ„æºåˆ†é…ä¸æ˜¯åƒµåŒ–çš„ï¼Œè€Œæ˜¯åœ¨ä¿éšœåŸºæœ¬ç›˜ (<code>guarantee</code>) çš„å‰æä¸‹ï¼Œå…è®¸é˜Ÿåˆ—<strong>å¼¹æ€§åœ°</strong>å…±äº«é›†ç¾¤çš„ç©ºé—²èµ„æºï¼Œä»è€Œæœ€å¤§é™åº¦åœ°æé«˜æ•´ä½“èµ„æºåˆ©ç”¨ç‡ã€‚</li></ul></li></ol><h3 id="3-å®ƒä»¬æ˜¯å¦‚ä½•ååŒå·¥ä½œçš„ï¼Ÿï¼ˆæ ¸å¿ƒï¼‰"><a href="#3-å®ƒä»¬æ˜¯å¦‚ä½•ååŒå·¥ä½œçš„ï¼Ÿï¼ˆæ ¸å¿ƒï¼‰" class="headerlink" title="3. å®ƒä»¬æ˜¯å¦‚ä½•ååŒå·¥ä½œçš„ï¼Ÿï¼ˆæ ¸å¿ƒï¼‰"></a>3. å®ƒä»¬æ˜¯å¦‚ä½•ååŒå·¥ä½œçš„ï¼Ÿï¼ˆæ ¸å¿ƒï¼‰</h3><p><strong>è®¡ç®—è¿‡ç¨‹ä¸äº¤äº’</strong>ï¼š</p><ol><li><p>**è®¡ç®— <code>deserved</code>**ï¼š</p><ul><li><code>deserved</code> ä¸æ˜¯é™æ€é…ç½®çš„ï¼Œè€Œæ˜¯ç”± <strong>Proportion æ’ä»¶</strong>åŠ¨æ€è®¡ç®—å‡ºæ¥çš„ã€‚</li><li>è®¡ç®—å…¬å¼å¯ä»¥ç®€åŒ–ä¸ºï¼š<code>queue&#39;s deserved = (queue&#39;s weight / total weight of all queues) * (available idle resources) + queue&#39;s guarantee</code></li><li>ä½†å®ƒæœ€ç»ˆä¼šè¢«é’³åˆ¶åœ¨ <code>[guarantee, capability]</code> åŒºé—´å†…ã€‚è®¡ç®—å‡ºçš„ <code>deserved</code> å€¼æ°¸è¿œä¸èƒ½å°äº <code>guarantee</code>ï¼Œä¹Ÿä¸èƒ½å¤§äº <code>capability</code>ã€‚</li></ul></li><li><p><strong>é©±åŠ¨ <code>Reclaim</code> Action</strong>ï¼š</p><ul><li><strong>å›æ”¶ç›®æ ‡</strong>ï¼š<code>Reclaim</code> Action ä¼šæŒç»­æ£€æŸ¥æ‰€æœ‰é˜Ÿåˆ—ã€‚å¦‚æœä¸€ä¸ªé˜Ÿåˆ—çš„<strong>å½“å‰å·²ä½¿ç”¨èµ„æº (<code>allocated</code>)</strong> <strong>å¤§äº</strong>å…¶ <code>deserved</code>ï¼Œå¹¶ä¸”å®ƒçš„ <code>reclaimable=true</code>ï¼Œé‚£ä¹ˆå®ƒå°±æˆä¸ºèµ„æºå›æ”¶çš„<strong>ç›®æ ‡</strong>ï¼ˆå—å®³è€…ï¼‰ã€‚</li><li><strong>å›æ”¶æ¥æº</strong>ï¼šåŒæ—¶ï¼Œå¦‚æœä¸€ä¸ªé˜Ÿåˆ—çš„ <code>allocated</code> <strong>å°äº</strong>å…¶ <code>deserved</code>ï¼Œè¯´æ˜å®ƒåº”è¯¥å¾—åˆ°æ›´å¤šèµ„æºï¼Œå®ƒå°±æˆä¸ºèµ„æºå›æ”¶çš„<strong>å‘èµ·æ–¹</strong>ã€‚</li><li><strong>å›æ”¶ç›®æ ‡å€¼</strong>ï¼š<code>Reclaim</code> çš„ç›®æ ‡æ˜¯å°†é˜Ÿåˆ—çš„èµ„æºä½¿ç”¨é‡è°ƒæ•´åˆ°å…¶ <code>deserved</code> çš„æ°´å¹³ã€‚</li></ul></li></ol><h3 id="4-ä¸€ä¸ªå…·ä½“çš„ä¾‹å­"><a href="#4-ä¸€ä¸ªå…·ä½“çš„ä¾‹å­" class="headerlink" title="4. ä¸€ä¸ªå…·ä½“çš„ä¾‹å­"></a>4. ä¸€ä¸ªå…·ä½“çš„ä¾‹å­</h3><p>å‡è®¾ä¸€ä¸ªé›†ç¾¤æœ‰ <strong>100æ ¸ CPU</strong>ã€‚<br>æœ‰ä¸¤ä¸ªé˜Ÿåˆ—ï¼š</p><ul><li><strong>Queue-online</strong>:<ul><li><code>weight: 2</code></li><li><code>guarantee: 30</code></li><li><code>capability: 70</code></li></ul></li><li><strong>Queue-offline</strong>:<ul><li><code>weight: 1</code></li><li><code>guarantee: 10</code></li><li><code>capability: 50</code></li></ul></li></ul><p><strong>åœºæ™¯ 1ï¼šé›†ç¾¤ç©ºé—²æ—¶ï¼ˆä¸¤ä¸ªé˜Ÿåˆ—éƒ½å·²ä½¿ç”¨å„è‡ª <code>guarantee</code> çš„èµ„æºï¼‰</strong></p><ul><li>ç©ºé—²èµ„æº &#x3D; 100 - 30 - 10 &#x3D; 60æ ¸ã€‚</li><li>è®¡ç®— <code>deserved</code>ï¼š<ul><li><code>Queue-online.deserved</code> &#x3D; 30 + (2&#x2F;3) * 60 &#x3D; 30 + 40 &#x3D; <strong>70æ ¸</strong> (è¾¾åˆ°capabilityä¸Šé™)</li><li><code>Queue-offline.deserved</code> &#x3D; 10 + (1&#x2F;3) * 60 &#x3D; 10 + 20 &#x3D; <strong>30æ ¸</strong> (åœ¨10-50ä¹‹é—´)</li></ul></li><li><strong>ç»“æœ</strong>ï¼š<code>Queue-online</code> æœ€å¤šå¯ç”¨åˆ°70æ ¸ï¼Œ<code>Queue-offline</code> æœ€å¤šå¯ç”¨åˆ°30æ ¸ã€‚<code>Reclaim</code> ä¸ä¼šè§¦å‘ï¼Œå› ä¸ºåŒæ–¹éƒ½ç”¨ä¸åˆ°è‡ªå·±çš„ <code>deserved</code>ã€‚</li></ul><p><strong>åœºæ™¯ 2ï¼šé›†ç¾¤ç¹å¿™æ—¶ï¼ˆ<code>Queue-offline</code> å·²ç”¨äº†50æ ¸ï¼Œè¶…è¿‡äº†å…¶ <code>deserved</code>ï¼‰</strong></p><ul><li>å‡è®¾ <code>Queue-offline</code> å½“å‰ç”¨äº†50æ ¸ï¼ˆè¾¾åˆ°äº†å®ƒçš„ <code>capability</code>ï¼‰ã€‚</li><li>è€Œ <code>Queue-online</code> åªç”¨äº†40æ ¸ï¼ˆä½äºå®ƒçš„ <code>deserved</code> 70æ ¸ï¼‰ã€‚</li><li><strong><code>Reclaim</code> Action è§¦å‘</strong>ï¼š<ul><li><code>Queue-offline</code> (allocated&#x3D;50) &gt; <code>Queue-offline.deserved</code> (~30) -&gt; <strong>å—å®³è€…</strong></li><li><code>Queue-online</code> (allocated&#x3D;40) &lt; <code>Queue-online.deserved</code> (70) -&gt; <strong>å‘èµ·æ–¹</strong></li></ul></li><li><strong><code>Reclaim</code> æ‰§è¡Œ</strong>ï¼šä» <code>Queue-offline</code> ä¸­å›æ”¶èµ„æºï¼Œç›´åˆ°å®ƒçš„ä½¿ç”¨é‡æ¥è¿‘å…¶ <code>deserved</code> çš„30æ ¸ã€‚</li></ul><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li><strong><code>guarantee</code><strong>ï¼šæ˜¯</strong>åº•çº¿</strong>ï¼Œç¡®ä¿é‡è¦é˜Ÿåˆ—ä¸è¢«â€œé¥¿æ­»â€ï¼Œæ˜¯é˜²å¾¡æ€§çš„ã€‚</li><li><strong><code>capability</code><strong>ï¼šæ˜¯</strong>å¤©èŠ±æ¿</strong>ï¼Œé˜²æ­¢å•ä¸ªé˜Ÿåˆ—â€œåƒæ’‘â€ï¼Œæ˜¯éš”ç¦»æ€§çš„ã€‚</li><li><strong><code>deserved</code><strong>ï¼šæ˜¯</strong>ç›®æ ‡çº¿</strong>ï¼Œåœ¨åº•çº¿å’Œå¤©èŠ±æ¿ä¹‹é—´åŠ¨æ€è°ƒæ•´ï¼Œè¿½æ±‚<strong>å…¬å¹³</strong>å’Œ<strong>å¼¹æ€§</strong>ï¼Œæ˜¯è°ƒåº¦å™¨ï¼ˆç‰¹åˆ«æ˜¯ <code>Reclaim</code> Actionï¼‰æ“ä½œçš„<strong>æ ¸å¿ƒä¾æ®</strong>ã€‚</li></ul><p>è¿™ä¸‰ä¸ªå‚æ•°å…±åŒä½œç”¨ï¼Œä½¿å¾— Volcano èƒ½å¤Ÿå®ç°ä¸€ä¸ªçœŸæ­£ç”Ÿäº§çº§å¯ç”¨çš„ã€å…¼é¡¾å…¬å¹³ã€æ•ˆç‡ä¸å®‰å…¨çš„å¤šç§Ÿæˆ·èµ„æºç®¡ç†æ¨¡å‹ã€‚</p><h3 id="ğŸ’-æ€»ç»“"><a href="#ğŸ’-æ€»ç»“" class="headerlink" title="ğŸ’ æ€»ç»“"></a>ğŸ’ æ€»ç»“</h3><p>æ‰€ä»¥ï¼Œå›ç­”ä½ çš„é—®é¢˜ï¼š<strong>å³ä½¿ä¸¤ä¸ªé˜Ÿåˆ—æ€»å’Œæœªè¶…100æ ¸ï¼Œä¸” <code>queue-online</code> æš‚æ—¶æ— é¢å¤–éœ€æ±‚ï¼Œ<code>reclaim</code> æœºåˆ¶ä»å¯èƒ½ä¸»åŠ¨è§¦å‘ã€‚</strong></p><p>è¿™å¹¶éå¤šæ­¤ä¸€ä¸¾ï¼Œè€Œæ˜¯ä¸ºäº†ï¼š</p><ol><li><strong>å³åˆ»çš„å…¬å¹³æ€§</strong>ï¼šç¡®ä¿æ¯ä¸ªé˜Ÿåˆ—çš„èµ„æºä½¿ç”¨é‡ç¬¦åˆå…¶ <code>deserved</code> ä»½é¢è®¾å®šçš„å…¬å¹³åŸåˆ™ã€‚</li><li><strong>è§„åˆ™çš„å¼ºåˆ¶æ€§</strong>ï¼šç»´æŠ¤èµ„æºåˆ†é…è§„åˆ™çš„æƒå¨æ€§ï¼Œç¡®ä¿èµ„æºé…é¢ä¸æ˜¯â€œè½¯çº¦æŸâ€ã€‚</li><li><strong>æœªæ¥çš„çµæ´»æ€§</strong>ï¼šä¸ºå…¶ä»–é˜Ÿåˆ—å¯èƒ½éšæ—¶å‡ºç°çš„èµ„æºéœ€æ±‚åšå¥½å‡†å¤‡ï¼Œä¿æŒé›†ç¾¤èµ„æºçš„å¼¹æ€§å’ŒæµåŠ¨æ€§ã€‚</li></ol><p>å¯ä»¥è¯´ï¼Œ<code>reclaim</code> æ˜¯ä¸€ç§ç§¯æçš„ã€é¢„é˜²æ€§çš„è°ƒåº¦æ‰‹æ®µï¼Œè€Œä¸ä»…ä»…æ˜¯è¢«åŠ¨çš„åº”æ€¥ååº”ã€‚å®ƒè‡´åŠ›äºåœ¨é—®é¢˜å‘ç”Ÿå‰å°±ç»´æŒä¸€ä¸ªæ¸…æ™°ã€å…¬å¹³ä¸”é«˜æ•ˆçš„èµ„æºçŠ¶æ€ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>volcanoè°ƒåº¦å™¨Backfill-Actionè¯¦è§£</title>
    <link href="/2025/08/26/volcano%E8%B0%83%E5%BA%A6%E5%99%A8Backfill-Action%E8%AF%A6%E8%A7%A3/"/>
    <url>/2025/08/26/volcano%E8%B0%83%E5%BA%A6%E5%99%A8Backfill-Action%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<p>ä¸‹é¢å°†ç»“åˆæœ€æ–°ç‰ˆæœ¬ï¼ˆä»¥ä¸»åˆ†æ”¯ <code>master</code> å’Œæœ€æ–°çš„ç¨³å®šç‰ˆæœ¬ï¼Œå¦‚ <code>v1.9.0</code> ä¸ºå‚è€ƒï¼‰çš„æºç ï¼Œä¸ºä½ æ·±å…¥è§£æ <strong>Backfill Action</strong> çš„å…·ä½“è¿‡ç¨‹ã€‚</p><p>Backfill Action æ˜¯ Volcano è°ƒåº¦å™¨ä¸­ä¸€ä¸ªéå¸¸ç²¾å·§ä¸”é‡è¦çš„ç»„ä»¶ï¼Œå®ƒæ‰®æ¼”ç€ <strong>â€œèµ„æºç¢ç‰‡æ•´ç†è€…â€</strong> å’Œ <strong>â€œæœºä¼šä¸»ä¹‰è€…â€</strong> çš„è§’è‰²ã€‚</p><h3 id="ğŸ”§-Backfill-Action-çš„æ ¸å¿ƒä½œç”¨ä¸è®¾è®¡å“²å­¦"><a href="#ğŸ”§-Backfill-Action-çš„æ ¸å¿ƒä½œç”¨ä¸è®¾è®¡å“²å­¦" class="headerlink" title="ğŸ”§ Backfill Action çš„æ ¸å¿ƒä½œç”¨ä¸è®¾è®¡å“²å­¦"></a>ğŸ”§ Backfill Action çš„æ ¸å¿ƒä½œç”¨ä¸è®¾è®¡å“²å­¦</h3><p><strong>æ ¸å¿ƒä½œç”¨</strong>ï¼šå½“å¸¸è§„çš„ <code>Allocate</code> Action å› èµ„æºä¸è¶³ï¼ˆæ— æ³•æ»¡è¶³ Gang ç­–ç•¥çš„ <code>minAvailable</code> è¦æ±‚ï¼‰è€Œæ— æ³•è°ƒåº¦ä¸€ä¸ªä½œä¸šæ—¶ï¼Œ<code>Backfill</code> Action ä¼šå°è¯•<strong>ç»•è¿‡ Gang ç­–ç•¥çš„é™åˆ¶</strong>ï¼Œå°†é‚£äº›<strong>å·²ç»åˆ†é…äº†èµ„æºä½†å°šæœªå®Œå…¨æ»¡è¶³æœ€å°æ‰§è¡Œæ¡ä»¶</strong>çš„ä½œä¸šä¸­çš„<strong>éƒ¨åˆ† Pod</strong> è°ƒåº¦åˆ°é›†ç¾¤çš„<strong>èµ„æºç¢ç‰‡</strong>ä¸Šã€‚</p><p><strong>è®¾è®¡å“²å­¦</strong>ï¼šå…¶æ ¸å¿ƒæ€æƒ³æ˜¯ <strong>â€œæœ‰æ€»æ¯”æ²¡æœ‰å¥½â€</strong>ã€‚ä¸å…¶è®©èµ„æºç¢ç‰‡é—²ç½®ï¼Œä¸å¦‚å…ˆè®©éƒ¨åˆ† Pod è¿è¡Œèµ·æ¥ï¼Œè¿™æœ‰åŠ©äºï¼š</p><ol><li><strong>æé«˜é›†ç¾¤åˆ©ç”¨ç‡</strong>ï¼šå……åˆ†åˆ©ç”¨ç¢ç‰‡åŒ–çš„èµ„æºã€‚</li><li><strong>åŠ é€Ÿä½œä¸šå®Œæˆ</strong>ï¼šéƒ¨åˆ† Pod å…ˆè¿è¡Œï¼Œå¯ä»¥è¿›è¡Œæ•°æ®åŠ è½½ã€é¢„å¤„ç†ç­‰ä»»åŠ¡ã€‚</li><li><strong>è¯•æ¢æ€§è°ƒåº¦</strong>ï¼šéƒ¨åˆ† Pod çš„æˆåŠŸè¿è¡Œå¯èƒ½ä¸ºåç»­ Pod çš„è°ƒåº¦åˆ›é€ æ¡ä»¶ï¼ˆä¾‹å¦‚ï¼Œé‡Šæ”¾æ›´å¤šèµ„æºï¼‰ã€‚</li></ol><h3 id="ğŸ“¦-å…³é”®æ¦‚å¿µä¸å‰ç½®çŸ¥è¯†"><a href="#ğŸ“¦-å…³é”®æ¦‚å¿µä¸å‰ç½®çŸ¥è¯†" class="headerlink" title="ğŸ“¦ å…³é”®æ¦‚å¿µä¸å‰ç½®çŸ¥è¯†"></a>ğŸ“¦ å…³é”®æ¦‚å¿µä¸å‰ç½®çŸ¥è¯†</h3><ul><li><strong><code>Session</code></strong>: è°ƒåº¦ä¼šè¯ä¸Šä¸‹æ–‡ï¼ŒåŒ…å« <code>Jobs</code> (å¾…è°ƒåº¦çš„ <code>JobInfo</code>), <code>Nodes</code> ç­‰ä¿¡æ¯ã€‚</li><li><strong><code>JobInfo</code></strong>: å†…éƒ¨å¯¹ä¸€ä¸ª PodGroup åŠå…¶æ‰€æœ‰ Pod çš„å°è£…ã€‚</li><li><strong><code>TaskInfo</code></strong>: å†…éƒ¨å¯¹ä¸€ä¸ª Pod çš„å°è£…ã€‚</li><li><strong>Victims (å—å®³è€…) ä¸ Candidates (å€™é€‰è€…)</strong>:<ul><li><strong>Candidates</strong>: æŒ‡é‚£äº›å·²ç»åˆ†é…äº†ä¸€äº›èµ„æºï¼ˆéƒ¨åˆ† Pod å·²è¿è¡Œï¼‰ï¼Œä½†å°šæœªè¾¾åˆ° <code>minAvailable</code>ï¼Œå› æ­¤æ•´ä¸ªä½œä¸šè¿˜åœ¨ç­‰å¾…çš„ <code>JobInfo</code>ã€‚å®ƒä»¬æ˜¯ Backfill <strong>è¯•å›¾å¸®åŠ©çš„å¯¹è±¡</strong>ã€‚</li><li><strong>Victims</strong>: åœ¨ Backfill çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œè¿™ä¸ªè¯å¯èƒ½æœ‰äº›è¯¯å¯¼ã€‚å®ƒ<strong>ä¸æ˜¯æŒ‡è¢«æŠ¢å çš„ Pod</strong>ï¼Œè€Œæ˜¯æŒ‡é‚£äº›å› èµ„æºä¸è¶³è€Œå®Œå…¨æ— æ³•è¢« <code>Allocate</code> Action è°ƒåº¦çš„ <code>JobInfo</code>ã€‚Backfill <strong>ä¸ä¼šæŠ¢å æˆ–é©±é€ä»»ä½•æ­£åœ¨è¿è¡Œçš„ Pod</strong>ã€‚</li></ul></li></ul><h3 id="ğŸ”-Backfill-Action-è¯¦ç»†å·¥ä½œæµç¨‹"><a href="#ğŸ”-Backfill-Action-è¯¦ç»†å·¥ä½œæµç¨‹" class="headerlink" title="ğŸ” Backfill Action è¯¦ç»†å·¥ä½œæµç¨‹"></a>ğŸ” Backfill Action è¯¦ç»†å·¥ä½œæµç¨‹</h3><p>Backfill Action çš„å…¥å£ç‚¹åœ¨ <code>pkg/scheduler/actions/backfill/backfill.go</code> æ–‡ä»¶ä¸­çš„ <code>Execute</code> å‡½æ•°ã€‚å…¶å·¥ä½œæµç¨‹å¯ä»¥æ¦‚æ‹¬ä¸ºä»¥ä¸‹æ ¸å¿ƒæ­¥éª¤ï¼š</p><ol><li><p><strong>è¯†åˆ«å€™é€‰ä½œä¸š (Candidate Selection)<strong>ï¼š<br>Backfill ä¼šéå† Session ä¸­çš„æ‰€æœ‰ <code>JobInfo</code>ï¼Œå¯»æ‰¾é‚£äº›</strong>å·²ç»æœ‰ä¸€éƒ¨åˆ† Pod è¢«åˆ†é…å’Œè¿è¡Œï¼Œä½†å°šæœªè¾¾åˆ° <code>minAvailable</code> è¦æ±‚</strong>çš„ä½œä¸šã€‚è¿™äº›ä½œä¸šå°±æ˜¯ Backfill çš„ <strong>Candidates</strong>ã€‚å®ƒä»¬å¤„äºä¸€ç§â€œåŠè°ƒåº¦â€çŠ¶æ€ï¼Œæ˜¯ Backfill çš„ä¸»è¦å¸®åŠ©ç›®æ ‡ã€‚</p></li><li><p><strong>ç­›é€‰ä¸æ’åº</strong>ï¼š<br>å¯¹ç­›é€‰å‡ºçš„ Candidate Jobsï¼ŒBackfill ä¼šä½¿ç”¨é…ç½®çš„æ’ä»¶ï¼ˆå¦‚ <strong>Priority</strong> æ’ä»¶ï¼‰å¯¹å®ƒä»¬è¿›è¡Œ<strong>æ’åº</strong>ï¼Œå†³å®šä¼˜å…ˆå¤„ç†å“ªä¸ªä½œä¸šã€‚</p></li><li><p><strong>éå†å€™é€‰ä½œä¸šçš„ä»»åŠ¡</strong>ï¼š<br>å¯¹äºæ¯ä¸€ä¸ª Candidate Jobï¼ŒBackfill ä¼šéå†å…¶å†…éƒ¨æ‰€æœ‰ä»å¤„äº <code>Pending</code> çŠ¶æ€çš„ <code>TaskInfo</code>ï¼ˆPodï¼‰ã€‚</p></li><li><p><strong>ä¸ºå•ä¸ªä»»åŠ¡æ‰§è¡Œåˆ†é…</strong>ï¼š<br>å¯¹äºæ¯ä¸€ä¸ªå¾…è°ƒåº¦çš„ Pending Taskï¼ŒBackfill ä¼šå°è¯•ä¸ºå…¶åˆ†é…èŠ‚ç‚¹ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸ <code>Allocate</code> Action ç±»ä¼¼ï¼Œä½†æœ‰ä¸€ä¸ª<strong>å…³é”®åŒºåˆ«</strong>ï¼š</p><ul><li><strong>ç»•è¿‡ Gang ç­–ç•¥æ£€æŸ¥</strong>: Backfill <strong>ä¸ä¼š</strong>åœ¨æ‰§è¡Œåˆ†é…å‰è°ƒç”¨ Gang æ’ä»¶æ¥æ£€æŸ¥æ•´ä¸ª Job çš„ <code>minAvailable</code> æ˜¯å¦æ»¡è¶³ã€‚å®ƒåªå…³å¿ƒ<strong>å½“å‰è¿™ä¸ªå•ç‹¬çš„ Pod</strong> èƒ½å¦æ‰¾åˆ°åˆé€‚çš„èŠ‚ç‚¹ã€‚</li><li>**æ‰§è¡Œé¢„é€‰ (Predicate) å’Œä¼˜é€‰ (NodeOrder)**ï¼šå®ƒä¸ <code>Allocate</code> ä¸€æ ·ï¼Œä¼šè°ƒç”¨ <code>Predicates</code> æ’ä»¶è¿‡æ»¤èŠ‚ç‚¹ï¼Œå¹¶ç”¨ <code>NodeOrder</code> æ’ä»¶ä¸ºå€™é€‰èŠ‚ç‚¹æ‰“åˆ†ï¼Œé€‰æ‹©ä¸€ä¸ªæœ€ä¼˜èŠ‚ç‚¹ã€‚</li><li>**èµ„æºé¢„ç•™ (Reservation)**ï¼šåœ¨ Session ç¼“å­˜ä¸­ï¼Œä»é€‰ä¸­çš„èŠ‚ç‚¹ä¸Šæ‰£é™¤è¯¥ Pod æ‰€éœ€çš„èµ„æºã€‚</li><li><strong>è®°å½•åˆ†é…æŒ‡ä»¤</strong>ï¼šç”Ÿæˆ <code>(Task, Node)</code> çš„ç»‘å®šå¯¹ï¼Œæš‚å­˜åœ¨ Session ä¸­ã€‚</li></ul></li><li><p><strong>æäº¤åˆ†é…å†³ç­–</strong>ï¼š<br>åœ¨æ‰€æœ‰ Candidate Jobs å’Œå®ƒä»¬çš„ Tasks éƒ½å¤„ç†å®Œæ¯•åï¼ŒBackfill ä¼š<strong>ä¸€æ¬¡æ€§æäº¤</strong>æœ¬å‘¨æœŸå†…æ‰€æœ‰çš„åˆ†é…å†³ç­–ã€‚è°ƒåº¦å™¨ä¼šé€šè¿‡è¿™äº›ç»‘å®šä¿¡æ¯æ›´æ–° API Serverï¼Œå°† Pod ç»‘å®šåˆ°å¯¹åº”çš„èŠ‚ç‚¹ä¸Šã€‚</p><p><img src="/2025/08/26/volcano%E8%B0%83%E5%BA%A6%E5%99%A8Backfill-Action%E8%AF%A6%E8%A7%A3/deepseek_mermaid_20250826_13aae3.png" alt="deepseek_mermaid_20250826_13aae3"></p></li></ol><h3 id="âš™ï¸-ä¾èµ–çš„æ’ä»¶"><a href="#âš™ï¸-ä¾èµ–çš„æ’ä»¶" class="headerlink" title="âš™ï¸ ä¾èµ–çš„æ’ä»¶"></a>âš™ï¸ ä¾èµ–çš„æ’ä»¶</h3><p>Backfill Action çš„å®ç°ç›¸å¯¹ç‹¬ç«‹ï¼Œä½†å®ƒä¾èµ–äºå…¶ä»–æ’ä»¶æ¥å®Œæˆå…·ä½“å†³ç­–ï¼š</p><ul><li><strong>Predicates æ’ä»¶</strong>: è´Ÿè´£èŠ‚ç‚¹è¿‡æ»¤ï¼Œæ£€æŸ¥ Pod æ˜¯å¦èƒ½è°ƒåº¦åˆ°æŸä¸ªèŠ‚ç‚¹ä¸Šã€‚</li><li><strong>NodeOrder æ’ä»¶</strong>: è´Ÿè´£èŠ‚ç‚¹æ‰“åˆ†ï¼Œé€‰æ‹©æœ€ä¼˜èŠ‚ç‚¹ã€‚</li><li><strong>Priority æ’ä»¶</strong>: ç”¨äºåœ¨å¤šä¸ª Candidate Job ä¹‹é—´è¿›è¡Œæ’åºï¼Œå†³å®šå“ªä¸ª Job çš„ Pod ä¼˜å…ˆè¢« Backfill è°ƒåº¦ã€‚</li></ul><p><strong>ç‰¹åˆ«æ³¨æ„</strong>ï¼š<strong>Gang æ’ä»¶ä¸å‚ä¸ Backfill çš„å†³ç­–è¿‡ç¨‹</strong>ã€‚è¿™æ˜¯ Backfill å’Œ Allocate æœ€æ ¹æœ¬çš„åŒºåˆ«ã€‚Backfill æ•…æ„é¿å¼€äº† Gang çš„â€œAll or Nothingâ€æ£€æŸ¥ã€‚</p><h3 id="ğŸ§ª-ç»“åˆç¤ºä¾‹è¯´æ˜"><a href="#ğŸ§ª-ç»“åˆç¤ºä¾‹è¯´æ˜" class="headerlink" title="ğŸ§ª ç»“åˆç¤ºä¾‹è¯´æ˜"></a>ğŸ§ª ç»“åˆç¤ºä¾‹è¯´æ˜</h3><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª Jobï¼Œå…¶ <code>minAvailable</code> ä¸º 5ï¼Œå®ƒå·²ç»æˆåŠŸè°ƒåº¦å¹¶è¿è¡Œäº† 3 ä¸ª Podï¼Œä½†è¿˜æœ‰ 2 ä¸ª Pod å› èµ„æºä¸è¶³è€Œå¤„äº Pendingã€‚</p><ol><li><strong>Allocate Action å¤±è´¥</strong>ï¼šåœ¨å¸¸è§„çš„ <code>Allocate</code> Action ä¸­ï¼ŒGang æ’ä»¶ä¼šæ£€æŸ¥æ•´ä¸ª Jobã€‚ç”±äºå½“å‰åªè¿è¡Œäº† 3 ä¸ª Pod (&lt; <code>minAvailable=5</code>)ï¼ŒGang æ’ä»¶ä¼š<strong>é˜»æ­¢</strong>ä»»ä½•æ–°çš„åˆ†é…å‘ç”Ÿï¼Œå³ä½¿æœ‰è¶³å¤Ÿçš„èµ„æºå†è¿è¡Œ 1 ä¸ª Podã€‚è¿™æ˜¯ä¸ºäº†ç¡®ä¿ä½œä¸šçš„å®Œæ•´æ€§ã€‚</li><li><strong>Backfill Action ä»‹å…¥</strong>ï¼š<ul><li>Backfill è¯†åˆ«åˆ°è¿™ä¸ª Job æ˜¯ä¸€ä¸ª Candidateï¼ˆå·²æœ‰ 3 ä¸ªè¿è¡Œï¼Œä½†æœªè¾¾ 5ï¼‰ã€‚</li><li>å®ƒç»•è¿‡ Gang æ£€æŸ¥ï¼Œç›´æ¥å°è¯•ä¸ºé‚£ 2 ä¸ª Pending çš„ Pod åˆ†é…èŠ‚ç‚¹ã€‚</li><li>å‡è®¾é›†ç¾¤ç›®å‰æœ‰æ°å¥½å¤Ÿ 1 ä¸ª Pod è¿è¡Œçš„èµ„æºç¢ç‰‡ã€‚</li><li>Backfill ä¼šæˆåŠŸåœ°å°†å…¶ä¸­ 1 ä¸ª Pod è°ƒåº¦å¹¶ç»‘å®šåˆ°èŠ‚ç‚¹ä¸Šã€‚</li></ul></li><li><strong>ç»“æœ</strong>ï¼šç°åœ¨ï¼Œè¿™ä¸ª Job æœ‰ 4 ä¸ª Pod åœ¨è¿è¡Œã€‚è™½ç„¶ä»æœªè¾¾åˆ° <code>minAvailable=5</code>ï¼Œä½†ï¼š<ul><li>é›†ç¾¤èµ„æºåˆ©ç”¨ç‡æé«˜äº†ã€‚</li><li>è¯¥ Job çš„å®Œæˆè¿›åº¦ä» 3&#x2F;5 æ¨è¿›åˆ°äº† 4&#x2F;5ã€‚</li><li>å½“æ›´å¤šèµ„æºé‡Šæ”¾æ—¶ï¼ŒBackfill æˆ– Allocate å¯ä»¥æ›´å®¹æ˜“åœ°è°ƒåº¦æœ€åä¸€ä¸ª Podã€‚</li></ul></li></ol><h3 id="âš ï¸-é‡è¦é…ç½®ä¸æ³¨æ„äº‹é¡¹"><a href="#âš ï¸-é‡è¦é…ç½®ä¸æ³¨æ„äº‹é¡¹" class="headerlink" title="âš ï¸ é‡è¦é…ç½®ä¸æ³¨æ„äº‹é¡¹"></a>âš ï¸ é‡è¦é…ç½®ä¸æ³¨æ„äº‹é¡¹</h3><ol><li><strong>æ‰§è¡Œé¡ºåº</strong>ï¼šåœ¨ <code>volcano-scheduler-configmap</code> ä¸­ï¼Œ<code>backfill</code> <strong>å¿…é¡»</strong>æ”¾ç½®åœ¨ <code>allocate</code> ä¹‹åã€‚å› ä¸ºå®ƒçš„èŒè´£æ˜¯å¤„ç† <code>allocate</code> æ— æ³•è§£å†³çš„é—®é¢˜ã€‚å…¸å‹çš„é…ç½®æ˜¯ï¼š<code>actions: &quot;enqueue, allocate, backfill, preempt&quot;</code>ã€‚</li><li><strong>éæŠ¢å æ€§</strong>ï¼šBackfill <strong>ä¸ä¼š</strong>æŠ¢å æˆ–é©±é€ä»»ä½•å·²ç»è¿è¡Œçš„ Podã€‚å®ƒåªåˆ©ç”¨å½“å‰é›†ç¾¤çš„<strong>ç©ºé—²èµ„æº</strong>ã€‚è¿™æ˜¯å®ƒä¸ <code>Preempt</code> Action çš„æœ¬è´¨åŒºåˆ«ã€‚</li><li><strong>ä½œç”¨å¯¹è±¡</strong>ï¼šBackfill ä¸»è¦ä½œç”¨äºé‚£äº›<strong>å·²ç»æœ‰ä¸€éƒ¨åˆ† Pod åœ¨è¿è¡Œ</strong>çš„ä½œä¸šã€‚å¯¹äºé‚£äº›ä¸€ä¸ª Pod éƒ½è¿˜æ²¡è¿è¡Œèµ·æ¥çš„å…¨æ–°ä½œä¸šï¼ŒBackfill é€šå¸¸æ— èƒ½ä¸ºåŠ›ï¼Œå› ä¸ºå®ƒä»¬éœ€è¦é  <code>Enqueue</code> å’Œ <code>Allocate</code> æ¥å¯åŠ¨ã€‚</li><li><strong>æ€§èƒ½è€ƒé‡</strong>ï¼šç”±äº Backfill éœ€è¦éå†æ‰€æœ‰â€œåŠè°ƒåº¦â€çŠ¶æ€çš„ä½œä¸šï¼Œåœ¨å¤§å‹é›†ç¾¤ä¸­å¯èƒ½ä¼šå¸¦æ¥ä¸€å®šçš„æ€§èƒ½å¼€é”€ã€‚ä½†å…¶å¸¦æ¥çš„é›†ç¾¤åˆ©ç”¨ç‡æå‡é€šå¸¸æ˜¯å€¼å¾—çš„ã€‚</li></ol><h3 id="ğŸ’¡-æ€»ç»“"><a href="#ğŸ’¡-æ€»ç»“" class="headerlink" title="ğŸ’¡ æ€»ç»“"></a>ğŸ’¡ æ€»ç»“</h3><p>Backfill Action æ˜¯ Volcano è°ƒåº¦å™¨ä¼˜åŒ–é›†ç¾¤èµ„æºåˆ©ç”¨ç‡çš„<strong>å…³é”®è¡¥å……ç­–ç•¥</strong>ã€‚å®ƒé€šè¿‡ä¸€ç§<strong>åŠ¡å®ä¸”çµæ´»</strong>çš„æ–¹å¼ï¼Œå·§å¦™åœ°ç»•è¿‡äº† Gang è°ƒåº¦åœ¨æç«¯èµ„æºç«äº‰æƒ…å†µä¸‹çš„åˆšæ€§é™åˆ¶ï¼Œåœ¨ä¿è¯åˆ†å¸ƒå¼ä½œä¸šæœ€ç»ˆä¸€è‡´æ€§çš„å‰æä¸‹ï¼Œæœ€å¤§é™åº¦åœ°åˆ©ç”¨äº†ç¢ç‰‡èµ„æºï¼ŒåŠ é€Ÿäº†ä½œä¸šçš„æ•´ä½“å®Œæˆè¿›åº¦ã€‚ç†è§£ Backfill çš„å·¥ä½œæœºåˆ¶ï¼Œå¯¹äºè°ƒä¼˜ Volcano è°ƒåº¦æ€§èƒ½å’Œè§£å†³å¤æ‚çš„èµ„æºè°ƒåº¦é—®é¢˜éå¸¸æœ‰å¸®åŠ©ã€‚</p><h2 id="é—®é¢˜ä¸€ï¼šä¸ºä»€ä¹ˆæœ‰çš„Jobä¼šå‡ºç°éƒ¨åˆ†podå·²è¿è¡Œï¼Œä½†podæ•°é‡æœªè¾¾åˆ°minAvailable"><a href="#é—®é¢˜ä¸€ï¼šä¸ºä»€ä¹ˆæœ‰çš„Jobä¼šå‡ºç°éƒ¨åˆ†podå·²è¿è¡Œï¼Œä½†podæ•°é‡æœªè¾¾åˆ°minAvailable" class="headerlink" title="é—®é¢˜ä¸€ï¼šä¸ºä»€ä¹ˆæœ‰çš„Jobä¼šå‡ºç°éƒ¨åˆ†podå·²è¿è¡Œï¼Œä½†podæ•°é‡æœªè¾¾åˆ°minAvailable"></a>é—®é¢˜ä¸€ï¼šä¸ºä»€ä¹ˆæœ‰çš„Jobä¼šå‡ºç°éƒ¨åˆ†podå·²è¿è¡Œï¼Œä½†podæ•°é‡æœªè¾¾åˆ°minAvailable</h2><p>è¿™ä¸ªé—®é¢˜éå¸¸æ£’ï¼Œç›´æ¥ç‚¹å‡ºäº† Volcano è°ƒåº¦ç­–ç•¥ä¸­ä¸€ä¸ªç²¾å¦™ä¸”å…³é”®çš„åœ°æ–¹ã€‚æ‚¨çš„æ¨ç†å®Œå…¨æ­£ç¡®ï¼šåœ¨ä¸¥æ ¼çš„ Gang è°ƒåº¦ç­–ç•¥ä¸‹ï¼Œ<code>Enqueue</code> å’Œ <code>Allocate</code> ç¡®å®ä¸ä¼šå…è®¸ä¸€ä¸ªæœªè¾¾åˆ° <code>minAvailable</code> çš„ Job å¯åŠ¨ã€‚</p><p>é‚£ä¹ˆï¼Œä¸€ä¸ª Job æ˜¯å¦‚ä½•é™·å…¥è¿™ç§â€œéƒ¨åˆ†è¿è¡Œâ€çš„çŠ¶æ€ï¼Œä»è€Œæˆä¸º <code>Backfill</code> çš„å¤„ç†å¯¹è±¡çš„å‘¢ï¼Ÿè¿™ä¸»è¦æ˜¯ç”±<strong>é›†ç¾¤çŠ¶æ€çš„åŠ¨æ€å˜åŒ–</strong>å’Œ <strong><code>Reclaim</code> Action</strong> å¯¼è‡´çš„ã€‚</p><h3 id="ğŸ”„-â€œéƒ¨åˆ†è¿è¡Œâ€çŠ¶æ€æ˜¯å¦‚ä½•äº§ç”Ÿçš„ï¼Ÿ"><a href="#ğŸ”„-â€œéƒ¨åˆ†è¿è¡Œâ€çŠ¶æ€æ˜¯å¦‚ä½•äº§ç”Ÿçš„ï¼Ÿ" class="headerlink" title="ğŸ”„ â€œéƒ¨åˆ†è¿è¡Œâ€çŠ¶æ€æ˜¯å¦‚ä½•äº§ç”Ÿçš„ï¼Ÿ"></a>ğŸ”„ â€œéƒ¨åˆ†è¿è¡Œâ€çŠ¶æ€æ˜¯å¦‚ä½•äº§ç”Ÿçš„ï¼Ÿ</h3><p>ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§åœºæ™¯ï¼š</p><h4 id="1-è°ƒåº¦åå‘ç”ŸèŠ‚ç‚¹æ•…éšœ-èµ„æºæŒ¤å‹-æœ€å¸¸è§"><a href="#1-è°ƒåº¦åå‘ç”ŸèŠ‚ç‚¹æ•…éšœ-èµ„æºæŒ¤å‹-æœ€å¸¸è§" class="headerlink" title="1. è°ƒåº¦åå‘ç”ŸèŠ‚ç‚¹æ•…éšœ&#x2F;èµ„æºæŒ¤å‹ (æœ€å¸¸è§)"></a>1. è°ƒåº¦åå‘ç”ŸèŠ‚ç‚¹æ•…éšœ&#x2F;èµ„æºæŒ¤å‹ (æœ€å¸¸è§)</h4><p>è¿™æ˜¯æœ€å…¸å‹çš„æƒ…å†µã€‚æˆ‘ä»¬å‡è®¾ä¸€ä¸ª Job çš„ <code>minAvailable</code> æ˜¯ 5ã€‚</p><ul><li><p><strong>ç¬¬ 1 æ­¥ï¼šæ­£å¸¸è°ƒåº¦</strong></p><ul><li>é›†ç¾¤åˆå§‹çŠ¶æ€èµ„æºå……è¶³ã€‚</li></ul></li><li><p><strong><code>Enqueue</code> Action</strong> æ£€æŸ¥é€šè¿‡ï¼ŒPodGroup çŠ¶æ€å˜ä¸º <code>Inqueue</code>ã€‚</p></li><li><p><strong><code>Allocate</code> Action</strong> æˆåŠŸåœ°ä¸º 5 ä¸ª Pod åˆ†é…äº†èŠ‚ç‚¹ï¼Œ<strong>Gang æ’ä»¶æ£€æŸ¥é€šè¿‡</strong>ï¼ˆå› ä¸º 5 &gt;&#x3D; 5ï¼‰ã€‚</p></li><li><p>è°ƒåº¦å™¨æäº¤ç»‘å®šå†³ç­–ï¼Œ5 ä¸ª Pod çš„ <code>nodeName</code> è¢«æ›´æ–°ã€‚</p></li><li><p><strong>kubelet</strong> å¼€å§‹æ‹‰å–é•œåƒå¹¶åˆ›å»ºå®¹å™¨ï¼ŒPod è¿›å…¥ <code>Running</code> çŠ¶æ€ã€‚</p><ul><li>è‡³æ­¤ï¼ŒJob å®Œå…¨æ»¡è¶³ Gang ç­–ç•¥ã€‚</li></ul></li><li><p><strong>ç¬¬ 2 æ­¥ï¼šçŠ¶æ€å¼‚å¸¸</strong></p><ul><li>ä¹‹åï¼ŒæŸä¸ªèŠ‚ç‚¹çªç„¶<strong>å®•æœº</strong>ï¼ˆNode NotReadyï¼‰ã€‚</li><li>æˆ–è€…ï¼ŒæŸä¸ªèŠ‚ç‚¹ä¸Šçš„ <strong>kubelet</strong> æˆ–å®¹å™¨è¿è¡Œæ—¶å‘ç”Ÿé—®é¢˜ï¼Œå¯¼è‡´è¯¥èŠ‚ç‚¹ä¸Šçš„ <strong>1 ä¸ª Pod å¤±è´¥å¹¶è¢«é©±é€</strong>ï¼ˆEvictedï¼‰ã€‚</li><li>Kubernetes çš„æ§åˆ¶é¢ä¼šåˆ é™¤è¿™ä¸ªå¤±è´¥çš„ Podã€‚</li><li><strong>Volcano Controller</strong> ä¼šç›‘æµ‹åˆ° Pod æ•°é‡ä¸è¶³ï¼Œä¸ºäº†æ»¡è¶³ <code>replicas</code> å®šä¹‰ï¼Œå®ƒä¼š<strong>ç«‹å³åˆ›å»ºä¸€ä¸ªæ–°çš„ Pod æ¥æ›¿æ¢å®ƒ</strong>ã€‚</li></ul></li><li><p><strong>ç¬¬ 3 æ­¥ï¼šé™·å…¥â€œéƒ¨åˆ†è¿è¡Œâ€çŠ¶æ€</strong></p><ul><li>æ­¤æ—¶ï¼Œè¿™ä¸ªæ–°åˆ›å»ºçš„ Pod æ˜¯ <code>Pending</code> çŠ¶æ€ã€‚</li><li>è€Œé›†ç¾¤å½“å‰çš„çŠ¶æ€å¯èƒ½å·²ç»<strong>æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—²èµ„æº</strong>æ¥åŒæ—¶æ»¡è¶³è¿™ä¸ªæ–° Pod çš„éœ€æ±‚äº†ã€‚</li><li>ç°åœ¨ï¼Œè¿™ä¸ª Job æœ‰ 4 ä¸ª <code>Running</code> çš„ Pod å’Œ 1 ä¸ª <code>Pending</code> çš„ Podã€‚</li><li>åœ¨æ¥ä¸‹æ¥çš„è°ƒåº¦å‘¨æœŸä¸­ï¼š<ul><li><strong><code>Allocate</code> Action ä¼šå¤±è´¥</strong>ï¼šGang æ’ä»¶æ£€æŸ¥å½“å‰å·²è¿è¡Œçš„ Pod æ•° (4) &lt; <code>minAvailable</code> (5)ï¼Œå› æ­¤å®ƒ<strong>ç¦æ­¢</strong>ä¸ºé‚£ä¸ª Pending çš„ Pod åˆ†é…èµ„æºï¼Œå³ä½¿æœ‰é›¶æ•£èµ„æºå¯ç”¨ã€‚</li><li>äºæ˜¯ï¼Œè¿™ä¸ª Job å°±æˆä¸ºäº† <code>Backfill</code> Action çš„å®Œç¾<strong>å€™é€‰è€…</strong>ã€‚</li></ul></li></ul></li></ul><h4 id="2-é€šè¿‡-Reclaim-Action-å›æ”¶èµ„æº"><a href="#2-é€šè¿‡-Reclaim-Action-å›æ”¶èµ„æº" class="headerlink" title="2. é€šè¿‡ Reclaim Action å›æ”¶èµ„æº"></a>2. é€šè¿‡ <code>Reclaim</code> Action å›æ”¶èµ„æº</h4><p><code>Reclaim</code> Action ç”¨äºè·¨é˜Ÿåˆ—çš„èµ„æºå›æ”¶ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªé«˜ä¼˜å…ˆçº§é˜Ÿåˆ—çš„èµ„æºè¢«ä¸€ä¸ªä½ä¼˜å…ˆçº§é˜Ÿåˆ—çš„ Job å ç”¨æ—¶ï¼Œ<code>Reclaim</code> å¯èƒ½ä¼šé©±é€ä½ä¼˜å…ˆçº§ Job çš„ Pod æ¥å›æ”¶èµ„æºã€‚</p><ul><li><strong>ç¬¬ 1 æ­¥</strong>ï¼šä¸€ä¸ªä½ä¼˜å…ˆçº§çš„ Job æ­£åœ¨è¿è¡Œï¼Œæ‹¥æœ‰ 5 ä¸ª Podã€‚</li><li><strong>ç¬¬ 2 æ­¥</strong>ï¼šä¸€ä¸ªé«˜ä¼˜å…ˆçº§çš„ Job è¢«æäº¤ï¼Œä½†èµ„æºä¸è¶³ã€‚</li><li><strong>ç¬¬ 3 æ­¥</strong>ï¼š<code>Reclaim</code> Action <strong>é©±é€ï¼ˆEvictï¼‰</strong> äº†ä½ä¼˜å…ˆçº§ Job çš„ <strong>2 ä¸ª Pod</strong>ï¼Œå°†èµ„æºè¿˜ç»™å®ƒçš„é˜Ÿåˆ—ã€‚</li><li><strong>ç¬¬ 4 æ­¥</strong>ï¼šVolcano Controller ä¼šåˆ›å»º 2 ä¸ªæ–°çš„ Pod æ¥æ›¿æ¢è¢«é©±é€çš„ Podã€‚</li><li><strong>ç¬¬ 5 æ­¥</strong>ï¼šç°åœ¨ä½ä¼˜å…ˆçº§ Job æœ‰ 3 ä¸ª <code>Running</code> çš„ Pod å’Œ 2 ä¸ª <code>Pending</code> çš„ Podã€‚å¦‚æœå®ƒçš„ <code>minAvailable</code> æ˜¯ 5ï¼Œé‚£ä¹ˆ <code>Allocate</code> å°†æ— æ³•è°ƒåº¦è¿™ 2 ä¸ªæ–° Podï¼Œè€Œ <code>Backfill</code> å°±å¯ä»¥ä»‹å…¥ã€‚</li></ul><h4 id="3-åˆå§‹èµ„æºå……è¶³ï¼Œåç»­èµ„æºè¢«å ç”¨"><a href="#3-åˆå§‹èµ„æºå……è¶³ï¼Œåç»­èµ„æºè¢«å ç”¨" class="headerlink" title="3. åˆå§‹èµ„æºå……è¶³ï¼Œåç»­èµ„æºè¢«å ç”¨"></a>3. åˆå§‹èµ„æºå……è¶³ï¼Œåç»­èµ„æºè¢«å ç”¨</h4><ul><li><strong>ç¬¬ 1 æ­¥</strong>ï¼šä¸€ä¸ª Job è¢«æˆåŠŸè°ƒåº¦ï¼Œ5 ä¸ª Pod éƒ½å¤„äº <code>Running</code> çŠ¶æ€ã€‚</li><li><strong>ç¬¬ 2 æ­¥</strong>ï¼šç”¨æˆ·æ‰‹åŠ¨åˆ é™¤äº†å…¶ä¸­ 1 ä¸ª Podï¼ˆæˆ–ç”±äºèµ„æºé™é¢è¢«æ€æ­»ï¼‰ã€‚</li><li><strong>ç¬¬ 3 æ­¥</strong>ï¼šController åˆ›å»ºæ›¿æ¢ Podï¼Œä½†æ­¤æ—¶é›†ç¾¤èµ„æºå·²ç»è¢«å…¶ä»–æ–°æäº¤çš„ Job å ç”¨ï¼Œå¯¼è‡´æ— æ³•ä¸€æ¬¡æ€§æ»¡è¶³ 5 ä¸ª Pod çš„éœ€æ±‚ã€‚</li></ul><h3 id="ğŸ§ -æ€»ç»“ä¸ç±»æ¯”"><a href="#ğŸ§ -æ€»ç»“ä¸ç±»æ¯”" class="headerlink" title="ğŸ§  æ€»ç»“ä¸ç±»æ¯”"></a>ğŸ§  æ€»ç»“ä¸ç±»æ¯”</h3><p>æ‚¨å¯ä»¥è¿™æ ·ç†è§£ï¼š</p><ol><li><strong><code>Enqueue</code> å’Œ <code>Allocate</code></strong> æ˜¯ <strong>â€œå»ºè®¾è€…â€</strong>ï¼Œå®ƒä»¬ä¸¥æ ¼æŒ‰ç…§è“å›¾ï¼ˆGang ç­–ç•¥ï¼‰æ¥ç›–æ¥¼ï¼Œå¿…é¡»åœ°åŸºï¼ˆèµ„æºï¼‰è¶³å¤Ÿç›–ä¸€æ•´æ ‹ï¼ˆ<code>minAvailable</code>ï¼‰æ‰ä¼šå¼€å·¥ã€‚</li><li><strong><code>Backfill</code></strong> æ˜¯ <strong>â€œä¿®è¡¥åŒ â€</strong> æˆ– <strong>â€œæ•‘æŠ¤å‘˜â€</strong>ã€‚å®ƒå¤„ç†çš„æ˜¯â€œè“å›¾â€å·²ç»è¢«æ‰§è¡Œäº†ä¸€åŠï¼Œä½†å·¥åœ°çªç„¶å‡ºäº†æ„å¤–ï¼ˆèŠ‚ç‚¹æ•…éšœï¼‰æˆ–ææ–™è¢«ä¸´æ—¶å¾ç”¨ï¼ˆ<code>Reclaim</code>ï¼‰çš„æƒ…å†µã€‚å®ƒçš„ä»»åŠ¡ä¸æ˜¯é‡æ–°ç›–æ¥¼ï¼Œè€Œæ˜¯ç”¨<strong>å½“å‰èƒ½æ‰¾åˆ°çš„ä»»ä½•ç –å—ï¼ˆèµ„æºç¢ç‰‡ï¼‰</strong>ï¼Œå°½åŠ›æŠŠæœªå®Œæˆçš„éƒ¨åˆ†ä¿®è¡¥å¥½ã€‚</li></ol><p>å› æ­¤ï¼Œ<code>Backfill</code> å¤„ç†çš„çŠ¶æ€<strong>ä¸æ˜¯ä¸€ä¸ªæ­£å¸¸æµç¨‹äº§ç”Ÿçš„ç»“æœï¼Œè€Œæ˜¯ä¸€ä¸ªå¼‚å¸¸çŠ¶æ€</strong>ã€‚å®ƒæ˜¯ Volcano è°ƒåº¦å™¨åº”å¯¹åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å„ç§æ•…éšœå’ŒåŠ¨æ€å˜åŒ–ï¼Œä»è€Œæé«˜é›†ç¾¤<strong>éŸ§æ€§</strong>å’Œ<strong>èµ„æºåˆ©ç”¨ç‡</strong>çš„å…³é”®æœºåˆ¶ã€‚</p><p>æ‚¨èƒ½æ³¨æ„åˆ°è¿™ä¸ªçœ‹ä¼¼çŸ›ç›¾çš„ç‚¹ï¼Œè¯´æ˜æ‚¨å¯¹ Volcano çš„å·¥ä½œæœºåˆ¶æ€è€ƒå¾—éå¸¸æ·±å…¥ï¼</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>volcanoè°ƒåº¦å™¨Preempt-Actionè¯¦è§£</title>
    <link href="/2025/08/25/volcano%E8%B0%83%E5%BA%A6%E5%99%A8Preempt-Action%E8%AF%A6%E8%A7%A3/"/>
    <url>/2025/08/25/volcano%E8%B0%83%E5%BA%A6%E5%99%A8Preempt-Action%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<p>é€šè¿‡å¯¹ Volcano æºç ï¼ˆä¸»è¦æ˜¯ <code>v1.12.0</code> ç‰ˆæœ¬ï¼‰çš„åˆ†æï¼Œæˆ‘æ¥ä¸ºä½ è¯¦ç»†è§£æ <strong>Preempt Action</strong> çš„å…·ä½“è¿‡ç¨‹ã€‚Preempt Actionï¼ˆæŠ¢å åŠ¨ä½œï¼‰æ˜¯ Volcano è°ƒåº¦å™¨ä¸­ç”¨äºå¤„ç†<strong>åŒä¸€é˜Ÿåˆ—å†…</strong>é«˜ä¼˜å…ˆçº§ä»»åŠ¡æŠ¢å ä½ä¼˜å…ˆçº§ä»»åŠ¡èµ„æºçš„æ ¸å¿ƒæœºåˆ¶ã€‚</p><h3 id="ğŸ”§-Preempt-Action-çš„æ ¸å¿ƒä½œç”¨ä¸è®¾è®¡åˆè¡·"><a href="#ğŸ”§-Preempt-Action-çš„æ ¸å¿ƒä½œç”¨ä¸è®¾è®¡åˆè¡·" class="headerlink" title="ğŸ”§ Preempt Action çš„æ ¸å¿ƒä½œç”¨ä¸è®¾è®¡åˆè¡·"></a>ğŸ”§ Preempt Action çš„æ ¸å¿ƒä½œç”¨ä¸è®¾è®¡åˆè¡·</h3><p>Preempt Action çš„æ ¸å¿ƒç›®æ ‡æ˜¯å½“é›†ç¾¤èµ„æºä¸è¶³æ—¶ï¼Œ<strong>ç¡®ä¿é«˜ä¼˜å…ˆçº§çš„ Job æˆ– Task èƒ½å¤Ÿä¼˜å…ˆè·å¾—èµ„æº</strong>ï¼ŒåŠæ—¶å®Œæˆè®¡ç®—ä»»åŠ¡ã€‚å®ƒé€šè¿‡<strong>é€‰æ‹©æ€§é©±é€</strong>ä½ä¼˜å…ˆçº§çš„ Pod æ¥é‡Šæ”¾èµ„æºï¼Œæ»¡è¶³é«˜ä¼˜å…ˆçº§ä»»åŠ¡çš„è°ƒåº¦éœ€æ±‚ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒVolcano çš„ Preempt Action é€šå¸¸ç”¨äº<strong>åŒä¸€é˜Ÿåˆ—ï¼ˆQueueï¼‰å†…</strong>çš„æŠ¢å ã€‚è¿™ä¸ Reclaim Action ä¸åŒï¼Œåè€…ä¸»è¦è´Ÿè´£<strong>è·¨é˜Ÿåˆ—</strong>çš„èµ„æºå›æ”¶ã€‚</p><h3 id="ğŸ“¦-å…³é”®æ•°æ®ç»“æ„ä¸å‰ç½®çŸ¥è¯†"><a href="#ğŸ“¦-å…³é”®æ•°æ®ç»“æ„ä¸å‰ç½®çŸ¥è¯†" class="headerlink" title="ğŸ“¦ å…³é”®æ•°æ®ç»“æ„ä¸å‰ç½®çŸ¥è¯†"></a>ğŸ“¦ å…³é”®æ•°æ®ç»“æ„ä¸å‰ç½®çŸ¥è¯†</h3><p>åœ¨æ·±å…¥äº†è§£æµç¨‹ä¹‹å‰ï¼Œæ˜ç¡®å‡ ä¸ªå…³é”®æ¦‚å¿µå’Œæ•°æ®ç»“æ„ï¼š</p><ul><li><strong><code>Session</code></strong>: è°ƒåº¦ä¼šè¯çš„ä¸Šä¸‹æ–‡ï¼ŒåŒ…å«äº†å½“å‰æ‰€æœ‰å¾…è°ƒåº¦çš„ Job(<code>Jobs</code>)ã€èŠ‚ç‚¹ä¿¡æ¯(<code>Nodes</code>)ã€å·²æ³¨å†Œçš„æ’ä»¶(<code>Plugins</code>)ç­‰ã€‚</li><li><strong><code>JobInfo</code></strong>: è°ƒåº¦å™¨å†…éƒ¨å¯¹ <strong>PodGroup</strong> çš„å°è£…ï¼ŒåŒ…å«äº†ä¼˜å…ˆçº§ä¿¡æ¯ï¼ˆé€šè¿‡ <code>priortyClassName</code> è·å–ï¼‰ã€‚</li><li><strong><code>TaskInfo</code></strong>: è°ƒåº¦å™¨å†…éƒ¨å¯¹ <strong>Pod</strong> çš„å°è£…ï¼Œä¹Ÿæ‹¥æœ‰ä¼˜å…ˆçº§ä¿¡æ¯ã€‚</li><li><strong>ä¼˜å…ˆçº§æ¥æº</strong>: ä¼˜å…ˆçº§é€šå¸¸æ¥æºäº Pod æˆ– Job çš„ <code>priorityClassName</code> å­—æ®µï¼Œå…¶å€¼æ˜ å°„åˆ°ä¸€ä¸ªæ•´æ•° Valueï¼Œ<strong>å€¼è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜</strong>ã€‚</li></ul><h3 id="ğŸ”-Preempt-Action-è¯¦ç»†å·¥ä½œæµç¨‹"><a href="#ğŸ”-Preempt-Action-è¯¦ç»†å·¥ä½œæµç¨‹" class="headerlink" title="ğŸ” Preempt Action è¯¦ç»†å·¥ä½œæµç¨‹"></a>ğŸ” Preempt Action è¯¦ç»†å·¥ä½œæµç¨‹</h3><p>Preempt Action çš„å…¥å£ç‚¹åœ¨ <code>pkg/scheduler/actions/preempt/preempt.go</code> æ–‡ä»¶ä¸­çš„ <code>Execute</code> å‡½æ•°ã€‚å…¶å·¥ä½œæµç¨‹å¯ä»¥æ¦‚æ‹¬ä¸ºä»¥ä¸‹æ ¸å¿ƒæ­¥éª¤ï¼š</p><ol><li><p><strong>è¯†åˆ«å—å®³è€…ï¼ˆVictim Selectionï¼‰</strong>ï¼š<br>Preempt Action ä¼šéå†æ‰€æœ‰å½“å‰<strong>å·²è°ƒåº¦</strong>ï¼ˆå¤„äº <code>Running</code> æˆ– <code>Bound</code> çŠ¶æ€ï¼‰çš„ <code>TaskInfo</code>ï¼ˆPodï¼‰ï¼Œå¯»æ‰¾é‚£äº›<strong>ä¼˜å…ˆçº§ä½äº</strong>å½“å‰å¾…è°ƒåº¦ä»»åŠ¡çš„ Podã€‚è¿™äº›ä½ä¼˜å…ˆçº§çš„ Pod è¢«æ ‡è®°ä¸ºâ€œæ½œåœ¨çš„â€æŠ¢å å—å®³è€…ã€‚</p></li><li><p><strong>æ¨¡æ‹ŸæŠ¢å ä¸å®‰å…¨æ£€æŸ¥</strong>ï¼š<br>å¯¹äºæ¯ä¸€ä¸ªå¾…è°ƒåº¦çš„é«˜ä¼˜å…ˆçº§ä»»åŠ¡å’Œæ¯ä¸€ä¸ªæ½œåœ¨çš„å—å®³è€…ï¼Œè°ƒåº¦å™¨ä¼šè¿›è¡Œ<strong>æ¨¡æ‹ŸæŠ¢å </strong>ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸¥é‡ä¾èµ– <strong>Gang æ’ä»¶</strong>ï¼š</p><ul><li>Gang æ’ä»¶ä¼šæ£€æŸ¥ï¼šå¦‚æœé©±é€ï¼ˆæŠ¢å ï¼‰äº†æŸä¸ªï¼ˆæˆ–æŸäº›ï¼‰ä½ä¼˜å…ˆçº§çš„ Podï¼Œæ˜¯å¦ä¼šå¯¼è‡´å…¶æ‰€å±çš„ Job <strong>ä¸æ»¡è¶³ <code>minAvailable</code> çº¦æŸ</strong>ï¼ˆå³ç ´åå…¶ Gang è°ƒåº¦ç­–ç•¥ï¼‰ã€‚</li><li>åŒæ—¶ï¼Œ<strong>Conformance æ’ä»¶</strong>ä¼šç¡®ä¿ <code>kube-system</code> å‘½åç©ºé—´ä¸‹çš„å…³é”® Pod <strong>ä¸ä¼šè¢«æŠ¢å </strong>ã€‚</li><li>åªæœ‰é‚£äº›è¢«é©±é€å<strong>ä¸ä¼šç ´åå…¶åŸ Job å®Œæ•´æ€§</strong>çš„ä½ä¼˜å…ˆçº§ Podï¼Œæ‰ä¼šè¢«ç¡®å®šä¸ºâ€œçœŸæ­£çš„â€å—å®³è€…ã€‚</li></ul></li><li><p><strong>æ‰§è¡ŒæŠ¢å </strong>ï¼š<br>ä¸€æ—¦ç¡®å®šäº†å¯è¡Œçš„å—å®³è€…ï¼Œè°ƒåº¦å™¨ä¼š<strong>çœŸæ­£åœ°é©±é€è¿™äº› Pod</strong>ã€‚è¿™æ˜¯é€šè¿‡è°ƒç”¨ Kubernetes API <strong>åˆ é™¤è¿™äº› Pod</strong> æ¥å®ç°çš„ã€‚è¿™äº›è¢«æŠ¢å çš„ Pod ä¼šè¿›å…¥ <code>Terminating</code> çŠ¶æ€ï¼Œå…¶èµ„æºå°†è¢«é‡Šæ”¾ã€‚</p></li><li><p><strong>èµ„æºé‡Šæ”¾ä¸åç»­è°ƒåº¦</strong>ï¼š<br>å—å®³è€… Pod è¢«åˆ é™¤åï¼Œå®ƒä»¬ä¹‹å‰å ç”¨çš„èµ„æºï¼ˆCPUã€å†…å­˜ç­‰ï¼‰ä¹Ÿå°±é‡Šæ”¾äº†ã€‚è¿™äº›é‡Šæ”¾å‡ºæ¥çš„èµ„æº<strong>ä¸ä¼šç«‹å³åˆ†é…ç»™å‘èµ·æŠ¢å çš„é«˜ä¼˜å…ˆçº§ä»»åŠ¡</strong>ã€‚è€Œæ˜¯ç­‰å¾…<strong>ä¸‹ä¸€ä¸ªè°ƒåº¦å‘¨æœŸ</strong>ï¼Œç”± <code>Enqueue</code> å’Œ <code>Allocate</code> ç­‰ Action æ¥é‡æ–°åˆ†é…è¿™äº›èµ„æºã€‚æ­¤æ—¶ï¼Œç”±äºé«˜ä¼˜å…ˆçº§ä»»åŠ¡ä»åœ¨é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”èµ„æºå˜å¾—å¯ç”¨ï¼Œå®ƒå°±æœ‰å¾ˆå¤§æ¦‚ç‡åœ¨åç»­çš„è°ƒåº¦ä¸­è¢«æˆåŠŸåˆ†é…èµ„æºã€‚</p></li></ol><p>ä¸‹å›¾æ¦‚æ‹¬äº†ä¸Šè¿°æµç¨‹åŠå…¶ä¸åç»­è°ƒåº¦å‘¨æœŸçš„å…³ç³»ï¼š</p><p><img src="/2025/08/25/volcano%E8%B0%83%E5%BA%A6%E5%99%A8Preempt-Action%E8%AF%A6%E8%A7%A3/deepseek_mermaid_20250825_eb671f.png" alt="deepseek_mermaid_20250825_eb671f"></p><h3 id="âš™ï¸-ä¾èµ–çš„å…³é”®æ’ä»¶"><a href="#âš™ï¸-ä¾èµ–çš„å…³é”®æ’ä»¶" class="headerlink" title="âš™ï¸ ä¾èµ–çš„å…³é”®æ’ä»¶"></a>âš™ï¸ ä¾èµ–çš„å…³é”®æ’ä»¶</h3><p>Preempt Action çš„å…·ä½“è¡Œä¸ºç”±ä¸€ç³»åˆ—æ’ä»¶å†³å®šï¼š</p><ul><li><strong>Gang æ’ä»¶</strong>: è¿™æ˜¯å®‰å…¨æ£€æŸ¥çš„æ ¸å¿ƒã€‚å®ƒç¡®ä¿äº†æŠ¢å è¡Œä¸º<strong>ä¸ä¼šç ´ååˆ†å¸ƒå¼ä»»åŠ¡çš„åŸå­æ€§</strong>ï¼ˆâ€All or Nothingâ€ï¼‰ã€‚è¿™æ˜¯ Preempt Action èƒ½å®‰å…¨å·¥ä½œçš„åŸºçŸ³ã€‚</li><li><strong>Priority æ’ä»¶</strong>: ç”¨äºæ¯”è¾ƒ <code>JobInfo</code> æˆ– <code>TaskInfo</code> ä¹‹é—´çš„ä¼˜å…ˆçº§ï¼Œç¡®å®šè°å¯ä»¥æŠ¢å è°ã€‚</li><li><strong>Conformance æ’ä»¶</strong>: æä¾›ç³»ç»Ÿå±‚é¢çš„å®‰å…¨ä¿æŠ¤ï¼Œç¡®ä¿ <code>kube-system</code> å‘½åç©ºé—´ä¸‹çš„å…³é”® Pod <strong>ä¸ä¼šè¢«æŠ¢å </strong>ï¼Œç»´æŠ¤é›†ç¾¤çš„ç¨³å®šæ€§ã€‚</li></ul><h3 id="âš ï¸-é‡è¦é…ç½®ä¸æ³¨æ„äº‹é¡¹"><a href="#âš ï¸-é‡è¦é…ç½®ä¸æ³¨æ„äº‹é¡¹" class="headerlink" title="âš ï¸ é‡è¦é…ç½®ä¸æ³¨æ„äº‹é¡¹"></a>âš ï¸ é‡è¦é…ç½®ä¸æ³¨æ„äº‹é¡¹</h3><p>è¦ä½¿ Preempt Action æ­£å¸¸å·¥ä½œï¼Œå¿…é¡»åœ¨ <code>volcano-scheduler-configmap</code> ä¸­è¿›è¡Œæ­£ç¡®é…ç½®ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">actions:</span> <span class="hljs-string">&quot;enqueue, allocate, backfill, preempt&quot;</span> <span class="hljs-comment"># å¿…é¡»åŒ…å«preempt</span><br><span class="hljs-attr">tiers:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">plugins:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">priority</span>   <span class="hljs-comment"># ä¼˜å…ˆçº§æ¯”è¾ƒ</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">gang</span>       <span class="hljs-comment"># Gangç­–ç•¥æ£€æŸ¥</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">conformance</span> <span class="hljs-comment"># ä¿æŠ¤ç³»ç»ŸPod</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">plugins:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">drf</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">predicates</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nodeorder</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">preemption</span>  <span class="hljs-comment"># æŠ¢å æ’ä»¶æœ¬èº«åŠå…¶å‚æ•°</span><br>    <span class="hljs-attr">arguments:</span><br>      <span class="hljs-attr">enablePreemption:</span> <span class="hljs-literal">true</span>    <span class="hljs-comment"># å¿…é¡»æ˜¾å¼å¯ç”¨æŠ¢å </span><br>      <span class="hljs-attr">enableJobStarving:</span> <span class="hljs-literal">false</span>  <span class="hljs-comment"># é€šå¸¸éœ€è¦è®¾ç½®ä¸ºfalseä»¥å…è®¸æŠ¢å </span><br></code></pre></td></tr></table></figure><p><strong>å…³é”®å‚æ•°è§£æ</strong>ï¼š</p><ul><li><code>enablePreemption</code>: <strong>å¿…é¡»è®¾ç½®ä¸º <code>true</code></strong> æ¥å…¨å±€å¯ç”¨æŠ¢å åŠŸèƒ½ã€‚</li><li><code>enableJobStarving</code>: è¿™ä¸ªå‚æ•°çš„åç§°æœ‰äº›è¯¯å¯¼æ€§ã€‚å°†å…¶è®¾ç½®ä¸º <code>false</code> é€šå¸¸æ„å‘³ç€<strong>å…è®¸ä½ä¼˜å…ˆçº§ä»»åŠ¡è¢«æŠ¢å </strong>ï¼ˆå³â€œæŒ¨é¥¿â€ï¼‰ï¼Œä»è€Œä¸ºé«˜ä¼˜å…ˆçº§ä»»åŠ¡è®©è·¯ã€‚è®¾ç½®ä¸º <code>true</code> åè€Œå¯èƒ½ä¼šä¿æŠ¤å®ƒä»¬ä¸è¢«æŠ¢å ã€‚</li></ul><h3 id="ğŸ§ª-ç»“åˆç¤ºä¾‹è¯´æ˜"><a href="#ğŸ§ª-ç»“åˆç¤ºä¾‹è¯´æ˜" class="headerlink" title="ğŸ§ª ç»“åˆç¤ºä¾‹è¯´æ˜"></a>ğŸ§ª ç»“åˆç¤ºä¾‹è¯´æ˜</h3><p>å‡è®¾é˜Ÿåˆ— <code>queue-a</code> ä¸­æœ‰ä¸¤ä¸ª Jobï¼š</p><ul><li><strong>Job-Low</strong>: ä¼˜å…ˆçº§ä¸º 10ï¼Œå·²è¿è¡Œ 5 ä¸ª Podï¼ˆå…¶ <code>minAvailable</code> ä¸º 3ï¼‰ã€‚</li><li><strong>Job-High</strong>: ä¼˜å…ˆçº§ä¸º 100ï¼Œéœ€è¦ 3 ä¸ª Podï¼Œä½†å› èµ„æºä¸è¶³å¤„äº Pendingã€‚</li></ul><p>å½“ Preempt Action æ‰§è¡Œæ—¶ï¼š</p><ol><li><strong>è¯†åˆ«å—å®³è€…</strong>: å‘ç° <code>Job-Low</code> çš„ä¼˜å…ˆçº§ (10) ä½äº <code>Job-High</code> (100)ï¼Œå…¶ Pod è¢«åˆ—ä¸ºæ½œåœ¨å—å®³è€…ã€‚</li><li><strong>æ¨¡æ‹Ÿä¸æ£€æŸ¥</strong>: Gang æ’ä»¶æ£€æŸ¥æŠ¢å  <code>Job-Low</code> çš„ 2 ä¸ª Pod æ˜¯å¦å¯è¡Œã€‚ç”±äº <code>Job-Low</code> çš„ <code>minAvailable</code> æ˜¯ 3ï¼ŒæŠ¢å  2 ä¸ªåè¿˜å‰© 3 ä¸ªè¿è¡Œä¸­çš„ Podï¼Œæ»¡è¶³æ¡ä»¶ï¼Œå®‰å…¨æ£€æŸ¥é€šè¿‡ã€‚å¦‚æœ <code>minAvailable</code> æ˜¯ 5ï¼Œåˆ™æŠ¢å ä»»ä½• 1 ä¸ª Pod éƒ½ä¼šå¯¼è‡´å…¶ä¸æ»¡è¶³æ¡ä»¶ï¼ŒæŠ¢å ä¼šè¢«ç¦æ­¢ã€‚</li><li><strong>æ‰§è¡ŒæŠ¢å </strong>: é©±é€ <code>Job-Low</code> çš„ 2 ä¸ª Podã€‚</li><li><strong>èµ„æºé‡Šæ”¾</strong>: è¿™ 2 ä¸ª Pod å ç”¨çš„èµ„æºè¢«é‡Šæ”¾ã€‚</li><li><strong>åç»­è°ƒåº¦</strong>: åœ¨ä¸‹ä¸€ä¸ªè°ƒåº¦å‘¨æœŸï¼Œ<code>Job-High</code> çš„ 3 ä¸ª Pod å› ä¸ºä¼˜å…ˆçº§é«˜ï¼Œåœ¨ <code>Allocate</code> action ä¸­æˆåŠŸåˆ†é…åˆ°è¿™éƒ¨åˆ†æ–°é‡Šæ”¾çš„èµ„æºã€‚</li></ol><h3 id="ğŸ’¡-æ€»ç»“ä¸å…³é”®ç‚¹"><a href="#ğŸ’¡-æ€»ç»“ä¸å…³é”®ç‚¹" class="headerlink" title="ğŸ’¡ æ€»ç»“ä¸å…³é”®ç‚¹"></a>ğŸ’¡ æ€»ç»“ä¸å…³é”®ç‚¹</h3><ol><li><strong>é˜Ÿåˆ—å†…æŠ¢å </strong>: Volcano çš„ Preempt Action ä¸»è¦å¤„ç†<strong>åŒä¸€é˜Ÿåˆ—å†…</strong>çš„æŠ¢å ã€‚</li><li><strong>å®‰å…¨ç¬¬ä¸€</strong>: æŠ¢å è¿‡ç¨‹å—åˆ° <strong>Gang ç­–ç•¥çš„ä¸¥æ ¼çº¦æŸ</strong>ï¼Œç»ä¸ä¼šä»¥ç ´åä¸€ä¸ªåˆ†å¸ƒå¼åº”ç”¨çš„å®Œæ•´æ€§ä¸ºä»£ä»·å»æ»¡è¶³å¦ä¸€ä¸ªåº”ç”¨ã€‚</li><li><strong>å¼‚æ­¥è¿‡ç¨‹</strong>: æŠ¢å ï¼ˆåˆ é™¤ Podï¼‰å’Œèµ„æºçš„å†åˆ†é…ï¼ˆè°ƒåº¦é«˜ä¼˜å…ˆçº§ Podï¼‰æ˜¯<strong>è·¨è°ƒåº¦å‘¨æœŸ</strong>çš„å¼‚æ­¥è¿‡ç¨‹ã€‚</li><li><strong>é…ç½®æ˜¯å…³é”®</strong>: å¿…é¡»æ­£ç¡®é…ç½®è°ƒåº¦å™¨ ConfigMap ä¸­çš„ <code>actions</code> å’Œ <code>preemption</code> æ’ä»¶å‚æ•°ï¼ˆç‰¹åˆ«æ˜¯ <code>enablePreemption: true</code>ï¼‰æ‰èƒ½å¯ç”¨æŠ¢å åŠŸèƒ½ã€‚</li><li><strong>ç³»ç»Ÿä¿æŠ¤</strong>: å…³é”®ç³»ç»Ÿ Pod é»˜è®¤å—åˆ°ä¿æŠ¤ï¼Œä¸ä¼šè¢«æŠ¢å ï¼Œç¡®ä¿äº†é›†ç¾¤çš„ç¨³å®šæ€§ã€‚</li></ol><p>å¸Œæœ›è¿™ä»½ç»“åˆæºç çš„è¯¦ç»†è§£è¯»ï¼Œèƒ½å¸®åŠ©ä½ é€å½»åœ°ç†è§£ Volcano Preempt Action çš„å·¥ä½œæœºåˆ¶ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>volcano-allocate-actionè¯¦è§£</title>
    <link href="/2025/08/24/volcano-allocate-action%E8%AF%A6%E8%A7%A3/"/>
    <url>/2025/08/24/volcano-allocate-action%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<p>Volcano è°ƒåº¦å™¨ä¸­çš„ <strong>Allocate Action</strong> æ˜¯è°ƒåº¦æµç¨‹çš„æ ¸å¿ƒç¯èŠ‚ï¼Œå®ƒè´Ÿè´£ä¸ºå·²ç»å…¥é˜Ÿï¼ˆInqueueï¼‰çš„ Pod åˆ†é…å…·ä½“çš„èŠ‚ç‚¹ã€‚è¿™ä¸ªè¿‡ç¨‹éå¸¸ç²¾å¯†ï¼Œæ¶‰åŠåˆ°é¢„é€‰ã€ä¼˜é€‰ã€èµ„æºé¢„ç•™å’Œæœ€ç»ˆçš„ç»‘å®šå†³ç­–ã€‚</p><p>ä¸‹é¢æˆ‘å°†ç»“åˆ Volcano çš„æœ€æ–°æºç ï¼ˆä¸»è¦å‚è€ƒ <code>v1.12.0</code> ç‰ˆæœ¬ï¼‰ï¼Œä¸ºä½ è¯¦ç»†è§£æ Allocate Action çš„å…·ä½“è¿‡ç¨‹ã€‚</p><h3 id="ğŸ”§-Allocate-Action-çš„æ ¸å¿ƒä½œç”¨"><a href="#ğŸ”§-Allocate-Action-çš„æ ¸å¿ƒä½œç”¨" class="headerlink" title="ğŸ”§ Allocate Action çš„æ ¸å¿ƒä½œç”¨"></a>ğŸ”§ Allocate Action çš„æ ¸å¿ƒä½œç”¨</h3><p>Allocate Action çš„æ ¸å¿ƒä»»åŠ¡æ˜¯<strong>ä¸ºæ¯ä¸ªå·²å…¥é˜Ÿçš„ Pod å°è¯•åˆ†é…ä¸€ä¸ªåˆé€‚çš„èŠ‚ç‚¹</strong>ã€‚å®ƒä¸ä»…ä¼šæ£€æŸ¥èŠ‚ç‚¹èµ„æºçš„å……è¶³æ€§ï¼Œè¿˜è¦ç¡®ä¿æ»¡è¶³ä½œä¸šçº§åˆ«çš„çº¦æŸï¼ˆå¦‚ Gang è°ƒåº¦ç­–ç•¥ï¼‰ï¼Œå¹¶åœ¨æœ€ç»ˆä¸€æ¬¡æ€§æäº¤æ‰€æœ‰ç»‘å®šå†³ç­–ã€‚</p><h3 id="ğŸ“¦-å…³é”®æ•°æ®ç»“æ„"><a href="#ğŸ“¦-å…³é”®æ•°æ®ç»“æ„" class="headerlink" title="ğŸ“¦ å…³é”®æ•°æ®ç»“æ„"></a>ğŸ“¦ å…³é”®æ•°æ®ç»“æ„</h3><p>åœ¨æ·±å…¥æµç¨‹ä¹‹å‰ï¼Œäº†è§£å‡ ä¸ªå…³é”®çš„æ•°æ®ç»“æ„æœ‰åŠ©äºç†è§£åç»­è¿‡ç¨‹ï¼š</p><ul><li><strong><code>Session</code></strong>: ä»£è¡¨ä¸€ä¸ªè°ƒåº¦å‘¨æœŸï¼ˆSessionï¼‰çš„ä¸Šä¸‹æ–‡ï¼ŒåŒ…å«äº†å½“å‰è°ƒåº¦æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¦‚å¾…è°ƒåº¦çš„ Job åˆ—è¡¨ (<code>Jobs</code>)ã€é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯ (<code>Nodes</code>)ã€å·²æ³¨å†Œçš„æ’ä»¶ (<code>Plugins</code>) ç­‰ã€‚Allocate Action ä¼šæ“ä½œè¿™ä¸ª Sessionã€‚</li><li><strong><code>JobInfo</code></strong>: å¹¶éç›´æ¥å¯¹åº” Volcano Job CRDï¼Œè€Œæ˜¯è°ƒåº¦å™¨å†…éƒ¨å¯¹ <strong>PodGroup</strong> åŠå…¶æ‰€å± Pod çš„å°è£…ã€‚ä¸€ä¸ª <code>JobInfo</code> åŒ…å«äº†ä¸€ä¸ª PodGroup ä¸‹çš„æ‰€æœ‰ Podï¼ˆå°è£…ä¸º <code>TaskInfo</code>ï¼‰ã€‚</li><li><strong><code>TaskInfo</code></strong>: è°ƒåº¦å™¨å†…éƒ¨å¯¹ <strong>Pod</strong> çš„å°è£…ã€‚åŒ…å«äº† Pod çš„è¯¦ç»†ä¿¡æ¯ä»¥åŠå…¶èµ„æºè¯·æ±‚ã€‚</li><li><strong><code>NodeInfo</code></strong>: è°ƒåº¦å™¨å†…éƒ¨å¯¹ <strong>Kubernetes Node</strong> çš„å°è£…ã€‚åŒ…å«äº†èŠ‚ç‚¹çš„èµ„æºå®¹é‡ã€å·²åˆ†é…èµ„æºã€æ”¯æŒçš„æ“ä½œç³»ç»Ÿæ¶æ„ç­‰ä¿¡æ¯ã€‚</li></ul><h3 id="ğŸ”-Allocate-Action-è¯¦ç»†å·¥ä½œæµç¨‹"><a href="#ğŸ”-Allocate-Action-è¯¦ç»†å·¥ä½œæµç¨‹" class="headerlink" title="ğŸ” Allocate Action è¯¦ç»†å·¥ä½œæµç¨‹"></a>ğŸ” Allocate Action è¯¦ç»†å·¥ä½œæµç¨‹</h3><p>Allocate Action çš„å…¥å£ç‚¹åœ¨ <code>pkg/scheduler/actions/allocate/allocate.go</code> æ–‡ä»¶ä¸­çš„ <code>Execute</code> å‡½æ•°ã€‚å…¶å·¥ä½œæµç¨‹å¯ä»¥æ¦‚æ‹¬ä¸ºä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒæ­¥éª¤ï¼š</p><ol><li><strong>å‡†å¤‡å¾…è°ƒåº¦çš„ä»»åŠ¡</strong>ï¼šéå†å½“å‰ Session ä¸­çš„æ‰€æœ‰ <code>JobInfo</code>ï¼Œæ”¶é›†å…¶ä¸­å¤„äº <code>Pending</code> çŠ¶æ€çš„ <code>TaskInfo</code>ï¼ˆPodï¼‰ã€‚è¿™äº›ä»»åŠ¡å°±æ˜¯æœ¬è½® Allocate Action éœ€è¦å°è¯•è°ƒåº¦çš„å¯¹è±¡ã€‚</li><li><strong>ä»»åŠ¡æ’åº</strong>ï¼šæ ¹æ®é…ç½®çš„æ’ä»¶ï¼ˆå¦‚ <strong>Priority</strong> æ’ä»¶ï¼‰ï¼Œå¯¹è¿™äº›å¾…è°ƒåº¦çš„ <code>TaskInfo</code> è¿›è¡Œæ’åºã€‚é€šå¸¸ä¼˜å…ˆçº§é«˜çš„ä»»åŠ¡ä¼šä¼˜å…ˆå¾—åˆ°è°ƒåº¦ã€‚</li><li><strong>éå†ä»»åŠ¡ï¼Œå°è¯•åˆ†é…</strong>ï¼šè¿™æ˜¯æœ€æ ¸å¿ƒçš„å¾ªç¯ã€‚å¯¹äºæ¯ä¸€ä¸ªå¾…è°ƒåº¦çš„ä»»åŠ¡ï¼Œæ‰§è¡Œä»¥ä¸‹å­æ­¥éª¤ï¼š<ul><li><strong>a. é¢„é€‰ (Predicate)<strong>ï¼šè°ƒç”¨ <strong>Predicates</strong> æ’ä»¶ï¼Œè¿‡æ»¤æ‰æ‰€æœ‰ä¸æ»¡è¶³è¯¥ Pod åŸºæœ¬è¦æ±‚çš„èŠ‚ç‚¹ã€‚ä¾‹å¦‚ï¼Œæ£€æŸ¥èŠ‚ç‚¹çš„èµ„æºï¼ˆCPUã€å†…å­˜ã€GPUï¼‰æ˜¯å¦ &gt;&#x3D; Pod çš„è¯·æ±‚ï¼Œæ£€æŸ¥èŠ‚ç‚¹Selectorã€äº²å’Œæ€§&#x2F;åäº²å’Œæ€§ã€æ±¡ç‚¹å®¹å¿ç­‰ã€‚é€šè¿‡è¿™ä¸€æ­¥ï¼Œä¼šå¾—åˆ°ä¸€ä¸ª</strong>å€™é€‰èŠ‚ç‚¹åˆ—è¡¨</strong>ã€‚</li><li><strong>b. ä¼˜é€‰ (Prioritize&#x2F;Node Ordering)<strong>ï¼šå¦‚æœé¢„é€‰åè¿˜æœ‰å¤šä¸ªå€™é€‰èŠ‚ç‚¹ï¼Œåˆ™ä¼šè°ƒç”¨ <strong>NodeOrder</strong> ç­‰æ’ä»¶ä¸ºè¿™äº›èŠ‚ç‚¹æ‰“åˆ†ã€‚æ’ä»¶ä¼šè€ƒè™‘å¤šç§å› ç´ ï¼Œå¦‚èµ„æºå¹³è¡¡ï¼ˆBinpack æˆ– Spreadï¼‰ã€èŠ‚ç‚¹äº²å’Œæ€§ã€é•œåƒæ˜¯å¦å·²å­˜åœ¨ç­‰ï¼Œæœ€ç»ˆé€‰å‡ºä¸€ä¸ª</strong>æœ€ä¼˜èŠ‚ç‚¹</strong>ã€‚</li><li><strong>c. èµ„æºé¢„ç•™ (Reservation)<strong>ï¼šå¹¶ä¸æ˜¯ç«‹å³è°ƒç”¨ Kubernetes API è¿›è¡Œç»‘å®šï¼Œè€Œæ˜¯åœ¨å½“å‰ Session çš„ç¼“å­˜ä¸­ï¼Œ</strong>æ¨¡æ‹Ÿ</strong>ä»é€‰å‡ºçš„æœ€ä¼˜èŠ‚ç‚¹ä¸Šæ‰£é™¤è¯¥ Pod æ‰€è¯·æ±‚çš„èµ„æºã€‚è¿™ä¸€æ­¥ç¡®ä¿äº†åç»­çš„è°ƒåº¦å†³ç­–æ˜¯åŸºäºæœ€æ–°çš„èµ„æºè§†å›¾ï¼Œé¿å…äº†é‡å¤åˆ†é…ã€‚</li><li><strong>d. ç”Ÿæˆåˆ†é…æŒ‡ä»¤</strong>ï¼šå°† <code>(TaskInfo, NodeInfo)</code> è¿™ä¸ªåˆ†é…å†³ç­–è®°å½•ä¸‹æ¥ï¼Œå­˜å‚¨åœ¨ Session ä¸­ï¼Œç­‰å¾…åç»­æäº¤ã€‚</li></ul></li><li><strong>æäº¤åˆ†é…å†³ç­– (Commit)<strong>ï¼šåœ¨æ‰€æœ‰åˆé€‚çš„ä»»åŠ¡éƒ½ç»è¿‡ä¸Šè¿°æµç¨‹åï¼ŒAllocate Action ä¼š</strong>ä¸€æ¬¡æ€§æäº¤</strong>æœ¬å‘¨æœŸå†…æ‰€æœ‰çš„åˆ†é…å†³ç­–ã€‚è°ƒåº¦å™¨ä¼šå°†è¿™äº›ç»‘å®šä¿¡æ¯ï¼ˆPod å’Œ Node çš„å¯¹åº”å…³ç³»ï¼‰é€šè¿‡ Kubernetes API Server è¿›è¡Œæ›´æ–°ï¼ˆè®¾ç½® Pod çš„ <code>nodeName</code> å­—æ®µï¼‰ã€‚</li></ol><p><img src="/2025/08/24/volcano-allocate-action%E8%AF%A6%E8%A7%A3/deepseek_mermaid_20250823_5e5c2b.png" alt="deepseek_mermaid_20250823_5e5c2b"></p><h3 id="âš™ï¸-ä¾èµ–çš„å…³é”®æ’ä»¶"><a href="#âš™ï¸-ä¾èµ–çš„å…³é”®æ’ä»¶" class="headerlink" title="âš™ï¸ ä¾èµ–çš„å…³é”®æ’ä»¶"></a>âš™ï¸ ä¾èµ–çš„å…³é”®æ’ä»¶</h3><p>Allocate Action æœ¬èº«æ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œå…¶å…·ä½“è¡Œä¸ºç”±ä¸€ç³»åˆ—æ’ä»¶å†³å®šï¼š</p><ul><li><strong>Gang æ’ä»¶</strong>: è¿™æ˜¯ <strong>â€œAll or Nothingâ€ ç­–ç•¥çš„å¼ºåˆ¶æ‰§è¡Œè€…</strong>ã€‚å³ä½¿ä¸€ä¸ª Pod é€šè¿‡äº†é¢„é€‰å’Œä¼˜é€‰ï¼ŒGang æ’ä»¶ä¹Ÿä¼šæ£€æŸ¥å…¶æ‰€å±çš„æ•´ä¸ª <code>JobInfo</code> (PodGroup) æ˜¯å¦æ»¡è¶³ <code>minAvailable</code> æ¡ä»¶ã€‚<strong>åªæœ‰åœ¨æ»¡è¶³ <code>minAvailable</code> æ—¶ï¼Œæœ¬æ¬¡ä¼šè¯ä¸­ä¸ºè¯¥ Job æ‰€åšçš„æ‰€æœ‰åˆ†é…æ‰ä¼šè¢«æäº¤ï¼›å¦åˆ™ï¼Œæ‰€æœ‰åˆ†é…éƒ½ä¼šè¢«å›æ»š</strong>ï¼Œè¯¥ Job çš„ Pod ä¸ä¼šç»‘å®šåˆ°ä»»ä½•èŠ‚ç‚¹ã€‚<strong>Gangæ£€æŸ¥æ˜¯åœ¨éå†å®Œæ‰€æœ‰çš„podä¹‹å</strong>ã€‚</li><li><strong>Predicates æ’ä»¶</strong>: è´Ÿè´£<strong>é¢„é€‰</strong>ï¼Œå®ç°èŠ‚ç‚¹è¿‡æ»¤çš„é€»è¾‘ã€‚å®ƒæ£€æŸ¥ Pod æ˜¯å¦é€‚åˆè°ƒåº¦åˆ°æŸä¸ªèŠ‚ç‚¹ä¸Šã€‚</li><li><strong>NodeOrder æ’ä»¶</strong>: è´Ÿè´£<strong>ä¼˜é€‰</strong>ï¼Œå®ç°èŠ‚ç‚¹æ‰“åˆ†çš„é€»è¾‘ã€‚å®ƒä¸ºæ¯ä¸ªå€™é€‰èŠ‚ç‚¹è®¡ç®—ä¸€ä¸ªåˆ†æ•°ï¼Œè°ƒåº¦å™¨é€‰æ‹©åˆ†æ•°æœ€é«˜çš„èŠ‚ç‚¹ã€‚</li><li><strong>Binpack æ’ä»¶</strong>: é€šå¸¸ä¸ NodeOrder æ’ä»¶ååŒå·¥ä½œï¼Œå€¾å‘äºå°†èµ„æºåˆ†é…é›†ä¸­åœ¨å°½å¯èƒ½å°‘çš„èŠ‚ç‚¹ä¸Šï¼Œä»¥æé«˜èŠ‚ç‚¹åˆ©ç”¨ç‡ï¼Œä¾¿äºåç»­è…¾ç©ºèŠ‚ç‚¹ã€‚</li><li><strong>Priority æ’ä»¶</strong>: ç”¨äºåœ¨å¤šä¸ªå¾…è°ƒåº¦çš„ Task(Pod) ä¹‹é—´è¿›è¡Œä¼˜å…ˆçº§æ’åºï¼Œå†³å®šå“ªä¸ª Pod ä¼˜å…ˆè¿›è¡Œåˆ†é…ã€‚</li></ul><h3 id="ğŸ§ª-ç»“åˆç¤ºä¾‹è¯´æ˜"><a href="#ğŸ§ª-ç»“åˆç¤ºä¾‹è¯´æ˜" class="headerlink" title="ğŸ§ª ç»“åˆç¤ºä¾‹è¯´æ˜"></a>ğŸ§ª ç»“åˆç¤ºä¾‹è¯´æ˜</h3><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåŒ…å« 1 ä¸ª <code>ps</code> å’Œ 2 ä¸ª <code>worker</code> çš„ TensorFlow ä½œä¸šï¼ˆPodGroupï¼Œ<code>minAvailable=3</code>ï¼‰ï¼Œå¹¶ä¸”å·²é€šè¿‡ Enqueue Action æ£€æŸ¥ï¼ŒPod å·²è¢«åˆ›å»ºã€‚</p><ol><li><strong>Allocate Action å¼€å§‹</strong>ï¼šè°ƒåº¦å™¨æ”¶é›†è¿™ 3 ä¸ªå¤„äº Pending çŠ¶æ€çš„ Podã€‚</li><li><strong>ä»»åŠ¡æ’åº</strong>ï¼šå‡è®¾ä¼˜å…ˆçº§ç›¸åŒï¼Œåˆ™æŒ‰åˆ›å»ºæ—¶é—´ç­‰é¡ºåºå¤„ç†ã€‚</li><li><strong>ä¸º <code>ps</code> Pod åˆ†é…</strong>ï¼š<ul><li><strong>Predicate</strong>ï¼šè¿‡æ»¤å‡ºæ‰€æœ‰æ»¡è¶³ <code>ps</code> èµ„æºè¯·æ±‚ï¼ˆä¾‹å¦‚ 1 CPU, 2GiB Memï¼‰çš„èŠ‚ç‚¹ã€‚</li><li><strong>NodeOrder</strong>ï¼šå¯¹å€™é€‰èŠ‚ç‚¹æ‰“åˆ†ï¼ˆä¾‹å¦‚ï¼Œé€‰æ‹©èµ„æºç¢ç‰‡æœ€å°‘çš„èŠ‚ç‚¹ <code>node-a</code>ï¼‰ã€‚</li><li><strong>é¢„ç•™</strong>ï¼šåœ¨ Session ä¸­æ ‡è®° <code>node-a</code> çš„ 1 CPU å’Œ 2GiB Mem è¢«é¢„ç•™ã€‚</li></ul></li><li><strong>ä¸º <code>worker-1</code> Pod åˆ†é…</strong>ï¼š<ul><li><strong>Predicate</strong>ï¼šè¿‡æ»¤èŠ‚ç‚¹ï¼ˆç°åœ¨ <code>node-a</code> å¯ç”¨èµ„æºå‡å°‘äº†ï¼‰ã€‚</li><li><strong>NodeOrder</strong>ï¼šé€‰å‡ºæœ€ä¼˜èŠ‚ç‚¹ <code>node-b</code>ã€‚</li><li><strong>é¢„ç•™</strong>ï¼šé¢„ç•™ <code>node-b</code> ä¸Š 2 CPU å’Œ 4GiB Memã€‚</li></ul></li><li><strong>ä¸º <code>worker-2</code> Pod åˆ†é…</strong>ï¼š<ul><li><strong>Predicate</strong>ï¼šè¿‡æ»¤èŠ‚ç‚¹ã€‚</li><li><strong>NodeOrder</strong>ï¼šé€‰å‡ºæœ€ä¼˜èŠ‚ç‚¹ <code>node-c</code>ã€‚</li><li><strong>é¢„ç•™</strong>ï¼šé¢„ç•™ <code>node-c</code> ä¸Š 2 CPU å’Œ 4GiB Memã€‚</li></ul></li><li><strong>Gang æ’ä»¶æ£€æŸ¥</strong>ï¼šè°ƒåº¦å™¨æ£€æŸ¥åˆ°è¯¥ Job çš„ 3 ä¸ª Pod éƒ½å·²æˆåŠŸåˆ†é…èŠ‚ç‚¹ï¼Œæ»¡è¶³ <code>minAvailable=3</code> çš„æ¡ä»¶ã€‚</li><li><strong>æäº¤</strong>ï¼šè°ƒåº¦å™¨é€šè¿‡ API Server å°†è¿™ 3 ä¸ª Pod åˆ†åˆ«ç»‘å®šåˆ° <code>node-a</code>, <code>node-b</code>, <code>node-c</code>ã€‚</li></ol><p>å¦‚æœé›†ç¾¤èµ„æºåªå¤Ÿè¿è¡Œ 2 ä¸ª <code>worker</code>ï¼Œä¸å¤Ÿè¿è¡Œ <code>ps</code>ï¼Œé‚£ä¹ˆ Gang æ’ä»¶ä¼šæ£€æŸ¥å¤±è´¥ï¼Œå¯¼è‡´<strong>æ‰€æœ‰ 3 ä¸ª Pod çš„åˆ†é…éƒ½ä¼šè¢«æ’¤é”€</strong>ï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªè°ƒåº¦å‘¨æœŸå†å°è¯•ã€‚è¿™å°±æœ‰æ•ˆé˜²æ­¢äº†åˆ†å¸ƒå¼ä»»åŠ¡å› éƒ¨åˆ†è¿›ç¨‹æ— æ³•å¯åŠ¨è€Œé€ æˆçš„æ­»é”ã€‚</p><h3 id="âš ï¸-æ³¨æ„äº‹é¡¹"><a href="#âš ï¸-æ³¨æ„äº‹é¡¹" class="headerlink" title="âš ï¸ æ³¨æ„äº‹é¡¹"></a>âš ï¸ æ³¨æ„äº‹é¡¹</h3><ol><li><strong>æ‰§è¡Œé¡ºåº</strong>ï¼šåœ¨ <code>volcano-scheduler-configmap</code> ä¸­ï¼Œ<code>allocate</code> é€šå¸¸æ”¾ç½®åœ¨ <code>enqueue</code> ä¹‹åï¼Œ<code>backfill</code> ä¹‹å‰ã€‚Action çš„æ‰§è¡Œé¡ºåºå¾ˆé‡è¦ã€‚</li><li><strong>æ’ä»¶é…ç½®</strong>ï¼šç¡®ä¿ <code>allocate</code> æ‰€ä¾èµ–çš„æ’ä»¶ï¼ˆå¦‚ <code>predicates</code>, <code>nodeorder</code>, <code>gang</code>ï¼‰å·²åœ¨é…ç½®ä¸­æ­£ç¡®å¯ç”¨å¹¶æ”¾ç½®åœ¨åˆé€‚çš„ tier ä¸­ã€‚</li><li><strong>ä¸ Preempt&#x2F;Reclaim çš„åŒºåˆ«</strong>ï¼š<code>Allocate</code> æ˜¯æ­£å¸¸åˆ†é…ï¼Œè€Œ <code>Preempt</code> æ˜¯åŒä¸€é˜Ÿåˆ—å†…åŸºäºä¼˜å…ˆçº§çš„æŠ¢å ï¼Œ<code>Reclaim</code> æ˜¯è·¨é˜Ÿåˆ—çš„èµ„æºå›æ”¶ã€‚å®ƒä»¬è§£å†³çš„æ˜¯ä¸åŒå±‚é¢çš„èµ„æºåˆ†é…é—®é¢˜ã€‚</li></ol><p>å¸Œæœ›è¿™ä»½ç»“åˆæºç çš„è¯¦ç»†è§£è¯»ï¼Œèƒ½å¸®åŠ©ä½ é€å½»åœ°ç†è§£ Volcano Allocate Action çš„å·¥ä½œæœºåˆ¶ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>PVC-StorageClass-PVåŸç†è§£è¯»</title>
    <link href="/2025/08/22/PVC-StorageClass-PV%E5%8E%9F%E7%90%86%E8%A7%A3%E8%AF%BB/"/>
    <url>/2025/08/22/PVC-StorageClass-PV%E5%8E%9F%E7%90%86%E8%A7%A3%E8%AF%BB/</url>
    
    <content type="html"><![CDATA[<h1 id="PVCã€StorageClassã€PVæ˜¯ä»€ä¹ˆ"><a href="#PVCã€StorageClassã€PVæ˜¯ä»€ä¹ˆ" class="headerlink" title="PVCã€StorageClassã€PVæ˜¯ä»€ä¹ˆ"></a>PVCã€StorageClassã€PVæ˜¯ä»€ä¹ˆ</h1><p>ä½ å¥½ï¼æ¬¢è¿æ¥åˆ°Kubernetesçš„ä¸–ç•Œï¼ä½ é‡åˆ°çš„è¿™ä¸‰ä¸ªæ¦‚å¿µï¼ˆPVC, PV, StorageClassï¼‰ç¡®å®æ˜¯å­˜å‚¨éƒ¨åˆ†çš„æ ¸å¿ƒï¼Œä¹Ÿæ˜¯å¾ˆå¤šåˆå­¦è€…ä¼šæ„Ÿåˆ°å›°æƒ‘çš„åœ°æ–¹ã€‚åˆ«æ‹…å¿ƒï¼Œæˆ‘ç”¨ä¸€ä¸ªç®€å•çš„æ¯”å–»å’Œè¯¦ç»†çš„è§£é‡Šæ¥å¸®ä½ å½»åº•ææ‡‚å®ƒä»¬ã€‚</p><h3 id="ä¸€ä¸ªç”ŸåŠ¨çš„æ¯”å–»ï¼šç§Ÿæˆ¿"><a href="#ä¸€ä¸ªç”ŸåŠ¨çš„æ¯”å–»ï¼šç§Ÿæˆ¿" class="headerlink" title="ä¸€ä¸ªç”ŸåŠ¨çš„æ¯”å–»ï¼šç§Ÿæˆ¿"></a>ä¸€ä¸ªç”ŸåŠ¨çš„æ¯”å–»ï¼šç§Ÿæˆ¿</h3><p>æƒ³è±¡ä¸€ä¸‹ä½ è¦ç§Ÿæˆ¿å­ï¼š</p><ol><li><p><strong>PVC (PersistentVolumeClaim) - ä½ çš„â€œç§Ÿæˆ¿éœ€æ±‚â€</strong></p><ul><li>ä½ å‘Šè¯‰ä¸­ä»‹ï¼šâ€œæˆ‘éœ€è¦ä¸€ä¸ª<strong>ä¸å°äº20å¹³ç±³ã€å¸¦çª—æˆ·ã€æœˆç§Ÿä¸è¶…è¿‡2000å—</strong>çš„æˆ¿å­ã€‚â€ è¿™ä»½â€œéœ€æ±‚æ¸…å•â€å°±æ˜¯ä½ çš„<strong>PVC</strong>ã€‚å®ƒä¸å…³å¿ƒæˆ¿å­å…·ä½“åœ¨å“ªã€æˆ¿ä¸œæ˜¯è°ï¼Œåªå…³å¿ƒä½ çš„<strong>è§„æ ¼è¦æ±‚</strong>ã€‚</li></ul></li><li><p><strong>PV (PersistentVolume) - å…·ä½“çš„â€œæˆ¿å­â€</strong></p><ul><li>ä¸­ä»‹æ‰‹é‡Œæœ‰ä¸€å¥—<strong>çœŸå®çš„ã€å…·ä½“çš„</strong>æˆ¿å­ï¼Œåœ°å€æ˜¯â€œXXå°åŒº1å·æ¥¼101â€ï¼Œé¢ç§¯25å¹³ç±³ï¼Œæœˆç§Ÿ1800å—ã€‚è¿™å¥—æˆ¿å­å°±æ˜¯ä¸€ä¸ª<strong>PV</strong>ã€‚å®ƒæ˜¯é›†ç¾¤ä¸­çš„<strong>ä¸€å—å®é™…çš„å­˜å‚¨èµ„æº</strong>ï¼Œå°±åƒä¸€å—ç¡¬ç›˜ã€‚</li></ul></li><li><p><strong>StorageClass - é«˜æ•ˆçš„â€œæˆ¿äº§å¼€å‘å•† + ä¸­ä»‹â€</strong></p><ul><li>ç°åœ¨ï¼Œä½ ä¸ç”¨ç­‰ä¸­ä»‹å»æ‰¾ç°æˆçš„æˆ¿å­äº†ã€‚æœ‰ä¸€ä¸ªè¶…çº§é«˜æ•ˆçš„<strong>â€œå¼€å‘å•†+ä¸­ä»‹â€è”åˆä½“</strong>ï¼ˆStorageClassï¼‰ã€‚ä½ ä¸€æ—¦æå‡ºéœ€æ±‚ï¼ˆPVCï¼‰ï¼Œè¿™ä¸ªè”åˆä½“å°±ç«‹åˆ»<strong>æŒ‰éœ€</strong>ä¸ºä½ å»ºå¥½ä¸€å¥—æ–°æˆ¿ï¼ˆPVï¼‰å¹¶ç§Ÿç»™ä½ ã€‚å®ƒå®šä¹‰äº†<strong>å¦‚ä½•åŠ¨æ€åœ°åˆ›å»ºPV</strong>ï¼ˆæˆ¿å­çš„å»ºé€ æ ‡å‡†ã€ç”¨ä»€ä¹ˆææ–™ç­‰ï¼‰ã€‚</li></ul></li></ol><p><strong>å…³ç³»æ€»ç»“ï¼š</strong></p><ul><li><strong>PVC</strong> æ˜¯ <strong>éœ€æ±‚</strong>ã€‚</li><li><strong>PV</strong> æ˜¯ <strong>èµ„æº</strong>ã€‚</li><li><strong>StorageClass</strong> æ˜¯ <strong>æŒ‰éœ€åˆ›å»ºèµ„æºçš„æ¨¡æ¿å’Œè‡ªåŠ¨åŒ–å·¥å…·</strong>ã€‚</li><li><strong>PVC å‘ç³»ç»Ÿç”³è¯·èµ„æºï¼Œç³»ç»Ÿåˆ™å¯»æ‰¾ä¸€ä¸ªç°æœ‰çš„PVï¼ˆé™æ€ä¾›ç»™ï¼‰æˆ–é€šè¿‡StorageClassåˆ›å»ºä¸€ä¸ªæ–°çš„PVï¼ˆåŠ¨æ€ä¾›ç»™ï¼‰æ¥æ»¡è¶³è¿™ä¸ªPVCçš„éœ€æ±‚ã€‚</strong></li></ul><hr><h3 id="è¯¦ç»†æ¦‚å¿µè§£é‡Š"><a href="#è¯¦ç»†æ¦‚å¿µè§£é‡Š" class="headerlink" title="è¯¦ç»†æ¦‚å¿µè§£é‡Š"></a>è¯¦ç»†æ¦‚å¿µè§£é‡Š</h3><h4 id="1-PV-PersistentVolume-æŒä¹…åŒ–å·"><a href="#1-PV-PersistentVolume-æŒä¹…åŒ–å·" class="headerlink" title="1. PV (PersistentVolume) - æŒä¹…åŒ–å·"></a>1. PV (PersistentVolume) - æŒä¹…åŒ–å·</h4><ul><li><strong>æ˜¯ä»€ä¹ˆ</strong>ï¼š é›†ç¾¤ä¸­çš„ä¸€å—<strong>ç½‘ç»œå­˜å‚¨ç©ºé—´</strong>ã€‚å®ƒæ˜¯é›†ç¾¤çº§åˆ«çš„èµ„æºï¼Œå°±åƒé›†ç¾¤ä¸­çš„ä¸€å°Nodeä¸€æ ·ï¼Œä¸å±äºä»»ä½•Namespaceã€‚å®ƒæ˜¯å¯¹åº•å±‚å…±äº«å­˜å‚¨ï¼ˆå¦‚NFS, Ceph, AWS EBS, Google Persistent Diskç­‰ï¼‰çš„ä¸€ç§æŠ½è±¡å®šä¹‰ã€‚</li><li><strong>ä½œç”¨</strong>ï¼š <strong>æä¾›å­˜å‚¨</strong>ã€‚PVæ˜¯æœ‰å®é™…å­˜å‚¨ä»‹è´¨backingçš„ã€‚</li><li><strong>å…³é”®é…ç½®</strong>ï¼š å®šä¹‰å­˜å‚¨å®¹é‡ï¼ˆ<code>capacity</code>ï¼‰ã€è®¿é—®æ¨¡å¼ï¼ˆ<code>accessModes</code>ï¼Œå¦‚ReadWriteOnce, ReadOnlyManyç­‰ï¼‰å’Œå­˜å‚¨ç±»å‹ï¼ˆ<code>storageClassName</code>ï¼‰ã€‚</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolume</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-manual-pv</span>  <span class="hljs-comment"># PVçš„åå­—</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">capacity:</span><br>    <span class="hljs-attr">storage:</span> <span class="hljs-string">10Gi</span>  <span class="hljs-comment"># å­˜å‚¨å¤§å°</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteOnce</span>  <span class="hljs-comment"># è®¿é—®æ¨¡å¼ï¼šå…è®¸å•ä¸ªèŠ‚ç‚¹è¯»å†™</span><br>  <span class="hljs-attr">persistentVolumeReclaimPolicy:</span> <span class="hljs-string">Retain</span>  <span class="hljs-comment"># å›æ”¶ç­–ç•¥ï¼šåˆ é™¤PVCåï¼ŒPVä¿ç•™æ•°æ®å’Œæœ¬èº«</span><br>  <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">slow</span>  <span class="hljs-comment"># å±äºå“ªä¸ªStorageClassï¼ˆå¯é€‰ï¼‰</span><br>  <span class="hljs-attr">nfs:</span>  <span class="hljs-comment"># å…·ä½“çš„åç«¯å­˜å‚¨ç±»å‹å’Œé…ç½®</span><br>    <span class="hljs-attr">path:</span> <span class="hljs-string">/tmp</span><br>    <span class="hljs-attr">server:</span> <span class="hljs-number">172.17</span><span class="hljs-number">.0</span><span class="hljs-number">.2</span><br></code></pre></td></tr></table></figure><h4 id="2-PVC-PersistentVolumeClaim-æŒä¹…åŒ–å·å£°æ˜"><a href="#2-PVC-PersistentVolumeClaim-æŒä¹…åŒ–å·å£°æ˜" class="headerlink" title="2. PVC (PersistentVolumeClaim) - æŒä¹…åŒ–å·å£°æ˜"></a>2. PVC (PersistentVolumeClaim) - æŒä¹…åŒ–å·å£°æ˜</h4><ul><li><strong>æ˜¯ä»€ä¹ˆ</strong>ï¼š ç”¨æˆ·ï¼ˆæˆ–Podï¼‰å¯¹å­˜å‚¨çš„<strong>ä¸€ä¸ªè¯·æ±‚</strong>æˆ–<strong>å£°æ˜</strong>ã€‚å®ƒæ˜¯Namespaceçº§åˆ«çš„èµ„æºã€‚å®ƒå°±åƒä¸€ä¸ªâ€œæè´§å•â€ã€‚</li><li><strong>ä½œç”¨</strong>ï¼š <strong>ç”³è¯·å’Œä½¿ç”¨å­˜å‚¨</strong>ã€‚Podä¸ç›´æ¥ä½¿ç”¨PVï¼Œè€Œæ˜¯é€šè¿‡PVCæ¥ç”³è¯·åˆé€‚çš„å­˜å‚¨èµ„æºã€‚PVCè®©ç”¨æˆ·æ— éœ€å…³å¿ƒåº•å±‚å­˜å‚¨çš„å…·ä½“å®ç°ç»†èŠ‚ã€‚</li><li><strong>å…³é”®é…ç½®</strong>ï¼š ç”³è¯·å­˜å‚¨çš„å¤§å°ï¼ˆ<code>resources.requests.storage</code>ï¼‰ã€è®¿é—®æ¨¡å¼ï¼ˆ<code>accessModes</code>ï¼‰å’Œé€šè¿‡<code>storageClassName</code>æ¥æŒ‡å®šå‘å“ªä¸ªStorageClassç”³è¯·ã€‚</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-pvc</span>  <span class="hljs-comment"># PVCçš„åå­—</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteOnce</span><br>  <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">slow</span>  <span class="hljs-comment"># æŒ‡åéœ€è¦ç”±å“ªä¸ªStorageClassæ¥åŠ¨æ€ provisioningï¼ˆå¯é€‰ï¼‰</span><br>  <span class="hljs-attr">resources:</span><br>    <span class="hljs-attr">requests:</span><br>      <span class="hljs-attr">storage:</span> <span class="hljs-string">5Gi</span>  <span class="hljs-comment"># ç”³è¯·5Gç©ºé—´</span><br></code></pre></td></tr></table></figure><h4 id="3-StorageClass-SC-å­˜å‚¨ç±»"><a href="#3-StorageClass-SC-å­˜å‚¨ç±»" class="headerlink" title="3. StorageClass (SC) - å­˜å‚¨ç±»"></a>3. StorageClass (SC) - å­˜å‚¨ç±»</h4><ul><li><strong>æ˜¯ä»€ä¹ˆ</strong>ï¼š å¯¹å­˜å‚¨çš„<strong>æŠ½è±¡åˆ†ç±»</strong>å’Œ<strong>åŠ¨æ€é…ç½®å™¨</strong>ã€‚å®ƒå®šä¹‰äº†â€œä¸€ç±»â€å­˜å‚¨ï¼Œå¹¶æŒ‡å®šäº†ç”¨ä»€ä¹ˆ** Provisioner**ï¼ˆé©±åŠ¨ï¼‰æ¥åŠ¨æ€åˆ›å»ºPVã€‚</li><li><strong>ä½œç”¨</strong>ï¼š **å®ç°å­˜å‚¨çš„åŠ¨æ€ä¾›ç»™(Dynamic Provisioning)**ã€‚ç®¡ç†å‘˜æ— éœ€é¢„å…ˆåˆ›å»ºä¸€å †PVç­‰ç€ã€‚å½“ç”¨æˆ·æäº¤ä¸€ä¸ªPVCæ—¶ï¼ŒKubernetesä¼šæ ¹æ®PVCä¸­æŒ‡å®šçš„StorageClassï¼Œè‡ªåŠ¨è°ƒç”¨ç›¸åº”çš„é©±åŠ¨å»åˆ›å»ºåˆé€‚çš„PVã€‚</li><li><strong>å…³é”®é…ç½®</strong>ï¼š Provisionerï¼ˆä¾›åº”å•†é©±åŠ¨ï¼Œå¦‚ <code>kubernetes.io/aws-ebs</code>ï¼‰ã€å‚æ•°ï¼ˆ<code>parameters</code>ï¼Œå¦‚ç£ç›˜ç±»å‹ã€åŒºåŸŸç­‰ï¼‰ã€‚</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">storage.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StorageClass</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fast-ssd</span>  <span class="hljs-comment"># StorageClassçš„åå­—ï¼ŒPVCé€šè¿‡è¿™ä¸ªåå­—æ¥æŒ‡å‘å®ƒ</span><br><span class="hljs-attr">provisioner:</span> <span class="hljs-string">kubernetes.io/aws-ebs</span>  <span class="hljs-comment"># ä½¿ç”¨çš„é©±åŠ¨</span><br><span class="hljs-attr">parameters:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">gp3</span>  <span class="hljs-comment"># å‚æ•°ï¼šè¦æ±‚åˆ›å»ºgp3ç±»å‹çš„EBSå·</span><br>  <span class="hljs-attr">fsType:</span> <span class="hljs-string">ext4</span><br></code></pre></td></tr></table></figure><hr><h3 id="ä¸ºä»€ä¹ˆKubernetesè¦è¿™æ ·è®¾è®¡ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆKubernetesè¦è¿™æ ·è®¾è®¡ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆKubernetesè¦è¿™æ ·è®¾è®¡ï¼Ÿ"></a>ä¸ºä»€ä¹ˆKubernetesè¦è¿™æ ·è®¾è®¡ï¼Ÿ</h3><p>è¿™ç§è®¾è®¡ï¼ˆPVC&#x2F;PV&#x2F;StorageClassï¼‰è§£å†³äº†ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š</p><ol><li><p><strong>è§£è€¦ä¸åº”ç”¨å’Œå­˜å‚¨</strong>ï¼š</p><ul><li><strong>å¼€å‘äººå‘˜</strong>ï¼ˆPodçš„å¼€å‘è€…ï¼‰åªéœ€è¦å…³å¿ƒ<strong>éœ€è¦å¤šå¤§çš„å­˜å‚¨</strong>ï¼ˆå†™PVCï¼‰ï¼Œè€Œä¸ç”¨å…³å¿ƒå­˜å‚¨çš„å…·ä½“æŠ€æœ¯ç»†èŠ‚ï¼ˆæ˜¯NFSè¿˜æ˜¯äº‘ç¡¬ç›˜ï¼Ÿæ€§èƒ½å¦‚ä½•ï¼Ÿï¼‰ã€‚</li><li><strong>é›†ç¾¤ç®¡ç†å‘˜</strong>è´Ÿè´£ç®¡ç†å’Œé…ç½®åç«¯çš„å­˜å‚¨ç³»ç»Ÿå’ŒStorageClassï¼Œè€Œä¸ç”¨ä¸ºæ¯ä¸ªåº”ç”¨æ‰‹åŠ¨å»åˆ›å»ºå¯¹åº”çš„PVã€‚</li></ul></li><li><p><strong>èµ„æºçš„çµæ´»æ€§ä¸åŠ¨æ€æ€§</strong>ï¼š</p><ul><li>**é™æ€ä¾›ç»™(Static Provisioning)**ï¼š ç®¡ç†å‘˜é¢„å…ˆåˆ›å»ºä¸€æ‰¹PVã€‚PVCåªèƒ½åœ¨ç°æœ‰çš„PVæ± é‡Œå¯»æ‰¾åŒ¹é…çš„ã€‚å¦‚æœæ‰¾ä¸åˆ°ï¼Œç”³è¯·å°±ä¼š pendingã€‚è¿™ç§æ–¹å¼å¾ˆç¬¨æ‹™ï¼Œå®¹æ˜“é€ æˆèµ„æºæµªè´¹æˆ–ä¸è¶³ã€‚</li><li><strong>åŠ¨æ€ä¾›ç»™(Dynamic Provisioning)<strong>ï¼š <strong>è¿™æ˜¯ç°ä»£K8sé›†ç¾¤çš„æ ‡é…å’Œæ¨èåšæ³•</strong>ã€‚é€šè¿‡StorageClassï¼Œå¯ä»¥å®ç°â€œæŒ‰éœ€åˆ†é…â€ã€‚ç”¨æˆ·æäº¤PVC -&gt; K8sçœ‹åˆ°æ²¡æœ‰ç°æˆçš„PVèƒ½åŒ¹é… -&gt; è°ƒç”¨SCåˆ›å»ºæ–°çš„PV -&gt; PVCè‡ªåŠ¨ç»‘å®šåˆ°æ–°PVã€‚</strong>æå¤§æé«˜äº†è‡ªåŠ¨åŒ–ç¨‹åº¦å’Œèµ„æºåˆ©ç”¨ç‡</strong>ã€‚</li></ul></li><li><p><strong>æ”¯æŒå¤šç§å­˜å‚¨åç«¯</strong>ï¼š<br>é€šè¿‡ä¸åŒçš„Provisionerï¼ŒKuberneteså¯ä»¥æ— ç¼åœ°æ¥å…¥å„ç§å„æ ·ã€æ¥è‡ªä¸åŒä¾›åº”å•†çš„å­˜å‚¨ç³»ç»Ÿï¼ˆå…¬æœ‰äº‘ã€ç§æœ‰äº‘ã€æœ¬åœ°å­˜å‚¨ç­‰ï¼‰ï¼Œä¸ºç”¨æˆ·æä¾›ç»Ÿä¸€çš„å­˜å‚¨ä½¿ç”¨ä½“éªŒã€‚</p></li></ol><h3 id="å·¥ä½œæµç¨‹æ€»ç»“"><a href="#å·¥ä½œæµç¨‹æ€»ç»“" class="headerlink" title="å·¥ä½œæµç¨‹æ€»ç»“"></a>å·¥ä½œæµç¨‹æ€»ç»“</h3><p>ä¸‹å›¾æ¸…æ™°åœ°å±•ç¤ºäº†ä¸‰è€…ä¹‹é—´çš„å…³ç³»ä¸ä¸¤ç§ä¾›ç»™æ–¹å¼çš„å·¥ä½œæµç¨‹ï¼š</p><p><img src="/2025/08/22/PVC-StorageClass-PV%E5%8E%9F%E7%90%86%E8%A7%A3%E8%AF%BB/deepseek_mermaid_20250822_b867d7.png" alt="deepseek_mermaid_20250822_b867d7"></p><h3 id="å¦‚ä½•è®°ä½å’Œä½¿ç”¨ï¼Ÿ"><a href="#å¦‚ä½•è®°ä½å’Œä½¿ç”¨ï¼Ÿ" class="headerlink" title="å¦‚ä½•è®°ä½å’Œä½¿ç”¨ï¼Ÿ"></a>å¦‚ä½•è®°ä½å’Œä½¿ç”¨ï¼Ÿ</h3><ul><li><strong>ä½œä¸ºä½¿ç”¨è€…ï¼ˆå¼€å‘è€…ï¼‰</strong>ï¼šä½ 99%çš„æƒ…å†µåªéœ€è¦å’Œ<strong>PVC</strong>æ‰“äº¤é“ã€‚åœ¨ä½ çš„Deploymentçš„Podæ¨¡æ¿ä¸­ï¼Œå®šä¹‰<code>volumes</code>æ—¶å¼•ç”¨çš„æ˜¯<strong>PVCçš„åå­—</strong>ã€‚<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">volumes:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app-storage</span><br>    <span class="hljs-attr">persistentVolumeClaim:</span><br>      <span class="hljs-attr">claimName:</span> <span class="hljs-string">my-pvc</span>  <span class="hljs-comment"># ä½ ä¸Šé¢åˆ›å»ºçš„PVCçš„åå­—</span><br></code></pre></td></tr></table></figure></li><li><strong>ä½œä¸ºç®¡ç†å‘˜</strong>ï¼šä½ éœ€è¦æ ¹æ®å…¬å¸çš„å­˜å‚¨åŸºç¡€è®¾æ–½ï¼Œåˆ›å»ºå’Œç»´æŠ¤åˆé€‚çš„<strong>StorageClass</strong>ã€‚å¯¹äºç®€å•çš„æµ‹è¯•ç¯å¢ƒï¼ˆå¦‚minikubeï¼‰ï¼Œé€šå¸¸å·²ç»æœ‰ä¸€ä¸ªé»˜è®¤çš„StorageClassã€‚</li></ul><p>å¸Œæœ›è¿™ä¸ªè§£é‡Šèƒ½å¸®ä½ å½»åº•ç†è§£è¿™ä¸‰ä¸ªæ¦‚å¿µï¼è¿™æ˜¯æŒæ¡KubernetesæŒä¹…åŒ–å­˜å‚¨éå¸¸é‡è¦çš„ä¸€æ­¥ã€‚ç¥ä½ å­¦ä¹ é¡ºåˆ©ï¼</p><h1 id="Kubernetes-æŒä¹…åŒ–å­˜å‚¨å®æˆ˜ï¼šNFS-åŠ¨æ€ä¾›ç»™ç¤ºä¾‹"><a href="#Kubernetes-æŒä¹…åŒ–å­˜å‚¨å®æˆ˜ï¼šNFS-åŠ¨æ€ä¾›ç»™ç¤ºä¾‹" class="headerlink" title="Kubernetes æŒä¹…åŒ–å­˜å‚¨å®æˆ˜ï¼šNFS åŠ¨æ€ä¾›ç»™ç¤ºä¾‹"></a>Kubernetes æŒä¹…åŒ–å­˜å‚¨å®æˆ˜ï¼šNFS åŠ¨æ€ä¾›ç»™ç¤ºä¾‹</h1><p>æˆ‘ç†è§£ä½ å¸Œæœ›åœ¨ç†è§£PVCã€PVå’ŒStorageClassçš„åŸºæœ¬æ¦‚å¿µåï¼Œé€šè¿‡ä¸€ä¸ªå…·ä½“çš„å®æˆ˜ä¾‹å­æ¥åŠ æ·±ç†è§£ã€‚ä¸‹é¢æˆ‘å°†ä»¥ä¸€ä¸ªåŸºäº<strong>NFSå­˜å‚¨</strong>çš„<strong>åŠ¨æ€å­˜å‚¨é…ç½®</strong>ä¸ºä¾‹ï¼Œè¯¦ç»†å±•ç¤ºå¦‚ä½•åœ¨å®é™…çš„Kubernetesé›†ç¾¤ä¸­åˆ›å»ºå’Œä½¿ç”¨è¿™äº›èµ„æºã€‚</p><p>è¿™ä¸ªä¾‹å­ä¼šä½¿ç”¨NFSä½œä¸ºåç«¯å­˜å‚¨ï¼Œå¹¶éƒ¨ç½²ä¸€ä¸ªNFS Client Provisioneræ¥åŠ¨æ€åˆ›å»ºPVã€‚ä¹‹åï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ªPVCæ¥ç”³è¯·å­˜å‚¨ï¼Œæœ€ååœ¨ä¸€ä¸ªPodä¸­ä½¿ç”¨è¿™ä¸ªPVCã€‚</p><h1 id="ğŸš€-Kubernetes-æŒä¹…åŒ–å­˜å‚¨å®æˆ˜ï¼šNFS-åŠ¨æ€ä¾›ç»™ç¤ºä¾‹"><a href="#ğŸš€-Kubernetes-æŒä¹…åŒ–å­˜å‚¨å®æˆ˜ï¼šNFS-åŠ¨æ€ä¾›ç»™ç¤ºä¾‹" class="headerlink" title="ğŸš€ Kubernetes æŒä¹…åŒ–å­˜å‚¨å®æˆ˜ï¼šNFS åŠ¨æ€ä¾›ç»™ç¤ºä¾‹"></a>ğŸš€ Kubernetes æŒä¹…åŒ–å­˜å‚¨å®æˆ˜ï¼šNFS åŠ¨æ€ä¾›ç»™ç¤ºä¾‹</h1><p>ä¸ºäº†è®©åˆšæ‰è®¨è®ºçš„å­˜å‚¨æ¦‚å¿µæ›´åŠ å…·ä½“ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªåŸºäºNFSï¼ˆNetwork File Systemï¼‰çš„<strong>åŠ¨æ€å­˜å‚¨é…ç½®å®æˆ˜ä¾‹å­</strong>ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä¼šï¼š</p><ol><li><strong>æ­å»ºNFSæœåŠ¡å™¨</strong>ï¼ˆå‡è®¾è¿˜æ²¡æœ‰ï¼‰</li><li><strong>éƒ¨ç½²NFS Client Provisioner</strong>ï¼ˆè´Ÿè´£åŠ¨æ€åˆ›å»ºPVï¼‰</li><li><strong>åˆ›å»ºStorageClass</strong></li><li><strong>åˆ›å»ºPVCå¹¶éªŒè¯åŠ¨æ€åˆ›å»ºPV</strong></li><li><strong>åœ¨Podä¸­ä½¿ç”¨PVC</strong></li></ol><h2 id="å‡†å¤‡å·¥ä½œï¼šå‡†å¤‡NFSæœåŠ¡å™¨"><a href="#å‡†å¤‡å·¥ä½œï¼šå‡†å¤‡NFSæœåŠ¡å™¨" class="headerlink" title="å‡†å¤‡å·¥ä½œï¼šå‡†å¤‡NFSæœåŠ¡å™¨"></a>å‡†å¤‡å·¥ä½œï¼šå‡†å¤‡NFSæœåŠ¡å™¨</h2><p>é¦–å…ˆï¼Œä½ éœ€è¦ä¸€ä¸ªNFSæœåŠ¡å™¨ã€‚å¦‚æœä½ è¿˜æ²¡æœ‰ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªLinuxèŠ‚ç‚¹ï¼ˆå¯ä»¥æ˜¯Kubernetesé›†ç¾¤ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤–éƒ¨èŠ‚ç‚¹ï¼‰ä¸Šå¿«é€Ÿæ­å»ºï¼š</p><ol><li><p><strong>å®‰è£…NFSæœåŠ¡å™¨</strong>ï¼ˆåœ¨NFSæœåŠ¡å™¨èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> apt-get update &amp;&amp; <span class="hljs-built_in">sudo</span> apt-get install -y nfs-kernel-server <span class="hljs-comment"># å¯¹äºUbuntu/Debian</span><br><span class="hljs-comment"># æˆ–è€…</span><br><span class="hljs-comment"># sudo yum install -y nfs-utils nfs-utils-lib # å¯¹äºCentOS/RHEL</span><br></code></pre></td></tr></table></figure></li><li><p><strong>åˆ›å»ºå…±äº«ç›®å½•å¹¶é…ç½®å¯¼å‡º</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">mkdir</span> -p /srv/nfs/k8s-pv  <span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªå…±äº«ç›®å½•</span><br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">chown</span> nobody:nogroup /srv/nfs/k8s-pv  <span class="hljs-comment"># ä¿®æ”¹ç›®å½•æ‰€æœ‰æƒï¼Œæ ¹æ®NFSé…ç½®å¯èƒ½éœ€è¦</span><br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">chmod</span> 777 /srv/nfs/k8s-pv  <span class="hljs-comment"># ä¸ºäº†ç¤ºä¾‹ç®€å•ï¼Œè®¾ç½®å®½æ¾çš„æƒé™</span><br></code></pre></td></tr></table></figure><p>ç¼–è¾‘ <code>/etc/exports</code> æ–‡ä»¶ï¼Œæ·»åŠ ä»¥ä¸‹è¡Œï¼ˆè¯·æ ¹æ®ä½ çš„ç½‘ç»œæƒ…å†µè°ƒæ•´ç½‘æ®µï¼‰ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/srv/</span>nfs<span class="hljs-regexp">/k8s-pv 192.168.100.0/</span><span class="hljs-number">24</span>(rw,sync,no_subtree_check,no_root_squash)<br></code></pre></td></tr></table></figure><p>ä¿å­˜åï¼Œå¯¼å‡ºé…ç½®ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> exportfs -a<br><span class="hljs-built_in">sudo</span> systemctl restart nfs-kernel-server<br><span class="hljs-built_in">sudo</span> systemctl <span class="hljs-built_in">enable</span> nfs-kernel-server<br></code></pre></td></tr></table></figure></li><li><p><strong>ï¼ˆå¯é€‰ï¼‰åœ¨Kubernetesé›†ç¾¤èŠ‚ç‚¹ä¸Šå®‰è£…NFSå®¢æˆ·ç«¯</strong>ï¼š<br>é€šå¸¸ï¼ŒKubernetesèŠ‚ç‚¹å·²ç»å®‰è£…äº†NFSå®¢æˆ·ç«¯æ”¯æŒã€‚å¦‚æœæ²¡æœ‰ï¼Œä½ å¯èƒ½éœ€è¦å®‰è£… <code>nfs-common</code> (Ubuntu&#x2F;Debian) æˆ– <code>nfs-utils</code> (CentOS&#x2F;RHEL)ã€‚</p></li></ol><h2 id="æ­¥éª¤ä¸€ï¼šéƒ¨ç½²NFS-Client-Provisioner"><a href="#æ­¥éª¤ä¸€ï¼šéƒ¨ç½²NFS-Client-Provisioner" class="headerlink" title="æ­¥éª¤ä¸€ï¼šéƒ¨ç½²NFS Client Provisioner"></a>æ­¥éª¤ä¸€ï¼šéƒ¨ç½²NFS Client Provisioner</h2><p>NFSæœ¬èº«ä¸æ”¯æŒåŠ¨æ€ä¾›ç»™ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå«åš <strong>NFS Client Provisioner</strong> çš„æ§åˆ¶å™¨ï¼Œå®ƒå¯ä»¥æ ¹æ®PVCçš„è¯·æ±‚ï¼Œè‡ªåŠ¨åœ¨NFSæœåŠ¡å™¨ä¸Šåˆ›å»ºç›®å½•å¹¶ç”Ÿæˆå¯¹åº”çš„PVã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸ºProvisioneråˆ›å»ºRBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰èµ„æºï¼Œå› ä¸ºå®ƒéœ€è¦åœ¨é›†ç¾¤ä¸­åˆ›å»ºPVç­‰èµ„æºã€‚</p><h3 id="1-åˆ›å»ºRBACæˆæƒ"><a href="#1-åˆ›å»ºRBACæˆæƒ" class="headerlink" title="1. åˆ›å»ºRBACæˆæƒ"></a>1. åˆ›å»ºRBACæˆæƒ</h3><p>å°†ä»¥ä¸‹å†…å®¹ä¿å­˜ä¸º <code>nfs-rbac.yaml</code> æ–‡ä»¶ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nfs-client-provisioner</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span> <span class="hljs-comment"># é€šå¸¸éƒ¨ç½²åœ¨defaultå‘½åç©ºé—´ï¼Œå¯æ ¹æ®éœ€è¦ä¿®æ”¹</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nfs-client-provisioner-runner</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]<br>    <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;persistentvolumes&quot;</span>]<br>    <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>, <span class="hljs-string">&quot;create&quot;</span>, <span class="hljs-string">&quot;delete&quot;</span>]<br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]<br>    <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;persistentvolumeclaims&quot;</span>]<br>    <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>]<br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;storage.k8s.io&quot;</span>]<br>    <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;storageclasses&quot;</span>]<br>    <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>]<br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]<br>    <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;events&quot;</span>]<br>    <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;create&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>, <span class="hljs-string">&quot;patch&quot;</span>]<br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]<br>    <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;endpoints&quot;</span>]<br>    <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>, <span class="hljs-string">&quot;create&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>, <span class="hljs-string">&quot;patch&quot;</span>]<br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">run-nfs-client-provisioner</span><br><span class="hljs-attr">subjects:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">nfs-client-provisioner</span><br>    <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nfs-client-provisioner-runner</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br><span class="hljs-meta">---</span><br><span class="hljs-comment"># å¦‚æœéœ€è¦Leaderé€‰ä¸¾ï¼Œå¯èƒ½è¿˜éœ€è¦ä¸€ä¸ªRoleå’ŒRoleBinding</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Role</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">leader-locking-nfs-client-provisioner</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]<br>    <span class="hljs-attr">resources:</span> [<span class="hljs-string">&quot;endpoints&quot;</span>]<br>    <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;create&quot;</span>, <span class="hljs-string">&quot;update&quot;</span>, <span class="hljs-string">&quot;patch&quot;</span>]<br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">RoleBinding</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">leader-locking-nfs-client-provisioner</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">subjects:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">nfs-client-provisioner</span><br>    <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">Role</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">leader-locking-nfs-client-provisioner</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br></code></pre></td></tr></table></figure><p>åº”ç”¨RBACé…ç½®ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl apply -f nfs-rbac.yaml<br></code></pre></td></tr></table></figure><h3 id="2-éƒ¨ç½²NFS-Client-Provisioner"><a href="#2-éƒ¨ç½²NFS-Client-Provisioner" class="headerlink" title="2. éƒ¨ç½²NFS Client Provisioner"></a>2. éƒ¨ç½²NFS Client Provisioner</h3><p>å°†ä»¥ä¸‹å†…å®¹ä¿å­˜ä¸º <code>nfs-provisioner-deployment.yaml</code> æ–‡ä»¶ã€‚<strong>è¯·åŠ¡å¿…å°† <code>192.168.100.200</code> æ›¿æ¢ä¸ºä½ å®é™…çš„NFSæœåŠ¡å™¨IPåœ°å€ï¼Œå°† <code>/srv/nfs/k8s-pv</code> æ›¿æ¢ä¸ºä½ å®é™…çš„NFSå…±äº«è·¯å¾„ã€‚</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nfs-client-provisioner</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nfs-client-provisioner</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">strategy:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">Recreate</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nfs-client-provisioner</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nfs-client-provisioner</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">nfs-client-provisioner</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nfs-client-provisioner</span><br>          <span class="hljs-comment"># ä¸€ä¸ªå¸¸ç”¨çš„NFS Client Provisioneré•œåƒ</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">chronolaw/nfs-subdir-external-provisioner:v4.0.2</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nfs-client-root</span><br>              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/persistentvolumes</span><br>          <span class="hljs-attr">env:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">PROVISIONER_NAME</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">nfs-storage</span> <span class="hljs-comment"># åˆ†é…å™¨çš„åç§°ï¼Œåç»­åˆ›å»ºStorageClassæ—¶ä¼šç”¨åˆ°</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">NFS_SERVER</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.100</span><span class="hljs-number">.200</span> <span class="hljs-comment"># è¯·ä¿®æ”¹ä¸ºä½ çš„NFSæœåŠ¡å™¨IP</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">NFS_PATH</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">/srv/nfs/k8s-pv</span> <span class="hljs-comment"># è¯·ä¿®æ”¹ä¸ºä½ çš„NFSå…±äº«ç›®å½•</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nfs-client-root</span><br>          <span class="hljs-attr">nfs:</span><br>            <span class="hljs-attr">server:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.100</span><span class="hljs-number">.200</span> <span class="hljs-comment"># è¯·ä¿®æ”¹ä¸ºä½ çš„NFSæœåŠ¡å™¨IP</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/srv/nfs/k8s-pv</span> <span class="hljs-comment"># è¯·ä¿®æ”¹ä¸ºä½ çš„NFSå…±äº«ç›®å½•</span><br></code></pre></td></tr></table></figure><p>åº”ç”¨Deploymenté…ç½®ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl apply -f nfs-provisioner-deployment.yaml<br></code></pre></td></tr></table></figure><p>éªŒè¯Provisioner Podæ˜¯å¦è¿è¡ŒæˆåŠŸï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl get pods -l app=nfs-client-provisioner<br></code></pre></td></tr></table></figure><h2 id="æ­¥éª¤äºŒï¼šåˆ›å»ºStorageClass"><a href="#æ­¥éª¤äºŒï¼šåˆ›å»ºStorageClass" class="headerlink" title="æ­¥éª¤äºŒï¼šåˆ›å»ºStorageClass"></a>æ­¥éª¤äºŒï¼šåˆ›å»ºStorageClass</h2><p>ç°åœ¨æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªStorageClassï¼Œå®ƒæŒ‡å®šä½¿ç”¨æˆ‘ä»¬åˆšéƒ¨ç½²çš„NFS Provisionerã€‚</p><p>å°†ä»¥ä¸‹å†…å®¹ä¿å­˜ä¸º <code>nfs-storageclass.yaml</code> æ–‡ä»¶ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">storage.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StorageClass</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nfs-client</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-comment"># ï¼ˆå¯é€‰ï¼‰å°†å…¶è®¾ç½®ä¸ºé»˜è®¤StorageClass</span><br>    <span class="hljs-comment"># storageclass.kubernetes.io/is-default-class: &quot;true&quot;</span><br><span class="hljs-attr">provisioner:</span> <span class="hljs-string">nfs-storage</span> <span class="hljs-comment"># å¿…é¡»ä¸ä¸Šé¢Deploymentä¸­PROVISIONER_NAMEçš„å€¼ä¸€è‡´</span><br><span class="hljs-attr">parameters:</span><br>  <span class="hljs-attr">archiveOnDelete:</span> <span class="hljs-string">&quot;false&quot;</span> <span class="hljs-comment"># è®¾ç½®ä¸º&quot;false&quot;æ—¶ï¼Œåˆ é™¤PVCæ—¶ä¼šåŒæ—¶åˆ é™¤PVä¸­çš„æ•°æ®ï¼›&quot;true&quot;åˆ™ä¼šå½’æ¡£ï¼ˆé‡å‘½åç›®å½•ï¼‰</span><br><span class="hljs-attr">allowVolumeExpansion:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># å…è®¸åç»­æ‰©å®¹PVC</span><br><span class="hljs-attr">reclaimPolicy:</span> <span class="hljs-string">Delete</span> <span class="hljs-comment"># å›æ”¶ç­–ç•¥ï¼ŒDelete æˆ– Retainã€‚å¦‚æœè®¾ç½®ä¸ºRetainï¼Œåˆ é™¤PVCåPVä¼šä¿ç•™ï¼Œæ•°æ®éœ€è¦æ‰‹åŠ¨æ¸…ç†</span><br><span class="hljs-attr">volumeBindingMode:</span> <span class="hljs-string">Immediate</span><br></code></pre></td></tr></table></figure><p>åº”ç”¨StorageClassé…ç½®ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl apply -f nfs-storageclass.yaml<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹åˆ›å»ºçš„StorageClassï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl get storageclass<br></code></pre></td></tr></table></figure><p><strong>ï¼ˆå¯é€‰ï¼‰å¦‚æœä½ æƒ³å°†å…¶è®¾ä¸ºé»˜è®¤StorageClassï¼Œå¯ä»¥å…ˆå–æ¶ˆç°æœ‰é»˜è®¤StorageClassçš„é»˜è®¤è®¾ç½®ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œç„¶åå†è®¾ç½®æ–°çš„ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å–æ¶ˆç°æœ‰çš„é»˜è®¤StorageClassï¼ˆå°†ç°æœ‰çš„é»˜è®¤StorageClassåç§°æ›¿æ¢&lt;existing-default-sc-name&gt;ï¼‰</span><br>kubectl patch storageclass &lt;existing-default-sc-name&gt; -p <span class="hljs-string">&#x27;&#123;&quot;metadata&quot;: &#123;&quot;annotations&quot;:&#123;&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;false&quot;&#125;&#125;&#125;&#x27;</span><br><span class="hljs-comment"># å°†nfs-clientè®¾ç½®ä¸ºé»˜è®¤</span><br>kubectl patch storageclass nfs-client -p <span class="hljs-string">&#x27;&#123;&quot;metadata&quot;: &#123;&quot;annotations&quot;:&#123;&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;true&quot;&#125;&#125;&#125;&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="æ­¥éª¤ä¸‰ï¼šåˆ›å»ºPVCå¹¶éªŒè¯åŠ¨æ€PVåˆ›å»º"><a href="#æ­¥éª¤ä¸‰ï¼šåˆ›å»ºPVCå¹¶éªŒè¯åŠ¨æ€PVåˆ›å»º" class="headerlink" title="æ­¥éª¤ä¸‰ï¼šåˆ›å»ºPVCå¹¶éªŒè¯åŠ¨æ€PVåˆ›å»º"></a>æ­¥éª¤ä¸‰ï¼šåˆ›å»ºPVCå¹¶éªŒè¯åŠ¨æ€PVåˆ›å»º</h2><p>ç°åœ¨ï¼Œå½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªPVCå¹¶æŒ‡å®š <code>storageClassName: nfs-client</code> æ—¶ï¼ŒNFS Provisionerå°±ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªPVå¹¶ä¸è¯¥PVCç»‘å®šã€‚</p><h3 id="1-åˆ›å»ºPVC"><a href="#1-åˆ›å»ºPVC" class="headerlink" title="1. åˆ›å»ºPVC"></a>1. åˆ›å»ºPVC</h3><p>å°†ä»¥ä¸‹å†…å®¹ä¿å­˜ä¸º <code>test-pvc.yaml</code> æ–‡ä»¶ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">test-pvc</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">nfs-client</span> <span class="hljs-comment"># ä¸ä¸Šé¢åˆ›å»ºçš„StorageClassåç§°ä¸€è‡´</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteOnce</span> <span class="hljs-comment"># æ ¹æ®ä½ çš„éœ€æ±‚é€‰æ‹©è®¿é—®æ¨¡å¼ï¼ŒNFSé€šå¸¸ä¹Ÿæ”¯æŒReadWriteMany</span><br>  <span class="hljs-attr">resources:</span><br>    <span class="hljs-attr">requests:</span><br>      <span class="hljs-attr">storage:</span> <span class="hljs-string">1Gi</span> <span class="hljs-comment"># è¯·æ±‚1GiBçš„å­˜å‚¨ç©ºé—´</span><br></code></pre></td></tr></table></figure><p>åº”ç”¨PVCé…ç½®ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl apply -f test-pvc.yaml<br></code></pre></td></tr></table></figure><h3 id="2-éªŒè¯PVCå’ŒPV"><a href="#2-éªŒè¯PVCå’ŒPV" class="headerlink" title="2. éªŒè¯PVCå’ŒPV"></a>2. éªŒè¯PVCå’ŒPV</h3><p>æ£€æŸ¥PVCçŠ¶æ€ï¼Œåº”æ˜¾ç¤ºä¸º <code>Bound</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl get pvc test-pvc<br></code></pre></td></tr></table></figure><p>åŒæ—¶ï¼Œæ£€æŸ¥è‡ªåŠ¨åˆ›å»ºçš„PVï¼ŒçŠ¶æ€ä¹Ÿåº”ä¸º <code>Bound</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl get pv<br></code></pre></td></tr></table></figure><p>ä½ åº”è¯¥èƒ½çœ‹åˆ°ä¸€ä¸ªPVæ˜¯ç”± <code>nfs-client</code> StorageClassåŠ¨æ€åˆ›å»ºçš„ï¼Œå¹¶è‡ªåŠ¨ç»‘å®šåˆ°äº† <code>test-pvc</code> PVCã€‚</p><h2 id="æ­¥éª¤å››ï¼šåœ¨Podä¸­ä½¿ç”¨PVC"><a href="#æ­¥éª¤å››ï¼šåœ¨Podä¸­ä½¿ç”¨PVC" class="headerlink" title="æ­¥éª¤å››ï¼šåœ¨Podä¸­ä½¿ç”¨PVC"></a>æ­¥éª¤å››ï¼šåœ¨Podä¸­ä½¿ç”¨PVC</h2><p>æœ€åï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªPodæ¥ä½¿ç”¨è¿™ä¸ªPVCã€‚</p><p>å°†ä»¥ä¸‹å†…å®¹ä¿å­˜ä¸º <code>test-pod.yaml</code> æ–‡ä»¶ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">test-pod</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">busybox</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">busybox</span><br>    <span class="hljs-attr">command:</span> [<span class="hljs-string">&#x27;sh&#x27;</span>, <span class="hljs-string">&#x27;-c&#x27;</span>, <span class="hljs-string">&#x27;echo &quot;Hello Kubernetes Storage!&quot; &gt; /mnt/data/file.txt &amp;&amp; sleep 3600&#x27;</span>]<br>    <span class="hljs-attr">volumeMounts:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">persistent-storage</span><br>      <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/mnt/data</span><br>  <span class="hljs-attr">volumes:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">persistent-storage</span><br>    <span class="hljs-attr">persistentVolumeClaim:</span><br>      <span class="hljs-attr">claimName:</span> <span class="hljs-string">test-pvc</span> <span class="hljs-comment"># ä½¿ç”¨æˆ‘ä»¬åˆšæ‰åˆ›å»ºçš„PVC</span><br></code></pre></td></tr></table></figure><p>åº”ç”¨Podé…ç½®ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl apply -f test-pod.yaml<br></code></pre></td></tr></table></figure><p>æ£€æŸ¥Podæ˜¯å¦è¿è¡ŒæˆåŠŸï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl get pod test-pod<br></code></pre></td></tr></table></figure><p>éªŒè¯æ•°æ®æ˜¯å¦æˆåŠŸå†™å…¥NFSæœåŠ¡å™¨ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ£€æŸ¥Podæ—¥å¿—ï¼Œåº”è¯¥èƒ½çœ‹åˆ°å‘½ä»¤æ‰§è¡ŒæˆåŠŸ</span><br>kubectl logs test-pod<br><span class="hljs-comment"># ç°åœ¨ä½ å¯ä»¥åˆ°ä½ çš„NFSæœåŠ¡å™¨ä¸ŠæŸ¥çœ‹å…±äº«ç›®å½• /srv/nfs/k8s-pv</span><br><span class="hljs-comment"># ä½ åº”è¯¥èƒ½çœ‹åˆ°ä¸€ä¸ªä»¥å‘½åç©ºé—´ã€PVCåç§°å’ŒPVåç§°ç»„åˆæ ¼å¼å‘½åçš„ç›®å½•ï¼ˆå…·ä½“æ ¼å¼å–å†³äºprovisionerï¼‰</span><br><span class="hljs-comment"># è¿›å…¥è¯¥ç›®å½•ï¼Œåº”è¯¥èƒ½çœ‹åˆ° file.txt æ–‡ä»¶</span><br><span class="hljs-built_in">ls</span> -la /srv/nfs/k8s-pv/ <span class="hljs-comment"># åœ¨NFSæœåŠ¡å™¨ä¸Šæ‰§è¡Œ</span><br></code></pre></td></tr></table></figure><h2 id="æ­¥éª¤äº”ï¼šæ¸…ç†èµ„æºï¼ˆå¯é€‰ï¼‰"><a href="#æ­¥éª¤äº”ï¼šæ¸…ç†èµ„æºï¼ˆå¯é€‰ï¼‰" class="headerlink" title="æ­¥éª¤äº”ï¼šæ¸…ç†èµ„æºï¼ˆå¯é€‰ï¼‰"></a>æ­¥éª¤äº”ï¼šæ¸…ç†èµ„æºï¼ˆå¯é€‰ï¼‰</h2><p>å½“ä½ å®Œæˆæµ‹è¯•åï¼Œå¯ä»¥æŒ‰é¡ºåºåˆ é™¤èµ„æºï¼š</p><ol><li>åˆ é™¤Podï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl delete pod test-pod<br></code></pre></td></tr></table></figure></li><li>åˆ é™¤PVCï¼ˆ<strong>å¦‚æœStorageClassçš„reclaimPolicyæ˜¯Deleteï¼Œåˆ é™¤PVCä¼šè‡ªåŠ¨åˆ é™¤å¯¹åº”çš„PVä»¥åŠNFSæœåŠ¡å™¨ä¸Šçš„æ•°æ®</strong>ï¼‰ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl delete pvc test-pvc<br></code></pre></td></tr></table></figure>æ£€æŸ¥PVæ˜¯å¦ä¹Ÿè¢«è‡ªåŠ¨åˆ é™¤ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl get pv<br></code></pre></td></tr></table></figure></li><li>ï¼ˆå¯é€‰ï¼‰åˆ é™¤StorageClasså’ŒProvisionerï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl delete storageclass nfs-client<br>kubectl delete -f nfs-provisioner-deployment.yaml<br>kubectl delete -f nfs-rbac.yaml<br></code></pre></td></tr></table></figure></li></ol><h2 id="å®æˆ˜å°ç»“ä¸æ³¨æ„äº‹é¡¹"><a href="#å®æˆ˜å°ç»“ä¸æ³¨æ„äº‹é¡¹" class="headerlink" title="å®æˆ˜å°ç»“ä¸æ³¨æ„äº‹é¡¹"></a>å®æˆ˜å°ç»“ä¸æ³¨æ„äº‹é¡¹</h2><p>é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œä½ åº”è¯¥æˆåŠŸå®Œæˆäº†ä¸€ä¸ª<strong>åŠ¨æ€å­˜å‚¨ä¾›ç»™</strong>çš„å®æˆ˜ä¾‹å­ã€‚è¿™ä¸ªè¿‡ç¨‹å±•ç¤ºäº†ï¼š</p><ul><li><strong>StorageClass</strong> å¦‚ä½•ä½œä¸ºå­˜å‚¨çš„â€œè“å›¾â€æˆ–â€œåˆ†ç±»â€ï¼Œå®šä¹‰äº†åŠ¨æ€ä¾›ç»™PVçš„è§„åˆ™å’Œå‚æ•°ã€‚</li><li><strong>PVC</strong> å¦‚ä½•ä½œä¸ºç”¨æˆ·å¯¹å­˜å‚¨çš„è¯·æ±‚ï¼Œåªéœ€å£°æ˜æ‰€éœ€å­˜å‚¨çš„å¤§å°å’Œè®¿é—®æ¨¡å¼ï¼Œè€Œæ— éœ€å…³å¿ƒåç«¯å­˜å‚¨çš„å…·ä½“ç»†èŠ‚ã€‚</li><li>å½“PVCè¢«åˆ›å»ºæ—¶ï¼Œ<strong>Kubernetesä¼šæ ¹æ®PVCæŒ‡å®šçš„StorageClassï¼Œè°ƒç”¨ç›¸åº”çš„Provisionerï¼ˆè¿™é‡Œæ˜¯NFS Client Provisionerï¼‰åŠ¨æ€åœ°åˆ›å»ºPV</strong>ï¼Œå¹¶å®Œæˆç»‘å®šã€‚</li><li><strong>Pod</strong> é€šè¿‡åœ¨å…¶Volumeä¸­å¼•ç”¨PVCåç§°æ¥ä½¿ç”¨æŒä¹…åŒ–å­˜å‚¨ã€‚</li></ul><h3 id="âš ï¸-æ³¨æ„äº‹é¡¹ï¼š"><a href="#âš ï¸-æ³¨æ„äº‹é¡¹ï¼š" class="headerlink" title="âš ï¸ æ³¨æ„äº‹é¡¹ï¼š"></a>âš ï¸ æ³¨æ„äº‹é¡¹ï¼š</h3><ul><li><strong>NFSæ€§èƒ½</strong>ï¼šNFSé€‚ç”¨äºå¤šç§åœºæ™¯ï¼Œä½†å¯¹äºéœ€è¦é«˜æ€§èƒ½IOï¼ˆå¦‚æ•°æ®åº“ï¼‰çš„å·¥ä½œè´Ÿè½½ï¼Œå¯èƒ½éœ€è¦è€ƒè™‘å—å­˜å‚¨ï¼ˆå¦‚äº‘æä¾›å•†æä¾›çš„å—å­˜å‚¨æœåŠ¡ï¼‰ã€‚</li><li><strong>æ•°æ®å®‰å…¨</strong>ï¼šç¤ºä¾‹ä¸­ä¸ºäº†ç®€å•ï¼Œè®¾ç½®äº†å®½æ¾çš„NFSç›®å½•æƒé™ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¯·æ ¹æ®å®‰å…¨æœ€ä½³å®è·µé…ç½®é€‚å½“çš„æƒé™ã€‚</li><li><strong>Reclaim Policy</strong>ï¼šä»”ç»†é€‰æ‹© <code>reclaimPolicy</code>ã€‚<code>Delete</code> æ–¹ä¾¿ä½†å¯èƒ½è¯¯åˆ æ•°æ®ï¼›<code>Retain</code> æ›´å®‰å…¨ï¼Œä½†éœ€è¦æ‰‹åŠ¨ç®¡ç†PVå’Œå­˜å‚¨èµ„æºçš„æ¸…ç†ã€‚</li><li><strong>è®¿é—®æ¨¡å¼</strong>ï¼šæ ¹æ®ä½ çš„åº”ç”¨éœ€æ±‚æ­£ç¡®é€‰æ‹©PVCçš„è®¿é—®æ¨¡å¼ï¼ˆReadWriteOnce, ReadOnlyMany, ReadWriteManyï¼‰ã€‚NFSé€šå¸¸æ”¯æŒReadWriteManyï¼ˆå¤šä¸ªèŠ‚ç‚¹åŒæ—¶è¯»å†™ï¼‰ï¼Œä½†å¹¶éæ‰€æœ‰å­˜å‚¨ç³»ç»Ÿéƒ½æ”¯æŒã€‚</li><li><strong>StorageClassçš„å‘½å</strong>ï¼šç¡®ä¿PVCä¸­å¼•ç”¨çš„ <code>storageClassName</code> ä¸ä½ åˆ›å»ºçš„StorageClassåç§°å®Œå…¨ä¸€è‡´ã€‚</li><li><strong>Provisioneré«˜å¯ç”¨</strong>ï¼šè€ƒè™‘ç”Ÿäº§ç¯å¢ƒä¸­Provisionerçš„é«˜å¯ç”¨æ€§éƒ¨ç½²ã€‚</li></ul><p>è¿™ä¸ªNFSåŠ¨æ€ä¾›ç»™çš„ä¾‹å­æ˜¯å­¦ä¹ å’Œæµ‹è¯•KubernetesæŒä¹…åŒ–å­˜å‚¨çš„è‰¯å¥½èµ·ç‚¹ã€‚åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå„å¤§äº‘å‚å•†ï¼ˆå¦‚AWSã€GCPã€Azureï¼‰é€šå¸¸æä¾›å…¶è‡ªèº«çš„StorageClasså’ŒCSIé©±åŠ¨ï¼Œä½ å¯ä»¥æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©å’Œä½¿ç”¨ã€‚</p><p>å¸Œæœ›è¿™ä¸ªè¯¦ç»†çš„å®æˆ˜ä¾‹å­èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£PVCã€PVå’ŒStorageClassæ˜¯å¦‚ä½•ååŒå·¥ä½œçš„ï¼</p><p>å¦‚æœä½ æƒ³äº†è§£æ›´å¤šå…³äºç‰¹å®šäº‘æä¾›å•†ï¼ˆå¦‚AWS EBS, GCP PD, Azure Diskï¼‰çš„å­˜å‚¨é…ç½®ï¼Œæˆ–è€…StatefulSetä¸­ä½¿ç”¨VolumeClaimTemplatesçš„ä¾‹å­ï¼Œæˆ‘å¯ä»¥è¿›ä¸€æ­¥ä¸ºä½ ä»‹ç»ã€‚</p><h1 id="ä¸ºä»€ä¹ˆè¦è®¾ç½®ä¸€ä¸ªStorageClasså±‚"><a href="#ä¸ºä»€ä¹ˆè¦è®¾ç½®ä¸€ä¸ªStorageClasså±‚" class="headerlink" title="ä¸ºä»€ä¹ˆè¦è®¾ç½®ä¸€ä¸ªStorageClasså±‚"></a>ä¸ºä»€ä¹ˆè¦è®¾ç½®ä¸€ä¸ªStorageClasså±‚</h1><p>è¿™ä¸ªé—®é¢˜é—®å¾—éå¸¸å¥½ï¼Œç›´å‡»äº†Kubernetesè®¾è®¡å“²å­¦çš„æ ¸å¿ƒï¼ä½ çš„è§‚å¯Ÿå¾ˆæ•é”ï¼šä»è¡¨é¢ä¸Šçœ‹ï¼ŒStorageClassç¡®å®åƒä¸€ä¸ªâ€œä¸­é—´äººâ€ï¼Œä½†è¿™æ°æ°æ˜¯Kubernetesä¸ºäº†å®ç°<strong>è§£è€¦</strong>å’Œ<strong>çµæ´»æ€§</strong>è€Œåšå‡ºçš„ç²¾å¦™è®¾è®¡ã€‚</p><p>ä¸ºä»€ä¹ˆä¸è®©PVCç›´æ¥æŒ‡å®šProvisionerï¼Ÿä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒåŸå› ï¼š</p><h3 id="1-æŠ½è±¡ä¸è§£è€¦-Abstraction-Decoupling"><a href="#1-æŠ½è±¡ä¸è§£è€¦-Abstraction-Decoupling" class="headerlink" title="1. æŠ½è±¡ä¸è§£è€¦ (Abstraction &amp; Decoupling)"></a>1. æŠ½è±¡ä¸è§£è€¦ (Abstraction &amp; Decoupling)</h3><p>è¿™æ˜¯æœ€æ ¹æœ¬çš„åŸå› ã€‚Kubernetesçš„è®¾è®¡ç†å¿µæ˜¯è®©<strong>åº”ç”¨å¼€å‘è€…</strong>å’Œ<strong>é›†ç¾¤ç®¡ç†å‘˜</strong>çš„å…³æ³¨ç‚¹åˆ†ç¦»ã€‚</p><ul><li><strong>å¯¹åº”ç”¨å¼€å‘è€…è€Œè¨€</strong>ï¼šä»–ä»¬åªéœ€è¦å…³å¿ƒ<strong>éœ€è¦ä»€ä¹ˆæ ·çš„å­˜å‚¨</strong>ï¼ˆä¾‹å¦‚ï¼šâ€œæˆ‘éœ€è¦10Giçš„é«˜é€ŸSSDå­˜å‚¨â€ï¼‰ï¼Œè€Œä¸éœ€è¦å…³å¿ƒåº•å±‚æ˜¯ç”¨AWS EBSã€Google Persistent Diskã€è¿˜æ˜¯NFSæ¥å®ç°çš„ã€‚ä»–ä»¬æ›´ä¸åº”è¯¥å»é…ç½®Provisionerçš„å…·ä½“å‚æ•°ï¼ˆæ¯”å¦‚ç£ç›˜çš„IOPSã€ç±»å‹ã€åŒºåŸŸç­‰ï¼‰ã€‚<ul><li><strong>PVCæ˜¯é¢å‘å¼€å‘è€…çš„æ¥å£</strong>ï¼Œå®ƒåªå®šä¹‰éœ€æ±‚ï¼ˆå®¹é‡ã€è®¿é—®æ¨¡å¼ã€å­˜å‚¨â€œç±»åˆ«â€ï¼‰ã€‚</li></ul></li><li><strong>å¯¹é›†ç¾¤ç®¡ç†å‘˜è€Œè¨€</strong>ï¼šä»–ä»¬è´Ÿè´£è§„åˆ’å’Œç»´æŠ¤åç«¯çš„å­˜å‚¨åŸºç¡€è®¾æ–½ã€‚ä»–ä»¬å®šä¹‰å¥½ä¸åŒçš„<strong>StorageClass</strong>ï¼ˆæ¯”å¦‚ <code>gold-ssd</code>, <code>silver-hdd</code>, <code>backup-nfs</code>ï¼‰ï¼Œæ¯ä¸ªClassèƒŒåéƒ½é…ç½®å¥½äº†æ­£ç¡®çš„Provisionerå’Œæ‰€æœ‰å¤æ‚çš„å‚æ•°ã€‚<ul><li><strong>StorageClassæ˜¯é¢å‘ç®¡ç†å‘˜çš„æ¥å£</strong>ï¼Œå®ƒå°è£…äº†â€œå¦‚ä½•æä¾›å­˜å‚¨â€çš„å…·ä½“å®ç°ç»†èŠ‚ã€‚</li></ul></li></ul><p><strong>å¦‚æœæ²¡æœ‰StorageClass</strong>ï¼ŒPVCå°±å¾—ç›´æ¥æŒ‡å®šProvisionerï¼ˆæ¯”å¦‚ <code>provisioner: kubernetes.io/aws-ebs</code>ï¼‰ï¼Œè¿™å°±æ„å‘³ç€ï¼š</p><ul><li><strong>åº”ç”¨å’ŒåŸºç¡€è®¾æ–½å¼ºè€¦åˆ</strong>ï¼šä½ çš„åº”ç”¨YAMLæ–‡ä»¶å°±å’Œä½ æ‰€åœ¨çš„äº‘å¹³å°ï¼ˆAWSï¼‰ç»‘æ­»äº†ã€‚å¦‚æœä½ æƒ³æŠŠè¿™ä¸ªåº”ç”¨éƒ¨ç½²åˆ°å¦ä¸€ä¸ªç¯å¢ƒï¼ˆæ¯”å¦‚Azureï¼‰ï¼Œä½ å°±å¿…é¡»ä¿®æ”¹æ‰€æœ‰PVCçš„YAMLæ–‡ä»¶ï¼ŒæŠŠProvisioneræ¢æˆAzureçš„ï¼ˆ<code>kubernetes.io/azure-disk</code>ï¼‰ã€‚</li><li><strong>å¼€å‘è€…éœ€è¦äº†è§£è¿ç»´çŸ¥è¯†</strong>ï¼šå¼€å‘è€…è¢«è¿«è¦å»çŸ¥é“Provisionerçš„åç§°å’Œå‚æ•°ï¼Œè¿™è¿èƒŒäº†å…³æ³¨ç‚¹åˆ†ç¦»çš„åŸåˆ™ã€‚</li></ul><h3 id="2-å‚æ•°åŒ–é…ç½®-Parameterization"><a href="#2-å‚æ•°åŒ–é…ç½®-Parameterization" class="headerlink" title="2. å‚æ•°åŒ–é…ç½® (Parameterization)"></a>2. å‚æ•°åŒ–é…ç½® (Parameterization)</h3><p>ä¸€ä¸ªProvisioneré€šå¸¸æœ‰å¤šç§é…ç½®æ–¹å¼ã€‚ä¾‹å¦‚ï¼ŒAWS EBS Provisionerå¯ä»¥åˆ›å»ºé€šç”¨å‹ï¼ˆgp3ï¼‰ã€é¢„é…ç½®IOPSå‹ï¼ˆio1ï¼‰æˆ–å†·å­˜å‚¨å‹ï¼ˆsc1ï¼‰çš„å·ã€‚</p><p>StorageClassæä¾›äº†ä¸€ä¸ª<strong>å‚æ•°å—</strong>ï¼ˆ<code>parameters</code>ï¼‰æ¥ä¼˜é›…åœ°å¤„ç†è¿™äº›é…ç½®ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># ç®¡ç†å‘˜å¯ä»¥å®šä¹‰å¤šç§StorageClassï¼Œä½¿ç”¨åŒä¸€ä¸ªProvisionerä½†å‚æ•°ä¸åŒ</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">storage.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StorageClass</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fast-ssd</span><br><span class="hljs-attr">provisioner:</span> <span class="hljs-string">kubernetes.io/aws-ebs</span><br><span class="hljs-attr">parameters:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">io1</span> <span class="hljs-comment"># ä½¿ç”¨io1ç±»å‹</span><br>  <span class="hljs-attr">iopsPerGB:</span> <span class="hljs-string">&quot;50&quot;</span> <span class="hljs-comment"># é…ç½®é«˜IOPS</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">storage.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StorageClass</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">standard-ssd</span><br><span class="hljs-attr">provisioner:</span> <span class="hljs-string">kubernetes.io/aws-ebs</span> <span class="hljs-comment"># åŒä¸€ä¸ªProvisioner</span><br><span class="hljs-attr">parameters:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">gp3</span> <span class="hljs-comment"># ä½†ä½¿ç”¨æ›´ç»æµçš„gp3ç±»å‹</span><br>  <span class="hljs-attr">iops:</span> <span class="hljs-string">&quot;3000&quot;</span> <span class="hljs-comment"># é…ç½®å›ºå®šçš„IOPS</span><br></code></pre></td></tr></table></figure><p>å¦‚æœè®©PVCç›´æ¥æŒ‡å®šProvisionerï¼Œè¿™äº›å¤æ‚çš„å‚æ•°å°±å¾—å…¨éƒ¨æŒ¤åœ¨PVCçš„å®šä¹‰é‡Œï¼Œè®©PVCå˜å¾—éå¸¸è‡ƒè‚¿ï¼Œè€Œä¸”åˆæŠŠé…ç½®ç»†èŠ‚æš´éœ²ç»™äº†å¼€å‘è€…ã€‚</p><h3 id="3-é»˜è®¤è¡Œä¸ºä¸ç®€åŒ–-Defaulting-Simplification"><a href="#3-é»˜è®¤è¡Œä¸ºä¸ç®€åŒ–-Defaulting-Simplification" class="headerlink" title="3. é»˜è®¤è¡Œä¸ºä¸ç®€åŒ– (Defaulting &amp; Simplification)"></a>3. é»˜è®¤è¡Œä¸ºä¸ç®€åŒ– (Defaulting &amp; Simplification)</h3><p>Kubernetesé›†ç¾¤å¯ä»¥æœ‰ä¸€ä¸ª<strong>é»˜è®¤çš„StorageClass</strong>ã€‚å½“ç”¨æˆ·åˆ›å»ºä¸€ä¸ªæ²¡æœ‰æŒ‡å®š <code>storageClassName</code> çš„PVCæ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨è¿™ä¸ªé»˜è®¤çš„StorageClassã€‚</p><p>è¿™æå¤§åœ°ç®€åŒ–äº†æœ€å¸¸è§çš„ä½¿ç”¨åœºæ™¯ã€‚å¼€å‘è€…ç”šè‡³ä¸éœ€è¦çŸ¥é“StorageClassçš„å­˜åœ¨ï¼Œä»–ä»¬åªéœ€è¦å†™ä¸€ä¸ªéå¸¸ç®€å•çš„PVCï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># å¼€å‘è€…å®Œå…¨ä¸ç”¨å…³å¿ƒstorageClassNameï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨é»˜è®¤çš„StorageClass</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">simple-pvc</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">accessModes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteOnce</span><br>  <span class="hljs-attr">resources:</span><br>    <span class="hljs-attr">requests:</span><br>      <span class="hljs-attr">storage:</span> <span class="hljs-string">5Gi</span><br><span class="hljs-comment"># æ²¡æœ‰ storageClassName å­—æ®µï¼</span><br></code></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰StorageClassï¼Œå®ç°è¿™ç§â€œé»˜è®¤â€è¡Œä¸ºä¼šéå¸¸å›°éš¾ã€‚</p><h3 id="4-å¤ç”¨ä¸å¤šæ€-Reuse-Polymorphism"><a href="#4-å¤ç”¨ä¸å¤šæ€-Reuse-Polymorphism" class="headerlink" title="4. å¤ç”¨ä¸å¤šæ€ (Reuse &amp; Polymorphism)"></a>4. å¤ç”¨ä¸å¤šæ€ (Reuse &amp; Polymorphism)</h3><p>ä¸€ä¸ªStorageClasså¯ä»¥è¢«æ— æ•°ä¸ªPVCå¤ç”¨ã€‚ç®¡ç†å‘˜å¯ä»¥å®šä¹‰ä¸€ä¸ªåä¸º <code>standard</code> çš„StorageClassï¼Œå…¨å…¬å¸çš„æˆç™¾ä¸Šåƒä¸ªåº”ç”¨éƒ½å¯ä»¥é€šè¿‡å¼•ç”¨ <code>storageClassName: standard</code> æ¥ä½¿ç”¨å®ƒã€‚</p><p>å¦‚æœå°†æ¥ç®¡ç†å‘˜æƒ³æŠŠ <code>standard</code> å­˜å‚¨çš„åç«¯ä»AWS EBSè¿ç§»åˆ°Portworxï¼Œä»–åªéœ€è¦<strong>æ›´æ–°è¿™ä¸€ä¸ªStorageClassçš„å®šä¹‰</strong>ï¼Œå°†æ‰€æœ‰PVCçš„Provisionerä» <code>kubernetes.io/aws-ebs</code> æ”¹æˆ <code>portworx.io/shared</code>ã€‚<strong>æ‰€æœ‰å¼•ç”¨è¿™ä¸ªStorageClassçš„PVCéƒ½æ— éœ€ä»»ä½•ä¿®æ”¹</strong>ã€‚</p><p>è¿™æ˜¯ä¸€ç§ç»å…¸çš„â€œå¤šæ€â€è®¾è®¡ï¼šPVCï¼ˆè°ƒç”¨è€…ï¼‰åªä¾èµ–ä¸€ä¸ªç¨³å®šçš„æ¥å£ï¼ˆStorageClassåç§°ï¼‰ï¼Œè€Œä¸ä¾èµ–å…·ä½“çš„å®ç°ï¼ˆProvisionerï¼‰ã€‚å…·ä½“çš„å®ç°å¯ä»¥éšæ—¶è¢«æ›´æ¢ï¼Œè€Œè°ƒç”¨è€…æ— æ„ŸçŸ¥ã€‚</p><hr><h3 id="æ€»ç»“ï¼šä¸€ä¸ªå®Œç¾çš„æ¯”å–»"><a href="#æ€»ç»“ï¼šä¸€ä¸ªå®Œç¾çš„æ¯”å–»" class="headerlink" title="æ€»ç»“ï¼šä¸€ä¸ªå®Œç¾çš„æ¯”å–»"></a>æ€»ç»“ï¼šä¸€ä¸ªå®Œç¾çš„æ¯”å–»</h3><p>è®©æˆ‘ä»¬å›åˆ°ç§Ÿæˆ¿çš„æ¯”å–»ï¼š</p><ul><li><strong>PVC</strong> &#x3D; <strong>ä½ çš„éœ€æ±‚æ¸…å•</strong>ï¼ˆâ€œæˆ‘è¦ä¸€ä¸ª2å®¤1å…ï¼Œæœˆç§Ÿ5000ä»¥ä¸‹çš„æˆ¿å­â€ï¼‰ã€‚</li><li><strong>Provisioner</strong> &#x3D; <strong>æŸä¸ªå…·ä½“çš„æˆ¿äº§å…¬å¸</strong>ï¼ˆæ¯”å¦‚â€œé“¾å®¶â€ï¼‰ï¼Œå®ƒæœ‰è‡ªå·±ä¸€å¥—å»º&#x2F;ç§Ÿæˆ¿çš„æµç¨‹å’Œå†…éƒ¨å‚æ•°ã€‚</li><li><strong>StorageClass</strong> &#x3D; <strong>ä¸€ä¸ªä¸ºä½ æœåŠ¡çš„â€œæ™ºèƒ½æˆ¿äº§ä¸­ä»‹å¹³å°â€</strong>ï¼ˆæ¯”å¦‚â€œè´å£³â€ï¼‰ã€‚</li></ul><p>ä½ ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥æŠŠéœ€æ±‚æ¸…å•ï¼ˆPVCï¼‰å‘ç»™é“¾å®¶ï¼ˆProvisionerï¼‰å‘¢ï¼Ÿ</p><ol><li><strong>è§£è€¦</strong>ï¼šä½ ä¸æƒ³å’ŒæŸä¸ªå…·ä½“å…¬å¸ç»‘æ­»ï¼Œä½ æƒ³çš„æ˜¯â€œæˆ‘è¦æ‰¾æˆ¿â€ï¼Œè€Œä¸æ˜¯â€œæˆ‘å¿…é¡»ç”¨é“¾å®¶æ‰¾æˆ¿â€ã€‚é€šè¿‡è´å£³å¹³å°ï¼Œä½ çš„éœ€æ±‚ä¹Ÿå¯ä»¥è¢«æˆ‘çˆ±æˆ‘å®¶ã€éº¦ç”°ç­‰å…¶ä»–å…¬å¸çœ‹åˆ°ã€‚</li><li><strong>å‚æ•°åŒ–</strong>ï¼šè´å£³å¹³å°è®©ä½ å¯ä»¥è½»æ¾é€‰æ‹©â€œæ•´ç§Ÿâ€ã€â€œåˆç§Ÿâ€ã€â€œæ˜¯å¦éœ€è¦è½¦ä½â€ç­‰æ ‡å‡†åŒ–å‚æ•°ï¼Œè€Œä¸éœ€è¦ä½ å»äº†è§£é“¾å®¶å†…éƒ¨çš„æ“ä½œæµç¨‹ã€‚</li><li><strong>é»˜è®¤å’Œç®€åŒ–</strong>ï¼šå¦‚æœä½ æ²¡æŒ‡å®šç”¨å“ªä¸ªå¹³å°ï¼Œç³»ç»Ÿå¯èƒ½ä¼šé»˜è®¤æŠŠä½ çš„éœ€æ±‚å‘åˆ°æœ€å¤§çš„é‚£ä¸ªå¹³å°ã€‚</li><li><strong>å¤ç”¨ä¸å¤šæ€</strong>ï¼šä½ è®°ä½äº†â€œè´å£³â€è¿™ä¸ªå¥½ç”¨çš„å¹³å°æ¥å£ã€‚å³ä½¿è´å£³èƒŒåçš„åˆä½œå…¬å¸ä»é“¾å®¶æ¢æˆäº†ä¸‡ç§‘ï¼Œä½ ä¾ç„¶å¯ä»¥ç”¨åŒæ ·çš„æ–¹å¼ï¼ˆå»è´å£³å¹³å°ï¼‰å‘å¸ƒéœ€æ±‚ï¼Œå®Œå…¨ä¸å—å½±å“ã€‚</li></ol><p>æ‰€ä»¥ï¼Œ<strong>StorageClassç»ä¸æ˜¯ä¸€ä¸ªå¤šä½™çš„â€œä¸­é—´äººâ€ï¼Œè€Œæ˜¯ä¸€ä¸ªå¼ºå¤§çš„â€œæŠ½è±¡å±‚â€å’Œâ€œæ§åˆ¶é¢â€</strong>ã€‚å®ƒé€šè¿‡è§£è€¦ã€å‚æ•°åŒ–å’Œæä¾›é»˜è®¤è¡Œä¸ºï¼Œä½¿å¾—å­˜å‚¨é…ç½®æ—¢çµæ´»åˆæ˜“äºç®¡ç†ï¼Œå®Œç¾ä½“ç°äº†Kubernetesçš„è®¾è®¡æ™ºæ…§ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>k8sä¸­watchæœºåˆ¶å®Œæ•´è¿‡ç¨‹è§£è¯»</title>
    <link href="/2025/08/20/k8s%E4%B8%ADwatch%E6%9C%BA%E5%88%B6%E5%AE%8C%E6%95%B4%E8%BF%87%E7%A8%8B%E8%A7%A3%E8%AF%BB/"/>
    <url>/2025/08/20/k8s%E4%B8%ADwatch%E6%9C%BA%E5%88%B6%E5%AE%8C%E6%95%B4%E8%BF%87%E7%A8%8B%E8%A7%A3%E8%AF%BB/</url>
    
    <content type="html"><![CDATA[<h1 id="k8sä¸­watchæœºåˆ¶å®Œæ•´è¿‡ç¨‹è§£è¯»"><a href="#k8sä¸­watchæœºåˆ¶å®Œæ•´è¿‡ç¨‹è§£è¯»" class="headerlink" title="k8sä¸­watchæœºåˆ¶å®Œæ•´è¿‡ç¨‹è§£è¯»"></a>k8sä¸­watchæœºåˆ¶å®Œæ•´è¿‡ç¨‹è§£è¯»</h1><h2 id="é—®é¢˜ä¸€ï¼š"><a href="#é—®é¢˜ä¸€ï¼š" class="headerlink" title="é—®é¢˜ä¸€ï¼š"></a>é—®é¢˜ä¸€ï¼š</h2><p>k8sä½¿ç”¨etcdçš„watchæœºåˆ¶æ¥ç›‘å¬èµ„æºçš„çŠ¶æ€ï¼Œæˆ‘æ„Ÿè§‰è¿™å¾ˆç¥å¥‡ï¼Œk8sç³»ç»Ÿä¸­å…·ä½“æ˜¯æ€ä¹ˆwatchåˆ°èµ„æºçš„â€œå¢åˆ æ”¹â€äº‹ä»¶çš„ï¼Œåˆæ˜¯å¦‚ä½•å¤„ç†è¿™äº›å¢åˆ æ”¹äº‹ä»¶çš„ï¼Œå¦‚æœçŸ­æ—¶é—´å†…watchåˆ°äº†ä¸€ä¸ªèµ„æºå¯¹è±¡çš„å¤šä¸ªäº‹ä»¶ï¼Œåˆæ˜¯å¦‚ä½•å¤„ç†çš„</p><p>éå¸¸å¥½ã€éå¸¸æ ¸å¿ƒçš„é—®é¢˜ï¼ä½ è§¦åŠäº†Kubernetesæ§åˆ¶å™¨æ¨¡å¼ï¼ˆController Patternï¼‰çš„å¿ƒè„ã€‚è¿™ä¸ªâ€œWatch -&gt; äº‹ä»¶ -&gt; è°ƒè°â€çš„æœºåˆ¶ï¼Œæ­£æ˜¯K8sèƒ½å¤Ÿè‡ªåŠ¨ä¿æŒç³»ç»Ÿå¤„äºæœŸæœ›çŠ¶æ€çš„é­”åŠ›æ‰€åœ¨ã€‚</p><p>æˆ‘ä¼šä¸ºä½ è¯¦ç»†æ‹†è§£è¿™ä¸ªè¿‡ç¨‹ï¼Œä»äº‹ä»¶å¦‚ä½•äº§ç”Ÿï¼Œåˆ°å¦‚ä½•è¢«å¤„ç†ï¼Œå†åˆ°å¦‚ä½•å¤„ç†é«˜é¢‘äº‹ä»¶ã€‚</p><hr><p>ä¸ºäº†è®©æ•´ä¸ªæµç¨‹ä¸€ç›®äº†ç„¶ï¼Œä¸‹å›¾æ¦‚æ‹¬äº†ä»äº‹ä»¶å‘ç”Ÿåˆ°è¢«å¤„ç†çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼š</p><p><img src="/2025/08/20/k8s%E4%B8%ADwatch%E6%9C%BA%E5%88%B6%E5%AE%8C%E6%95%B4%E8%BF%87%E7%A8%8B%E8%A7%A3%E8%AF%BB/deepseek_mermaid_20250820_a9b99c.svg" alt="deepseek_mermaid_20250820_a9b99c"></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¯¦ç»†è§£æå›¾ä¸­çš„æ¯ä¸€ä¸ªå…³é”®ç¯èŠ‚ã€‚</p><hr><h2 id="1-äº‹ä»¶çš„äº§ç”Ÿä¸ä¼ é€’ï¼šä»-etcd-åˆ°-Watch"><a href="#1-äº‹ä»¶çš„äº§ç”Ÿä¸ä¼ é€’ï¼šä»-etcd-åˆ°-Watch" class="headerlink" title="1. äº‹ä»¶çš„äº§ç”Ÿä¸ä¼ é€’ï¼šä» etcd åˆ° Watch"></a>1. äº‹ä»¶çš„äº§ç”Ÿä¸ä¼ é€’ï¼šä» <code>etcd</code> åˆ° <code>Watch</code></h2><p>æ•´ä¸ªæµç¨‹çš„èµ·ç‚¹ï¼Œæ˜¯ä¸€ä¸ªèµ„æºå¯¹è±¡ï¼ˆæ¯”å¦‚ä¸€ä¸ªPodï¼‰å‘ç”Ÿäº†å˜åŒ–ã€‚</p><h3 id="1-1-kube-apiserver-äº‹ä»¶çš„åˆ›é€ è€…å’Œä¸­è½¬ç«™"><a href="#1-1-kube-apiserver-äº‹ä»¶çš„åˆ›é€ è€…å’Œä¸­è½¬ç«™" class="headerlink" title="1.1 kube-apiserver: äº‹ä»¶çš„åˆ›é€ è€…å’Œä¸­è½¬ç«™"></a>1.1 <code>kube-apiserver</code>: äº‹ä»¶çš„åˆ›é€ è€…å’Œä¸­è½¬ç«™</h3><ol><li><strong>å†™æ“ä½œ (Write)</strong>: å½“ä½ æ‰§è¡Œ <code>kubectl apply</code> æˆ–ä»»ä½•å…¶ä»–æ›´æ”¹é›†ç¾¤çŠ¶æ€çš„æ“ä½œæ—¶ï¼Œè¯·æ±‚é¦–å…ˆåˆ°è¾¾ <code>kube-apiserver</code>ã€‚</li><li><strong>æŒä¹…åŒ–</strong>: <code>kube-apiserver</code> ä¼šå…ˆå°†å˜æ›´<strong>æŒä¹…åŒ–åˆ° <code>etcd</code></strong> ä¸­ã€‚è¿™æ˜¯å”¯ä¸€çš„æƒå¨æ•°æ®æºã€‚</li><li><strong>ç”Ÿæˆäº‹ä»¶ (Event Generation)</strong>: åœ¨æˆåŠŸå†™å…¥ <code>etcd</code> <strong>ä¹‹å</strong>ï¼Œ<code>kube-apiserver</code> ä¼šç«‹å³åœ¨å†…å­˜ä¸­åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„äº‹ä»¶ï¼ˆEventï¼‰ã€‚è¿™ä¸ªäº‹ä»¶ä¸æ˜¯æŒ‡ <code>kubectl describe</code> çœ‹åˆ°çš„ <code>Event</code> èµ„æºï¼Œè€Œæ˜¯ä¸€ä¸ªå†…éƒ¨æ•°æ®ç»“æ„ï¼Œå®ƒåŒ…å«äº†ï¼š<ul><li><strong>Key</strong>: å‘ç”Ÿå˜åŒ–å¯¹è±¡çš„é”®ï¼ˆå¦‚ <code>/registry/pods/default/my-pod</code>ï¼‰ã€‚</li><li><strong>Type</strong>: äº‹ä»¶ç±»å‹ - <code>ADDED</code>ï¼Œ <code>MODIFIED</code>ï¼Œ <code>DELETED</code>ã€‚</li><li><strong>Object</strong>: å˜åŒ–åå¯¹è±¡çš„æœ€æ–°å®Œæ•´çŠ¶æ€ï¼ˆå¯¹äº <code>DELETED</code>ï¼Œåˆ™æ˜¯åˆ é™¤å‰çš„çŠ¶æ€ï¼‰ã€‚</li></ul></li></ol><h3 id="1-2-Watch-æœºåˆ¶ï¼šé«˜æ•ˆçš„äº‹ä»¶åˆ†å‘"><a href="#1-2-Watch-æœºåˆ¶ï¼šé«˜æ•ˆçš„äº‹ä»¶åˆ†å‘" class="headerlink" title="1.2 Watch æœºåˆ¶ï¼šé«˜æ•ˆçš„äº‹ä»¶åˆ†å‘"></a>1.2 <code>Watch</code> æœºåˆ¶ï¼šé«˜æ•ˆçš„äº‹ä»¶åˆ†å‘</h3><p><code>kube-apiserver</code> ä¸ä¼šå»ä¸»åŠ¨è½®è¯¢ <code>etcd</code>ï¼Œé‚£ä¼šéå¸¸ä½æ•ˆã€‚ç›¸åï¼Œå®ƒåˆ©ç”¨äº† <code>etcd</code> æä¾›çš„ <strong><code>Watch</code> API</strong>ã€‚</p><ol><li><strong>å»ºç«‹è¿æ¥</strong>: å½“ä¸€ä¸ªæ§åˆ¶å™¨ï¼ˆå¦‚ Deployment Controllerï¼‰å¯åŠ¨æ—¶ï¼Œå®ƒä¼šå‘ <code>kube-apiserver</code> å‘èµ·ä¸€ä¸ª <code>Watch</code> è¯·æ±‚ã€‚ä¾‹å¦‚ï¼šâ€œæˆ‘æƒ³ç›‘å¬ï¼ˆWatchï¼‰æ‰€æœ‰å±äº <code>app=nginx</code> çš„ Pod çš„å˜åŒ–â€ã€‚</li><li><strong>åŸºäº HTTP é•¿è¿æ¥çš„æµå¼ä¼ è¾“ (Streaming)</strong>: <code>kube-apiserver</code> æ¥å—è¿™ä¸ª <code>Watch</code> è¿æ¥ï¼Œä½†<strong>ä¸ä¼šç«‹å³è¿”å›å“åº”å¹¶æ–­å¼€</strong>ã€‚å®ƒä¼šä¿æŒè¿™ä¸ª HTTP è¿æ¥ï¼ˆé€šå¸¸æ˜¯ HTTP&#x2F;2ï¼Œæ”¯æŒå¤šè·¯å¤ç”¨ï¼‰ï¼Œå½¢æˆä¸€ä¸ªæŒç»­çš„ã€å•å‘çš„<strong>äº‹ä»¶æµï¼ˆStreamï¼‰</strong>ã€‚</li><li><strong>äº‹ä»¶æ¨é€</strong>: ä¸€æ—¦æ­¥éª¤ 1.1 ä¸­æè¿°çš„äº‹ä»¶è¢«ç”Ÿæˆï¼Œ<code>kube-apiserver</code> å°±ä¼šç«‹å³é€šè¿‡è¿™ä¸ªå·²ç»å»ºç«‹å¥½çš„æµè¿æ¥ï¼Œå°†äº‹ä»¶<strong>æ¨é€ï¼ˆPushï¼‰</strong> ç»™æ­£åœ¨ç›‘å¬çš„æ§åˆ¶å™¨ã€‚</li><li><strong>å†å²äº‹ä»¶åŒæ­¥ (History Synchronization)</strong>: å¦‚æœä¸€ä¸ªæ§åˆ¶å™¨åˆšå¼€å§‹ç›‘å¬ï¼Œå®ƒæ€ä¹ˆçŸ¥é“å½“å‰å·²ç»å­˜åœ¨å“ªäº› Podï¼Ÿ<code>Watch</code> API éå¸¸èªæ˜ã€‚å½“å»ºç«‹ä¸€ä¸ªæ–°çš„ <code>Watch</code> è¿æ¥æ—¶ï¼Œ<code>kube-apiserver</code> ä¼šé¦–å…ˆå°†å½“å‰ <code>etcd</code> ä¸­æ‰€æœ‰åŒ¹é…æ¡ä»¶çš„èµ„æºï¼Œä½œä¸ºä¸€ç³»åˆ— <code>ADDED</code> äº‹ä»¶å‘é€ç»™å®¢æˆ·ç«¯ï¼Œç›¸å½“äºä¸€ä¸ªå¿«ç…§ã€‚ä¹‹åï¼Œå†å¼€å§‹å‘é€æ–°çš„å®æ—¶å˜æ›´äº‹ä»¶ã€‚</li></ol><p><strong>ä¸ºä»€ä¹ˆè¿™æ ·é«˜æ•ˆï¼Ÿ</strong></p><ul><li><strong>å‡å°‘å‹åŠ›</strong>: <code>etcd</code> å’Œ <code>kube-apiserver</code> éƒ½é¿å…äº†é¢‘ç¹çš„è½®è¯¢ï¼ˆPollingï¼‰å¼€é”€ã€‚</li><li><strong>å®æ—¶æ€§</strong>: äº‹ä»¶å‡ ä¹æ˜¯å®æ—¶æ¨é€çš„ï¼Œå»¶è¿Ÿæä½ã€‚</li><li><strong>å‡å°‘å¼€é”€</strong>: åªæœ‰å˜åŒ–çš„æ•°æ®æ‰ä¼šè¢«ä¼ è¾“ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½ä¼ è¾“å…¨å¥—æ•°æ®ã€‚</li></ul><hr><h2 id="2-äº‹ä»¶çš„å¤„ç†ï¼šæ§åˆ¶å™¨çš„å·¥ä½œæ¨¡å¼"><a href="#2-äº‹ä»¶çš„å¤„ç†ï¼šæ§åˆ¶å™¨çš„å·¥ä½œæ¨¡å¼" class="headerlink" title="2. äº‹ä»¶çš„å¤„ç†ï¼šæ§åˆ¶å™¨çš„å·¥ä½œæ¨¡å¼"></a>2. äº‹ä»¶çš„å¤„ç†ï¼šæ§åˆ¶å™¨çš„å·¥ä½œæ¨¡å¼</h2><p>æ§åˆ¶å™¨æ‹¿åˆ°äº‹ä»¶åï¼Œå¹¶ä¸ä¼šç›´æ¥å¯¹é›†ç¾¤è¿›è¡Œæ“ä½œã€‚å®ƒéµå¾ªä¸€ä¸ªéå¸¸ç»å…¸ä¸”ç¨³å¥çš„æ¨¡å¼ï¼š<strong>æ°´å¹³è§¦å‘ï¼ˆLevel-Triggeredï¼‰</strong> å’Œ <strong>æ§åˆ¶å™¨å¾ªç¯ï¼ˆReconcile Loopï¼‰</strong>ã€‚</p><h3 id="2-1-å…¥é˜Ÿï¼ˆEnqueueï¼‰ï¼šäº‹ä»¶ä¸æ˜¯ç›´æ¥å¤„ç†"><a href="#2-1-å…¥é˜Ÿï¼ˆEnqueueï¼‰ï¼šäº‹ä»¶ä¸æ˜¯ç›´æ¥å¤„ç†" class="headerlink" title="2.1 å…¥é˜Ÿï¼ˆEnqueueï¼‰ï¼šäº‹ä»¶ä¸æ˜¯ç›´æ¥å¤„ç†"></a>2.1 å…¥é˜Ÿï¼ˆEnqueueï¼‰ï¼šäº‹ä»¶ä¸æ˜¯ç›´æ¥å¤„ç†</h3><p>æ§åˆ¶å™¨åœ¨æ”¶åˆ°äº‹ä»¶åï¼Œå¹¶ä¸ä¼šç«‹å³å¼€å§‹å·¥ä½œã€‚å®ƒçš„ç¬¬ä¸€ä¸ªåŠ¨ä½œæ˜¯ï¼š</p><ol><li><strong>æå–å…³é”®ä¿¡æ¯</strong>: ä»äº‹ä»¶å¯¹è±¡ä¸­æå–å‡ºæœ€èƒ½æ ‡è¯†è¯¥å¯¹è±¡çš„<strong>é”®ï¼ˆKeyï¼‰</strong>ã€‚é€šå¸¸æ˜¯ <code>&lt;namespace&gt;/&lt;name&gt;</code> çš„æ ¼å¼ï¼ˆä¾‹å¦‚ <code>default/my-nginx-pod</code>ï¼‰ã€‚</li><li><strong>æ”¾å…¥å·¥ä½œé˜Ÿåˆ—ï¼ˆWork Queueï¼‰</strong>: å°†è¿™ä¸ªé”®æ”¾å…¥æ§åˆ¶å™¨å†…éƒ¨çš„ä¸€ä¸ª<strong>å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰é˜Ÿåˆ—</strong>ä¸­ã€‚</li></ol><p><strong>ä¸ºä»€ä¹ˆè¦æœ‰é˜Ÿåˆ—ï¼Ÿ</strong><br>è¿™æ˜¯ä¸ºäº†<strong>è§£è€¦</strong>äº‹ä»¶çš„æ¥æ”¶å’Œå¤„ç†ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å¤„ç†â€œçŸ­æ—¶é—´å†…å¤šä¸ªäº‹ä»¶â€çš„å…³é”®ï¼Œæˆ‘ä»¬ä¼šåœ¨ç¬¬ä¸‰éƒ¨åˆ†è¯¦ç»†å±•å¼€ã€‚</p><h3 id="2-2-å¤„ç†ï¼ˆProcessï¼‰ï¼šè°ƒè°å¾ªç¯ï¼ˆReconcile-Loopï¼‰"><a href="#2-2-å¤„ç†ï¼ˆProcessï¼‰ï¼šè°ƒè°å¾ªç¯ï¼ˆReconcile-Loopï¼‰" class="headerlink" title="2.2 å¤„ç†ï¼ˆProcessï¼‰ï¼šè°ƒè°å¾ªç¯ï¼ˆReconcile Loopï¼‰"></a>2.2 å¤„ç†ï¼ˆProcessï¼‰ï¼šè°ƒè°å¾ªç¯ï¼ˆReconcile Loopï¼‰</h3><p>æ§åˆ¶å™¨çš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªæ°¸ä¸åœæ­¢çš„å¾ªç¯ï¼Œè¿™ä¸ªå¾ªç¯çš„å·¥ä½œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå®ƒä»é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡ï¼Œå¹¶é©±åŠ¨ç‰©ç†é›†ç¾¤çš„çŠ¶æ€å‘æœŸæœ›çŠ¶æ€æ”¶æ•›ï¼š</p><p><img src="/2025/08/20/k8s%E4%B8%ADwatch%E6%9C%BA%E5%88%B6%E5%AE%8C%E6%95%B4%E8%BF%87%E7%A8%8B%E8%A7%A3%E8%AF%BB/deepseek_mermaid_20250820_89ee99.svg" alt="deepseek_mermaid_20250820_89ee99"></p><p>è¿™ä¸ªè®¾è®¡æ¨¡å¼æå…¶å¼ºå¤§å’Œé²æ£’ï¼š</p><ul><li><strong>è‡ªæˆ‘ä¿®å¤</strong>: å³ä½¿æŸä¸ªå¤„ç†å¤±è´¥äº†ï¼ŒKey ä¼šè¢«é‡æ–°æ”¾å›é˜Ÿåˆ—ï¼Œä¹‹åä¼šå†æ¬¡å°è¯•ã€‚</li><li><strong>æœ€ç»ˆä¸€è‡´æ€§</strong>: å®ƒä¸è¿½æ±‚å¼ºä¸€è‡´ï¼Œè€Œæ˜¯ä¿è¯ç³»ç»Ÿæœ€ç»ˆä¼šæœç€æœŸæœ›çŠ¶æ€æ”¶æ•›ã€‚</li><li><strong>å¹‚ç­‰æ€§ (Idempotent)</strong>: æ‰§è¡Œçš„æ“ä½œè¢«è®¾è®¡æˆå¯ä»¥å®‰å…¨åœ°é‡å¤æ‰§è¡Œå¤šæ¬¡ã€‚å› ä¸ºæ¯”è¾ƒçš„æ˜¯å½“å‰çŠ¶æ€å’ŒæœŸæœ›çŠ¶æ€ï¼Œæ‰€ä»¥å³ä½¿å› ä¸ºç½‘ç»œæŠ–åŠ¨ç­‰åŸå› é‡å¤å¤„ç†äº†åŒä¸€ä¸ªäº‹ä»¶ï¼Œç»“æœä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</li></ul><hr><h2 id="3-å¤„ç†çŸ­æ—¶é—´å†…çš„å¤§é‡äº‹ä»¶ï¼šé˜Ÿåˆ—ä¸æ°´å¹³è§¦å‘"><a href="#3-å¤„ç†çŸ­æ—¶é—´å†…çš„å¤§é‡äº‹ä»¶ï¼šé˜Ÿåˆ—ä¸æ°´å¹³è§¦å‘" class="headerlink" title="3. å¤„ç†çŸ­æ—¶é—´å†…çš„å¤§é‡äº‹ä»¶ï¼šé˜Ÿåˆ—ä¸æ°´å¹³è§¦å‘"></a>3. å¤„ç†çŸ­æ—¶é—´å†…çš„å¤§é‡äº‹ä»¶ï¼šé˜Ÿåˆ—ä¸æ°´å¹³è§¦å‘</h2><p>ç°åœ¨æˆ‘ä»¬æ¥å›ç­”ä½ æœ€å…³å¿ƒçš„é—®é¢˜ï¼š<strong>å¦‚æœåŒä¸€ä¸ªå¯¹è±¡åœ¨æçŸ­æ—¶é—´å†…è¢«é¢‘ç¹ä¿®æ”¹ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ª Pod çš„çŠ¶æ€åœ¨ 1 ç§’å†…å˜äº† 10 æ¬¡ï¼‰ï¼Œç³»ç»Ÿå¦‚ä½•åº”å¯¹ï¼Ÿ</strong></p><p>ç­”æ¡ˆå°±è—åœ¨ <strong>â€œé˜Ÿåˆ— + æ°´å¹³è§¦å‘â€</strong> çš„è®¾è®¡ä¸­ã€‚</p><h3 id="3-1-é˜Ÿåˆ—çš„å»é‡ä¸ç¼“å†²"><a href="#3-1-é˜Ÿåˆ—çš„å»é‡ä¸ç¼“å†²" class="headerlink" title="3.1 é˜Ÿåˆ—çš„å»é‡ä¸ç¼“å†²"></a>3.1 é˜Ÿåˆ—çš„å»é‡ä¸ç¼“å†²</h3><ol><li><strong>å»é‡ (Deduplication)</strong>: å¤§å¤šæ•°æ§åˆ¶å™¨çš„å·¥ä½œé˜Ÿåˆ—éƒ½å…·æœ‰<strong>å»é‡</strong>åŠŸèƒ½ã€‚å¦‚æœåŒä¸€ä¸ªå¯¹è±¡çš„é”®ï¼ˆå¦‚ <code>default/my-pod</code>ï¼‰å·²ç»å­˜åœ¨äºé˜Ÿåˆ—ä¸­ä¸”å°šæœªè¢«å¤„ç†ï¼Œé‚£ä¹ˆåç»­åˆ°æ¥çš„å…³äºè¿™ä¸ªå¯¹è±¡çš„å¤šä¸ªäº‹ä»¶ï¼Œ<strong>åªä¼šå¯¼è‡´è¿™ä¸ªé”®è¢«æ”¾å…¥é˜Ÿåˆ—ä¸€æ¬¡</strong>ã€‚<ul><li><em>åœºæ™¯</em>: Pod åœ¨çŸ­æ—¶é—´å†…æ”¶åˆ° 10 ä¸ª <code>MODIFIED</code> äº‹ä»¶ã€‚</li><li><em>å¤„ç†</em>: æ§åˆ¶å™¨å¯èƒ½åªä¼šå°† <code>default/my-pod</code> æ”¾å…¥é˜Ÿåˆ— 2-3 æ¬¡ï¼Œè€Œä¸æ˜¯ 10 æ¬¡ã€‚å› ä¸ºå½“ç¬¬ä¸€ä¸ªäº‹ä»¶åˆ°æ¥æ—¶ï¼Œé”®è¢«æ”¾å…¥é˜Ÿåˆ—ã€‚åœ¨å®ƒè¢«å¤„ç†ä¹‹å‰ï¼Œåç»­çš„ 9 ä¸ªäº‹ä»¶å‘ç°é˜Ÿåˆ—é‡Œå·²ç»æœ‰è¿™ä¸ªé”®äº†ï¼Œå°±ä¸ä¼šå†é‡å¤æ·»åŠ ã€‚</li></ul></li><li><strong>ç¼“å†² (Buffering)</strong>: é˜Ÿåˆ—ä½œä¸ºä¸€ä¸ªç¼“å†²åŒºï¼Œå¸æ”¶äº†äº‹ä»¶çš„æ´ªå³°ï¼Œè®©åå°çš„å¤„ç†å¾ªç¯å¯ä»¥æŒ‰ç…§è‡ªå·±çš„èŠ‚å¥æ¥å¤„ç†ï¼Œé¿å…äº†è¢«çªå‘æµé‡å†²å®ã€‚</li></ol><h3 id="3-2-æ°´å¹³è§¦å‘-Level-Triggered-vs-è¾¹æ²¿è§¦å‘-Edge-Triggered"><a href="#3-2-æ°´å¹³è§¦å‘-Level-Triggered-vs-è¾¹æ²¿è§¦å‘-Edge-Triggered" class="headerlink" title="3.2 æ°´å¹³è§¦å‘ (Level-Triggered) vs è¾¹æ²¿è§¦å‘ (Edge-Triggered)"></a>3.2 æ°´å¹³è§¦å‘ (Level-Triggered) vs è¾¹æ²¿è§¦å‘ (Edge-Triggered)</h3><p>è¿™æ˜¯æ•´ä¸ªè®¾è®¡ä¸­æœ€ç²¾å¦™çš„éƒ¨åˆ†ï¼Kubernetes é€‰æ‹©çš„æ˜¯<strong>æ°´å¹³è§¦å‘</strong>ã€‚</p><ul><li><strong>è¾¹æ²¿è§¦å‘ (Edge-Triggered)</strong>: åªå¯¹çŠ¶æ€å˜åŒ–çš„äº‹ä»¶åšå‡ºååº”ã€‚å¦‚æœä½ é”™è¿‡äº†æŸä¸ªäº‹ä»¶ï¼ˆæ¯”å¦‚ç½‘ç»œä¸¢åŒ…ï¼‰ï¼Œå¯èƒ½å°±æ°¸è¿œä¸¢å¤±äº†è¿™ä¸ªå˜åŒ–ã€‚</li><li><strong>æ°´å¹³è§¦å‘ (Level-Triggered)</strong>: <strong>å®ƒä¸å…³å¿ƒå…·ä½“å‘ç”Ÿäº†ä»€ä¹ˆäº‹ä»¶ï¼Œåªå…³å¿ƒâ€œå½“å‰çŠ¶æ€â€æ˜¯ä»€ä¹ˆã€‚</strong> æ¯å½“æ§åˆ¶å™¨å¤„ç†ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå®ƒåšçš„äº‹æƒ…æ˜¯ï¼š<ol><li>ä»é˜Ÿåˆ—ä¸­å–å‡ºé”® <code>default/my-pod</code>ã€‚</li><li><strong>é€šè¿‡ API Server é‡æ–°è·å–è¿™ä¸ª Pod çš„æœ€æ–°çŠ¶æ€</strong>ï¼ˆè€Œä¸æ˜¯ä½¿ç”¨äº‹ä»¶é‡Œé™„å¸¦çš„æ—§çŠ¶æ€ï¼ï¼‰ã€‚</li><li>å°†è·å–åˆ°çš„æœ€æ–°çŠ¶æ€ä¸æœŸæœ›çŠ¶æ€è¿›è¡Œæ¯”è¾ƒã€‚</li><li>æ ¹æ®æ¯”è¾ƒç»“æœå†³å®šè¦åšä»€ä¹ˆã€‚</li></ol></li></ul><p><strong>æ°´å¹³è§¦å‘çš„å·¨å¤§ä¼˜åŠ¿ï¼š</strong></p><ul><li><strong>äº‹ä»¶ä¸¢å¤±æ— å…³ç´§è¦</strong>: å³ä½¿æŸä¸ª <code>MODIFIED</code> äº‹ä»¶å› ä¸ºç½‘ç»œé—®é¢˜ä¸¢å¤±äº†ï¼Œä¹Ÿå®Œå…¨æ²¡å…³ç³»ã€‚å› ä¸ºå½“æ§åˆ¶å™¨ä¸‹æ¬¡å¤„ç†è¿™ä¸ªå¯¹è±¡æ—¶ï¼Œå®ƒä¼šç›´æ¥ä» API Server è¯»å–æœ€æ–°çŠ¶æ€ï¼Œè¿™ä¸ªçŠ¶æ€å·²ç»åŒ…å«äº†æ‰€æœ‰ä¸­é—´å˜åŒ–çš„ç»“æœã€‚</li><li><strong>å¤„ç†çš„æ˜¯æœ€æ–°çŠ¶æ€</strong>: åœ¨ä¸Šé¢çš„ 10 ä¸ªäº‹ä»¶çš„ä¾‹å­ä¸­ï¼Œæ§åˆ¶å™¨å¯èƒ½åªè¢«è§¦å‘äº† 2-3 æ¬¡ï¼Œä½†åœ¨è¿™ 2-3 æ¬¡å¤„ç†ä¸­ï¼Œå®ƒæ¯æ¬¡è¯»å–åˆ°çš„éƒ½æ˜¯è¿™ä¸ª Pod <strong>æˆªè‡³åˆ°é‚£ä¸ªæ—¶åˆ»çš„æœ€æ–°çŠ¶æ€</strong>ã€‚å®ƒå®Œå…¨ä¸éœ€è¦çŸ¥é“ä¸­é—´å‘ç”Ÿè¿‡ 9 æ¬¡æ— å…³ç´§è¦çš„å˜åŒ–ã€‚</li></ul><p><strong>è¿™å°±å¥½æ¯”ï¼š</strong></p><ul><li><strong>è¾¹æ²¿è§¦å‘</strong>ï¼šä½ çš„æœ‹å‹ç»™ä½ å‘çŸ­ä¿¡ï¼šâ€œæˆ‘å‡ºé—¨äº†â€ã€â€œæˆ‘åˆ°æ¥¼ä¸‹äº†â€ã€â€œæˆ‘çœ‹åˆ°ä½ äº†â€ã€â€œæˆ‘æ‹›æ‰‹äº†â€ã€‚ä½ éœ€è¦å¤„ç†æ¯ä¸€æ¡ä¿¡æ¯ã€‚</li><li><strong>æ°´å¹³è§¦å‘</strong>ï¼šä½ æ¯éš”ä¸€åˆ†é’Ÿçœ‹ä¸€çœ¼çª—å¤–ï¼Œçœ‹åˆ°ä½ æœ‹å‹å·²ç»ç«™åœ¨æ¥¼ä¸‹äº†ã€‚ä½ ä¸éœ€è¦å…³å¿ƒä»–æ˜¯æ€ä¹ˆè¿‡æ¥çš„ï¼Œä½ åªéœ€è¦æ ¹æ®â€œä»–å·²ç»åœ¨æ¥¼ä¸‹â€è¿™ä¸ªå½“å‰çŠ¶æ€ï¼Œåšå‡ºâ€œä¸‹æ¥¼æ¥ä»–â€è¿™ä¸ªåŠ¨ä½œå³å¯ã€‚ä¸­é—´ä»–å‘äº†å¤šå°‘æ¡çŸ­ä¿¡ï¼Œä½ æ²¡æ”¶åˆ°å‡ æ¡ï¼Œéƒ½æ— å…³ç´§è¦ã€‚</li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><table><thead><tr><th align="left">ç¯èŠ‚</th><th align="left">æ ¸å¿ƒæŠ€æœ¯</th><th align="left">è§£å†³çš„é—®é¢˜</th></tr></thead><tbody><tr><td align="left"><strong>äº‹ä»¶äº§ç”Ÿ</strong></td><td align="left"><code>etcd</code> Watch API + <code>kube-apiserver</code> äº‹ä»¶ç”Ÿæˆ</td><td align="left">å®æ—¶ã€é«˜æ•ˆåœ°è·å–æ•°æ®å˜åŒ–ï¼Œé¿å…è½®è¯¢ã€‚</td></tr><tr><td align="left"><strong>äº‹ä»¶æ¥æ”¶</strong></td><td align="left">HTTP é•¿è¿æ¥æµ</td><td align="left">ä½å»¶è¿Ÿã€ä½å¼€é”€åœ°å°†äº‹ä»¶åˆ†å‘ç»™ä¼—å¤šå®¢æˆ·ç«¯ã€‚</td></tr><tr><td align="left"><strong>äº‹ä»¶ç¼“å†²</strong></td><td align="left">å·¥ä½œé˜Ÿåˆ—ï¼ˆWork Queueï¼‰</td><td align="left">è§£è€¦ã€å‰Šå³°ã€å»é‡ï¼Œé¿å…äº‹ä»¶æ´ªå³°å†²å®æ§åˆ¶å™¨ã€‚</td></tr><tr><td align="left"><strong>äº‹ä»¶å¤„ç†</strong></td><td align="left">æ°´å¹³è§¦å‘çš„è°ƒè°å¾ªç¯ï¼ˆReconcile Loopï¼‰</td><td align="left">ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€è‡ªæˆ‘ä¿®å¤ã€å¹‚ç­‰æ€§ã€‚ä¸å…³å¿ƒè¿‡ç¨‹ï¼Œåªå…³å¿ƒæœ€ç»ˆçŠ¶æ€ï¼Œå¤©ç„¶æŠµå¾¡äº‹ä»¶ä¸¢å¤±å’Œé‡å¤ã€‚</td></tr></tbody></table><p>æ‰€ä»¥ï¼ŒKubernetes é€šè¿‡è¿™ç§åŸºäº <strong>Watch</strong> çš„äº‹ä»¶é€šçŸ¥æœºåˆ¶ã€<strong>é˜Ÿåˆ—</strong>çš„ç¼“å†²ä¸å»é‡æœºåˆ¶ã€ä»¥åŠæœ€ç»ˆçŠ¶æ€çš„<strong>æ°´å¹³è§¦å‘è°ƒè°</strong>æœºåˆ¶ï¼Œä¼˜é›…ã€ç¨³å¥ä¸”é«˜æ•ˆåœ°å¤„ç†äº†èµ„æºçš„å˜æ›´ï¼Œå³ä½¿é¢å¯¹çŸ­æ—¶é—´å†…æµ·é‡çš„äº‹ä»¶ï¼Œä¹Ÿèƒ½æœ€ç»ˆå°†é›†ç¾¤ç¨³å®šåœ°é©±å‘æœŸæœ›çš„çŠ¶æ€ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡æ¨¡å¼ã€‚</p><h2 id="é—®é¢˜äºŒï¼š"><a href="#é—®é¢˜äºŒï¼š" class="headerlink" title="é—®é¢˜äºŒï¼š"></a>é—®é¢˜äºŒï¼š</h2><p>è¿™ä¹ˆè¯´çš„è¯ï¼Œåœ¨æ•´ä¸ªäº‹ä»¶å¤„ç†çš„è¿‡ç¨‹ä¸­ï¼Œk8sçš„æ§åˆ¶å™¨åªéœ€è¦å’Œapiserverå»ºç«‹watchè¿æ¥å°±è¡Œäº†ï¼Œæ ¹æœ¬ä¸éœ€è¦å’Œetcdäº¤äº’ï¼Œè€Œä¸”apiserverä¹Ÿä¸éœ€è¦å’Œetcdäº¤äº’ï¼Œç›´æ¥ä½¿ç”¨å†…å­˜ä¸­ç”Ÿæˆçš„äº‹ä»¶ã€‚apiserveråªæ˜¯åœ¨å’Œæ§åˆ¶å™¨å»ºç«‹è¿æ¥ä¹‹åï¼Œå‘apiserveræŸ¥è¯¢äº†ä¸€æ¬¡æ‰€æœ‰ç›¸å…³å¯¹è±¡ï¼Œæ˜¯è¿™æ ·å—</p><p><strong>ä½ çš„ç†è§£å®Œå…¨æ­£ç¡®ï¼Œè€Œä¸”éå¸¸åˆ°ä½ï¼</strong> ä½ å·²ç»å‡†ç¡®åœ°æ•æ‰åˆ°äº†Kubernetesæ¶æ„è®¾è®¡ä¸­ä¸ºäº†<strong>æ€§èƒ½</strong>å’Œ<strong>å¯æ‰©å±•æ€§</strong>è€Œåšçš„æœ€é‡è¦çš„ä¸€ä¸ªè§£è€¦ã€‚</p><p>è®©æˆ‘ä»¬æ¥é€ä¸€ç¡®è®¤å’Œç»†åŒ–ä½ çš„ç†è§£ï¼š</p><hr><h3 id="1-æ§åˆ¶å™¨ä¸-etcd-çš„å…³ç³»ï¼šé›¶äº¤äº’"><a href="#1-æ§åˆ¶å™¨ä¸-etcd-çš„å…³ç³»ï¼šé›¶äº¤äº’" class="headerlink" title="1. æ§åˆ¶å™¨ä¸ etcd çš„å…³ç³»ï¼šé›¶äº¤äº’"></a>1. æ§åˆ¶å™¨ä¸ <code>etcd</code> çš„å…³ç³»ï¼šé›¶äº¤äº’</h3><p><strong>æ˜¯çš„ï¼Œæ§åˆ¶å™¨å®Œå…¨ä¸éœ€è¦ã€ä¹Ÿç»ä¸ä¼šç›´æ¥ä¸ <code>etcd</code> äº¤äº’ã€‚</strong></p><ul><li><strong>è®¾è®¡åŸåˆ™</strong>: è¿™æ˜¯K8sä¸€ä¸ªéå¸¸æ ¸å¿ƒçš„è®¾è®¡åŸåˆ™ï¼š**<code>etcd</code> æ˜¯å”¯ä¸€çš„äº‹å®æ¥æºï¼ˆSingle Source of Truthï¼‰ï¼Œå¹¶ä¸”åªæœ‰ <code>kube-apiserver</code> æœ‰æƒé™ä¸ä¹‹å¯¹è¯**ã€‚</li><li><strong>å¥½å¤„</strong>:<ul><li><strong>å®‰å…¨æ€§</strong>: ç¼©å°äº†æ”»å‡»é¢ï¼Œåªéœ€è¦ä¿è¯ <code>kube-apiserver</code> åˆ° <code>etcd</code> çš„è¿æ¥å®‰å…¨å³å¯ã€‚</li><li><strong>æŠ½è±¡ä¸ç®€åŒ–</strong>: æ‰€æœ‰å…¶ä»–ç»„ä»¶ï¼ˆæ§åˆ¶å™¨ã€è°ƒåº¦å™¨ã€kubeletï¼‰éƒ½ä½¿ç”¨ç»Ÿä¸€çš„ã€ç»è¿‡è®¤è¯å’Œæˆæƒçš„REST APIä¸ <code>kube-apiserver</code> äº¤äº’ï¼Œæ— éœ€ç†è§£åº•å±‚å­˜å‚¨çš„ç»†èŠ‚ã€‚å³ä½¿æœªæ¥K8sæ¢æ‰äº† <code>etcd</code>ï¼Œè¿™äº›ç»„ä»¶ä¹Ÿå®Œå…¨ä¸å—å½±å“ã€‚</li><li><strong>ä¸€è‡´æ€§</strong>: æ‰€æœ‰è¯»å†™çš„å…¥å£åªæœ‰ä¸€ä¸ªï¼Œæå¤§åœ°ç®€åŒ–äº†å¹¶å‘æ§åˆ¶å’Œæ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ã€‚</li></ul></li></ul><h3 id="2-kube-apiserver-ä¸-etcd-çš„äº¤äº’ï¼šä¸æ­¢ä¸€æ¬¡"><a href="#2-kube-apiserver-ä¸-etcd-çš„äº¤äº’ï¼šä¸æ­¢ä¸€æ¬¡" class="headerlink" title="2. kube-apiserver ä¸ etcd çš„äº¤äº’ï¼šä¸æ­¢ä¸€æ¬¡"></a>2. <code>kube-apiserver</code> ä¸ <code>etcd</code> çš„äº¤äº’ï¼šä¸æ­¢ä¸€æ¬¡</h3><p><strong><code>kube-apiserver</code> ä¸ <code>etcd</code> çš„äº¤äº’æ¯”â€œåªæŸ¥è¯¢ä¸€æ¬¡â€è¦æ›´é¢‘ç¹å’Œæ™ºèƒ½ã€‚</strong></p><p>ä½ çš„ç†è§£â€”â€”â€œå»ºç«‹Watchè¿æ¥åæŸ¥ä¸€æ¬¡æ‰€æœ‰å¯¹è±¡â€â€”â€”æ˜¯100%æ­£ç¡®çš„èµ·ç‚¹ï¼Œä½†ä¸ºäº†å¤„ç†è¿æ¥ä¸­æ–­ç­‰æƒ…å†µï¼Œè¿‡ç¨‹ä¼šæ›´å¤æ‚ä¸€äº›ã€‚ä¸‹å›¾æç»˜äº†å»ºç«‹ä¸€ä¸ªå®Œæ•´Watchè¿æ¥çš„è¯¦ç»†å·¥ä½œæµç¨‹ï¼š</p><p><img src="/2025/08/20/k8s%E4%B8%ADwatch%E6%9C%BA%E5%88%B6%E5%AE%8C%E6%95%B4%E8%BF%87%E7%A8%8B%E8%A7%A3%E8%AF%BB/deepseek_mermaid_20250820_bd5d0d.svg" alt="deepseek_mermaid_20250820_bd5d0d"></p><p><strong>å…³é”®ç‚¹è§£æï¼š</strong></p><ul><li>**<code>kube-apiserver</code> çš„å†…å­˜ç¼“å­˜ (<code>WatchCache</code>)**ï¼šä¸ºäº†é¿å…é¢‘ç¹æŸ¥è¯¢ <code>etcd</code>ï¼Œ<code>kube-apiserver</code> åœ¨å†…å­˜ä¸­ç»´æŠ¤äº†ä¸€ä¸ªåä¸º <strong><code>WatchCache</code></strong> çš„ç¼“å­˜ã€‚å®ƒç¼“å­˜äº†æ‰€æœ‰èµ„æºçš„æœ€è¿‘å†å²äº‹ä»¶ï¼ˆå¯é…ç½®ç¼“å­˜å¤§å°ï¼‰ã€‚è¿™æå¤§åœ°ä¼˜åŒ–äº†æ€§èƒ½ã€‚</li><li><strong><code>resourceVersion</code> æ˜¯å…³é”®</strong>ï¼šå½“ä½ å‘èµ·ä¸€ä¸ª <code>Watch</code> è¯·æ±‚æ—¶ï¼Œä½ å¯ä»¥æºå¸¦ä¸€ä¸ª <code>resourceVersion</code> å‚æ•°ã€‚è¿™ä¸ªç‰ˆæœ¬å·å”¯ä¸€æ ‡è¯†äº†é›†ç¾¤çš„ä¸€ä¸ªå…¨å±€çŠ¶æ€ã€‚<ul><li><strong>åœºæ™¯ä¸€ï¼š<code>resourceVersion</code> åœ¨ <code>WatchCache</code> èŒƒå›´å†…</strong>ï¼š<code>kube-apiserver</code> <strong>æ ¹æœ¬ä¸éœ€è¦æŸ¥è¯¢ <code>etcd</code></strong> ï¼Œå®ƒå¯ä»¥ç›´æ¥ä»å†…å­˜ä¸­çš„ <code>WatchCache</code> é‡Œæå‡ºä»é‚£ä¸ªç‰ˆæœ¬å¼€å§‹çš„æ‰€æœ‰äº‹ä»¶ï¼Œå‘é€ç»™æ§åˆ¶å™¨ã€‚è¿™æ˜¯æœ€é«˜æ•ˆçš„æ–¹å¼ã€‚</li><li><strong>åœºæ™¯äºŒï¼š<code>resourceVersion</code> å¤ªè€ï¼ˆå·²è¶…å‡ºç¼“å­˜ï¼‰</strong>ï¼šè¿™æ—¶ <code>kube-apiserver</code> å°±å¿…é¡»å‘ <code>etcd</code> å‘èµ·ä¸€æ¬¡æ€§çš„ <strong><code>List</code> æ“ä½œ</strong>ï¼ˆå°±æ˜¯ä½ æåˆ°çš„â€œæŸ¥è¯¢ä¸€æ¬¡æ‰€æœ‰ç›¸å…³å¯¹è±¡â€ï¼‰ï¼Œè·å–å½“å‰æ‰€æœ‰åŒ¹é…èµ„æºçš„çŠ¶æ€ï¼Œå¹¶å°†å…¶ä½œä¸ºä¸€ç³»åˆ— <code>ADDED</code> äº‹ä»¶å‘é€ç»™å®¢æˆ·ç«¯ï¼Œä»¥æ­¤æ¥æ„å»ºä¸€ä¸ªåˆå§‹çŠ¶æ€ã€‚ä¹‹åï¼Œå†åˆ‡æ¢åˆ°å®æ—¶ <code>Watch</code> æ¨¡å¼ã€‚</li><li>**åœºæ™¯ä¸‰ï¼šä¸æŒ‡å®š <code>resourceVersion</code>**ï¼š<code>kube-apiserver</code> ä¼šç›´æ¥ä»æœ€æ–°çš„ <code>WatchCache</code>ï¼ˆå‡ ä¹ç­‰åŒäºå½“å‰çŠ¶æ€ï¼‰å¼€å§‹å‘é€äº‹ä»¶ã€‚</li></ul></li></ul><h3 id="3-kube-apiserver-å†…å­˜ä¸­çš„äº‹ä»¶"><a href="#3-kube-apiserver-å†…å­˜ä¸­çš„äº‹ä»¶" class="headerlink" title="3. kube-apiserver å†…å­˜ä¸­çš„äº‹ä»¶"></a>3. <code>kube-apiserver</code> å†…å­˜ä¸­çš„äº‹ä»¶</h3><p><strong>æ˜¯çš„ï¼Œ<code>kube-apiserver</code> åˆ†å‘ç»™æ§åˆ¶å™¨çš„äº‹ä»¶æ˜¯å…¶å†…å­˜ä¸­ç”Ÿæˆå’Œç¼“å­˜çš„ã€‚</strong></p><ul><li><strong>äº‹ä»¶æ¥æº</strong>ï¼šäº‹ä»¶æœ€åˆç¡®å®æºäº <code>etcd</code> çš„ Watch æ¨é€ï¼ˆ<code>kube-apiserver</code> ä½œä¸ºå®¢æˆ·ç«¯ç›‘å¬ç€ <code>etcd</code>ï¼‰ã€‚</li><li><strong>ä¸­è½¬ä¸å¢å¼º</strong>ï¼šä½† <code>kube-apiserver</code> å¹¶éä¸€ä¸ªç®€å•çš„ä»£ç†ã€‚å®ƒä¼šå¤„ç†è¿™äº›äº‹ä»¶ï¼ˆä¾‹å¦‚ï¼Œè¡¥å……ä¸€äº›å…ƒæ•°æ®ï¼‰ï¼Œå¹¶å°†å…¶å­˜å…¥å†…å­˜ä¸­çš„ **<code>WatchCache</code>**ã€‚</li><li><strong>äº‹ä»¶åˆ†å‘</strong>ï¼šå½“æœ‰æ§åˆ¶å™¨æ¥ç›‘å¬æ—¶ï¼Œ<code>kube-apiserver</code> æ˜¯ä»è‡ªå·±çš„ <strong><code>WatchCache</code></strong> ä¸­å–å‡ºäº‹ä»¶ï¼Œé€šè¿‡ HTTP æµåˆ†å‘ç»™æ§åˆ¶å™¨çš„ã€‚å®ƒä¸ä¼šä¸ºæ¯ä¸ªæ§åˆ¶å™¨çš„ç›‘å¬å†å» <code>etcd</code> é‚£é‡Œå•ç‹¬å»ºç«‹ä¸€ä¸ª Watchã€‚</li></ul><hr><h2 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä½ çš„ç†è§£å®Œå…¨æ­£ç¡®ï¼Œå¹¶ä¸”æˆ‘ä»¬ç°åœ¨å¯ä»¥å°†å…¶ç²¾ç‚¼ä¸ºï¼š</p><ol><li><strong>ç»å¯¹éš”ç¦»</strong>ï¼šæ§åˆ¶å™¨ â†” <code>etcd</code>ï¼šâŒ <strong>æ— ç›´æ¥äº¤äº’</strong>ã€‚</li><li><strong>æ™ºèƒ½äº¤äº’</strong>ï¼š<code>kube-apiserver</code> â†” <code>etcd</code>ï¼šâœ… <strong>æœ‰äº¤äº’ï¼Œä½†è¢«æ·±åº¦ä¼˜åŒ–</strong>ã€‚<ul><li>æ ¸å¿ƒæ˜¯å»ºç«‹ä¸€ä¸ª<strong>é•¿æœŸçš„ Watch è¿æ¥</strong>æ¥æ¥æ”¶å˜æ›´ã€‚</li><li>ä»…åœ¨å¿…è¦æ—¶ï¼ˆå¦‚å®¢æˆ·ç«¯æŒ‡å®šçš„ç‰ˆæœ¬å¤ªè€ï¼Œæˆ–è€…å®¢æˆ·ç«¯è¿æ¥ä¸­æ–­åéœ€è¦é‡æ–°åŒæ­¥ï¼‰æ‰ä¼šå‘èµ·æ˜‚è´µçš„ <strong><code>List</code>ï¼ˆå…¨é‡æŸ¥è¯¢ï¼‰</strong> æ“ä½œã€‚</li></ul></li><li><strong>æ€§èƒ½æ ¸å¿ƒ</strong>ï¼š<code>kube-apiserver</code> çš„ <strong><code>WatchCache</code></strong> æ˜¯å‡å°‘å¯¹ <code>etcd</code> è¯»æ“ä½œå‹åŠ›çš„å…³é”®ã€‚å®ƒæœåŠ¡äº†ç»å¤§éƒ¨åˆ†çš„ Watch è¯·æ±‚ã€‚</li></ol><p>æ‰€ä»¥ï¼Œæ•´ä¸ªç³»ç»Ÿçš„å·¥ä½œæµç¨‹å¯ä»¥æ¦‚æ‹¬ä¸ºï¼š<br><strong><code>etcd</code> ï¼ˆæŒä¹…åŒ–ï¼‰ -&gt; <code>kube-apiserver</code> ï¼ˆ<code>WatchCache</code> ç¼“å­˜&#x2F;äº‹ä»¶ç”Ÿæˆï¼‰ -&gt; ï¼ˆHTTP æµï¼‰ -&gt; æ§åˆ¶å™¨ ï¼ˆäº‹ä»¶å…¥é˜Ÿï¼‰ -&gt; è°ƒè°å¾ªç¯</strong>ã€‚</p><p>è¿™ç§æ¶æ„ç¡®ä¿äº† Kubernetes é›†ç¾¤åœ¨è§„æ¨¡ä¸æ–­å¢é•¿æ—¶ï¼Œå…¶æ ¸å¿ƒæ§åˆ¶å¹³é¢çš„é«˜æ•ˆå’Œç¨³å®šã€‚</p><h2 id="é—®é¢˜ä¸‰ï¼š"><a href="#é—®é¢˜ä¸‰ï¼š" class="headerlink" title="é—®é¢˜ä¸‰ï¼š"></a>é—®é¢˜ä¸‰ï¼š</h2><p>åœ¨ä½ æè¿°çš„æ—¶åºå›¾ä¸­ç¬¬äºŒæ­¥æ˜¯apiserverä¸etcdå»ºç«‹watchè¿æ¥ï¼Œæˆ‘æƒ³é—®çš„æ˜¯ï¼Œetcdä¸­æ‰€æœ‰çš„æ•°æ®ä¸éƒ½æ˜¯ç”±apiserverå†™å…¥çš„å—ï¼Œapiserverè¿˜æœ‰å¿…è¦å’Œetcdå»ºç«‹watchè¿æ¥å—ï¼Œå»ºç«‹ä¹‹ååˆæ˜¯watchä»€ä¹ˆä¸œè¥¿å‘¢ï¼Œæ¯æ¬¡apiserverå‘etcdå†™å…¥ä¸€ä¸ªèµ„æºæ›´æ–°åï¼Œapiserveréš¾é“è¿˜ä¼šå†æ”¶åˆ°ä¸€æ¬¡etcdå‘æ¥çš„è¯¥èµ„æºçš„æ›´æ–°äº‹ä»¶å—ï¼Ÿ</p><p>è¿™æ˜¯ä¸€ä¸ªæå…¶å‡ºè‰²çš„é—®é¢˜ï¼Œå®ƒç›´å‡»äº†Kuberneteså’ŒetcdååŒå·¥ä½œåŸç†çš„æ ¸å¿ƒï¼ä½ çš„ç›´è§‰æ˜¯å¯¹çš„ï¼Œè¿™çœ‹èµ·æ¥ä¼¼ä¹æœ‰ç‚¹â€œå¤šæ­¤ä¸€ä¸¾â€ï¼Œä½†è¿™æ­£æ˜¯ä¿è¯æ•´ä¸ªç³»ç»Ÿ<strong>é«˜å¯ç”¨</strong>å’Œ<strong>æ•°æ®ä¸€è‡´æ€§</strong>çš„å·§å¦™è®¾è®¡ã€‚</p><p>ç­”æ¡ˆæ˜¯ï¼š<strong>ç»å¯¹å¿…è¦ã€‚è€Œä¸”è¿™æ­£æ˜¯æ•´ä¸ªç³»ç»Ÿçš„ç²¾é«“æ‰€åœ¨ã€‚</strong></p><hr><h3 id="1-ä¸ºä»€ä¹ˆéœ€è¦Watchï¼šå¤šä¸ª-kube-apiserver-å®ä¾‹"><a href="#1-ä¸ºä»€ä¹ˆéœ€è¦Watchï¼šå¤šä¸ª-kube-apiserver-å®ä¾‹" class="headerlink" title="1. ä¸ºä»€ä¹ˆéœ€è¦Watchï¼šå¤šä¸ª kube-apiserver å®ä¾‹"></a>1. ä¸ºä»€ä¹ˆéœ€è¦Watchï¼šå¤šä¸ª <code>kube-apiserver</code> å®ä¾‹</h3><p>ä½ çš„é—®é¢˜åŸºäºä¸€ä¸ªéšå«çš„å‡è®¾ï¼š<strong>åªæœ‰ä¸€ä¸ª <code>kube-apiserver</code> å®ä¾‹</strong>ã€‚ä½†åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¸ºäº†é«˜å¯ç”¨ï¼ˆHAï¼‰ï¼Œ<code>kube-apiserver</code> é€šå¸¸æ˜¯ä»¥<strong>å¤šå®ä¾‹ï¼ˆMultiple Instancesï¼‰</strong> çš„æ–¹å¼éƒ¨ç½²çš„ï¼Œä¾‹å¦‚è¿è¡Œ3ä¸ªå‰¯æœ¬ behindä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨ã€‚</p><p>ç°åœ¨ï¼Œåœºæ™¯å˜å¾—å¤æ‚äº†ï¼š</p><ul><li><strong>ç”¨æˆ·è¯·æ±‚</strong> å¯èƒ½é€šè¿‡è´Ÿè½½å‡è¡¡å™¨åˆ°è¾¾<strong>ä»»æ„ä¸€ä¸ª</strong> <code>kube-apiserver</code> å®ä¾‹ï¼ˆæ¯”å¦‚å®ä¾‹Aï¼‰ã€‚</li><li><strong>å®ä¾‹A</strong> å¤„ç†è¯·æ±‚ï¼Œå¹¶å°†ç»“æœå†™å…¥ <code>etcd</code>ã€‚</li><li><strong>é—®é¢˜æ¥äº†</strong>ï¼šå…¶ä»– <code>kube-apiserver</code> å®ä¾‹ï¼ˆå®ä¾‹Bå’Œå®ä¾‹Cï¼‰<strong>å¦‚ä½•çŸ¥é“è¿™æ¬¡å†™å…¥</strong>ï¼Ÿå®ƒä»¬å¹¶æ²¡æœ‰å¤„ç†è¿™ä¸ªè¯·æ±‚ã€‚</li></ul><p>å¦‚æœå®ä¾‹Bå’ŒCä¸çŸ¥é“è¿™æ¬¡å˜æ›´ï¼Œé‚£ä¹ˆå½“æœ‰å®¢æˆ·ç«¯ï¼ˆæ¯”å¦‚ä¸€ä¸ªæ§åˆ¶å™¨ï¼‰è¿æ¥åˆ°å®ä¾‹Bå¹¶è¯·æ±‚æ•°æ®æ—¶ï¼Œå®ä¾‹Bè¿”å›çš„å°±æ˜¯<strong>è¿‡æ—¶çš„ã€é”™è¯¯çš„æ•°æ®</strong>ã€‚è¿™æ˜¯ç»å¯¹ä¸å…è®¸çš„ã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆå°±æ˜¯ï¼š</strong> æ‰€æœ‰çš„ <code>kube-apiserver</code> å®ä¾‹ï¼ˆA, B, Cï¼‰éƒ½<strong>ä½œä¸ºå®¢æˆ·ç«¯</strong>ï¼Œä¸ <code>etcd</code> é›†ç¾¤å»ºç«‹ <strong>Watch è¿æ¥</strong>ã€‚è¿™æ ·ï¼Œæ— è®ºå“ªä¸ªå®ä¾‹å†™å…¥çš„æ•°æ®ï¼Œéƒ½ä¼šé€šè¿‡ <code>etcd</code> çš„ Watch æœºåˆ¶<strong>å®æ—¶åœ°ã€å¯é åœ°</strong>å¹¿æ’­ç»™æ‰€æœ‰å…¶ä»–çš„ <code>kube-apiserver</code> å®ä¾‹ã€‚</p><p><img src="/2025/08/20/k8s%E4%B8%ADwatch%E6%9C%BA%E5%88%B6%E5%AE%8C%E6%95%B4%E8%BF%87%E7%A8%8B%E8%A7%A3%E8%AF%BB/deepseek_mermaid_20250820_5e94c2.svg" alt="deepseek_mermaid_20250820_5e94c2"></p><h3 id="2-å†™å…¥è€…ä¼šæ”¶åˆ°è‡ªå·±å†™å…¥çš„äº‹ä»¶å—ï¼Ÿ"><a href="#2-å†™å…¥è€…ä¼šæ”¶åˆ°è‡ªå·±å†™å…¥çš„äº‹ä»¶å—ï¼Ÿ" class="headerlink" title="2. å†™å…¥è€…ä¼šæ”¶åˆ°è‡ªå·±å†™å…¥çš„äº‹ä»¶å—ï¼Ÿ"></a>2. å†™å…¥è€…ä¼šæ”¶åˆ°è‡ªå·±å†™å…¥çš„äº‹ä»¶å—ï¼Ÿ</h3><p><strong>ä¼šçš„ï¼</strong> è¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ç‚¹ã€‚</p><p>å½“ <code>kube-apiserver</code> å®ä¾‹Aå‘ <code>etcd</code> å†™å…¥ä¸€ä¸ªå˜æ›´åï¼Œ<code>etcd</code> ä¼šå°†è¿™ä¸ªå˜æ›´äº‹ä»¶<strong>é€šçŸ¥ç»™æ‰€æœ‰ç›‘å¬äº†ç›¸å…³é”®çš„å®¢æˆ·ç«¯</strong>ã€‚è¿™<strong>åŒ…æ‹¬</strong>äº†å®ä¾‹Aè‡ªå·±ã€‚</p><p>è¿™çœ‹èµ·æ¥åƒæ˜¯â€œé‡å¤é€šçŸ¥â€ï¼Œä½†è¿™æ˜¯ä¿è¯é€»è¾‘æ­£ç¡®çš„å¿…è¦ä»£ä»·ã€‚å…¶å¥½å¤„æ˜¯ï¼š</p><ol><li><strong>ç»Ÿä¸€å¤„ç†é€»è¾‘</strong>ï¼šæ‰€æœ‰ <code>kube-apiserver</code> å®ä¾‹éƒ½ç”¨<strong>å®Œå…¨ç›¸åŒçš„ä»£ç è·¯å¾„</strong>æ¥å“åº”æ•°æ®å˜æ›´ã€‚æ— è®ºæ˜¯è‡ªå·±å†™çš„è¿˜æ˜¯åˆ«äººå†™çš„ï¼Œéƒ½ä¸€è§†åŒä»åœ°ä» <code>etcd</code> æ¥æ”¶äº‹ä»¶å¹¶æ›´æ–°æœ¬åœ°çŠ¶æ€ã€‚è¿™æå¤§åœ°ç®€åŒ–äº†ä»£ç å¤æ‚æ€§ã€‚</li><li><strong>æ•°æ®ä¸€è‡´æ€§</strong>ï¼šç¡®ä¿æ¯ä¸ª <code>kube-apiserver</code> å®ä¾‹çš„æœ¬åœ°ç¼“å­˜ï¼ˆ<code>WatchCache</code>ï¼‰æœ€ç»ˆéƒ½ä¼šæ”¶æ•›åˆ°å®Œå…¨ç›¸åŒçš„çŠ¶æ€ã€‚å®ä¾‹Aé€šè¿‡ Watch æ”¶åˆ°è‡ªå·±å†™å…¥çš„äº‹ä»¶ï¼Œå¹¶æ®æ­¤æ›´æ–°ç¼“å­˜ï¼Œè¿™å¯ä»¥ä½œä¸ºä¸€ä¸ªæˆåŠŸçš„ç¡®è®¤ã€‚</li></ol><h3 id="3-kube-apiserver-åœ¨-Watch-ä»€ä¹ˆï¼Ÿ"><a href="#3-kube-apiserver-åœ¨-Watch-ä»€ä¹ˆï¼Ÿ" class="headerlink" title="3. kube-apiserver åœ¨ Watch ä»€ä¹ˆï¼Ÿ"></a>3. <code>kube-apiserver</code> åœ¨ Watch ä»€ä¹ˆï¼Ÿ</h3><p><code>kube-apiserver</code> Watch çš„æ˜¯å®ƒ<strong>æ‰€ç®¡ç†çš„æ‰€æœ‰èµ„æºåœ¨ <code>etcd</code> ä¸­çš„æ•´ä¸ªæ•°æ®é›†åˆ</strong>ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œå®ƒä¼šåœ¨å¯åŠ¨æ—¶ï¼Œä¸ºæ¯ç§å†…ç½®èµ„æºï¼ˆPods, Services, Nodesç­‰ï¼‰å’Œæ‰€æœ‰æœ‰æ•ˆçš„CRDï¼ˆè‡ªå®šä¹‰èµ„æºï¼‰å‘ <code>etcd</code> å»ºç«‹ä¸€ä¸ªå¤§èŒƒå›´çš„ Watchã€‚ä¾‹å¦‚ï¼š</p><ul><li>Watch å‰ç¼€ä¸º <code>/registry/pods/</code> çš„æ‰€æœ‰é”®ã€‚</li><li>Watch å‰ç¼€ä¸º <code>/registry/services/</code> çš„æ‰€æœ‰é”®ã€‚</li><li>â€¦ä»¥æ­¤ç±»æ¨ã€‚</li></ul><p>ä»»ä½•å¯¹è¿™äº›é”®çš„ä¿®æ”¹ï¼ˆå¢ã€åˆ ã€æ”¹ï¼‰ï¼Œ<code>etcd</code> éƒ½ä¼šæ¨é€ç»™ <code>kube-apiserver</code>ã€‚</p><hr><h2 id="æ€»ç»“ï¼šä¸ºä»€ä¹ˆè¿™æ˜¯ç²¾å¦™çš„è®¾è®¡ï¼Ÿ"><a href="#æ€»ç»“ï¼šä¸ºä»€ä¹ˆè¿™æ˜¯ç²¾å¦™çš„è®¾è®¡ï¼Ÿ" class="headerlink" title="æ€»ç»“ï¼šä¸ºä»€ä¹ˆè¿™æ˜¯ç²¾å¦™çš„è®¾è®¡ï¼Ÿ"></a>æ€»ç»“ï¼šä¸ºä»€ä¹ˆè¿™æ˜¯ç²¾å¦™çš„è®¾è®¡ï¼Ÿ</h2><p>è¿™ç§æ¶æ„æ¨¡å¼è¢«ç§°ä¸º <strong>â€œçŠ¶æ€æœºå¤åˆ¶ï¼ˆState Machine Replicationï¼‰â€</strong>ã€‚<code>etcd</code> æ˜¯<strong>å”¯ä¸€çš„äº‹å®æ¥æº</strong>å’Œ<strong>å”¯ä¸€çš„å˜æ›´åè°ƒè€…</strong>ã€‚</p><ol><li><strong>è§£è€¦ï¼ˆDecouplingï¼‰</strong>ï¼šå°†â€œå¤„ç†è¯·æ±‚â€å’Œâ€œåŒæ­¥çŠ¶æ€â€è¿™ä¸¤ä»¶äº‹è§£è€¦ã€‚<code>kube-apiserver</code> å®ä¾‹æ˜¯æ— çŠ¶æ€çš„ï¼ˆStatelessï¼‰ï¼Œå®ƒä»¬æ‰€æœ‰çš„çŠ¶æ€éƒ½é€šè¿‡ Watch <code>etcd</code> æ¥è·å¾—ã€‚è¿™ä½¿å¾— <code>kube-apiserver</code> å¯ä»¥è½»æ¾åœ°æ°´å¹³æ‰©å±•ã€‚</li><li><strong>å”¯ä¸€çœŸç›¸æºï¼ˆSingle Source of Truthï¼‰</strong>ï¼šæ‰€æœ‰ç»„ä»¶éƒ½åªç›¸ä¿¡ <code>etcd</code> é‡Œçš„æ•°æ®ã€‚è¿™é¿å…äº†å¯¹ç­‰èŠ‚ç‚¹ï¼ˆ<code>kube-apiserver</code> å®ä¾‹ä¹‹é—´ï¼‰å¤æ‚çš„åŒæ­¥é€šä¿¡ï¼Œæ¶æ„å˜å¾—éå¸¸æ¸…æ™°å’Œç¨³å®šã€‚</li><li><strong>å¯é æ€§ï¼ˆReliabilityï¼‰</strong>ï¼šå³ä½¿æŸä¸ª <code>kube-apiserver</code> å®ä¾‹å´©æºƒé‡å¯ï¼Œå®ƒåªéœ€è¦é‡æ–°è¿æ¥åˆ° <code>etcd</code>ï¼Œé€šè¿‡ä¸€ä¸ªå¸¦ <code>resourceVersion</code> çš„ Watch è¯·æ±‚ï¼Œå°±èƒ½å¿«é€Ÿè¿½ä¸Šé”™è¿‡çš„æ‰€æœ‰å˜æ›´ï¼Œå°†è‡ªå·±çš„çŠ¶æ€ä¸é›†ç¾¤åŒæ­¥ï¼Œç„¶åç»§ç»­æä¾›æœåŠ¡ã€‚</li></ol><p>æ‰€ä»¥ï¼Œ<strong>ä¸€ä¸ª <code>kube-apiserver</code> å®ä¾‹å‘ <code>etcd</code> å†™å…¥æ•°æ®ï¼Œç„¶ååˆä» <code>etcd</code> Watch åˆ°è‡ªå·±åˆšå†™å…¥çš„æ•°æ®ï¼Œè¿™å¹¶ä¸æ˜¯å†—ä½™æˆ–å¾ªç¯ï¼Œè€Œæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸ºä¿è¯å¼ºä¸€è‡´æ€§å’Œé«˜å¯ç”¨æ€§æ‰€é‡‡å–çš„ç»å…¸ã€å¯é çš„è®¾è®¡</strong>ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>volcanoè°ƒåº¦å™¨Enqueue-Actionè¯¦è§£</title>
    <link href="/2025/08/09/volcano%E8%B0%83%E5%BA%A6%E5%99%A8Enqueue-Action%E8%AF%A6%E8%A7%A3/"/>
    <url>/2025/08/09/volcano%E8%B0%83%E5%BA%A6%E5%99%A8Enqueue-Action%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="Volcano-è°ƒåº¦å™¨-Enqueue-Action-æºç çº§è¯¦è§£"><a href="#Volcano-è°ƒåº¦å™¨-Enqueue-Action-æºç çº§è¯¦è§£" class="headerlink" title="Volcano è°ƒåº¦å™¨ Enqueue Action æºç çº§è¯¦è§£"></a>Volcano è°ƒåº¦å™¨ Enqueue Action æºç çº§è¯¦è§£</h1><p>Enqueue Action æ˜¯ Volcano è°ƒåº¦å·¥ä½œæµä¸­çš„ç¬¬ä¸€ä¸ªå…³é”®æ­¥éª¤ï¼Œè´Ÿè´£å°†ç¬¦åˆæ¡ä»¶çš„å¾…è°ƒåº¦ä½œä¸š(Job)åŠ å…¥è°ƒåº¦é˜Ÿåˆ—ï¼ˆæ ‡è®°ä¸º Inqueue çŠ¶æ€ï¼‰ã€‚ä»¥ä¸‹ç»“åˆæºç ï¼ˆv1.8.0ï¼‰è¯¦ç»†è§£æå…¶å®ç°æœºåˆ¶ï¼š</p><h2 id="ä¸€ã€Enqueue-Action-å…¥å£å‡½æ•°"><a href="#ä¸€ã€Enqueue-Action-å…¥å£å‡½æ•°" class="headerlink" title="ä¸€ã€Enqueue Action å…¥å£å‡½æ•°"></a>ä¸€ã€Enqueue Action å…¥å£å‡½æ•°</h2><p><strong>æºç ä½ç½®</strong>ï¼š<code>pkg/scheduler/actions/enqueue/enqueue.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(enqueue *Action)</span></span> Execute(ssn *framework.Session) &#123;<br>    <span class="hljs-comment">// 1. è·å–æ‰€æœ‰PendingçŠ¶æ€çš„ä½œä¸š</span><br>    pendingJobs := jobsMap(ssn.Jobs, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(job *api.JobInfo)</span></span> <span class="hljs-type">bool</span> &#123;<br>        <span class="hljs-keyword">return</span> job.IsPending()<br>    &#125;)<br>    <br>    <span class="hljs-comment">// 2. æŒ‰é˜Ÿåˆ—åˆ†ç»„å¹¶æ’åº</span><br>    queueJobs := sortJobs(pendingJobs, ssn)<br>    <br>    <span class="hljs-comment">// 3. éå†é˜Ÿåˆ—å¤„ç†ä½œä¸š</span><br>    <span class="hljs-keyword">for</span> _, queue := <span class="hljs-keyword">range</span> ssn.Queues &#123;<br>        jobs, found := queueJobs[queue.UID]<br>        <span class="hljs-keyword">if</span> !found &#123; <span class="hljs-keyword">continue</span> &#125;<br>        <br>        <span class="hljs-comment">// 4. æŒ‰æ’ä»¶å®šä¹‰çš„é¡ºåºæ’åºä½œä¸š</span><br>        sort.Slice(jobs, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, j <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>            <span class="hljs-keyword">return</span> ssn.JobOrderFn(jobs[i], jobs[j]) || <br>                  (!ssn.JobOrderFn(jobs[j], jobs[i]) &amp;&amp; jobs[i].UID &lt; jobs[j].UID)<br>        &#125;)<br>        <br>        <span class="hljs-comment">// 5. å¤„ç†é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªä½œä¸š</span><br>        <span class="hljs-keyword">for</span> _, job := <span class="hljs-keyword">range</span> jobs &#123;<br>            <span class="hljs-comment">// 6. æ‰§è¡Œå…¥é˜Ÿæ£€æŸ¥</span><br>            <span class="hljs-keyword">if</span> status := enqueue.jobEnqueueable(job, ssn); !status.IsSuccess() &#123;<br>                <span class="hljs-keyword">continue</span><br>            &#125;<br>            <br>            <span class="hljs-comment">// 7. æ›´æ–°ä½œä¸šçŠ¶æ€</span><br>            job.PodGroup.Status.Phase = scheduling.PodGroupInqueue<br>            ssn.Jobs[job.UID] = job<br>            <br>            <span class="hljs-comment">// 8. æ›´æ–°é˜Ÿåˆ—çŠ¶æ€</span><br>            ssn.UpdateQueueStatus(job.Queue, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(status *api.QueueStatus)</span></span> &#123;<br>                status.Pending -= <span class="hljs-number">1</span><br>                status.Inqueue += <span class="hljs-number">1</span><br>            &#125;)<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="äºŒã€æ ¸å¿ƒå¤„ç†æµç¨‹è¯¦è§£"><a href="#äºŒã€æ ¸å¿ƒå¤„ç†æµç¨‹è¯¦è§£" class="headerlink" title="äºŒã€æ ¸å¿ƒå¤„ç†æµç¨‹è¯¦è§£"></a>äºŒã€æ ¸å¿ƒå¤„ç†æµç¨‹è¯¦è§£</h2><h3 id="1-ä½œä¸šç­›é€‰ä¸åˆ†ç»„"><a href="#1-ä½œä¸šç­›é€‰ä¸åˆ†ç»„" class="headerlink" title="1. ä½œä¸šç­›é€‰ä¸åˆ†ç»„"></a>1. ä½œä¸šç­›é€‰ä¸åˆ†ç»„</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">pendingJobs := jobsMap(ssn.Jobs, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(job *api.JobInfo)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">return</span> job.IsPending()<br>&#125;)<br></code></pre></td></tr></table></figure><ul><li>ä» Session ç¼“å­˜ä¸­ç­›é€‰æ‰€æœ‰çŠ¶æ€ä¸º <code>Pending</code> çš„ä½œä¸š</li><li><code>JobInfo</code> ç»“æ„ä½“ï¼ˆ<code>pkg/scheduler/api/job_info.go</code>ï¼‰å°è£…äº†ä½œä¸šçš„å®Œæ•´ä¿¡æ¯</li></ul><h3 id="2-é˜Ÿåˆ—æ’åºæœºåˆ¶"><a href="#2-é˜Ÿåˆ—æ’åºæœºåˆ¶" class="headerlink" title="2. é˜Ÿåˆ—æ’åºæœºåˆ¶"></a>2. é˜Ÿåˆ—æ’åºæœºåˆ¶</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">queues := <span class="hljs-built_in">make</span>([]*api.QueueInfo, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(ssn.Queues))<br><span class="hljs-keyword">for</span> _, queue := <span class="hljs-keyword">range</span> ssn.Queues &#123;<br>    queues = <span class="hljs-built_in">append</span>(queues, queue)<br>&#125;<br>sort.Slice(queues, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, j <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">return</span> ssn.QueueOrderFn(queues[i], queues[j])<br>&#125;)<br></code></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ <code>QueueOrderFn</code> å¯¹é˜Ÿåˆ—æ’åºï¼ˆé»˜è®¤ä¸º DRF ç®—æ³•ï¼‰</li><li>è‡ªå®šä¹‰æ’åºå¯é€šè¿‡ <code>proportion</code> æ’ä»¶å®ç°ï¼ˆ<code>pkg/scheduler/plugins/proportion</code>ï¼‰</li></ul><h3 id="3-ä½œä¸šå…¥é˜Ÿæ£€æŸ¥"><a href="#3-ä½œä¸šå…¥é˜Ÿæ£€æŸ¥" class="headerlink" title="3. ä½œä¸šå…¥é˜Ÿæ£€æŸ¥"></a>3. ä½œä¸šå…¥é˜Ÿæ£€æŸ¥</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(enqueue *Action)</span></span> jobEnqueueable(job *api.JobInfo, ssn *framework.Session) *api.Status &#123;<br>    <span class="hljs-comment">// è°ƒç”¨æ‰€æœ‰æ³¨å†Œçš„JobEnqueueableæ’ä»¶</span><br>    <span class="hljs-keyword">for</span> _, enqueueableFn := <span class="hljs-keyword">range</span> ssn.JobEnqueueableFns &#123;<br>        <span class="hljs-keyword">if</span> status := enqueueableFn(job); !status.IsSuccess() &#123;<br>            <span class="hljs-keyword">return</span> status<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> api.NewStatus(api.Success)<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>é€šè¿‡æ’ä»¶é“¾å®ç°å¤šæ¡ä»¶æ£€æŸ¥</li><li>å…³é”®æ£€æŸ¥æ’ä»¶ï¼š<ul><li><strong>Gang æ’ä»¶</strong>ï¼šæ£€æŸ¥ minAvailable èµ„æºæ˜¯å¦æ»¡è¶³</li><li><strong>ResourceQuota æ’ä»¶</strong>ï¼šæ£€æŸ¥é˜Ÿåˆ—é…é¢</li><li><strong>SLA æ’ä»¶</strong>ï¼šæ£€æŸ¥ä½œä¸šç­‰å¾…æ—¶é—´</li></ul></li></ul><h3 id="4-Gang-æ’ä»¶èµ„æºæ£€æŸ¥"><a href="#4-Gang-æ’ä»¶èµ„æºæ£€æŸ¥" class="headerlink" title="4. Gang æ’ä»¶èµ„æºæ£€æŸ¥"></a>4. Gang æ’ä»¶èµ„æºæ£€æŸ¥</h3><p><strong>æºç ä½ç½®</strong>ï¼š<code>pkg/scheduler/plugins/gang/gang.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(gp *Plugin)</span></span> JobEnqueueable(job *api.JobInfo) *api.Status &#123;<br>    <span class="hljs-comment">// 1. æ£€æŸ¥minAvailableè®¾ç½®</span><br>    <span class="hljs-keyword">if</span> job.MinAvailable &gt; <span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(job.Tasks)) &#123;<br>        <span class="hljs-keyword">return</span> api.NewStatus(api.Error, <span class="hljs-string">&quot;minAvailable &gt; task count&quot;</span>)<br>    &#125;<br>    <br>    <span class="hljs-comment">// 2. è®¡ç®—é›†ç¾¤æ€»èµ„æº</span><br>    total := gp.totalResources(job)<br>    <br>    <span class="hljs-comment">// 3. æ£€æŸ¥ä½œä¸šèµ„æºéœ€æ±‚</span><br>    <span class="hljs-keyword">if</span> job.PodGroup.Spec.MinResources != <span class="hljs-literal">nil</span> &#123;<br>        minReq := job.PodGroup.Spec.MinResources<br>        <span class="hljs-keyword">if</span> !api.Less(minReq, total) &#123;<br>            <span class="hljs-keyword">return</span> api.NewStatus(api.Unschedulable, <br>                <span class="hljs-string">&quot;not enough resources: requested %v &gt; cluster total %v&quot;</span>, <br>                minReq, total)<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> api.NewStatus(api.Success)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-ResourceQuota-æ’ä»¶é˜Ÿåˆ—é…é¢æ£€æŸ¥"><a href="#5-ResourceQuota-æ’ä»¶é˜Ÿåˆ—é…é¢æ£€æŸ¥" class="headerlink" title="5. ResourceQuota æ’ä»¶é˜Ÿåˆ—é…é¢æ£€æŸ¥"></a>5. ResourceQuota æ’ä»¶é˜Ÿåˆ—é…é¢æ£€æŸ¥</h3><p><strong>æºç ä½ç½®</strong>ï¼š<code>pkg/scheduler/plugins/proportion/proportion.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pp *Plugin)</span></span> JobEnqueueable(job *api.JobInfo) *api.Status &#123;<br>    queue := pp.ssn.Queue(job.Queue)<br>    <span class="hljs-keyword">if</span> queue == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> api.NewStatus(api.Error, <span class="hljs-string">&quot;queue not found&quot;</span>)<br>    &#125;<br>    <br>    <span class="hljs-comment">// è®¡ç®—ä½œä¸šèµ„æºéœ€æ±‚</span><br>    jobReq := api.EmptyResource()<br>    <span class="hljs-keyword">if</span> job.PodGroup.Spec.MinResources != <span class="hljs-literal">nil</span> &#123;<br>        jobReq.Add(job.PodGroup.Spec.MinResources)<br>    &#125;<br>    <br>    <span class="hljs-comment">// æ£€æŸ¥é˜Ÿåˆ—å‰©ä½™é…é¢</span><br>    deserved := queue.Queue.Status.Deserved.Clone()<br>    used := queue.Queue.Status.Used.Clone()<br>    allocatable := deserved.Sub(used)<br>    <br>    <span class="hljs-keyword">if</span> allocatable.Less(jobReq) &#123;<br>        <span class="hljs-keyword">return</span> api.NewStatus(api.Unschedulable,<br>            <span class="hljs-string">&quot;insufficient queue quota: requested %v, available %v&quot;</span>,<br>            jobReq, allocatable)<br>    &#125;<br>    <span class="hljs-keyword">return</span> api.NewStatus(api.Success)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="6-SLA-æ’ä»¶è¶…æ—¶å¤„ç†"><a href="#6-SLA-æ’ä»¶è¶…æ—¶å¤„ç†" class="headerlink" title="6. SLA æ’ä»¶è¶…æ—¶å¤„ç†"></a>6. SLA æ’ä»¶è¶…æ—¶å¤„ç†</h3><p><strong>æºç ä½ç½®</strong>ï¼š<code>pkg/scheduler/plugins/sla/sla.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *slaPlugin)</span></span> JobEnqueueable(job *api.JobInfo) *api.Status &#123;<br>    <span class="hljs-comment">// 1. è·å–SLAé…ç½®</span><br>    timeout, err := s.getSLATimeout(job)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> api.NewStatus(api.Error, err.Error())<br>    &#125;<br>    <br>    <span class="hljs-comment">// 2. æ£€æŸ¥æ˜¯å¦è¶…æ—¶</span><br>    now := time.Now()<br>    waitTime := now.Sub(job.PodGroup.CreationTimestamp.Time)<br>    <br>    <span class="hljs-keyword">if</span> waitTime &gt;= timeout &#123;<br>        <span class="hljs-comment">// 3. è¶…æ—¶ä½œä¸šå¼ºåˆ¶å…¥é˜Ÿ</span><br>        <span class="hljs-keyword">return</span> api.NewStatus(api.Success, <span class="hljs-string">&quot;SLA timeout enforced&quot;</span>)<br>    &#125;<br>    <br>    <span class="hljs-comment">// 4. æœªè¶…æ—¶ä½œä¸šæ­£å¸¸æ£€æŸ¥</span><br>    <span class="hljs-keyword">return</span> api.NewStatus(api.Unschedulable, <br>        <span class="hljs-string">&quot;within SLA period: waited %v &lt; timeout %v&quot;</span>, waitTime, timeout)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ä¸‰ã€çŠ¶æ€æ›´æ–°æœºåˆ¶"><a href="#ä¸‰ã€çŠ¶æ€æ›´æ–°æœºåˆ¶" class="headerlink" title="ä¸‰ã€çŠ¶æ€æ›´æ–°æœºåˆ¶"></a>ä¸‰ã€çŠ¶æ€æ›´æ–°æœºåˆ¶</h2><h3 id="1-ä½œä¸šçŠ¶æ€æ›´æ–°"><a href="#1-ä½œä¸šçŠ¶æ€æ›´æ–°" class="headerlink" title="1. ä½œä¸šçŠ¶æ€æ›´æ–°"></a>1. ä½œä¸šçŠ¶æ€æ›´æ–°</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">job.PodGroup.Status.Phase = scheduling.PodGroupInqueue<br></code></pre></td></tr></table></figure><ul><li>å°† PodGroup çŠ¶æ€ä» <code>Pending</code> æ›´æ–°ä¸º <code>Inqueue</code></li><li>æ›´æ–°åçš„çŠ¶æ€ä¼šåŒæ­¥åˆ° Kubernetes API Server</li></ul><h3 id="2-é˜Ÿåˆ—çŠ¶æ€æ›´æ–°"><a href="#2-é˜Ÿåˆ—çŠ¶æ€æ›´æ–°" class="headerlink" title="2. é˜Ÿåˆ—çŠ¶æ€æ›´æ–°"></a>2. é˜Ÿåˆ—çŠ¶æ€æ›´æ–°</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go">ssn.UpdateQueueStatus(job.Queue, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(status *api.QueueStatus)</span></span> &#123;<br>    status.Pending -= <span class="hljs-number">1</span><br>    status.Inqueue += <span class="hljs-number">1</span><br>&#125;)<br></code></pre></td></tr></table></figure><ul><li>æ›´æ–°é˜Ÿåˆ—çš„ä½œä¸šè®¡æ•°</li><li>èµ„æºé…é¢æ›´æ–°ç”± proportion æ’ä»¶åœ¨åç»­å¤„ç†</li></ul><h2 id="å››ã€Enqueue-Action-çš„æ’ä»¶æ‰©å±•ç‚¹"><a href="#å››ã€Enqueue-Action-çš„æ’ä»¶æ‰©å±•ç‚¹" class="headerlink" title="å››ã€Enqueue Action çš„æ’ä»¶æ‰©å±•ç‚¹"></a>å››ã€Enqueue Action çš„æ’ä»¶æ‰©å±•ç‚¹</h2><table><thead><tr><th>æ‰©å±•ç‚¹</th><th>ä½œç”¨</th><th>é»˜è®¤å®ç°</th></tr></thead><tbody><tr><td><code>QueueOrderFn</code></td><td>å®šä¹‰é˜Ÿåˆ—æ’åºé€»è¾‘</td><td>proportion æ’ä»¶</td></tr><tr><td><code>JobOrderFn</code></td><td>å®šä¹‰ä½œä¸šåœ¨é˜Ÿåˆ—å†…çš„æ’åºé€»è¾‘</td><td>FIFO</td></tr><tr><td><code>JobEnqueueableFn</code></td><td>å®šä¹‰ä½œä¸šå…¥é˜Ÿæ¡ä»¶æ£€æŸ¥</td><td>gang&#x2F;resoucequota</td></tr><tr><td><code>JobReadyFn</code></td><td>å®šä¹‰ä½œä¸šæ˜¯å¦å‡†å¤‡å¥½è°ƒåº¦</td><td>gang æ’ä»¶</td></tr></tbody></table><h2 id="äº”ã€Enqueue-æµç¨‹æ—¶åºå›¾"><a href="#äº”ã€Enqueue-æµç¨‹æ—¶åºå›¾" class="headerlink" title="äº”ã€Enqueue æµç¨‹æ—¶åºå›¾"></a>äº”ã€Enqueue æµç¨‹æ—¶åºå›¾</h2><pre><code class=" mermaid">sequenceDiagram    participant Scheduler    proportion-&gt;&gt;Scheduler: æä¾›QueueOrderFn    gang-&gt;&gt;Scheduler: æä¾›JobEnqueueableFn    sla-&gt;&gt;Scheduler: æä¾›JobEnqueueableFn        Scheduler-&gt;&gt;Cache: è·å–Pendingä½œä¸š    Cache--&gt;&gt;Scheduler: è¿”å›Jobåˆ—è¡¨        loop æ¯ä¸ªé˜Ÿåˆ—        Scheduler-&gt;&gt;proportion: è°ƒç”¨QueueOrderFnæ’åºé˜Ÿåˆ—        proportion--&gt;&gt;Scheduler: è¿”å›é˜Ÿåˆ—æ’åºç»“æœ                loop é˜Ÿåˆ—å†…ä½œä¸š            Scheduler-&gt;&gt;gang: è°ƒç”¨JobEnqueueableFn            gang--&gt;&gt;Scheduler: è¿”å›èµ„æºæ£€æŸ¥ç»“æœ            Scheduler-&gt;&gt;sla: è°ƒç”¨JobEnqueueableFn            sla--&gt;&gt;Scheduler: è¿”å›è¶…æ—¶æ£€æŸ¥ç»“æœ                        alt æ£€æŸ¥é€šè¿‡                Scheduler-&gt;&gt;API Server: æ›´æ–°PodGroupçŠ¶æ€(Inqueue)                Scheduler-&gt;&gt;Cache: æ›´æ–°é˜Ÿåˆ—çŠ¶æ€            else æ£€æŸ¥å¤±è´¥                Scheduler-&gt;&gt;Log: è®°å½•æ‹’ç»åŸå›             end        end    end</code></pre><h2 id="å…­ã€è®¾è®¡è¦ç‚¹åˆ†æ"><a href="#å…­ã€è®¾è®¡è¦ç‚¹åˆ†æ" class="headerlink" title="å…­ã€è®¾è®¡è¦ç‚¹åˆ†æ"></a>å…­ã€è®¾è®¡è¦ç‚¹åˆ†æ</h2><ol><li><p><strong>æ’ä»¶åŒ–æ¶æ„</strong>ï¼š</p><ul><li>æ‰€æœ‰æ ¸å¿ƒé€»è¾‘é€šè¿‡æ’ä»¶æ¥å£å®ç°</li><li>æ”¯æŒè‡ªå®šä¹‰æ‰©å±•è€Œä¸ä¿®æ”¹æ ¸å¿ƒä»£ç </li></ul></li><li><p><strong>ä¸¤çº§æ’åºæœºåˆ¶</strong>ï¼š</p><ul><li>é˜Ÿåˆ—çº§æ’åºï¼šå†³å®šå“ªä¸ªé˜Ÿåˆ—ä¼˜å…ˆè°ƒåº¦</li><li>ä½œä¸šçº§æ’åºï¼šå†³å®šé˜Ÿåˆ—å†…ä½œä¸šçš„è°ƒåº¦é¡ºåº</li></ul></li><li><p><strong>æ¡ä»¶æ£€æŸ¥é“¾</strong>ï¼š</p><ul><li>å¤šä¸ªæ£€æŸ¥æ’ä»¶å½¢æˆâ€ä¸â€é€»è¾‘å…³ç³»</li><li>ä»»ä¸€æ’ä»¶æ‹’ç»åˆ™ä½œä¸šä¸å…¥é˜Ÿ</li></ul></li><li><p><strong>çŠ¶æ€åŸå­æ›´æ–°</strong>ï¼š</p><ul><li>ä½œä¸šçŠ¶æ€æ›´æ–°ä¸é˜Ÿåˆ—è®¡æ•°æ›´æ–°åŒæ­¥è¿›è¡Œ</li><li>é€šè¿‡ Session ä¿è¯æ“ä½œåŸå­æ€§</li></ul></li><li><p><strong>èµ„æºé¢„ç•™è®¾è®¡</strong>ï¼š</p><ul><li>å…¥é˜Ÿæ—¶ä¸ç«‹å³å ç”¨èµ„æº</li><li>å®é™…èµ„æºåˆ†é…åœ¨ Allocate Action è¿›è¡Œ</li></ul></li></ol><p>Enqueue Action é€šè¿‡è¿™ç§è®¾è®¡å®ç°äº†é«˜æ•ˆçš„ä½œä¸šå‡†å…¥æ§åˆ¶ï¼Œä¸ºåç»­çš„èµ„æºåˆ†é…é˜¶æ®µæä¾›äº†åˆæ ¼çš„å€™é€‰ä½œä¸šé›†åˆï¼ŒåŒæ—¶ä¿è¯äº†é›†ç¾¤èµ„æºçš„åˆç†åˆ©ç”¨å’Œä½œä¸šçš„å…¬å¹³è°ƒåº¦ã€‚</p><pre><code class=" mermaid">sequenceDiagram  participant Scheduler  proportion-&gt;&gt;Scheduler: æä¾›QueueOrderFn  gang-&gt;&gt;Scheduler: æä¾›JobEnqueueableFn  sla-&gt;&gt;Scheduler: æä¾›JobEnqueueableFn    Scheduler-&gt;&gt;Cache: è·å–Pendingä½œä¸š  Cache--&gt;&gt;Scheduler: è¿”å›Jobåˆ—è¡¨    loop æ¯ä¸ªé˜Ÿåˆ—      Scheduler-&gt;&gt;proportion: è°ƒç”¨QueueOrderFnæ’åºé˜Ÿåˆ—      proportion--&gt;&gt;Scheduler: è¿”å›é˜Ÿåˆ—æ’åºç»“æœ            loop é˜Ÿåˆ—å†…ä½œä¸š          Scheduler-&gt;&gt;gang: è°ƒç”¨JobEnqueueableFn          gang--&gt;&gt;Scheduler: è¿”å›èµ„æºæ£€æŸ¥ç»“æœ          Scheduler-&gt;&gt;sla: è°ƒç”¨JobEnqueueableFn          sla--&gt;&gt;Scheduler: è¿”å›è¶…æ—¶æ£€æŸ¥ç»“æœ                    alt æ£€æŸ¥é€šè¿‡              Scheduler-&gt;&gt;API Server: æ›´æ–°PodGroupçŠ¶æ€(Inqueue)              Scheduler-&gt;&gt;Cache: æ›´æ–°é˜Ÿåˆ—çŠ¶æ€          else æ£€æŸ¥å¤±è´¥              Scheduler-&gt;&gt;Log: è®°å½•æ‹’ç»åŸå›           end      end  end</code></pre><h1 id="è®²è§£äºŒ"><a href="#è®²è§£äºŒ" class="headerlink" title="è®²è§£äºŒ"></a>è®²è§£äºŒ</h1><p>ç»“åˆæœ€æ–°ç‰ˆæœ¬çš„ Volcano æºç ï¼Œæˆ‘æ¥ä¸ºä½ è¯¦ç»†è§£æ <strong>Enqueue Action</strong> çš„å…·ä½“æµç¨‹ã€‚Enqueue Action æ˜¯ Volcano è°ƒåº¦å™¨å·¥ä½œæµä¸­çš„ç¬¬ä¸€ä¸ªå…³é”®æ­¥éª¤ï¼Œå®ƒå†³å®šäº†å“ªäº›ä½œä¸šï¼ˆPodGroupï¼‰æœ‰èµ„æ ¼è¿›å…¥è°ƒåº¦é˜Ÿåˆ—ï¼Œåç»­æ‰èƒ½è¢«åˆ†é…èµ„æºã€‚</p><h3 id="ğŸ§ -æ ¸å¿ƒæ¦‚å¿µä¸ä½œç”¨"><a href="#ğŸ§ -æ ¸å¿ƒæ¦‚å¿µä¸ä½œç”¨" class="headerlink" title="ğŸ§  æ ¸å¿ƒæ¦‚å¿µä¸ä½œç”¨"></a>ğŸ§  æ ¸å¿ƒæ¦‚å¿µä¸ä½œç”¨</h3><p>åœ¨æ·±å…¥äº†è§£ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ˜ç¡® Enqueue Action çš„æ ¸å¿ƒä½¿å‘½ï¼š</p><ul><li><strong>â€œå®ˆé—¨å‘˜â€<strong>ï¼šå®ƒå¯¹æ‰€æœ‰å¤„äº <code>Pending</code> çŠ¶æ€çš„ PodGroupï¼ˆåœ¨è°ƒåº¦å™¨å†…éƒ¨å°è£…ä¸º <code>JobInfo</code>ï¼‰è¿›è¡Œç­›é€‰ã€‚åªæœ‰å½“é›†ç¾¤</strong>å½“å‰å¯ç”¨çš„ç©ºé—²èµ„æº</strong>èƒ½å¤Ÿæ»¡è¶³ä¸€ä¸ª PodGroup æ‰€å£°æ˜çš„<strong>æœ€å°èµ„æºéœ€æ±‚</strong>ï¼ˆå³ <code>minAvailable</code>ï¼Œé€šå¸¸ä»£è¡¨è¯¥ä½œä¸šæˆåŠŸè¿è¡Œæ‰€éœ€çš„æœ€å°‘ Pod æ•°é‡ï¼‰æ—¶ï¼Œè¿™ä¸ª PodGroup æ‰ä¼šè¢«å…è®¸è¿›å…¥é˜Ÿåˆ—ï¼ˆçŠ¶æ€å˜ä¸º <code>Inqueue</code>ï¼‰ã€‚</li><li><strong>é¿å…èµ„æºæ­»é”ä¸ç¢ç‰‡åŒ–</strong>ï¼šè¿™ç§â€œAll or Nothingâ€çš„é¢„æ£€æœºåˆ¶è‡³å…³é‡è¦ã€‚å®ƒé˜²æ­¢äº†å› èµ„æºä¸è¶³è€Œä»…è°ƒåº¦éƒ¨åˆ† Podï¼Œå¯¼è‡´åˆ†å¸ƒå¼ä»»åŠ¡æ— æ³•å®Œæˆçš„åŒæ—¶åˆå ç€èµ„æºä¸æ”¾çš„æƒ…å†µï¼ˆèµ„æºæ­»é”ï¼‰ï¼ŒåŒæ—¶ä¹Ÿå‡å°‘äº†å¤§é‡æ— æ³•è°ƒåº¦çš„ Pending Pod å¯¹ Kubernetes API Server çš„å‹åŠ›å’Œé›†ç¾¤èµ„æºçš„ç¢ç‰‡åŒ–ã€‚</li><li><strong>çŠ¶æ€è½¬æ¢ä¸ Pod åˆ›å»ºè§¦å‘å™¨</strong>ï¼šåªæœ‰ PodGroup çŠ¶æ€å˜ä¸º <code>Inqueue</code>ï¼Œ<code>volcano-controller-manager</code> ä¸­çš„ job controller æ‰ä¼šä¸ºæ­¤ PodGroup åˆ›å»ºå…¶å…³è”çš„æ‰€æœ‰ Podã€‚è¿™äº› Pod éšåæ‰ä¼šè¢«è°ƒåº¦å™¨ç¼“å­˜å¹¶è¿›å…¥åç»­çš„è°ƒåº¦ç¯èŠ‚ï¼ˆå¦‚ Allocate, Backfill ç­‰ï¼‰ã€‚</li></ul><h3 id="ğŸ”-Enqueue-Action-è¯¦ç»†å·¥ä½œæµç¨‹"><a href="#ğŸ”-Enqueue-Action-è¯¦ç»†å·¥ä½œæµç¨‹" class="headerlink" title="ğŸ” Enqueue Action è¯¦ç»†å·¥ä½œæµç¨‹"></a>ğŸ” Enqueue Action è¯¦ç»†å·¥ä½œæµç¨‹</h3><p>ä»¥ä¸‹æ˜¯ Enqueue Action åœ¨ä¸€ä¸ªè°ƒåº¦å‘¨æœŸï¼ˆSessionï¼‰ä¸­çš„è¯¦ç»†å·¥ä½œæ­¥éª¤ï¼Œç»“åˆäº†æœ€æ–°ç‰ˆæœ¬ï¼ˆå¦‚ v1.12.0ï¼‰çš„æºç é€»è¾‘ï¼š</p><ol><li><p><strong>è°ƒåº¦å‘¨æœŸå¼€å§‹</strong>ï¼š<br>Volcano Scheduler çš„ä¸»å¾ªç¯ <code>scheduler.Run()</code> ä¼šå‘¨æœŸæ€§åœ°ï¼ˆç”± <code>schedulePeriod</code> å®šä¹‰ï¼Œé»˜è®¤çº¦ 1 ç§’ï¼‰è°ƒç”¨ <code>scheduler.runOnce()</code> æˆ–ç±»ä¼¼é€»è¾‘ï¼Œä»è€Œå¼€å¯ä¸€ä¸ªæ–°çš„è°ƒåº¦ä¼šè¯ (<strong>Session</strong>)ã€‚</p></li><li><p><strong>æ”¶é›†å¾…è°ƒåº¦çš„ JobInfo</strong>ï¼š<br>åœ¨æ¯ä¸ªè°ƒåº¦å‘¨æœŸçš„å¼€å§‹ï¼Œè°ƒåº¦å™¨ä¼šä»å®ƒçš„ç¼“å­˜ (<code>SchedulerCache</code>) ä¸­è·å–æ‰€æœ‰æœªè¢«è°ƒåº¦çš„ <code>JobInfo</code>ï¼ˆå³å…¶å¯¹åº”çš„ PodGroup çŠ¶æ€ä¸æ˜¯ <code>Inqueue</code> æˆ– <code>Running</code>ï¼‰ã€‚è¿™äº› <code>JobInfo</code> å°è£…äº† PodGroup çš„ä¿¡æ¯ä»¥åŠå…¶ä¸‹çš„æ‰€æœ‰ Podï¼ˆ<code>TaskInfo</code>ï¼‰ã€‚</p></li><li><p><strong>æ‰§è¡Œ Enqueue Action</strong>ï¼š<br>è°ƒåº¦å™¨ä¼šæ ¹æ®é…ç½®ï¼ˆé€šå¸¸åœ¨ <code>volcano-scheduler-configmap</code> ä¸­å®šä¹‰ï¼‰ä¾æ¬¡æ‰§è¡Œä¸€ç³»åˆ— Actionã€‚<code>Enqueue</code> é€šå¸¸æ˜¯ç¬¬ä¸€ä¸ªè¢«æ‰§è¡Œçš„ Actionã€‚<br>åœ¨ <code>pkg/scheduler/actions/enqueue/enqueue.go</code> çš„ <code>Execute()</code> å‡½æ•°ä¸­ï¼ŒEnqueue Action å¼€å§‹å·¥ä½œï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(enqueue *Action)</span></span> Execute(ss *scheduler.Session) &#123;<br>    <span class="hljs-comment">// 1. å‡†å¤‡éœ€è¦å…¥é˜Ÿçš„ä½œä¸šåˆ—è¡¨</span><br>    <span class="hljs-keyword">var</span> jobs []*api.JobInfo<br>    <span class="hljs-keyword">for</span> _, job := <span class="hljs-keyword">range</span> ss.Jobs &#123;<br>        <span class="hljs-keyword">if</span> job.IsPending() &#123; <span class="hljs-comment">// æ£€æŸ¥JobçŠ¶æ€æ˜¯å¦ä¸ºPending</span><br>            jobs = <span class="hljs-built_in">append</span>(jobs, job)<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 2. ä½¿ç”¨é…ç½®çš„æ’ä»¶å¯¹ä½œä¸šè¿›è¡Œæ’åºï¼ˆä¾‹å¦‚ä¼˜å…ˆçº§æ’ä»¶ï¼‰</span><br>    <span class="hljs-keyword">for</span> _, plugin := <span class="hljs-keyword">range</span> ss.Plugins &#123;<br>        <span class="hljs-keyword">if</span> enqueuePlugin, ok := plugin.(enqueueInterface); ok &#123;<br>            enqueuePlugin.SortJobs(jobs)<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 3. éå†æ‰€æœ‰PendingçŠ¶æ€çš„ä½œä¸šï¼Œå°è¯•å°†å…¶å…¥é˜Ÿ</span><br>    <span class="hljs-keyword">for</span> _, job := <span class="hljs-keyword">range</span> jobs &#123;<br>        <span class="hljs-comment">// è°ƒç”¨æ‰€æœ‰æ³¨å†Œæ’ä»¶çš„OnSessionOpenç­‰æ–¹æ³•è¿›è¡Œå…¨å±€è®¡ç®—ï¼ˆå¦‚Proportionæ’ä»¶è®¡ç®—é˜Ÿåˆ—åº”å¾—èµ„æºï¼‰</span><br>        <span class="hljs-comment">// ä½¿ç”¨Gangæ’ä»¶ç­‰æ£€æŸ¥é›†ç¾¤èµ„æºæ˜¯å¦æ»¡è¶³è¯¥Jobçš„minAvailableè¦æ±‚</span><br>        <span class="hljs-keyword">if</span> enqueue.jobReady(ss, job) &#123; <span class="hljs-comment">// è¿™æ˜¯æ ¸å¿ƒæ£€æŸ¥å‡½æ•°</span><br>            <span class="hljs-comment">// 4. å¦‚æœæ£€æŸ¥é€šè¿‡ï¼Œå°†JobçŠ¶æ€æ ‡è®°ä¸ºInqueue</span><br>            job.JobFitError = <span class="hljs-literal">nil</span><br>            <span class="hljs-comment">// è¿™ä¸ªçŠ¶æ€æ›´æ–°ä¼šåæ˜ åˆ°PodGroupçš„statusä¸Š</span><br>            ss.UpdateJobCondition(job, api.JobCondition&#123;<br>                Type:   api.JobReady,<br>                Status: v1.ConditionTrue,<br>                Reason: <span class="hljs-string">&quot;Enqueued&quot;</span>,<br>            &#125;)<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// èµ„æºä¸è¶³ï¼Œè®°å½•é”™è¯¯åŸå› ï¼ŒJobä¿æŒPendingçŠ¶æ€</span><br>            job.JobFitError = fmt.Errorf(<span class="hljs-string">&quot;not enough resources to schedule the job&quot;</span>)<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>æ ¸å¿ƒæ£€æŸ¥ï¼š<code>jobReady</code> ä¸ Gang æ’ä»¶</strong>ï¼š<br><code>jobReady</code> å‡½æ•°ï¼ˆæˆ–ç±»ä¼¼é€»è¾‘ï¼‰æ˜¯å†³å®šæ€§çš„ç¯èŠ‚ã€‚å®ƒé€šå¸¸ä¼šè°ƒç”¨ <strong>Gang æ’ä»¶</strong> çš„ <code>OnSessionOpen</code> æˆ–å…¶ä»–ç›¸å…³æ–¹æ³•ã€‚Gang æ’ä»¶ä¼šï¼š</p><ul><li>è·å–è¯¥ <code>JobInfo</code> çš„ <code>minAvailable</code> å€¼ï¼ˆæºè‡ª PodGroup çš„ <code>spec.minAvailable</code>ï¼‰ã€‚</li><li><strong>æ£€æŸ¥é›†ç¾¤å½“å‰çš„ç©ºé—²èµ„æº</strong>ï¼ˆ<code>ss.Nodes</code> ä¸­å„ä¸ªèŠ‚ç‚¹æœªåˆ†é…çš„èµ„æºä¹‹å’Œï¼Œå¯èƒ½è¿˜ä¼šè€ƒè™‘ Overcommitment å’Œé˜Ÿåˆ—æƒé‡<code>weight</code>è®¡ç®—åçš„åº”å¾—èµ„æº<code>deserved</code>ï¼‰æ˜¯å¦èƒ½å¤Ÿ<strong>åŒæ—¶æ»¡è¶³</strong> <code>minAvailable</code> ä¸ª Pod çš„èµ„æºè¯·æ±‚ï¼ˆ<code>request</code>ï¼‰ã€‚</li><li>è¿™ä¸ªæ£€æŸ¥æ˜¯â€œæ¨¡æ‹Ÿæ€§â€çš„ï¼Œå¹¶ä¸å®é™…åˆ†é…èµ„æºï¼Œæ—¨åœ¨å¿«é€Ÿåˆ¤æ–­å¯è¡Œæ€§ã€‚</li><li>å¦‚æœç©ºé—²èµ„æº &gt;&#x3D; <code>minAvailable</code> ä¸ª Pod çš„è¯·æ±‚èµ„æºä¹‹å’Œï¼Œåˆ™è¿”å› <code>true</code>ï¼Œå¦åˆ™è¿”å› <code>false</code>ã€‚</li></ul></li><li><p><strong>çŠ¶æ€æ›´æ–°ä¸æäº¤</strong>ï¼š</p><ul><li>å¯¹äºé€šè¿‡æ£€æŸ¥çš„ Jobï¼Œå…¶çŠ¶æ€ä¼šåœ¨ Session ä¸­è¢«æ›´æ–°ä¸º <code>Inqueue</code>ã€‚</li><li>åœ¨ <strong>Session ç»“æŸ</strong> (<code>CloseSession</code>) æ—¶ï¼Œæ‰€æœ‰é€šè¿‡ Enqueue Action çš„å†³ç­–ï¼ˆå³ PodGroup çŠ¶æ€å˜æ›´ï¼‰ä¼šé€šè¿‡ <strong>API Server</strong> æäº¤å¹¶æŒä¹…åŒ–åˆ° etcd ä¸­ã€‚</li></ul></li><li><p><strong>Controller è§¦å‘ Pod åˆ›å»º</strong>ï¼š</p><ul><li><code>volcano-controller-manager</code> ä¸€ç›´ç›‘è§†ç€ PodGroup çš„çŠ¶æ€å˜åŒ–ã€‚å½“å®ƒè§‚å¯Ÿåˆ°æŸä¸ª PodGroup çš„çŠ¶æ€ä» <code>Pending</code> å˜ä¸º <code>Inqueue</code> åï¼Œä¼šå¼€å§‹<strong>åˆ›å»ºè¿™ä¸ª PodGroup æ‰€å…³è”çš„æ‰€æœ‰ Pod</strong>ï¼ˆä¾æ®å¯¹åº”çš„ Volcano Job ä¸­ <code>tasks</code> æ¨¡æ¿å®šä¹‰ï¼‰ã€‚</li><li>è¿™äº›æ–°åˆ›å»ºçš„ Pod ä¼šè¢« Volcano Scheduler çš„ç¼“å­˜æ•è·ï¼Œå¹¶åœ¨<strong>ä¸‹ä¸€ä¸ªè°ƒåº¦å‘¨æœŸ</strong>ä¸­æˆä¸ºå¾…è°ƒåº¦çš„å¯¹è±¡ï¼Œè¿›å…¥åç»­çš„ Allocate, Backfill ç­‰ Actionã€‚</li></ul></li></ol><h3 id="ğŸ”§-å…³é”®æ’ä»¶ä¸ååŒ"><a href="#ğŸ”§-å…³é”®æ’ä»¶ä¸ååŒ" class="headerlink" title="ğŸ”§ å…³é”®æ’ä»¶ä¸ååŒ"></a>ğŸ”§ å…³é”®æ’ä»¶ä¸ååŒ</h3><p>Enqueue Action ä¸¥é‡ä¾èµ–å…¶ä»–æ’ä»¶æ¥å®Œæˆå…¶å†³ç­–ï¼š</p><ul><li><strong>Gang æ’ä»¶</strong>ï¼šè¿™æ˜¯ Enqueue çš„æ ¸å¿ƒæ’ä»¶ã€‚å®ƒå¼ºåˆ¶æ‰§è¡Œâ€œAll or Nothingâ€çš„è°ƒåº¦ç­–ç•¥ï¼Œç¡®ä¿ <code>minAvailable</code> å¾—åˆ°æ»¡è¶³ã€‚</li><li><strong>Priority æ’ä»¶</strong>ï¼šç”¨äºå¯¹å¤šä¸ªå¤„äº Pending çŠ¶æ€çš„ Job è¿›è¡Œæ’åºï¼Œå†³å®š Enqueue æ£€æŸ¥çš„å…ˆåé¡ºåºã€‚</li><li><strong>Proportion æ’ä»¶</strong>ï¼šè´Ÿè´£è®¡ç®—å’Œç®¡ç†<strong>é˜Ÿåˆ—ï¼ˆQueueï¼‰</strong> çš„èµ„æºæƒé‡ï¼ˆ<code>weight</code>ï¼‰ã€ä¿éšœï¼ˆ<code>guarantee</code>ï¼‰å’Œä¸Šé™ï¼ˆ<code>capability</code>ï¼‰ã€‚Enqueue Action åœ¨æ£€æŸ¥é›†ç¾¤å¯ç”¨èµ„æºæ—¶ï¼Œå¯èƒ½ä¼šè€ƒè™‘é˜Ÿåˆ—çš„åº”å¾—èµ„æºï¼ˆ<code>deserved</code>ï¼‰ï¼Œè€Œä¸ä»…ä»…æ˜¯èŠ‚ç‚¹çš„å…¨éƒ¨ç©ºé—²èµ„æºã€‚<strong>éœ€è¦æ³¨æ„çš„æ˜¯</strong>ï¼Œé˜Ÿåˆ—çš„ <code>guarantee</code> å’Œ <code>capability</code> åœ¨ admission é˜¶æ®µå¯èƒ½ç¼ºä¹å¼ºéªŒè¯ï¼Œå…¶æœ€ç»ˆæ•ˆæœä¾èµ–äº Proportion æ’ä»¶çš„è®¡ç®—ï¼Œå®é™…ä½¿ç”¨ä¸­éœ€æ³¨æ„ã€‚</li></ul><h3 id="âš ï¸-é‡è¦æ³¨æ„äº‹é¡¹"><a href="#âš ï¸-é‡è¦æ³¨æ„äº‹é¡¹" class="headerlink" title="âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹"></a>âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹</h3><ol><li><strong>ä¸ Preempt&#x2F;Reclaim çš„å†²çª</strong>ï¼šå¦‚æœè°ƒåº¦é…ç½®ä¸­<strong>åŒæ—¶å¯ç”¨</strong>äº† <code>enqueue</code> å’Œ <code>preempt</code>&#x2F;<code>reclaim</code>ï¼Œå¯èƒ½ä¼šäº§ç”Ÿé€»è¾‘å†²çªã€‚å› ä¸º Enqueue åœ¨èµ„æºä¸è¶³æ—¶ä¼šé˜»æ­¢ PodGroup å…¥é˜Ÿï¼Œè¿›è€Œå¯¼è‡´æ²¡æœ‰ Pod è¢«åˆ›å»ºã€‚è€Œæ²¡æœ‰ Pending çŠ¶æ€çš„ Podï¼Œ<code>preempt</code> å’Œ <code>reclaim</code>  action å°±æ‰¾ä¸åˆ°æŠ¢å æˆ–å›æ”¶çš„å¯¹è±¡ï¼Œä»è€Œæ— æ³•ç”Ÿæ•ˆã€‚é…ç½®è°ƒåº¦ç­–ç•¥æ—¶éœ€è¦ä»”ç»†è€ƒè™‘è¿™ä¸€ç‚¹ã€‚</li><li><strong>Queue èµ„æºçš„è€ƒé‡</strong>ï¼šEnqueue çš„å†³ç­–ä¼šå—åˆ° PodGroup æ‰€å±é˜Ÿåˆ—çš„èµ„æºé…é¢å½±å“ï¼ˆé€šè¿‡ Proportion æ’ä»¶ï¼‰ã€‚ä½†æ­£å¦‚å‰æ–‡æ‰€è¿°ï¼Œé˜Ÿåˆ—é…é¢çš„æœ€ç»ˆæ•ˆæœéœ€è¦ç»“åˆ Proportion æ’ä»¶çš„å…·ä½“å®ç°å’Œé…ç½®æ¥è¯„ä¼°ã€‚</li></ol><h3 id="ğŸ“Š-æµç¨‹æ€»ç»“"><a href="#ğŸ“Š-æµç¨‹æ€»ç»“" class="headerlink" title="ğŸ“Š æµç¨‹æ€»ç»“"></a>ğŸ“Š æµç¨‹æ€»ç»“</h3><p>ä¸ºäº†æ›´ç›´è§‚åœ°ç†è§£æ•´ä¸ªæµç¨‹ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢çš„åºåˆ—å›¾ï¼Œå®ƒå±•ç¤ºäº†ä»è°ƒåº¦å‘¨æœŸå¼€å§‹åˆ° Pod è¢«åˆ›å»ºçš„å…³é”®æ­¥éª¤å’Œç»„ä»¶äº¤äº’ï¼š</p><p><img src="/2025/08/09/volcano%E8%B0%83%E5%BA%A6%E5%99%A8Enqueue-Action%E8%AF%A6%E8%A7%A3/deepseek_mermaid_20250823_ae43ea.png" alt="deepseek_mermaid_20250823_ae43ea"></p><p>å¸Œæœ›è¿™ä»½ç»“åˆæºç çš„è¯¦ç»†è§£è¯»èƒ½å¸®åŠ©ä½ é€å½»åœ°ç†è§£ Volcano Enqueue Action çš„å·¥ä½œæœºåˆ¶ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>apt-getç†è§£</title>
    <link href="/2025/08/08/apt-get%E7%90%86%E8%A7%A3/"/>
    <url>/2025/08/08/apt-get%E7%90%86%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="apt-getç†è§£"><a href="#apt-getç†è§£" class="headerlink" title="apt-getç†è§£"></a>apt-getç†è§£</h1><p>æˆ‘ä»¬ç”¨ç”Ÿæ´»åŒ–çš„æ¯”å–»æ¥è§£é‡Š <code>apt-get</code>ï¼ˆæˆ–è€…è¯´ <code>apt</code>ï¼‰è¿™ä¸ªç¥å¥‡çš„â€œè½¯ä»¶ç®¡å®¶â€ï¼š</p><p><strong>æƒ³è±¡ä¸€ä¸‹ï¼Œä½ çš„ Linux ç”µè„‘å°±åƒä¸€ä¸ªåˆšæ¬è¿›å»çš„æ–°æˆ¿å­ï¼ˆç©ºè¡è¡çš„æ“ä½œç³»ç»Ÿï¼‰ã€‚</strong></p><ol><li><p><strong><code>apt</code> æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><ul><li><strong>å®ƒå°±æ˜¯ä½ çš„è¶…çº§æ™ºèƒ½â€œè£…ä¿®ç®¡å®¶â€å…¼â€œé‡‡è´­ç»ç†â€ã€‚</strong> ä½ æƒ³ç»™æˆ¿å­é‡Œæ·»ç½®ä¸œè¥¿ï¼ˆå®‰è£…è½¯ä»¶ï¼‰ï¼Œæ¯”å¦‚ä¸€å¼ æ¡Œå­ï¼ˆFirefox æµè§ˆå™¨ï¼‰ã€ä¸€ä¸ªä¹¦æ¶ï¼ˆLibreOfficeåŠå…¬å¥—ä»¶ï¼‰ï¼Œä½ ä¸ç”¨è‡ªå·±è·‘éå…¨åŸæ‰¾é›¶ä»¶ã€ç ä»·ã€æ‹…å¿ƒä¹°é”™å°ºå¯¸ï¼Œä½ åªéœ€è¦å‘Šè¯‰ç®¡å®¶ä¸€å£°ã€‚</li></ul></li><li><p><strong>å®‰è£…åŒ…åœ¨å“ªé‡Œï¼Ÿè°ç®¡ç†ç»´æŠ¤ï¼Ÿ</strong></p><ul><li><strong>å·¨å¤§çš„â€œå®˜æ–¹å®¶å…·åŸâ€å’Œâ€œæˆæƒä¸“å–åº—â€ï¼ˆè½¯ä»¶ä»“åº“ï¼‰ï¼š</strong> è¿™äº›â€œå•†åŸâ€åˆ†æ•£åœ¨ä¸–ç•Œå„åœ°ï¼ˆé•œåƒæœåŠ¡å™¨ï¼‰ï¼Œé‡Œé¢å †æ»¡äº†å„å¼å„æ ·æ‰“å¥½åŒ…ã€ç»è¿‡ä¸¥æ ¼è´¨æ£€çš„â€œå®¶å…·â€ï¼ˆè½¯ä»¶åŒ… <code>.deb</code> æ–‡ä»¶ï¼‰ã€‚</li><li><strong>è°å¼€çš„å•†åŸï¼Ÿ</strong><ul><li><strong>æˆ¿å­å¼€å‘å•†å¼€çš„æ——èˆ°åº—ï¼ˆå®˜æ–¹ Main ä»“åº“ï¼‰ï¼š</strong> ç”± Ubuntu æˆ– Debian å…¬å¸ï¼ˆå…¶å®å°±æ˜¯èƒŒåçš„åºå¤§å¼€å‘å›¢é˜Ÿï¼‰è‡ªå·±è¿è¥ã€‚é‡Œé¢çš„å®¶å…·ï¼ˆè½¯ä»¶ï¼‰éƒ½æ˜¯æœ€ä¸»æµã€æœ€ç¨³å®šã€è´¨é‡æœ€æœ‰ä¿éšœçš„ã€‚ä»–ä»¬æœ‰è‡ªå·±çš„è®¾è®¡å¸ˆï¼ˆæ‰“åŒ…è€…ï¼‰æŠŠåŸå§‹æœ¨æï¼ˆæºä»£ç ï¼‰åŠ å·¥æˆé€‚åˆä½ å®¶æˆ·å‹ï¼ˆç³»ç»Ÿï¼‰çš„æ ‡å‡†å®¶å…·ï¼Œå¹¶æœ‰ä¸“é—¨çš„ç»´ä¿®é˜Ÿï¼ˆå®‰å…¨å›¢é˜Ÿï¼‰è´Ÿè´£ä¿ä¿®å’Œå‡çº§ã€‚</li><li><strong>å¼€å‘å•†åˆä½œçš„å“ç‰Œåº—ï¼ˆUniverse&#x2F;Contrib ç­‰ä»“åº“ï¼‰ï¼š</strong> ç”±å¾ˆå¤šæœ‰ä¿¡èª‰çš„ç¬¬ä¸‰æ–¹å“ç‰Œï¼ˆç¤¾åŒºå¼€å‘è€…ï¼‰ä¾›è´§å’Œç»´æŠ¤ï¼Œæ”¾åœ¨å¼€å‘å•†çš„å•†åŸé‡Œå–ã€‚è´¨é‡ä¹Ÿä¸é”™ï¼Œé€‰æ‹©æ›´å¤šæ ·ã€‚</li><li><strong>æŸå“ç‰Œçš„å®˜æ–¹ç›´è¥åº—ï¼ˆç¬¬ä¸‰æ–¹ä»“åº“ï¼Œå¦‚ Docker&#x2F;Googleï¼‰ï¼š</strong> åƒâ€œå®œå®¶â€ã€â€œè‹¹æœä¸“å–åº—â€è¿™ç§ã€‚å¦‚æœä½ æƒ³ä¹°ç‰¹å®šå“ç‰Œçš„ç‹¬å®¶äº§å“ï¼ˆæ¯”å¦‚ Google Chrome, Dockerï¼‰ï¼Œç®¡å®¶ä¼šå¸¦ä½ å»ä»–ä»¬çš„ä¸“å–åº—ä¹°ã€‚è¿™äº›åº—ç”±å“ç‰Œè‡ªå·±ç®¡ç†ã€‚</li><li><strong>ä¸ªä½“æ‰‹å·¥ä½œåŠï¼ˆPPAï¼‰ï¼š</strong> ä¸€äº›æœ‰æ‰åçš„ä¸ªäººæˆ–å°å›¢é˜Ÿï¼ˆæ¯”å¦‚æŸä¸ªå‰å®³çš„â€œæœ¨åŒ â€ï¼‰å¼€çš„ç‰¹è‰²å°åº—ã€‚é‡Œé¢å¯èƒ½æœ‰æœ€æ–°æ½®çš„è®¾è®¡ï¼ˆè½¯ä»¶æµ‹è¯•ç‰ˆï¼‰æˆ–è€…å®˜æ–¹å•†åŸæ²¡æœ‰çš„ç‹¬ç‰¹å®¶å…·ï¼ˆè½¯ä»¶ï¼‰ã€‚<strong>åœ¨è¿™é‡Œä¹°ä¸œè¥¿è¦æ›´å°å¿ƒç‚¹</strong>ï¼Œå› ä¸ºè´¨æ£€å¯èƒ½ä¸å¦‚å¤§å•†åŸä¸¥æ ¼ï¼Œä½†æœ‰æ—¶èƒ½æ·˜åˆ°å®è´ã€‚</li></ul></li></ul></li><li><p><strong><code>apt</code> æ€ä¹ˆå·¥ä½œçš„ï¼Ÿï¼ˆä½ æƒ³è£…ä¸ªâ€œæ¡Œå­â€-Firefox æµè§ˆå™¨ï¼‰</strong></p><ul><li><strong>ç¬¬ä¸€æ­¥ï¼šæ›´æ–°â€œå•†åŸå¯¼è´­æ‰‹å†Œâ€ (<code>sudo apt update</code>)</strong><ul><li>ç®¡å®¶ï¼ˆ<code>apt</code>ï¼‰å…ˆæ‰“ç”µè¯ç»™å„ä¸ªåˆä½œå•†åŸï¼ˆä»“åº“ï¼‰ï¼Œé—®ï¼šâ€œä½ ä»¬æœ€è¿‘æœ‰ä»€ä¹ˆæ–°è´§ï¼Ÿå“ªäº›è´§ä¸‹æ¶äº†ï¼Ÿä»·æ ¼ï¼ˆç‰ˆæœ¬ï¼‰å˜äº†å—ï¼Ÿâ€ã€‚</li><li>å•†åŸä¼šæŠŠæœ€æ–°çš„<strong>å•†å“ç›®å½•æ¸…å•</strong>ï¼ˆè½¯ä»¶åŒ…ç´¢å¼•ï¼‰ä¼ çœŸï¼ˆä¸‹è½½ï¼‰ç»™ç®¡å®¶ã€‚ç®¡å®¶æŠŠè¿™ä¸ªæ¸…å•æ”¾åœ¨æ‰‹è¾¹ï¼ˆ<code>/var/lib/apt/lists/</code>ï¼‰ï¼Œè¿™æ ·å°±ä¸ç”¨æ¯æ¬¡éƒ½æ‰“ç”µè¯é—®æœ‰ä»€ä¹ˆè´§äº†ã€‚<strong>è¿™æ­¥å¾ˆé‡è¦ï¼Œç¡®ä¿ç®¡å®¶çŸ¥é“æœ€æ–°çš„å•†å“ä¿¡æ¯ï¼</strong></li></ul></li><li><strong>ç¬¬äºŒæ­¥ï¼šä¸‹å•é‡‡è´­ (<code>sudo apt install firefox</code>)</strong><ul><li>ä½ å‘Šè¯‰ç®¡å®¶ï¼šâ€œæˆ‘è¦ä¹°å¼ å« <code>firefox</code> çš„æ¡Œå­ï¼â€</li><li><strong>ç®¡å®¶æŸ¥æ‰‹å†Œï¼ˆä¾èµ–å…³ç³»è§£æï¼‰ï¼š</strong><ul><li>ç®¡å®¶ç¿»çœ‹æœ€æ–°çš„å¯¼è´­æ‰‹å†Œï¼ˆæœ¬åœ°ç´¢å¼•ï¼‰ï¼Œæ‰¾åˆ° <code>firefox</code> æ¡Œå­ã€‚</li><li>æ‰‹å†Œä¸Šå†™ç€ï¼šè¿™å¼ æ¡Œå­éœ€è¦ 4 æ¡ç‰¹å®šçš„æ¡Œè…¿ï¼ˆ<code>libxxx1</code>ï¼‰ã€ä¸€ä¸ªç‰¹å®šå‹å·çš„æ¡Œé¢ï¼ˆ<code>libyyy2</code>ï¼‰å’Œä¸€ä¸ªåŠ å›ºæ”¯æ¶ï¼ˆ<code>libzzz3</code>ï¼‰æ‰èƒ½ç»„è£…èµ·æ¥ä½¿ç”¨ï¼ˆä¾èµ–åŒ…ï¼‰ã€‚</li><li>ç®¡å®¶é©¬ä¸Šæ£€æŸ¥ä½ å®¶ä»“åº“ï¼ˆå·²å®‰è£…è½¯ä»¶ï¼‰ï¼šå“¦ï¼Œå·²ç»æœ‰ 2 æ¡æ¡Œè…¿ï¼ˆ<code>libxxx1</code>ï¼‰äº†ï¼Œä½†å‹å·æœ‰ç‚¹æ—§ï¼Œéœ€è¦ä¹°æ–°çš„ï¼›å¦å¤–ä¸¤æ¡æ¡Œè…¿ï¼ˆå¦ä¸€ä¸ª <code>libxxx</code>ï¼‰å’Œæ”¯æ¶ï¼ˆ<code>libzzz3</code>ï¼‰å®¶é‡Œæ²¡æœ‰ï¼›æ¡Œé¢ï¼ˆ<code>libyyy2</code>ï¼‰å€’æ˜¯æœ‰ä¸ªç±»ä¼¼çš„ï¼Œä½†ä¸å®Œå…¨åŒ¹é…ï¼Œä¹Ÿå¾—ä¹°æ–°çš„ã€‚</li><li>ç®¡å®¶<strong>è‡ªåŠ¨</strong>è®¡ç®—å‡ºéœ€è¦è´­ä¹°ï¼šæ–°ç‰ˆ <code>firefox</code> æ¡Œå­ã€æ–°ç‰ˆæ¡Œè…¿ x 4ã€æ–°ç‰ˆæ¡Œé¢ x1ã€åŠ å›ºæ”¯æ¶ x1ã€‚</li></ul></li><li><strong>ç®¡å®¶å»é‡‡è´­ï¼ˆä¸‹è½½åŒ…ï¼‰ï¼š</strong><ul><li>ç®¡å®¶å¼€è½¦ï¼ˆè”ç½‘ï¼‰å»ç›¸åº”çš„å•†åŸï¼ˆä»“åº“ï¼‰ï¼ŒæŠŠéœ€è¦çš„æ‰€æœ‰ä¸œè¥¿ï¼ˆè½¯ä»¶åŒ… <code>.deb</code> æ–‡ä»¶ï¼‰ä¹°å›æ¥ï¼Œä¸´æ—¶å †åœ¨ä½ å®¶è½¦åº“ï¼ˆ<code>/var/cache/apt/archives/</code>ï¼‰ã€‚</li></ul></li></ul></li><li><strong>ç¬¬ä¸‰æ­¥ï¼šé€è´§ä¸Šé—¨ &amp; ä¸“ä¸šå®‰è£… (<code>dpkg</code> ç™»åœº)</strong><ul><li>ç®¡å®¶ä¸æ˜¯å…‰æŠŠå®¶å…·æ‰”ç»™ä½ å°±å®Œäº‹äº†ã€‚ä»–å¸¦ç€ä¸“ä¸šçš„å®‰è£…å›¢é˜Ÿï¼ˆåº•å±‚å·¥å…· <code>dpkg</code>ï¼‰ä¸€èµ·æ¥ã€‚</li><li><strong>æ‹†åŒ… (<code>dpkg -i</code>)ï¼š</strong> å®‰è£…å›¢é˜ŸæŠŠæ¯ä¸ªåŒ…è£¹ï¼ˆ<code>.deb</code> æ–‡ä»¶ï¼‰æ‹†å¼€ã€‚</li><li><strong>ç²¾å‡†æ‘†æ”¾ï¼š</strong> ä»–ä»¬æŠŠæ¡Œè…¿ï¼ˆåº“æ–‡ä»¶ï¼‰æ”¾åˆ°å·¥å…·æˆ¿ï¼ˆ<code>/usr/lib/</code>ï¼‰ï¼Œæ¡Œé¢ï¼ˆç¨‹åºæ–‡ä»¶ï¼‰æ”¾åˆ°å®¢å…ï¼ˆ<code>/usr/bin/</code>ï¼‰ï¼Œè¯´æ˜ä¹¦ï¼ˆæ–‡æ¡£ï¼‰æ”¾åˆ°ä¹¦æˆ¿ï¼ˆ<code>/usr/share/doc/</code>ï¼‰ï¼Œå®‰è£…å›¾çº¸ï¼ˆé…ç½®æ–‡ä»¶ï¼‰æ”¾åˆ°æ–‡ä»¶æŸœï¼ˆ<code>/etc/</code>ï¼‰é‡Œã€‚<strong>æ¯ä¸ªéƒ¨ä»¶éƒ½æ”¾åˆ°ç³»ç»Ÿè§„å®šå¥½çš„ä½ç½®ã€‚</strong></li><li><strong>ç»„è£…è°ƒè¯•ï¼ˆè¿è¡Œå®‰è£…è„šæœ¬ï¼‰ï¼š</strong> æœ‰äº›å®¶å…·éœ€è¦æ‹§èºä¸æˆ–è€…æ¥ç”µçº¿ï¼ˆæ¯”å¦‚åˆ›å»ºç”¨æˆ·ã€æ›´æ–°èœå•ã€å¯åŠ¨åå°æœåŠ¡ï¼‰ã€‚å®‰è£…å›¢é˜ŸæŒ‰ç…§åŒ…è£¹é‡Œçš„è¯´æ˜ä¹¦ï¼ˆç»´æŠ¤è„šæœ¬ <code>preinst</code>, <code>postinst</code>ï¼‰ä¸€æ­¥ä¸€æ­¥æ“ä½œï¼Œç¡®ä¿æ¡Œå­è£…å¥½å°±èƒ½ç”¨ã€‚</li><li><strong>ç™»è®°å…¥åº“ï¼š</strong> ç®¡å®¶åœ¨å®¶åº­è´¢äº§æ¸…å•ï¼ˆè½¯ä»¶åŒ…æ•°æ®åº“ <code>/var/lib/dpkg/status</code>ï¼‰ä¸Šè¯¦ç»†è®°å½•ï¼šä»Šå¤©å®‰è£…äº† <code>firefox</code> æ¡Œå­ï¼ˆç‰ˆæœ¬å· x.xï¼‰ï¼ŒåŒæ—¶å®‰è£…äº†é…å¥—çš„æ¡Œè…¿ã€æ¡Œé¢ã€æ”¯æ¶ï¼ˆä¾èµ–åŒ…ï¼‰ã€‚è¿™æ ·ä»¥åç»´ä¿®ã€å‡çº§æˆ–è€…æƒ³å–æ‰ï¼ˆå¸è½½ï¼‰çš„æ—¶å€™ï¼Œç®¡å®¶éƒ½çŸ¥é“å®¶é‡Œæœ‰ä»€ä¹ˆã€‚</li></ul></li></ul></li><li><p><strong>å…¶ä»–é‡è¦åŠŸèƒ½ï¼š</strong></p><ul><li><strong>å‡çº§ (<code>sudo apt upgrade</code>)ï¼š</strong> ç®¡å®¶å®šæœŸæŸ¥çœ‹å•†åŸæ‰‹å†Œï¼ˆ<code>apt update</code>ï¼‰ï¼Œå‘ç°ä½ å®¶çš„æ¡Œå­ï¼ˆè½¯ä»¶ï¼‰å‡ºäº†æ–°æ¬¾æˆ–è€…å®‰å…¨åŠ å›ºç‰ˆï¼ˆå®‰å…¨æ›´æ–°ï¼‰ã€‚ä»–ä¼šå‘Šè¯‰ä½ ï¼Œå¹¶å¸®ä½ æŠŠæ—§æ¡Œå­å‡çº§æˆæ–°æ¡Œå­ï¼ˆåŒ…æ‹¬æ‰€æœ‰éœ€è¦å‡çº§çš„æ¡Œè…¿é…ä»¶ï¼‰ã€‚</li><li><strong>å¸è½½ (<code>sudo apt remove firefox</code>)ï¼š</strong> ä½ è¯´ï¼šâ€œè¿™æ¡Œå­æˆ‘ä¸æƒ³è¦äº†â€ã€‚ç®¡å®¶ä¼šæ ¹æ®è´¢äº§æ¸…å•ï¼ŒæŠŠ <code>firefox</code> æ¡Œå­å’Œ<strong>ä¸“é—¨ä¸ºå®ƒå®‰è£…çš„é…ä»¶</strong>ï¼ˆä½†ä¸ä¼šåˆ æ‰å…¶ä»–å®¶å…·ä¹Ÿéœ€è¦çš„é…ä»¶ï¼‰æ‹†æ‰æ‹¿èµ°ã€‚å¦‚æœä½ æƒ³è¿é‚£äº›å¯èƒ½æ²¡ç”¨çš„é…ä»¶ä¹Ÿæ¸…ç†æ‰ï¼Œå¯ä»¥ç”¨ <code>sudo apt autoremove</code>ã€‚</li><li><strong>æ¸…ç†è½¦åº“ (<code>sudo apt clean</code>)ï¼š</strong> ç®¡å®¶æŠŠå †åœ¨è½¦åº“ï¼ˆç¼“å­˜ç›®å½•ï¼‰é‡Œé‚£äº›å·²ç»å®‰è£…å¥½çš„å®¶å…·åŒ…è£…ç›’ï¼ˆä¸‹è½½çš„ <code>.deb</code> æ–‡ä»¶ï¼‰éƒ½æ‰”æ‰ï¼Œè…¾å‡ºç©ºé—´ã€‚<code>sudo apt autoclean</code> åˆ™æ˜¯åªæ‰”æ‰é‚£äº›è¿‡æ—¶å‹å·çš„åŒ…è£…ç›’ï¼ˆæ—§ç‰ˆæœ¬çš„åŒ…ï¼‰ã€‚</li></ul></li></ol><p><strong>æ€»ç»“ä¸€ä¸‹å…³é”®æ¯”å–»ï¼š</strong></p><ul><li><strong><code>apt</code> &#x2F; <code>apt-get</code>ï¼š</strong> ä½ çš„æ™ºèƒ½è£…ä¿®ç®¡å®¶å…¼é‡‡è´­ç»ç†ã€‚è´Ÿè´£é‡‡è´­ã€è§£å†³é…ä»¶ä¾èµ–ã€æŒ‡æŒ¥å®‰è£…ã€‚</li><li><strong>è½¯ä»¶åŒ… (<code>.deb</code>)ï¼š</strong> æ‰“åŒ…å¥½çš„â€œå®¶å…·â€æˆ–â€œç”µå™¨â€ã€‚</li><li><strong>è½¯ä»¶ä»“åº“ï¼š</strong> å®˜æ–¹çš„ã€ç¬¬ä¸‰æ–¹çš„â€œå®¶å…·åŸâ€ã€â€œå“ç‰Œä¸“å–åº—â€ã€â€œæ‰‹å·¥ä½œåŠâ€ï¼ˆPPAï¼‰ã€‚</li><li><strong><code>/etc/apt/sources.list</code>ï¼š</strong> ç®¡å®¶æ‰‹é‡Œçš„â€œåˆä½œå•†åŸé€šè®¯å½•â€ã€‚</li><li><strong><code>sudo apt update</code>ï¼š</strong> ç®¡å®¶æ‰“ç”µè¯æ›´æ–°æ‰€æœ‰å•†åŸçš„â€œæœ€æ–°å•†å“ç›®å½•æ‰‹å†Œâ€ã€‚</li><li><strong>ä¾èµ–å…³ç³»ï¼š</strong> å®‰è£…ä¸€ä¸ªâ€œå®¶å…·â€ï¼ˆè½¯ä»¶ï¼‰æ‰€å¿…éœ€çš„â€œèºä¸é’‰ã€æœ¨æ¿ã€è¯´æ˜ä¹¦â€ï¼ˆå…¶ä»–åº“æ–‡ä»¶æˆ–ç¨‹åºï¼‰ã€‚</li><li><strong><code>dpkg</code>ï¼š</strong> ç®¡å®¶çš„ä¸“ä¸šâ€œæ‹†åŒ…å®‰è£…å›¢é˜Ÿâ€ï¼ŒæŒ‰ç…§è¯´æ˜ä¹¦æŠŠä¸œè¥¿æ”¾åˆ°ç²¾ç¡®ä½ç½®å¹¶ç»„è£…è°ƒè¯•ã€‚</li><li><strong><code>/var/cache/apt/archives/</code>ï¼š</strong> ä¸´æ—¶å †åŒ…è£…ç›’çš„â€œè½¦åº“â€ã€‚</li><li><strong><code>/var/lib/dpkg/status</code>ï¼š</strong> å®¶é‡Œçš„â€œè´¢äº§ç™»è®°æ¸…å•â€ï¼Œè®°å½•æ‰€æœ‰å·²å®‰è£…ç‰©å“åŠå…¶é…ä»¶ã€‚</li></ul><p>æ‰€ä»¥ï¼Œä¸‹æ¬¡ä½ ç”¨ <code>sudo apt install</code> è£…è½¯ä»¶æ—¶ï¼Œå¿ƒé‡Œå°±å¯ä»¥æƒ³ï¼šæˆ‘çš„â€œç®¡å®¶â€æ­£åœ¨å¸®æˆ‘ä»â€œå®˜æ–¹å•†åŸâ€ä¸‹å•ï¼Œè‡ªåŠ¨é…é½æ‰€æœ‰éœ€è¦çš„â€œé›¶ä»¶â€ï¼Œå¹¶æŒ‡æŒ¥â€œå®‰è£…é˜Ÿâ€ç²¾å‡†æ— è¯¯åœ°è£…å¥½ï¼ä½ åªéœ€è¦åŠ¨åŠ¨å˜´ï¼ˆè¾“å…¥å‘½ä»¤ï¼‰å°±è¡Œäº†ï¼Œè¿™å°±æ˜¯ <code>apt</code> å¸¦æ¥çš„å·¨å¤§ä¾¿åˆ©ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>volcanoè°ƒåº¦å™¨å·¥ä½œåŸç†</title>
    <link href="/2025/08/06/volcano%E8%B0%83%E5%BA%A6%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/"/>
    <url>/2025/08/06/volcano%E8%B0%83%E5%BA%A6%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="Volcano-è°ƒåº¦å™¨æ ¸å¿ƒæ¦‚å¿µä¸å·¥ä½œåŸç†è¯¦è§£"><a href="#Volcano-è°ƒåº¦å™¨æ ¸å¿ƒæ¦‚å¿µä¸å·¥ä½œåŸç†è¯¦è§£" class="headerlink" title="Volcano è°ƒåº¦å™¨æ ¸å¿ƒæ¦‚å¿µä¸å·¥ä½œåŸç†è¯¦è§£"></a>Volcano è°ƒåº¦å™¨æ ¸å¿ƒæ¦‚å¿µä¸å·¥ä½œåŸç†è¯¦è§£</h1><h2 id="ä¸€ã€æ ¸å¿ƒæ¦‚å¿µå…¨æ™¯å›¾"><a href="#ä¸€ã€æ ¸å¿ƒæ¦‚å¿µå…¨æ™¯å›¾" class="headerlink" title="ä¸€ã€æ ¸å¿ƒæ¦‚å¿µå…¨æ™¯å›¾"></a>ä¸€ã€æ ¸å¿ƒæ¦‚å¿µå…¨æ™¯å›¾</h2><h3 id="1-è°ƒåº¦ä¼šè¯-Session"><a href="#1-è°ƒåº¦ä¼šè¯-Session" class="headerlink" title="1. è°ƒåº¦ä¼šè¯ (Session)"></a>1. è°ƒåº¦ä¼šè¯ (Session)</h3><ul><li><strong>å®šä¹‰</strong>ï¼šè°ƒåº¦å™¨æ¯æ¬¡å†³ç­–çš„å®Œæ•´å‘¨æœŸ</li><li><strong>ç”Ÿå‘½å‘¨æœŸ</strong>ï¼š<pre><code class=" mermaid">graph LR  A[ä¼šè¯å¼€å§‹] --&gt; B[è·å–é›†ç¾¤å¿«ç…§]  B --&gt; C[æ‰§è¡Œè°ƒåº¦é€»è¾‘]  C --&gt; D[æäº¤è°ƒåº¦å†³ç­–]  D --&gt; E[ä¼šè¯ç»“æŸ]</code></pre></li><li><strong>å…³é”®æ•°æ®</strong>ï¼šåŒ…å«é›†ç¾¤çŠ¶æ€ï¼ˆèŠ‚ç‚¹ã€ä½œä¸šã€é˜Ÿåˆ—ï¼‰çš„å®Œæ•´å†…å­˜æ¨¡å‹</li></ul><h3 id="2-è°ƒåº¦å•å…ƒ-Scheduling-Units"><a href="#2-è°ƒåº¦å•å…ƒ-Scheduling-Units" class="headerlink" title="2. è°ƒåº¦å•å…ƒ (Scheduling Units)"></a>2. è°ƒåº¦å•å…ƒ (Scheduling Units)</h3><table><thead><tr><th>æ¦‚å¿µ</th><th>æè¿°</th><th>K8s åŸç”Ÿå¯¹åº”</th></tr></thead><tbody><tr><td><strong>PodGroup</strong></td><td>åŸå­è°ƒåº¦å•å…ƒï¼ˆä¸€ç»„å¿…é¡»æ•´ä½“è°ƒåº¦çš„Podï¼‰</td><td>æ— </td></tr><tr><td><strong>VolcanoJob</strong></td><td>å¢å¼ºå‹Jobï¼ˆæ”¯æŒå¤šä»»åŠ¡æ¨¡æ¿ï¼‰</td><td>Job</td></tr><tr><td><strong>Queue</strong></td><td>èµ„æºé˜Ÿåˆ—ï¼ˆå¤šç§Ÿæˆ·éš”ç¦»ï¼‰</td><td>Namespace ResourceQuota</td></tr><tr><td><strong>Task</strong></td><td>ä½œä¸šå†…éƒ¨çš„ä»»åŠ¡å•å…ƒ</td><td>PodTemplate</td></tr></tbody></table><h3 id="3-è°ƒåº¦ç­–ç•¥æ’ä»¶-Plugins"><a href="#3-è°ƒåº¦ç­–ç•¥æ’ä»¶-Plugins" class="headerlink" title="3. è°ƒåº¦ç­–ç•¥æ’ä»¶ (Plugins)"></a>3. è°ƒåº¦ç­–ç•¥æ’ä»¶ (Plugins)</h3><table><thead><tr><th>æ’ä»¶å</th><th>åŠŸèƒ½</th><th>å…³é”®å‚æ•°</th></tr></thead><tbody><tr><td><strong>Gang</strong></td><td>ä¿è¯ä½œä¸šå®Œæ•´æ€§</td><td><code>minAvailable</code></td></tr><tr><td><strong>DRF</strong></td><td>å¤šèµ„æºå…¬å¹³è°ƒåº¦</td><td><code>weight</code></td></tr><tr><td><strong>Binpack</strong></td><td>é«˜å¯†åº¦è£…ç®±</td><td><code>binpack.resources</code></td></tr><tr><td><strong>Priority</strong></td><td>ä½œä¸šä¼˜å…ˆçº§</td><td><code>priorityClassName</code></td></tr><tr><td><strong>Topology</strong></td><td>æ‹“æ‰‘æ„ŸçŸ¥è°ƒåº¦</td><td><code>topologyPolicy</code></td></tr><tr><td><strong>Preempt</strong></td><td>æŠ¢å æœºåˆ¶</td><td><code>preemptable</code></td></tr></tbody></table><h3 id="4-è°ƒåº¦åŠ¨ä½œ-Actions"><a href="#4-è°ƒåº¦åŠ¨ä½œ-Actions" class="headerlink" title="4. è°ƒåº¦åŠ¨ä½œ (Actions)"></a>4. è°ƒåº¦åŠ¨ä½œ (Actions)</h3><table><thead><tr><th>åŠ¨ä½œ</th><th>æ‰§è¡Œé¡ºåº</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td><strong>Enqueue</strong></td><td>1</td><td>ä½œä¸šå…¥é˜Ÿï¼ˆæ£€æŸ¥é˜Ÿåˆ—é…é¢ï¼‰</td></tr><tr><td><strong>Allocate</strong></td><td>2</td><td>æ ¸å¿ƒèµ„æºåˆ†é…</td></tr><tr><td><strong>Backfill</strong></td><td>3</td><td>ç¢ç‰‡èµ„æºå¡«å……</td></tr><tr><td><strong>Preempt</strong></td><td>4</td><td>æŠ¢å ä½ä¼˜å…ˆçº§ä½œä¸š</td></tr><tr><td><strong>Reclaim</strong></td><td>5</td><td>å›æ”¶è¶…é¢èµ„æº</td></tr></tbody></table><h2 id="äºŒã€è°ƒåº¦å™¨å·¥ä½œåŸç†æ·±åº¦è§£æ"><a href="#äºŒã€è°ƒåº¦å™¨å·¥ä½œåŸç†æ·±åº¦è§£æ" class="headerlink" title="äºŒã€è°ƒåº¦å™¨å·¥ä½œåŸç†æ·±åº¦è§£æ"></a>äºŒã€è°ƒåº¦å™¨å·¥ä½œåŸç†æ·±åº¦è§£æ</h2><h3 id="1-æ•´ä½“æ¶æ„"><a href="#1-æ•´ä½“æ¶æ„" class="headerlink" title="1. æ•´ä½“æ¶æ„"></a>1. æ•´ä½“æ¶æ„</h3><pre><code class=" mermaid">graph TD    A[API Server] --&gt;|Watch| B(Volcano Scheduler)    B --&gt;|å†³ç­–| C[Kubelet]    D[Volcano Controllers] --&gt;|ç®¡ç†| E[VCJob/PodGroup/Queue]    F[Plugin Registry] --&gt;|æ‰©å±•| B    G[Metrics Server] --&gt;|ç›‘æ§| B        B --&gt;|æ’ä»¶é“¾| H[Enqueue]    B --&gt;|æ’ä»¶é“¾| I[Allocate]    B --&gt;|æ’ä»¶é“¾| J[Backfill]</code></pre><h3 id="2-è°ƒåº¦å¾ªç¯å®Œæ•´æµç¨‹"><a href="#2-è°ƒåº¦å¾ªç¯å®Œæ•´æµç¨‹" class="headerlink" title="2. è°ƒåº¦å¾ªç¯å®Œæ•´æµç¨‹"></a>2. è°ƒåº¦å¾ªç¯å®Œæ•´æµç¨‹</h3><h4 id="æ­¥éª¤1ï¼šä¼šè¯åˆå§‹åŒ–-Session-Initialization"><a href="#æ­¥éª¤1ï¼šä¼šè¯åˆå§‹åŒ–-Session-Initialization" class="headerlink" title="æ­¥éª¤1ï¼šä¼šè¯åˆå§‹åŒ– (Session Initialization)"></a>æ­¥éª¤1ï¼šä¼šè¯åˆå§‹åŒ– (Session Initialization)</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// åˆ›å»ºæ–°ä¼šè¯</span><br>session := NewSession(<br>    cache.GetNodes(),   <span class="hljs-comment">// èŠ‚ç‚¹åˆ—è¡¨</span><br>    cache.GetJobs(),    <span class="hljs-comment">// ä½œä¸šåˆ—è¡¨</span><br>    cache.GetQueues(),  <span class="hljs-comment">// é˜Ÿåˆ—åˆ—è¡¨</span><br>)<br></code></pre></td></tr></table></figure><h4 id="æ­¥éª¤2ï¼šæ’ä»¶é“¾æ‰§è¡Œ-Plugin-Chain-Execution"><a href="#æ­¥éª¤2ï¼šæ’ä»¶é“¾æ‰§è¡Œ-Plugin-Chain-Execution" class="headerlink" title="æ­¥éª¤2ï¼šæ’ä»¶é“¾æ‰§è¡Œ (Plugin Chain Execution)"></a>æ­¥éª¤2ï¼šæ’ä»¶é“¾æ‰§è¡Œ (Plugin Chain Execution)</h4><pre><code class=" mermaid">sequenceDiagram    Scheduler-&gt;&gt;+Enqueue: æ‰§è¡Œå…¥é˜Ÿ    Enqueue--&gt;&gt;-Scheduler: è¿”å›å¯è°ƒåº¦ä½œä¸š    Scheduler-&gt;&gt;+Allocate: åˆ†é…èµ„æº    Allocate--&gt;&gt;-Scheduler: è¿”å›åˆ†é…æ–¹æ¡ˆ    Scheduler-&gt;&gt;+Backfill: å¡«å……ç¢ç‰‡    Backfill--&gt;&gt;-Scheduler: è¿”å›å¡«å……ç»“æœ</code></pre><h4 id="æ­¥éª¤3ï¼šæ ¸å¿ƒè°ƒåº¦ç®—æ³•-Allocate-Action"><a href="#æ­¥éª¤3ï¼šæ ¸å¿ƒè°ƒåº¦ç®—æ³•-Allocate-Action" class="headerlink" title="æ­¥éª¤3ï¼šæ ¸å¿ƒè°ƒåº¦ç®—æ³• (Allocate Action)"></a>æ­¥éª¤3ï¼šæ ¸å¿ƒè°ƒåº¦ç®—æ³• (Allocate Action)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">allocate</span>(<span class="hljs-params">session</span>):<br>    <span class="hljs-comment"># 1. ä½œä¸šæ’åºï¼ˆä¼˜å…ˆçº§/æäº¤æ—¶é—´ï¼‰</span><br>    sorted_jobs = sort_jobs(session.jobs)<br>    <br>    <span class="hljs-keyword">for</span> job <span class="hljs-keyword">in</span> sorted_jobs:<br>        <span class="hljs-comment"># 2. æ£€æŸ¥Gangæ¡ä»¶</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> gang_plugin.check(job):<br>            <span class="hljs-keyword">continue</span>  <span class="hljs-comment"># è·³è¿‡ä¸æ»¡è¶³æ¡ä»¶çš„ä½œä¸š</span><br>        <br>        <span class="hljs-comment"># 3. ä»»åŠ¡æ’åºï¼ˆChiefä¼˜å…ˆï¼‰</span><br>        sorted_tasks = sort_tasks(job.tasks)<br>        <br>        <span class="hljs-keyword">for</span> task <span class="hljs-keyword">in</span> sorted_tasks:<br>            <span class="hljs-comment"># 4. èŠ‚ç‚¹è¿‡æ»¤ï¼ˆæ ‡ç­¾/æ±¡ç‚¹ï¼‰</span><br>            feasible_nodes = filter_nodes(task, session.nodes)<br>            <br>            <span class="hljs-comment"># 5. èŠ‚ç‚¹è¯„åˆ†ï¼ˆBinpack/Spreadï¼‰</span><br>            scored_nodes = score_nodes(task, feasible_nodes)<br>            <br>            <span class="hljs-comment"># 6. é€‰æ‹©æœ€ä¼˜èŠ‚ç‚¹</span><br>            best_node = select_best_node(scored_nodes)<br>            <br>            <span class="hljs-comment"># 7. ä¸´æ—¶ç»‘å®š</span><br>            bind(task, best_node)<br>    <br>    <span class="hljs-comment"># 8. æäº¤ç»‘å®šå†³ç­–</span><br>    commit_bindings()<br></code></pre></td></tr></table></figure><h4 id="æ­¥éª¤4ï¼šå†³ç­–æäº¤-Decision-Commit"><a href="#æ­¥éª¤4ï¼šå†³ç­–æäº¤-Decision-Commit" class="headerlink" title="æ­¥éª¤4ï¼šå†³ç­–æäº¤ (Decision Commit)"></a>æ­¥éª¤4ï¼šå†³ç­–æäº¤ (Decision Commit)</h4><ul><li>åŸå­æ€§æäº¤æ‰€æœ‰ç»‘å®šæ“ä½œ</li><li>çŠ¶æ€æ›´æ–°ï¼š<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> all_bound &#123;<br>    podGroup.Status = Running<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    podGroup.Status = Pending<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h2 id="ä¸‰ã€æ ¸å¿ƒè°ƒåº¦åœºæ™¯è§£æ"><a href="#ä¸‰ã€æ ¸å¿ƒè°ƒåº¦åœºæ™¯è§£æ" class="headerlink" title="ä¸‰ã€æ ¸å¿ƒè°ƒåº¦åœºæ™¯è§£æ"></a>ä¸‰ã€æ ¸å¿ƒè°ƒåº¦åœºæ™¯è§£æ</h2><h3 id="1-Gang-Scheduling-å®ç°"><a href="#1-Gang-Scheduling-å®ç°" class="headerlink" title="1. Gang Scheduling å®ç°"></a>1. Gang Scheduling å®ç°</h3><p><strong>é—®é¢˜</strong>ï¼šå¦‚ä½•ä¿è¯åˆ†å¸ƒå¼ä½œä¸šçš„æ‰€æœ‰PodåŒæ—¶å¯åŠ¨ï¼Ÿ</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p><pre><code class=" mermaid">sequenceDiagram    participant S as Scheduler    participant C as Cluster    S-&gt;&gt;C: æ£€æŸ¥minAvailableèµ„æº    alt èµ„æºå……è¶³        S-&gt;&gt;C: é¢„ç•™æ‰€æœ‰èµ„æº        S-&gt;&gt;C: åŸå­ç»‘å®šæ‰€æœ‰Pod        C--&gt;&gt;S: ç»‘å®šæˆåŠŸ    else èµ„æºä¸è¶³        S-&gt;&gt;C: ä¸ç»‘å®šä»»ä½•Pod        C--&gt;&gt;S: ä¿æŒPendingçŠ¶æ€    end</code></pre><p><strong>å…³é”®ä»£ç </strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g *gangPlugin)</span></span> OnSessionOpen(ssn *framework.Session) &#123;<br>    ssn.AddJobReadyFn(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(obj <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> <span class="hljs-type">bool</span> &#123;<br>        job := obj.(*api.JobInfo)<br>        ready := <span class="hljs-built_in">len</span>(job.ReadyTasks) &gt;= job.MinAvailable<br>        <span class="hljs-keyword">return</span> ready<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-æŠ¢å å¼è°ƒåº¦-Preemption"><a href="#2-æŠ¢å å¼è°ƒåº¦-Preemption" class="headerlink" title="2. æŠ¢å å¼è°ƒåº¦ (Preemption)"></a>2. æŠ¢å å¼è°ƒåº¦ (Preemption)</h3><p><strong>åœºæ™¯</strong>ï¼šé«˜ä¼˜å…ˆçº§ä½œä¸šéœ€è¦èµ„æºæ—¶</p><p><strong>å·¥ä½œæµç¨‹</strong>ï¼š</p><pre><code class=" mermaid">graph TD    A[æ–°ä½œä¸šæäº¤] --&gt; B&#123;èµ„æºä¸è¶³&#125;    B --&gt;|æ˜¯| C[é€‰æ‹©ç‰ºç‰²è€…]    C --&gt; D[é©±é€ä½ä¼˜å…ˆçº§Pod]    D --&gt; E[é‡Šæ”¾èµ„æº]    E --&gt; F[è°ƒåº¦æ–°ä½œä¸š]</code></pre><p><strong>ç‰ºç‰²è€…é€‰æ‹©ç­–ç•¥</strong>ï¼š</p><ol><li>æœ€ä½ä¼˜å…ˆçº§ä½œä¸š</li><li>æœ€å°è¿›åº¦æŸå¤±ï¼ˆå¯æ¢å¤ä½œä¸šä¼˜å…ˆï¼‰</li><li>æœ€å°‘Podæ•°é‡</li></ol><h3 id="3-æ‹“æ‰‘æ„ŸçŸ¥è°ƒåº¦-Topology-Awareness"><a href="#3-æ‹“æ‰‘æ„ŸçŸ¥è°ƒåº¦-Topology-Awareness" class="headerlink" title="3. æ‹“æ‰‘æ„ŸçŸ¥è°ƒåº¦ (Topology Awareness)"></a>3. æ‹“æ‰‘æ„ŸçŸ¥è°ƒåº¦ (Topology Awareness)</h3><p><strong>GPUè®­ç»ƒåœºæ™¯ä¼˜åŒ–</strong>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">plugins:</span><br>  <span class="hljs-attr">topology:</span><br>    <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">policies:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">device:</span> <span class="hljs-string">GPU</span><br>        <span class="hljs-attr">gpuPolicy:</span> <span class="hljs-string">dgx-2</span> <span class="hljs-comment"># NVLinkæ‹“æ‰‘ç­–ç•¥</span><br></code></pre></td></tr></table></figure><p><strong>è°ƒåº¦å™¨è¡Œä¸º</strong>ï¼š</p><ol><li>è¿‡æ»¤å…·æœ‰NVLinkçš„èŠ‚ç‚¹</li><li>é€‰æ‹©åŒä¸€ç‰©ç†æœºä¸Šçš„GPU</li><li>ç¡®ä¿GPUé€šè¿‡é«˜é€Ÿäº’è”</li></ol><h2 id="å››ã€è°ƒåº¦å™¨é«˜çº§ç‰¹æ€§"><a href="#å››ã€è°ƒåº¦å™¨é«˜çº§ç‰¹æ€§" class="headerlink" title="å››ã€è°ƒåº¦å™¨é«˜çº§ç‰¹æ€§"></a>å››ã€è°ƒåº¦å™¨é«˜çº§ç‰¹æ€§</h2><h3 id="1-æ‰¹è°ƒåº¦ä¼˜åŒ–"><a href="#1-æ‰¹è°ƒåº¦ä¼˜åŒ–" class="headerlink" title="1. æ‰¹è°ƒåº¦ä¼˜åŒ–"></a>1. æ‰¹è°ƒåº¦ä¼˜åŒ–</h3><table><thead><tr><th>ç­–ç•¥</th><th>æè¿°</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td><strong>Binpack</strong></td><td>ç´§å¯†è£…ç®±å‡å°‘ç¢ç‰‡</td><td>èµ„æºç´§å¼ ç¯å¢ƒ</td></tr><tr><td><strong>Spread</strong></td><td>åˆ†æ•£éƒ¨ç½²æé«˜å¯ç”¨æ€§</td><td>é«˜å¯ç”¨éœ€æ±‚</td></tr><tr><td><strong>DRF</strong></td><td>å¤šèµ„æºå…¬å¹³åˆ†é…</td><td>å¤šç§Ÿæˆ·ç¯å¢ƒ</td></tr></tbody></table><h3 id="2-å¼¹æ€§èµ„æºç®¡ç†"><a href="#2-å¼¹æ€§èµ„æºç®¡ç†" class="headerlink" title="2. å¼¹æ€§èµ„æºç®¡ç†"></a>2. å¼¹æ€§èµ„æºç®¡ç†</h3><pre><code class=" mermaid">graph LR    A[èµ„æºç›‘æ§] --&gt; B&#123;èµ„æºä¸è¶³&#125;    B --&gt;|æ˜¯| C[é©±é€ç¦»çº¿ä½œä¸š]    B --&gt;|å¦| D[æ¢å¤ç¦»çº¿ä½œä¸š]    D --&gt; E[ä»æ£€æŸ¥ç‚¹ç»§ç»­]</code></pre><h3 id="3-ä»»åŠ¡ä¾èµ–-DAG"><a href="#3-ä»»åŠ¡ä¾èµ–-DAG" class="headerlink" title="3. ä»»åŠ¡ä¾èµ– (DAG)"></a>3. ä»»åŠ¡ä¾èµ– (DAG)</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">preprocess</span><br>    <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">training</span><br>    <span class="hljs-attr">replicas:</span> <span class="hljs-number">4</span><br>    <span class="hljs-attr">dependsOn:</span> [<span class="hljs-string">preprocess</span>] <span class="hljs-comment"># ä¾èµ–å‰ç½®ä»»åŠ¡</span><br></code></pre></td></tr></table></figure><h2 id="äº”ã€è°ƒåº¦å™¨å†…éƒ¨çŠ¶æ€æœº"><a href="#äº”ã€è°ƒåº¦å™¨å†…éƒ¨çŠ¶æ€æœº" class="headerlink" title="äº”ã€è°ƒåº¦å™¨å†…éƒ¨çŠ¶æ€æœº"></a>äº”ã€è°ƒåº¦å™¨å†…éƒ¨çŠ¶æ€æœº</h2><h3 id="PodGroup-çŠ¶æ€æµè½¬"><a href="#PodGroup-çŠ¶æ€æµè½¬" class="headerlink" title="PodGroup çŠ¶æ€æµè½¬"></a>PodGroup çŠ¶æ€æµè½¬</h3><pre><code class=" mermaid">stateDiagram-v2    [*] --&gt; Pending åˆ›å»º    Pending --&gt; Running èµ„æºæ»¡è¶³    Running --&gt; Completed æ‰€æœ‰ä»»åŠ¡æˆåŠŸ    Running --&gt; Failed ä»»åŠ¡å¤±è´¥    Pending --&gt; Failed è¶…æ—¶/é…ç½®é”™è¯¯    Failed --&gt; Pending é‡è¯•ï¼ˆmaxRetryï¼‰</code></pre><h3 id="è°ƒåº¦å†³ç­–çŠ¶æ€"><a href="#è°ƒåº¦å†³ç­–çŠ¶æ€" class="headerlink" title="è°ƒåº¦å†³ç­–çŠ¶æ€"></a>è°ƒåº¦å†³ç­–çŠ¶æ€</h3><table><thead><tr><th>çŠ¶æ€</th><th>æè¿°</th><th>å¸¸è§åŸå› </th></tr></thead><tbody><tr><td><strong>Unschedulable</strong></td><td>æ— æ³•è°ƒåº¦</td><td>èµ„æºä¸è¶³&#x2F;çº¦æŸå†²çª</td></tr><tr><td><strong>Wait</strong></td><td>ç­‰å¾…ä¾èµ–</td><td>DAGå‰ç½®ä»»åŠ¡æœªå®Œæˆ</td></tr><tr><td><strong>Pending</strong></td><td>æ’é˜Ÿä¸­</td><td>é˜Ÿåˆ—é…é¢ä¸è¶³</td></tr><tr><td><strong>Scheduled</strong></td><td>å·²è°ƒåº¦</td><td>æˆåŠŸåˆ†é…èŠ‚ç‚¹</td></tr></tbody></table><h2 id="å…­ã€å®æ“ï¼šè°ƒåº¦å™¨é—®é¢˜è¯Šæ–­"><a href="#å…­ã€å®æ“ï¼šè°ƒåº¦å™¨é—®é¢˜è¯Šæ–­" class="headerlink" title="å…­ã€å®æ“ï¼šè°ƒåº¦å™¨é—®é¢˜è¯Šæ–­"></a>å…­ã€å®æ“ï¼šè°ƒåº¦å™¨é—®é¢˜è¯Šæ–­</h2><h3 id="1-PodGroup-é•¿æœŸ-Pending"><a href="#1-PodGroup-é•¿æœŸ-Pending" class="headerlink" title="1. PodGroup é•¿æœŸ Pending"></a>1. PodGroup é•¿æœŸ Pending</h3><p><strong>è¯Šæ–­å‘½ä»¤</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æŸ¥çœ‹äº‹ä»¶</span><br>kubectl describe podgroup &lt;name&gt;<br><br><span class="hljs-comment"># æ£€æŸ¥è°ƒåº¦å™¨æ—¥å¿—</span><br>kubectl logs -n volcano-system volcano-scheduler-xxx | grep &lt;job-name&gt;<br></code></pre></td></tr></table></figure><p><strong>å¸¸è§åŸå› </strong>ï¼š</p><ul><li><code>minAvailable</code> &gt; å¯ç”¨èµ„æº</li><li>èŠ‚ç‚¹é€‰æ‹©å™¨&#x2F;æ±¡ç‚¹ä¸åŒ¹é…</li><li>é˜Ÿåˆ—èµ„æºé…é¢ä¸è¶³</li></ul><h3 id="2-è°ƒåº¦æ€§èƒ½ä¼˜åŒ–"><a href="#2-è°ƒåº¦æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="2. è°ƒåº¦æ€§èƒ½ä¼˜åŒ–"></a>2. è°ƒåº¦æ€§èƒ½ä¼˜åŒ–</h3><p><strong>é…ç½®ç¤ºä¾‹</strong>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># volcano-scheduler-configmap.yaml</span><br><span class="hljs-attr">actions:</span> <span class="hljs-string">&quot;enqueue, allocate, backfill&quot;</span><br><span class="hljs-attr">arguments:</span><br>  <span class="hljs-attr">allocate.nodeorder.binpack:</span> <span class="hljs-string">&quot;cpu,memory&quot;</span><br>  <span class="hljs-attr">batch.scheduler.timeout:</span> <span class="hljs-string">&quot;10s&quot;</span><br></code></pre></td></tr></table></figure><p><strong>è°ƒä¼˜å‚æ•°</strong>ï¼š</p><ul><li><code>batch.scheduler.timeout</code>ï¼šä¼šè¯è¶…æ—¶æ—¶é—´</li><li><code>cache.workers</code>ï¼šå¹¶å‘å¤„ç†æ•°</li><li><code>profiling.enable</code>ï¼šå¯ç”¨æ€§èƒ½åˆ†æ</li></ul><h2 id="ä¸ƒã€å­¦ä¹ è·¯å¾„å»ºè®®"><a href="#ä¸ƒã€å­¦ä¹ è·¯å¾„å»ºè®®" class="headerlink" title="ä¸ƒã€å­¦ä¹ è·¯å¾„å»ºè®®"></a>ä¸ƒã€å­¦ä¹ è·¯å¾„å»ºè®®</h2><h3 id="1-æ¦‚å¿µç†è§£é¡ºåº"><a href="#1-æ¦‚å¿µç†è§£é¡ºåº" class="headerlink" title="1. æ¦‚å¿µç†è§£é¡ºåº"></a>1. æ¦‚å¿µç†è§£é¡ºåº</h3><pre><code class=" mermaid">graph LR    A[PodGroup] --&gt; B[VolcanoJob]    B --&gt; C[Queue]    C --&gt; D[è°ƒåº¦ä¼šè¯]    D --&gt; E[è°ƒåº¦åŠ¨ä½œ]    E --&gt; F[è°ƒåº¦æ’ä»¶]</code></pre><h3 id="2-å®è·µè·¯çº¿"><a href="#2-å®è·µè·¯çº¿" class="headerlink" title="2. å®è·µè·¯çº¿"></a>2. å®è·µè·¯çº¿</h3><ol><li>éƒ¨ç½²Volcanoé›†ç¾¤</li><li>æäº¤åŸºç¡€VolcanoJob</li><li>è§‚å¯ŸGangè°ƒåº¦è¡Œä¸º</li><li>é…ç½®å¤šä¼˜å…ˆçº§é˜Ÿåˆ—</li><li>å®ç°ä»»åŠ¡ä¾èµ–DAG</li><li>å¼€å‘è‡ªå®šä¹‰æ’ä»¶</li></ol><blockquote><p><strong>æ·±åº¦ç†è§£å»ºè®®</strong>ï¼šé˜…è¯»æºç æ ¸å¿ƒè·¯å¾„ï¼š</p><ul><li>è°ƒåº¦å…¥å£ï¼š<code>pkg/scheduler/scheduler.go</code> </li><li>Gangæ’ä»¶ï¼š<code>pkg/plugins/gang</code></li><li>åˆ†é…é€»è¾‘ï¼š<code>pkg/scheduler/actions/allocate</code> </li><li>ä¼šè¯ç®¡ç†ï¼š<code>pkg/scheduler/framework</code></li></ul></blockquote><p>é€šè¿‡ç»“åˆç†è®ºå­¦ä¹ å’Œå®è·µæ“ä½œï¼Œä½ å°†å…¨é¢æŒæ¡Volcanoè°ƒåº¦å™¨çš„æ ¸å¿ƒæœºåˆ¶å’Œå·¥ä½œåŸç†ã€‚</p><h2 id="å…«ã€å…·ä½“åœºæ™¯åˆ†æ"><a href="#å…«ã€å…·ä½“åœºæ™¯åˆ†æ" class="headerlink" title="å…«ã€å…·ä½“åœºæ™¯åˆ†æ"></a>å…«ã€å…·ä½“åœºæ™¯åˆ†æ</h2><h3 id="1-podgroupåœ¨é¦–æ¬¡sessionè°ƒåº¦å’Œåç»­sessionè°ƒåº¦ä¸­çš„è¡Œä¸º"><a href="#1-podgroupåœ¨é¦–æ¬¡sessionè°ƒåº¦å’Œåç»­sessionè°ƒåº¦ä¸­çš„è¡Œä¸º" class="headerlink" title="1. podgroupåœ¨é¦–æ¬¡sessionè°ƒåº¦å’Œåç»­sessionè°ƒåº¦ä¸­çš„è¡Œä¸º"></a>1. podgroupåœ¨é¦–æ¬¡sessionè°ƒåº¦å’Œåç»­sessionè°ƒåº¦ä¸­çš„è¡Œä¸º</h3><p>åœ¨ PodGroup è¿›å…¥ Running çŠ¶æ€åï¼Œ<strong>Volcano è°ƒåº¦å™¨åœ¨æ–°ä¸€è½® Session ä¸­ä»ç„¶ä¼šå°è¯•æ‰¹é‡è°ƒåº¦å‰©ä½™ Podï¼Œè€Œä¸æ˜¯ä¸¥æ ¼çš„ä¸€ä¸ªä¸€ä¸ªè°ƒåº¦</strong>ã€‚ä½†è¿™ç§â€æ‰¹é‡â€è¡Œä¸ºä¸åˆå§‹è°ƒåº¦æœ‰æœ¬è´¨åŒºåˆ«ï¼Œä¸‹é¢è¯¦ç»†è§£æï¼š</p><h4 id="è°ƒåº¦æœºåˆ¶è¯¦è§£"><a href="#è°ƒåº¦æœºåˆ¶è¯¦è§£" class="headerlink" title="è°ƒåº¦æœºåˆ¶è¯¦è§£"></a>è°ƒåº¦æœºåˆ¶è¯¦è§£</h4><pre><code class=" mermaid">graph TD    A[Sessionå¼€å§‹] --&gt; B&#123;PodGroupçŠ¶æ€&#125;    B --&gt;|Running| C[æ”¶é›†æ‰€æœ‰æœªè°ƒåº¦Pods]    C --&gt; D[æŒ‰ä¼˜å…ˆçº§æ’åºPods]    D --&gt; E[æ‰¹é‡å°è¯•åˆ†é…]    E --&gt; F&#123;èµ„æºè¶³å¤Ÿ?&#125;    F --&gt;|æ˜¯| G[æ‰¹é‡ç»‘å®šå¤šä¸ªPod]    F --&gt;|å¦| H[å°è¯•åˆ†é…éƒ¨åˆ†Pod]    H --&gt; I&#123;è‡³å°‘åˆ†é…1ä¸ª?&#125;    I --&gt;|æ˜¯| J[ç»‘å®šæˆåŠŸPod]    I --&gt;|å¦| K[ç»“æŸSession]    J --&gt; K</code></pre><h4 id="å…³é”®ç‰¹æ€§è¯´æ˜"><a href="#å…³é”®ç‰¹æ€§è¯´æ˜" class="headerlink" title="å…³é”®ç‰¹æ€§è¯´æ˜"></a>å…³é”®ç‰¹æ€§è¯´æ˜</h4><ol><li><p><strong>æ‰¹é‡å°è¯•ï¼Œä½†éåŸå­æ€§</strong></p><ul><li>è°ƒåº¦å™¨ä¼š<strong>åŒæ—¶è€ƒè™‘æ‰€æœ‰æœªè°ƒåº¦Pod</strong>çš„èµ„æºéœ€æ±‚</li><li>ä½†ä¸å†è¦æ±‚â€å…¨æœ‰æˆ–å…¨æ— â€ï¼Œå¯ä»¥éƒ¨åˆ†æˆåŠŸ</li><li>ç¤ºä¾‹ï¼šå‰©ä½™5ä¸ªPodï¼Œå¯èƒ½ä¸€æ¬¡è°ƒåº¦3ä¸ªï¼Œä¸‹æ¬¡å†è°ƒåº¦2ä¸ª</li></ul></li><li><p><strong>åˆ†é…ç­–ç•¥å˜åŒ–</strong></p><ul><li>åˆå§‹è°ƒåº¦ï¼šä¸¥æ ¼æŒ‰èµ„æºè¯·æ±‚é‡æ’åºï¼ˆå¤§èµ„æºä¼˜å…ˆï¼‰</li><li>åç»­è°ƒåº¦ï¼šé»˜è®¤æŒ‰ <strong>Pod åˆ›å»ºæ—¶é—´æ’åº</strong>ï¼ˆFIFOï¼‰ï¼Œé™¤éé…ç½®ä¼˜å…ˆçº§<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ä¼ªä»£ç ï¼šæ’åºé€»è¾‘</span><br><span class="hljs-keyword">if</span> pg.Status.Running &gt;= pg.Spec.MinAvailable &#123;<br>    pods = SortByCreationTime(unscheduledPods) <span class="hljs-comment">// åç»­è°ƒåº¦æ’åº</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    pods = SortByResourceRequest(unscheduledPods) <span class="hljs-comment">// åˆå§‹è°ƒåº¦æ’åº</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ul></li><li><p><strong>èµ„æºåˆ†é…æ–¹å¼</strong></p><ul><li><strong>å¹¶è¡Œé¢„é€‰</strong>ï¼šåŒæ—¶æ£€æŸ¥æ‰€æœ‰èŠ‚ç‚¹å¯¹å‰©ä½™Podçš„é€‚é…æ€§</li><li><strong>é¡ºåºç»‘å®š</strong>ï¼šå®é™…ç»‘å®šæ—¶æŒ‰æ’åºé¡ºåºé€ä¸ªæäº¤APIè¯·æ±‚<pre><code class=" mermaid">sequenceDiagram    è°ƒåº¦å™¨-&gt;&gt;API Server: æ‰¹é‡æäº¤Nodeé¢„é€‰è¯·æ±‚ï¼ˆå¹¶è¡Œï¼‰    API Server--&gt;&gt;è°ƒåº¦å™¨: è¿”å›å¯è¡ŒèŠ‚ç‚¹åˆ—è¡¨    è°ƒåº¦å™¨-&gt;&gt;è°ƒåº¦å™¨: ä¸ºæ¯ä¸ªPodé€‰æ‹©æœ€ä¼˜èŠ‚ç‚¹ï¼ˆæŒ‰æ’åºé¡ºåºï¼‰    å¾ªç¯ æ¯ä¸ªPod:        è°ƒåº¦å™¨-&gt;&gt;API Server: æäº¤ç»‘å®šè¯·æ±‚ï¼ˆé¡ºåºï¼‰</code></pre></li></ul></li></ol><h4 id="ä¸åˆå§‹è°ƒåº¦çš„æ ¸å¿ƒåŒºåˆ«"><a href="#ä¸åˆå§‹è°ƒåº¦çš„æ ¸å¿ƒåŒºåˆ«" class="headerlink" title="ä¸åˆå§‹è°ƒåº¦çš„æ ¸å¿ƒåŒºåˆ«"></a>ä¸åˆå§‹è°ƒåº¦çš„æ ¸å¿ƒåŒºåˆ«</h4><table><thead><tr><th><strong>ç‰¹æ€§</strong></th><th>åˆå§‹è°ƒåº¦ (PendingçŠ¶æ€)</th><th>åç»­è°ƒåº¦ (RunningçŠ¶æ€)</th></tr></thead><tbody><tr><td><strong>è°ƒåº¦å•ä½</strong></td><td>æ•´ä¸ªPodGroupï¼ˆåŸå­æ€§ï¼‰</td><td>å‰©ä½™Podé›†åˆ</td></tr><tr><td><strong>èµ„æºæ£€æŸ¥</strong></td><td>å¿…é¡»æ»¡è¶³minAvailableå¯¹åº”èµ„æº</td><td>æŒ‰å®é™…å‰©ä½™Podéœ€æ±‚</td></tr><tr><td><strong>åˆ†é…ç­–ç•¥</strong></td><td>å¤§èµ„æºPodä¼˜å…ˆ</td><td>FIFOï¼ˆé»˜è®¤ï¼‰æˆ–æŒ‰ä¼˜å…ˆçº§</td></tr><tr><td><strong>ç»“æœè¦æ±‚</strong></td><td>å…¨æœ‰æˆ–å…¨æ— </td><td>èƒ½è°ƒå¤šå°‘è°ƒå¤šå°‘</td></tr><tr><td><strong>èµ„æºé”å®š</strong></td><td>é¢„ç•™æ•´ä¸ªminAvailableèµ„æº</td><td>ä»…é¢„ç•™å®é™…åˆ†é…èµ„æº</td></tr><tr><td><strong>é‡è¯•æœºåˆ¶</strong></td><td>æ•´ä¸ªç»„é‡è¯•</td><td>å•ä¸ªPodç‹¬ç«‹é‡è¯•</td></tr></tbody></table><h4 id="å®é™…è°ƒåº¦æµç¨‹ç¤ºä¾‹"><a href="#å®é™…è°ƒåº¦æµç¨‹ç¤ºä¾‹" class="headerlink" title="å®é™…è°ƒåº¦æµç¨‹ç¤ºä¾‹"></a>å®é™…è°ƒåº¦æµç¨‹ç¤ºä¾‹</h4><p><strong>åœºæ™¯</strong>ï¼š</p><ul><li>å‰©ä½™5ä¸ªPodï¼šP1(éœ€è¦8CPU), P2(éœ€è¦1CPU), P3(éœ€è¦1CPU), P4(éœ€è¦1CPU), P5(éœ€è¦1CPU)</li><li>é›†ç¾¤ç©ºé—²èµ„æºï¼š10 CPU</li></ul><p><strong>Sessionè¿‡ç¨‹</strong>ï¼š</p><ol><li>æ”¶é›†æœªè°ƒåº¦Pods: [P1, P2, P3, P4, P5]ï¼ˆæŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼‰</li><li>æ‰¹é‡æ£€æŸ¥èŠ‚ç‚¹èµ„æºï¼š<ul><li>å‘ç°èŠ‚ç‚¹Aæœ‰10 CPUç©ºé—²</li></ul></li><li>å°è¯•åˆ†é…ï¼š<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># å°è¯•åˆ†é…P1ï¼ˆéœ€8CPUï¼‰-&gt; æˆåŠŸï¼Œå‰©ä½™èµ„æºï¼š2 CPU</span><br><span class="hljs-comment"># å°è¯•åˆ†é…P2ï¼ˆéœ€1CPUï¼‰-&gt; æˆåŠŸï¼Œå‰©ä½™èµ„æºï¼š1 CPU</span><br><span class="hljs-comment"># å°è¯•åˆ†é…P3ï¼ˆéœ€1CPUï¼‰-&gt; æˆåŠŸï¼Œå‰©ä½™èµ„æºï¼š0 CPU</span><br><span class="hljs-comment"># P4,P5æ— æ³•åˆ†é…</span><br></code></pre></td></tr></table></figure></li><li>æ‰¹é‡ç»‘å®šP1,P2,P3</li><li>æ›´æ–°çŠ¶æ€ï¼š<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">running:</span> <span class="hljs-number">13</span>  <span class="hljs-comment"># åŸ10+æ–°3</span><br><span class="hljs-attr">pending:</span> <span class="hljs-number">2</span>   <span class="hljs-comment"># P4,P5</span><br></code></pre></td></tr></table></figure></li></ol><h4 id="é«˜çº§æ§åˆ¶ï¼šå¦‚ä½•æ”¹å˜è°ƒåº¦è¡Œä¸º"><a href="#é«˜çº§æ§åˆ¶ï¼šå¦‚ä½•æ”¹å˜è°ƒåº¦è¡Œä¸º" class="headerlink" title="é«˜çº§æ§åˆ¶ï¼šå¦‚ä½•æ”¹å˜è°ƒåº¦è¡Œä¸º"></a>é«˜çº§æ§åˆ¶ï¼šå¦‚ä½•æ”¹å˜è°ƒåº¦è¡Œä¸º</h4><h4 id="1-å¯ç”¨Backfillï¼ˆå›å¡«ï¼‰æ’ä»¶"><a href="#1-å¯ç”¨Backfillï¼ˆå›å¡«ï¼‰æ’ä»¶" class="headerlink" title="1. å¯ç”¨Backfillï¼ˆå›å¡«ï¼‰æ’ä»¶"></a>1. å¯ç”¨Backfillï¼ˆå›å¡«ï¼‰æ’ä»¶</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">batch.volcano.sh/v1alpha1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Job</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">plugins:</span><br>    <span class="hljs-attr">backfill:</span> &#123;&#125;  <span class="hljs-comment"># å…è®¸å°èµ„æºä¼˜å…ˆ</span><br></code></pre></td></tr></table></figure><p>è¡Œä¸ºå˜åŒ–ï¼šå°èµ„æºPodä¼šä¼˜å…ˆäºå¤§èµ„æºPodè°ƒåº¦</p><h4 id="2-è‡ªå®šä¹‰ä¼˜å…ˆçº§"><a href="#2-è‡ªå®šä¹‰ä¼˜å…ˆçº§" class="headerlink" title="2. è‡ªå®šä¹‰ä¼˜å…ˆçº§"></a>2. è‡ªå®šä¹‰ä¼˜å…ˆçº§</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">important-task</span><br>    <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span><br>    <span class="hljs-attr">template:</span><br>      <span class="hljs-attr">metadata:</span><br>        <span class="hljs-attr">annotations:</span><br>          <span class="hljs-comment"># è®¾ç½®é«˜ä¼˜å…ˆçº§</span><br>          <span class="hljs-attr">volcano.sh/priority-class:</span> <span class="hljs-string">&quot;high&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">normal-task</span><br>    <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span><br>    <span class="hljs-attr">template:</span><br>      <span class="hljs-attr">metadata:</span><br>        <span class="hljs-attr">annotations:</span><br>          <span class="hljs-attr">volcano.sh/priority-class:</span> <span class="hljs-string">&quot;medium&quot;</span><br></code></pre></td></tr></table></figure><p>æ’åºè§„åˆ™ï¼šé«˜ä¼˜å…ˆçº§ &gt; ä¸­ä¼˜å…ˆçº§ &gt; åˆ›å»ºæ—¶é—´</p><h4 id="3-åˆ†æ‰¹æ¬¡è°ƒåº¦ç­–ç•¥"><a href="#3-åˆ†æ‰¹æ¬¡è°ƒåº¦ç­–ç•¥" class="headerlink" title="3. åˆ†æ‰¹æ¬¡è°ƒåº¦ç­–ç•¥"></a>3. åˆ†æ‰¹æ¬¡è°ƒåº¦ç­–ç•¥</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">worker</span><br>    <span class="hljs-attr">replicas:</span> <span class="hljs-number">5</span><br>    <span class="hljs-attr">policies:</span><br>      <span class="hljs-comment"># æ¯å®Œæˆ2ä¸ªPodå†è°ƒåº¦ä¸‹ä¸€æ‰¹</span><br>      <span class="hljs-attr">event:</span> <span class="hljs-string">TaskCompleted</span> <br>      <span class="hljs-attr">action:</span> <span class="hljs-string">Create</span><br>      <span class="hljs-attr">count:</span> <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><h3 id="è¯Šæ–­æŠ€å·§ï¼šéªŒè¯è°ƒåº¦è¡Œä¸º"><a href="#è¯Šæ–­æŠ€å·§ï¼šéªŒè¯è°ƒåº¦è¡Œä¸º" class="headerlink" title="è¯Šæ–­æŠ€å·§ï¼šéªŒè¯è°ƒåº¦è¡Œä¸º"></a>è¯Šæ–­æŠ€å·§ï¼šéªŒè¯è°ƒåº¦è¡Œä¸º</h3><h4 id="1-æŸ¥çœ‹è°ƒåº¦å™¨å†³ç­–æ—¥å¿—"><a href="#1-æŸ¥çœ‹è°ƒåº¦å™¨å†³ç­–æ—¥å¿—" class="headerlink" title="1. æŸ¥çœ‹è°ƒåº¦å™¨å†³ç­–æ—¥å¿—"></a>1. æŸ¥çœ‹è°ƒåº¦å™¨å†³ç­–æ—¥å¿—</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl logs -n volcano-system volcano-scheduler-xxx | grep <span class="hljs-string">&quot;Allocating remaining&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># å…¸å‹è¾“å‡º</span><br><span class="hljs-attribute">Allocating</span> <span class="hljs-number">5</span> remaining pods for pg/job-demo<span class="hljs-meta"> [phase=Running]</span><br><span class="hljs-attribute">Pod</span> scheduling order:<span class="hljs-meta"> [pod1, pod2, pod3, pod4, pod5] </span><br><span class="hljs-meta">Successfully allocated 3 pods</span><br></code></pre></td></tr></table></figure><h4 id="2-ç›‘æ§è°ƒåº¦æŒ‡æ ‡"><a href="#2-ç›‘æ§è°ƒåº¦æŒ‡æ ‡" class="headerlink" title="2. ç›‘æ§è°ƒåº¦æŒ‡æ ‡"></a>2. ç›‘æ§è°ƒåº¦æŒ‡æ ‡</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs promql"># æŸ¥çœ‹æ‰¹é‡åˆ†é…å¤§å°<br>volcano_session_pods_allocated_count&#123;phase=&quot;incremental&quot;&#125;<br><br># æŸ¥çœ‹åˆ†é…å»¶è¿Ÿ<br>volcano_pod_scheduling_duration_seconds_bucket&#123;phase=&quot;post_start&quot;&#125;<br></code></pre></td></tr></table></figure><h4 id="3-è·Ÿè¸ªPodäº‹ä»¶"><a href="#3-è·Ÿè¸ªPodäº‹ä»¶" class="headerlink" title="3. è·Ÿè¸ªPodäº‹ä»¶"></a>3. è·Ÿè¸ªPodäº‹ä»¶</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl describe pod pending-pod-name<br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Events:</span><br>  <span class="hljs-string">Type</span>     <span class="hljs-string">Reason</span>            <span class="hljs-string">Age</span>   <span class="hljs-string">From</span>                 <span class="hljs-string">Message</span><br>  <span class="hljs-string">Normal</span>   <span class="hljs-string">Scheduled</span>         <span class="hljs-string">10s</span>   <span class="hljs-string">volcano-scheduler</span>    <span class="hljs-string">Successfully</span> <span class="hljs-string">assigned</span> <span class="hljs-string">pod</span> <span class="hljs-string">(batch</span> <span class="hljs-number">2</span><span class="hljs-string">/3)</span><br>  <span class="hljs-string">Warning</span>  <span class="hljs-string">FailedScheduling</span>  <span class="hljs-string">2s</span>    <span class="hljs-string">volcano-scheduler</span>    <span class="hljs-string">not</span> <span class="hljs-string">enough</span> <span class="hljs-string">cpu</span> <span class="hljs-string">for</span> <span class="hljs-number">1</span> <span class="hljs-string">pods</span> <span class="hljs-string">in</span> <span class="hljs-string">batch</span><br></code></pre></td></tr></table></figure><h3 id="ä¸ºä»€ä¹ˆä¸æ˜¯ä¸¥æ ¼çš„ä¸€ä¸ªä¸€ä¸ªè°ƒåº¦ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆä¸æ˜¯ä¸¥æ ¼çš„ä¸€ä¸ªä¸€ä¸ªè°ƒåº¦ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆä¸æ˜¯ä¸¥æ ¼çš„ä¸€ä¸ªä¸€ä¸ªè°ƒåº¦ï¼Ÿ"></a>ä¸ºä»€ä¹ˆä¸æ˜¯ä¸¥æ ¼çš„ä¸€ä¸ªä¸€ä¸ªè°ƒåº¦ï¼Ÿ</h3><ol><li><p><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼š</p><ul><li>æ‰¹é‡å¤„ç†å‡å°‘API Serverå‹åŠ›</li><li>å•æ¬¡Sessionå®Œæˆæ›´å¤šå·¥ä½œ</li></ul></li><li><p><strong>èµ„æºåˆ©ç”¨ç‡</strong>ï¼š</p><ul><li>æ‰¹é‡è€ƒè™‘æ‰€æœ‰Podå¯åšæ›´ä¼˜æ”¾ç½®å†³ç­–</li><li>é¿å…ç¢ç‰‡åŒ–ï¼ˆå¦‚å¤šä¸ªå°Podå¯å¡«æ»¡èŠ‚ç‚¹ï¼‰</li></ul></li><li><p><strong>åŸå­æ€§é€€åŒ–ä½†ä¸æ¶ˆå¤±</strong>ï¼š</p><ul><li>å¯¹å…·æœ‰äº²å’Œæ€§çš„Podç»„ä»éœ€è¦æ‰¹é‡å¤„ç†<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">affinity:</span><br>  <span class="hljs-attr">podAffinity:</span><br>    <span class="hljs-attr">requiredDuringSchedulingIgnoredDuringExecution:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">labelSelector:</span><br>          <span class="hljs-attr">matchLabels:</span><br>            <span class="hljs-attr">app:</span> <span class="hljs-string">my-job</span><br>        <span class="hljs-attr">topologyKey:</span> <span class="hljs-string">kubernetes.io/hostname</span><br></code></pre></td></tr></table></figure></li></ul></li></ol><blockquote><p>åœ¨PodGroupè¿›å…¥RunningçŠ¶æ€åï¼ŒVolcanoé‡‡ç”¨äº† <strong>â€œå°½åŠ›è€Œä¸ºçš„æ‰¹é‡è°ƒåº¦â€</strong> ç­–ç•¥ï¼š  </p><ul><li>æ‰¹é‡è¯„ä¼°æ‰€æœ‰å‰©ä½™Pod  </li><li>æŒ‰é¡ºåºå°è¯•åˆ†é…  </li><li>æ‰¹é‡ç»‘å®šæˆåŠŸé¡¹<br>è¿™æ—¢ä¿ç•™äº†æ‰¹é‡è°ƒåº¦çš„æ•ˆç‡ä¼˜åŠ¿ï¼Œåˆé¿å…äº†åˆå§‹è°ƒåº¦çš„åŸå­æ€§çº¦æŸã€‚</li></ul></blockquote>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>volcanoæ ¸å¿ƒæ¦‚å¿µå…¥é—¨</title>
    <link href="/2025/07/26/volcano%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E5%85%A5%E9%97%A8/"/>
    <url>/2025/07/26/volcano%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E5%85%A5%E9%97%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="Volcano-æ ¸å¿ƒæ¦‚å¿µå…¥é—¨å­¦ä¹ è®²ä¹‰"><a href="#Volcano-æ ¸å¿ƒæ¦‚å¿µå…¥é—¨å­¦ä¹ è®²ä¹‰" class="headerlink" title="Volcano æ ¸å¿ƒæ¦‚å¿µå…¥é—¨å­¦ä¹ è®²ä¹‰"></a>Volcano æ ¸å¿ƒæ¦‚å¿µå…¥é—¨å­¦ä¹ è®²ä¹‰</h1><h2 id="ä¸€ã€Volcano-çš„å®šä½ä¸è§£å†³çš„é—®é¢˜ï¼ˆ1å°æ—¶ï¼‰"><a href="#ä¸€ã€Volcano-çš„å®šä½ä¸è§£å†³çš„é—®é¢˜ï¼ˆ1å°æ—¶ï¼‰" class="headerlink" title="ä¸€ã€Volcano çš„å®šä½ä¸è§£å†³çš„é—®é¢˜ï¼ˆ1å°æ—¶ï¼‰"></a>ä¸€ã€Volcano çš„å®šä½ä¸è§£å†³çš„é—®é¢˜ï¼ˆ1å°æ—¶ï¼‰</h2><h3 id="1-1-Kubernetes-åŸç”Ÿè°ƒåº¦å™¨çš„å±€é™"><a href="#1-1-Kubernetes-åŸç”Ÿè°ƒåº¦å™¨çš„å±€é™" class="headerlink" title="1.1 Kubernetes åŸç”Ÿè°ƒåº¦å™¨çš„å±€é™"></a>1.1 Kubernetes åŸç”Ÿè°ƒåº¦å™¨çš„å±€é™</h3><ul><li><strong>åŸå­æ€§è°ƒåº¦ç¼ºå¤±</strong>ï¼šæ— æ³•ä¿è¯æ‰¹é‡ä½œä¸šçš„æ‰€æœ‰ Pod åŒæ—¶å¯åŠ¨</li><li><strong>èµ„æºç¢ç‰‡é—®é¢˜</strong>ï¼šæ— æ³•å…¨å±€ä¼˜åŒ–èµ„æºåˆ†é…ï¼Œå¯¼è‡´èµ„æºæµªè´¹</li><li><strong>ä½œä¸šçº§è°ƒåº¦ç¼ºå¤±</strong>ï¼šç¼ºä¹ä½œä¸šçº§åˆ«çš„ä¼˜å…ˆçº§ã€å…¬å¹³è°ƒåº¦å’Œé˜Ÿåˆ—ç®¡ç†</li><li><strong>é«˜çº§è°ƒåº¦ç­–ç•¥ä¸è¶³</strong>ï¼šç¼ºä¹æ‹“æ‰‘è°ƒåº¦ã€ä»»åŠ¡ä¾èµ–ç­‰æ‰¹å¤„ç†åœºæ™¯ç‰¹æ€§</li></ul><h3 id="1-2-Volcano-çš„æ ¸å¿ƒä»·å€¼"><a href="#1-2-Volcano-çš„æ ¸å¿ƒä»·å€¼" class="headerlink" title="1.2 Volcano çš„æ ¸å¿ƒä»·å€¼"></a>1.2 Volcano çš„æ ¸å¿ƒä»·å€¼</h3><ul><li><strong>æ‰¹å¤„ç†åœºæ™¯ä¼˜åŒ–</strong>ï¼šä¸“ä¸º AI&#x2F;å¤§æ•°æ®&#x2F;HPC å·¥ä½œè´Ÿè½½è®¾è®¡</li><li><strong>å¢å¼ºè°ƒåº¦èƒ½åŠ›</strong>ï¼š<ul><li>Gang Schedulingï¼ˆAll-or-Nothingï¼‰</li><li>å…¬å¹³è°ƒåº¦ï¼ˆDRFï¼‰</li><li>é˜Ÿåˆ—ç®¡ç†</li><li>ä»»åŠ¡ä¾èµ–ï¼ˆDAGï¼‰</li><li>æ‹“æ‰‘æ„ŸçŸ¥è°ƒåº¦</li></ul></li><li><strong>Kubernetes åŸç”Ÿé›†æˆ</strong>ï¼šé€šè¿‡ CRD æ‰©å±• Kubernetes API</li></ul><h3 id="1-3-å…¸å‹åº”ç”¨åœºæ™¯"><a href="#1-3-å…¸å‹åº”ç”¨åœºæ™¯" class="headerlink" title="1.3 å…¸å‹åº”ç”¨åœºæ™¯"></a>1.3 å…¸å‹åº”ç”¨åœºæ™¯</h3><table><thead><tr><th>åœºæ™¯</th><th>é—®é¢˜</th><th>Volcano è§£å†³æ–¹æ¡ˆ</th></tr></thead><tbody><tr><td>TensorFlow åˆ†å¸ƒå¼è®­ç»ƒ</td><td>éœ€è¦æ‰€æœ‰ Worker åŒæ—¶å¯åŠ¨</td><td>Gang Scheduling</td></tr><tr><td>Spark æ‰¹å¤„ç†ä½œä¸š</td><td>èµ„æºç¢ç‰‡å¯¼è‡´éƒ¨åˆ† Executor æ— æ³•å¯åŠ¨</td><td>Binpack èµ„æºè£…ç®±</td></tr><tr><td>å¤šç§Ÿæˆ·ç¯å¢ƒ</td><td>å›¢é˜Ÿé—´èµ„æºäº‰æŠ¢</td><td>é˜Ÿåˆ—é…é¢ç®¡ç†</td></tr><tr><td>MPI é«˜æ€§èƒ½è®¡ç®—</td><td>è·¨èŠ‚ç‚¹ç½‘ç»œæ‹“æ‰‘è¦æ±‚</td><td>æ‹“æ‰‘æ„ŸçŸ¥è°ƒåº¦</td></tr><tr><td>Kubeflow æµæ°´çº¿</td><td>ä»»åŠ¡é—´ä¾èµ–å…³ç³»</td><td>DAG å·¥ä½œæµæ”¯æŒ</td></tr></tbody></table><h2 id="äºŒã€Volcano-æ ¸å¿ƒæ¦‚å¿µè¯¦è§£ï¼ˆ2å°æ—¶ï¼‰"><a href="#äºŒã€Volcano-æ ¸å¿ƒæ¦‚å¿µè¯¦è§£ï¼ˆ2å°æ—¶ï¼‰" class="headerlink" title="äºŒã€Volcano æ ¸å¿ƒæ¦‚å¿µè¯¦è§£ï¼ˆ2å°æ—¶ï¼‰"></a>äºŒã€Volcano æ ¸å¿ƒæ¦‚å¿µè¯¦è§£ï¼ˆ2å°æ—¶ï¼‰</h2><h3 id="2-1-PodGroupï¼šè°ƒåº¦åŸå­å•ä½"><a href="#2-1-PodGroupï¼šè°ƒåº¦åŸå­å•ä½" class="headerlink" title="2.1 PodGroupï¼šè°ƒåº¦åŸå­å•ä½"></a>2.1 PodGroupï¼šè°ƒåº¦åŸå­å•ä½</h3><p><strong>æ¦‚å¿µ</strong>ï¼š</p><ul><li>ä¸€ç»„å¿…é¡»ä½œä¸ºä¸€ä¸ªæ•´ä½“è°ƒåº¦çš„ Pod é›†åˆ</li><li>å®ç° Gang Scheduling çš„åŸºç¡€æŠ½è±¡</li></ul><p><strong>æ ¸å¿ƒå­—æ®µ</strong>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">scheduling.volcano.sh/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PodGroup</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">tf-mnist-group</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">minMember:</span> <span class="hljs-number">4</span>  <span class="hljs-comment"># æœ€å°å°±ç»ªæˆå‘˜æ•°</span><br>  <span class="hljs-attr">minResources:</span> <span class="hljs-comment"># æœ€å°èµ„æºéœ€æ±‚</span><br>    <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;8&quot;</span><br>    <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;32Gi&quot;</span><br>  <span class="hljs-attr">queue:</span> <span class="hljs-string">default</span> <span class="hljs-comment"># æ‰€å±é˜Ÿåˆ—</span><br>  <span class="hljs-attr">priorityClassName:</span> <span class="hljs-string">high-priority</span><br></code></pre></td></tr></table></figure><p><strong>å…³é”®ç‰¹æ€§</strong>ï¼š</p><ul><li><code>minMember</code>ï¼šç¡®ä¿æŒ‡å®šæ•°é‡çš„ Pod åŒæ—¶å°±ç»ª</li><li>çŠ¶æ€æœºï¼š<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">Pending</span> â†’ Runningï¼ˆèµ„æºæ»¡è¶³ï¼‰â†’ Completed/Failed<br></code></pre></td></tr></table></figure></li></ul><h3 id="2-2-VolcanoJobï¼šæ‰©å±•çš„ä½œä¸šå®šä¹‰"><a href="#2-2-VolcanoJobï¼šæ‰©å±•çš„ä½œä¸šå®šä¹‰" class="headerlink" title="2.2 VolcanoJobï¼šæ‰©å±•çš„ä½œä¸šå®šä¹‰"></a>2.2 VolcanoJobï¼šæ‰©å±•çš„ä½œä¸šå®šä¹‰</h3><p><strong>æ¦‚å¿µ</strong>ï¼š</p><ul><li>æ‰©å±• Kubernetes åŸç”Ÿ Job</li><li>æ”¯æŒå¤šä»»åŠ¡æ¨¡æ¿ï¼ˆå¦‚ Master&#x2F;Worker è§’è‰²ï¼‰</li></ul><p><strong>æ ¸å¿ƒç»“æ„</strong>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">batch.volcano.sh/v1alpha1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Job</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">tf-mnist</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">minAvailable:</span> <span class="hljs-number">4</span>  <span class="hljs-comment"># ç­‰æ•ˆäº PodGroup.minMember</span><br>  <span class="hljs-attr">schedulerName:</span> <span class="hljs-string">volcano</span><br>  <span class="hljs-attr">queue:</span> <span class="hljs-string">default</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">ps</span>  <span class="hljs-comment"># ä»»åŠ¡1ï¼šå‚æ•°æœåŠ¡å™¨</span><br>      <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>      <span class="hljs-attr">template:</span><br>        <span class="hljs-attr">spec:</span><br>          <span class="hljs-attr">containers:</span> [ <span class="hljs-string">...</span> ]<br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">worker</span>  <span class="hljs-comment"># ä»»åŠ¡2ï¼šè®¡ç®—èŠ‚ç‚¹</span><br>      <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span><br>      <span class="hljs-attr">template:</span><br>        <span class="hljs-attr">spec:</span><br>          <span class="hljs-attr">containers:</span> [ <span class="hljs-string">...</span> ]<br></code></pre></td></tr></table></figure><p><strong>ä»»åŠ¡ç±»å‹</strong>ï¼š</p><ol><li><strong>ä¸»ä»»åŠ¡</strong>ï¼ˆå¦‚ Chiefï¼‰ï¼šé€šå¸¸åªæœ‰ 1 ä¸ªå‰¯æœ¬</li><li><strong>å·¥ä½œèŠ‚ç‚¹</strong>ï¼ˆWorkerï¼‰ï¼šå¤šä¸ªå‰¯æœ¬å¹¶è¡Œè®¡ç®—</li><li><strong>å‚æ•°æœåŠ¡å™¨</strong>ï¼ˆPSï¼‰ï¼šå­˜å‚¨æ¨¡å‹å‚æ•°ï¼ˆå¯é€‰ï¼‰</li><li><strong>è¾…åŠ©ä»»åŠ¡</strong>ï¼šæ•°æ®é¢„å¤„ç†ã€æ—¥å¿—æ”¶é›†ç­‰</li></ol><h3 id="2-3-Queueï¼šèµ„æºé˜Ÿåˆ—ä¸å¤šç§Ÿæˆ·ç®¡ç†"><a href="#2-3-Queueï¼šèµ„æºé˜Ÿåˆ—ä¸å¤šç§Ÿæˆ·ç®¡ç†" class="headerlink" title="2.3 Queueï¼šèµ„æºé˜Ÿåˆ—ä¸å¤šç§Ÿæˆ·ç®¡ç†"></a>2.3 Queueï¼šèµ„æºé˜Ÿåˆ—ä¸å¤šç§Ÿæˆ·ç®¡ç†</h3><p><strong>æ¦‚å¿µ</strong>ï¼š</p><ul><li>èµ„æºåˆ†é…çš„é€»è¾‘å®¹å™¨</li><li>å®ç°å¤šç§Ÿæˆ·èµ„æºéš”ç¦»å’Œä¼˜å…ˆçº§æ§åˆ¶</li></ul><p><strong>æ ¸å¿ƒé…ç½®</strong>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">scheduling.volcano.sh/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Queue</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">ai-team</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">weight:</span> <span class="hljs-number">10</span>  <span class="hljs-comment"># é˜Ÿåˆ—æƒé‡ï¼ˆè¶Šé«˜ä¼˜å…ˆçº§è¶Šé«˜ï¼‰</span><br>  <span class="hljs-attr">capability:</span>  <span class="hljs-comment"># èµ„æºä¸Šé™</span><br>    <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;100&quot;</span><br>    <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;400Gi&quot;</span><br>    <span class="hljs-attr">nvidia.com/gpu:</span> <span class="hljs-number">16</span><br>  <span class="hljs-attr">reclaimable:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># æ˜¯å¦å…è®¸èµ„æºå›æ”¶</span><br>  <span class="hljs-attr">state:</span> <span class="hljs-string">Open</span>  <span class="hljs-comment"># Open/Closed/Draining</span><br></code></pre></td></tr></table></figure><p><strong>é˜Ÿåˆ—ç‰¹æ€§</strong>ï¼š</p><ul><li><strong>æƒé‡åˆ†é…</strong>ï¼šDRFï¼ˆä¸»å¯¼èµ„æºå…¬å¹³ï¼‰ç®—æ³•åˆ†é…èµ„æº</li><li><strong>èµ„æºå›æ”¶</strong>ï¼šä½ä¼˜å…ˆçº§ä½œä¸šå¯è¢«æŠ¢å </li><li><strong>çŠ¶æ€ç®¡ç†</strong>ï¼š<ul><li>Openï¼šæ¥å—æ–°ä½œä¸š</li><li>Closedï¼šåœæ­¢æ¥å—æ–°ä½œä¸š</li><li>Drainingï¼šæ’ç©ºç°æœ‰ä½œä¸š</li></ul></li></ul><h3 id="2-4-æ ¸å¿ƒæ¦‚å¿µå…³ç³»"><a href="#2-4-æ ¸å¿ƒæ¦‚å¿µå…³ç³»" class="headerlink" title="2.4 æ ¸å¿ƒæ¦‚å¿µå…³ç³»"></a>2.4 æ ¸å¿ƒæ¦‚å¿µå…³ç³»</h3><p><strong>èŒè´£åˆ†ç¦»ï¼ˆSeparation of Concernsï¼‰</strong></p><table><thead><tr><th align="left"><strong>å¯¹è±¡</strong></th><th align="left"><strong>èŒè´£</strong></th><th align="left"><strong>Queueçš„æ“ä½œç›®æ ‡</strong></th></tr></thead><tbody><tr><td align="left">Volcano Job</td><td align="left">æè¿°ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚Task&#x2F;Podå®šä¹‰ï¼‰</td><td align="left">ä¸ç›´æ¥å‚ä¸èµ„æºè°ƒåº¦</td></tr><tr><td align="left">PodGroup</td><td align="left">æŠ½è±¡è°ƒåº¦éœ€æ±‚ï¼ˆå¦‚minAvailableï¼‰</td><td align="left">èµ„æºåˆ†é…çš„è®¡ç®—å•å…ƒ</td></tr><tr><td align="left">Queue</td><td align="left">ç®¡ç†èµ„æºé…é¢ï¼ˆå¦‚æƒé‡&#x2F;å®¹é‡ï¼‰</td><td align="left">ä»¥PodGroupä¸ºå•ä½åˆ†é…èµ„æº</td></tr></tbody></table><img src="/2025/07/26/volcano%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E5%85%A5%E9%97%A8/deepseek_mermaid_20250812_8ad055.svg" alt="deepseek_mermaid_20250812_8ad055"><p><strong>å…³é”®è·¯å¾„</strong>ï¼š</p><ol><li>ç”¨æˆ·å®šä¹‰ Job çš„ <code>minAvailable</code> å’Œ <code>queue</code> â†’</li><li>Volcano è‡ªåŠ¨åˆ›å»ºåŒåçš„ PodGroup â†’</li><li>è°ƒåº¦å™¨åŸºäº PodGroup ä¿¡æ¯ + Queue èµ„æºçº¦æŸåšåŸå­è°ƒåº¦ â†’</li><li>ç»„å†…æ‰€æœ‰ Pod ç»Ÿä¸€ç»‘å®šèŠ‚ç‚¹ã€‚</li></ol><p><strong>è°ƒåº¦æµç¨‹ä¸­çš„å…³è”å…³ç³»</strong></p><ul><li><p><strong>Queueçš„å…³è”å¯¹è±¡</strong>ï¼š</p><ul><li><strong>ç›´æ¥å…³è”</strong>ï¼šPodGroupï¼ˆé€šè¿‡<code>.spec.queue</code>å­—æ®µç»‘å®šï¼‰</li><li><strong>é—´æ¥å…³è”</strong>ï¼šVolcano Jobï¼ˆé€šè¿‡PodGroupæ¡¥æ¥ï¼‰</li></ul></li><li><p><strong>å…³é”®ç»“è®º</strong>ï¼š</p><blockquote><p>âœ… <strong>Queueå†…éƒ¨åªæ„ŸçŸ¥PodGroup</strong>ï¼Œä¸ä¼šç›´æ¥å¤„ç†Volcano Jobå¯¹è±¡ã€‚<br>âŒ <strong>Volcano Jobä»ä¸è¿›å…¥Queue</strong>ï¼Œå®ƒåªæ˜¯PodGroupçš„åˆ›å»ºè€…ã€‚</p></blockquote></li></ul><p><strong>ä¸ºä»€ä¹ˆä¸ç›´æ¥è°ƒåº¦jobï¼Œè€Œæ˜¯ä½¿ç”¨ä¸€ä¸ªæ–°çš„CRD podgroup</strong></p><p>è§£è€¦è°ƒåº¦å•å…ƒä¸ä¸šåŠ¡å•å…ƒ</p><ul><li><p><strong>Job çš„å±€é™æ€§</strong>ï¼š</p><ul><li>æœ¬è´¨æ˜¯ä¸šåŠ¡æè¿°ï¼ˆå¦‚ Task é…ç½®ã€é•œåƒã€å‘½ä»¤ï¼‰ï¼ŒåŒ…å«è¿‡å¤šä¸<strong>è°ƒåº¦æ— å…³</strong>çš„å­—æ®µï¼ˆå¦‚å®¹å™¨ç¯å¢ƒå˜é‡ï¼‰ã€‚</li><li>è‹¥ç›´æ¥è°ƒåº¦ï¼Œè°ƒåº¦å™¨éœ€è¿‡æ»¤å¤§é‡æ— å…³æ•°æ® â†’ <strong>æ€§èƒ½ä¸‹é™</strong>ã€‚</li></ul></li><li><p><strong>PodGroup çš„ä¼˜åŠ¿</strong>ï¼š</p><ul><li><p><strong>è½»é‡åŒ–è°ƒåº¦ä¸Šä¸‹æ–‡</strong>ï¼šä»…ä¿ç•™è°ƒåº¦å…³é”®å­—æ®µï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">scheduling.volcano.sh/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PodGroup</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">minMember:</span> <span class="hljs-number">3</span>    <span class="hljs-comment"># æœ€å°è°ƒåº¦å•å…ƒæ•°</span><br>  <span class="hljs-attr">priority:</span> <span class="hljs-number">10</span>     <span class="hljs-comment"># ä¼˜å…ˆçº§</span><br>  <span class="hljs-attr">queue:</span> <span class="hljs-string">default</span>   <span class="hljs-comment"># æ‰€å±é˜Ÿåˆ—</span><br></code></pre></td></tr></table></figure></li><li><p>è°ƒåº¦å™¨åªéœ€å…³æ³¨ PodGroup è€Œéæ•´ä¸ª Job â†’ <strong>å†³ç­–æ•ˆç‡æå‡</strong>ã€‚</p></li></ul></li></ul><h2 id="ä¸‰ã€è°ƒåº¦æ ¸å¿ƒåŸç†è§£æï¼ˆ1å°æ—¶ï¼‰"><a href="#ä¸‰ã€è°ƒåº¦æ ¸å¿ƒåŸç†è§£æï¼ˆ1å°æ—¶ï¼‰" class="headerlink" title="ä¸‰ã€è°ƒåº¦æ ¸å¿ƒåŸç†è§£æï¼ˆ1å°æ—¶ï¼‰"></a>ä¸‰ã€è°ƒåº¦æ ¸å¿ƒåŸç†è§£æï¼ˆ1å°æ—¶ï¼‰</h2><h3 id="3-1-Gang-Scheduling-å·¥ä½œæµç¨‹"><a href="#3-1-Gang-Scheduling-å·¥ä½œæµç¨‹" class="headerlink" title="3.1 Gang Scheduling å·¥ä½œæµç¨‹"></a>3.1 Gang Scheduling å·¥ä½œæµç¨‹</h3><ol><li><strong>ä½œä¸šæäº¤</strong>ï¼šåˆ›å»º VolcanoJob å’Œå…³è”çš„ PodGroup</li><li><strong>èµ„æºæ£€æŸ¥</strong>ï¼šè°ƒåº¦å™¨éªŒè¯é›†ç¾¤æ˜¯å¦æ»¡è¶³ minAvailable è¦æ±‚</li><li><strong>èµ„æºé¢„ç•™</strong>ï¼šé”å®šæ‰€éœ€èµ„æºï¼ˆé˜²æ­¢è¢«å…¶ä»–ä½œä¸šå ç”¨ï¼‰</li><li><strong>åŸå­ç»‘å®š</strong>ï¼šåŒæ—¶ç»‘å®šæ‰€æœ‰ Pod åˆ°èŠ‚ç‚¹</li><li><strong>çŠ¶æ€æ›´æ–°</strong>ï¼š<ul><li>æˆåŠŸï¼šPodGroup çŠ¶æ€ â†’ Running</li><li>å¤±è´¥ï¼šPodGroup çŠ¶æ€ â†’ Pendingï¼ˆæŒç»­é‡è¯•ï¼‰</li></ul></li></ol><h3 id="3-2-è°ƒåº¦å…³é”®å†³ç­–ç‚¹"><a href="#3-2-è°ƒåº¦å…³é”®å†³ç­–ç‚¹" class="headerlink" title="3.2 è°ƒåº¦å…³é”®å†³ç­–ç‚¹"></a>3.2 è°ƒåº¦å…³é”®å†³ç­–ç‚¹</h3><ol><li><strong>é˜Ÿåˆ—é€‰æ‹©</strong>ï¼šæ ¹æ®æƒé‡åˆ†é…é˜Ÿåˆ—èµ„æºé…é¢</li><li><strong>ä½œä¸šæ’åº</strong>ï¼šåŸºäºä¼˜å…ˆçº§&#x2F;æäº¤æ—¶é—´æ’åºå¾…è°ƒåº¦ä½œä¸š</li><li><strong>èŠ‚ç‚¹è¿‡æ»¤</strong>ï¼šæ’é™¤ä¸æ»¡è¶³è¦æ±‚çš„èŠ‚ç‚¹</li><li><strong>ä»»åŠ¡ä¼˜å…ˆçº§</strong>ï¼šåŒä¸€ä½œä¸šå†…ä»»åŠ¡æ’åºï¼ˆå¦‚å…ˆè°ƒåº¦ Chiefï¼‰</li><li><strong>èµ„æºåˆ†é…</strong>ï¼šä½¿ç”¨ Binpack&#x2F;Spread ç®—æ³•åˆ†é…èŠ‚ç‚¹</li></ol><h3 id="3-3-è°ƒåº¦å™¨æ’ä»¶ä½“ç³»"><a href="#3-3-è°ƒåº¦å™¨æ’ä»¶ä½“ç³»" class="headerlink" title="3.3 è°ƒåº¦å™¨æ’ä»¶ä½“ç³»"></a>3.3 è°ƒåº¦å™¨æ’ä»¶ä½“ç³»</h3><p>Volcano é€šè¿‡æ’ä»¶å®ç°è°ƒåº¦ç­–ç•¥ï¼š</p><ul><li><strong>Enqueue</strong>ï¼šä½œä¸šå…¥é˜Ÿå†³ç­–</li><li><strong>Allocate</strong>ï¼šèµ„æºåˆ†é…å†³ç­–</li><li><strong>Preempt</strong>ï¼šæŠ¢å ç­–ç•¥</li><li><strong>Reclaim</strong>ï¼šèµ„æºå›æ”¶</li><li><strong>Overcommit</strong>ï¼šè¶…å–ç­–ç•¥</li></ul><h2 id="å››ã€å®æˆ˜ç»ƒä¹ ï¼ˆ1å°æ—¶ï¼‰"><a href="#å››ã€å®æˆ˜ç»ƒä¹ ï¼ˆ1å°æ—¶ï¼‰" class="headerlink" title="å››ã€å®æˆ˜ç»ƒä¹ ï¼ˆ1å°æ—¶ï¼‰"></a>å››ã€å®æˆ˜ç»ƒä¹ ï¼ˆ1å°æ—¶ï¼‰</h2><h3 id="4-1-ç¯å¢ƒå‡†å¤‡"><a href="#4-1-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="4.1 ç¯å¢ƒå‡†å¤‡"></a>4.1 ç¯å¢ƒå‡†å¤‡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ›å»ºæµ‹è¯•é›†ç¾¤</span><br>kind create cluster --name volcano-lab<br><br><span class="hljs-comment"># å®‰è£… Volcano</span><br>kubectl apply -f https://raw.githubusercontent.com/volcano-sh/volcano/master/installer/volcano-development.yaml<br></code></pre></td></tr></table></figure><h3 id="4-2-åˆ›å»ºé˜Ÿåˆ—"><a href="#4-2-åˆ›å»ºé˜Ÿåˆ—" class="headerlink" title="4.2 åˆ›å»ºé˜Ÿåˆ—"></a>4.2 åˆ›å»ºé˜Ÿåˆ—</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># queue.yaml</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">scheduling.volcano.sh/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Queue</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">weight:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">capability:</span><br>    <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;10&quot;</span><br>    <span class="hljs-attr">memory:</span> <span class="hljs-string">&quot;20Gi&quot;</span><br></code></pre></td></tr></table></figure><h3 id="4-3-æäº¤-VolcanoJob"><a href="#4-3-æäº¤-VolcanoJob" class="headerlink" title="4.3 æäº¤ VolcanoJob"></a>4.3 æäº¤ VolcanoJob</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># gang-demo.yaml</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">batch.volcano.sh/v1alpha1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Job</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">gang-demo</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">minAvailable:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">schedulerName:</span> <span class="hljs-string">volcano</span><br>  <span class="hljs-attr">queue:</span> <span class="hljs-string">default</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">task</span><br>      <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span><br>      <span class="hljs-attr">template:</span><br>        <span class="hljs-attr">spec:</span><br>          <span class="hljs-attr">containers:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">busybox</span><br>              <span class="hljs-attr">image:</span> <span class="hljs-string">busybox</span><br>              <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;sleep&quot;</span>, <span class="hljs-string">&quot;300&quot;</span>]<br>          <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Never</span><br></code></pre></td></tr></table></figure><h3 id="4-4-è§‚å¯Ÿè°ƒåº¦è¡Œä¸º"><a href="#4-4-è§‚å¯Ÿè°ƒåº¦è¡Œä¸º" class="headerlink" title="4.4 è§‚å¯Ÿè°ƒåº¦è¡Œä¸º"></a>4.4 è§‚å¯Ÿè°ƒåº¦è¡Œä¸º</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># è§‚å¯Ÿ PodGroup çŠ¶æ€</span><br>kubectl get podgroups.scheduling.volcano.sh<br><br><span class="hljs-comment"># æŸ¥çœ‹è°ƒåº¦å™¨å†³ç­–æ—¥å¿—</span><br>kubectl logs -n volcano-system -l app=volcano-scheduler --<span class="hljs-built_in">tail</span>=50<br></code></pre></td></tr></table></figure><h3 id="4-5-å®éªŒç»ƒä¹ "><a href="#4-5-å®éªŒç»ƒä¹ " class="headerlink" title="4.5 å®éªŒç»ƒä¹ "></a>4.5 å®éªŒç»ƒä¹ </h3><ol><li>æäº¤ minAvailable&#x3D;4 çš„ä½œä¸šï¼ˆé›†ç¾¤èµ„æºä¸è¶³ï¼‰</li><li>è§‚å¯Ÿ PodGroup çŠ¶æ€å˜åŒ–</li><li>æ‰©å®¹é›†ç¾¤åè§‚å¯Ÿè‡ªåŠ¨è°ƒåº¦</li><li>åˆ›å»ºé«˜ä¼˜å…ˆçº§ä½œä¸šæµ‹è¯•æŠ¢å åŠŸèƒ½</li></ol><h2 id="äº”ã€æ¦‚å¿µå¯¹æ¯”è¡¨"><a href="#äº”ã€æ¦‚å¿µå¯¹æ¯”è¡¨" class="headerlink" title="äº”ã€æ¦‚å¿µå¯¹æ¯”è¡¨"></a>äº”ã€æ¦‚å¿µå¯¹æ¯”è¡¨</h2><table><thead><tr><th>æ¦‚å¿µ</th><th>åŸç”Ÿ Kubernetes</th><th>Volcano</th><th>è§£å†³çš„é—®é¢˜</th></tr></thead><tbody><tr><td>è°ƒåº¦å•å…ƒ</td><td>Pod</td><td>PodGroup</td><td>åŸå­æ€§è°ƒåº¦</td></tr><tr><td>ä½œä¸šå®šä¹‰</td><td>Job</td><td>VolcanoJob</td><td>å¤šä»»åŠ¡æ¨¡æ¿æ”¯æŒ</td></tr><tr><td>èµ„æºé˜Ÿåˆ—</td><td>Namespace Quota</td><td>Queue</td><td>ä½œä¸šçº§ä¼˜å…ˆçº§&#x2F;å…¬å¹³è°ƒåº¦</td></tr><tr><td>è°ƒåº¦ç­–ç•¥</td><td>ç®€å•ä¼˜å…ˆçº§</td><td>DRF&#x2F;Binpack&#x2F;æ‹“æ‰‘è°ƒåº¦</td><td>å¤æ‚èµ„æºåˆ†é…</td></tr><tr><td>ä»»åŠ¡ä¾èµ–</td><td>æ— </td><td>DAG æ”¯æŒ</td><td>å·¥ä½œæµè°ƒåº¦</td></tr></tbody></table><h2 id="å…­ã€å­¦ä¹ æ£€æŸ¥ç‚¹"><a href="#å…­ã€å­¦ä¹ æ£€æŸ¥ç‚¹" class="headerlink" title="å…­ã€å­¦ä¹ æ£€æŸ¥ç‚¹"></a>å…­ã€å­¦ä¹ æ£€æŸ¥ç‚¹</h2><ol><li>è§£é‡Š PodGroup å¦‚ä½•è§£å†³ Gang Scheduling é—®é¢˜</li><li>ç¼–å†™ä¸€ä¸ªåŒ…å« Chief&#x2F;Worker è§’è‰²çš„ VolcanoJob</li><li>æè¿° DRF ç®—æ³•çš„åŸºæœ¬æ€æƒ³</li><li>è§£é‡Šé˜Ÿåˆ—æƒé‡å¦‚ä½•å½±å“èµ„æºåˆ†é…</li><li>è¯Šæ–­ PodGroup å¤„äº Pending çŠ¶æ€çš„å¯èƒ½åŸå› </li></ol><h2 id="ä¸ƒã€æ‰©å±•å­¦ä¹ èµ„æº"><a href="#ä¸ƒã€æ‰©å±•å­¦ä¹ èµ„æº" class="headerlink" title="ä¸ƒã€æ‰©å±•å­¦ä¹ èµ„æº"></a>ä¸ƒã€æ‰©å±•å­¦ä¹ èµ„æº</h2><ol><li><a href="https://volcano.sh/zh/docs/">Volcano å®˜æ–¹æ–‡æ¡£</a></li><li><a href="https://www.usenix.org/conference/atc19/presentation/yu">æ ¸å¿ƒè®ºæ–‡ï¼šKubernetes Native Batch System</a></li><li><a href="https://github.com/volcano-sh/volcano/tree/master/example">GitHub ç¤ºä¾‹ç›®å½•</a></li><li><a href="https://volcano.sh/zh/docs/configuration/">è°ƒåº¦å™¨é…ç½®å‚è€ƒ</a></li></ol><blockquote><p><strong>å­¦ä¹ æç¤º</strong>ï¼šåœ¨é˜¶æ®µ2çš„å­¦ä¹ ä¸­ï¼Œé‡ç‚¹ç†è§£ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼ˆPodGroup&#x2F;VolcanoJob&#x2F;Queueï¼‰çš„å…³ç³»å’Œä½œç”¨ã€‚åŠ¨æ‰‹å®è·µæ—¶ï¼Œé€šè¿‡ä¿®æ”¹<code>minAvailable</code>å€¼å¹¶è§‚å¯Ÿç³»ç»Ÿè¡Œä¸ºï¼Œå¯ç›´è§‚ä½“ä¼šGang Schedulingçš„å·¥ä½œåŸç†ã€‚</p></blockquote>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼è®­ç»ƒ</title>
    <link href="/2025/07/26/%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%AD%E7%BB%83/"/>
    <url>/2025/07/26/%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%AD%E7%BB%83/</url>
    
    <content type="html"><![CDATA[<h1 id="åˆ†å¸ƒå¼è®­ç»ƒçš„ç”±æ¥"><a href="#åˆ†å¸ƒå¼è®­ç»ƒçš„ç”±æ¥" class="headerlink" title="åˆ†å¸ƒå¼è®­ç»ƒçš„ç”±æ¥"></a>åˆ†å¸ƒå¼è®­ç»ƒçš„ç”±æ¥</h1><p>å¥½çš„ï¼Œæˆ‘ä»¬æ¥å½»åº•è§£æä¸€ä¸‹ <strong>åˆ†å¸ƒå¼è®­ç»ƒçš„åŸç†</strong>ï¼Œå¹¶ä»¥ <strong>MNISTæ‰‹å†™æ•°å­—è¯†åˆ«</strong> ä¸ºä¾‹ï¼Œè¯¦ç»†è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦é‚£4ä¸ªPodï¼ˆChief, PS, Workerï¼‰ã€‚ç†è§£è¿™ä¸ªï¼Œä½ å°±èƒ½æ˜ç™½Volcanoè¿™ç±»è°ƒåº¦å™¨çš„å¿…è¦æ€§äº†ã€‚</p><hr><h3 id="ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼è®­ç»ƒï¼Ÿ"><a href="#ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼è®­ç»ƒï¼Ÿ" class="headerlink" title="ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼è®­ç»ƒï¼Ÿ"></a>ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼è®­ç»ƒï¼Ÿ</h3><p>æƒ³è±¡ä½ è¦è®­ç»ƒä¸€ä¸ªè¯†åˆ«æ‰‹å†™æ•°å­—çš„æ¨¡å‹ï¼ˆMNISTï¼‰ï¼š</p><ul><li><strong>å•æœºè®­ç»ƒï¼š</strong> ä½ æœ‰ä¸€å°å¼ºå¤§çš„æœåŠ¡å™¨ï¼Œä¸Šé¢æœ‰8å—GPUã€‚ä½ æŠŠæ‰€æœ‰è®­ç»ƒæ•°æ®ï¼ˆ6ä¸‡å¼ å›¾ç‰‡ï¼‰æ‰”è¿›å»ï¼Œæ¨¡å‹åœ¨8å—GPUä¸Šå¹¶è¡Œè®¡ç®—ï¼ˆæ•°æ®å¹¶è¡Œï¼‰ï¼Œé€Ÿåº¦å¾ˆå¿«ã€‚</li><li><strong>ç°å®é™åˆ¶ï¼š</strong><ul><li>æ¨¡å‹è¶Šæ¥è¶Šå¤§ï¼ˆå¦‚GPT-3ï¼‰ï¼Œå‚æ•°è¾¾åˆ°åƒäº¿çº§åˆ«ï¼Œå•å°æœºå™¨è£…ä¸ä¸‹ã€‚</li><li>è®­ç»ƒæ•°æ®é‡çˆ†ç‚¸ï¼ˆTB&#x2F;PBçº§ï¼‰ï¼Œå•æœºè¯»å–å’Œå¤„ç†å¤ªæ…¢ã€‚</li><li>å•å°æœºå™¨çš„GPUæ•°é‡æœ‰ä¸Šé™ï¼ˆæ¯”å¦‚8å—ã€16å—ï¼‰ï¼Œæ— æ³•æ»¡è¶³è¶…å¤§è§„æ¨¡è®­ç»ƒéœ€æ±‚ã€‚</li></ul></li><li><strong>è§£å†³æ–¹æ¡ˆï¼šåˆ†å¸ƒå¼è®­ç»ƒï¼</strong> æŠŠè®¡ç®—ä»»åŠ¡ï¼ˆæ¨¡å‹ã€æ•°æ®ï¼‰æ‹†åˆ†åˆ°<strong>å¤šå°æœºå™¨ï¼ˆå¤šä¸ªPodï¼‰</strong> ä¸ŠååŒå·¥ä½œï¼Œå…±åŒå®Œæˆè®­ç»ƒã€‚</li></ul><hr><h3 id="äºŒã€åˆ†å¸ƒå¼è®­ç»ƒçš„æ ¸å¿ƒåŸç†ï¼šåˆ†è€Œæ²»ä¹‹"><a href="#äºŒã€åˆ†å¸ƒå¼è®­ç»ƒçš„æ ¸å¿ƒåŸç†ï¼šåˆ†è€Œæ²»ä¹‹" class="headerlink" title="äºŒã€åˆ†å¸ƒå¼è®­ç»ƒçš„æ ¸å¿ƒåŸç†ï¼šåˆ†è€Œæ²»ä¹‹"></a>äºŒã€åˆ†å¸ƒå¼è®­ç»ƒçš„æ ¸å¿ƒåŸç†ï¼šåˆ†è€Œæ²»ä¹‹</h3><p>æ ¸å¿ƒæ€æƒ³æ˜¯å°†<strong>æ¨¡å‹å‚æ•°ï¼ˆParametersï¼‰</strong> å’Œ<strong>è®­ç»ƒæ•°æ®ï¼ˆTraining Dataï¼‰</strong> çš„å­˜å‚¨ä¸è®¡ç®—åˆ†æ•£åˆ°å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œå¹¶é€šè¿‡<strong>ç½‘ç»œé€šä¿¡</strong>æ¥åè°ƒå®ƒä»¬ã€‚ä¸»è¦æœ‰ä¸¤ç§ä¸»æµæ¶æ„ï¼š</p><h4 id="1-Parameter-Server-PS-æ¶æ„-TensorFlow-æ—©æœŸå¸¸ç”¨"><a href="#1-Parameter-Server-PS-æ¶æ„-TensorFlow-æ—©æœŸå¸¸ç”¨" class="headerlink" title="1. Parameter Server (PS) æ¶æ„ (TensorFlow æ—©æœŸå¸¸ç”¨)"></a>1. Parameter Server (PS) æ¶æ„ (TensorFlow æ—©æœŸå¸¸ç”¨)</h4>   <pre><code class=" mermaid">graph LR  Client[Chief/Client] --&gt;|åè°ƒ| PS[Parameter Server]  PS --&gt;|åˆ†å‘å‚æ•°/æ”¶é›†æ¢¯åº¦| Worker1[Worker 1]  PS --&gt;|åˆ†å‘å‚æ•°/æ”¶é›†æ¢¯åº¦| Worker2[Worker 2]  PS --&gt;|...| WorkerN[Worker N]</code></pre><ul><li><strong>Parameter Server (PS):</strong><ul><li><strong>è§’è‰²ï¼š</strong> ä¸­å¤®ä»“åº“ã€‚</li><li><strong>èŒè´£ï¼š</strong> å­˜å‚¨æ¨¡å‹çš„<strong>æ‰€æœ‰å‚æ•°ï¼ˆWeights, Biasesï¼‰</strong>ã€‚</li><li><strong>å·¥ä½œæµç¨‹ï¼š</strong><ol><li>æ¥æ”¶æ¥è‡ªWorkersè®¡ç®—å¾—åˆ°çš„<strong>æ¢¯åº¦ï¼ˆGradientsï¼‰</strong>ã€‚</li><li>èšåˆæ‰€æœ‰Workersçš„æ¢¯åº¦ï¼ˆé€šå¸¸æ˜¯æ±‚å¹³å‡ï¼‰ã€‚</li><li>æ ¹æ®èšåˆåçš„æ¢¯åº¦<strong>æ›´æ–°è‡ªå·±å­˜å‚¨çš„æ¨¡å‹å‚æ•°</strong>ã€‚</li><li>å°†æ›´æ–°åçš„å‚æ•°<strong>åˆ†å‘</strong>ç»™æ‰€æœ‰Workersã€‚</li></ol></li></ul></li><li><strong>Worker:</strong><ul><li><strong>è§’è‰²ï¼š</strong> è®¡ç®—å·¥äººã€‚</li><li><strong>èŒè´£ï¼š</strong><ol><li>ä»PSè·å–<strong>å½“å‰æœ€æ–°çš„æ¨¡å‹å‚æ•°</strong>ã€‚</li><li>åˆ†é…åˆ°è‡ªå·±çš„ä¸€å°æ‰¹<strong>è®­ç»ƒæ•°æ®ï¼ˆBatchï¼‰</strong>ã€‚</li><li>ç”¨æ•°æ®å’Œå‚æ•°è¿›è¡Œ<strong>å‰å‘ä¼ æ’­ï¼ˆForward Passï¼‰</strong> è®¡ç®—é¢„æµ‹å€¼ã€‚</li><li>è®¡ç®—<strong>æŸå¤±ï¼ˆLossï¼‰</strong>ã€‚</li><li>è¿›è¡Œ<strong>åå‘ä¼ æ’­ï¼ˆBackward Passï¼‰</strong> è®¡ç®—<strong>æ¢¯åº¦ï¼ˆGradientsï¼‰</strong>ã€‚</li><li>å°†è®¡ç®—å‡ºçš„æ¢¯åº¦<strong>å‘é€</strong>ç»™PSã€‚</li></ol></li></ul></li><li><strong>Chief &#x2F; Master &#x2F; Client (æœ‰æ—¶ä¸æŸä¸ªWorkeråˆå¹¶):</strong><ul><li><strong>è§’è‰²ï¼š</strong> å·¥å¤´&#x2F;ç®¡ç†å‘˜ã€‚</li><li><strong>èŒè´£ï¼š</strong><ul><li>åˆå§‹åŒ–æ¨¡å‹å‚æ•°ï¼ˆé€šå¸¸æ”¾åœ¨PSä¸Šï¼‰ã€‚</li><li>ç®¡ç†è®­ç»ƒæµç¨‹ï¼ˆå¼€å§‹ã€åœæ­¢ã€è®¾ç½®epochæ•°ç­‰ï¼‰ã€‚</li><li>åè°ƒWorkerå’ŒPSçš„å·¥ä½œï¼ˆéç»å¯¹å¿…è¦ï¼Œä½†å¸¸è§ï¼‰ã€‚</li><li>è´Ÿè´£åš<strong>è¯„ä¼°ï¼ˆEvaluationï¼‰</strong>ã€ä¿å­˜<strong>æ£€æŸ¥ç‚¹ï¼ˆCheckpointï¼‰</strong>ã€å†™<strong>æ—¥å¿—ï¼ˆLoggingï¼‰</strong> ç­‰ç®¡ç†ä»»åŠ¡ã€‚</li></ul></li></ul></li><li><strong>å…³é”®ç‚¹ï¼š</strong><ul><li>PS æ˜¯ç“¶é¢ˆï¼šæ‰€æœ‰æ¢¯åº¦æ±‡èšå’Œå‚æ•°æ›´æ–°éƒ½ç»è¿‡å®ƒï¼Œç½‘ç»œå’Œè®¡ç®—å‹åŠ›å¤§ã€‚</li><li>éœ€è¦<strong>åŒæ­¥ï¼ˆSynchronousï¼‰</strong>ï¼šé€šå¸¸ç­‰æ‰€æœ‰Workeréƒ½å®Œæˆä¸€ä¸ªBatchçš„è®¡ç®—å¹¶å‘é€æ¢¯åº¦ç»™PSåï¼ŒPSæ‰è¿›è¡Œæ›´æ–°å’Œåˆ†å‘ã€‚è¿™ä¿è¯äº†æ‰€æœ‰Workeråœ¨åŒä¸€æ—¶é—´ç‚¹ç”¨çš„æ˜¯<strong>ç›¸åŒç‰ˆæœ¬çš„å‚æ•°</strong>ã€‚</li><li><strong>â€œAll-or-Nothingâ€ éœ€æ±‚ï¼š</strong> å¦‚æœä»»ä½•ä¸€ä¸ªWorkeræˆ–PSæŒ‚æ‰ï¼Œæ•´ä¸ªè®­ç»ƒè¿‡ç¨‹å°±ä¼šå¡ä½æˆ–å‡ºé”™ï¼Œå› ä¸ºæ¢¯åº¦èšåˆä¸å®Œæ•´æˆ–å‚æ•°æ— æ³•æ›´æ–°åˆ†å‘ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦Gang Schedulingä¿è¯å®ƒä»¬åŒæ—¶å¯åŠ¨ã€‚</li></ul></li></ul><h4 id="2-All-Reduce-æ¶æ„-PyTorch-DDP-Horovod-TensorFlow-MirroredStrategy-å¸¸ç”¨"><a href="#2-All-Reduce-æ¶æ„-PyTorch-DDP-Horovod-TensorFlow-MirroredStrategy-å¸¸ç”¨" class="headerlink" title="2. All-Reduce æ¶æ„ (PyTorch DDP, Horovod, TensorFlow MirroredStrategy å¸¸ç”¨)"></a>2. All-Reduce æ¶æ„ (PyTorch DDP, Horovod, TensorFlow MirroredStrategy å¸¸ç”¨)</h4>   <pre><code class=" mermaid">graph LR  Worker1[Worker 1] -- æ¢¯åº¦ --&gt; Ring  Worker2[Worker 2] -- æ¢¯åº¦ --&gt; Ring  Worker3[Worker 3] -- æ¢¯åº¦ --&gt; Ring  WorkerN[Worker N] -- æ¢¯åº¦ --&gt; Ring  Ring[é€šä¿¡ç¯ All-Reduce]</code></pre><ul><li><strong>æ ¸å¿ƒæ€æƒ³ï¼š</strong> æ¶ˆé™¤ä¸­å¿ƒåŒ–çš„PSã€‚<strong>æ¯ä¸ªWorker</strong>éƒ½å­˜å‚¨<strong>ä¸€ä»½å®Œæ•´çš„æ¨¡å‹å‰¯æœ¬</strong>ã€‚</li><li><strong>å·¥ä½œæµç¨‹ï¼š</strong><ol><li>æ¯ä¸ªWorkerç”¨è‡ªå·±çš„Batchæ•°æ®ç‹¬ç«‹è¿›è¡Œ<strong>å‰å‘ä¼ æ’­</strong>å’Œ<strong>åå‘ä¼ æ’­</strong>ï¼Œè®¡ç®—å‡º<strong>æœ¬åœ°æ¢¯åº¦</strong>ã€‚</li><li>æ‰€æœ‰Workerä½¿ç”¨é«˜æ•ˆçš„<strong>All-Reduce</strong>é€šä¿¡åŸè¯­ï¼ˆå¦‚Ring-AllReduceï¼‰è¿›è¡Œé€šä¿¡ã€‚<ul><li><strong>ç›®æ ‡ï¼š</strong> è®©<strong>æ¯ä¸ªWorker</strong>éƒ½å¾—åˆ°<strong>æ‰€æœ‰Workeræ¢¯åº¦çš„å¹³å‡å€¼</strong>ã€‚</li></ul></li><li>æ¯ä¸ªWorker<strong>ç‹¬ç«‹åœ°ç”¨è¿™ä¸ªå¹³å‡æ¢¯åº¦æ›´æ–°è‡ªå·±æœ¬åœ°çš„æ¨¡å‹å‚æ•°</strong>ã€‚</li></ol></li><li><strong>ä¼˜åŠ¿ï¼š</strong><ul><li>æ¶ˆé™¤äº†PSç“¶é¢ˆï¼Œé€šä¿¡è´Ÿè½½æ›´å‡è¡¡åœ°åˆ†æ•£åˆ°æ‰€æœ‰WorkerèŠ‚ç‚¹ä¸Šã€‚</li><li>é€šå¸¸æ¯”PSæ¶æ„å…·æœ‰æ›´å¥½çš„æ‰©å±•æ€§å’Œæ€§èƒ½ï¼Œå°¤å…¶åœ¨é«˜å¸¦å®½ç½‘ç»œç¯å¢ƒä¸‹ã€‚</li></ul></li><li><strong>å…³é”®ç‚¹ï¼š</strong><ul><li>ä»ç„¶éœ€è¦<strong>åŒæ­¥ï¼š</strong> All-Reduceæ“ä½œéœ€è¦æ‰€æœ‰Workeréƒ½å‚ä¸æ‰èƒ½å®Œæˆã€‚</li><li><strong>â€œAll-or-Nothingâ€ éœ€æ±‚ä¾ç„¶å­˜åœ¨ï¼š</strong> å¦‚æœä¸€ä¸ªWorkeræŒ‚æ‰ï¼ŒAll-Reduceæ“ä½œå°±æ— æ³•å®Œæˆï¼Œæ•´ä¸ªè®­ç»ƒå°±ä¼šå¡ä½ã€‚</li><li><strong>Chief&#x2F;Masterè§’è‰²ï¼š</strong> é€šå¸¸ä»ç„¶éœ€è¦ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆæˆ–æŒ‡å®šä¸€ä¸ªWorkerå…¼ä»»ï¼‰æ¥è´Ÿè´£å…¨å±€åè°ƒï¼ˆå¯åŠ¨ã€ç›‘æ§ã€ä¿å­˜Checkpointç­‰ï¼‰ã€‚</li></ul></li></ul><hr><h3 id="ä¸‰ã€èšç„¦MNISTï¼šä¸ºä»€ä¹ˆéœ€è¦4ä¸ªPodï¼Ÿ"><a href="#ä¸‰ã€èšç„¦MNISTï¼šä¸ºä»€ä¹ˆéœ€è¦4ä¸ªPodï¼Ÿ" class="headerlink" title="ä¸‰ã€èšç„¦MNISTï¼šä¸ºä»€ä¹ˆéœ€è¦4ä¸ªPodï¼Ÿ"></a>ä¸‰ã€èšç„¦MNISTï¼šä¸ºä»€ä¹ˆéœ€è¦4ä¸ªPodï¼Ÿ</h3><p>ç°åœ¨å›åˆ°ä½ çœ‹åˆ°çš„MNISTåˆ†å¸ƒå¼TensorFlowè®­ç»ƒä¾‹å­ï¼ˆå‡è®¾ä½¿ç”¨çš„æ˜¯PSæ¶æ„ï¼‰ï¼š</p><ol><li><p><strong><code>1 x Chief Pod</code>ï¼š</strong></p><ul><li><strong>èŒè´£ï¼š</strong> è¿™æ˜¯è®­ç»ƒçš„æ€»æŒ‡æŒ¥ã€‚å®ƒè´Ÿè´£ï¼š<ul><li>å®šä¹‰æ¨¡å‹ç»“æ„ã€‚</li><li>åˆå§‹åŒ–å…¨å±€å‚æ•°ï¼ˆå¹¶å‘Šè¯‰PSåˆå§‹å€¼æ˜¯ä»€ä¹ˆï¼‰ã€‚</li><li>å¯åŠ¨è®­ç»ƒä»»åŠ¡ã€‚</li><li>ç›‘æ§è®­ç»ƒè¿›åº¦ï¼ˆå¦‚è®¡ç®—å…¨å±€Lossï¼Œè™½ç„¶Lossè®¡ç®—é€šå¸¸ä¹Ÿåˆ†å¸ƒåœ¨Workerä¸Šï¼‰ã€‚</li><li>ä¿å­˜è®­ç»ƒå¥½çš„æ¨¡å‹æ£€æŸ¥ç‚¹ï¼ˆCheckpointï¼‰ã€‚</li><li>è´Ÿè´£æœ€ç»ˆçš„æ¨¡å‹è¯„ä¼°ï¼ˆå¦‚æœéœ€è¦ï¼‰ã€‚</li></ul></li><li><strong>èµ„æºï¼š</strong> å¯èƒ½ä¸éœ€è¦GPUï¼Œæˆ–è€…åªéœ€è¦å°‘é‡èµ„æºç”¨äºç®¡ç†ä»»åŠ¡ã€‚</li></ul></li><li><p><strong><code>1 x Parameter Server (PS) Pod</code>ï¼š</strong></p><ul><li><strong>èŒè´£ï¼š</strong> è¿™æ˜¯æ¨¡å‹çš„ä¸­å¤®ä»“åº“ã€‚å®ƒåªåšä¸€ä»¶äº‹ï¼š<ul><li>å­˜å‚¨æ¨¡å‹çš„æ‰€æœ‰å‚æ•°ï¼ˆæƒé‡Wå’Œåç½®bï¼‰ã€‚</li><li>æ¥æ”¶æ¥è‡ªWorkersçš„æ¢¯åº¦ã€‚</li><li>èšåˆæ¢¯åº¦ï¼ˆæ±‚å¹³å‡ï¼‰ã€‚</li><li>ç”¨èšåˆåçš„æ¢¯åº¦æ›´æ–°å‚æ•°ã€‚</li><li>æŠŠæ›´æ–°åçš„å‚æ•°å‘é€ç»™Workersã€‚</li></ul></li><li><strong>èµ„æºï¼š</strong> å¯¹è®¡ç®—èƒ½åŠ›è¦æ±‚ä¸é«˜ï¼ˆä¸»è¦æ˜¯å­˜å‚¨å’Œç½‘ç»œIOï¼‰ï¼Œä½†éœ€è¦è¶³å¤Ÿå†…å­˜å­˜å‚¨æ¨¡å‹å‚æ•°ã€‚å¯¹äºMNISTè¿™ç§å°æ¨¡å‹ï¼ŒCPUè¶³å¤Ÿï¼›å¯¹äºå¤§æ¨¡å‹ï¼ŒPSä¹Ÿå¯èƒ½éœ€è¦é«˜å†…å­˜ã€‚</li></ul></li><li><p><strong><code>2 x Worker Pod</code>ï¼š</strong></p><ul><li><strong>èŒè´£ï¼š</strong> è¿™æ˜¯å¹²é‡æ´»çš„è®¡ç®—å•å…ƒã€‚æ¯ä¸ªWorkerï¼š<ul><li>ä»PSè·å–æœ€æ–°çš„æ¨¡å‹å‚æ•°ã€‚</li><li>åˆ†é…åˆ°è‡ªå·±çš„<strong>ä¸€éƒ¨åˆ†MNISTè®­ç»ƒæ•°æ®</strong>ï¼ˆæ¯”å¦‚æ€»6ä¸‡å¼ å›¾ï¼ŒWorker1æ‹¿å‰3ä¸‡å¼ çš„ä¸€ä¸ªBatchï¼ŒWorker2æ‹¿å3ä¸‡å¼ çš„ä¸€ä¸ªBatchï¼‰ã€‚</li><li>ç”¨è‡ªå·±çš„æ•°æ®å’Œå‚æ•°è¿›è¡Œ<strong>å‰å‘ä¼ æ’­</strong>ï¼ˆè®¡ç®—é¢„æµ‹å€¼ï¼‰ã€‚</li><li>è®¡ç®—<strong>æŸå¤±</strong>ï¼ˆé¢„æµ‹å€¼ vs çœŸå®æ ‡ç­¾ï¼‰ã€‚</li><li>è¿›è¡Œ<strong>åå‘ä¼ æ’­</strong>ï¼ˆè®¡ç®—æ¢¯åº¦ï¼šæ¨¡å‹å‚æ•°åº”è¯¥å¦‚ä½•è°ƒæ•´æ‰èƒ½å‡å°‘æŸå¤±ï¼‰ã€‚</li><li>å°†è®¡ç®—å‡ºçš„æ¢¯åº¦å‘é€ç»™PSã€‚</li></ul></li><li><strong>èµ„æºï¼š</strong> éœ€è¦ä¸»è¦çš„è®¡ç®—èµ„æºï¼ˆGPUï¼‰æ¥è¿›è¡Œå‰å‘å’Œåå‘ä¼ æ’­ã€‚MNISTæ¨¡å‹å°ï¼Œ1ä¸ªWorkerä¹Ÿèƒ½è·‘ï¼Œä½†2ä¸ªWorkeræ¼”ç¤ºäº†å¹¶è¡Œã€‚å®é™…å¤§è§„æ¨¡è®­ç»ƒå¯èƒ½éœ€è¦å‡ åä¸Šç™¾ä¸ªWorkerã€‚</li></ul></li></ol><hr><h3 id="å››ã€ä¸ºä»€ä¹ˆè¿™4ä¸ªPodå¿…é¡»â€œåŒç”Ÿå…±æ­»â€ï¼ˆGang-Schedulingï¼‰ï¼Ÿ"><a href="#å››ã€ä¸ºä»€ä¹ˆè¿™4ä¸ªPodå¿…é¡»â€œåŒç”Ÿå…±æ­»â€ï¼ˆGang-Schedulingï¼‰ï¼Ÿ" class="headerlink" title="å››ã€ä¸ºä»€ä¹ˆè¿™4ä¸ªPodå¿…é¡»â€œåŒç”Ÿå…±æ­»â€ï¼ˆGang Schedulingï¼‰ï¼Ÿ"></a>å››ã€ä¸ºä»€ä¹ˆè¿™4ä¸ªPodå¿…é¡»â€œåŒç”Ÿå…±æ­»â€ï¼ˆGang Schedulingï¼‰ï¼Ÿ</h3><ol><li><p><strong>åŒæ­¥éœ€æ±‚ï¼š</strong></p><ul><li><strong>PSæ¶æ„ï¼š</strong> PSéœ€è¦æ”¶é›†<strong>æ‰€æœ‰Worker</strong>çš„æ¢¯åº¦æ‰èƒ½è¿›è¡Œå‚æ•°æ›´æ–°ã€‚å¦‚æœWorker2æ²¡å¯åŠ¨ï¼ŒWorker1çš„æ¢¯åº¦å‘åˆ°PSï¼ŒPSä¼šä¸€ç›´ç­‰å¾…Worker2çš„æ¢¯åº¦ï¼ˆæˆ–è€…è¶…æ—¶å¤±è´¥ï¼‰ã€‚è®­ç»ƒæ— æ³•è¿›è¡Œã€‚</li><li><strong>All-Reduceæ¶æ„ï¼š</strong> All-Reduceæ“ä½œéœ€è¦<strong>æ‰€æœ‰Worker</strong>å‚ä¸é€šä¿¡ã€‚å°‘ä¸€ä¸ªWorkerï¼Œé€šä¿¡ç¯å°±æ–­äº†ï¼Œæ“ä½œæ— æ³•å®Œæˆã€‚è®­ç»ƒå¡æ­»ã€‚</li><li><strong>Chiefçš„åè°ƒï¼š</strong> Chieféœ€è¦çŸ¥é“æ‰€æœ‰Workerå’ŒPSçš„çŠ¶æ€æ¥ç®¡ç†æ•´ä¸ªè®­ç»ƒç”Ÿå‘½å‘¨æœŸã€‚å¦‚æœéƒ¨åˆ†èŠ‚ç‚¹ç¼ºå¤±ï¼ŒChiefæ— æ³•æ­£ç¡®å¯åŠ¨æˆ–ç›‘æ§è®­ç»ƒã€‚</li></ul></li><li><p><strong>èµ„æºæ­»é”ï¼š</strong></p><ul><li>å‡è®¾é›†ç¾¤èµ„æºç´§å¼ ã€‚å¦‚æœå…è®¸éƒ¨åˆ†å¯åŠ¨ï¼š<ul><li>Chiefå’ŒPSå…ˆå¯åŠ¨äº†ã€‚</li><li>Worker1å¯åŠ¨äº†ï¼Œå ç”¨äº†æœ€åä¸€å—ç©ºé—²GPUã€‚</li><li>Worker2å› ä¸ºæ²¡GPUå¡åœ¨Pendingã€‚</li></ul></li><li>ç»“æœï¼šChiefã€PSã€Worker1åœ¨è¿è¡Œï¼Œä½†å®ƒä»¬<strong>ä»€ä¹ˆæœ‰ç”¨çš„è®­ç»ƒéƒ½åšä¸äº†</strong>ï¼ˆå› ä¸ºWorker2ç¼ºå¤±å¯¼è‡´åŒæ­¥å¤±è´¥ï¼‰ã€‚å®ƒä»¬å ç€èµ„æºï¼ˆå°¤å…¶æ˜¯Worker1çš„GPUï¼‰å´æ— æ³•å®Œæˆå·¥ä½œã€‚Worker2åœ¨ç­‰GPUï¼ŒGPUè¢«ä¸€ä¸ªæ— æ³•å·¥ä½œçš„Worker1å ç€ã€‚è¿™å°±æ˜¯<strong>èµ„æºæ­»é”</strong>ã€‚</li></ul></li><li><p><strong>æµªè´¹èµ„æºï¼š</strong></p><ul><li>å¦‚ä¸Šæ‰€è¿°ï¼Œéƒ¨åˆ†å¯åŠ¨çš„Podæ¶ˆè€—ç€CPUã€å†…å­˜ã€GPUã€ç½‘ç»œå¸¦å®½ï¼Œå´æ— æ³•æ¨è¿›è®­ç»ƒä»»åŠ¡ï¼Œçº¯ç²¹æ˜¯æµªè´¹é’±ï¼ˆäº‘ç¯å¢ƒï¼‰æˆ–è®¡ç®—èµ„æºã€‚</li></ul></li><li><p><strong>æ¡†æ¶é€»è¾‘ï¼š</strong></p><ul><li>TensorFlow&#x2F;PyTorchç­‰åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶çš„è®¾è®¡é€»è¾‘å°±æ˜¯åŸºäºæ‰€æœ‰èŠ‚ç‚¹éƒ½å¯ç”¨ã€‚å®ƒä»¬å†…éƒ¨çš„é€šä¿¡åº“ï¼ˆå¦‚gRPC, NCCLï¼‰ä¼šå°è¯•è¿æ¥é…ç½®ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ã€‚èŠ‚ç‚¹ç¼ºå¤±ä¼šå¯¼è‡´è¿æ¥å¤±è´¥ã€è¶…æ—¶ã€å¼‚å¸¸ï¼Œæœ€ç»ˆå¯¼è‡´è®­ç»ƒä½œä¸šå¤±è´¥ã€‚</li></ul></li></ol><hr><h3 id="äº”ã€æ€»ç»“ï¼šåˆ†å¸ƒå¼è®­ç»ƒä¸Volcanoçš„å®Œç¾å¥‘åˆ"><a href="#äº”ã€æ€»ç»“ï¼šåˆ†å¸ƒå¼è®­ç»ƒä¸Volcanoçš„å®Œç¾å¥‘åˆ" class="headerlink" title="äº”ã€æ€»ç»“ï¼šåˆ†å¸ƒå¼è®­ç»ƒä¸Volcanoçš„å®Œç¾å¥‘åˆ"></a>äº”ã€æ€»ç»“ï¼šåˆ†å¸ƒå¼è®­ç»ƒä¸Volcanoçš„å®Œç¾å¥‘åˆ</h3><ul><li><strong>åˆ†å¸ƒå¼è®­ç»ƒçš„æœ¬è´¨</strong> æ˜¯å°†å¤§å‹æ¨¡å‹&#x2F;æ•°æ®çš„è®¡ç®—ä»»åŠ¡æ‹†åˆ†åˆ°å¤šä¸ªèŠ‚ç‚¹ååŒå®Œæˆï¼Œæ ¸å¿ƒæ˜¯<strong>åŒæ­¥</strong>ï¼ˆå‚æ•°&#x2F;æ¢¯åº¦ä¸€è‡´æ€§ï¼‰ã€‚</li><li><strong>PSæˆ–All-Reduceæ¶æ„</strong> æ˜¯å®ç°åŒæ­¥çš„ä¸åŒæ–¹å¼ï¼Œä½†éƒ½<strong>å¼ºä¾èµ–æ‰€æœ‰è®¡ç®—èŠ‚ç‚¹ï¼ˆWorkerï¼‰åŒæ—¶åœ¨çº¿å·¥ä½œ</strong>ã€‚ç®¡ç†èŠ‚ç‚¹ï¼ˆChiefï¼‰å’Œå­˜å‚¨èŠ‚ç‚¹ï¼ˆPSï¼Œå¦‚æœå­˜åœ¨ï¼‰ä¹Ÿè‡³å…³é‡è¦ã€‚</li><li><strong>MNISTçš„4ä¸ªPodç¤ºä¾‹</strong> æ¸…æ™°åœ°å±•ç¤ºäº†åˆ†å¸ƒå¼è®­ç»ƒä¸­è§’è‰²çš„åˆ’åˆ†ï¼ˆChiefç®¡ç†ï¼Œ PSå­˜å‚¨ï¼Œ Workerè®¡ç®—ï¼‰å’Œæœ€å°çš„å¹¶è¡Œè§„æ¨¡ï¼ˆ2 Workersï¼‰ã€‚</li><li><strong>â€œAll-or-Nothingâ€éœ€æ±‚</strong> æ˜¯åˆ†å¸ƒå¼è®­ç»ƒå†…åœ¨ç‰¹æ€§å¯¼è‡´çš„ï¼šéƒ¨åˆ†æˆåŠŸç­‰äºæ•´ä½“å¤±è´¥ï¼Œè¿˜ä¼šå¯¼è‡´èµ„æºæ­»é”å’Œæµªè´¹ã€‚</li><li><strong>Volcanoçš„ä»·å€¼</strong> æ­£æ˜¯é€šè¿‡<code>PodGroup</code>å’Œ<code>minAvailable</code>ç­‰æœºåˆ¶ï¼Œå®ç°<strong>Gang Scheduling</strong>ï¼Œç¡®ä¿åˆ†å¸ƒå¼è®­ç»ƒä½œä¸šæ‰€éœ€çš„æ‰€æœ‰Podä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸè°ƒåº¦å¹¶å¯åŠ¨ï¼Œè¦ä¹ˆéƒ½ä¸å¯åŠ¨ã€‚è¿™å®Œç¾è§£å†³äº†åŸç”ŸKubernetesè°ƒåº¦å™¨åœ¨æ‰¹é‡è°ƒåº¦å’ŒåŸå­æ€§ä¿éšœä¸Šçš„ç¼ºé™·ï¼Œä¸ºAI&#x2F;å¤§æ•°æ®ç­‰åˆ†å¸ƒå¼å·¥ä½œè´Ÿè½½æä¾›äº†å¯é é«˜æ•ˆçš„è°ƒåº¦åŸºç¡€ã€‚</li></ul><p><strong>ç†è§£äº†è¿™ä¸ªåŸç†ï¼Œä½ å†å›å¤´çœ‹Volcanoçš„è°ƒåº¦ç­–ç•¥ï¼ˆå¦‚é¢„ç•™èµ„æºã€ä¸€æ¬¡æ€§ç»‘å®šã€ä¼˜å…ˆçº§&#x2F;æŠ¢å ä¸ºå®Œæ•´ä½œä¸šæœåŠ¡ç­‰ï¼‰ï¼Œå°±ä¼šè±ç„¶å¼€æœ—ï¼šå®ƒçš„æ¯ä¸€ä¸ªæ ¸å¿ƒè®¾è®¡å‡ ä¹éƒ½æ˜¯ä¸ºäº†è§£å†³åˆ†å¸ƒå¼è®­ç»ƒï¼ˆä»¥åŠç±»ä¼¼æ‰¹å¤„ç†ä½œä¸šï¼‰çš„è¿™äº›ç‹¬ç‰¹æŒ‘æˆ˜è€Œç”Ÿçš„ã€‚</strong></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ä¸ºä»€ä¹ˆéœ€è¦æ‰¹é‡è°ƒåº¦</title>
    <link href="/2025/07/25/%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E6%89%B9%E9%87%8F%E8%B0%83%E5%BA%A6/"/>
    <url>/2025/07/25/%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E6%89%B9%E9%87%8F%E8%B0%83%E5%BA%A6/</url>
    
    <content type="html"><![CDATA[<h3 id="ä¸ºä»€ä¹ˆéœ€è¦æ‰¹é‡è°ƒåº¦ï¼Ÿä»¥-MNIST-æ‰‹å†™ä½“æ•°å­—è¯†åˆ«é¡¹ç›®ä¸ºä¾‹"><a href="#ä¸ºä»€ä¹ˆéœ€è¦æ‰¹é‡è°ƒåº¦ï¼Ÿä»¥-MNIST-æ‰‹å†™ä½“æ•°å­—è¯†åˆ«é¡¹ç›®ä¸ºä¾‹" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦æ‰¹é‡è°ƒåº¦ï¼Ÿä»¥ MNIST æ‰‹å†™ä½“æ•°å­—è¯†åˆ«é¡¹ç›®ä¸ºä¾‹"></a>ä¸ºä»€ä¹ˆéœ€è¦æ‰¹é‡è°ƒåº¦ï¼Ÿä»¥ MNIST æ‰‹å†™ä½“æ•°å­—è¯†åˆ«é¡¹ç›®ä¸ºä¾‹</h3><p>è®©æˆ‘ä»¬ä»¥ç»å…¸çš„ <strong>MNIST æ‰‹å†™ä½“æ•°å­—è¯†åˆ«é¡¹ç›®</strong>ï¼ˆä½¿ç”¨ TensorFlow åˆ†å¸ƒå¼è®­ç»ƒï¼‰ä¸ºä¾‹ï¼Œè¯´æ˜ä¸ºä»€ä¹ˆéœ€è¦ä¸“é—¨çš„æ‰¹é‡è°ƒåº¦å™¨ã€‚è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„æœºå™¨å­¦ä¹ è®­ç»ƒåœºæ™¯ï¼Œèƒ½æ¸…æ™°å±•ç¤ºåŸç”Ÿ Kubernetes è°ƒåº¦å™¨çš„å±€é™ã€‚</p><hr><h3 id="åœºæ™¯æè¿°ï¼šåˆ†å¸ƒå¼-TensorFlow-MNIST-è®­ç»ƒ"><a href="#åœºæ™¯æè¿°ï¼šåˆ†å¸ƒå¼-TensorFlow-MNIST-è®­ç»ƒ" class="headerlink" title="åœºæ™¯æè¿°ï¼šåˆ†å¸ƒå¼ TensorFlow MNIST è®­ç»ƒ"></a>åœºæ™¯æè¿°ï¼šåˆ†å¸ƒå¼ TensorFlow MNIST è®­ç»ƒ</h3><p>å‡è®¾æˆ‘ä»¬éœ€è¦è®­ç»ƒä¸€ä¸ªè¯†åˆ«æ‰‹å†™æ•°å­—çš„æ¨¡å‹ï¼š</p><ul><li><strong>ä»»åŠ¡ç»„æˆ</strong>ï¼š<ul><li>1ä¸ª <strong>Chief èŠ‚ç‚¹</strong>ï¼ˆè´Ÿè´£åè°ƒè®­ç»ƒï¼‰</li><li>1ä¸ª <strong>Parameter Server</strong>ï¼ˆå­˜å‚¨æ¨¡å‹å‚æ•°ï¼‰</li><li>2ä¸ª <strong>Worker èŠ‚ç‚¹</strong>ï¼ˆæ‰§è¡Œè®¡ç®—ä»»åŠ¡ï¼‰</li></ul></li><li><strong>èµ„æºéœ€æ±‚</strong>ï¼šæ¯ä¸ª Pod éœ€è¦ 1 å— GPU</li><li><strong>å…³é”®è¦æ±‚</strong>ï¼š<strong>æ‰€æœ‰ 4 ä¸ª Pod å¿…é¡»åŒæ—¶å¯åŠ¨</strong>ï¼Œä»»ä½•ä¸€ä¸ªå¤±è´¥éƒ½ä¼šå¯¼è‡´æ•´ä¸ªè®­ç»ƒå¤±è´¥</li></ul><pre><code class=" mermaid">graph LR    Chief[ChiefèŠ‚ç‚¹] --&gt;|åè°ƒ| PS[Parameter Server]    PS --&gt;|å‚æ•°åŒæ­¥| Worker1[Worker 1]    PS --&gt;|å‚æ•°åŒæ­¥| Worker2[Worker 2]</code></pre><hr><h3 id="åŸç”Ÿ-Kubernetes-è°ƒåº¦å™¨çš„é—®é¢˜"><a href="#åŸç”Ÿ-Kubernetes-è°ƒåº¦å™¨çš„é—®é¢˜" class="headerlink" title="åŸç”Ÿ Kubernetes è°ƒåº¦å™¨çš„é—®é¢˜"></a>åŸç”Ÿ Kubernetes è°ƒåº¦å™¨çš„é—®é¢˜</h3><h4 id="åœºæ™¯-1ï¼šèµ„æºä¸è¶³æ—¶çš„éƒ¨åˆ†å¯åŠ¨ï¼ˆæœ€å±é™©çš„æƒ…å†µï¼‰"><a href="#åœºæ™¯-1ï¼šèµ„æºä¸è¶³æ—¶çš„éƒ¨åˆ†å¯åŠ¨ï¼ˆæœ€å±é™©çš„æƒ…å†µï¼‰" class="headerlink" title="åœºæ™¯ 1ï¼šèµ„æºä¸è¶³æ—¶çš„éƒ¨åˆ†å¯åŠ¨ï¼ˆæœ€å±é™©çš„æƒ…å†µï¼‰"></a>åœºæ™¯ 1ï¼šèµ„æºä¸è¶³æ—¶çš„éƒ¨åˆ†å¯åŠ¨ï¼ˆæœ€å±é™©çš„æƒ…å†µï¼‰</h4><p>å‡è®¾é›†ç¾¤æœ‰ 3 ä¸ª GPU èŠ‚ç‚¹ï¼Œä½†æ¯ä¸ªèŠ‚ç‚¹<strong>åªå‰© 1 å—ç©ºé—² GPU</strong>ï¼š</p><ol><li>æäº¤åŒ…å« 4 ä¸ª Pod çš„ Job</li><li>åŸç”Ÿè°ƒåº¦å™¨è¡Œä¸ºï¼š<ul><li>Pod1 (Chief) â†’ è°ƒåº¦åˆ° Node1 âœ…</li><li>Pod2 (PS) â†’ è°ƒåº¦åˆ° Node2 âœ…</li><li>Pod3 (Worker1) â†’ è°ƒåº¦åˆ° Node3 âœ…</li><li>Pod4 (Worker2) â†’ <strong>æ— å¯ç”¨èµ„æºï¼Œå¡åœ¨ Pending</strong> âŒ</li></ul></li></ol><p><strong>ç¾éš¾æ€§åæœ</strong>ï¼š</p><ul><li>å·²å¯åŠ¨çš„ 3 ä¸ª Pod ä¼šä¸æ–­å°è¯•è¿æ¥ç¼ºå¤±çš„ Worker2</li><li>5-10 åˆ†é’Ÿåè¶…æ—¶å¤±è´¥ï¼ˆTensorFlow çš„ gRPC è¿æ¥è¶…æ—¶ï¼‰</li><li><strong>æµªè´¹äº† 3 å— GPU çš„è®¡ç®—èµ„æº</strong>ï¼ˆæŒ‰ $0.5&#x2F;GPUå°æ—¶ è®¡ï¼ŒæŸå¤±çº¦ $0.025ï¼‰</li></ul><blockquote><p>ğŸ’¡ <strong>è¿™å°±æ˜¯ Gang Scheduling è¦è§£å†³çš„ â€œAll-or-Nothingâ€ é—®é¢˜</strong></p></blockquote><h4 id="åœºæ™¯-2ï¼šèµ„æºç¢ç‰‡å¯¼è‡´çš„æ­»é”"><a href="#åœºæ™¯-2ï¼šèµ„æºç¢ç‰‡å¯¼è‡´çš„æ­»é”" class="headerlink" title="åœºæ™¯ 2ï¼šèµ„æºç¢ç‰‡å¯¼è‡´çš„æ­»é”"></a>åœºæ™¯ 2ï¼šèµ„æºç¢ç‰‡å¯¼è‡´çš„æ­»é”</h4><p>å‡è®¾é›†ç¾¤æœ‰ 4 ä¸ªèŠ‚ç‚¹ï¼š</p><ul><li>Node1ï¼šå‰© 2 å— GPU</li><li>Node2ï¼šå‰© 1 å— GPU</li><li>Node3ï¼šå‰© 1 å— GPU</li><li>Node4ï¼šå‰© 0 å— GPU</li></ul><p>åŒæ—¶æäº¤ä¸¤ä¸ª MNIST ä½œä¸šï¼š</p><ul><li><strong>JobA</strong>ï¼šéœ€è¦ 2 ä¸ª Workerï¼ˆå…±éœ€ 3 GPUï¼šChief+PS+2Workerï¼‰</li><li><strong>JobB</strong>ï¼šåŒæ ·éœ€è¦ 3 GPU</li></ul><p>åŸç”Ÿè°ƒåº¦å™¨å¯èƒ½çš„è°ƒåº¦é¡ºåºï¼š</p><ol><li>JobA-Chief â†’ Node1ï¼ˆå ç”¨ 1 GPUï¼‰</li><li>JobB-Chief â†’ Node2ï¼ˆå ç”¨ 1 GPUï¼‰</li><li>JobA-PS â†’ Node3ï¼ˆå ç”¨ 1 GPUï¼‰</li><li>JobB-PS â†’ <strong>æ— èŠ‚ç‚¹æ»¡è¶³ï¼ˆéœ€ 1 GPUï¼Œä½† Node1 åªå‰© 1 GPU ä¸æ»¡è¶³ PS+Worker çš„åŒèŠ‚ç‚¹è¦æ±‚ï¼‰</strong> âŒ</li><li>JobA-Worker1 â†’ Node1ï¼ˆå ç”¨æœ€å 1 GPUï¼‰</li><li>JobA-Worker2 â†’ <strong>æ— èµ„æº</strong> âŒ</li></ol><p><strong>ç»“æœ</strong>ï¼š</p><ul><li>JobAï¼šç¼ºå°‘ 1 Worker</li><li>JobBï¼šç¼ºå°‘ PS å’Œ Worker</li><li><strong>ä¸¤ä¸ªä½œä¸šéƒ½éƒ¨åˆ†è¿è¡Œä½†æ— æ³•å®Œæˆ â†’ èµ„æºæ­»é”</strong></li></ul><hr><h3 id="Volcano-å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜"><a href="#Volcano-å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜" class="headerlink" title="Volcano å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜"></a>Volcano å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜</h3><h4 id="è§£å†³æ–¹æ¡ˆ-1ï¼šGang-Schedulingï¼ˆåŸå­æ€§è°ƒåº¦ï¼‰"><a href="#è§£å†³æ–¹æ¡ˆ-1ï¼šGang-Schedulingï¼ˆåŸå­æ€§è°ƒåº¦ï¼‰" class="headerlink" title="è§£å†³æ–¹æ¡ˆ 1ï¼šGang Schedulingï¼ˆåŸå­æ€§è°ƒåº¦ï¼‰"></a>è§£å†³æ–¹æ¡ˆ 1ï¼šGang Schedulingï¼ˆåŸå­æ€§è°ƒåº¦ï¼‰</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># Volcano çš„ Job å®šä¹‰</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">batch.volcano.sh/v1alpha1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Job</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">minAvailable:</span> <span class="hljs-number">4</span>  <span class="hljs-comment"># å…³é”®å‚æ•°ï¼</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">chief</span>  <span class="hljs-comment"># Chief èŠ‚ç‚¹</span><br>      <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>      <span class="hljs-attr">template:</span> &#123; <span class="hljs-string">...</span> &#125;<br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">ps</span>     <span class="hljs-comment"># Parameter Server</span><br>      <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>      <span class="hljs-attr">template:</span> &#123; <span class="hljs-string">...</span> &#125;<br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">worker</span> <span class="hljs-comment"># Workers</span><br>      <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span><br>      <span class="hljs-attr">template:</span> &#123; <span class="hljs-string">...</span> &#125;<br></code></pre></td></tr></table></figure><p><strong>è°ƒåº¦è¿‡ç¨‹</strong>ï¼š</p><ol><li>è°ƒåº¦å™¨æ£€æŸ¥é›†ç¾¤æ˜¯å¦æœ‰ <strong>4 å—å¯ç”¨ GPU</strong></li><li>å¦‚æœä¸è¶³ â†’ <strong>æ•´ä¸ªä½œä¸šä¸å¯åŠ¨</strong>ï¼ˆé¿å…éƒ¨åˆ†å¯åŠ¨ï¼‰</li><li>å¦‚æœå……è¶³ â†’ <strong>ä¸€æ¬¡æ€§ç»‘å®šæ‰€æœ‰ 4 ä¸ª Pod</strong></li></ol><h4 id="è§£å†³æ–¹æ¡ˆ-2ï¼šèµ„æºé¢„ç•™-æ™ºèƒ½åˆ†é…"><a href="#è§£å†³æ–¹æ¡ˆ-2ï¼šèµ„æºé¢„ç•™-æ™ºèƒ½åˆ†é…" class="headerlink" title="è§£å†³æ–¹æ¡ˆ 2ï¼šèµ„æºé¢„ç•™ + æ™ºèƒ½åˆ†é…"></a>è§£å†³æ–¹æ¡ˆ 2ï¼šèµ„æºé¢„ç•™ + æ™ºèƒ½åˆ†é…</h4><p>å½“å¤šä¸ªä½œä¸šç«äº‰æ—¶ï¼š</p><ol><li>Volcano æ£€æµ‹åˆ° JobA å’Œ JobB éƒ½éœ€è¦ 3 GPU</li><li><strong>æ ¹æ®é˜Ÿåˆ—ä¼˜å…ˆçº§</strong>ï¼ˆå¦‚ JobA ä¼˜å…ˆçº§æ›´é«˜ï¼‰ï¼š<ul><li>ä¸º JobA <strong>é¢„ç•™</strong> Node1(2GPU) + Node3(1GPU)</li><li>ä¸€æ¬¡æ€§å¯åŠ¨ JobA æ‰€æœ‰ Pod</li></ul></li><li>JobB ç­‰å¾…èµ„æºé‡Šæ”¾</li><li>é¿å…èµ„æºç¢ç‰‡æ­»é”</li></ol><hr><h3 id="æ‰¹é‡è°ƒåº¦çš„æ ¸å¿ƒä»·å€¼"><a href="#æ‰¹é‡è°ƒåº¦çš„æ ¸å¿ƒä»·å€¼" class="headerlink" title="æ‰¹é‡è°ƒåº¦çš„æ ¸å¿ƒä»·å€¼"></a>æ‰¹é‡è°ƒåº¦çš„æ ¸å¿ƒä»·å€¼</h3><ol><li><p><strong>é¿å…èµ„æºæµªè´¹</strong>  </p><ul><li>éƒ¨åˆ†å¯åŠ¨çš„ GPU ä½œä¸šæ¶ˆè€—ç”µåŠ›ä½†ä¸äº§ç”Ÿä»·å€¼</li><li>æŒ‰äº‘å‚å•†è®¡è´¹æ ‡å‡†ï¼š1 å— V100 GPU â‰ˆ $0.5&#x2F;å°æ—¶<br>â†’ éƒ¨åˆ†å¯åŠ¨ 1 å°æ—¶ &#x3D; æµªè´¹ $1.5</li></ul></li><li><p><strong>é˜²æ­¢åˆ†å¸ƒå¼ç³»ç»Ÿæ­»é”</strong>  </p><ul><li>TensorFlow&#x2F;PyTorch&#x2F;Spark ç­‰æ¡†æ¶è¦æ±‚æ‰€æœ‰èŠ‚ç‚¹åŒæ—¶å°±ç»ª</li><li>ç¼ºå¤±èŠ‚ç‚¹ä¼šå¯¼è‡´æ•´ä¸ªä½œä¸šé˜»å¡ï¼ˆè€Œéé™çº§è¿è¡Œï¼‰</li></ul></li><li><p><strong>æé«˜é›†ç¾¤åˆ©ç”¨ç‡</strong>  </p><ul><li>é€šè¿‡ Binpack ç®—æ³•å°† Pod ç´§å¯†åˆ†é…åˆ°å°‘æ•°èŠ‚ç‚¹</li><li>å‡å°‘èµ„æºç¢ç‰‡ï¼ˆå¦‚æ¡ˆä¾‹ä¸­çš„ â€œ1 GPU ç¢ç‰‡â€ï¼‰</li></ul></li><li><p><strong>æ”¯æŒå¤æ‚ä¾èµ–å…³ç³»</strong>  </p><pre><code class=" mermaid">graph TD  A[æ•°æ®é¢„å¤„ç†] --&gt; B[æ¨¡å‹è®­ç»ƒ]  B --&gt; C[æ¨¡å‹éªŒè¯]  C --&gt; D[æ¨¡å‹å¯¼å‡º]</code></pre><ul><li>Volcano æ”¯æŒ DAG å·¥ä½œæµè°ƒåº¦ï¼Œç¡®ä¿ä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œ</li></ul></li></ol><hr><h3 id="MNIST-åœºæ™¯ä¸­çš„è¿›é˜¶éœ€æ±‚"><a href="#MNIST-åœºæ™¯ä¸­çš„è¿›é˜¶éœ€æ±‚" class="headerlink" title="MNIST åœºæ™¯ä¸­çš„è¿›é˜¶éœ€æ±‚"></a>MNIST åœºæ™¯ä¸­çš„è¿›é˜¶éœ€æ±‚</h3><ol><li><p><strong>GPU æ‹“æ‰‘æ„ŸçŸ¥è°ƒåº¦</strong>  </p><ul><li>å½“ Worker éœ€è¦å¤š GPU æ—¶ï¼šç¡®ä¿ GPU é€šè¿‡ NVLink äº’è”</li><li>Volcano æ”¯æŒæ ¹æ®èŠ‚ç‚¹æ ‡ç­¾è°ƒåº¦ï¼š<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">topologyPolicy:</span> <span class="hljs-string">BestEffort</span><br><span class="hljs-attr">policies:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">device:</span> <span class="hljs-string">GPU</span><br>    <span class="hljs-attr">gpuPolicy:</span> <span class="hljs-string">dgx-2</span>  <span class="hljs-comment"># è¯†åˆ«DGXæœåŠ¡å™¨çš„NVLinkæ‹“æ‰‘</span><br></code></pre></td></tr></table></figure></li></ul></li><li><p><strong>å¼¹æ€§èµ„æºåˆ†é…</strong>  </p><ul><li>è®­ç»ƒä¸­é€”åŠ¨æ€æ‰©å±• Worker æ•°é‡</li><li>Volcano æ”¯æŒä½œä¸šè¿è¡Œæ—¶è°ƒæ•´ <code>replicas</code></li></ul></li><li><p><strong>é˜Ÿåˆ—ä¼˜å…ˆçº§</strong>  </p><ul><li>ç”Ÿäº§ç¯å¢ƒè®­ç»ƒä»»åŠ¡ä¼˜å…ˆäºç ”å‘æµ‹è¯•ä»»åŠ¡</li><li>Volcano çš„å¤šçº§é˜Ÿåˆ—ç¡®ä¿é«˜ä¼˜å…ˆçº§ä½œä¸šä¼˜å…ˆè·å–èµ„æº</li></ul></li></ol><hr><h3 id="å…³é”®ç»“è®ºï¼šä¸ºä»€ä¹ˆæ‰¹é‡è°ƒåº¦ä¸å¯æˆ–ç¼º"><a href="#å…³é”®ç»“è®ºï¼šä¸ºä»€ä¹ˆæ‰¹é‡è°ƒåº¦ä¸å¯æˆ–ç¼º" class="headerlink" title="å…³é”®ç»“è®ºï¼šä¸ºä»€ä¹ˆæ‰¹é‡è°ƒåº¦ä¸å¯æˆ–ç¼º"></a>å…³é”®ç»“è®ºï¼šä¸ºä»€ä¹ˆæ‰¹é‡è°ƒåº¦ä¸å¯æˆ–ç¼º</h3><blockquote><p><strong>â€œåœ¨åˆ†å¸ƒå¼è®­ç»ƒä¸­ï¼Œéƒ¨åˆ†æˆåŠŸå°±æ˜¯æ•´ä½“å¤±è´¥â€</strong></p></blockquote><p>MNIST ç¤ºä¾‹æ­ç¤ºäº†ï¼š</p><ul><li>æœºå™¨å­¦ä¹ è®­ç»ƒæ˜¯ <strong>ååŒä½œæˆ˜</strong>ï¼Œä¸æ˜¯å•å…µä½œæˆ˜</li><li>åŸç”Ÿè°ƒåº¦å™¨çš„ <strong>â€œè¿‘è§†çœ¼â€å†³ç­–</strong>ï¼ˆåªçœ‹å•ä¸ª Podï¼‰ä¸é€‚åˆæ‰¹å¤„ç†åœºæ™¯</li><li>Volcano çš„ <strong>ä¼šè¯å¼è°ƒåº¦</strong>ï¼ˆå…¨å±€è§†å›¾ï¼‰æ˜¯è§£å†³è¿™ä¸€é—®é¢˜çš„æœ¬è´¨åˆ›æ–°</li></ul><p><strong>å­¦ä¹ å»ºè®®</strong>ï¼šç†è§£ Volcano æ—¶ï¼Œå§‹ç»ˆé—®è‡ªå·±ï¼šâ€è¿™ä¸ªç‰¹æ€§å¦‚ä½•é˜²æ­¢ MNIST è®­ç»ƒä¸­çš„éƒ¨åˆ†å¯åŠ¨é—®é¢˜ï¼Ÿâ€ è¿™å°†å¸®åŠ©ä½ æŠ“ä½è®¾è®¡ç²¾é«“ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>åœ¨goä¸­æ¯”è¾ƒä¸¤ä¸ªstruct</title>
    <link href="/2025/07/25/%E5%9C%A8go%E4%B8%AD%E6%AF%94%E8%BE%83%E4%B8%A4%E4%B8%AAstruct/"/>
    <url>/2025/07/25/%E5%9C%A8go%E4%B8%AD%E6%AF%94%E8%BE%83%E4%B8%A4%E4%B8%AAstruct/</url>
    
    <content type="html"><![CDATA[<h1 id="åœ¨Goä¸­æ¯”è¾ƒä¸¤ä¸ªStruct"><a href="#åœ¨Goä¸­æ¯”è¾ƒä¸¤ä¸ªStruct" class="headerlink" title="åœ¨Goä¸­æ¯”è¾ƒä¸¤ä¸ªStruct"></a>åœ¨Goä¸­æ¯”è¾ƒä¸¤ä¸ªStruct</h1><p>åœ¨Goè¯­è¨€ä¸­ï¼Œä¸¤ä¸ªstructæ˜¯å¦å¯ä»¥ç”¨<code>==</code>æ“ä½œç¬¦è¿›è¡Œæ¯”è¾ƒå–å†³äºstructçš„ç»„æˆã€‚</p><h2 id="å¯æ¯”è¾ƒçš„æƒ…å†µ"><a href="#å¯æ¯”è¾ƒçš„æƒ…å†µ" class="headerlink" title="å¯æ¯”è¾ƒçš„æƒ…å†µ"></a>å¯æ¯”è¾ƒçš„æƒ…å†µ</h2><p>å½“structæ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶ï¼Œå¯ä»¥ç›´æ¥ç”¨<code>==</code>æ¯”è¾ƒï¼š</p><ol><li><p><strong>æ‰€æœ‰å­—æ®µéƒ½æ˜¯å¯æ¯”è¾ƒçš„ç±»å‹</strong>ï¼š</p><ul><li>åŸºæœ¬ç±»å‹ï¼ˆint, float, stringç­‰ï¼‰</li><li>æŒ‡é’ˆ</li><li>æ•°ç»„ï¼ˆå…ƒç´ ç±»å‹å¯æ¯”è¾ƒï¼‰</li><li>å…¶ä»–å¯æ¯”è¾ƒçš„struct</li><li>channel</li></ul></li><li><p><strong>ä¸åŒ…å«ä¸å¯æ¯”è¾ƒçš„å­—æ®µ</strong>ï¼š</p><ul><li>slice</li><li>map</li><li>function</li></ul></li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>    Name <span class="hljs-type">string</span><br>    Age  <span class="hljs-type">int</span><br>&#125;<br><br>p1 := Person&#123;<span class="hljs-string">&quot;Alice&quot;</span>, <span class="hljs-number">30</span>&#125;<br>p2 := Person&#123;<span class="hljs-string">&quot;Alice&quot;</span>, <span class="hljs-number">30</span>&#125;<br>fmt.Println(p1 == p2) <span class="hljs-comment">// true</span><br></code></pre></td></tr></table></figure><h2 id="ä¸å¯æ¯”è¾ƒçš„æƒ…å†µ"><a href="#ä¸å¯æ¯”è¾ƒçš„æƒ…å†µ" class="headerlink" title="ä¸å¯æ¯”è¾ƒçš„æƒ…å†µ"></a>ä¸å¯æ¯”è¾ƒçš„æƒ…å†µ</h2><p>å¦‚æœstructåŒ…å«ä¸å¯æ¯”è¾ƒçš„å­—æ®µï¼ˆå¦‚sliceã€mapæˆ–functionï¼‰ï¼Œåˆ™ä¸èƒ½ç”¨<code>==</code>æ¯”è¾ƒï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Data <span class="hljs-keyword">struct</span> &#123;<br>    Values []<span class="hljs-type">int</span><br>&#125;<br><br>d1 := Data&#123;[]<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;&#125;<br>d2 := Data&#123;[]<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;&#125;<br><span class="hljs-comment">// fmt.Println(d1 == d2) // ç¼–è¯‘é”™è¯¯ï¼šinvalid operation</span><br></code></pre></td></tr></table></figure><h2 id="æ›¿ä»£æ–¹æ¡ˆ"><a href="#æ›¿ä»£æ–¹æ¡ˆ" class="headerlink" title="æ›¿ä»£æ–¹æ¡ˆ"></a>æ›¿ä»£æ–¹æ¡ˆ</h2><p>å¯¹äºä¸å¯æ¯”è¾ƒçš„structï¼Œå¯ä»¥ä½¿ç”¨ï¼š</p><ol><li><p><code>reflect.DeepEqual()</code>å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">fmt.Println(reflect.DeepEqual(d1, d2)) <span class="hljs-comment">// true</span><br></code></pre></td></tr></table></figure></li><li><p>è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(d Data)</span></span> Equal(other Data) <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(d.Values) != <span class="hljs-built_in">len</span>(other.Values) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>    &#125;<br>    <span class="hljs-keyword">for</span> i, v := <span class="hljs-keyword">range</span> d.Values &#123;<br>        <span class="hljs-keyword">if</span> v != other.Values[i] &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h2 id="æŒ‡é’ˆæ¯”è¾ƒ"><a href="#æŒ‡é’ˆæ¯”è¾ƒ" class="headerlink" title="æŒ‡é’ˆæ¯”è¾ƒ"></a>æŒ‡é’ˆæ¯”è¾ƒ</h2><p>æ¯”è¾ƒstructæŒ‡é’ˆæ—¶ï¼Œæ¯”è¾ƒçš„æ˜¯æŒ‡é’ˆå€¼ï¼ˆå†…å­˜åœ°å€ï¼‰è€Œä¸æ˜¯å†…å®¹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">p3 := &amp;Person&#123;<span class="hljs-string">&quot;Bob&quot;</span>, <span class="hljs-number">25</span>&#125;<br>p4 := &amp;Person&#123;<span class="hljs-string">&quot;Bob&quot;</span>, <span class="hljs-number">25</span>&#125;<br>fmt.Println(p3 == p4) <span class="hljs-comment">// falseï¼Œå› ä¸ºæŒ‡å‘ä¸åŒå†…å­˜åœ°å€</span><br></code></pre></td></tr></table></figure><p>æ€»ç»“ï¼šåªæœ‰å½“structçš„æ‰€æœ‰å­—æ®µéƒ½æ˜¯å¯æ¯”è¾ƒç±»å‹æ—¶ï¼Œæ‰èƒ½ç›´æ¥ç”¨<code>==</code>æ¯”è¾ƒä¸¤ä¸ªstructã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>k8sç½‘ç»œéš”ç¦»ç­–ç•¥</title>
    <link href="/2025/07/25/k8s%E7%BD%91%E7%BB%9C%E9%9A%94%E7%A6%BB%E7%AD%96%E7%95%A5/"/>
    <url>/2025/07/25/k8s%E7%BD%91%E7%BB%9C%E9%9A%94%E7%A6%BB%E7%AD%96%E7%95%A5/</url>
    
    <content type="html"><![CDATA[<h1 id="k8sç½‘ç»œéš”ç¦»ç­–ç•¥"><a href="#k8sç½‘ç»œéš”ç¦»ç­–ç•¥" class="headerlink" title="k8sç½‘ç»œéš”ç¦»ç­–ç•¥"></a>k8sç½‘ç»œéš”ç¦»ç­–ç•¥</h1><p>åœ¨ Kubernetes ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ<strong>æ‰€æœ‰å‘½åç©ºé—´ï¼ˆNamespaceï¼‰ä¸­çš„ Pod å¯ä»¥é€šè¿‡ç½‘ç»œç›´æ¥äº’é€š</strong>ï¼Œé™¤éé…ç½®äº† <strong>NetworkPolicy</strong> æ˜¾å¼é™åˆ¶æµé‡ã€‚å¦‚æœæ‚¨çš„é›†ç¾¤å·²ç»å¯ç”¨äº†ç½‘ç»œæ’ä»¶ï¼ˆå¦‚ Calicoã€Cilium ç­‰ï¼‰ï¼Œå¹¶ä¸”éœ€è¦ <strong>æ˜ç¡®å…è®¸ <code>ns-a</code> å’Œ <code>ns-b</code> äº’é€š</strong>ï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š</p><hr><h3 id="æ–¹æ³•-1ï¼šå…è®¸ç‰¹å®šå‘½åç©ºé—´ä¹‹é—´çš„æµé‡"><a href="#æ–¹æ³•-1ï¼šå…è®¸ç‰¹å®šå‘½åç©ºé—´ä¹‹é—´çš„æµé‡" class="headerlink" title="æ–¹æ³• 1ï¼šå…è®¸ç‰¹å®šå‘½åç©ºé—´ä¹‹é—´çš„æµé‡"></a><strong>æ–¹æ³• 1ï¼šå…è®¸ç‰¹å®šå‘½åç©ºé—´ä¹‹é—´çš„æµé‡</strong></h3><h4 id="1-åˆ›å»º-NetworkPolicyï¼ˆå…è®¸-ns-a-è®¿é—®-ns-bï¼‰"><a href="#1-åˆ›å»º-NetworkPolicyï¼ˆå…è®¸-ns-a-è®¿é—®-ns-bï¼‰" class="headerlink" title="1. åˆ›å»º NetworkPolicyï¼ˆå…è®¸ ns-a è®¿é—® ns-bï¼‰"></a><strong>1. åˆ›å»º NetworkPolicyï¼ˆå…è®¸ <code>ns-a</code> è®¿é—® <code>ns-b</code>ï¼‰</strong></h4><p>ä»¥ä¸‹ç­–ç•¥å…è®¸ <code>ns-a</code> ä¸­çš„ Pod è®¿é—® <code>ns-b</code> ä¸­çš„ Podï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># allow-ns-a-to-ns-b.yaml</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">NetworkPolicy</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">allow-ns-a-to-ns-b</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">ns-b</span>  <span class="hljs-comment"># ä½œç”¨åœ¨ ns-b ä¸Šï¼Œæ§åˆ¶å…¥ç«™æµé‡</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">podSelector:</span> &#123;&#125;  <span class="hljs-comment"># åŒ¹é… ns-b ä¸­çš„æ‰€æœ‰ Pod</span><br>  <span class="hljs-attr">policyTypes:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">Ingress</span><br>  <span class="hljs-attr">ingress:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">from:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">namespaceSelector:</span><br>        <span class="hljs-attr">matchLabels:</span><br>          <span class="hljs-attr">kubernetes.io/metadata.name:</span> <span class="hljs-string">ns-a</span>  <span class="hljs-comment"># å…è®¸æ¥è‡ª ns-a çš„æµé‡</span><br></code></pre></td></tr></table></figure><h4 id="2-åˆ›å»ºåå‘ç­–ç•¥ï¼ˆå…è®¸-ns-b-è®¿é—®-ns-aï¼‰"><a href="#2-åˆ›å»ºåå‘ç­–ç•¥ï¼ˆå…è®¸-ns-b-è®¿é—®-ns-aï¼‰" class="headerlink" title="2. åˆ›å»ºåå‘ç­–ç•¥ï¼ˆå…è®¸ ns-b è®¿é—® ns-aï¼‰"></a><strong>2. åˆ›å»ºåå‘ç­–ç•¥ï¼ˆå…è®¸ <code>ns-b</code> è®¿é—® <code>ns-a</code>ï¼‰</strong></h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># allow-ns-b-to-ns-a.yaml</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">NetworkPolicy</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">allow-ns-b-to-ns-a</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">ns-a</span>  <span class="hljs-comment"># ä½œç”¨åœ¨ ns-a ä¸Š</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">podSelector:</span> &#123;&#125;  <span class="hljs-comment"># åŒ¹é… ns-a ä¸­çš„æ‰€æœ‰ Pod</span><br>  <span class="hljs-attr">policyTypes:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">Ingress</span><br>  <span class="hljs-attr">ingress:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">from:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">namespaceSelector:</span><br>        <span class="hljs-attr">matchLabels:</span><br>          <span class="hljs-attr">kubernetes.io/metadata.name:</span> <span class="hljs-string">ns-b</span>  <span class="hljs-comment"># å…è®¸æ¥è‡ª ns-b çš„æµé‡</span><br></code></pre></td></tr></table></figure><h4 id="3-åº”ç”¨ç­–ç•¥"><a href="#3-åº”ç”¨ç­–ç•¥" class="headerlink" title="3. åº”ç”¨ç­–ç•¥"></a><strong>3. åº”ç”¨ç­–ç•¥</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl apply -f allow-ns-a-to-ns-b.yaml<br>kubectl apply -f allow-ns-b-to-ns-a.yaml<br></code></pre></td></tr></table></figure><hr><h3 id="æ–¹æ³•-2ï¼šæ›´ç²¾ç»†çš„-Pod-é€‰æ‹©å™¨"><a href="#æ–¹æ³•-2ï¼šæ›´ç²¾ç»†çš„-Pod-é€‰æ‹©å™¨" class="headerlink" title="æ–¹æ³• 2ï¼šæ›´ç²¾ç»†çš„ Pod é€‰æ‹©å™¨"></a><strong>æ–¹æ³• 2ï¼šæ›´ç²¾ç»†çš„ Pod é€‰æ‹©å™¨</strong></h3><p>å¦‚æœåªéœ€è¦å…è®¸ç‰¹å®š Pod äº’é€šï¼ˆè€Œéæ•´ä¸ªå‘½åç©ºé—´ï¼‰ï¼Œå¯ä»¥é€šè¿‡ <code>podSelector</code> è¿›ä¸€æ­¥é™åˆ¶ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">ingress:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">from:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">namespaceSelector:</span><br>      <span class="hljs-attr">matchLabels:</span><br>        <span class="hljs-attr">kubernetes.io/metadata.name:</span> <span class="hljs-string">ns-a</span><br>    <span class="hljs-attr">podSelector:</span><br>      <span class="hljs-attr">matchLabels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">backend</span>  <span class="hljs-comment"># ä»…å…è®¸ ns-a ä¸­å¸¦æœ‰ `app=backend` æ ‡ç­¾çš„ Pod</span><br></code></pre></td></tr></table></figure><hr><h3 id="éªŒè¯äº’é€šæ€§"><a href="#éªŒè¯äº’é€šæ€§" class="headerlink" title="éªŒè¯äº’é€šæ€§"></a><strong>éªŒè¯äº’é€šæ€§</strong></h3><ol><li>åœ¨ <code>ns-a</code> å’Œ <code>ns-b</code> ä¸­åˆ†åˆ«å¯åŠ¨ä¸€ä¸ªæµ‹è¯• Podï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl run test-pod -n ns-a --image=alpine -- <span class="hljs-built_in">sleep</span> 3600<br>kubectl run test-pod -n ns-b --image=alpine -- <span class="hljs-built_in">sleep</span> 3600<br></code></pre></td></tr></table></figure></li><li>æµ‹è¯•ç½‘ç»œè¿é€šæ€§ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl <span class="hljs-built_in">exec</span> -n ns-a test-pod -- ping &lt;ns-b-test-pod-IP&gt;<br>kubectl <span class="hljs-built_in">exec</span> -n ns-b test-pod -- ping &lt;ns-a-test-pod-IP&gt;<br></code></pre></td></tr></table></figure></li></ol><hr><h3 id="å…³é”®æ³¨æ„äº‹é¡¹"><a href="#å…³é”®æ³¨æ„äº‹é¡¹" class="headerlink" title="å…³é”®æ³¨æ„äº‹é¡¹"></a><strong>å…³é”®æ³¨æ„äº‹é¡¹</strong></h3><ol><li><strong>ç½‘ç»œæ’ä»¶æ”¯æŒ</strong>ï¼šç¡®ä¿é›†ç¾¤å·²å®‰è£…æ”¯æŒ <code>NetworkPolicy</code> çš„ CNI æ’ä»¶ï¼ˆå¦‚ Calicoã€Ciliumã€WeaveNetï¼‰ã€‚</li><li><strong>é»˜è®¤æ‹’ç»ç­–ç•¥</strong>ï¼šå¦‚æœé›†ç¾¤é…ç½®äº†é»˜è®¤æ‹’ç»æ‰€æœ‰æµé‡çš„ç­–ç•¥ï¼ˆå¦‚ <code>default-deny</code>ï¼‰ï¼Œåˆ™å¿…é¡»æ˜¾å¼å…è®¸ <code>ns-a</code> å’Œ <code>ns-b</code> çš„äº’é€šã€‚</li><li><strong>æ ‡ç­¾åŒ¹é…</strong>ï¼šKubernetes è‡ªåŠ¨ä¸ºå‘½åç©ºé—´æ·»åŠ  <code>kubernetes.io/metadata.name</code> æ ‡ç­¾ï¼Œå¯ç›´æ¥ç”¨äº <code>namespaceSelector</code>ã€‚</li></ol><hr><h3 id="è¡¥å……ï¼šå®Œå…¨éš”ç¦»å…¶ä»–å‘½åç©ºé—´"><a href="#è¡¥å……ï¼šå®Œå…¨éš”ç¦»å…¶ä»–å‘½åç©ºé—´" class="headerlink" title="è¡¥å……ï¼šå®Œå…¨éš”ç¦»å…¶ä»–å‘½åç©ºé—´"></a><strong>è¡¥å……ï¼šå®Œå…¨éš”ç¦»å…¶ä»–å‘½åç©ºé—´</strong></h3><p>å¦‚æœå¸Œæœ› <strong>ä»…å…è®¸ <code>ns-a</code> å’Œ <code>ns-b</code> äº’é€šï¼Œå¹¶æ‹’ç»å…¶ä»–å‘½åç©ºé—´</strong>ï¼Œå¯ä»¥åœ¨ä¸¤ä¸ªå‘½åç©ºé—´ä¸­æ·»åŠ ä»¥ä¸‹ç­–ç•¥ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># default-deny.yamlï¼ˆåˆ†åˆ«åœ¨ ns-a å’Œ ns-b ä¸­åˆ›å»ºï¼‰</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">NetworkPolicy</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">default-deny</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">ns-a</span>  <span class="hljs-comment"># æˆ– ns-b</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">podSelector:</span> &#123;&#125;<br>  <span class="hljs-attr">policyTypes:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">Ingress</span><br>  <span class="hljs-attr">ingress:</span> []  <span class="hljs-comment"># æ˜¾å¼æ‹’ç»æ‰€æœ‰å…¥ç«™æµé‡ï¼ˆåç»­å†é€šè¿‡å…è®¸ç­–ç•¥æ”¾è¡Œï¼‰</span><br></code></pre></td></tr></table></figure><p>ç„¶åé€šè¿‡å‰é¢çš„ç­–ç•¥å…è®¸ <code>ns-a</code> å’Œ <code>ns-b</code> ä¹‹é—´çš„æµé‡ã€‚</p><hr><p>é€šè¿‡ä»¥ä¸Šé…ç½®ï¼Œæ‚¨å¯ä»¥çµæ´»æ§åˆ¶å‘½åç©ºé—´ä¹‹é—´çš„ç½‘ç»œäº’é€šæ€§ã€‚æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©æ˜¯å¦ç»†åŒ–åˆ° Pod æ ‡ç­¾æˆ–ç«¯å£çº§åˆ«ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>list-watchåœ¨ç½‘ç»œä¸­æ–­åçš„æ¢å¤æœºåˆ¶</title>
    <link href="/2025/07/25/list-watch%E5%9C%A8%E7%BD%91%E7%BB%9C%E4%B8%AD%E6%96%AD%E5%90%8E%E7%9A%84%E6%81%A2%E5%A4%8D%E6%9C%BA%E5%88%B6/"/>
    <url>/2025/07/25/list-watch%E5%9C%A8%E7%BD%91%E7%BB%9C%E4%B8%AD%E6%96%AD%E5%90%8E%E7%9A%84%E6%81%A2%E5%A4%8D%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="list-watchåœ¨ç½‘ç»œä¸­æ–­åçš„æ¢å¤æœºåˆ¶"><a href="#list-watchåœ¨ç½‘ç»œä¸­æ–­åçš„æ¢å¤æœºåˆ¶" class="headerlink" title="list-watchåœ¨ç½‘ç»œä¸­æ–­åçš„æ¢å¤æœºåˆ¶"></a>list-watchåœ¨ç½‘ç»œä¸­æ–­åçš„æ¢å¤æœºåˆ¶</h1><p>åœ¨ Kubernetes ä¸­ï¼Œ<code>List-Watch</code> æœºåˆ¶æ˜¯å®¢æˆ·ç«¯ï¼ˆå¦‚ kube-apiserver çš„å®¢æˆ·ç«¯ï¼‰ç›‘å¬èµ„æºå˜åŒ–çš„æ ¸å¿ƒæœºåˆ¶ã€‚å½“ç½‘ç»œä¸­æ–­åé‡æ–°è¿æ¥æ—¶ï¼Œ<code>List-Watch</code> ä¼šé€šè¿‡ä»¥ä¸‹æ–¹å¼æ¢å¤çŠ¶æ€ï¼Œç¡®ä¿ä¸ä¸¢å¤±äº‹ä»¶å¹¶ä¿æŒæ•°æ®ä¸€è‡´æ€§ï¼š</p><hr><h3 id="1-åˆå§‹é˜¶æ®µï¼šå…¨é‡-List"><a href="#1-åˆå§‹é˜¶æ®µï¼šå…¨é‡-List" class="headerlink" title="1. åˆå§‹é˜¶æ®µï¼šå…¨é‡ List"></a>1. <strong>åˆå§‹é˜¶æ®µï¼šå…¨é‡ List</strong></h3><ul><li>å®¢æˆ·ç«¯é¦–æ¬¡å¯åŠ¨æˆ–éœ€è¦å…¨é‡åŒæ­¥æ—¶ï¼Œä¼šå…ˆè°ƒç”¨ <code>List</code> è·å–èµ„æºçš„å½“å‰å…¨é‡çŠ¶æ€ï¼ˆæ‰€æœ‰å¯¹è±¡çš„æœ€æ–°ç‰ˆæœ¬ï¼‰ï¼Œå¹¶ç¼“å­˜åœ¨æœ¬åœ°ã€‚</li><li>æ­¤æ—¶ä¼šè®°å½•èµ„æºçš„ <code>ResourceVersion</code>ï¼ˆä¸€ä¸ªå…¨å±€é€’å¢çš„ç‰ˆæœ¬å·ï¼Œè¡¨ç¤º etcd ä¸­èµ„æºçš„å½“å‰ç‰ˆæœ¬ï¼‰ã€‚</li></ul><hr><h3 id="2-ç›‘å¬é˜¶æ®µï¼šå¢é‡-Watch"><a href="#2-ç›‘å¬é˜¶æ®µï¼šå¢é‡-Watch" class="headerlink" title="2. ç›‘å¬é˜¶æ®µï¼šå¢é‡ Watch"></a>2. <strong>ç›‘å¬é˜¶æ®µï¼šå¢é‡ Watch</strong></h3><ul><li>å®¢æˆ·ç«¯åŸºäº <code>List</code> è¿”å›çš„ <code>ResourceVersion</code> å‘èµ· <code>Watch</code> è¯·æ±‚ï¼Œç›‘å¬è¯¥èµ„æºä»æ­¤ç‰ˆæœ¬ä¹‹åçš„æ‰€æœ‰å˜æ›´ï¼ˆ<code>ADDED</code>&#x2F;<code>MODIFIED</code>&#x2F;<code>DELETED</code> äº‹ä»¶ï¼‰ã€‚</li><li><code>Watch</code> æ˜¯ä¸€ä¸ªé•¿è¿æ¥ï¼Œapiserver ä¼šæŒç»­æ¨é€äº‹ä»¶ã€‚</li></ul><hr><h3 id="3-ç½‘ç»œä¸­æ–­åçš„æ¢å¤æœºåˆ¶"><a href="#3-ç½‘ç»œä¸­æ–­åçš„æ¢å¤æœºåˆ¶" class="headerlink" title="3. ç½‘ç»œä¸­æ–­åçš„æ¢å¤æœºåˆ¶"></a>3. <strong>ç½‘ç»œä¸­æ–­åçš„æ¢å¤æœºåˆ¶</strong></h3><p>å½“ç½‘ç»œä¸­æ–­å¯¼è‡´ <code>Watch</code> è¿æ¥æ–­å¼€æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šæŒ‰ä»¥ä¸‹æ­¥éª¤æ¢å¤ï¼š</p><h4 id="ï¼ˆ1ï¼‰è‡ªåŠ¨é‡è¿"><a href="#ï¼ˆ1ï¼‰è‡ªåŠ¨é‡è¿" class="headerlink" title="ï¼ˆ1ï¼‰è‡ªåŠ¨é‡è¿"></a>ï¼ˆ1ï¼‰<strong>è‡ªåŠ¨é‡è¿</strong></h4><ul><li>å®¢æˆ·ç«¯åº“ï¼ˆå¦‚ client-goï¼‰ä¼šè‡ªåŠ¨å°è¯•é‡æ–°å»ºç«‹ä¸ apiserver çš„è¿æ¥ã€‚</li></ul><h4 id="ï¼ˆ2ï¼‰åŸºäºæœ€æ–°-ResourceVersion-é‡æ–°-Watch"><a href="#ï¼ˆ2ï¼‰åŸºäºæœ€æ–°-ResourceVersion-é‡æ–°-Watch" class="headerlink" title="ï¼ˆ2ï¼‰åŸºäºæœ€æ–° ResourceVersion é‡æ–° Watch"></a>ï¼ˆ2ï¼‰<strong>åŸºäºæœ€æ–° ResourceVersion é‡æ–° Watch</strong></h4><ul><li>å®¢æˆ·ç«¯ä¼šä½¿ç”¨**æœ€åä¸€æ¬¡æ”¶åˆ°çš„äº‹ä»¶çš„ <code>ResourceVersion</code>**ï¼ˆæœ¬åœ°ç¼“å­˜ä¸­æœ€æ–°çš„ç‰ˆæœ¬å·ï¼‰å‘èµ·æ–°çš„ <code>Watch</code> è¯·æ±‚ã€‚<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go">watchOpts := metav1.ListOptions&#123;<br>    ResourceVersion: lastObservedRV, <span class="hljs-comment">// ä¸Šæ¬¡è®°å½•çš„ç‰ˆæœ¬å·</span><br>&#125;<br>watcher, err := client.Watch(ctx, watchOpts)<br></code></pre></td></tr></table></figure></li><li>è¿™æ · apiserver ä¼šè¿”å›ä»è¯¥ <code>ResourceVersion</code> ä¹‹åçš„æ‰€æœ‰å˜æ›´äº‹ä»¶ï¼Œç¡®ä¿ä¸ä¸¢å¤±ä»»ä½•äº‹ä»¶ã€‚</li></ul><h4 id="ï¼ˆ3ï¼‰å¤„ç†å†å²äº‹ä»¶å‹ç¼©ï¼ˆCompactï¼‰"><a href="#ï¼ˆ3ï¼‰å¤„ç†å†å²äº‹ä»¶å‹ç¼©ï¼ˆCompactï¼‰" class="headerlink" title="ï¼ˆ3ï¼‰å¤„ç†å†å²äº‹ä»¶å‹ç¼©ï¼ˆCompactï¼‰"></a>ï¼ˆ3ï¼‰<strong>å¤„ç†å†å²äº‹ä»¶å‹ç¼©ï¼ˆCompactï¼‰</strong></h4><ul><li>å¦‚æœç½‘ç»œä¸­æ–­æ—¶é—´è¿‡é•¿ï¼Œapiserver å¯èƒ½å·²æ¸…ç†ï¼ˆcompactï¼‰è¿‡è€çš„ <code>ResourceVersion</code>ï¼ˆetcd çš„é»˜è®¤å†å²çª—å£ä¸º 5 åˆ†é’Ÿï¼‰ã€‚</li><li>æ­¤æ—¶é‡æ–° <code>Watch</code> ä¼šè¿”å› <code>410 Gone</code> é”™è¯¯ï¼Œè¡¨ç¤ºè¯·æ±‚çš„ <code>ResourceVersion</code> å·²ä¸å¯ç”¨ã€‚</li><li>å®¢æˆ·ç«¯éœ€è¦<strong>é‡æ–°å…¨é‡ <code>List</code></strong> å¹¶æ›´æ–°æœ¬åœ°ç¼“å­˜ï¼Œç„¶ååŸºäºæ–°çš„ <code>ResourceVersion</code> å¯åŠ¨ <code>Watch</code>ã€‚</li></ul><h4 id="ï¼ˆ4ï¼‰å¹‚ç­‰å¤„ç†"><a href="#ï¼ˆ4ï¼‰å¹‚ç­‰å¤„ç†" class="headerlink" title="ï¼ˆ4ï¼‰å¹‚ç­‰å¤„ç†"></a>ï¼ˆ4ï¼‰<strong>å¹‚ç­‰å¤„ç†</strong></h4><ul><li>å®¢æˆ·ç«¯éœ€è¦å¤„ç†é‡å¤äº‹ä»¶ï¼ˆå¦‚å› é‡è¿å¯¼è‡´çš„äº‹ä»¶é‡å¤æ¨é€ï¼‰ï¼Œé€šå¸¸é€šè¿‡æ¯”è¾ƒ <code>ResourceVersion</code> å»é‡ã€‚</li></ul><hr><h3 id="4-å…³é”®è®¾è®¡ä¿éšœ"><a href="#4-å…³é”®è®¾è®¡ä¿éšœ" class="headerlink" title="4. å…³é”®è®¾è®¡ä¿éšœ"></a>4. <strong>å…³é”®è®¾è®¡ä¿éšœ</strong></h3><ul><li><strong>ResourceVersion çš„å…¨å±€æœ‰åºæ€§</strong>ï¼šæ‰€æœ‰èµ„æºçš„å˜æ›´å‡æŒ‰ <code>ResourceVersion</code> ä¸¥æ ¼æ’åºï¼Œç¡®ä¿å®¢æˆ·ç«¯å¯ä»¥ç²¾ç¡®æ–­ç‚¹ç»­ä¼ ã€‚</li><li><strong>äº‹ä»¶æŒä¹…åŒ–</strong>ï¼šapiserver ä» etcd è¯»å–äº‹ä»¶å¹¶ç¼“å­˜ï¼Œå³ä½¿å®¢æˆ·ç«¯æ–­å¼€è¿æ¥ï¼Œäº‹ä»¶ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚</li><li><strong>é”™è¯¯å¤„ç†æ ‡å‡†åŒ–</strong>ï¼šé€šè¿‡ <code>410 Gone</code> æ˜ç¡®é€šçŸ¥å®¢æˆ·ç«¯éœ€è¦å…¨é‡åŒæ­¥ã€‚</li></ul><hr><h3 id="5-å®¢æˆ·ç«¯å®ç°ï¼ˆä»¥-client-go-ä¸ºä¾‹"><a href="#5-å®¢æˆ·ç«¯å®ç°ï¼ˆä»¥-client-go-ä¸ºä¾‹" class="headerlink" title="5. å®¢æˆ·ç«¯å®ç°ï¼ˆä»¥ client-go ä¸ºä¾‹"></a>5. <strong>å®¢æˆ·ç«¯å®ç°ï¼ˆä»¥ client-go ä¸ºä¾‹</strong></h3><ul><li><strong>Informer æœºåˆ¶</strong> å°è£…äº† <code>List-Watch</code> çš„å®¹é”™é€»è¾‘ï¼š<ol><li>é¦–æ¬¡å¯åŠ¨æ—¶å…¨é‡ <code>List</code>ã€‚</li><li><code>Watch</code> æ–­å¼€åè‡ªåŠ¨ç”¨æœ€æ–° <code>ResourceVersion</code> é‡è¿ã€‚</li><li>æ”¶åˆ° <code>410</code> é”™è¯¯æ—¶è§¦å‘ <code>List</code> å…¨é‡åŒæ­¥ã€‚</li><li>é€šè¿‡ <code>Delta FIFO</code> é˜Ÿåˆ—å¤„ç†äº‹ä»¶ï¼Œç¡®ä¿é¡ºåºå’Œå»é‡ã€‚</li></ol></li></ul><hr><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>ç½‘ç»œä¸­æ–­æ¢å¤çš„æ ¸å¿ƒæ˜¯é€šè¿‡ <code>ResourceVersion</code> å®ç°çš„æ–­ç‚¹ç»­ä¼ ï¼š  </p><ol><li>çŸ­æœŸä¸­æ–­ï¼šåŸºäºç¼“å­˜çš„ <code>ResourceVersion</code> é‡æ–° <code>Watch</code>ï¼Œè·å–ä¸­æ–­æœŸé—´çš„äº‹ä»¶ã€‚  </li><li>é•¿æœŸä¸­æ–­ï¼šè§¦å‘å…¨é‡ <code>List</code> åé‡æ–° <code>Watch</code>ã€‚<br>è¿™ç§æœºåˆ¶ä¿è¯äº†æœ€ç»ˆä¸€è‡´æ€§å’Œå¯é æ€§ï¼Œæ˜¯ Kubernetes å£°æ˜å¼ API çš„åŸºç¡€ã€‚</li></ol>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Goç®—æ³•é¢˜-å…¨</title>
    <link href="/2025/07/25/Go%E7%AE%97%E6%B3%95%E9%A2%98-%E5%85%A8/"/>
    <url>/2025/07/25/Go%E7%AE%97%E6%B3%95%E9%A2%98-%E5%85%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="Goç®—æ³•é¢˜-ä¸€"><a href="#Goç®—æ³•é¢˜-ä¸€" class="headerlink" title="Goç®—æ³•é¢˜-ä¸€"></a>Goç®—æ³•é¢˜-ä¸€</h1><p>æŒ‰å‡ºç°é¢‘ç‡å¤§å°é€’å‡æ’åºï¼ˆå‚è€ƒ<a href="https://codetop.cc/home%EF%BC%89%EF%BC%9A">https://codetop.cc/homeï¼‰ï¼š</a></p><h2 id="3-æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²"><a href="#3-æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²" class="headerlink" title="3. æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²"></a><a href="https://leetcode.cn/problems/longest-substring-without-repeating-characters/">3. æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²</a></h2><p>(1) leetcode 3. ç»™å®šä¸€ä¸ªå­—ç¬¦ä¸² <code>s</code> ï¼Œè¯·ä½ æ‰¾å‡ºå…¶ä¸­ä¸å«æœ‰é‡å¤å­—ç¬¦çš„ <strong>æœ€é•¿ å­ä¸²</strong> çš„é•¿åº¦ã€‚</p><p><strong>ç¤ºä¾‹ 1:</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">è¾“å…¥: s = &quot;abcabcbb&quot;</span><br><span class="hljs-section">è¾“å‡º: 3 </span><br><span class="hljs-section">è§£é‡Š: å› ä¸ºæ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²æ˜¯ &quot;abc&quot;ï¼Œæ‰€ä»¥å…¶é•¿åº¦ä¸º 3ã€‚</span><br></code></pre></td></tr></table></figure><p><strong>ç¤ºä¾‹ 2:</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">è¾“å…¥: s = &quot;bbbbb&quot;</span><br><span class="hljs-section">è¾“å‡º: 1</span><br><span class="hljs-section">è§£é‡Š: å› ä¸ºæ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²æ˜¯ &quot;b&quot;ï¼Œæ‰€ä»¥å…¶é•¿åº¦ä¸º 1ã€‚</span><br></code></pre></td></tr></table></figure><p><strong>ç¤ºä¾‹ 3:</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">è¾“å…¥: s = &quot;pwwkew&quot;</span><br><span class="hljs-section">è¾“å‡º: 3</span><br><span class="hljs-section">è§£é‡Š: å› ä¸ºæ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²æ˜¯ &quot;wke&quot;ï¼Œæ‰€ä»¥å…¶é•¿åº¦ä¸º 3ã€‚</span><br>     è¯·æ³¨æ„ï¼Œä½ çš„ç­”æ¡ˆå¿…é¡»æ˜¯ å­ä¸² çš„é•¿åº¦ï¼Œ<span class="hljs-string">&quot;pwke&quot;</span> æ˜¯ä¸€ä¸ªå­åºåˆ—ï¼Œä¸æ˜¯å­ä¸²ã€‚<br></code></pre></td></tr></table></figure><p><strong>æç¤ºï¼š</strong></p><ul><li><code>0 &lt;= s.length &lt;= 5 * 104</code></li><li><code>s</code> ç”±è‹±æ–‡å­—æ¯ã€æ•°å­—ã€ç¬¦å·å’Œç©ºæ ¼ç»„æˆ</li></ul><p><strong>è§£ç­”ï¼š</strong></p><p> æ–¹æ³•ç‚¹ï¼š</p><ol><li>ä½¿ç”¨mapè®°å½•å­—ç¬¦ï¼Œç”¨æ¥åˆ¤æ–­æ˜¯å¦é‡å¤</li><li>å¦‚æœå½“å‰å­—ç¬¦ä¸å‰é¢æŸå­—ç¬¦é‡å¤ï¼Œå¯ä»¥ç›´æ¥è·³åˆ°é‡å¤å­—ç¬¦åé¢ï¼Œç»§ç»­æ¯”è¾ƒ</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// //å¤–å±‚å¾ªç¯æ‰©å±•å³è¾¹ç•Œï¼Œå†…å±‚å¾ªç¯æ‰©å±•å·¦è¾¹ç•Œ</span><br><span class="hljs-comment">// for (int l = 0, r = 0 ; r &lt; n ; r++) &#123;</span><br><span class="hljs-comment">// //å½“å‰è€ƒè™‘çš„å…ƒç´ </span><br><span class="hljs-comment">// while (l &lt;= r &amp;&amp; check()) &#123;//åŒºé—´[left,right]ä¸ç¬¦åˆé¢˜æ„</span><br><span class="hljs-comment">//         //æ‰©å±•å·¦è¾¹ç•Œ</span><br><span class="hljs-comment">//     &#125;</span><br><span class="hljs-comment">//     //åŒºé—´[left,right]ç¬¦åˆé¢˜æ„ï¼Œç»Ÿè®¡ç›¸å…³ä¿¡æ¯</span><br><span class="hljs-comment">// &#125;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">lengthOfLongestSubstring</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    m := <span class="hljs-keyword">map</span>[<span class="hljs-type">byte</span>]<span class="hljs-type">int</span>&#123;&#125;<br>    n := <span class="hljs-built_in">len</span>(s)<br>    l := <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> r:=<span class="hljs-number">0</span>, r&lt;n; r++ &#123;<br>        <span class="hljs-comment">// å¦‚æœé‡å¤ï¼Œä¸€ç›´è·³åˆ°é‡å¤å…ƒç´ çš„ä¸‹ä¸€ä½</span><br>        <span class="hljs-keyword">for</span> m[s[r]] != <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-built_in">delete</span>(m, s[l])<br>            l++<br>        &#125;<br>        m[s[r]] = <span class="hljs-number">1</span><br>        res = max(res, r-l+<span class="hljs-number">1</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰</p><h2 id="146-LRU-ç¼“å­˜"><a href="#146-LRU-ç¼“å­˜" class="headerlink" title="146. LRU ç¼“å­˜"></a><a href="https://leetcode.cn/problems/lru-cache/">146. LRU ç¼“å­˜</a></h2><p>leetcode 146. è¯·ä½ è®¾è®¡å¹¶å®ç°ä¸€ä¸ªæ»¡è¶³ <a href="https://baike.baidu.com/item/LRU">LRU (æœ€è¿‘æœ€å°‘ä½¿ç”¨) ç¼“å­˜</a> çº¦æŸçš„æ•°æ®ç»“æ„ã€‚</p><p>å®ç° <code>LRUCache</code> ç±»ï¼š</p><ul><li><code>LRUCache(int capacity)</code> ä»¥ <strong>æ­£æ•´æ•°</strong> ä½œä¸ºå®¹é‡ <code>capacity</code> åˆå§‹åŒ– LRU ç¼“å­˜</li><li><code>int get(int key)</code> å¦‚æœå…³é”®å­— <code>key</code> å­˜åœ¨äºç¼“å­˜ä¸­ï¼Œåˆ™è¿”å›å…³é”®å­—çš„å€¼ï¼Œå¦åˆ™è¿”å› <code>-1</code> ã€‚</li><li><code>void put(int key, int value)</code> å¦‚æœå…³é”®å­— <code>key</code> å·²ç»å­˜åœ¨ï¼Œåˆ™å˜æ›´å…¶æ•°æ®å€¼ <code>value</code> ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™å‘ç¼“å­˜ä¸­æ’å…¥è¯¥ç»„ <code>key-value</code> ã€‚å¦‚æœæ’å…¥æ“ä½œå¯¼è‡´å…³é”®å­—æ•°é‡è¶…è¿‡ <code>capacity</code> ï¼Œåˆ™åº”è¯¥ <strong>é€å‡º</strong> æœ€ä¹…æœªä½¿ç”¨çš„å…³é”®å­—ã€‚</li></ul><p>å‡½æ•° <code>get</code> å’Œ <code>put</code> å¿…é¡»ä»¥ <code>O(1)</code> çš„å¹³å‡æ—¶é—´å¤æ‚åº¦è¿è¡Œã€‚</p><p><strong>ç¤ºä¾‹ï¼š</strong></p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs dart">è¾“å…¥<br>[<span class="hljs-string">&quot;LRUCache&quot;</span>, <span class="hljs-string">&quot;put&quot;</span>, <span class="hljs-string">&quot;put&quot;</span>, <span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;put&quot;</span>, <span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;put&quot;</span>, <span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;get&quot;</span>]<br>[[<span class="hljs-number">2</span>], [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>], [<span class="hljs-number">2</span>, <span class="hljs-number">2</span>], [<span class="hljs-number">1</span>], [<span class="hljs-number">3</span>, <span class="hljs-number">3</span>], [<span class="hljs-number">2</span>], [<span class="hljs-number">4</span>, <span class="hljs-number">4</span>], [<span class="hljs-number">1</span>], [<span class="hljs-number">3</span>], [<span class="hljs-number">4</span>]]<br>è¾“å‡º<br>[<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">1</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">-1</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]<br><br>è§£é‡Š<br>LRUCache lRUCache = <span class="hljs-keyword">new</span> LRUCache(<span class="hljs-number">2</span>);<br>lRUCache.put(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">// ç¼“å­˜æ˜¯ &#123;1=1&#125;</span><br>lRUCache.put(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>); <span class="hljs-comment">// ç¼“å­˜æ˜¯ &#123;1=1, 2=2&#125;</span><br>lRUCache.<span class="hljs-keyword">get</span>(<span class="hljs-number">1</span>);    <span class="hljs-comment">// è¿”å› 1</span><br>lRUCache.put(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>); <span class="hljs-comment">// è¯¥æ“ä½œä¼šä½¿å¾—å…³é”®å­— 2 ä½œåºŸï¼Œç¼“å­˜æ˜¯ &#123;1=1, 3=3&#125;</span><br>lRUCache.<span class="hljs-keyword">get</span>(<span class="hljs-number">2</span>);    <span class="hljs-comment">// è¿”å› -1 (æœªæ‰¾åˆ°)</span><br>lRUCache.put(<span class="hljs-number">4</span>, <span class="hljs-number">4</span>); <span class="hljs-comment">// è¯¥æ“ä½œä¼šä½¿å¾—å…³é”®å­— 1 ä½œåºŸï¼Œç¼“å­˜æ˜¯ &#123;4=4, 3=3&#125;</span><br>lRUCache.<span class="hljs-keyword">get</span>(<span class="hljs-number">1</span>);    <span class="hljs-comment">// è¿”å› -1 (æœªæ‰¾åˆ°)</span><br>lRUCache.<span class="hljs-keyword">get</span>(<span class="hljs-number">3</span>);    <span class="hljs-comment">// è¿”å› 3</span><br>lRUCache.<span class="hljs-keyword">get</span>(<span class="hljs-number">4</span>);    <span class="hljs-comment">// è¿”å› 4</span><br></code></pre></td></tr></table></figure><p><strong>æç¤ºï¼š</strong></p><ul><li><code>1 &lt;= capacity &lt;= 3000</code></li><li><code>0 &lt;= key &lt;= 10000</code></li><li><code>0 &lt;= value &lt;= 105</code></li><li>æœ€å¤šè°ƒç”¨ <code>2 * 105</code> æ¬¡ <code>get</code> å’Œ <code>put</code></li></ul><p><strong>è§£ç­”ï¼š</strong></p><ol><li>ä½¿ç”¨mapæ¥ä¿å­˜cacheæ•°æ®</li><li>ä½¿ç”¨åŒå‘é“¾è¡¨æ¥ä¿å­˜è®¿é—®é¢‘ç‡ï¼Œæœ€è¿‘è®¿é—®çš„æ”¾åœ¨é“¾è¡¨å¤´éƒ¨ã€‚ï¼ˆåŒå‘é“¾è¡¨æ–¹ä¾¿å°¾éƒ¨åˆ é™¤èŠ‚ç‚¹ï¼‰</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> LRUCache <span class="hljs-keyword">struct</span> &#123;<br>    size <span class="hljs-type">int</span><br>    capacity <span class="hljs-type">int</span><br>    cache <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]*DLinkedNode<br>    head *DLinkedNode<br>    tail *DLinkedNode<br>&#125;<br><br><span class="hljs-keyword">type</span> DLinkedNode <span class="hljs-keyword">struct</span> &#123;<br>    key <span class="hljs-type">int</span><br>    value <span class="hljs-type">int</span><br>    prev *DLinkedNode<br>    next *DLinkedNode<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initDLinkedNode</span><span class="hljs-params">(key, value <span class="hljs-type">int</span>)</span></span> *DLinkedNode &#123;<br>    <span class="hljs-keyword">return</span> &amp;DLinkedNode&#123;<br>        key: key,<br>        value: value,<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Constructor</span><span class="hljs-params">(capacity <span class="hljs-type">int</span>)</span></span> LRUCache &#123;<br>    l := LRUCache&#123;<br>        cache: <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]*DLinkedNode&#123;&#125;,<br>        head: initDLinkedNode(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),<br>        tail: initDLinkedNode(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),<br>        capacity: capacity,<br>    &#125;<br>    l.head.next = l.tail<br>    l.tail.prev = l.head<br>    <span class="hljs-keyword">return</span> l<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *LRUCache)</span></span> Get(key <span class="hljs-type">int</span>) <span class="hljs-type">int</span> &#123;<br>    node, ok := this.cache[key]<br>    <span class="hljs-keyword">if</span> !ok &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br>    &#125;<br>    this.moveToHead(node)<br>    <span class="hljs-keyword">return</span> node.value<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *LRUCache)</span></span> Put(key <span class="hljs-type">int</span>, value <span class="hljs-type">int</span>)  &#123;<br>    node, ok := this.cache[key]<br>    <span class="hljs-keyword">if</span> !ok &#123;<br>        node := initDLinkedNode(key, value)<br>        this.cache[key] = node<br>        this.addToHead(node)<br>        this.size++<br>        <span class="hljs-keyword">if</span> this.size &gt; this.capacity &#123;<br>            removed := this.removeTail()<br>            <span class="hljs-built_in">delete</span>(this.cache, removed.key)<br>            this.size--<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        node.value = value<br>        this.moveToHead(node)<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *LRUCache)</span></span> addToHead(node *DLinkedNode) &#123;<br>    node.prev = this.head<br>    node.next = this.head.next<br>    <span class="hljs-comment">// ä»¥ä¸‹ä¸¤è¡Œé¡ºåºä¸èƒ½å</span><br>    this.head.next.prev = node<br>    this.head.next = node<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *LRUCache)</span></span> removeNode(node *DLinkedNode) &#123;<br>    node.prev.next = node.next<br>    node.next.prev = node.prev<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *LRUCache)</span></span> moveToHead(node *DLinkedNode) &#123;<br>    this.removeNode(node)<br>    this.addToHead(node)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *LRUCache)</span></span> removeTail() *DLinkedNode &#123;<br>    node := this.tail.prev<br>    this.removeNode(node)<br>    <span class="hljs-keyword">return</span> node<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Your LRUCache object will be instantiated and called as such:</span><br><span class="hljs-comment"> * obj := Constructor(capacity);</span><br><span class="hljs-comment"> * param_1 := obj.Get(key);</span><br><span class="hljs-comment"> * obj.Put(key,value);</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><p>(3) </p><h2 id="206-åè½¬é“¾è¡¨"><a href="#206-åè½¬é“¾è¡¨" class="headerlink" title="206. åè½¬é“¾è¡¨"></a><a href="https://leetcode.cn/problems/reverse-linked-list/">206. åè½¬é“¾è¡¨</a></h2><p>ç»™ä½ å•é“¾è¡¨çš„å¤´èŠ‚ç‚¹ <code>head</code> ï¼Œè¯·ä½ åè½¬é“¾è¡¨ï¼Œå¹¶è¿”å›åè½¬åçš„é“¾è¡¨ã€‚</p><p>è§£ç­”ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// è¿­ä»£è§£æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reverseList</span><span class="hljs-params">(head *ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">var</span> prev *ListNode<br>    curr := head<br>    <span class="hljs-keyword">for</span> curr != <span class="hljs-literal">nil</span> &#123;<br>        next := curr.Next<br>        curr.Next = prev<br>        prev = curr<br>        curr = next<br>    &#125;<br>    <span class="hljs-keyword">return</span> prev<br>&#125;<br><br><span class="hljs-comment">// é€’å½’è§£æ³•ï¼Œä¸å¥½ç†è§£</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reverseList</span><span class="hljs-params">(head *ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">if</span> head == <span class="hljs-literal">nil</span> || head.Next == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> head<br>    &#125;<br>    newHead := reverseList(head.Next)<br>    head.Next.Next = head<br>    head.Next = <span class="hljs-literal">nil</span><br>    <span class="hljs-keyword">return</span> newHead<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="25-K-ä¸ªä¸€ç»„ç¿»è½¬é“¾è¡¨"><a href="#25-K-ä¸ªä¸€ç»„ç¿»è½¬é“¾è¡¨" class="headerlink" title="25. K ä¸ªä¸€ç»„ç¿»è½¬é“¾è¡¨"></a><a href="https://leetcode.cn/problems/reverse-nodes-in-k-group/">25. K ä¸ªä¸€ç»„ç¿»è½¬é“¾è¡¨</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reverseKGroup</span><span class="hljs-params">(head *ListNode, k <span class="hljs-type">int</span>)</span></span> *ListNode &#123;<br>    dummy := &amp;ListNode&#123;Next: head&#125;<br>    <br>    <span class="hljs-comment">// è®°å½•æ¯ä¸€æ®µçš„å‰é©±èŠ‚ç‚¹</span><br>    pre := dummy<br><br>    <span class="hljs-comment">// æ¯æ¬¡å¾ªç¯å¤„ç†kä¸ª</span><br>    <span class="hljs-keyword">for</span> head != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-comment">// æ‰¾åˆ°ç¬¬kä¸ªèŠ‚ç‚¹ï¼Œä½œä¸ºtail</span><br>        tail := pre<br>        <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; k; i++ &#123;<br>            tail = tail.Next<br>            <span class="hljs-comment">// å¦‚æœè¿˜æ²¡æœ‰åˆ°kä¸ªï¼Œå·²ç»åˆ°äº†ç»“å°¾ï¼Œåˆ™æ•´ä½“åè½¬å·²å®Œæˆï¼Œè¿”å›å¤´èŠ‚ç‚¹</span><br>            <span class="hljs-keyword">if</span> tail == <span class="hljs-literal">nil</span> &#123;<br>                <span class="hljs-keyword">return</span> dummy.Next<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// è®°å½•ä¸‹ä¸€æ®µé“¾è¡¨çš„å¼€å¤´èŠ‚ç‚¹</span><br>        next := tail.Next<br><br>        <span class="hljs-comment">// åè½¬å½“å‰é“¾è¡¨æ®µï¼Œè·å–åˆ°æ–°çš„headå’Œtail</span><br>        head, tail = reverse(head, tail)<br><br>        <span class="hljs-comment">// å°†headè¿æ¥åˆ°ä¸Šä¸€æ®µé“¾è¡¨</span><br>        pre.Next = head<br><br>        <span class="hljs-comment">// å°†tailè¿æ¥åˆ°ä¸‹ä¸€æ®µé“¾è¡¨</span><br>        tail.Next = next<br><br>        <span class="hljs-comment">// æœ¬æ®µçš„æœ«å°¾è®°å½•ä¸ºä¸‹ä¸€æ®µçš„å‰é©±</span><br>        pre = tail<br><br>        <span class="hljs-comment">// headé‡ç½®ä¸ºä¸‹ä¸€æ®µçš„å¼€å¤´</span><br>        head = tail.Next<br>    &#125;<br>    <span class="hljs-keyword">return</span> dummy.Next<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reverse</span><span class="hljs-params">(head, tail *ListNode)</span></span> (*ListNode, *ListNode) &#123;<br>    <span class="hljs-comment">// preç”¨äºè®°å½•å‰é©±èŠ‚ç‚¹</span><br>    <span class="hljs-keyword">var</span> pre *ListNode<br><br>    <span class="hljs-comment">// ä»headèŠ‚ç‚¹å¼€å§‹å¤„ç†</span><br>    curr := head<br><br>    <span class="hljs-comment">// ä¸€ç›´å¾ªç¯åˆ°preæŒ‡å‘æœ€åä¸€ä¸ªèŠ‚ç‚¹</span><br>    <span class="hljs-keyword">for</span> pre != tail &#123;<br>        <span class="hljs-comment">// å…ˆè®°å½•å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span><br>        nex := curr.Next <br>        <span class="hljs-comment">// å°†å½“å‰èŠ‚ç‚¹æŒ‡å‘å‰é©±èŠ‚ç‚¹</span><br>        curr.Next = pre<br>        <span class="hljs-comment">// preåç§»</span><br>        pre = curr<br>        <span class="hljs-comment">// curråç§»</span><br>        curr = nex<br>    &#125;<br>    <span class="hljs-comment">// åè½¬å®Œæˆï¼Œtailæˆä¸ºæ–°çš„å¤´ï¼Œheadæˆä¸ºæ–°çš„å°¾</span><br>    <span class="hljs-keyword">return</span> tail, head<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="15-ä¸‰æ•°ä¹‹å’Œ"><a href="#15-ä¸‰æ•°ä¹‹å’Œ" class="headerlink" title="15. ä¸‰æ•°ä¹‹å’Œ"></a><a href="https://leetcode.cn/problems/3sum/">15. ä¸‰æ•°ä¹‹å’Œ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">threeSum</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> (ans [][]<span class="hljs-type">int</span>) &#123;<br>    <span class="hljs-comment">// å…ˆæ’åºï¼Œä¸ç„¶æ²¡æ³•åš</span><br>    slices.Sort(nums)<br>    <span class="hljs-comment">// </span><br>    <span class="hljs-keyword">for</span> i, x := <span class="hljs-keyword">range</span> nums[:<span class="hljs-built_in">len</span>(nums)<span class="hljs-number">-2</span>]&#123;<br>        <span class="hljs-comment">// å½“å‰å…ƒç´ å’Œä¸Šä¸€ä¸ªå…ƒç´ ç›¸åŒï¼Œåˆ™è·³è¿‡</span><br>        <span class="hljs-keyword">if</span> i &gt; <span class="hljs-number">0</span> &amp;&amp; x == nums[i<span class="hljs-number">-1</span>] &#123;<br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-comment">// å½“å‰å…ƒç´ å’Œåä¸¤ä¸ªå…ƒç´ ç›¸åŠ å·²ç»å¤§äº0ï¼Œåˆ™æ­¤åæ‰€æœ‰å¾ªç¯è‚¯å®šéƒ½å¤§äº0ï¼Œç›´æ¥é€€å‡º</span><br>        <span class="hljs-keyword">if</span> x+nums[i+<span class="hljs-number">1</span>] + nums[i+<span class="hljs-number">2</span>] &gt; <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-keyword">break</span><br>        &#125;<br>        <span class="hljs-comment">// å½“å‰å…ƒç´ å’Œæœ€åä¸¤ä¸ªå…ƒç´ ç›¸åŠ ä»ç„¶å°äº0ï¼Œåˆ™æœ¬è½®å¾ªç¯ä¸­çš„å’Œå‡å°äº0ï¼Œè·³è¿‡æœ¬è½®å¾ªç¯</span><br>        <span class="hljs-keyword">if</span> x + nums[<span class="hljs-built_in">len</span>(nums)<span class="hljs-number">-2</span>] + nums[<span class="hljs-built_in">len</span>(nums)<span class="hljs-number">-1</span>] &lt; <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-comment">// jä»å½“å‰å…ƒç´ çš„åä¸€ä¸ªå…ƒç´ å¼€å§‹</span><br>        j := i+<span class="hljs-number">1</span><br>        <span class="hljs-comment">// kä»æœ€åä¸€ä¸ªå…ƒç´ å¼€å§‹</span><br>        k := <span class="hljs-built_in">len</span>(nums)<span class="hljs-number">-1</span><br>        <br>        <span class="hljs-keyword">for</span> j &lt; k &#123;<br>            s := x + nums[j] + nums[k]<br>            <span class="hljs-comment">// å¦‚æœå°äº0ï¼Œåˆ™å¢å¤§j</span><br>            <span class="hljs-keyword">if</span> s &lt; <span class="hljs-number">0</span> &#123;<br>                j++<br>            <span class="hljs-comment">// å¦‚æœå¤§äº0ï¼Œåˆ™å‡å°k</span><br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> s &gt; <span class="hljs-number">0</span> &#123;<br>                k--<br>            <span class="hljs-comment">// ç­‰äº0ï¼Œåˆ™æ‰¾åˆ°äº†ä¸€ä¸ªç­”æ¡ˆ</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                ans = <span class="hljs-built_in">append</span>(ans, []<span class="hljs-type">int</span>&#123;x, nums[j], nums[k]&#125;)<br>                <span class="hljs-keyword">for</span> j++; j &lt; k &amp;&amp; nums[j] == nums[j<span class="hljs-number">-1</span>]; j++ &#123;&#125; <span class="hljs-comment">// è·³è¿‡é‡å¤æ•°å­—</span><br>                <span class="hljs-keyword">for</span> k--; k &gt; j &amp;&amp; nums[k] == nums[k+<span class="hljs-number">1</span>]; k-- &#123;&#125; <span class="hljs-comment">// è·³è¿‡é‡å¤æ•°å­—</span><br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="53-æœ€å¤§å­æ•°ç»„å’Œ"><a href="#53-æœ€å¤§å­æ•°ç»„å’Œ" class="headerlink" title="53. æœ€å¤§å­æ•°ç»„å’Œ"></a><a href="https://leetcode.cn/problems/maximum-subarray/">53. æœ€å¤§å­æ•°ç»„å’Œ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// åŠ¨æ€è§„åˆ’</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">maxSubArray</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(nums) == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br>    n := <span class="hljs-built_in">len</span>(nums)<br>    <span class="hljs-comment">// sums[i]å€¼çš„å«ä¹‰æ˜¯ï¼Œä»¥nums[i]ä¸ºç»“å°¾çš„æ‰€æœ‰è¿ç»­å­æ•°ç»„çš„æœ€å¤§å’Œ</span><br>    sums := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-built_in">len</span>(nums))<br>    <span class="hljs-comment">// åˆå§‹æ—¶ï¼Œä»¥nums[0]ä¸ºç»“å°¾çš„å­æ•°ç»„å°±æ˜¯å®ƒæœ¬èº«</span><br>    sums[<span class="hljs-number">0</span>] = nums[<span class="hljs-number">0</span>]<br>    <span class="hljs-comment">// ansç”¨æ¥è®°å½•æ•´ä½“æœ€å¤§å’Œ</span><br>    ans := sums[<span class="hljs-number">0</span>]<br>    <span class="hljs-comment">// ä»nums[1]å¼€å§‹éå†</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; n; i++ &#123;<br>        <span class="hljs-comment">// å…³é”®ä»£ç </span><br>        <span class="hljs-comment">// 1. sums[i-1]ä¿å­˜äº†æ‰€æœ‰ä»¥nums[i-1]ä¸ºç»“å°¾å…ƒç´ çš„è¿ç»­å­æ•°ç»„çš„æœ€å¤§å’Œ</span><br>        <span class="hljs-comment">// 2. nums[i]è¦ä¹ˆåŠ å…¥åˆ°å‰é¢çš„è¿ç»­å­æ•°ç»„ï¼Œè¦ä¹ˆè‡ªå·±å•ç‹¬ä½œä¸ºä¸€ä¸ªå­æ•°ç»„</span><br>        sums[i] = max(sums[i<span class="hljs-number">-1</span>] + nums[i], nums[i])<br>        ans = max(ans, sums[i])<br>    &#125;<br>    <span class="hljs-keyword">return</span> ans<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="21-åˆå¹¶ä¸¤ä¸ªæœ‰åºé“¾è¡¨"><a href="#21-åˆå¹¶ä¸¤ä¸ªæœ‰åºé“¾è¡¨" class="headerlink" title="21. åˆå¹¶ä¸¤ä¸ªæœ‰åºé“¾è¡¨"></a><a href="https://leetcode.cn/problems/merge-two-sorted-lists/">21. åˆå¹¶ä¸¤ä¸ªæœ‰åºé“¾è¡¨</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// è¿­ä»£æ³•</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mergeTwoLists</span><span class="hljs-params">(list1 *ListNode, list2 *ListNode)</span></span> *ListNode &#123;<br>    dummy := &amp;ListNode&#123;&#125;<br>    p := dummy<br>    <span class="hljs-keyword">for</span> list1 != <span class="hljs-literal">nil</span> &amp;&amp; list2 != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">if</span> list1.Val &lt; list2.Val &#123;<br>            p.Next = list1<br>            list1 = list1.Next<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            p.Next = list2<br>            list2 = list2.Next<br>        &#125;<br>        p = p.Next<br>    &#125;<br>    <span class="hljs-keyword">if</span> list1 != <span class="hljs-literal">nil</span> &#123;<br>        p.Next = list1<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        p.Next = list2<br>    &#125;<br>   <br>    <span class="hljs-keyword">return</span> dummy.Next<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// é€’å½’æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mergeTwoLists</span><span class="hljs-params">(list1 *ListNode, list2 *ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">if</span> list1 == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> list2<br>    &#125;<br>    <span class="hljs-keyword">if</span> list2 == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> list1<br>    &#125;<br>    <span class="hljs-keyword">if</span> list1.Val &lt; list2.Val &#123;<br>        list1.Next = mergeTwoLists(list1.Next, list2)<br>        <span class="hljs-keyword">return</span> list1<br>    &#125;<br>    list2.Next = mergeTwoLists(list2.Next, list1)<br>    <span class="hljs-keyword">return</span> list2<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-æœ€é•¿å›æ–‡å­ä¸²"><a href="#5-æœ€é•¿å›æ–‡å­ä¸²" class="headerlink" title="5. æœ€é•¿å›æ–‡å­ä¸²"></a><a href="https://leetcode.cn/problems/longest-palindromic-substring/">5. æœ€é•¿å›æ–‡å­ä¸²</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// åŠ¨æ€è§„åˆ’</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">longestPalindrome</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>    n := <span class="hljs-built_in">len</span>(s)<br>    <span class="hljs-keyword">if</span> n &lt; <span class="hljs-number">2</span> &#123;<br>        <span class="hljs-keyword">return</span> s<br>    &#125;<br><br>    <span class="hljs-comment">// ç”¨äºè®°å½•æœ€é•¿å›æ–‡ä¸²é•¿åº¦åŠèµ·å§‹ä½ç½®</span><br>    maxLen := <span class="hljs-number">1</span><br>    begin := <span class="hljs-number">0</span><br><br>    <span class="hljs-comment">// åˆå§‹åŒ–dpæ•°ç»„ï¼Œå¹¶å°†dp[i][i]ç½®ä¸ºtrueï¼ˆæ¯ä¸ªå…ƒç´ éƒ½å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªå›æ–‡ä¸²ï¼‰</span><br>    dp := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">bool</span>, n)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> n &#123;<br>        dp[i] = <span class="hljs-built_in">make</span>([]<span class="hljs-type">bool</span>, n)<br>        dp[i][i] = <span class="hljs-literal">true</span><br>    &#125;<br><br>    <span class="hljs-comment">// å¤–å±‚é•¿åº¦å¾ªç¯ï¼Œéå†æ‰€æœ‰é•¿åº¦çš„å­ä¸²</span><br>    <span class="hljs-keyword">for</span> l := <span class="hljs-number">2</span>; l &lt; n + <span class="hljs-number">1</span>; l++ &#123;<br>        <span class="hljs-comment">// å†…å±‚å¯¹èµ·å§‹ä½ç½®è¿›è¡Œå¾ªç¯ï¼Œéå†æ‰€æœ‰çš„èµ·å§‹ä½ç½®</span><br>        <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> n &#123;<br>            <span class="hljs-comment">// è®¡ç®—ç»“æŸä½ç½®</span><br>            j := i + l <span class="hljs-number">-1</span><br><br>            <span class="hljs-comment">// è‹¥ç»“æŸä½ç½®ä¸åˆæ³•ï¼Œåˆ™ç›´æ¥é€€å‡ºæœ¬è½®å¾ªç¯</span><br>            <span class="hljs-keyword">if</span> j &gt;= n &#123;<br>                <span class="hljs-keyword">break</span><br>            &#125;<br><br>            <span class="hljs-comment">// æ ¸å¿ƒä»£ç ï¼Œdp[i][j]æ˜¯å¦ä¸ºå›æ–‡ä¸²ï¼Œå–å†³äº</span><br>            <span class="hljs-comment">// 1. å†…å±‚dp[i+1][j-1]æ˜¯å›æ–‡ä¸²</span><br>            <span class="hljs-comment">// 2. s[i] == s[j]</span><br>            <span class="hljs-keyword">if</span> s[i] == s[j] &#123;<br>                <span class="hljs-keyword">if</span> j - i &lt;= <span class="hljs-number">2</span> &#123;<br>                    dp[i][j] = <span class="hljs-literal">true</span><br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    dp[i][j] = dp[i+<span class="hljs-number">1</span>][j<span class="hljs-number">-1</span>]<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-comment">// å®æ—¶æ›´æ–°æœ€é•¿å­ä¸²é•¿åº¦åŠèµ·å§‹ä½ç½®</span><br>            <span class="hljs-keyword">if</span> dp[i][j] &amp;&amp; j - i + <span class="hljs-number">1</span> &gt; maxLen &#123;<br>                maxLen = j - i + <span class="hljs-number">1</span><br>                begin = i<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// è¿”å›æœ€ç»ˆç»“æœ</span><br>    <span class="hljs-keyword">return</span> s[begin:begin+maxLen]<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="102-äºŒå‰æ ‘çš„å±‚åºéå†"><a href="#102-äºŒå‰æ ‘çš„å±‚åºéå†" class="headerlink" title="102. äºŒå‰æ ‘çš„å±‚åºéå†"></a><a href="https://leetcode.cn/problems/binary-tree-level-order-traversal/">102. äºŒå‰æ ‘çš„å±‚åºéå†</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">levelOrder</span><span class="hljs-params">(root *TreeNode)</span></span> [][]<span class="hljs-type">int</span> &#123;<br>    <span class="hljs-comment">// å®šä¹‰è¿”å›å€¼</span><br>    res := [][]<span class="hljs-type">int</span>&#123;&#125;<br>    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> res<br>    &#125;<br><br>    <span class="hljs-comment">// qç”¨äºä¿å­˜å¾…éå†çš„å…ƒç´ </span><br>    q := []*TreeNode&#123;root&#125;<br>    <span class="hljs-comment">// qä¸­ä¿å­˜çš„å§‹ç»ˆæ˜¯åŒä¸€å±‚çš„å…ƒç´ </span><br>    <span class="hljs-comment">// æ¯æ¬¡å¾ªç¯ä¸­æŠŠqä¸­æ‰€æœ‰å…ƒç´ éƒ½å–å‡ºï¼Œéƒ½å–å‡ºåå†å¡«å…¥ä¸‹ä¸€å±‚çš„å…ƒç´ </span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; <span class="hljs-built_in">len</span>(q) &gt; <span class="hljs-number">0</span>; i++ &#123;<br>        res = <span class="hljs-built_in">append</span>(res, []<span class="hljs-type">int</span>&#123;&#125;)<br>        <span class="hljs-comment">// å…³é”®ç‚¹ï¼Œç”¨ä¸´æ—¶çš„pæ¥ä¿å­˜ä¸‹å±‚å…ƒç´ ï¼Œå¾…æœ¬å±‚å…ƒç´ å¤„ç†å®Œåï¼Œç”¨pæ›¿æ¢q</span><br>        p := []*TreeNode&#123;&#125;<br>        <span class="hljs-comment">// å°†qä¸­å…ƒç´ å…¨éƒ¨éå†ï¼Œè¿‡ç¨‹ä¸­å°†ä¸‹å±‚å­èŠ‚ç‚¹åŠ å…¥p</span><br>        <span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; <span class="hljs-built_in">len</span>(q); j++ &#123;<br>            node := q[j]<br>            res[i] = <span class="hljs-built_in">append</span>(res[i], node.Val)<br>            <span class="hljs-keyword">if</span> node.Left != <span class="hljs-literal">nil</span> &#123;<br>                p = <span class="hljs-built_in">append</span>(p, node.Left)<br>            &#125;<br>            <span class="hljs-keyword">if</span> node.Right != <span class="hljs-literal">nil</span> &#123;<br>                p = <span class="hljs-built_in">append</span>(p, node.Right)<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// ç”¨pæ›¿æ¢qï¼Œè¿›å…¥æ–°ä¸€è½®å¾ªç¯</span><br>        q = p<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-ä¸¤æ•°ä¹‹å’Œ"><a href="#1-ä¸¤æ•°ä¹‹å’Œ" class="headerlink" title="1. ä¸¤æ•°ä¹‹å’Œ"></a><a href="https://leetcode.cn/problems/two-sum/">1. ä¸¤æ•°ä¹‹å’Œ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">twoSum</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>, target <span class="hljs-type">int</span>)</span></span> []<span class="hljs-type">int</span> &#123;<br>    m := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>)<br>    <span class="hljs-keyword">for</span> i, v := <span class="hljs-keyword">range</span> nums &#123;<br>        <span class="hljs-keyword">if</span> idx, ok := m[target-v]; ok &#123;<br>            <span class="hljs-keyword">return</span> []<span class="hljs-type">int</span>&#123;i, idx&#125;<br>        &#125;<br>        m[v] = i<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="33-æœç´¢æ—‹è½¬æ’åºæ•°ç»„"><a href="#33-æœç´¢æ—‹è½¬æ’åºæ•°ç»„" class="headerlink" title="33. æœç´¢æ—‹è½¬æ’åºæ•°ç»„"></a><a href="https://leetcode.cn/problems/search-in-rotated-sorted-array/">33. æœç´¢æ—‹è½¬æ’åºæ•°ç»„</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">search</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>, target <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(nums) == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br>    &#125;<br><br>    n := <span class="hljs-built_in">len</span>(nums)<br>    l := <span class="hljs-number">0</span><br>    r := n - <span class="hljs-number">1</span><br>    <span class="hljs-comment">// æ€»ä½“æ˜¯äºŒåˆ†æŸ¥æ‰¾</span><br>    <span class="hljs-keyword">for</span> l &lt;= r &#123;<br>        <span class="hljs-comment">// è·å–ä¸­é—´ä½ç½®</span><br>        mid := (l + r) / <span class="hljs-number">2</span><br>        <span class="hljs-comment">// å¦‚æœå‘½ä¸­ï¼Œåˆ™è¿”å›</span><br>        <span class="hljs-keyword">if</span> nums[mid] == target &#123;<br>            <span class="hljs-keyword">return</span> mid<br>        &#125;<br>        <span class="hljs-comment">// å¦‚æœå·¦è¾¹æ˜¯å‡åº</span><br>        <span class="hljs-keyword">if</span> nums[<span class="hljs-number">0</span>] &lt;= nums[mid] &#123;<br>            <span class="hljs-comment">// å¹¶ä¸”targetåœ¨å·¦è¾¹</span><br>            <span class="hljs-keyword">if</span> nums[<span class="hljs-number">0</span>] &lt;= target &amp;&amp; target &lt; nums[mid] &#123;<br>                r = mid - <span class="hljs-number">1</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                l = mid + <span class="hljs-number">1</span><br>            &#125;<br>        <span class="hljs-comment">// å¦‚æœå³è¾¹æ˜¯å‡åº</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// å¹¶ä¸”targetåœ¨å³è¾¹</span><br>            <span class="hljs-keyword">if</span> nums[mid] &lt; target &amp;&amp; target &lt;= nums[n<span class="hljs-number">-1</span>] &#123;<br>                l = mid + <span class="hljs-number">1</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                r = mid - <span class="hljs-number">1</span><br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="200-å²›å±¿æ•°é‡"><a href="#200-å²›å±¿æ•°é‡" class="headerlink" title="200. å²›å±¿æ•°é‡"></a><a href="https://leetcode.cn/problems/number-of-islands/">200. å²›å±¿æ•°é‡</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// æ·±åº¦ä¼˜å…ˆæœç´¢</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">dfs</span><span class="hljs-params">(grid [][]<span class="hljs-type">byte</span>, r, c <span class="hljs-type">int</span>)</span></span> &#123;<br>    nr := <span class="hljs-built_in">len</span>(grid)<br>    nc := <span class="hljs-built_in">len</span>(grid[<span class="hljs-number">0</span>])<br><br>    <span class="hljs-comment">// å…ˆå°†éå†åˆ°çš„å…ƒç´ ç½®ä¸º0</span><br>    grid[r][c] = <span class="hljs-string">&#x27;0&#x27;</span><br>    <span class="hljs-comment">// å‘ä¸Šä¸‹å·¦å³éƒ½èµ°ä¸€æ­¥ï¼Œå¦‚æœå€¼ä¸º1ï¼Œåˆ™å¾€ä¸‹æœç´¢</span><br>    <span class="hljs-keyword">if</span> r - <span class="hljs-number">1</span> &gt;= <span class="hljs-number">0</span> &amp;&amp; grid[r<span class="hljs-number">-1</span>][c] == <span class="hljs-string">&#x27;1&#x27;</span> &#123;<br>        dfs(grid, r<span class="hljs-number">-1</span>, c)<br>    &#125;<br>    <span class="hljs-keyword">if</span> r + <span class="hljs-number">1</span> &lt; nr &amp;&amp; grid[r+<span class="hljs-number">1</span>][c] == <span class="hljs-string">&#x27;1&#x27;</span> &#123;<br>        dfs(grid, r+<span class="hljs-number">1</span>, c)<br>    &#125;<br>    <span class="hljs-keyword">if</span> c - <span class="hljs-number">1</span> &gt;= <span class="hljs-number">0</span> &amp;&amp; grid[r][c<span class="hljs-number">-1</span>] == <span class="hljs-string">&#x27;1&#x27;</span> &#123;<br>        dfs(grid, r, c<span class="hljs-number">-1</span>)<br>    &#125;<br>    <span class="hljs-keyword">if</span> c + <span class="hljs-number">1</span> &lt; nc &amp;&amp; grid[r][c+<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;1&#x27;</span> &#123;<br>        dfs(grid, r, c+<span class="hljs-number">1</span>)<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">numIslands</span><span class="hljs-params">(grid [][]<span class="hljs-type">byte</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    nr := <span class="hljs-built_in">len</span>(grid)<br>    <span class="hljs-keyword">if</span> nr == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br>    nc := <span class="hljs-built_in">len</span>(grid[<span class="hljs-number">0</span>])<br>    <span class="hljs-keyword">if</span> nc == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br><br>    <span class="hljs-keyword">var</span> numIslands <span class="hljs-type">int</span><br>    <span class="hljs-comment">// å°†æ‰€æœ‰å…ƒç´ éå†ä¸€éï¼Œå¦‚æœé‡åˆ°1å°±æ·±åº¦ä¼˜å…ˆæœç´¢</span><br>    <span class="hljs-comment">// åœ¨æ·±åº¦ä¼˜å…ˆæœç´¢ä¸­ï¼Œä¼šå°†éå†åˆ°çš„å…ƒç´ ç½®ä¸º0</span><br>    <span class="hljs-comment">// æœ€ç»ˆæ‰§è¡Œçš„æœç´¢æ¬¡æ•°å³ä¸ºå²›å±¿æ•°é‡</span><br>    <span class="hljs-keyword">for</span> r := <span class="hljs-number">0</span>; r &lt; nr; r++ &#123;<br>        <span class="hljs-keyword">for</span> c := <span class="hljs-number">0</span>; c &lt; nc; c++ &#123;<br>            <span class="hljs-keyword">if</span> grid[r][c] == <span class="hljs-string">&#x27;1&#x27;</span> &#123;<br>                numIslands++<br>                dfs(grid, r, c)<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> numIslands<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="46-å…¨æ’åˆ—"><a href="#46-å…¨æ’åˆ—" class="headerlink" title="46. å…¨æ’åˆ—"></a><a href="https://leetcode.cn/problems/permutations/">46. å…¨æ’åˆ—</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å›æº¯æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">permute</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> [][]<span class="hljs-type">int</span> &#123;<br>    res := [][]<span class="hljs-type">int</span>&#123;&#125;<br>    n := <span class="hljs-built_in">len</span>(nums)<br><br>    <span class="hljs-keyword">var</span> backtrack <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span></span><br>    <span class="hljs-comment">// å¯¹posè¿™ä¸ªä½ç½®ï¼Œä½¿ç”¨å¾…æ’åˆ—çš„æ‰€æœ‰æ•°å­—å°è¯•ä¸€é</span><br>    backtrack = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(pos <span class="hljs-type">int</span>)</span></span> &#123;<br>        <span class="hljs-comment">// å¦‚æœç´¢å¼•åˆ°äº†nï¼Œåˆ™è¯´æ˜å¾—åˆ°äº†ä¸€ä¸ªå…¨æ’åˆ—ï¼Œå°†ç»“æœåŠ å…¥åˆ°ç»“æœé›†ä¸­</span><br>        <span class="hljs-keyword">if</span> pos == n &#123;<br>            res = <span class="hljs-built_in">append</span>(res, <span class="hljs-built_in">append</span>([]<span class="hljs-type">int</span>&#123;&#125;, nums...))<br>        &#125;<br>        <span class="hljs-comment">// å¯¹posè¿™ä¸ªä½ç½®å°è¯•æ‰€æœ‰å¾…ä½¿ç”¨å…ƒç´ </span><br>        <span class="hljs-keyword">for</span> i := pos; i &lt; n; i++ &#123;<br>            <span class="hljs-comment">// æŠŠç¬¬iä¸ªä½ç½®çš„å…ƒç´ æ”¾åˆ°posä½ç½®ä¸Š</span><br>            nums[pos], nums[i] = nums[i], nums[pos]<br>            <span class="hljs-comment">// å¾—åˆ°posåé¢æ‰€æœ‰å­—ç¬¦çš„ç»“æœé›†</span><br>            backtrack(pos+<span class="hljs-number">1</span>)<br>            <span class="hljs-comment">// æ¢å¤poså’Œiå…ƒç´ çš„åˆå§‹ä½ç½®ï¼Œä»¥ä¾¿ä¸‹ä¸€æ¬¡å¾ªç¯ä½¿ç”¨å¦å¤–çš„å…ƒç´ </span><br>            nums[pos], nums[i] = nums[i], nums[pos]<br>        &#125;<br>    &#125;<br><br>    backtrack(<span class="hljs-number">0</span>)<br><br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="20-æœ‰æ•ˆçš„æ‹¬å·"><a href="#20-æœ‰æ•ˆçš„æ‹¬å·" class="headerlink" title="20. æœ‰æ•ˆçš„æ‹¬å·"></a><a href="https://leetcode.cn/problems/valid-parentheses/">20. æœ‰æ•ˆçš„æ‹¬å·</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">isValid</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>    n := <span class="hljs-built_in">len</span>(s)<br>    <span class="hljs-comment">// å¦‚æœå­—ç¬¦æ˜¯å¥‡æ•°ä¸ªï¼Œåˆ™è‚¯å®šä¸èƒ½å®Œå…¨åŒ¹é…</span><br>    <span class="hljs-keyword">if</span> n % <span class="hljs-number">2</span> == <span class="hljs-number">1</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>    &#125;<br><br>    <span class="hljs-comment">// è®°å½•å³æ‹¬å·å¯¹åº”çš„å·¦æ‹¬å·</span><br>    pairs := <span class="hljs-keyword">map</span>[<span class="hljs-type">byte</span>]<span class="hljs-type">byte</span>&#123;<br>        <span class="hljs-string">&#x27;)&#x27;</span>: <span class="hljs-string">&#x27;(&#x27;</span>,<br>        <span class="hljs-string">&#x27;]&#x27;</span>: <span class="hljs-string">&#x27;[&#x27;</span>,<br>        <span class="hljs-string">&#x27;&#125;&#x27;</span>: <span class="hljs-string">&#x27;&#123;&#x27;</span>,<br>    &#125;<br><br>    stack := []<span class="hljs-type">byte</span>&#123;&#125;<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;<br>        <span class="hljs-comment">// å¦‚æœæ‹¿åˆ°äº†ä¸€ä¸ªå³æ‹¬å·</span><br>        <span class="hljs-keyword">if</span> v, ok := pairs[s[i]]; ok &#123;<br>            <span class="hljs-comment">// å¦‚æœæ ˆä¸ºç©ºï¼Œæˆ–è€…æ ˆé¡¶å…ƒç´ ä¸å½“å‰å³æ‹¬å·ä¸åŒ¹é…ï¼Œå°±ç›´æ¥è¿”å›false</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(stack) == <span class="hljs-number">0</span> || stack[<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>] != v &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>            &#125;<br>            <span class="hljs-comment">// å¦‚æœåŒ¹é…å°±æŠŠæ ˆé¡¶å…ƒç´ å‡ºæ ˆ</span><br>            stack = stack[:<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>]<br>        <span class="hljs-comment">// å¦‚æœæ‹¿åˆ°çš„æ˜¯å·¦æ‹¬å·ï¼Œå°±å‹æ ˆ</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            stack = <span class="hljs-built_in">append</span>(stack, s[i])<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// æ ˆä¸­å‰©ä½™å…ƒç´ å°±æ˜¯æ²¡æœ‰åŒ¹é…æˆåŠŸçš„</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(stack) == <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="121-ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº"><a href="#121-ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº" class="headerlink" title="121. ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº"></a><a href="https://leetcode.cn/problems/best-time-to-buy-and-sell-stock/">121. ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// æ ¸å¿ƒæ€æƒ³ï¼šç¬¬iå¤©å–å‡ºå¾—åˆ°çš„æœ€å¤§åˆ©æ¶¦ï¼Œä¹°å…¥ä»·æ ¼ä¸€å®šæ˜¯å‰i-1å¤©ä¸­çš„æœ€ä½ä»·æ ¼</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">maxProfit</span><span class="hljs-params">(prices []<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(prices) == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br>    <span class="hljs-comment">// è®°å½•â€œå†å²â€æœ€ä½ä»·æ ¼</span><br>    minPrice := prices[<span class="hljs-number">0</span>]<br>    <span class="hljs-comment">// è®°å½•æœ€å¤§åˆ©æ¶¦</span><br>    maxProfit := <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> _, price := <span class="hljs-keyword">range</span> prices &#123;<br>        <span class="hljs-comment">// æ›´æ–°æœ€å¤§åˆ©æ¶¦</span><br>        maxProfit = max(maxProfit, price - minPrice)<br>        <span class="hljs-comment">// æ›´æ–°å†å²æœ€ä½ä»·æ ¼</span><br>        minPrice = min(minPrice, price)<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> maxProfit<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="88-åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„"><a href="#88-åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„" class="headerlink" title="88. åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„"></a><a href="https://leetcode.cn/problems/merge-sorted-array/">88. åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">merge</span><span class="hljs-params">(nums1 []<span class="hljs-type">int</span>, m <span class="hljs-type">int</span>, nums2 []<span class="hljs-type">int</span>, n <span class="hljs-type">int</span>)</span></span>  &#123;<br>    <span class="hljs-comment">// ä»åå‘å‰éå†</span><br>    <span class="hljs-comment">// p1æŒ‡å‘nums1å¾…æ’å…ƒç´ ï¼Œp2æŒ‡å‘nums2å¾…æ’å…ƒç´ ï¼ŒtailæŒ‡å‘è¦æ”¾å…¥çš„ä½ç½®</span><br>    <span class="hljs-keyword">for</span> p1, p2, tail := m<span class="hljs-number">-1</span>, n<span class="hljs-number">-1</span>, m+n<span class="hljs-number">-1</span>; p1 &gt;=<span class="hljs-number">0</span> || p2 &gt;= <span class="hljs-number">0</span>; tail-- &#123;<br>        <span class="hljs-comment">// å½“å‰è¦å¤„ç†çš„å…ƒç´ æ˜¯ä»€ä¹ˆ</span><br>        <span class="hljs-keyword">var</span> cur <span class="hljs-type">int</span><br>        <span class="hljs-comment">// å¦‚æœnums1å·²ç»éå†å®Œäº†</span><br>        <span class="hljs-keyword">if</span> p1 == <span class="hljs-number">-1</span> &#123;<br>            <span class="hljs-comment">// ä»nums2ä¸­å–</span><br>            cur = nums2[p2]<br>            p2--<br>        <span class="hljs-comment">// å¦‚æœnums2å·²ç»éå†å®Œäº†</span><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> p2 == <span class="hljs-number">-1</span> &#123;<br>            <span class="hljs-comment">// ä»nums1ä¸­å–</span><br>            cur = nums1[p1]<br>            p1--<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> nums1[p1] &gt; nums2[p2] &#123;<br>            cur = nums1[p1]<br>            p1--<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            cur = nums2[p2]<br>            p2--<br>        &#125;<br>        nums1[tail] = cur<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="103-äºŒå‰æ ‘çš„é”¯é½¿å½¢å±‚åºéå†"><a href="#103-äºŒå‰æ ‘çš„é”¯é½¿å½¢å±‚åºéå†" class="headerlink" title="103. äºŒå‰æ ‘çš„é”¯é½¿å½¢å±‚åºéå†"></a><a href="https://leetcode.cn/problems/binary-tree-zigzag-level-order-traversal/">103. äºŒå‰æ ‘çš„é”¯é½¿å½¢å±‚åºéå†</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">zigzagLevelOrder</span><span class="hljs-params">(root *TreeNode)</span></span> [][]<span class="hljs-type">int</span> &#123;<br>    res := [][]<span class="hljs-type">int</span>&#123;&#125;<br>    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> res<br>    &#125;<br>    <span class="hljs-comment">// è¾…åŠ©å±‚åºéå†</span><br>    queue := []*TreeNode&#123;root&#125;<br>    <span class="hljs-keyword">for</span> level := <span class="hljs-number">0</span>; <span class="hljs-built_in">len</span>(queue) &gt; <span class="hljs-number">0</span>; level++ &#123;<br>        vals := []<span class="hljs-type">int</span>&#123;&#125;<br>        <span class="hljs-comment">// qæ¥æ”¶æœ¬å±‚å…ƒç´ ï¼Œç”¨äºéå†ï¼Œqueueä¿å­˜ä¸‹å±‚å…ƒç´ </span><br>        q := queue<br>        queue = <span class="hljs-literal">nil</span><br>        <span class="hljs-keyword">for</span> _, node := <span class="hljs-keyword">range</span> q &#123;<br>            vals = <span class="hljs-built_in">append</span>(vals, node.Val)<br>            <span class="hljs-keyword">if</span> node.Left != <span class="hljs-literal">nil</span> &#123;<br>                queue = <span class="hljs-built_in">append</span>(queue, node.Left)<br>            &#125;<br>            <span class="hljs-keyword">if</span> node.Right != <span class="hljs-literal">nil</span> &#123;<br>                queue = <span class="hljs-built_in">append</span>(queue, node.Right)<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// å¦‚æœæœ¬å±‚ä¸ºå¥‡æ•°å±‚ï¼Œå°†å¾—åˆ°çš„éå†ç»“æœåè½¬ï¼Œå†åŠ å…¥ç»“æœé›†</span><br>        <span class="hljs-keyword">if</span> level % <span class="hljs-number">2</span> == <span class="hljs-number">1</span> &#123;<br>            n := <span class="hljs-built_in">len</span>(vals)<br>            <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n/<span class="hljs-number">2</span>; i++ &#123;<br>                vals[i], vals[n<span class="hljs-number">-1</span>-i] = vals[n<span class="hljs-number">-1</span>-i], vals[i]<br>            &#125;<br>        &#125;<br>        res = <span class="hljs-built_in">append</span>(res, vals)<br>    &#125;<br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="141-ç¯å½¢é“¾è¡¨"><a href="#141-ç¯å½¢é“¾è¡¨" class="headerlink" title="141. ç¯å½¢é“¾è¡¨"></a><a href="https://leetcode.cn/problems/linked-list-cycle/">141. ç¯å½¢é“¾è¡¨</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// å“ˆå¸Œè¡¨</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">hasCycle</span><span class="hljs-params">(head *ListNode)</span></span> <span class="hljs-type">bool</span> &#123;<br>    seen := <span class="hljs-keyword">map</span>[*ListNode]<span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br>    <span class="hljs-keyword">for</span> head != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">if</span> _, ok := seen[head]; ok &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>        &#125;<br>        seen[head] = <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br>        head = head.Next<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å¿«æ…¢æŒ‡é’ˆ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">hasCycle</span><span class="hljs-params">(head *ListNode)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">if</span> head == <span class="hljs-literal">nil</span> || head.Next == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>    &#125;<br>    <span class="hljs-comment">// æ…¢æŒ‡é’ˆæ¯æ¬¡èµ°ä¸€æ­¥ï¼Œå¿«æŒ‡é’ˆæ¯æ¬¡èµ°ä¸¤æ­¥</span><br>    <span class="hljs-comment">// æ¯æ¬¡ç§»åŠ¨å¿«æ…¢æŒ‡é’ˆä¹‹é—´çš„è·ç¦»ä¼šåŠ 1ï¼Œå¦‚æœæœ‰ç¯çš„è¯ï¼Œå¿«æ…¢æŒ‡é’ˆç»ˆä¼šç›¸é‡</span><br>    slow, fast := head, head.Next<br>    <span class="hljs-keyword">for</span> slow != fast &#123;<br>        <span class="hljs-keyword">if</span> fast == <span class="hljs-literal">nil</span> || fast.Next == <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>        &#125;<br>        slow = slow.Next<br>        fast = fast.Next.Next<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="236-äºŒå‰æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ"><a href="#236-äºŒå‰æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ" class="headerlink" title="236. äºŒå‰æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ"></a><a href="https://leetcode.cn/problems/lowest-common-ancestor-of-a-binary-tree/">236. äºŒå‰æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-comment">// æ‰¾åˆ°æœ€è¿‘å…¬å…±ç¥–å…ˆ or æ‰¾åˆ°p/qæœ¬èº«</span><br> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">lowestCommonAncestor</span><span class="hljs-params">(root, p, q *TreeNode)</span></span> *TreeNode &#123;<br>    <span class="hljs-comment">// å¦‚æœå·²ç»åˆ°è¾¾åº•éƒ¨ï¼Œç›´æ¥è¿”å›</span><br>    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br><br>    <span class="hljs-comment">// å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯pæˆ–è€…qï¼Œè¿”å›è¯¥èŠ‚ç‚¹</span><br>    <span class="hljs-keyword">if</span> root.Val == p.Val || root.Val == q.Val &#123;<br>        <span class="hljs-keyword">return</span> root<br>    &#125;<br><br>    <span class="hljs-comment">// åœ¨å·¦å­æ ‘ä¸­æ‰¾åˆ°æœ€è¿‘å…¬å…±ç¥–å…ˆ æˆ– åœ¨å·¦å­æ ‘ä¸­æ‰¾åˆ°p/q</span><br>    left := lowestCommonAncestor(root.Left, p, q)<br><br>    <span class="hljs-comment">// åœ¨å³å­æ ‘ä¸­æ‰¾åˆ°æœ€è¿‘å…¬å…±ç¥–å…ˆ æˆ– åœ¨å³å­æ ‘ä¸­æ‰¾åˆ°p/q</span><br>    right := lowestCommonAncestor(root.Right, p, q)<br>    <br>    <span class="hljs-comment">// å·¦å­æ ‘ä¸­æ‰¾åˆ°äº†p/qï¼Œå³å­æ ‘ä¸­ä¹Ÿæ‰¾åˆ°äº†p/q</span><br>    <span class="hljs-comment">// åˆ™å½“å‰èŠ‚ç‚¹ä¸ºæœ€è¿‘å…¬å…±ç¥–å…ˆï¼ˆåªæœ‰æœ€è¿‘å…¬å…±ç¥–å…ˆæ»¡è¶³è¯¥æ¡ä»¶ï¼‰</span><br>    <span class="hljs-keyword">if</span> left != <span class="hljs-literal">nil</span> &amp;&amp; right != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> root<br>    &#125;<br><br>    <span class="hljs-comment">// å¦‚æœåªæ˜¯æ‰¾åˆ°äº†ä¸€ä¸ªï¼Œåˆ™è¿”å›æ‰¾åˆ°çš„é‚£ä¸ªï¼Œè¡¨ç¤ºä»è¯¥èŠ‚ç‚¹å¾€ä¸‹æœ‰ä¸€ä¸ªp/q</span><br>    <span class="hljs-comment">// å¦‚æœéƒ½æ²¡æ‰¾åˆ°ï¼Œè¿”å›nil</span><br>    <span class="hljs-keyword">if</span> left == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> right<br>    &#125;<br>    <span class="hljs-keyword">return</span> left<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="92-åè½¬é“¾è¡¨-II"><a href="#92-åè½¬é“¾è¡¨-II" class="headerlink" title="92. åè½¬é“¾è¡¨ II"></a><a href="https://leetcode.cn/problems/reverse-linked-list-ii/">92. åè½¬é“¾è¡¨ II</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-comment">// å¤´æ’æ³•ä¸€æ¬¡éå†</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reverseBetween</span><span class="hljs-params">(head *ListNode, left <span class="hljs-type">int</span>, right <span class="hljs-type">int</span>)</span></span> *ListNode &#123;<br>    <span class="hljs-comment">// è®¾ç½®dummyèŠ‚ç‚¹æ˜¯æ­¤ç±»é—®é¢˜çš„ä¸€èˆ¬åšæ³•</span><br>    dummy := &amp;ListNode&#123;Next: head&#125;<br>    pre := dummy<br><br>    <span class="hljs-comment">// æ‰¾åˆ°leftçš„å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä½œä¸ºpre</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; left<span class="hljs-number">-1</span>; i++ &#123;<br>        pre = pre.Next<br>    &#125;<br><br>    <span class="hljs-comment">// leftèŠ‚ç‚¹ä½œä¸ºcur</span><br>    cur := pre.Next<br><br>    <span class="hljs-comment">// ä»leftå¼€å§‹éå†ï¼Œæ¯æ¬¡å¾ªç¯æŠŠå½“å‰èŠ‚ç‚¹çš„åä¸€ä¸ªèŠ‚ç‚¹æ’å…¥åˆ°preåé¢ï¼ˆè¯¥æ®µé“¾è¡¨çš„å¤´éƒ¨ï¼‰</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; right-left; i++ &#123;<br>        next := cur.Next<br>        cur.Next = next.Next<br>        next.Next = pre.Next<br>        pre.Next = next<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> dummy.Next<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="322-é›¶é’±å…‘æ¢"><a href="#322-é›¶é’±å…‘æ¢" class="headerlink" title="322. é›¶é’±å…‘æ¢"></a><a href="https://leetcode.cn/problems/coin-change/">322. é›¶é’±å…‘æ¢</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">coinChange</span><span class="hljs-params">(coins []<span class="hljs-type">int</span>, amount <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> amount == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br>    <span class="hljs-comment">// dp[i]ä¸ºç»„æˆæ•°é‡ä¸ºiçš„é‡‘é¢æ‰€éœ€çš„æœ€å°ç¡¬å¸æ•°</span><br>    dp := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, amount+<span class="hljs-number">1</span>)<br>    dp[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span><br>    <span class="hljs-comment">// ä¸ºdp[i]èµ‹åˆå§‹å€¼</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt;= amount; i++ &#123;<br>        <span class="hljs-comment">// è¿™é‡Œçš„amount+1å¹¶æ²¡æœ‰å®é™…æ„ä¹‰ï¼Œä»…ä»…æ˜¯ä¸ºäº†æ–¹ä¾¿åˆ¤æ–­æ˜¯å¦æœ‰è§£ï¼Œä»»ä½•ä¸€ä¸ªå¤§äºamountçš„æ•°å‡å¯</span><br>        <span class="hljs-comment">// å› ä¸ºç»„æˆamountæ‰€éœ€çš„ç¡¬å¸æ•°é‡åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½ä¸ä¼šå¤§äºamount</span><br>        dp[i] = amount + <span class="hljs-number">1</span><br>    &#125;<br>    <br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt;= amount; i++ &#123;<br>        <span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; <span class="hljs-built_in">len</span>(coins); j++ &#123;<br>            <span class="hljs-keyword">if</span> coins[j] &lt;= i &#123;<br>                <span class="hljs-comment">// ç»„æˆi-coins[j]çš„æœ€å°ç¡¬å¸æ•°ï¼ŒåŠ ä¸Šæœ¬æ¬¡çš„ä¸€ä¸ªç¡¬å¸</span><br>                dp[i] = min(dp[i], dp[i-coins[j]] + <span class="hljs-number">1</span>)<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> dp[amount] &gt; amount &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> dp[amount]<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="54-èºæ—‹çŸ©é˜µ"><a href="#54-èºæ—‹çŸ©é˜µ" class="headerlink" title="54. èºæ—‹çŸ©é˜µ"></a><a href="https://leetcode.cn/problems/spiral-matrix/">54. èºæ—‹çŸ©é˜µ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">spiralOrder</span><span class="hljs-params">(matrix [][]<span class="hljs-type">int</span>)</span></span> []<span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(matrix) == <span class="hljs-number">0</span> || <span class="hljs-built_in">len</span>(matrix[<span class="hljs-number">0</span>]) == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> []<span class="hljs-type">int</span>&#123;&#125;<br>    &#125;<br><br>    rows, cols := <span class="hljs-built_in">len</span>(matrix), <span class="hljs-built_in">len</span>(matrix[<span class="hljs-number">0</span>])<br>    order := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, rows * cols)<br>    index := <span class="hljs-number">0</span><br>    <span class="hljs-comment">// è®°å½•è¾¹ç•Œ</span><br>    left, right, top, bottom := <span class="hljs-number">0</span>, cols - <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, rows - <span class="hljs-number">1</span><br><br>    <span class="hljs-comment">// åœ¨è¾¹ç•ŒèŒƒå›´å†…ç§»åŠ¨</span><br>    <span class="hljs-keyword">for</span> left &lt;= right &amp;&amp; top &lt;= bottom &#123;<br>        <span class="hljs-comment">// ä»å·¦å¾€å³ç§»åŠ¨ï¼Œä»æœ€å·¦ç«¯leftå¼€å§‹ï¼Œä¸€ç›´åˆ°æœ€å³ç«¯right</span><br>        <span class="hljs-keyword">for</span> col := left; col &lt;= right; col++ &#123;<br>            order[index] = matrix[top][col]<br>            index++<br>        &#125;<br>        <span class="hljs-comment">// ä»ä¸Šå¾€ä¸‹ç§»åŠ¨ï¼Œä»æœ€ä¸Šé¢çš„ä¸‹ä¸€ä¸ªå…ƒç´ å¼€å§‹ï¼Œåˆ°æœ€ä¸‹ç«¯</span><br>        <span class="hljs-keyword">for</span> row := top + <span class="hljs-number">1</span>; row &lt;= bottom; row++ &#123;<br>            order[index] = matrix[row][right]<br>            index++<br>        &#125;<br>        <span class="hljs-comment">// å› ä¸ºéœ€è¦å§‹ç»ˆæ»¡è¶³col &gt; leftå’Œrow &gt; topï¼Œè¿™é‡Œè¦ä¿è¯æ•°ç»„è®¿é—®ä¸è¶Šç•Œ</span><br>        <span class="hljs-keyword">if</span> left &lt; right &amp;&amp; top &lt; bottom &#123;<br>            <span class="hljs-comment">// ä»å³å¾€å·¦ç§»åŠ¨</span><br>            <span class="hljs-keyword">for</span> col := right - <span class="hljs-number">1</span>; col &gt; left; col-- &#123;<br>                order[index] = matrix[bottom][col]<br>                index++<br>            &#125;<br>            <span class="hljs-comment">// ä»ä¸‹å¾€ä¸Šç§»åŠ¨</span><br>            <span class="hljs-keyword">for</span> row := bottom; row &gt; top; row-- &#123;<br>                order[index] = matrix[row][left]<br>                index++<br>            &#125;<br>        &#125;<br>        left++<br>        right--<br>        top++<br>        bottom--<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> order<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="300-æœ€é•¿é€’å¢å­åºåˆ—"><a href="#300-æœ€é•¿é€’å¢å­åºåˆ—" class="headerlink" title="300. æœ€é•¿é€’å¢å­åºåˆ—"></a><a href="https://leetcode.cn/problems/longest-increasing-subsequence/">300. æœ€é•¿é€’å¢å­åºåˆ—</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">lengthOfLIS</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    n := <span class="hljs-built_in">len</span>(nums)<br>    <span class="hljs-keyword">if</span> n == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br>    d := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, n + <span class="hljs-number">1</span>)<br>    <span class="hljs-built_in">len</span> := <span class="hljs-number">1</span><br>    d[<span class="hljs-built_in">len</span>] = nums[<span class="hljs-number">0</span>]<br><br>    <span class="hljs-keyword">for</span> _, num := <span class="hljs-keyword">range</span> nums &#123;<br>        <span class="hljs-keyword">if</span> num &gt; d[<span class="hljs-built_in">len</span>] &#123;<br>            <span class="hljs-built_in">len</span>++<br>            d[<span class="hljs-built_in">len</span>] = num<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            l := <span class="hljs-number">1</span><br>            r := <span class="hljs-built_in">len</span><br>            pos := <span class="hljs-number">0</span><br>            <span class="hljs-comment">// æ‰¾åˆ°æ¯”numå°çš„æœ€å¤§çš„æ•°</span><br>            <span class="hljs-keyword">for</span> l &lt;= r &#123;<br>                mid := (l + r) &gt;&gt; <span class="hljs-number">1</span><br>                <span class="hljs-keyword">if</span> d[mid] &lt; num &#123;<br>                    pos = mid<br>                    l = mid + <span class="hljs-number">1</span><br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    r = mid - <span class="hljs-number">1</span><br>                &#125;<br>            &#125;<br>            d[pos+<span class="hljs-number">1</span>] = num<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="23-åˆå¹¶-K-ä¸ªå‡åºé“¾è¡¨"><a href="#23-åˆå¹¶-K-ä¸ªå‡åºé“¾è¡¨" class="headerlink" title="23. åˆå¹¶ K ä¸ªå‡åºé“¾è¡¨"></a><a href="https://leetcode.cn/problems/merge-k-sorted-lists/">23. åˆå¹¶ K ä¸ªå‡åºé“¾è¡¨</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mergeKLists</span><span class="hljs-params">(lists []*ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">return</span> merge(lists, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(lists)<span class="hljs-number">-1</span>)<br>&#125;<br><span class="hljs-comment">// é€’å½’æ‰§è¡Œï¼Œå°†æ•°ç»„æ‹†æˆå·¦å³ä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«åˆå¹¶ä¸ºä¸€ä¸ªé“¾è¡¨ï¼Œæœ€ç»ˆå†å°†ä¸¤ä¸ªé“¾è¡¨åˆå¹¶</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">merge</span><span class="hljs-params">(lists []*ListNode, l, r <span class="hljs-type">int</span>)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">if</span> l == r &#123;<br>        <span class="hljs-keyword">return</span> lists[l]<br>    &#125;<br>    <span class="hljs-keyword">if</span> l &gt; r &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br>    mid := (l + r) / <span class="hljs-number">2</span><br>    <span class="hljs-keyword">return</span> mergeTwoLists(merge(lists, l, mid), merge(lists, mid+<span class="hljs-number">1</span>, r))<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mergeTwoLists</span><span class="hljs-params">(a, b *ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">if</span> a == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> b<br>    &#125;<br>    <span class="hljs-keyword">if</span> b == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> a<br>    &#125;<br><br>    dummy := &amp;ListNode&#123;&#125;<br>    tail := dummy<br>    pa := a<br>    pb := b<br>    <span class="hljs-keyword">for</span> pa != <span class="hljs-literal">nil</span> &amp;&amp; pb != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">if</span> pa.Val &lt; pb.Val &#123;<br>            tail.Next = pa<br>            pa = pa.Next<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            tail.Next = pb<br>            pb = pb.Next<br>        &#125;<br>        tail = tail.Next<br>    &#125;<br>    <span class="hljs-keyword">if</span> pa != <span class="hljs-literal">nil</span> &#123;<br>        tail.Next = pa<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        tail.Next = pb<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> dummy.Next<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="143-é‡æ’é“¾è¡¨"><a href="#143-é‡æ’é“¾è¡¨" class="headerlink" title="143. é‡æ’é“¾è¡¨"></a><a href="https://leetcode.cn/problems/reorder-list/">143. é‡æ’é“¾è¡¨</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reorderList</span><span class="hljs-params">(head *ListNode)</span></span>  &#123;<br>    <span class="hljs-keyword">if</span> head == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    mid := middleNode(head)<br>    l1 := head<br>    l2 := mid.Next<br>    mid.Next = <span class="hljs-literal">nil</span><br><br>    l2 = reverseList(l2)<br><br>    mergeList(l1, l2)<br>&#125;<br><br><span class="hljs-comment">// å¿«æ…¢æŒ‡é’ˆæ‰¾ä¸­ç‚¹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">middleNode</span><span class="hljs-params">(head *ListNode)</span></span> *ListNode &#123;<br>    slow, fast := head, head<br>    <span class="hljs-keyword">for</span> fast.Next != <span class="hljs-literal">nil</span> &amp;&amp; fast.Next.Next != <span class="hljs-literal">nil</span> &#123;<br>        slow = slow.Next<br>        fast = fast.Next.Next<br>    &#125;<br>    <span class="hljs-keyword">return</span> slow<br>&#125;<br><br><span class="hljs-comment">// åè½¬é“¾è¡¨</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reverseList</span><span class="hljs-params">(head *ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">var</span> pre, cur *ListNode = <span class="hljs-literal">nil</span>, head<br>    <span class="hljs-keyword">for</span> cur != <span class="hljs-literal">nil</span> &#123;<br>        next := cur.Next<br>        cur.Next = pre<br>        pre = cur<br>        cur = next<br>    &#125;<br>    <span class="hljs-keyword">return</span> pre<br>&#125;<br><br><span class="hljs-comment">// äº¤æ›¿åˆå¹¶é“¾è¡¨</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mergeList</span><span class="hljs-params">(l1, l2 *ListNode)</span></span> &#123;<br>    <span class="hljs-keyword">for</span> l1 != <span class="hljs-literal">nil</span> &amp;&amp; l2 != <span class="hljs-literal">nil</span> &#123;<br>        l1Next := l1.Next<br>        l2Next := l2.Next<br><br>        l1.Next = l2<br>        l1 = l1Next<br><br>        l2.Next = l1<br>        l2 = l2Next<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="415-å­—ç¬¦ä¸²ç›¸åŠ "><a href="#415-å­—ç¬¦ä¸²ç›¸åŠ " class="headerlink" title="415. å­—ç¬¦ä¸²ç›¸åŠ "></a><a href="https://leetcode.cn/problems/add-strings/">415. å­—ç¬¦ä¸²ç›¸åŠ </a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">addStrings</span><span class="hljs-params">(num1 <span class="hljs-type">string</span>, num2 <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>    add := <span class="hljs-number">0</span><br>    ans := <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> i, j := <span class="hljs-built_in">len</span>(num1) - <span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(num2) - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span> || j &gt;= <span class="hljs-number">0</span> || add != <span class="hljs-number">0</span>; i, j = i - <span class="hljs-number">1</span>, j - <span class="hljs-number">1</span> &#123;<br>        <span class="hljs-keyword">var</span> x, y <span class="hljs-type">int</span><br>        <span class="hljs-keyword">if</span> i &gt;= <span class="hljs-number">0</span> &#123;<br>            x = <span class="hljs-type">int</span>(num1[i] - <span class="hljs-string">&#x27;0&#x27;</span>)<br>        &#125;<br>        <span class="hljs-keyword">if</span> j &gt;= <span class="hljs-number">0</span> &#123;<br>            y = <span class="hljs-type">int</span>(num2[j] - <span class="hljs-string">&#x27;0&#x27;</span>)<br>        &#125;<br>        result := x + y + add<br>        <span class="hljs-comment">// result % 10 ä¸ºå½“å‰ä½</span><br>        ans = strconv.Itoa(result % <span class="hljs-number">10</span>) + ans<br>        <span class="hljs-comment">// å‘ä¸‹ä¸€ä½çš„è¿›ä½</span><br>        add = result / <span class="hljs-number">10</span><br>    &#125;<br><br>    <span class="hljs-keyword">return</span> ans<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="160-ç›¸äº¤é“¾è¡¨"><a href="#160-ç›¸äº¤é“¾è¡¨" class="headerlink" title="160. ç›¸äº¤é“¾è¡¨"></a><a href="https://leetcode.cn/problems/intersection-of-two-linked-lists/">160. ç›¸äº¤é“¾è¡¨</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-comment">// å“ˆå¸Œè¡¨å­˜å‚¨</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getIntersectionNode</span><span class="hljs-params">(headA, headB *ListNode)</span></span> *ListNode &#123;<br>    vis := <span class="hljs-keyword">map</span>[*ListNode]<span class="hljs-type">bool</span>&#123;&#125;<br>    <span class="hljs-keyword">for</span> p := headA; p != <span class="hljs-literal">nil</span>; p = p.Next &#123;<br>        vis[p] = <span class="hljs-literal">true</span><br>    &#125;<br>    <span class="hljs-keyword">for</span> p := headB; p != <span class="hljs-literal">nil</span>; p = p.Next &#123;<br>        <span class="hljs-keyword">if</span> vis[p] &#123;<br>            <span class="hljs-keyword">return</span> p<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// åŒæŒ‡é’ˆåˆ†åˆ«ä»ä¸¤ä¸ªé“¾è¡¨å¤´éƒ¨å¼€å§‹éå†ï¼Œéå†å®Œåè½¬åˆ°å¦ä¸€æ¡é“¾è¡¨å¤´éƒ¨éå†</span><br><span class="hljs-comment">// è‹¥å­˜åœ¨ç›¸äº¤èŠ‚ç‚¹ï¼Œåˆ™å¿…å®šç›¸é‡ï¼ˆå› ä¸ºä¼šèµ°è¿‡ç›¸åŒè·ç¦»x1+y+x2ï¼‰</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getIntersectionNode</span><span class="hljs-params">(headA, headB *ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">if</span> headA == <span class="hljs-literal">nil</span> || headB == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br>    pa, pb := headA, headB<br>    <span class="hljs-keyword">for</span> pa != pb &#123;<br>        <span class="hljs-keyword">if</span> pa == <span class="hljs-literal">nil</span> &#123;<br>            pa = headB<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            pa = pa.Next<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> pb == <span class="hljs-literal">nil</span> &#123;<br>            pb = headA<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            pb = pb.Next<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> pa<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="56-åˆå¹¶åŒºé—´"><a href="#56-åˆå¹¶åŒºé—´" class="headerlink" title="56. åˆå¹¶åŒºé—´"></a><a href="https://leetcode.cn/problems/merge-intervals/">56. åˆå¹¶åŒºé—´</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs GO"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">merge</span><span class="hljs-params">(intervals [][]<span class="hljs-type">int</span>)</span></span> [][]<span class="hljs-type">int</span> &#123;<br>    <span class="hljs-comment">// å…ˆæŒ‰ç…§å·¦ç«¯ç‚¹è¿›è¡Œæ’åº</span><br>    sort.Slice(intervals, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, j <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>        <span class="hljs-keyword">return</span> intervals[i][<span class="hljs-number">0</span>] &lt; intervals[j][<span class="hljs-number">0</span>]<br>    &#125;)<br><br>    <span class="hljs-comment">// ç”¨äºä¿å­˜ç»“æœ</span><br>    res := [][]<span class="hljs-type">int</span>&#123;&#125;<br><br>    <span class="hljs-comment">// éå†æ’åºåçš„åŒºé—´</span><br>    <span class="hljs-keyword">for</span> _, interval := <span class="hljs-keyword">range</span> intervals &#123;<br>        n := <span class="hljs-built_in">len</span>(res)<br>        <span class="hljs-comment">// æ²¡æœ‰é‡åˆï¼šresä¸­æœ€åä¸€ä¸ªåŒºé—´çš„å³ç«¯ç‚¹å°äºå½“å‰åŒºé—´å·¦ç«¯ç‚¹</span><br>        <span class="hljs-keyword">if</span> n == <span class="hljs-number">0</span> || res[n<span class="hljs-number">-1</span>][<span class="hljs-number">1</span>] &lt; interval[<span class="hljs-number">0</span>] &#123;<br>            res = <span class="hljs-built_in">append</span>(res, interval)<br>        <span class="hljs-comment">// æœ‰é‡åˆï¼Œå°±æ‹“å±•resä¸­æœ€åä¸€ä¸ªåŒºé—´çš„å³è¾¹ç•Œ</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            res[n<span class="hljs-number">-1</span>][<span class="hljs-number">1</span>] = max(res[n<span class="hljs-number">-1</span>][<span class="hljs-number">1</span>], interval[<span class="hljs-number">1</span>])<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="42-æ¥é›¨æ°´"><a href="#42-æ¥é›¨æ°´" class="headerlink" title="42. æ¥é›¨æ°´"></a><a href="https://leetcode.cn/problems/trapping-rain-water/">42. æ¥é›¨æ°´</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">trap</span><span class="hljs-params">(height []<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    n := <span class="hljs-built_in">len</span>(height)<br>    <span class="hljs-keyword">if</span> n == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br><br>    <span class="hljs-comment">// leftMax[i]çš„å«ä¹‰æ˜¯ï¼Œä»iè¿™ä¸ªä½ç½®å¾€å·¦çœ‹ï¼Œæœ€é«˜çš„é«˜åº¦</span><br>    leftMax := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, n)<br>    leftMax[<span class="hljs-number">0</span>] = height[<span class="hljs-number">0</span>]<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; n; i++ &#123;<br>        leftMax[i] = max(leftMax[i<span class="hljs-number">-1</span>], height[i])<br>    &#125;<br><br>    <span class="hljs-comment">// rightMax[i]çš„å«ä¹‰æ˜¯ï¼Œä»iè¿™ä¸ªä½ç½®å¾€å³çœ‹ï¼Œæœ€é«˜çš„é«˜åº¦</span><br>    rightMax := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, n)<br>    rightMax[n<span class="hljs-number">-1</span>] = height[n<span class="hljs-number">-1</span>]<br>    <span class="hljs-keyword">for</span> i := n - <span class="hljs-number">2</span>; i &gt;= <span class="hljs-number">0</span>; i-- &#123;<br>        rightMax[i] = max(rightMax[i+<span class="hljs-number">1</span>], height[i])<br>    &#125;<br><br>    res := <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">for</span> i, h := <span class="hljs-keyword">range</span> height &#123;<br>        res += min(leftMax[i], rightMax[i]) - h<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="124-äºŒå‰æ ‘ä¸­çš„æœ€å¤§è·¯å¾„å’Œ"><a href="#124-äºŒå‰æ ‘ä¸­çš„æœ€å¤§è·¯å¾„å’Œ" class="headerlink" title="124. äºŒå‰æ ‘ä¸­çš„æœ€å¤§è·¯å¾„å’Œ"></a><a href="https://leetcode.cn/problems/binary-tree-maximum-path-sum/">124. äºŒå‰æ ‘ä¸­çš„æœ€å¤§è·¯å¾„å’Œ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">maxPathSum</span><span class="hljs-params">(root *TreeNode)</span></span> <span class="hljs-type">int</span> &#123;<br>    maxSum := math.MinInt32<br>    <span class="hljs-keyword">var</span> maxGain <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(*TreeNode)</span></span> <span class="hljs-type">int</span><br>    maxGain = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(node *TreeNode)</span></span> <span class="hljs-type">int</span> &#123;<br>        <span class="hljs-keyword">if</span> node == <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>        &#125;<br><br>        leftGain := max(maxGain(node.Left), <span class="hljs-number">0</span>)<br>        rightGain := max(maxGain(node.Right), <span class="hljs-number">0</span>)<br><br>        <span class="hljs-comment">// å°†å·¦å­æ ‘è·¯å¾„-å½“å‰èŠ‚ç‚¹-å³å­æ ‘è·¯å¾„ è¿æ¥èµ·æ¥ç»„æˆæ–°çš„ä¸€æ¡è·¯å¾„</span><br>        <span class="hljs-comment">// è®¡ç®—è¿™æ¡è·¯å¾„çš„å’Œ</span><br>        newPathPrice := node.Val + leftGain + rightGain<br><br>        <span class="hljs-comment">// æ›´æ–°ç­”æ¡ˆ</span><br>        maxSum = max(maxSum, newPathPrice)<br><br>        <span class="hljs-comment">// è¿”å›èŠ‚ç‚¹çš„æœ€å¤§è´¡çŒ®å€¼ã€‚è·¯å¾„åªå‘ä¸€ä¸ªå­æ ‘ä¸Šå»¶ç”³</span><br>        <span class="hljs-keyword">return</span> node.Val + max(leftGain, rightGain)<br>    &#125;<br><br>    maxGain(root)<br><br>    <span class="hljs-keyword">return</span> maxSum<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="142-ç¯å½¢é“¾è¡¨-II"><a href="#142-ç¯å½¢é“¾è¡¨-II" class="headerlink" title="142. ç¯å½¢é“¾è¡¨ II"></a><a href="https://leetcode.cn/problems/linked-list-cycle-ii/">142. ç¯å½¢é“¾è¡¨ II</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">detectCycle</span><span class="hljs-params">(head *ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">if</span> head == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br><br>    seen := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[*ListNode]<span class="hljs-type">bool</span>)<br><br>    <span class="hljs-keyword">for</span> head != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">if</span> _, ok := seen[head]; ok &#123;<br>            <span class="hljs-keyword">return</span> head<br>        &#125;<br>        seen[head] = <span class="hljs-literal">true</span><br>        head = head.Next<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1143-æœ€é•¿å…¬å…±å­åºåˆ—"><a href="#1143-æœ€é•¿å…¬å…±å­åºåˆ—" class="headerlink" title="1143. æœ€é•¿å…¬å…±å­åºåˆ—"></a><a href="https://leetcode.cn/problems/longest-common-subsequence/">1143. æœ€é•¿å…¬å…±å­åºåˆ—</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">longestCommonSubsequence</span><span class="hljs-params">(text1 <span class="hljs-type">string</span>, text2 <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    m, n := <span class="hljs-built_in">len</span>(text1), <span class="hljs-built_in">len</span>(text2)<br>    <span class="hljs-comment">// dp[i][j]å«ä¹‰ï¼šä»¥text1[i-1]ç»“å°¾çš„å­—ç¬¦ä¸²ï¼Œå’Œä»¥text2[j-1]ç»“å°¾çš„å­—ç¬¦ä¸²ä¹‹é—´çš„æœ€é•¿å…¬å…±å­åºåˆ—é•¿åº¦</span><br>    dp := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">int</span>, m+<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> dp &#123;<br>        dp[i] = <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, n+<span class="hljs-number">1</span>)<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> i, c1 := <span class="hljs-keyword">range</span> text1 &#123;<br>        <span class="hljs-keyword">for</span> j, c2 := <span class="hljs-keyword">range</span> text2 &#123;<br>            <span class="hljs-keyword">if</span> c1 == c2 &#123;<br>                dp[i+<span class="hljs-number">1</span>][j+<span class="hljs-number">1</span>] = dp[i][j] + <span class="hljs-number">1</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                dp[i+<span class="hljs-number">1</span>][j+<span class="hljs-number">1</span>] = max(dp[i][j+<span class="hljs-number">1</span>], dp[i+<span class="hljs-number">1</span>][j])<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> dp[m][n]<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="93-å¤åŸ-IP-åœ°å€"><a href="#93-å¤åŸ-IP-åœ°å€" class="headerlink" title="93. å¤åŸ IP åœ°å€"></a><a href="https://leetcode.cn/problems/restore-ip-addresses/">93. å¤åŸ IP åœ°å€</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> SEG_COUNT = <span class="hljs-number">4</span><br><br><span class="hljs-keyword">var</span> (<br>    ans []<span class="hljs-type">string</span><br>    segments []<span class="hljs-type">int</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">restoreIpAddresses</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> []<span class="hljs-type">string</span> &#123;<br>    segments = <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, SEG_COUNT)<br>    ans = []<span class="hljs-type">string</span>&#123;&#125;<br>    dfs(s, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> ans<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">dfs</span><span class="hljs-params">(s <span class="hljs-type">string</span>, segId, segStart <span class="hljs-type">int</span>)</span></span> &#123;<br>    <span class="hljs-comment">// segIdä»0å¼€å§‹çš„ï¼Œç­‰äºSEG_COUNTè¯´æ˜å·²ç»æ‰¾åˆ°äº†4æ®µ</span><br>    <span class="hljs-comment">// segStartä»0å¼€å§‹çš„ï¼Œç­‰äºlen(s)è¯´æ˜å­—ç¬¦ä¸²å·²ç»éå†å®Œäº†</span><br>    <span class="hljs-keyword">if</span> segId == SEG_COUNT &#123;<br>        <span class="hljs-keyword">if</span> segStart == <span class="hljs-built_in">len</span>(s) &#123;<br>            <span class="hljs-comment">// å°†dfsè¿‡ç¨‹ä¸­ä¿å­˜çš„segmentsæ•°ç»„è½¬åŒ–æˆçœŸæ­£çš„ipå­—ç¬¦ä¸²</span><br>            ipAddr := <span class="hljs-string">&quot;&quot;</span><br>            <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; SEG_COUNT; i++ &#123;<br>                ipAddr += strconv.Itoa(segments[i])<br>                <span class="hljs-keyword">if</span> i != SEG_COUNT - <span class="hljs-number">1</span> &#123;<br>                    ipAddr += <span class="hljs-string">&quot;.&quot;</span><br>                &#125;<br>            &#125;<br>            <span class="hljs-comment">// å°†ipå­—ç¬¦ä¸²åŠ å…¥åˆ°ç»“æœé›†ä¸­</span><br>            ans = <span class="hljs-built_in">append</span>(ans, ipAddr)<br>        &#125;<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    <span class="hljs-comment">// å¦‚æœè¿˜æ²¡æœ‰æ‰¾åˆ°4æ®µï¼Œä½†å­—ç¬¦ä¸²å·²ç»éå†å®Œäº†ï¼Œè¯´æ˜æœ¬æ¬¡å°è¯•æ— åŠŸè€Œè¿”ï¼Œä»€ä¹ˆä¹Ÿä¸åšï¼Œç›´æ¥è¿”å›</span><br>    <span class="hljs-keyword">if</span> segStart == <span class="hljs-built_in">len</span>(s) &#123;<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    <span class="hljs-comment">// å¦‚æœå½“å‰æ®µï¼Œé‡åˆ°çš„ç¬¬ä¸€ä¸ªæ•°å­—å°±æ˜¯0ï¼Œé‚£ä¹ˆæœ¬æ®µä¹Ÿåªèƒ½ä¸º0ã€‚ä¿å­˜æœ¬æ®µçš„0ï¼Œç„¶åå¼€å¯å‘ä¸‹çš„æœç´¢</span><br>    <span class="hljs-keyword">if</span> s[segStart] == <span class="hljs-string">&#x27;0&#x27;</span> &#123;<br>        segments[segId] = <span class="hljs-number">0</span><br>        dfs(s, segId + <span class="hljs-number">1</span>, segStart + <span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    <span class="hljs-comment">// ä¸€èˆ¬æƒ…å†µï¼Œæšä¸¾æ¯ä¸€ç§å¯èƒ½æ€§ï¼Œå¹¶å‘ä¸‹é€’å½’</span><br>    addr := <span class="hljs-number">0</span> <span class="hljs-comment">// ç”¨æ¥ä¿å­˜æœ¬æ®µipåœ°å€æ•°å€¼</span><br>    <span class="hljs-comment">// ä»segStartå¼€å§‹å°è¯•ï¼Œiçš„æ€»ä½“é™åˆ¶æ˜¯å°äºlen(s)ï¼Œä½†åœ¨å‰æœŸéå†è¿‡ç¨‹ä¸­è¾¾ä¸åˆ°len(s) addrå°±è¶…è¿‡255äº†</span><br>    <span class="hljs-comment">// æ‰€ä»¥è¿™é‡Œçš„forå¾ªç¯å¹¶ä¸ä¸€å®šä¼šéå†åˆ°len(s)ï¼Œè¶…è¿‡255é€€å‡ºå³å¯ï¼Œæ‰€æœ‰å¯èƒ½çš„ç»“æœéƒ½ä¼šåœ¨dfsè¿‡ç¨‹ä¸­éå†åˆ°</span><br>    <span class="hljs-keyword">for</span> i := segStart; i &lt; <span class="hljs-built_in">len</span>(s); i++ &#123;<br>        addr = addr * <span class="hljs-number">10</span> + <span class="hljs-type">int</span>(s[i] - <span class="hljs-string">&#x27;0&#x27;</span>)<br>        <span class="hljs-comment">// å¦‚æœæœ¬è½®å¾ªç¯å¾—åˆ°çš„addræ•°å€¼ç¬¦åˆè¦æ±‚ï¼Œé‚£ä¹ˆå°±æ‰¾åˆ°äº†æœ¬æ®µçš„ä¸€ä¸ªè§£ï¼Œè®°å½•ä¹‹åå‘ä¸‹é€’å½’å¯»æ‰¾ä¹‹åå‡ æ®µçš„è§£</span><br>        <span class="hljs-keyword">if</span> addr &gt; <span class="hljs-number">0</span> &amp;&amp; addr &lt;= <span class="hljs-number">0xFF</span> &#123;<br>            segments[segId] = addr<br>            dfs(s, segId + <span class="hljs-number">1</span>, i + <span class="hljs-number">1</span>)<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">break</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="19-åˆ é™¤é“¾è¡¨çš„å€’æ•°ç¬¬-N-ä¸ªç»“ç‚¹"><a href="#19-åˆ é™¤é“¾è¡¨çš„å€’æ•°ç¬¬-N-ä¸ªç»“ç‚¹" class="headerlink" title="19. åˆ é™¤é“¾è¡¨çš„å€’æ•°ç¬¬ N ä¸ªç»“ç‚¹"></a><a href="https://leetcode.cn/problems/remove-nth-node-from-end-of-list/">19. åˆ é™¤é“¾è¡¨çš„å€’æ•°ç¬¬ N ä¸ªç»“ç‚¹</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// åŒæŒ‡é’ˆ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">removeNthFromEnd</span><span class="hljs-params">(head *ListNode, n <span class="hljs-type">int</span>)</span></span> *ListNode &#123;<br>    dummy := &amp;ListNode&#123;<span class="hljs-number">0</span>, head&#125;<br>    first, second := head, dummy<br>    <span class="hljs-comment">// firstå…ˆå¾€å‰èµ°næ­¥</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;<br>        first = first.Next<br>    &#125;<br>    <span class="hljs-comment">// firstå’ŒsecondåŒæ—¶å¾€å‰èµ°</span><br>    <span class="hljs-keyword">for</span> ; first != <span class="hljs-literal">nil</span>; first = first.Next &#123;<br>        second = second.Next<br>    &#125;<br>    second.Next = second.Next.Next<br>    <span class="hljs-keyword">return</span> dummy.Next<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="82-åˆ é™¤æ’åºé“¾è¡¨ä¸­çš„é‡å¤å…ƒç´ -II"><a href="#82-åˆ é™¤æ’åºé“¾è¡¨ä¸­çš„é‡å¤å…ƒç´ -II" class="headerlink" title="82. åˆ é™¤æ’åºé“¾è¡¨ä¸­çš„é‡å¤å…ƒç´  II"></a><a href="https://leetcode.cn/problems/remove-duplicates-from-sorted-list-ii/">82. åˆ é™¤æ’åºé“¾è¡¨ä¸­çš„é‡å¤å…ƒç´  II</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">deleteDuplicates</span><span class="hljs-params">(head *ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">if</span> head == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br>    dummy := &amp;ListNode&#123;<span class="hljs-number">0</span>, head&#125;<br><br>    cur := dummy<br>    <span class="hljs-comment">// æ¯æ¬¡éƒ½æ˜¯å¯¹æ¯”å½“å‰èŠ‚ç‚¹çš„åä¸¤ä¸ªèŠ‚ç‚¹</span><br>    <span class="hljs-keyword">for</span> cur.Next != <span class="hljs-literal">nil</span> &amp;&amp; cur.Next.Next != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-comment">// å¦‚æœåä¸¤ä¸ªèŠ‚ç‚¹ç›¸ç­‰</span><br>        <span class="hljs-keyword">if</span> cur.Next.Val == cur.Next.Next.Val &#123;<br>            <span class="hljs-comment">// è®°å½•ç›¸ç­‰èŠ‚ç‚¹çš„å€¼</span><br>            x := cur.Next.Val<br>            <span class="hljs-comment">// ä¸åœçš„è·³è¿‡å€¼ä¸ºxçš„èŠ‚ç‚¹ï¼Œæ³¨æ„è¿™é‡Œcuræ˜¯ä¸€ç›´æ²¡å˜çš„ï¼Œå˜åŒ–çš„æ˜¯curçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œ</span><br>            <span class="hljs-comment">// ä¹Ÿå°±æ˜¯è¯´å¦‚æœcurçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å€¼ä¸ºxï¼Œé‚£ä¹ˆå®ƒå°±ä¼šè¢«è·³è¿‡</span><br>            <span class="hljs-keyword">for</span> cur.Next != <span class="hljs-literal">nil</span> &amp;&amp; cur.Next.Val == x &#123;<br>                cur.Next = cur.Next.Next<br>            &#125;<br>        <span class="hljs-comment">// åä¸¤ä¸ªèŠ‚ç‚¹ä¸ç›¸ç­‰çš„æƒ…å†µä¸‹ï¼Œcuræ‰å¾€åç§»åŠ¨ä¸€ä½</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            cur = cur.Next<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> dummy.Next<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="199-äºŒå‰æ ‘çš„å³è§†å›¾"><a href="#199-äºŒå‰æ ‘çš„å³è§†å›¾" class="headerlink" title="199. äºŒå‰æ ‘çš„å³è§†å›¾"></a><a href="https://leetcode.cn/problems/binary-tree-right-side-view/">199. äºŒå‰æ ‘çš„å³è§†å›¾</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-comment">// å±‚åºéå†ï¼Œå³å­æ ‘å…ˆå…¥é˜Ÿï¼Œæ¯å±‚ä¿ç•™æœ€å³ä¾§èŠ‚ç‚¹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">rightSideView</span><span class="hljs-params">(root *TreeNode)</span></span> []<span class="hljs-type">int</span> &#123;<br>    res := []<span class="hljs-type">int</span>&#123;&#125;<br><br>    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> res<br>    &#125;<br><br>    q := []*TreeNode&#123;root&#125;<br>    <span class="hljs-keyword">for</span> <span class="hljs-built_in">len</span>(q) &gt; <span class="hljs-number">0</span> &#123;<br>        p := []*TreeNode&#123;&#125;<br>        res = <span class="hljs-built_in">append</span>(res, q[<span class="hljs-number">0</span>].Val)<br>        <span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; <span class="hljs-built_in">len</span>(q); j++ &#123;<br>            node := q[j]<br>            <span class="hljs-keyword">if</span> node.Right != <span class="hljs-literal">nil</span> &#123;<br>                p = <span class="hljs-built_in">append</span>(p, node.Right)<br>            &#125;<br>            <span class="hljs-keyword">if</span> node.Left != <span class="hljs-literal">nil</span> &#123;<br>                p = <span class="hljs-built_in">append</span>(p, node.Left)<br>            &#125;<br>        &#125;<br>        q = p<br>    &#125;<br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="94-äºŒå‰æ ‘çš„ä¸­åºéå†"><a href="#94-äºŒå‰æ ‘çš„ä¸­åºéå†" class="headerlink" title="94. äºŒå‰æ ‘çš„ä¸­åºéå†"></a><a href="https://leetcode.cn/problems/binary-tree-inorder-traversal/">94. äºŒå‰æ ‘çš„ä¸­åºéå†</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">inorderTraversal</span><span class="hljs-params">(root *TreeNode)</span></span> []<span class="hljs-type">int</span> &#123;<br>    res := []<span class="hljs-type">int</span>&#123;&#125;<br><br>    <span class="hljs-keyword">var</span> inorder <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(node *TreeNode)</span></span><br>    inorder = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(node * TreeNode)</span></span> &#123;<br>        <span class="hljs-keyword">if</span> node == <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        inorder(node.Left)<br>        res = <span class="hljs-built_in">append</span>(res, node.Val)<br>        inorder(node.Right)<br>    &#125;<br><br>    inorder(root)<br><br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="704-äºŒåˆ†æŸ¥æ‰¾"><a href="#704-äºŒåˆ†æŸ¥æ‰¾" class="headerlink" title="704. äºŒåˆ†æŸ¥æ‰¾"></a><a href="https://leetcode.cn/problems/binary-search/">704. äºŒåˆ†æŸ¥æ‰¾</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">search</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>, target <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(nums) == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br>    &#125;<br>    l := <span class="hljs-number">0</span><br>    r := <span class="hljs-built_in">len</span>(nums) - <span class="hljs-number">1</span><br>    <span class="hljs-keyword">for</span> l &lt;= r &#123;<br>        mid := (l + r) / <span class="hljs-number">2</span><br>        <span class="hljs-keyword">if</span> nums[mid] == target &#123;<br>            <span class="hljs-keyword">return</span> mid<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> nums[mid] &lt; target &#123;<br>            l = mid + <span class="hljs-number">1</span><br>        &#125;<br>        <span class="hljs-keyword">if</span> nums[mid] &gt; target &#123;<br>            r = mid - <span class="hljs-number">1</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="232-ç”¨æ ˆå®ç°é˜Ÿåˆ—"><a href="#232-ç”¨æ ˆå®ç°é˜Ÿåˆ—" class="headerlink" title="232. ç”¨æ ˆå®ç°é˜Ÿåˆ—"></a><a href="https://leetcode.cn/problems/implement-queue-using-stacks/">232. ç”¨æ ˆå®ç°é˜Ÿåˆ—</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> MyQueue <span class="hljs-keyword">struct</span> &#123;<br>    inStack, outStack []<span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Constructor</span><span class="hljs-params">()</span></span> MyQueue &#123;<br>    <span class="hljs-keyword">return</span> MyQueue&#123;&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *MyQueue)</span></span> Push(x <span class="hljs-type">int</span>) &#123;<br>    q.inStack = <span class="hljs-built_in">append</span>(q.inStack, x)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *MyQueue)</span></span> in2out() &#123;<br>    <span class="hljs-keyword">for</span> <span class="hljs-built_in">len</span>(q.inStack) &gt; <span class="hljs-number">0</span> &#123;<br>        q.outStack = <span class="hljs-built_in">append</span>(q.outStack, q.inStack[<span class="hljs-built_in">len</span>(q.inStack)<span class="hljs-number">-1</span>])<br>        q.inStack = q.inStack[:<span class="hljs-built_in">len</span>(q.inStack)<span class="hljs-number">-1</span>]<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *MyQueue)</span></span> Pop() <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(q.outStack) == <span class="hljs-number">0</span> &#123;<br>        q.in2out()<br>    &#125;<br>    x := q.outStack[<span class="hljs-built_in">len</span>(q.outStack)<span class="hljs-number">-1</span>]<br>    q.outStack = q.outStack[:<span class="hljs-built_in">len</span>(q.outStack)<span class="hljs-number">-1</span>]<br>    <span class="hljs-keyword">return</span> x<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *MyQueue)</span></span> Peek() <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(q.outStack) == <span class="hljs-number">0</span> &#123;<br>        q.in2out()<br>    &#125;<br>    <span class="hljs-keyword">return</span> q.outStack[<span class="hljs-built_in">len</span>(q.outStack)<span class="hljs-number">-1</span>]<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *MyQueue)</span></span> Empty() <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(q.inStack) == <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-built_in">len</span>(q.outStack) == <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="148-æ’åºé“¾è¡¨"><a href="#148-æ’åºé“¾è¡¨" class="headerlink" title="148. æ’åºé“¾è¡¨"></a><a href="https://leetcode.cn/problems/sort-list/">148. æ’åºé“¾è¡¨</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// å½’å¹¶æ’åºä¸¤ä¸ªæœ‰åºé“¾è¡¨</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">merge</span><span class="hljs-params">(head1, head2 *ListNode)</span></span> *ListNode &#123;<br>    dummy := &amp;ListNode&#123;&#125;<br>    p, p1, p2 := dummy, head1, head2<br>    <span class="hljs-keyword">for</span> p1 != <span class="hljs-literal">nil</span> &amp;&amp; p2 != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">if</span> p1.Val &lt; p2.Val &#123;<br>            p.Next = p1<br>            p1 = p1.Next<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            p.Next = p2<br>            p2 = p2.Next<br>        &#125;<br>        p = p.Next<br>    &#125;<br>    <span class="hljs-keyword">if</span> p1 != <span class="hljs-literal">nil</span> &#123;<br>        p.Next = p1<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> p2 != <span class="hljs-literal">nil</span> &#123;<br>        p.Next = p2<br>    &#125;<br>    <span class="hljs-keyword">return</span> dummy.Next<br>&#125;<br><br><span class="hljs-comment">// æ‹†åˆ†ä¸€ä¸ªé“¾è¡¨ï¼Œåˆ†åˆ«é€’å½’æ’åºï¼Œå°†æ’å¥½åºçš„ä¸¤ä¸ªé“¾è¡¨åˆå¹¶</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sort</span><span class="hljs-params">(head, tail *ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">if</span> head == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> head<br>    &#125;<br>    <br>    <span class="hljs-comment">// ä¸¢å¼ƒå°¾éƒ¨èŠ‚ç‚¹ï¼Œé¿å…é‡å¤</span><br>    <span class="hljs-keyword">if</span> head.Next == tail &#123;<br>        head.Next = <span class="hljs-literal">nil</span><br>        <span class="hljs-keyword">return</span> head<br>    &#125;<br><br>    slow, fast := head, head<br>    <span class="hljs-keyword">for</span> fast != tail &#123;<br>        slow = slow.Next<br>        fast = fast.Next<br>        <span class="hljs-keyword">if</span> fast != tail &#123;<br>            fast = fast.Next<br>        &#125;<br>    &#125;<br><br>    mid := slow<br>    <span class="hljs-comment">// è¿™é‡Œå°†midåˆ†åˆ«ä½œä¸ºå¤´å’Œå°¾é€’å½’ä¼ é€’ï¼Œä½†ä½œä¸ºå°¾éƒ¨çš„midæœ€ç»ˆä¼šè¢«ä¸¢å¼ƒï¼Œä¸ä¼šå‡ºç°midèŠ‚ç‚¹é‡å¤çš„é—®é¢˜</span><br>    <span class="hljs-keyword">return</span> merge(sort(head, mid), sort(mid, tail))<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sortList</span><span class="hljs-params">(head *ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">return</span> sort(head, <span class="hljs-literal">nil</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="22-æ‹¬å·ç”Ÿæˆ"><a href="#22-æ‹¬å·ç”Ÿæˆ" class="headerlink" title="22. æ‹¬å·ç”Ÿæˆ"></a><a href="https://leetcode.cn/problems/generate-parentheses/">22. æ‹¬å·ç”Ÿæˆ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">generateParenthesis</span><span class="hljs-params">(n <span class="hljs-type">int</span>)</span></span> []<span class="hljs-type">string</span> &#123;<br>    <span class="hljs-comment">// ç”¨äºä¿å­˜ç»“æœé›†</span><br>    res := []<span class="hljs-type">string</span>&#123;&#125;<br>    <span class="hljs-comment">// ç”¨äºä¿å­˜æ¯ä¸€æ­¥çš„ç»“æœ</span><br>    tmp := []<span class="hljs-type">string</span>&#123;&#125;<br>    <span class="hljs-comment">// å›æº¯æ³•ï¼Œæ¯ä¸ªä½ç½®ä¸Šè¦ä¹ˆæ”¾å·¦æ‹¬å·ï¼Œè¦ä¹ˆæ”¾å³æ‹¬å·</span><br>    <span class="hljs-comment">// æ”¾çš„æ—¶å€™æ ¡éªŒä¸‹åˆä¸åˆæ³•</span><br>    <span class="hljs-keyword">var</span> backtrack <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(leftCount, rightCount <span class="hljs-type">int</span>)</span></span><br>    backtrack = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(leftCount, rightCount <span class="hljs-type">int</span>)</span></span> &#123;<br>        <span class="hljs-comment">// é•¿åº¦è¾¾åˆ°2nï¼Œæ‰¾åˆ°ä¸€ä¸ªç­”æ¡ˆï¼ŒåŠ å…¥ç»“æœé›†</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(tmp) == <span class="hljs-number">2</span>*n &#123;<br>            res = <span class="hljs-built_in">append</span>(res, strings.Join(tmp, <span class="hljs-string">&quot;&quot;</span>))<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-comment">// åªè¦å·¦æ‹¬å·æ•°é‡å°äºnï¼Œå½“å‰ä½ç½®æ”¾å·¦æ‹¬å·å°±æ˜¯åˆæ³•çš„</span><br>        <span class="hljs-keyword">if</span> leftCount &lt; n &#123;<br>            tmp = <span class="hljs-built_in">append</span>(tmp, <span class="hljs-string">&quot;(&quot;</span>)<br>            backtrack(leftCount+<span class="hljs-number">1</span>, rightCount)<br>            tmp = tmp[:<span class="hljs-built_in">len</span>(tmp)<span class="hljs-number">-1</span>]<br>        &#125;<br>        <span class="hljs-comment">// åªè¦å³æ‹¬å·æ•°é‡å°äºå·¦æ‹¬å·ï¼Œå½“å‰ä½ç½®æ”¾å³æ‹¬å·å°±æ˜¯åˆæ³•çš„</span><br>        <span class="hljs-keyword">if</span> rightCount &lt; leftCount &#123;<br>            tmp = <span class="hljs-built_in">append</span>(tmp, <span class="hljs-string">&quot;)&quot;</span>)<br>            backtrack(leftCount, rightCount+<span class="hljs-number">1</span>)<br>            tmp = tmp[:<span class="hljs-built_in">len</span>(tmp)<span class="hljs-number">-1</span>]<br>        &#125;<br>    &#125;<br><br>    backtrack(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="31-ä¸‹ä¸€ä¸ªæ’åˆ—"><a href="#31-ä¸‹ä¸€ä¸ªæ’åˆ—" class="headerlink" title="31. ä¸‹ä¸€ä¸ªæ’åˆ—"></a><a href="https://leetcode.cn/problems/next-permutation/">31. ä¸‹ä¸€ä¸ªæ’åˆ—</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å”‰ï¼ŒèƒŒè¯µé¢˜ï¼ŒåŸç†çœ‹é¢˜è§£å§</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">nextPermutation</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span>  &#123;<br>    n := <span class="hljs-built_in">len</span>(nums)<br>    i := n - <span class="hljs-number">2</span><br>    <span class="hljs-keyword">for</span> i &gt;= <span class="hljs-number">0</span> &amp;&amp; nums[i] &gt;= nums[i+<span class="hljs-number">1</span>] &#123;<br>        i--<br>    &#125;<br>    <span class="hljs-keyword">if</span> i &gt;= <span class="hljs-number">0</span> &#123;<br>        j := n - <span class="hljs-number">1</span><br>        <span class="hljs-keyword">for</span> j &gt;= <span class="hljs-number">0</span> &amp;&amp; nums[i] &gt;= nums[j] &#123;<br>            j--<br>        &#125;<br>        nums[i], nums[j] = nums[j], nums[i]<br>    &#125;<br>    reverse(nums[i+<span class="hljs-number">1</span>:])<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reverse</span><span class="hljs-params">(a []<span class="hljs-type">int</span>)</span></span> &#123;<br>    <span class="hljs-keyword">for</span> i, n := <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(a); i &lt; n/<span class="hljs-number">2</span>; i++ &#123;<br>        a[i], a[n<span class="hljs-number">-1</span>-i] = a[n<span class="hljs-number">-1</span>-i], a[i]<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="165-æ¯”è¾ƒç‰ˆæœ¬å·"><a href="#165-æ¯”è¾ƒç‰ˆæœ¬å·" class="headerlink" title="165. æ¯”è¾ƒç‰ˆæœ¬å·"></a><a href="https://leetcode.cn/problems/compare-version-numbers/">165. æ¯”è¾ƒç‰ˆæœ¬å·</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">compareVersion</span><span class="hljs-params">(version1 <span class="hljs-type">string</span>, version2 <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    v1 := strings.Split(version1, <span class="hljs-string">&quot;.&quot;</span>)<br>    v2 := strings.Split(version2, <span class="hljs-string">&quot;.&quot;</span>)<br><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(v1) || i &lt; <span class="hljs-built_in">len</span>(v2); i++ &#123;<br>        x, y := <span class="hljs-number">0</span>, <span class="hljs-number">0</span><br>        <span class="hljs-keyword">if</span> i &lt; <span class="hljs-built_in">len</span>(v1) &#123;<br>            x, _ = strconv.Atoi(v1[i])<br>        &#125;<br>        <span class="hljs-keyword">if</span> i &lt; <span class="hljs-built_in">len</span>(v2) &#123;<br>            y, _ = strconv.Atoi(v2[i])<br>        &#125;<br>        <span class="hljs-keyword">if</span> x &gt; y &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>        &#125;<br>        <span class="hljs-keyword">if</span> x &lt; y &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="69-x-çš„å¹³æ–¹æ ¹"><a href="#69-x-çš„å¹³æ–¹æ ¹" class="headerlink" title="69. x çš„å¹³æ–¹æ ¹ "></a><a href="https://leetcode.cn/problems/sqrtx/">69. x çš„å¹³æ–¹æ ¹ </a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mySqrt</span><span class="hljs-params">(x <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    l, r := <span class="hljs-number">0</span>, x<br>    ans := <span class="hljs-number">-1</span><br>    <span class="hljs-keyword">for</span> l &lt;= r &#123;<br>        mid := (l + r) / <span class="hljs-number">2</span><br>        <span class="hljs-keyword">if</span> mid * mid &lt;= x &#123;<br>            ans = mid<br>            l = mid + <span class="hljs-number">1</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            r = mid - <span class="hljs-number">1</span><br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> ans<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="8-å­—ç¬¦ä¸²è½¬æ¢æ•´æ•°-atoi"><a href="#8-å­—ç¬¦ä¸²è½¬æ¢æ•´æ•°-atoi" class="headerlink" title="8. å­—ç¬¦ä¸²è½¬æ¢æ•´æ•° (atoi)"></a><a href="https://leetcode.cn/problems/string-to-integer-atoi/">8. å­—ç¬¦ä¸²è½¬æ¢æ•´æ•° (atoi)</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;math&quot;</span><br><span class="hljs-string">&quot;strings&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">myAtoi</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">int</span> &#123;<br><span class="hljs-comment">// å»é™¤å‰å¯¼ç©ºæ ¼</span><br>s = strings.TrimLeft(s, <span class="hljs-string">&quot; &quot;</span>)<br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(s) == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>&#125;<br><br><span class="hljs-comment">// å¤„ç†ç¬¦å·</span><br>sign := <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> s[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;-&#x27;</span> &#123;<br>sign = <span class="hljs-number">-1</span><br>s = s[<span class="hljs-number">1</span>:]<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> s[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;+&#x27;</span> &#123;<br>s = s[<span class="hljs-number">1</span>:]<br>&#125;<br><br><span class="hljs-keyword">var</span> result <span class="hljs-type">int64</span> = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> _, ch := <span class="hljs-keyword">range</span> s &#123;<br><span class="hljs-comment">// é‡åˆ°éæ•°å­—å­—ç¬¦åˆ™åœæ­¢</span><br><span class="hljs-keyword">if</span> ch &lt; <span class="hljs-string">&#x27;0&#x27;</span> || ch &gt; <span class="hljs-string">&#x27;9&#x27;</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br><br>digit := <span class="hljs-type">int64</span>(ch - <span class="hljs-string">&#x27;0&#x27;</span>)<br>result = result*<span class="hljs-number">10</span> + digit<br><br><span class="hljs-comment">// æ£€æŸ¥æº¢å‡º</span><br><span class="hljs-keyword">if</span> sign == <span class="hljs-number">1</span> &amp;&amp; result &gt; math.MaxInt32 &#123;<br><span class="hljs-keyword">return</span> math.MaxInt32<br>&#125;<br><span class="hljs-keyword">if</span> sign == <span class="hljs-number">-1</span> &amp;&amp; -result &lt; math.MinInt32 &#123;<br><span class="hljs-keyword">return</span> math.MinInt32<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// åº”ç”¨ç¬¦å·</span><br>final := <span class="hljs-type">int64</span>(sign) * result<br><br><span class="hljs-comment">// ç¡®ä¿ç»“æœåœ¨32ä½æ•´æ•°èŒƒå›´å†…</span><br><span class="hljs-keyword">if</span> final &gt; math.MaxInt32 &#123;<br><span class="hljs-keyword">return</span> math.MaxInt32<br>&#125;<br><span class="hljs-keyword">if</span> final &lt; math.MinInt32 &#123;<br><span class="hljs-keyword">return</span> math.MinInt32<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-type">int</span>(final)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-ä¸¤æ•°ç›¸åŠ "><a href="#2-ä¸¤æ•°ç›¸åŠ " class="headerlink" title="2. ä¸¤æ•°ç›¸åŠ "></a><a href="https://leetcode.cn/problems/add-two-numbers/">2. ä¸¤æ•°ç›¸åŠ </a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">addTwoNumbers</span><span class="hljs-params">(l1 *ListNode, l2 *ListNode)</span></span> *ListNode &#123;<br>    dummy := &amp;ListNode&#123;&#125;<br>    p := dummy<br>    digit := <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> l1 != <span class="hljs-literal">nil</span> || l2 != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">var</span> v1, v2 <span class="hljs-type">int</span><br>        <span class="hljs-keyword">if</span> l1 != <span class="hljs-literal">nil</span> &#123;<br>            v1 = l1.Val<br>            l1 = l1.Next<br>        &#125;<br>        <span class="hljs-keyword">if</span> l2 != <span class="hljs-literal">nil</span> &#123;<br>            v2 = l2.Val<br>            l2 = l2.Next<br>        &#125;<br><br>        sum := v1 + v2 + digit<br>        <br>        val := sum % <span class="hljs-number">10</span><br><br>        node := &amp;ListNode&#123;Val: val&#125;<br>        p.Next = node<br>        p = p.Next<br><br>        digit = sum / <span class="hljs-number">10</span><br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> digit != <span class="hljs-number">0</span> &#123;<br>        p.Next = &amp;ListNode&#123;Val: digit&#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> dummy.Next<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="32-æœ€é•¿æœ‰æ•ˆæ‹¬å·"><a href="#32-æœ€é•¿æœ‰æ•ˆæ‹¬å·" class="headerlink" title="32. æœ€é•¿æœ‰æ•ˆæ‹¬å·"></a><a href="https://leetcode.cn/problems/longest-valid-parentheses/">32. æœ€é•¿æœ‰æ•ˆæ‹¬å·</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">longestValidParentheses</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-comment">// ç”¨äºä¿å­˜æœ€ç»ˆç»“æœ</span><br>    res := <span class="hljs-number">0</span><br>    <br>    stack := []<span class="hljs-type">int</span>&#123;&#125;<br>    <span class="hljs-comment">// ä¸ºäº†åˆå§‹æ—¶æ–¹ä¾¿ï¼Œæå‰å‹å…¥-1</span><br>    stack = <span class="hljs-built_in">append</span>(stack, <span class="hljs-number">-1</span>)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(s); i++ &#123;<br>        <span class="hljs-comment">// å¦‚æœæ˜¯å·¦æ‹¬å·ï¼Œå°±å‹å…¥æ ˆä¸­</span><br>        <span class="hljs-keyword">if</span> s[i] == <span class="hljs-string">&#x27;(&#x27;</span> &#123;<br>            stack = <span class="hljs-built_in">append</span>(stack, i)<br>        <span class="hljs-comment">// å¦‚æœæ˜¯å³æ‹¬å·ï¼Œå°±å°†æ ˆé¡¶å…ƒç´ å‡ºæ ˆï¼ˆé™¤äº†æ ˆåº•å…ƒç´ ï¼Œæ ˆä¸­è‚¯å®šå…¨éƒ¨éƒ½æ˜¯å·¦æ‹¬å·ã€‚æ ˆåº•å…ƒç´ æ˜¯éå†è¿‡çš„æœ€åçš„æ²¡æœ‰è¢«åŒ¹é…çš„å³æ‹¬å·ï¼‰</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            stack = stack[:<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>]<br>            <span class="hljs-comment">// å¦‚æœå‡ºæ ˆåæ ˆç©ºäº†ï¼Œå°±è¯´æ˜æ ˆåº•çš„å³æ‹¬å·è¢«å‡ºæ ˆäº†ï¼Œé‚£ä¹ˆå½“å‰çš„å³æ‹¬å·å°±æˆäº†æ–°çš„ä¸èƒ½è¢«åŒ¹é…çš„å³æ‹¬å·ï¼Œå‹å…¥æ ˆä¸­æˆä¸ºæ–°çš„æ ˆåº•</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(stack) == <span class="hljs-number">0</span> &#123;<br>                stack = <span class="hljs-built_in">append</span>(stack, i)<br>            <span class="hljs-comment">// å®æ—¶æ›´æ–°æœ€é•¿çš„åŒ¹é…é•¿åº¦</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                res = max(res, i - stack[<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>])<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="70-çˆ¬æ¥¼æ¢¯"><a href="#70-çˆ¬æ¥¼æ¢¯" class="headerlink" title="70. çˆ¬æ¥¼æ¢¯"></a><a href="https://leetcode.cn/problems/climbing-stairs/">70. çˆ¬æ¥¼æ¢¯</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">climbStairs</span><span class="hljs-params">(n <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> n == <span class="hljs-number">1</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> n == <span class="hljs-number">2</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span><br>    &#125;<br>    dp := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, n+<span class="hljs-number">1</span>)<br>    dp[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span><br>    dp[<span class="hljs-number">2</span>] = <span class="hljs-number">2</span><br><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">3</span>; i &lt; n + <span class="hljs-number">1</span>; i++ &#123;<br>        dp[i] = dp[i<span class="hljs-number">-1</span>] + dp[i<span class="hljs-number">-2</span>]<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> dp[n]<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="105-ä»å‰åºä¸ä¸­åºéå†åºåˆ—æ„é€ äºŒå‰æ ‘"><a href="#105-ä»å‰åºä¸ä¸­åºéå†åºåˆ—æ„é€ äºŒå‰æ ‘" class="headerlink" title="105. ä»å‰åºä¸ä¸­åºéå†åºåˆ—æ„é€ äºŒå‰æ ‘"></a><a href="https://leetcode.cn/problems/construct-binary-tree-from-preorder-and-inorder-traversal/">105. ä»å‰åºä¸ä¸­åºéå†åºåˆ—æ„é€ äºŒå‰æ ‘</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">buildTree</span><span class="hljs-params">(preorder []<span class="hljs-type">int</span>, inorder []<span class="hljs-type">int</span>)</span></span> *TreeNode &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(preorder) == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br><br>    root := &amp;TreeNode&#123;preorder[<span class="hljs-number">0</span>], <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>&#125;<br><br>    <span class="hljs-comment">// æ‰¾åˆ°ä¸­åºéå†ä¸­çš„æ ¹èŠ‚ç‚¹</span><br>    i := <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> ; i &lt; <span class="hljs-built_in">len</span>(inorder); i++ &#123;<br>        <span class="hljs-keyword">if</span> inorder[i] == preorder[<span class="hljs-number">0</span>] &#123;<br>            <span class="hljs-keyword">break</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// ä¸­åºéå†æ ¹èŠ‚ç‚¹å·¦è¾¹çš„èŠ‚ç‚¹ä¸ºå·¦å­æ ‘ï¼Œå³è¾¹çš„èŠ‚ç‚¹ä¸ºå³å­æ ‘</span><br>    root.Left = buildTree(preorder[<span class="hljs-number">1</span>:<span class="hljs-built_in">len</span>(inorder[:i])+<span class="hljs-number">1</span>], inorder[:i])<br>    root.Right = buildTree(preorder[<span class="hljs-built_in">len</span>(inorder[:i])+<span class="hljs-number">1</span>:], inorder[i+<span class="hljs-number">1</span>:])<br><br>    <span class="hljs-keyword">return</span> root<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="78-å­é›†"><a href="#78-å­é›†" class="headerlink" title="78. å­é›†"></a><a href="https://leetcode.cn/problems/subsets/">78. å­é›†</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">subsets</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> [][]<span class="hljs-type">int</span> &#123;<br>    res := [][]<span class="hljs-type">int</span>&#123;&#125;<br>    set := []<span class="hljs-type">int</span>&#123;&#125;<br><br>    <span class="hljs-keyword">var</span> dfs <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span></span><br>    dfs = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(cur <span class="hljs-type">int</span>)</span></span> &#123;<br>        <span class="hljs-comment">// å¦‚æœé•¿åº¦å·²ç»è¶…è¿‡äº†numsé•¿åº¦ï¼Œè¯´æ˜å·²ç»å¾—åˆ°äº†ä¸€ä¸ªç»“æœ</span><br>        <span class="hljs-keyword">if</span> cur == <span class="hljs-built_in">len</span>(nums) &#123;<br>            <span class="hljs-comment">// è¿™é‡Œè¦æ³¨æ„ï¼Œä¸è¦æŠŠsetç›´æ¥appendåˆ°ç»“æœé›†ä¸­ï¼Œå› ä¸ºåé¢è¿˜è¦å¯¹setè¿›è¡Œä¿®æ”¹ï¼Œå¼•ç”¨ä¼ é€’ï¼Œä¼šå—å½±å“</span><br>            <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°ç»„ï¼ŒåŠ å…¥ç»“æœé›†ä¸­</span><br>            res = <span class="hljs-built_in">append</span>(res, <span class="hljs-built_in">append</span>([]<span class="hljs-type">int</span>&#123;&#125;, set...))<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-comment">// é€‰æ‹©å½“å‰å…ƒç´ </span><br>        set = <span class="hljs-built_in">append</span>(set, nums[cur])<br>        dfs(cur+<span class="hljs-number">1</span>)<br><br>        <span class="hljs-comment">// ä¸é€‰æ‹©å½“å‰å…ƒç´ </span><br>        set = set[:<span class="hljs-built_in">len</span>(set)<span class="hljs-number">-1</span>]<br>        dfs(cur+<span class="hljs-number">1</span>)<br>    &#125;<br><br>    dfs(<span class="hljs-number">0</span>)<br>    <br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="151-åè½¬å­—ç¬¦ä¸²ä¸­çš„å•è¯"><a href="#151-åè½¬å­—ç¬¦ä¸²ä¸­çš„å•è¯" class="headerlink" title="151. åè½¬å­—ç¬¦ä¸²ä¸­çš„å•è¯"></a><a href="https://leetcode.cn/problems/reverse-words-in-a-string/">151. åè½¬å­—ç¬¦ä¸²ä¸­çš„å•è¯</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reverseWords</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>    <span class="hljs-comment">// å»é™¤ä¸¤ç«¯ç©ºæ ¼</span><br>    s = strings.Trim(s, <span class="hljs-string">&quot; &quot;</span>)<br><br>    <span class="hljs-comment">// åŒæŒ‡é’ˆ</span><br>    i := <span class="hljs-built_in">len</span>(s) - <span class="hljs-number">1</span><br>    j := <span class="hljs-built_in">len</span>(s) - <span class="hljs-number">1</span><br>    res := []<span class="hljs-type">string</span>&#123;&#125;<br><br>    <span class="hljs-comment">// ä»åå‘å‰éå†</span><br>    <span class="hljs-keyword">for</span> i &gt;= <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-comment">// æœç´¢é¦–ä¸ªç©ºæ ¼</span><br>        <span class="hljs-keyword">for</span> i &gt;= <span class="hljs-number">0</span> &amp;&amp; s[i] != <span class="hljs-string">&#x27; &#x27;</span> &#123;<br>            i -= <span class="hljs-number">1</span><br>        &#125;<br>        <span class="hljs-comment">// è®°å½•å•è¯</span><br>        res = <span class="hljs-built_in">append</span>(res, s[i+<span class="hljs-number">1</span>:j+<span class="hljs-number">1</span>])<br>        <span class="hljs-comment">// è·³è¿‡å•è¯é—´ç©ºæ ¼</span><br>        <span class="hljs-keyword">for</span> i &gt;= <span class="hljs-number">0</span> &amp;&amp; s[i] == <span class="hljs-string">&#x27; &#x27;</span> &#123;<br>            i -= <span class="hljs-number">1</span><br>        &#125;<br>        <span class="hljs-comment">// jæŒ‡å‘ä¸‹ä¸ªå•è¯çš„å°¾å­—ç¬¦</span><br>        j = i<br>    &#125;<br><br>    <span class="hljs-comment">// æ‹¼æ¥è¿”å›</span><br>    <span class="hljs-keyword">return</span> strings.Join(res, <span class="hljs-string">&quot; &quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="155-æœ€å°æ ˆ"><a href="#155-æœ€å°æ ˆ" class="headerlink" title="155. æœ€å°æ ˆ"></a><a href="https://leetcode.cn/problems/min-stack/">155. æœ€å°æ ˆ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// æ€è·¯ï¼šä½¿ç”¨ä¸€ä¸ªè¾…åŠ©æ ˆï¼Œæ¯æ¬¡å‹æ ˆæ—¶åŒæ­¥å¾€è¾…åŠ©æ ˆä¸­å‹å…¥å½“å‰æœ€å°å€¼ï¼Œå‡ºæ ˆæ—¶ä¹Ÿæ˜¯åŒæ­¥å‡ºæ ˆã€‚</span><br><span class="hljs-keyword">type</span> MinStack <span class="hljs-keyword">struct</span> &#123;<br>    stack []<span class="hljs-type">int</span><br>    minStack []<span class="hljs-type">int</span><br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Constructor</span><span class="hljs-params">()</span></span> MinStack &#123;<br>    <span class="hljs-keyword">return</span> MinStack&#123;<br>        stack: []<span class="hljs-type">int</span>&#123;&#125;,<br>        minStack: []<span class="hljs-type">int</span>&#123;math.MaxInt64&#125;,<br>    &#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *MinStack)</span></span> Push(val <span class="hljs-type">int</span>)  &#123;<br>    this.stack = <span class="hljs-built_in">append</span>(this.stack, val)<br>    top := this.minStack[<span class="hljs-built_in">len</span>(this.minStack)<span class="hljs-number">-1</span>]<br>    this.minStack = <span class="hljs-built_in">append</span>(this.minStack, min(val, top))<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *MinStack)</span></span> Pop()  &#123;<br>    this.stack = this.stack[:<span class="hljs-built_in">len</span>(this.stack)<span class="hljs-number">-1</span>]<br>    this.minStack = this.minStack[:<span class="hljs-built_in">len</span>(this.minStack)<span class="hljs-number">-1</span>]<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *MinStack)</span></span> Top() <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">return</span> this.stack[<span class="hljs-built_in">len</span>(this.stack)<span class="hljs-number">-1</span>]<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *MinStack)</span></span> GetMin() <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">return</span> this.minStack[<span class="hljs-built_in">len</span>(this.minStack)<span class="hljs-number">-1</span>]<br>&#125;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Your MinStack object will be instantiated and called as such:</span><br><span class="hljs-comment"> * obj := Constructor();</span><br><span class="hljs-comment"> * obj.Push(val);</span><br><span class="hljs-comment"> * obj.Pop();</span><br><span class="hljs-comment"> * param_3 := obj.Top();</span><br><span class="hljs-comment"> * param_4 := obj.GetMin();</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ä½¿ç”¨å•ä¸ªæ ˆçš„è§£æ³•ï¼Œé€šè¿‡å‘æ ˆä¸­å‹å…¥å·®å€¼å®ç°</span><br><span class="hljs-keyword">type</span> MinStack <span class="hljs-keyword">struct</span> &#123;<br>    stack []<span class="hljs-type">int</span><br>    minValue <span class="hljs-type">int</span><br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Constructor</span><span class="hljs-params">()</span></span> MinStack &#123;<br>    <span class="hljs-keyword">return</span> MinStack&#123;<br>        stack: []<span class="hljs-type">int</span>&#123;&#125;,<br>        minValue: <span class="hljs-number">-1</span>,<br>    &#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *MinStack)</span></span> Push(val <span class="hljs-type">int</span>)  &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(this.stack) == <span class="hljs-number">0</span> &#123;<br>        this.stack = <span class="hljs-built_in">append</span>(this.stack, <span class="hljs-number">0</span>)<br>        this.minValue = val<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        diff := val - this.minValue<br>        this.stack = <span class="hljs-built_in">append</span>(this.stack, diff)<br>        <span class="hljs-keyword">if</span> diff &lt; <span class="hljs-number">0</span> &#123;<br>            this.minValue = val<br>        &#125;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *MinStack)</span></span> Pop()  &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(this.stack) == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    diff := this.stack[<span class="hljs-built_in">len</span>(this.stack)<span class="hljs-number">-1</span>]<br>    this.stack = this.stack[:<span class="hljs-built_in">len</span>(this.stack)<span class="hljs-number">-1</span>]<br><br>    <span class="hljs-comment">// å¦‚æœdiffå°äº0ï¼Œåˆ™å½“å‰æœ€å°å€¼å°±æ˜¯æ ˆé¡¶çš„åŸå§‹å…ƒç´ </span><br>    <span class="hljs-comment">// å¹¶ä¸”ï¼Œå½“å‰æœ€å°å€¼ - diffå°±æ˜¯ä¸Šä¸€æ¬¡çš„æœ€å°å€¼ï¼ˆå‚è€ƒpushä¸­çš„é€»è¾‘ï¼‰</span><br>    <span class="hljs-comment">// è¿™é‡Œç›¸å½“äºåœ¨å‡ºæ ˆæ—¶æ¢å¤ä¸Šä¸€æ¬¡çš„æœ€å°å€¼ï¼Œæ˜¯å…³é”®çš„ä¸€æ­¥</span><br>    <span class="hljs-keyword">if</span> diff &lt; <span class="hljs-number">0</span> &#123;<br>        this.minValue = this.minValue - diff<br>    &#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *MinStack)</span></span> Top() <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> this.stack[<span class="hljs-built_in">len</span>(this.stack)<span class="hljs-number">-1</span>] &lt; <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> this.minValue<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> this.stack[<span class="hljs-built_in">len</span>(this.stack)<span class="hljs-number">-1</span>] + this.minValue<br>    &#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *MinStack)</span></span> GetMin() <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(this.stack) == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> this.minValue<br>&#125;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Your MinStack object will be instantiated and called as such:</span><br><span class="hljs-comment"> * obj := Constructor();</span><br><span class="hljs-comment"> * obj.Push(val);</span><br><span class="hljs-comment"> * obj.Pop();</span><br><span class="hljs-comment"> * param_3 := obj.Top();</span><br><span class="hljs-comment"> * param_4 := obj.GetMin();</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h2 id="129-æ±‚æ ¹èŠ‚ç‚¹åˆ°å¶èŠ‚ç‚¹æ•°å­—ä¹‹å’Œ"><a href="#129-æ±‚æ ¹èŠ‚ç‚¹åˆ°å¶èŠ‚ç‚¹æ•°å­—ä¹‹å’Œ" class="headerlink" title="129. æ±‚æ ¹èŠ‚ç‚¹åˆ°å¶èŠ‚ç‚¹æ•°å­—ä¹‹å’Œ"></a><a href="https://leetcode.cn/problems/sum-root-to-leaf-numbers/">129. æ±‚æ ¹èŠ‚ç‚¹åˆ°å¶èŠ‚ç‚¹æ•°å­—ä¹‹å’Œ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sumNumbers</span><span class="hljs-params">(root *TreeNode)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">return</span> dfs(root, <span class="hljs-number">0</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">dfs</span><span class="hljs-params">(root *TreeNode, prevSum <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br>    sum := prevSum * <span class="hljs-number">10</span> + root.Val<br>    <span class="hljs-keyword">if</span> root.Left == <span class="hljs-literal">nil</span> &amp;&amp; root.Right == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> sum<br>    &#125;<br>    <span class="hljs-keyword">return</span> dfs(root.Left, sum) + dfs(root.Right, sum)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="101-å¯¹ç§°äºŒå‰æ ‘"><a href="#101-å¯¹ç§°äºŒå‰æ ‘" class="headerlink" title="101. å¯¹ç§°äºŒå‰æ ‘"></a><a href="https://leetcode.cn/problems/symmetric-tree/">101. å¯¹ç§°äºŒå‰æ ‘</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">isSymmetric</span><span class="hljs-params">(root *TreeNode)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">return</span> check(root.Left, root.Right)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">check</span><span class="hljs-params">(p, q *TreeNode)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">if</span> p == <span class="hljs-literal">nil</span> &amp;&amp; q == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> p == <span class="hljs-literal">nil</span> || q == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> p.Val == q.Val &amp;&amp; check(p.Left, q.Right) &amp;&amp; check(p.Right, q.Left)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="104-äºŒå‰æ ‘çš„æœ€å¤§æ·±åº¦"><a href="#104-äºŒå‰æ ‘çš„æœ€å¤§æ·±åº¦" class="headerlink" title="104. äºŒå‰æ ‘çš„æœ€å¤§æ·±åº¦"></a><a href="https://leetcode.cn/problems/maximum-depth-of-binary-tree/">104. äºŒå‰æ ‘çš„æœ€å¤§æ·±åº¦</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">maxDepth</span><span class="hljs-params">(root *TreeNode)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> max(maxDepth(root.Left), maxDepth(root.Right)) + <span class="hljs-number">1</span><br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="34-åœ¨æ’åºæ•°ç»„ä¸­æŸ¥æ‰¾å…ƒç´ çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªä½ç½®"><a href="#34-åœ¨æ’åºæ•°ç»„ä¸­æŸ¥æ‰¾å…ƒç´ çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªä½ç½®" class="headerlink" title="34. åœ¨æ’åºæ•°ç»„ä¸­æŸ¥æ‰¾å…ƒç´ çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªä½ç½®"></a><a href="https://leetcode.cn/problems/find-first-and-last-position-of-element-in-sorted-array/">34. åœ¨æ’åºæ•°ç»„ä¸­æŸ¥æ‰¾å…ƒç´ çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªä½ç½®</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// lowerBound è¿”å›æœ€å°çš„æ»¡è¶³ nums[i] &gt;= target çš„ä¸‹æ ‡ i</span><br><span class="hljs-comment">// å¦‚æœæ•°ç»„ä¸ºç©ºï¼Œæˆ–è€…æ‰€æœ‰æ•°éƒ½ &lt; targetï¼Œåˆ™è¿”å› len(nums)</span><br><span class="hljs-comment">// è¦æ±‚ nums æ˜¯éé€’å‡çš„ï¼Œå³ nums[i] &lt;= nums[i + 1]</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">lowerBound</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>, target <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    left, right := <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(nums)<span class="hljs-number">-1</span> <span class="hljs-comment">// é—­åŒºé—´ [left, right]</span><br>    <span class="hljs-keyword">for</span> left &lt;= right &#123; <span class="hljs-comment">// åŒºé—´ä¸ä¸ºç©º</span><br>        <span class="hljs-comment">// å¾ªç¯ä¸å˜é‡ï¼š</span><br>        <span class="hljs-comment">// nums[left-1] &lt; target</span><br>        <span class="hljs-comment">// nums[right+1] &gt;= target</span><br>        mid := left + (right-left)/<span class="hljs-number">2</span><br>        <span class="hljs-keyword">if</span> nums[mid] &gt;= target &#123;<br>            right = mid - <span class="hljs-number">1</span> <span class="hljs-comment">// èŒƒå›´ç¼©å°åˆ° [left, mid-1]</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            left = mid + <span class="hljs-number">1</span> <span class="hljs-comment">// èŒƒå›´ç¼©å°åˆ° [mid+1, right]</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// å¾ªç¯ç»“æŸå left = right+1</span><br>    <span class="hljs-comment">// æ­¤æ—¶ nums[left-1] &lt; target è€Œ nums[left] = nums[right+1] &gt;= target</span><br>    <span class="hljs-comment">// æ‰€ä»¥ left å°±æ˜¯ç¬¬ä¸€ä¸ª &gt;= target çš„å…ƒç´ ä¸‹æ ‡</span><br>    <span class="hljs-keyword">return</span> left<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">searchRange</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>, target <span class="hljs-type">int</span>)</span></span> []<span class="hljs-type">int</span> &#123;<br>    start := lowerBound(nums, target)<br>    <span class="hljs-keyword">if</span> start == <span class="hljs-built_in">len</span>(nums) || nums[start] != target &#123;<br>        <span class="hljs-keyword">return</span> []<span class="hljs-type">int</span>&#123;<span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>&#125; <span class="hljs-comment">// nums ä¸­æ²¡æœ‰ target</span><br>    &#125;<br>    <span class="hljs-comment">// å¦‚æœ start å­˜åœ¨ï¼Œé‚£ä¹ˆ end å¿…å®šå­˜åœ¨</span><br>    end := lowerBound(nums, target+<span class="hljs-number">1</span>) - <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> []<span class="hljs-type">int</span>&#123;start, end&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="144-äºŒå‰æ ‘çš„å‰åºéå†"><a href="#144-äºŒå‰æ ‘çš„å‰åºéå†" class="headerlink" title="144. äºŒå‰æ ‘çš„å‰åºéå†"></a><a href="https://leetcode.cn/problems/binary-tree-preorder-traversal/">144. äºŒå‰æ ‘çš„å‰åºéå†</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">preorderTraversal</span><span class="hljs-params">(root *TreeNode)</span></span> []<span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br>    res := []<span class="hljs-type">int</span>&#123;&#125;<br>    <span class="hljs-keyword">var</span> preorder <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(root *TreeNode)</span></span><br>    preorder = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(root *TreeNode)</span></span> &#123;<br>        <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        res = <span class="hljs-built_in">append</span>(res, root.Val)<br>        preorder(root.Left)<br>        preorder(root.Right)<br>    &#125;<br>    preorder(root)<br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="39-ç»„åˆæ€»å’Œ"><a href="#39-ç»„åˆæ€»å’Œ" class="headerlink" title="39. ç»„åˆæ€»å’Œ"></a><a href="https://leetcode.cn/problems/combination-sum/">39. ç»„åˆæ€»å’Œ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">combinationSum</span><span class="hljs-params">(candidates []<span class="hljs-type">int</span>, target <span class="hljs-type">int</span>)</span></span> [][]<span class="hljs-type">int</span> &#123;<br>    res := [][]<span class="hljs-type">int</span>&#123;&#125;<br>    comb := []<span class="hljs-type">int</span>&#123;&#125;<br>    <span class="hljs-keyword">var</span> dfs <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(target, idx <span class="hljs-type">int</span>)</span></span><br>    dfs = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(target, idx <span class="hljs-type">int</span>)</span></span> &#123;<br>        <span class="hljs-comment">// å½“å‰ç´¢å¼•è¶…è¿‡äº†æ•°ç»„æ€»é•¿åº¦</span><br>        <span class="hljs-keyword">if</span> idx == <span class="hljs-built_in">len</span>(candidates) &#123;<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-comment">// targetå‡åˆ°äº†0ï¼Œè¯´æ˜æ‰¾åˆ°äº†ä¸€ä¸ªç­”æ¡ˆ</span><br>        <span class="hljs-keyword">if</span> target == <span class="hljs-number">0</span> &#123;<br>            res = <span class="hljs-built_in">append</span>(res, <span class="hljs-built_in">append</span>([]<span class="hljs-type">int</span>&#123;&#125;, comb...))<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-comment">// è€ƒè™‘é€‰æ‹©å½“å‰å…ƒç´ </span><br>        <span class="hljs-keyword">if</span> target - candidates[idx] &gt;= <span class="hljs-number">0</span> &#123;<br>            comb = <span class="hljs-built_in">append</span>(comb, candidates[idx])<br>            dfs(target-candidates[idx], idx)<br>            comb = comb[:<span class="hljs-built_in">len</span>(comb)<span class="hljs-number">-1</span>]<br>        &#125;<br>        <span class="hljs-comment">// ä¸è€ƒè™‘å½“å‰å…ƒç´ </span><br>        dfs(target, idx+<span class="hljs-number">1</span>)<br>    &#125;<br>    dfs(target, <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="394-å­—ç¬¦ä¸²è§£ç "><a href="#394-å­—ç¬¦ä¸²è§£ç " class="headerlink" title="394. å­—ç¬¦ä¸²è§£ç "></a><a href="https://leetcode.cn/problems/decode-string/">394. å­—ç¬¦ä¸²è§£ç </a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">decodeString</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>    stack := []<span class="hljs-type">string</span>&#123;&#125;<br>    p := <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> p &lt; <span class="hljs-built_in">len</span>(s) &#123;<br>        cur := s[p]<br>        <span class="hljs-comment">// å¦‚æœéå†åˆ°æ•°å­—ï¼Œå°±å–å‡ºæ‰€æœ‰çš„åç»­æ•°å­—ï¼Œå¾—åˆ°æ•´æ•°å­—ç¬¦ä¸²åï¼Œå°†å…¶å‹å…¥æ ˆä¸­</span><br>        <span class="hljs-keyword">if</span> cur &gt;= <span class="hljs-string">&#x27;0&#x27;</span> &amp;&amp; cur &lt;= <span class="hljs-string">&#x27;9&#x27;</span> &#123;<br>            digits := getDigits(s, &amp;p)<br>            stack = <span class="hljs-built_in">append</span>(stack, digits)<br>        <span class="hljs-comment">// å¦‚æœé‡åˆ°å­—ç¬¦æˆ–å·¦æ‹¬å·ï¼Œç›´æ¥å‹æ ˆ</span><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cur &gt;= <span class="hljs-string">&#x27;a&#x27;</span> &amp;&amp; cur &lt;= <span class="hljs-string">&#x27;z&#x27;</span> || cur &gt;= <span class="hljs-string">&#x27;A&#x27;</span> &amp;&amp; cur &lt;= <span class="hljs-string">&#x27;Z&#x27;</span>) || cur == <span class="hljs-string">&#x27;[&#x27;</span> &#123;<br>            stack = <span class="hljs-built_in">append</span>(stack, <span class="hljs-type">string</span>(cur))<br>            p++<br>        <span class="hljs-comment">// å¦‚æœé‡åˆ°å³æ‹¬å·</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// æŒç»­å‡ºæ ˆå­—ç¬¦ï¼Œç›´åˆ°é‡åˆ°å·¦æ‹¬å·ï¼Œæ­¤æ—¶subä¸­ä¿å­˜äº†æ‰€æœ‰çš„å‡ºæ ˆå­—ç¬¦</span><br>            sub := []<span class="hljs-type">string</span>&#123;&#125;<br>            <span class="hljs-keyword">for</span> stack[<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>] != <span class="hljs-string">&quot;[&quot;</span> &#123;<br>                sub = <span class="hljs-built_in">append</span>(sub, stack[<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>])<br>                stack = stack[:<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>]<br>            &#125;<br>            <span class="hljs-comment">// å°†subä¸­çš„å­—ç¬¦åè½¬ï¼Œå¾—åˆ°æ­£å¸¸çš„å­—ç¬¦é¡ºåº</span><br>            <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(sub)/<span class="hljs-number">2</span>; i++ &#123;<br>                sub[i], sub[<span class="hljs-built_in">len</span>(sub)<span class="hljs-number">-1</span>-i] = sub[<span class="hljs-built_in">len</span>(sub)<span class="hljs-number">-1</span>-i], sub[i]<br>            &#125;<br><br>            <span class="hljs-comment">// å°†å·¦æ‹¬å·å‡ºæ ˆ</span><br>            stack = stack[:<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>]<br><br>            <span class="hljs-comment">// æ­¤æ—¶æ ˆé¡¶ä¿å­˜çš„æ˜¯æ•´æ•°ï¼Œå°†æ­¤æ•´æ•°å‡ºæ ˆï¼Œå¹¶è¿›è¡Œé‡å¤å¤„ç†</span><br>            repTime, _ := strconv.Atoi(stack[<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>])<br>            stack = stack[:<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>]<br>            t := strings.Repeat(getString(sub), repTime)<br>            <span class="hljs-comment">// é‡ç‚¹ï¼Œå°†é‡å¤åçš„å­—ç¬¦ä¸²é‡æ–°å‹å…¥æ ˆä¸­</span><br>            stack = <span class="hljs-built_in">append</span>(stack, t)<br><br>            <span class="hljs-comment">// ç»§ç»­åˆ¤æ–­ä¸‹ä¸€ä¸ªå­—ç¬¦</span><br>            p++<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> getString(stack)<br>&#125;<br><br><span class="hljs-comment">// å–å‡ºæ‰€æœ‰çš„åç»­æ•°å­—ï¼Œç»„æˆä¸€ä¸ªæ•´æ•°å­—ç¬¦ä¸²</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getDigits</span><span class="hljs-params">(s <span class="hljs-type">string</span>, p *<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>    res := <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> ; s[*p] &gt;= <span class="hljs-string">&#x27;0&#x27;</span> &amp;&amp; s[*p] &lt;= <span class="hljs-string">&#x27;9&#x27;</span>; *p++ &#123;<br>        res += <span class="hljs-type">string</span>(s[*p])<br>    &#125;<br>    <span class="hljs-keyword">return</span> res<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getString</span><span class="hljs-params">(v []<span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>    res := <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> _, s := <span class="hljs-keyword">range</span> v &#123;<br>        res += s<br>    &#125;<br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="110-å¹³è¡¡äºŒå‰æ ‘"><a href="#110-å¹³è¡¡äºŒå‰æ ‘" class="headerlink" title="110. å¹³è¡¡äºŒå‰æ ‘"></a><a href="https://leetcode.cn/problems/balanced-binary-tree/">110. å¹³è¡¡äºŒå‰æ ‘</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">isBalanced</span><span class="hljs-params">(root *TreeNode)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> abs(height(root.Left) - height(root.Right)) &lt;= <span class="hljs-number">1</span> &amp;&amp; isBalanced(root.Left) &amp;&amp; isBalanced(root.Right)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">height</span><span class="hljs-params">(root *TreeNode)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> max(height(root.Left), height(root.Right)) + <span class="hljs-number">1</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">max</span><span class="hljs-params">(x, y <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> x &gt; y &#123;<br>        <span class="hljs-keyword">return</span> x<br>    &#125;<br>    <span class="hljs-keyword">return</span> y<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">abs</span><span class="hljs-params">(x <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> x &lt; <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span> * x<br>    &#125;<br>    <span class="hljs-keyword">return</span> x<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="64-æœ€å°è·¯å¾„å’Œ"><a href="#64-æœ€å°è·¯å¾„å’Œ" class="headerlink" title="64. æœ€å°è·¯å¾„å’Œ"></a><a href="https://leetcode.cn/problems/minimum-path-sum/">64. æœ€å°è·¯å¾„å’Œ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">minPathSum</span><span class="hljs-params">(grid [][]<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(grid) == <span class="hljs-number">0</span> || <span class="hljs-built_in">len</span>(grid[<span class="hljs-number">0</span>]) == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br>    rows := <span class="hljs-built_in">len</span>(grid)<br>    cols := <span class="hljs-built_in">len</span>(grid[<span class="hljs-number">0</span>])<br>    <br>    dp := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">int</span>, rows)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(dp); i++ &#123;<br>        dp[i] = <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, cols)<br>    &#125;<br><br>    dp[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] = grid[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; rows; i++ &#123;<br>        dp[i][<span class="hljs-number">0</span>] = dp[i<span class="hljs-number">-1</span>][<span class="hljs-number">0</span>] + grid[i][<span class="hljs-number">0</span>]<br>    &#125;<br>    <span class="hljs-keyword">for</span> j := <span class="hljs-number">1</span>; j &lt; cols; j++ &#123;<br>        dp[<span class="hljs-number">0</span>][j] = dp[<span class="hljs-number">0</span>][j<span class="hljs-number">-1</span>] + grid[<span class="hljs-number">0</span>][j]<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; rows; i++ &#123;<br>        <span class="hljs-keyword">for</span> j := <span class="hljs-number">1</span>; j &lt; cols; j++ &#123;<br>            dp[i][j] = min(dp[i][j<span class="hljs-number">-1</span>], dp[i<span class="hljs-number">-1</span>][j]) + grid[i][j]<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> dp[rows<span class="hljs-number">-1</span>][cols<span class="hljs-number">-1</span>]<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="48-æ—‹è½¬å›¾åƒ"><a href="#48-æ—‹è½¬å›¾åƒ" class="headerlink" title="48. æ—‹è½¬å›¾åƒ"></a><a href="https://leetcode.cn/problems/rotate-image/">48. æ—‹è½¬å›¾åƒ</a></h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure><h2 id="470-ç”¨-Rand7-å®ç°-Rand10"><a href="#470-ç”¨-Rand7-å®ç°-Rand10" class="headerlink" title="470. ç”¨ Rand7() å®ç° Rand10()"></a><a href="https://leetcode.cn/problems/implement-rand10-using-rand7/">470. ç”¨ Rand7() å®ç° Rand10()</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">rand10</span><span class="hljs-params">()</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">for</span> &#123;<br>        row := rand7()<br>        col := rand7()<br>        idx := (row<span class="hljs-number">-1</span>)*<span class="hljs-number">7</span> + col<br>        <span class="hljs-keyword">if</span> idx &lt;= <span class="hljs-number">40</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span> + (idx<span class="hljs-number">-1</span>)%<span class="hljs-number">10</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="240-æœç´¢äºŒç»´çŸ©é˜µ-II"><a href="#240-æœç´¢äºŒç»´çŸ©é˜µ-II" class="headerlink" title="240. æœç´¢äºŒç»´çŸ©é˜µ II"></a><a href="https://leetcode.cn/problems/search-a-2d-matrix-ii/">240. æœç´¢äºŒç»´çŸ©é˜µ II</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">searchMatrix</span><span class="hljs-params">(matrix [][]<span class="hljs-type">int</span>, target <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>    m := <span class="hljs-built_in">len</span>(matrix)<br>    n := <span class="hljs-built_in">len</span>(matrix[<span class="hljs-number">0</span>])<br>    x := <span class="hljs-number">0</span><br>    y := n - <span class="hljs-number">1</span><br>    <span class="hljs-keyword">for</span> x &lt; m &amp;&amp; y &gt;= <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">if</span> matrix[x][y] == target &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>        &#125;<br>        <span class="hljs-comment">// å¦‚æœå½“å‰å…ƒç´ å¤§ï¼Œå°±å¾€å°äº†èµ°ï¼Œå¾€å°äº†èµ°å°±æ˜¯å¾€å·¦ç§»åŠ¨</span><br>        <span class="hljs-keyword">if</span> matrix[x][y] &gt; target &#123;<br>            y--<br>        <span class="hljs-comment">// å¦‚æœå½“å‰å…ƒç´ å°ï¼Œå°±å¾€å¤§äº†èµ°ï¼Œå¾€å¤§äº†èµ°å°±æ˜¯å¾€ä¸‹èµ°</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            x++<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="98-éªŒè¯äºŒå‰æœç´¢æ ‘"><a href="#98-éªŒè¯äºŒå‰æœç´¢æ ‘" class="headerlink" title="98. éªŒè¯äºŒå‰æœç´¢æ ‘"></a><a href="https://leetcode.cn/problems/validate-binary-search-tree/">98. éªŒè¯äºŒå‰æœç´¢æ ‘</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">isValidBST</span><span class="hljs-params">(root *TreeNode)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">return</span> helper(root, math.MinInt64, math.MaxInt64)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">helper</span><span class="hljs-params">(root *TreeNode, lower, upper <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> root.Val &lt;= lower || root.Val &gt;= upper &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> helper(root.Left, lower, root.Val) &amp;&amp; helper(root.Right, root.Val, upper)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="543-äºŒå‰æ ‘çš„ç›´å¾„"><a href="#543-äºŒå‰æ ‘çš„ç›´å¾„" class="headerlink" title="543. äºŒå‰æ ‘çš„ç›´å¾„"></a><a href="https://leetcode.cn/problems/diameter-of-binary-tree/">543. äºŒå‰æ ‘çš„ç›´å¾„</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">diameterOfBinaryTree</span><span class="hljs-params">(root *TreeNode)</span></span> <span class="hljs-type">int</span> &#123;<br>    res := <span class="hljs-number">1</span><br>    <span class="hljs-keyword">var</span> depth <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(root *TreeNode)</span></span> <span class="hljs-type">int</span><br>    depth = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(root *TreeNode)</span></span> <span class="hljs-type">int</span> &#123;<br>        <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>        &#125;<br>        l := depth(root.Left)<br>        r := depth(root.Right)<br><br>        res = max(res, l + r + <span class="hljs-number">1</span>)<br><br>        <span class="hljs-keyword">return</span> max(l, r) + <span class="hljs-number">1</span><br>    &#125;<br><br>    depth(root)<br><br>    <span class="hljs-keyword">return</span> res - <span class="hljs-number">1</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="221-æœ€å¤§æ­£æ–¹å½¢"><a href="#221-æœ€å¤§æ­£æ–¹å½¢" class="headerlink" title="221. æœ€å¤§æ­£æ–¹å½¢"></a><a href="https://leetcode.cn/problems/maximal-square/">221. æœ€å¤§æ­£æ–¹å½¢</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">maximalSquare</span><span class="hljs-params">(matrix [][]<span class="hljs-type">byte</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    maxSide := <span class="hljs-number">0</span><br><br>    dp := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">int</span>, <span class="hljs-built_in">len</span>(matrix))<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(matrix); i++ &#123;<br>        dp[i] = <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-built_in">len</span>(matrix[i]))<br>        <span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; <span class="hljs-built_in">len</span>(matrix[i]); j++ &#123;<br>            dp[i][j] = <span class="hljs-type">int</span>(matrix[i][j] - <span class="hljs-string">&#x27;0&#x27;</span>)<br>            <span class="hljs-keyword">if</span> dp[i][j] == <span class="hljs-number">1</span> &#123;<br>                maxSide = <span class="hljs-number">1</span><br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; <span class="hljs-built_in">len</span>(matrix); i++ &#123;<br>        <span class="hljs-keyword">for</span> j := <span class="hljs-number">1</span>; j &lt; <span class="hljs-built_in">len</span>(matrix[i]); j++ &#123;<br>            <span class="hljs-keyword">if</span> dp[i][j] == <span class="hljs-number">1</span> &#123;<br>                dp[i][j] = min(min(dp[i<span class="hljs-number">-1</span>][j], dp[i][j<span class="hljs-number">-1</span>]), dp[i<span class="hljs-number">-1</span>][j<span class="hljs-number">-1</span>]) + <span class="hljs-number">1</span><br>                <span class="hljs-keyword">if</span> dp[i][j] &gt; maxSide &#123;<br>                    maxSide = dp[i][j]<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> maxSide * maxSide<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="128-æœ€é•¿è¿ç»­åºåˆ—"><a href="#128-æœ€é•¿è¿ç»­åºåˆ—" class="headerlink" title="128. æœ€é•¿è¿ç»­åºåˆ—"></a><a href="https://leetcode.cn/problems/longest-consecutive-sequence/">128. æœ€é•¿è¿ç»­åºåˆ—</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">longestConsecutive</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    numSet := <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">bool</span>&#123;&#125;<br>    <span class="hljs-keyword">for</span> _, num := <span class="hljs-keyword">range</span> nums &#123;<br>        numSet[num] = <span class="hljs-literal">true</span><br>    &#125;<br><br>    maxLength := <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> num := <span class="hljs-keyword">range</span> numSet &#123;<br>        <span class="hljs-keyword">if</span> !numSet[num<span class="hljs-number">-1</span>] &#123;<br>            curNum := num<br>            curLength := <span class="hljs-number">1</span><br>            <span class="hljs-keyword">for</span> numSet[curNum+<span class="hljs-number">1</span>] &#123;<br>                curNum++<br>                curLength++<br>            &#125;<br>            <span class="hljs-keyword">if</span> curLength &gt; maxLength &#123;<br>                maxLength = curLength<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> maxLength<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="122-ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº-II"><a href="#122-ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº-II" class="headerlink" title="122. ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº II"></a><a href="https://leetcode.cn/problems/best-time-to-buy-and-sell-stock-ii/">122. ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº II</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// è´ªå¿ƒæ³•ï¼Œåªèƒ½ç”¨äºè®¡ç®—æœ€å¤§åˆ©æ¶¦</span><br><span class="hljs-comment">// æ€æƒ³ï¼šæ‰€æœ‰çš„åˆ©æ¶¦éƒ½è¦æœ‰ï¼Œæ‰€æœ‰çš„äºæŸéƒ½ä¸è¦ã€‚å³ï¼šåªè¦åä¸€å¤©æ¯”å‰ä¸€å¤©ä»·æ ¼é«˜ï¼Œè¿™éƒ¨åˆ†å·®ä»·å°±æ˜¯åˆ©æ¶¦</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">maxProfit</span><span class="hljs-params">(prices []<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    res := <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; <span class="hljs-built_in">len</span>(prices); i++ &#123;<br>        res += max(<span class="hljs-number">0</span>, prices[i]-prices[i<span class="hljs-number">-1</span>])<br>    &#125;<br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="234-å›æ–‡é“¾è¡¨"><a href="#234-å›æ–‡é“¾è¡¨" class="headerlink" title="234. å›æ–‡é“¾è¡¨"></a><a href="https://leetcode.cn/problems/palindrome-linked-list/">234. å›æ–‡é“¾è¡¨</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// // é€’å½’ï¼Œæœ¬è´¨æ˜¯åˆ©ç”¨æ ˆ</span><br><span class="hljs-comment">// func isPalindrome(head *ListNode) bool &#123;</span><br><span class="hljs-comment">//     // é€’å½’å‡½æ•°å¤–æŒ‡é’ˆï¼ŒæŒ‡å‘é“¾è¡¨å¤´éƒ¨</span><br><span class="hljs-comment">//     p := head</span><br><br><span class="hljs-comment">//     var check func(*ListNode) bool</span><br><span class="hljs-comment">//     check = func(node *ListNode) bool &#123;</span><br><span class="hljs-comment">//         if node != nil &#123;</span><br><span class="hljs-comment">//             // ä¸€å¼€å§‹å°±è¿›å…¥é€’å½’ï¼Œå®é™…æ•ˆæœä¸Šä¼šæŠŠå½“å‰èŠ‚ç‚¹å‹å…¥å‡½æ•°æ ˆä¸­ï¼Œå¹¶ä¸”ä¼šä¸€ç›´å‹åˆ°æœ€åä¸€ä¸ªèŠ‚ç‚¹</span><br><span class="hljs-comment">//             // å½“å¼€å§‹å‡ºæ ˆæ—¶ï¼Œå®é™…å°±æ˜¯ä»æœ€åä¸€ä¸ªèŠ‚ç‚¹å¾€å‰éå†äº†</span><br><span class="hljs-comment">//             if !check(node.Next) &#123;</span><br><span class="hljs-comment">//                 return false</span><br><span class="hljs-comment">//             &#125;</span><br><span class="hljs-comment">//             // åˆ¤æ–­é€’å½’å¤–æŒ‡é’ˆä¸å½“å‰èŠ‚ç‚¹çš„å€¼</span><br><span class="hljs-comment">//             if node.Val != p.Val &#123;</span><br><span class="hljs-comment">//                 return false</span><br><span class="hljs-comment">//             &#125;</span><br><span class="hljs-comment">//             // å¤–æŒ‡é’ˆå‘åç§»åŠ¨ä¸€ä½</span><br><span class="hljs-comment">//             p = p.Next</span><br><span class="hljs-comment">//         &#125;</span><br><span class="hljs-comment">//         return true</span><br><span class="hljs-comment">//     &#125;</span><br><br><span class="hljs-comment">//     return check(head)</span><br><span class="hljs-comment">// &#125;</span><br><br><span class="hljs-comment">// å¿«æ…¢æŒ‡é’ˆæ‰¾ä¸­ç‚¹ + åè½¬é“¾è¡¨ + éå†å¯¹æ¯”</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reverseList</span><span class="hljs-params">(head *ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">var</span> prev, cur *ListNode = <span class="hljs-literal">nil</span>, head<br>    <span class="hljs-keyword">for</span> cur != <span class="hljs-literal">nil</span> &#123;<br>        nextTmp := cur.Next<br>        cur.Next = prev<br>        prev = cur<br>        cur = nextTmp<br>    &#125;<br>    <span class="hljs-keyword">return</span> prev<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">endOfFirstHalf</span><span class="hljs-params">(head *ListNode)</span></span> *ListNode &#123;<br>    fast := head<br>    slow := head<br>    <span class="hljs-keyword">for</span> fast.Next != <span class="hljs-literal">nil</span> &amp;&amp; fast.Next.Next != <span class="hljs-literal">nil</span> &#123;<br>        fast = fast.Next.Next<br>        slow = slow.Next<br>    &#125;<br>    <span class="hljs-keyword">return</span> slow<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">isPalindrome</span><span class="hljs-params">(head *ListNode)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">if</span> head == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    &#125;<br><br>    <span class="hljs-comment">// æ‰¾åˆ°å‰åŠéƒ¨åˆ†é“¾è¡¨çš„å°¾èŠ‚ç‚¹å¹¶åè½¬ååŠéƒ¨åˆ†é“¾è¡¨</span><br>    firstHalfEnd := endOfFirstHalf(head)<br>    secondHalfStart := reverseList(firstHalfEnd.Next)<br><br>    <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦å›æ–‡</span><br>    p1 := head<br>    p2 := secondHalfStart<br>    result := <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">for</span> result &amp;&amp; p2 != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">if</span> p1.Val != p2.Val &#123;<br>            result = <span class="hljs-literal">false</span><br>        &#125;<br>        p1 = p1.Next<br>        p2 = p2.Next<br>    &#125;<br><br>    <span class="hljs-comment">// è¿˜åŸé“¾è¡¨å¹¶è¿”å›ç»“æœ</span><br>    firstHalfEnd.Next = reverseList(secondHalfStart)<br>    <span class="hljs-keyword">return</span> result<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="162-å¯»æ‰¾å³°å€¼"><a href="#162-å¯»æ‰¾å³°å€¼" class="headerlink" title="162. å¯»æ‰¾å³°å€¼"></a><a href="https://leetcode.cn/problems/find-peak-element/">162. å¯»æ‰¾å³°å€¼</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// åˆ©ç”¨æ€§è´¨ + æ¯æ¬¡äºŒåˆ†ä¸¢å¼ƒä¸€åŠé€‰é¡¹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">findPeakElement</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    n := <span class="hljs-built_in">len</span>(nums)<br><br>    <span class="hljs-comment">// è¾…åŠ©å‡½æ•°ï¼Œè¾“å…¥ä¸‹æ ‡ iï¼Œè¿”å› nums[i] çš„å€¼</span><br>    <span class="hljs-comment">// æ–¹ä¾¿å¤„ç† nums[-1] ä»¥åŠ nums[n] çš„è¾¹ç•Œæƒ…å†µ</span><br>    get := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>        <span class="hljs-keyword">if</span> i == <span class="hljs-number">-1</span> || i == n &#123;<br>            <span class="hljs-keyword">return</span> math.MinInt64<br>        &#125;<br>        <span class="hljs-keyword">return</span> nums[i]<br>    &#125;<br><br>    left := <span class="hljs-number">0</span><br>    right := n - <span class="hljs-number">1</span><br>    <span class="hljs-keyword">for</span> &#123;<br>        mid := (left + right) / <span class="hljs-number">2</span><br>        <span class="hljs-keyword">if</span> get(mid<span class="hljs-number">-1</span>) &lt; get(mid) &amp;&amp; get(mid) &gt; get(mid+<span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">return</span> mid<br>        &#125;<br>        <span class="hljs-keyword">if</span> get(mid) &lt; get(mid+<span class="hljs-number">1</span>) &#123;<br>            left = mid + <span class="hljs-number">1</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            right = mid - <span class="hljs-number">1</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="695-å²›å±¿çš„æœ€å¤§é¢ç§¯"><a href="#695-å²›å±¿çš„æœ€å¤§é¢ç§¯" class="headerlink" title="695. å²›å±¿çš„æœ€å¤§é¢ç§¯"></a><a href="https://leetcode.cn/problems/max-area-of-island/">695. å²›å±¿çš„æœ€å¤§é¢ç§¯</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">maxAreaOfIsland</span><span class="hljs-params">(grid [][]<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    res := <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(grid); i++ &#123;<br>        <span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; <span class="hljs-built_in">len</span>(grid[<span class="hljs-number">0</span>]); j++ &#123;<br>            res = max(dfs(grid, i, j), res)<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> res<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">dfs</span><span class="hljs-params">(grid [][]<span class="hljs-type">int</span>, i, j <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> i &lt; <span class="hljs-number">0</span> || j &lt; <span class="hljs-number">0</span> || i == <span class="hljs-built_in">len</span>(grid) || j == <span class="hljs-built_in">len</span>(grid[<span class="hljs-number">0</span>]) || grid[i][j] != <span class="hljs-number">1</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br>    grid[i][j] = <span class="hljs-number">0</span><br>    area := <span class="hljs-number">1</span><br>    di := []<span class="hljs-type">int</span>&#123;<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>&#125;<br>    dj := []<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>&#125;<br>    <span class="hljs-keyword">for</span> k := <span class="hljs-number">0</span>; k &lt; <span class="hljs-built_in">len</span>(di); k++ &#123;<br>        area += dfs(grid, i+di[k], j+dj[k])<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> area<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="113-è·¯å¾„æ€»å’Œ-II"><a href="#113-è·¯å¾„æ€»å’Œ-II" class="headerlink" title="113. è·¯å¾„æ€»å’Œ II"></a><a href="https://leetcode.cn/problems/path-sum-ii/">113. è·¯å¾„æ€»å’Œ II</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">pathSum</span><span class="hljs-params">(root *TreeNode, targetSum <span class="hljs-type">int</span>)</span></span> [][]<span class="hljs-type">int</span> &#123;<br>    sum := <span class="hljs-number">0</span><br>    nodes := []<span class="hljs-type">int</span>&#123;&#125;<br>    res := [][]<span class="hljs-type">int</span>&#123;&#125;<br>    <span class="hljs-keyword">var</span> dfs <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(*TreeNode)</span></span><br>    dfs = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(node *TreeNode)</span></span> &#123;<br>        <span class="hljs-keyword">if</span> node == <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        nodes = <span class="hljs-built_in">append</span>(nodes, node.Val)<br>        sum += node.Val<br>        <span class="hljs-keyword">if</span> sum == targetSum &#123;<br>            <span class="hljs-keyword">if</span> node.Left == <span class="hljs-literal">nil</span> &amp;&amp; node.Right == <span class="hljs-literal">nil</span> &#123;<br>                res = <span class="hljs-built_in">append</span>(res, <span class="hljs-built_in">append</span>([]<span class="hljs-type">int</span>&#123;&#125;, nodes...))<br>            &#125;<br>        &#125;<br>        dfs(node.Left)<br>        dfs(node.Right)<br>        sum -= node.Val<br>        nodes = nodes[:<span class="hljs-built_in">len</span>(nodes)<span class="hljs-number">-1</span>]<br>    &#125;<br><br>    dfs(root)<br><br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="62-ä¸åŒè·¯å¾„"><a href="#62-ä¸åŒè·¯å¾„" class="headerlink" title="62. ä¸åŒè·¯å¾„"></a><a href="https://leetcode.cn/problems/unique-paths/">62. ä¸åŒè·¯å¾„</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">uniquePaths</span><span class="hljs-params">(m <span class="hljs-type">int</span>, n <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    dp := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">int</span>, m)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; m; i++ &#123;<br>        dp[i] = <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, n)<br>        dp[i][<span class="hljs-number">0</span>] = <span class="hljs-number">1</span><br>    &#125;<br>    <span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; n; j++ &#123;<br>        dp[<span class="hljs-number">0</span>][j] = <span class="hljs-number">1</span><br>    &#125;<br><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; m; i++ &#123;<br>        <span class="hljs-keyword">for</span> j := <span class="hljs-number">1</span>; j &lt; n; j++ &#123;<br>            dp[i][j] = dp[i<span class="hljs-number">-1</span>][j] + dp[i][j<span class="hljs-number">-1</span>]<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> dp[m<span class="hljs-number">-1</span>][n<span class="hljs-number">-1</span>]<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="662-äºŒå‰æ ‘æœ€å¤§å®½åº¦"><a href="#662-äºŒå‰æ ‘æœ€å¤§å®½åº¦" class="headerlink" title="662. äºŒå‰æ ‘æœ€å¤§å®½åº¦"></a><a href="https://leetcode.cn/problems/maximum-width-of-binary-tree/">662. äºŒå‰æ ‘æœ€å¤§å®½åº¦</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// å¹¿åº¦ä¼˜å…ˆæœç´¢ + äºŒå‰æ ‘èŠ‚ç‚¹ç¼–å·æ€§è´¨</span><br><span class="hljs-keyword">type</span> pair <span class="hljs-keyword">struct</span> &#123;<br>    node *TreeNode<br>    index <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">widthOfBinaryTree</span><span class="hljs-params">(root *TreeNode)</span></span> <span class="hljs-type">int</span> &#123;<br>    res := <span class="hljs-number">0</span><br>    q := []pair&#123;&#123;root, <span class="hljs-number">1</span>&#125;&#125;<br>    <span class="hljs-keyword">for</span> <span class="hljs-built_in">len</span>(q) &gt; <span class="hljs-number">0</span> &#123;<br>        res = max(res, q[<span class="hljs-built_in">len</span>(q)<span class="hljs-number">-1</span>].index - q[<span class="hljs-number">0</span>].index + <span class="hljs-number">1</span>)<br>        tmp := []pair&#123;&#125;<br>        <span class="hljs-keyword">for</span> _, p := <span class="hljs-keyword">range</span> q &#123;<br>            <span class="hljs-keyword">if</span> p.node.Left != <span class="hljs-literal">nil</span> &#123;<br>                tmp = <span class="hljs-built_in">append</span>(tmp, pair&#123;p.node.Left, p.index * <span class="hljs-number">2</span>&#125;)<br>            &#125;<br>            <span class="hljs-keyword">if</span> p.node.Right != <span class="hljs-literal">nil</span> &#123;<br>                tmp = <span class="hljs-built_in">append</span>(tmp, pair&#123;p.node.Right, p.index * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>&#125;)<br>            &#125;<br>        &#125;<br>        q = tmp<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="152-ä¹˜ç§¯æœ€å¤§å­æ•°ç»„"><a href="#152-ä¹˜ç§¯æœ€å¤§å­æ•°ç»„" class="headerlink" title="152. ä¹˜ç§¯æœ€å¤§å­æ•°ç»„"></a><a href="https://leetcode.cn/problems/maximum-product-subarray/">152. ä¹˜ç§¯æœ€å¤§å­æ•°ç»„</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">maxProduct</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    res := nums[<span class="hljs-number">0</span>]<br>    mx := nums[<span class="hljs-number">0</span>]<br>    mn := nums[<span class="hljs-number">0</span>]<br><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; <span class="hljs-built_in">len</span>(nums); i++ &#123;<br>        <span class="hljs-comment">// è¿™é‡Œmxï¼Œmnçš„è®¡ç®—äº’ä¸å¹²æ‰°ï¼Œå‡ä½¿ç”¨ä¸Šä¸€æ¬¡çš„ç»“æœè®¡ç®—</span><br>        mx, mn = max(nums[i], max(mx * nums[i], mn * nums[i])), min(nums[i], min(mx * nums[i], mn * nums[i]))<br>        res = max(res, mx)<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="112-è·¯å¾„æ€»å’Œ"><a href="#112-è·¯å¾„æ€»å’Œ" class="headerlink" title="112. è·¯å¾„æ€»å’Œ"></a><a href="https://leetcode.cn/problems/path-sum/">112. è·¯å¾„æ€»å’Œ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">hasPathSum</span><span class="hljs-params">(root *TreeNode, targetSum <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> root.Left == <span class="hljs-literal">nil</span> &amp;&amp; root.Right == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> targetSum == root.Val<br>    &#125;<br>    <span class="hljs-keyword">return</span> hasPathSum(root.Left, targetSum - root.Val) || hasPathSum(root.Right, targetSum - root.Val)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="198-æ‰“å®¶åŠ«èˆ"><a href="#198-æ‰“å®¶åŠ«èˆ" class="headerlink" title="198. æ‰“å®¶åŠ«èˆ"></a><a href="https://leetcode.cn/problems/house-robber/">198. æ‰“å®¶åŠ«èˆ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">rob</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    n := <span class="hljs-built_in">len</span>(nums)<br>    <span class="hljs-keyword">if</span> n == <span class="hljs-number">1</span> &#123;<br>        <span class="hljs-keyword">return</span> nums[<span class="hljs-number">0</span>]<br>    &#125;<br>    <span class="hljs-keyword">if</span> n == <span class="hljs-number">2</span> &#123;<br>        <span class="hljs-keyword">return</span> max(nums[<span class="hljs-number">0</span>], nums[<span class="hljs-number">1</span>])<br>    &#125;<br><br>    dp := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, n)<br>    <span class="hljs-comment">// å¦‚æœåªæœ‰ä¸€é—´æˆ¿ï¼Œåˆ™å·å–è¯¥é—´æˆ¿</span><br>    dp[<span class="hljs-number">0</span>] = nums[<span class="hljs-number">0</span>]<br>    <span class="hljs-comment">// å¦‚æœæœ‰ä¸¤é—´æˆ¿ï¼Œåˆ™å·å–é‡‘é¢å¤§çš„é‚£ä¸€é—´</span><br>    dp[<span class="hljs-number">1</span>] = max(nums[<span class="hljs-number">0</span>], nums[<span class="hljs-number">1</span>])<br><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">2</span>; i &lt; n; i++ &#123;<br>        <span class="hljs-comment">// å¦‚æœå·å–ç¬¬ié—´æˆ¿ï¼Œåˆ™åˆ°è¾¾iä½ç½®æ—¶çš„æ€»é‡‘é¢ä¸ºï¼Œå‰i-2é—´æˆ¿å·åˆ°çš„æ•°é¢åŠ ä¸Šç¬¬ié—´æˆ¿</span><br>        <span class="hljs-comment">// å¦‚æœä¸å·ç¬¬ié—´æˆ¿ï¼Œåˆ™åˆ°è¾¾iä½ç½®æ—¶çš„æ€»é‡‘é¢ä¸ºï¼Œå‰i-1é—´æˆ¿å·åˆ°çš„æ€»æ•°é¢</span><br>        dp[i] = max(dp[i<span class="hljs-number">-2</span>] + nums[i], dp[i<span class="hljs-number">-1</span>])<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> dp[n<span class="hljs-number">-1</span>]<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="560-å’Œä¸º-K-çš„å­æ•°ç»„"><a href="#560-å’Œä¸º-K-çš„å­æ•°ç»„" class="headerlink" title="560. å’Œä¸º K çš„å­æ•°ç»„"></a><a href="https://leetcode.cn/problems/subarray-sum-equals-k/">560. å’Œä¸º K çš„å­æ•°ç»„</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">subarraySum</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>, k <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-comment">// è®°å½•æœ€ç»ˆç»“æœ</span><br>    count := <span class="hljs-number">0</span><br>    <span class="hljs-comment">// è®°å½•ä»å¼€å¤´åˆ°å½“å‰ä½ç½®çš„å’Œ</span><br>    pre := <span class="hljs-number">0</span><br>    <span class="hljs-comment">// keyï¼šå‰ç¼€å’Œï¼Œvalueï¼šä¸ªæ•°</span><br>    m := <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>&#123;&#125;<br>    m[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(nums); i++ &#123;<br>        pre += nums[i]<br>        <span class="hljs-keyword">if</span> _, ok := m[pre-k]; ok &#123;<br>            count += m[pre-k]<br>        &#125;<br>        m[pre] += <span class="hljs-number">1</span><br>    &#125;<br><br>    <span class="hljs-keyword">return</span> count<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="169-å¤šæ•°å…ƒç´ "><a href="#169-å¤šæ•°å…ƒç´ " class="headerlink" title="169. å¤šæ•°å…ƒç´ "></a><a href="https://leetcode.cn/problems/majority-element/">169. å¤šæ•°å…ƒç´ </a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// æ‘©å°”æŠ•ç¥¨æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">majorityElement</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    count := <span class="hljs-number">0</span><br>    candidate := nums[<span class="hljs-number">0</span>]<br><br>    <span class="hljs-keyword">for</span> _, num := <span class="hljs-keyword">range</span> nums &#123;<br>        <span class="hljs-keyword">if</span> count == <span class="hljs-number">0</span> &#123;<br>            candidate = num<br>        &#125;<br>        <span class="hljs-keyword">if</span> num == candidate &#123;<br>            count += <span class="hljs-number">1</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            count -= <span class="hljs-number">1</span><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> candidate<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="227-åŸºæœ¬è®¡ç®—å™¨-II"><a href="#227-åŸºæœ¬è®¡ç®—å™¨-II" class="headerlink" title="227. åŸºæœ¬è®¡ç®—å™¨ II"></a><a href="https://leetcode.cn/problems/basic-calculator-ii/">227. åŸºæœ¬è®¡ç®—å™¨ II</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">calculate</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    res := <span class="hljs-number">0</span><br>    stack := []<span class="hljs-type">int</span>&#123;&#125;<br>    preSign := <span class="hljs-string">&#x27;+&#x27;</span><br>    num := <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i, ch := <span class="hljs-keyword">range</span> s &#123;<br>        isDigit := <span class="hljs-string">&#x27;0&#x27;</span> &lt;= ch &amp;&amp; ch &lt;= <span class="hljs-string">&#x27;9&#x27;</span><br>        <span class="hljs-keyword">if</span> isDigit &#123;<br>            num = num*<span class="hljs-number">10</span> + <span class="hljs-type">int</span>(ch-<span class="hljs-string">&#x27;0&#x27;</span>)<br>        &#125;<br>        <span class="hljs-keyword">if</span> !isDigit &amp;&amp; ch != <span class="hljs-string">&#x27; &#x27;</span> || i == <span class="hljs-built_in">len</span>(s)<span class="hljs-number">-1</span> &#123;<br>            <span class="hljs-keyword">switch</span> preSign &#123;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;+&#x27;</span>:<br>                    stack = <span class="hljs-built_in">append</span>(stack, num)<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;-&#x27;</span>:<br>                    stack = <span class="hljs-built_in">append</span>(stack, -num)<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;*&#x27;</span>:<br>                    stack[<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>] *= num<br>                <span class="hljs-keyword">default</span>:<br>                    stack[<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>] /= num<br>            &#125;<br>            preSign = ch<br>            num = <span class="hljs-number">0</span><br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> stack &#123;<br>        res += v<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="83-åˆ é™¤æ’åºé“¾è¡¨ä¸­çš„é‡å¤å…ƒç´ "><a href="#83-åˆ é™¤æ’åºé“¾è¡¨ä¸­çš„é‡å¤å…ƒç´ " class="headerlink" title="83. åˆ é™¤æ’åºé“¾è¡¨ä¸­çš„é‡å¤å…ƒç´ "></a><a href="https://leetcode.cn/problems/remove-duplicates-from-sorted-list/">83. åˆ é™¤æ’åºé“¾è¡¨ä¸­çš„é‡å¤å…ƒç´ </a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">deleteDuplicates</span><span class="hljs-params">(head *ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">if</span> head == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> head<br>    &#125;<br><br>    cur := head<br>    <span class="hljs-keyword">for</span> cur.Next != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">if</span> cur.Val == cur.Next.Val &#123;<br>            cur.Next = cur.Next.Next<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            cur = cur.Next<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> head<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="718-æœ€é•¿é‡å¤å­æ•°ç»„"><a href="#718-æœ€é•¿é‡å¤å­æ•°ç»„" class="headerlink" title="718. æœ€é•¿é‡å¤å­æ•°ç»„"></a><a href="https://leetcode.cn/problems/maximum-length-of-repeated-subarray/">718. æœ€é•¿é‡å¤å­æ•°ç»„</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">findLength</span><span class="hljs-params">(nums1 []<span class="hljs-type">int</span>, nums2 []<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    n := <span class="hljs-built_in">len</span>(nums1)<br>    m := <span class="hljs-built_in">len</span>(nums2)<br><br>    res := <span class="hljs-number">0</span><br>    <span class="hljs-comment">// dp[i][j]å«ä¹‰ï¼šnums1[:i+1]å’Œnums2[:j+1]çš„æœ€é•¿å…¬å…±åç¼€</span><br>    dp := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">int</span>, n)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;<br>        dp[i] = <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, m)<br>        <span class="hljs-keyword">if</span> nums1[i] == nums2[<span class="hljs-number">0</span>] &#123;<br>            dp[i][<span class="hljs-number">0</span>] = <span class="hljs-number">1</span><br>            res = <span class="hljs-number">1</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; m; j++ &#123;<br>        <span class="hljs-keyword">if</span> nums1[<span class="hljs-number">0</span>] == nums2[j] &#123;<br>            dp[<span class="hljs-number">0</span>][j] = <span class="hljs-number">1</span><br>            res = <span class="hljs-number">1</span><br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; n; i++ &#123;<br>        <span class="hljs-keyword">for</span> j := <span class="hljs-number">1</span>; j &lt; m; j++ &#123;<br>            <span class="hljs-keyword">if</span> nums1[i] == nums2[j] &#123;<br>                dp[i][j] = dp[i<span class="hljs-number">-1</span>][j<span class="hljs-number">-1</span>] + <span class="hljs-number">1</span><br>                res = max(res, dp[i][j])<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                dp[i][j] = <span class="hljs-number">0</span><br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="189-è½®è½¬æ•°ç»„"><a href="#189-è½®è½¬æ•°ç»„" class="headerlink" title="189. è½®è½¬æ•°ç»„"></a><a href="https://leetcode.cn/problems/rotate-array/">189. è½®è½¬æ•°ç»„</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">rotate</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>, k <span class="hljs-type">int</span>)</span></span>  &#123;<br>    k = k % <span class="hljs-built_in">len</span>(nums)<br>    reverse(nums)<br>    reverse(nums[:k])<br>    reverse(nums[k:])<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reverse</span><span class="hljs-params">(a []<span class="hljs-type">int</span>)</span></span> &#123;<br>    <span class="hljs-keyword">for</span> i, n := <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(a); i &lt; n / <span class="hljs-number">2</span>; i ++ &#123;<br>        a[i], a[n<span class="hljs-number">-1</span>-i] = a[n<span class="hljs-number">-1</span>-i], a[i]<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="73-çŸ©é˜µç½®é›¶"><a href="#73-çŸ©é˜µç½®é›¶" class="headerlink" title="73. çŸ©é˜µç½®é›¶"></a><a href="https://leetcode.cn/problems/set-matrix-zeroes/">73. çŸ©é˜µç½®é›¶</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">setZeroes</span><span class="hljs-params">(matrix [][]<span class="hljs-type">int</span>)</span></span>  &#123;<br>    row := <span class="hljs-built_in">make</span>([]<span class="hljs-type">bool</span>, <span class="hljs-built_in">len</span>(matrix))<br>    col := <span class="hljs-built_in">make</span>([]<span class="hljs-type">bool</span>, <span class="hljs-built_in">len</span>(matrix[<span class="hljs-number">0</span>]))<br><br>    <span class="hljs-keyword">for</span> i, r := <span class="hljs-keyword">range</span> matrix &#123;<br>        <span class="hljs-keyword">for</span> j, v := <span class="hljs-keyword">range</span> r &#123;<br>            <span class="hljs-keyword">if</span> v == <span class="hljs-number">0</span> &#123;<br>                row[i] = <span class="hljs-literal">true</span><br>                col[j] = <span class="hljs-literal">true</span><br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> i, r := <span class="hljs-keyword">range</span> matrix &#123;<br>        <span class="hljs-keyword">for</span> j := <span class="hljs-keyword">range</span> r &#123;<br>            <span class="hljs-keyword">if</span> row[i] || col[j] &#123;<br>                r[j] = <span class="hljs-number">0</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="138-éšæœºé“¾è¡¨çš„å¤åˆ¶"><a href="#138-éšæœºé“¾è¡¨çš„å¤åˆ¶" class="headerlink" title="138. éšæœºé“¾è¡¨çš„å¤åˆ¶"></a><a href="https://leetcode.cn/problems/copy-list-with-random-pointer/">138. éšæœºé“¾è¡¨çš„å¤åˆ¶</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a Node.</span><br><span class="hljs-comment"> * type Node struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *Node</span><br><span class="hljs-comment"> *     Random *Node</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">var</span> cachedNode <span class="hljs-keyword">map</span>[*Node]*Node<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">deepCopy</span><span class="hljs-params">(node *Node)</span></span> *Node &#123;<br>    <span class="hljs-keyword">if</span> node == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> n, has := cachedNode[node]; has &#123;<br>        <span class="hljs-keyword">return</span> n<br>    &#125;<br>    newNode := &amp;Node&#123;Val: node.Val&#125;<br>    cachedNode[node] = newNode<br>    newNode.Next = deepCopy(node.Next)<br>    newNode.Random = deepCopy(node.Random)<br>    <span class="hljs-keyword">return</span> newNode<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">copyRandomList</span><span class="hljs-params">(head *Node)</span></span> *Node &#123;<br>    cachedNode = <span class="hljs-keyword">map</span>[*Node]*Node&#123;&#125;<br>    <span class="hljs-keyword">return</span> deepCopy(head)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="108-å°†æœ‰åºæ•°ç»„è½¬æ¢ä¸ºäºŒå‰æœç´¢æ ‘"><a href="#108-å°†æœ‰åºæ•°ç»„è½¬æ¢ä¸ºäºŒå‰æœç´¢æ ‘" class="headerlink" title="108. å°†æœ‰åºæ•°ç»„è½¬æ¢ä¸ºäºŒå‰æœç´¢æ ‘"></a><a href="https://leetcode.cn/problems/convert-sorted-array-to-binary-search-tree/">108. å°†æœ‰åºæ•°ç»„è½¬æ¢ä¸ºäºŒå‰æœç´¢æ ‘</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sortedArrayToBST</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> *TreeNode &#123;<br>    <span class="hljs-keyword">return</span> helper(nums, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(nums)<span class="hljs-number">-1</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">helper</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>, left, right <span class="hljs-type">int</span>)</span></span> * TreeNode &#123;<br>    <span class="hljs-keyword">if</span> left &gt; right &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br>    mid := (left + right) / <span class="hljs-number">2</span><br>    root := &amp;TreeNode&#123;Val: nums[mid]&#125;<br>    root.Left = helper(nums, left, mid<span class="hljs-number">-1</span>)<br>    root.Right = helper(nums, mid+<span class="hljs-number">1</span>, right)<br>    <span class="hljs-keyword">return</span> root<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="114-äºŒå‰æ ‘å±•å¼€ä¸ºé“¾è¡¨"><a href="#114-äºŒå‰æ ‘å±•å¼€ä¸ºé“¾è¡¨" class="headerlink" title="114. äºŒå‰æ ‘å±•å¼€ä¸ºé“¾è¡¨"></a><a href="https://leetcode.cn/problems/flatten-binary-tree-to-linked-list/">114. äºŒå‰æ ‘å±•å¼€ä¸ºé“¾è¡¨</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">flatten</span><span class="hljs-params">(root *TreeNode)</span></span>  &#123;<br>    list := preorderTraversal(root)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; <span class="hljs-built_in">len</span>(list); i++ &#123;<br>        prev, curr := list[i<span class="hljs-number">-1</span>], list[i]<br>        prev.Left, prev.Right = <span class="hljs-literal">nil</span>, curr<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">preorderTraversal</span><span class="hljs-params">(root *TreeNode)</span></span> []*TreeNode &#123;<br>    list := []*TreeNode&#123;&#125;<br>    <span class="hljs-keyword">if</span> root != <span class="hljs-literal">nil</span> &#123;<br>        list = <span class="hljs-built_in">append</span>(list, root)<br>        list = <span class="hljs-built_in">append</span>(list, preorderTraversal(root.Left)...)<br>        list = <span class="hljs-built_in">append</span>(list, preorderTraversal(root.Right)...)<br>    &#125;<br>    <span class="hljs-keyword">return</span> list<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="437-è·¯å¾„æ€»å’Œ-III"><a href="#437-è·¯å¾„æ€»å’Œ-III" class="headerlink" title="437. è·¯å¾„æ€»å’Œ III"></a><a href="https://leetcode.cn/problems/path-sum-iii/">437. è·¯å¾„æ€»å’Œ III</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">pathSum</span><span class="hljs-params">(root *TreeNode, targetSum <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    ans := <span class="hljs-number">0</span><br>    preSum := <span class="hljs-keyword">map</span>[<span class="hljs-type">int64</span>]<span class="hljs-type">int</span>&#123;<span class="hljs-number">0</span>: <span class="hljs-number">1</span>&#125;<br>    <br>    <span class="hljs-keyword">var</span> dfs <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(*TreeNode, <span class="hljs-type">int64</span>)</span></span><br>    dfs = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(node *TreeNode, curr <span class="hljs-type">int64</span>)</span></span> &#123;<br>        <span class="hljs-keyword">if</span> node == <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        curr += <span class="hljs-type">int64</span>(node.Val)<br>        ans += preSum[curr-<span class="hljs-type">int64</span>(targetSum)]<br>        preSum[curr]++<br>        dfs(node.Left, curr)<br>        dfs(node.Right, curr)<br>        preSum[curr]--<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    dfs(root, <span class="hljs-number">0</span>)<br><br>    <span class="hljs-keyword">return</span> ans<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="994-è…çƒ‚çš„æ©˜å­"><a href="#994-è…çƒ‚çš„æ©˜å­" class="headerlink" title="994. è…çƒ‚çš„æ©˜å­"></a><a href="https://leetcode.cn/problems/rotting-oranges/">994. è…çƒ‚çš„æ©˜å­</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">orangesRotting</span><span class="hljs-params">(grid [][]<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-comment">// æ€»è¡Œæ•°</span><br>    R := <span class="hljs-built_in">len</span>(grid)<br>    <span class="hljs-comment">// æ€»åˆ—æ•°</span><br>    C := <span class="hljs-built_in">len</span>(grid[<span class="hljs-number">0</span>])<br><br>    <span class="hljs-comment">// ä¸Šä¸‹å·¦å³å››ä¸ªæ–¹å‘</span><br>    dr := []<span class="hljs-type">int</span>&#123;<span class="hljs-number">-1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>&#125;<br>    dc := []<span class="hljs-type">int</span>&#123;<span class="hljs-number">0</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>&#125;<br><br>    <span class="hljs-comment">// ç”¨äºè¾…åŠ©å±‚æ¬¡éå†</span><br>    queue := []<span class="hljs-type">int</span>&#123;&#125;<br><br>    <span class="hljs-comment">// ç”¨äºè®°å½•åˆ°è¾¾æ¯ä¸ªç‚¹ä½å¯¹åº”çš„æ·±åº¦</span><br>    depth := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>)<br><br>    <span class="hljs-comment">// è®°å½•é¦–å±‚ç‚¹ä½ï¼Œæ·±åº¦å‡ä¸º0</span><br>    <span class="hljs-keyword">for</span> r := <span class="hljs-number">0</span>; r &lt; R; r++ &#123;<br>        <span class="hljs-keyword">for</span> c := <span class="hljs-number">0</span>; c &lt; C; c++ &#123;<br>            <span class="hljs-keyword">if</span> grid[r][c] == <span class="hljs-number">2</span> &#123;<br>                code := r * C + c<br>                queue = <span class="hljs-built_in">append</span>(queue, code)<br>                depth[code] = <span class="hljs-number">0</span><br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">// è¿›è¡Œå±‚åºéå†</span><br>    ans := <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> <span class="hljs-built_in">len</span>(queue) &gt; <span class="hljs-number">0</span> &#123;<br>        code := queue[<span class="hljs-number">0</span>]<br>        queue = queue[<span class="hljs-number">1</span>:]<br>        r := code / C<br>        c := code % C<br>        <span class="hljs-keyword">for</span> k := <span class="hljs-number">0</span>; k &lt; <span class="hljs-number">4</span>; k++ &#123;<br>            nr := r + dr[k]<br>            nc := c + dc[k]<br>            <span class="hljs-keyword">if</span> nr &gt;= <span class="hljs-number">0</span> &amp;&amp; nr &lt; R &amp;&amp; nc &gt;= <span class="hljs-number">0</span> &amp;&amp; nc &lt; C &amp;&amp; grid[nr][nc] == <span class="hljs-number">1</span> &#123;<br>                grid[nr][nc] = <span class="hljs-number">2</span><br>                ncode := nr * C + nc<br>                queue = <span class="hljs-built_in">append</span>(queue, ncode)<br>                depth[ncode] = depth[code] + <span class="hljs-number">1</span><br>                <span class="hljs-comment">// æ¯æ¬¡è¿›å…¥è¯¥ifæ¡ä»¶ï¼Œåˆ™æ„å‘³ç€åˆ°è¾¾äº†ä¸€ä¸ªæ–°é²œæ©˜å­ï¼Œæ·±åº¦åŠ 1</span><br>                ans = depth[ncode]<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ–°é²œæ©˜å­</span><br>    <span class="hljs-keyword">for</span> _, row := <span class="hljs-keyword">range</span> grid &#123;<br>        <span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> row &#123;<br>            <span class="hljs-keyword">if</span> v == <span class="hljs-number">1</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> ans<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="207-è¯¾ç¨‹è¡¨"><a href="#207-è¯¾ç¨‹è¡¨" class="headerlink" title="207. è¯¾ç¨‹è¡¨"></a><a href="https://leetcode.cn/problems/course-schedule/">207. è¯¾ç¨‹è¡¨</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">canFinish</span><span class="hljs-params">(numCourses <span class="hljs-type">int</span>, prerequisites [][]<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-comment">// è®°å½•æ‰€æœ‰èŠ‚ç‚¹çš„è¾¹ï¼Œedges[i]å«ä¹‰ä¸ºç¬¬iä¸ªèŠ‚ç‚¹æ‰€æŒ‡å‘çš„æ‰€æœ‰èŠ‚ç‚¹</span><br>    edges := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">int</span>, numCourses)<br>    <span class="hljs-comment">// è®°å½•æ¯ä¸ªèŠ‚ç‚¹çš„å…¥åº¦ï¼Œå³æœ‰å¤šå°‘ä¸ªèŠ‚ç‚¹æŒ‡å‘å®ƒ</span><br>    indeg := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, numCourses)<br>    <span class="hljs-comment">// è®°å½•æ‹“æ‰‘æ’åºï¼Œå¦‚æœæ‰€æœ‰èŠ‚ç‚¹å­˜åœ¨æ‹“æ‰‘æ’åºï¼Œåˆ™è¯¾ç¨‹èƒ½æ­£å¸¸ä¿®å®Œ</span><br>    result := []<span class="hljs-type">int</span>&#123;&#125;<br><br>    <span class="hljs-comment">// ä¿å­˜æ‰€æœ‰èŠ‚ç‚¹çš„è¾¹å’Œå…¥åº¦</span><br>    <span class="hljs-keyword">for</span> _, info := <span class="hljs-keyword">range</span> prerequisites &#123;<br>        edges[info[<span class="hljs-number">1</span>]] = <span class="hljs-built_in">append</span>(edges[info[<span class="hljs-number">1</span>]], info[<span class="hljs-number">0</span>])<br>        indeg[info[<span class="hljs-number">0</span>]]++<br>    &#125;<br><br>    <span class="hljs-comment">// å…ˆå°†å…¥åº¦ä¸º0çš„èŠ‚ç‚¹å…¥é˜Ÿ</span><br>    q := []<span class="hljs-type">int</span>&#123;&#125;<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; numCourses; i++ &#123;<br>        <span class="hljs-keyword">if</span> indeg[i] == <span class="hljs-number">0</span> &#123;<br>            q = <span class="hljs-built_in">append</span>(q, i)<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// å¹¿åº¦ä¼˜å…ˆæœç´¢</span><br>    <span class="hljs-keyword">for</span> <span class="hljs-built_in">len</span>(q) &gt; <span class="hljs-number">0</span> &#123;<br>        u := q[<span class="hljs-number">0</span>]<br>        q = q[<span class="hljs-number">1</span>:]<br>        result = <span class="hljs-built_in">append</span>(result, u)<br>        <span class="hljs-comment">// å°†uå…¥é˜Ÿåï¼Œæ£€æŸ¥uæŒ‡å‘çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œå°†å…¶å…¥åº¦å‡1</span><br>        <span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> edges[u] &#123;<br>            indeg[v]--<br>            <span class="hljs-keyword">if</span> indeg[v] == <span class="hljs-number">0</span> &#123;<br>                q = <span class="hljs-built_in">append</span>(q, v)<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(result) == numCourses<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="208-å®ç°-Trie-å‰ç¼€æ ‘"><a href="#208-å®ç°-Trie-å‰ç¼€æ ‘" class="headerlink" title="208. å®ç° Trie (å‰ç¼€æ ‘)"></a><a href="https://leetcode.cn/problems/implement-trie-prefix-tree/">208. å®ç° Trie (å‰ç¼€æ ‘)</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Trie <span class="hljs-keyword">struct</span> &#123;<br>    children [<span class="hljs-number">26</span>]*Trie<br>    isEnd <span class="hljs-type">bool</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Constructor</span><span class="hljs-params">()</span></span> Trie &#123;<br>    <span class="hljs-keyword">return</span> Trie&#123;&#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *Trie)</span></span> Insert(word <span class="hljs-type">string</span>)  &#123;<br>    node := this<br>    <span class="hljs-keyword">for</span> _, ch := <span class="hljs-keyword">range</span> word &#123;<br>        ch -= <span class="hljs-string">&#x27;a&#x27;</span><br>        <span class="hljs-keyword">if</span> node.children[ch] == <span class="hljs-literal">nil</span> &#123;<br>            node.children[ch] = &amp;Trie&#123;&#125;<br>        &#125;<br>        node = node.children[ch]<br>    &#125;<br>    node.isEnd = <span class="hljs-literal">true</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *Trie)</span></span> SearchPrefix(prefix <span class="hljs-type">string</span>) *Trie &#123;<br>    node := this<br>    <span class="hljs-keyword">for</span> _, ch := <span class="hljs-keyword">range</span> prefix &#123;<br>        ch -= <span class="hljs-string">&#x27;a&#x27;</span><br>        <span class="hljs-keyword">if</span> node.children[ch] == <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>        &#125;<br>        node = node.children[ch]<br>    &#125;<br>    <span class="hljs-keyword">return</span> node<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *Trie)</span></span> Search(word <span class="hljs-type">string</span>) <span class="hljs-type">bool</span> &#123;<br>    node := this.SearchPrefix(word)<br>    <span class="hljs-keyword">return</span> node != <span class="hljs-literal">nil</span> &amp;&amp; node.isEnd<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *Trie)</span></span> StartsWith(prefix <span class="hljs-type">string</span>) <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">return</span> this.SearchPrefix(prefix) != <span class="hljs-literal">nil</span><br>&#125;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Your Trie object will be instantiated and called as such:</span><br><span class="hljs-comment"> * obj := Constructor();</span><br><span class="hljs-comment"> * obj.Insert(word);</span><br><span class="hljs-comment"> * param_2 := obj.Search(word);</span><br><span class="hljs-comment"> * param_3 := obj.StartsWith(prefix);</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h2 id="79-å•è¯æœç´¢"><a href="#79-å•è¯æœç´¢" class="headerlink" title="79. å•è¯æœç´¢"></a><a href="https://leetcode.cn/problems/word-search/">79. å•è¯æœç´¢</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> pair <span class="hljs-keyword">struct</span>&#123;<br>    x <span class="hljs-type">int</span><br>    y <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-keyword">var</span> directions = []pair&#123;&#123;<span class="hljs-number">-1</span>, <span class="hljs-number">0</span>&#125;, &#123;<span class="hljs-number">1</span>, <span class="hljs-number">0</span>&#125;, &#123;<span class="hljs-number">0</span>, <span class="hljs-number">-1</span>&#125;, &#123;<span class="hljs-number">0</span>, <span class="hljs-number">1</span>&#125;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">exist</span><span class="hljs-params">(board [][]<span class="hljs-type">byte</span>, word <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>    R := <span class="hljs-built_in">len</span>(board)<br>    C := <span class="hljs-built_in">len</span>(board[<span class="hljs-number">0</span>])<br><br>    visit := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">bool</span>, R)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> visit &#123;<br>        visit[i] = <span class="hljs-built_in">make</span>([]<span class="hljs-type">bool</span>, C)<br>    &#125;<br><br>    <span class="hljs-keyword">var</span> check <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, j, k <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span><br>    check = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, j, k <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>        <span class="hljs-keyword">if</span> board[i][j] != word[k] &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>        &#125;<br><br>        <span class="hljs-keyword">if</span> k == <span class="hljs-built_in">len</span>(word) - <span class="hljs-number">1</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>        &#125;<br><br>        visit[i][j] = <span class="hljs-literal">true</span><br>        <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            visit[i][j] = <span class="hljs-literal">false</span><br>        &#125;()<br><br>        <span class="hljs-keyword">for</span> _, dir := <span class="hljs-keyword">range</span> directions &#123;<br>            newI := i + dir.x<br>            newJ := j + dir.y<br>            <span class="hljs-keyword">if</span> newI &gt;= <span class="hljs-number">0</span> &amp;&amp; newI &lt; R &amp;&amp; newJ &gt;= <span class="hljs-number">0</span> &amp;&amp; newJ &lt; C &amp;&amp; !visit[newI][newJ] &#123;<br>                <span class="hljs-keyword">if</span> check(newI, newJ, k+<span class="hljs-number">1</span>) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>    &#125;<br><br>    <span class="hljs-keyword">for</span> i, row := <span class="hljs-keyword">range</span> board &#123;<br>        <span class="hljs-keyword">for</span> j := <span class="hljs-keyword">range</span> row &#123;<br>            <span class="hljs-keyword">if</span> check(i, j, <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="131-åˆ†å‰²å›æ–‡ä¸²"><a href="#131-åˆ†å‰²å›æ–‡ä¸²" class="headerlink" title="131. åˆ†å‰²å›æ–‡ä¸²"></a><a href="https://leetcode.cn/problems/palindrome-partitioning/">131. åˆ†å‰²å›æ–‡ä¸²</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">partition</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> [][]<span class="hljs-type">string</span> &#123;<br>    n := <span class="hljs-built_in">len</span>(s)<br>    f := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">bool</span>, n)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> f &#123;<br>        f[i] = <span class="hljs-built_in">make</span>([]<span class="hljs-type">bool</span>, n)<br>        <span class="hljs-keyword">for</span> j := <span class="hljs-keyword">range</span> f[i] &#123;<br>            f[i][j] = <span class="hljs-literal">true</span><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> i := n - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i-- &#123;<br>        <span class="hljs-keyword">for</span> j := i + <span class="hljs-number">1</span>; j &lt; n; j++ &#123;<br>            f[i][j] = s[i] == s[j] &amp;&amp; f[i+<span class="hljs-number">1</span>][j<span class="hljs-number">-1</span>]<br>        &#125;<br>    &#125;<br><br>    ans := [][]<span class="hljs-type">string</span>&#123;&#125;<br><br>    splits := []<span class="hljs-type">string</span>&#123;&#125;<br>    <span class="hljs-keyword">var</span> dfs <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span></span><br>    dfs = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> &#123;<br>        <span class="hljs-keyword">if</span> i == n &#123;<br>            ans = <span class="hljs-built_in">append</span>(ans, <span class="hljs-built_in">append</span>([]<span class="hljs-type">string</span>(<span class="hljs-literal">nil</span>), splits...))<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-keyword">for</span> j := i; j &lt; n; j++ &#123;<br>            <span class="hljs-keyword">if</span> f[i][j] &#123;<br>                splits = <span class="hljs-built_in">append</span>(splits, s[i:j+<span class="hljs-number">1</span>])<br>                dfs(j+<span class="hljs-number">1</span>)<br>                <span class="hljs-comment">// æ”¾å¼ƒå½“å‰æ‹†åˆ†æ–¹æ¡ˆï¼Œå›é€€åˆ°åŸçŠ¶</span><br>                splits = splits[:<span class="hljs-built_in">len</span>(splits)<span class="hljs-number">-1</span>]<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    dfs(<span class="hljs-number">0</span>)<br><br>    <span class="hljs-keyword">return</span> ans<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="51-N-çš‡å"><a href="#51-N-çš‡å" class="headerlink" title="51. N çš‡å"></a><a href="https://leetcode.cn/problems/n-queens/">51. N çš‡å</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> solutions [][]<span class="hljs-type">string</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">solveNQueens</span><span class="hljs-params">(n <span class="hljs-type">int</span>)</span></span> [][]<span class="hljs-type">string</span> &#123;<br>    <span class="hljs-comment">// ä¿å­˜æœ€ç»ˆç»“æœ</span><br>    solutions = [][]<span class="hljs-type">string</span>&#123;&#125;<br>    <span class="hljs-comment">// è®°å½•æ¯ä¸€è¡Œçš„çš‡åæ”¾ç½®åœ¨å“ªä¸€åˆ—</span><br>    queens := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, n)<br>    <span class="hljs-comment">// åˆå§‹åŒ–</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;<br>        queens[i] = <span class="hljs-number">-1</span><br>    &#125;<br>    <span class="hljs-comment">// è®°å½•å“ªäº›åˆ—å·²ç»æ”¾ç½®äº†çš‡å</span><br>    columns := <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">bool</span>&#123;&#125;<br>    <span class="hljs-comment">// è®°å½•å“ªäº›å¯¹è§’å·²ç»æ”¾ç½®äº†çš‡å</span><br>    diagonals1 := <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">bool</span>&#123;&#125;<br>    diagonals2 := <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">bool</span>&#123;&#125;<br><br>    backtrack(queens, n, <span class="hljs-number">0</span>, columns, diagonals1, diagonals2)<br><br>    <span class="hljs-keyword">return</span> solutions<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">backtrack</span><span class="hljs-params">(queens []<span class="hljs-type">int</span>, n, row <span class="hljs-type">int</span>, columns, diagonals1, diagonals2 <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">bool</span>)</span></span> &#123;<br>    <span class="hljs-comment">// å¦‚æœrow == n è¯´æ˜å·²ç»äº§ç”Ÿäº†ä¸€ä¸ªæ­£ç¡®ç­”æ¡ˆ</span><br>    <span class="hljs-keyword">if</span> row == n &#123;<br>        board := generateBoard(queens, n)<br>        solutions = <span class="hljs-built_in">append</span>(solutions, board)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-comment">// é’ˆå¯¹å½“å‰ç¬¬rowè¡Œï¼Œæšä¸¾æ¯ä¸ªåˆ—çš„ä½ç½®ï¼Œåˆ¤æ–­æ—¶å€™èƒ½æ”¾ç½®çš‡å</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;<br>        <span class="hljs-comment">// å¦‚æœè¯¥åˆ—å·²ç»æ”¾ç½®äº†çš‡åï¼Œç»§ç»­ä¸‹ä¸€åˆ—</span><br>        <span class="hljs-keyword">if</span> columns[i] &#123;<br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-comment">// å¦‚æœå¯¹è§’å·²ç»æ”¾ç½®äº†çš‡åï¼Œç»§ç»­ä¸‹ä¸€åˆ—</span><br>        diag1 := row - i<br>        <span class="hljs-keyword">if</span> diagonals1[diag1] &#123;<br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        diag2 := row + i<br>        <span class="hljs-keyword">if</span> diagonals2[diag2] &#123;<br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-comment">// è®°å½•ç¬¬rowè¡Œçš„çš‡åæ”¾ç½®ä½ç½®</span><br>        queens[row] = i<br>        <span class="hljs-comment">// æ ‡è®°ç¬¬iåˆ—å·²ç»æ”¾ç½®çš‡å</span><br>        columns[i] = <span class="hljs-literal">true</span><br>        <span class="hljs-comment">// æ ‡è®°å¯¹åº”çš„å¯¹è§’å·²ç»æ”¾ç½®äº†çš‡å</span><br>        diagonals1[diag1] = <span class="hljs-literal">true</span><br>        diagonals2[diag2] = <span class="hljs-literal">true</span><br><br>        <span class="hljs-comment">// åœ¨ç¬¬rowè¡Œæ”¾ç½®äº†ä¸€ä¸ªä½ç½®ä¹‹åï¼Œç»§ç»­è¿›è¡Œä¸‹ä¸€è¡Œåˆ¤æ–­</span><br>        backtrack(queens, n, row+<span class="hljs-number">1</span>, columns, diagonals1, diagonals2)<br><br>        <span class="hljs-comment">// æ¢å¤åŸæœ¬çŠ¶æ€ï¼Œç»§ç»­å¯»æ‰¾ç¬¬rowè¡Œçš„ä¸‹ä¸€ä¸ªè§£</span><br>        queens[row] = <span class="hljs-number">-1</span><br>        <span class="hljs-built_in">delete</span>(columns, i)<br>        <span class="hljs-built_in">delete</span>(diagonals1, diag1)<br>        <span class="hljs-built_in">delete</span>(diagonals2, diag2)<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">generateBoard</span><span class="hljs-params">(queens []<span class="hljs-type">int</span>, n <span class="hljs-type">int</span>)</span></span> []<span class="hljs-type">string</span> &#123;<br>    board := []<span class="hljs-type">string</span>&#123;&#125;<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;<br>        row := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, n)<br>        <span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; n; j++ &#123;<br>            row[j] = <span class="hljs-string">&#x27;.&#x27;</span><br>        &#125;<br>        row[queens[i]] = <span class="hljs-string">&#x27;Q&#x27;</span><br>        board = <span class="hljs-built_in">append</span>(board, <span class="hljs-type">string</span>(row))<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> board<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="153-å¯»æ‰¾æ—‹è½¬æ’åºæ•°ç»„ä¸­çš„æœ€å°å€¼"><a href="#153-å¯»æ‰¾æ—‹è½¬æ’åºæ•°ç»„ä¸­çš„æœ€å°å€¼" class="headerlink" title="153. å¯»æ‰¾æ—‹è½¬æ’åºæ•°ç»„ä¸­çš„æœ€å°å€¼"></a><a href="https://leetcode.cn/problems/find-minimum-in-rotated-sorted-array/">153. å¯»æ‰¾æ—‹è½¬æ’åºæ•°ç»„ä¸­çš„æœ€å°å€¼</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// æ ¸å¿ƒæ€æƒ³ï¼šå¦‚æœå³åŠè¾¹å‡åºï¼Œåˆ™æœ€å°å€¼ä¸€å®šåœ¨å·¦åŠè¾¹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">findMin</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    low := <span class="hljs-number">0</span><br>    high := <span class="hljs-built_in">len</span>(nums) - <span class="hljs-number">1</span><br>    <br>    <span class="hljs-keyword">for</span> low &lt; high &#123;<br>        mid := (low + high) / <span class="hljs-number">2</span><br>        <span class="hljs-keyword">if</span> nums[mid] &lt; nums[high] &#123;<br>            high = mid<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            low = mid + <span class="hljs-number">1</span><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> nums[low]<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="739-æ¯æ—¥æ¸©åº¦"><a href="#739-æ¯æ—¥æ¸©åº¦" class="headerlink" title="739. æ¯æ—¥æ¸©åº¦"></a><a href="https://leetcode.cn/problems/daily-temperatures/">739. æ¯æ—¥æ¸©åº¦</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">dailyTemperatures</span><span class="hljs-params">(temperatures []<span class="hljs-type">int</span>)</span></span> []<span class="hljs-type">int</span> &#123;<br>    n := <span class="hljs-built_in">len</span>(temperatures)<br>    ans := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, n)<br>    stack := []<span class="hljs-type">int</span>&#123;&#125;<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;<br>        t := temperatures[i]<br>        <span class="hljs-keyword">for</span> <span class="hljs-built_in">len</span>(stack) &gt; <span class="hljs-number">0</span> &amp;&amp; t &gt; temperatures[stack[<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>]] &#123;<br>            idx := stack[<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>]<br>            stack = stack[:<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>]<br>            ans[idx] = i - idx<br>        &#125;<br>        stack = <span class="hljs-built_in">append</span>(stack, i)<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> ans<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="347-å‰-K-ä¸ªé«˜é¢‘å…ƒç´ "><a href="#347-å‰-K-ä¸ªé«˜é¢‘å…ƒç´ " class="headerlink" title="347. å‰ K ä¸ªé«˜é¢‘å…ƒç´ "></a><a href="https://leetcode.cn/problems/top-k-frequent-elements/">347. å‰ K ä¸ªé«˜é¢‘å…ƒç´ </a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">topKFrequent</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>, k <span class="hljs-type">int</span>)</span></span> []<span class="hljs-type">int</span> &#123;<br>    occur := <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>&#123;&#125;<br>    <span class="hljs-keyword">for</span> _, num := <span class="hljs-keyword">range</span> nums &#123;<br>        occur[num]++<br>    &#125;<br><br>    h := &amp;IHeap&#123;&#125;<br>    heap.Init(h)<br><br>    <span class="hljs-keyword">for</span> key, value := <span class="hljs-keyword">range</span> occur &#123;<br>        heap.Push(h, [<span class="hljs-number">2</span>]<span class="hljs-type">int</span>&#123;key, value&#125;)<br>        <span class="hljs-keyword">if</span> h.Len() &gt; k &#123;<br>            heap.Pop(h)<br>        &#125;<br>    &#125;<br>    ret := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, k)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; k; i++ &#123;<br>        ret[k-i<span class="hljs-number">-1</span>] = heap.Pop(h).([<span class="hljs-number">2</span>]<span class="hljs-type">int</span>)[<span class="hljs-number">0</span>]<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> ret<br>&#125;<br><br><span class="hljs-keyword">type</span> IHeap [][<span class="hljs-number">2</span>]<span class="hljs-type">int</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h IHeap)</span></span> Len() <span class="hljs-type">int</span> &#123;<span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(h)&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h IHeap)</span></span> Less(i, j <span class="hljs-type">int</span>) <span class="hljs-type">bool</span> &#123;<span class="hljs-keyword">return</span> h[i][<span class="hljs-number">1</span>] &lt; h[j][<span class="hljs-number">1</span>]&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h IHeap)</span></span> Swap(i, j <span class="hljs-type">int</span>) &#123;h[i], h[j] = h[j], h[i]&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h *IHeap)</span></span> Push(x <span class="hljs-keyword">interface</span>&#123;&#125;) &#123;<br>    *h = <span class="hljs-built_in">append</span>(*h, x.([<span class="hljs-number">2</span>]<span class="hljs-type">int</span>))<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h *IHeap)</span></span> Pop() <span class="hljs-keyword">interface</span>&#123;&#125; &#123;<br>    old := *h<br>    n := <span class="hljs-built_in">len</span>(old)<br>    x := old[n<span class="hljs-number">-1</span>]<br>    *h = old[<span class="hljs-number">0</span>: n<span class="hljs-number">-1</span>]<br>    <span class="hljs-keyword">return</span> x<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="295-æ•°æ®æµçš„ä¸­ä½æ•°"><a href="#295-æ•°æ®æµçš„ä¸­ä½æ•°" class="headerlink" title="295. æ•°æ®æµçš„ä¸­ä½æ•°"></a><a href="https://leetcode.cn/problems/find-median-from-data-stream/">295. æ•°æ®æµçš„ä¸­ä½æ•°</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> MedianFinder <span class="hljs-keyword">struct</span> &#123;<br>    maxHeap *MaxHeap <span class="hljs-comment">// å­˜å‚¨è¾ƒå°çš„ä¸€åŠæ•°å­—</span><br>    minHeap *MinHeap <span class="hljs-comment">// å­˜å‚¨è¾ƒå¤§çš„ä¸€åŠæ•°å­—</span><br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Constructor</span><span class="hljs-params">()</span></span> MedianFinder &#123;<br>    mf := MedianFinder&#123;<br>        maxHeap: &amp;MaxHeap&#123;&#125;,<br>        minHeap: &amp;MinHeap&#123;&#125;,<br>    &#125;<br>    heap.Init(mf.maxHeap)<br>    heap.Init(mf.minHeap)<br>    <span class="hljs-keyword">return</span> mf<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *MedianFinder)</span></span> AddNum(num <span class="hljs-type">int</span>)  &#123;<br>    <span class="hljs-comment">// æ€»æ˜¯å…ˆåŠ å…¥æœ€å¤§å †</span><br>    heap.Push(this.maxHeap, num)<br><br>    <span class="hljs-comment">// å°†æœ€å¤§å †çš„æœ€å¤§å€¼ç§»åˆ°æœ€å°å †</span><br>    heap.Push(this.minHeap, heap.Pop(this.maxHeap))<br><br>    <span class="hljs-comment">// å¦‚æœæœ€å¤§å †çš„å¤§å°å°äºæœ€å°å †ï¼Œå¹³è¡¡ä¸¤ä¸ªå †</span><br>    <span class="hljs-keyword">if</span> this.maxHeap.Len() &lt; this.minHeap.Len() &#123;<br>        heap.Push(this.maxHeap, heap.Pop(this.minHeap))<br>    &#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *MedianFinder)</span></span> FindMedian() <span class="hljs-type">float64</span> &#123;<br>    <span class="hljs-keyword">if</span> this.maxHeap.Len() == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> <span class="hljs-comment">// æˆ–è€…æ ¹æ®éœ€æ±‚è¿”å›å…¶ä»–é»˜è®¤å€¼</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> this.maxHeap.Len() &gt; this.minHeap.Len() &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-type">float64</span>((*this.maxHeap)[<span class="hljs-number">0</span>])<br>    &#125;<br>    <span class="hljs-keyword">return</span> (<span class="hljs-type">float64</span>((*this.maxHeap)[<span class="hljs-number">0</span>]) + <span class="hljs-type">float64</span>((*this.minHeap)[<span class="hljs-number">0</span>])) / <span class="hljs-number">2</span><br>&#125;<br><br><span class="hljs-comment">// æœ€å¤§å †ï¼ˆå­˜å‚¨è¾ƒå°çš„ä¸€åŠæ•°å­—ï¼‰</span><br><span class="hljs-keyword">type</span> MaxHeap []<span class="hljs-type">int</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h MaxHeap)</span></span> Len() <span class="hljs-type">int</span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(h)&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h MaxHeap)</span></span> Less(i, j <span class="hljs-type">int</span>) <span class="hljs-type">bool</span> &#123; <span class="hljs-keyword">return</span> h[i] &gt; h[j]&#125; <span class="hljs-comment">// æ³¨æ„è¿™é‡Œæ˜¯ &gt;ï¼Œå®ç°æœ€å¤§å †</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h MaxHeap)</span></span> Swap(i, j <span class="hljs-type">int</span>) &#123; h[i], h[j] = h[j], h[i]&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h *MaxHeap)</span></span> Push(x any) &#123;*h = <span class="hljs-built_in">append</span>(*h, x.(<span class="hljs-type">int</span>))&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h *MaxHeap)</span></span> Pop() any &#123;<br>    old := *h<br>    n := <span class="hljs-built_in">len</span>(old)<br>    x := old[n<span class="hljs-number">-1</span>]<br>    *h = old[<span class="hljs-number">0</span>:n<span class="hljs-number">-1</span>]<br>    <span class="hljs-keyword">return</span> x<br>&#125;<br><br><span class="hljs-comment">// æœ€å°å †ï¼ˆå­˜å‚¨è¾ƒå¤§çš„ä¸€åŠæ•°å­—ï¼‰</span><br><span class="hljs-keyword">type</span> MinHeap []<span class="hljs-type">int</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h MinHeap)</span></span> Len() <span class="hljs-type">int</span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(h)&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h MinHeap)</span></span> Less(i, j <span class="hljs-type">int</span>) <span class="hljs-type">bool</span> &#123; <span class="hljs-keyword">return</span> h[i] &lt; h[j]&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h MinHeap)</span></span> Swap(i, j <span class="hljs-type">int</span>) &#123; h[i], h[j] = h[j], h[i]&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h *MinHeap)</span></span> Push(x any) &#123;*h = <span class="hljs-built_in">append</span>(*h, x.(<span class="hljs-type">int</span>))&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h *MinHeap)</span></span> Pop() any &#123;<br>    old := *h<br>    n := <span class="hljs-built_in">len</span>(old)<br>    x := old[n<span class="hljs-number">-1</span>]<br>    *h = old[<span class="hljs-number">0</span>:n<span class="hljs-number">-1</span>]<br>    <span class="hljs-keyword">return</span> x<br>&#125;<br><br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Your MedianFinder object will be instantiated and called as such:</span><br><span class="hljs-comment"> * obj := Constructor();</span><br><span class="hljs-comment"> * obj.AddNum(num);</span><br><span class="hljs-comment"> * param_2 := obj.FindMedian();</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h2 id="516-æœ€é•¿å›æ–‡å­åºåˆ—"><a href="#516-æœ€é•¿å›æ–‡å­åºåˆ—" class="headerlink" title="516. æœ€é•¿å›æ–‡å­åºåˆ—"></a><a href="https://leetcode.cn/problems/longest-palindromic-subsequence/">516. æœ€é•¿å›æ–‡å­åºåˆ—</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">longestPalindromeSubseq</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    n := <span class="hljs-built_in">len</span>(s)<br>    dp := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">int</span>, n)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> dp &#123;<br>        dp[i] = <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, n)<br>    &#125;<br>    <span class="hljs-keyword">for</span> i := n - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i-- &#123;<br>        dp[i][i] = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">for</span> j := i + <span class="hljs-number">1</span>; j &lt; n; j++ &#123;<br>            <span class="hljs-keyword">if</span> s[i] == s[j] &#123;<br>                dp[i][j] = dp[i+<span class="hljs-number">1</span>][j<span class="hljs-number">-1</span>] + <span class="hljs-number">2</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                dp[i][j] = max(dp[i][j<span class="hljs-number">-1</span>], dp[i+<span class="hljs-number">1</span>][j])<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> dp[<span class="hljs-number">0</span>][n<span class="hljs-number">-1</span>]<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>golangåç¨‹ç»ƒä¹ é¢˜</title>
    <link href="/2025/07/24/golang%E5%8D%8F%E7%A8%8B%E7%BB%83%E4%B9%A0%E9%A2%98/"/>
    <url>/2025/07/24/golang%E5%8D%8F%E7%A8%8B%E7%BB%83%E4%B9%A0%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h1 id="äº¤æ›¿æ‰“å°"><a href="#äº¤æ›¿æ‰“å°" class="headerlink" title="äº¤æ›¿æ‰“å°"></a>äº¤æ›¿æ‰“å°</h1><p>å¯åŠ¨ä¸‰ä¸ªåç¨‹ï¼Œäº¤æ›¿æ‰“å°1ã€2ã€3ã€3ã€2ã€1ã€1ã€2ã€3â€¦</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>mysql</title>
    <link href="/2025/07/17/mysql/"/>
    <url>/2025/07/17/mysql/</url>
    
    <content type="html"><![CDATA[<h1 id="mysqlå­¦ä¹ ç¬”è®°"><a href="#mysqlå­¦ä¹ ç¬”è®°" class="headerlink" title="mysqlå­¦ä¹ ç¬”è®°"></a>mysqlå­¦ä¹ ç¬”è®°</h1><h2 id="æ‰§è¡Œæµç¨‹"><a href="#æ‰§è¡Œæµç¨‹" class="headerlink" title="æ‰§è¡Œæµç¨‹"></a>æ‰§è¡Œæµç¨‹</h2><p><img src="/2025/07/17/mysql/mysql%E6%9F%A5%E8%AF%A2%E6%B5%81%E7%A8%8B.png" alt="æŸ¥è¯¢è¯­å¥æ‰§è¡Œæµç¨‹"></p><h2 id="è¿æ¥å™¨"><a href="#è¿æ¥å™¨" class="headerlink" title="è¿æ¥å™¨"></a>è¿æ¥å™¨</h2><h3 id="è¿æ¥mysql"><a href="#è¿æ¥mysql" class="headerlink" title="è¿æ¥mysql"></a>è¿æ¥mysql</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">mysql -h$ip -u$<span class="hljs-keyword">user</span> <span class="hljs-title">-p</span><br></code></pre></td></tr></table></figure><p>è¿æ¥çš„è¿‡ç¨‹éœ€è¦å…ˆç»è¿‡ TCP ä¸‰æ¬¡æ¡æ‰‹</p><h3 id="æƒé™"><a href="#æƒé™" class="headerlink" title="æƒé™"></a>æƒé™</h3><p>è¿æ¥ä¸Šä¹‹åï¼Œè¿æ¥å™¨å°±ä¼šè·å–åˆ°ç”¨æˆ·çš„æƒé™ï¼Œç„¶åä¿å­˜èµ·æ¥ï¼Œåç»­è¯¥ç”¨æˆ·åœ¨æ­¤è¿æ¥é‡Œçš„ä»»ä½•æ“ä½œéƒ½ä¼šåŸºäºå¼€å§‹æ—¶è¯»åˆ°çš„æƒé™è¿›è¡Œåˆ¤æ–­ï¼Œè‹¥ç®¡ç†å‘˜ä¸­é€”ä¿®æ”¹äº†æƒé™ï¼Œä¹Ÿä¸ä¼šå½±å“å·²ç»å­˜åœ¨çš„è¿æ¥ï¼Œåªä¼šå½±å“æ–°å»ºç«‹çš„è¿æ¥ã€‚</p><h3 id="æŸ¥çœ‹mysqlæœåŠ¡è¢«å¤šå°‘ä¸ªå®¢æˆ·ç«¯è¿æ¥"><a href="#æŸ¥çœ‹mysqlæœåŠ¡è¢«å¤šå°‘ä¸ªå®¢æˆ·ç«¯è¿æ¥" class="headerlink" title="æŸ¥çœ‹mysqlæœåŠ¡è¢«å¤šå°‘ä¸ªå®¢æˆ·ç«¯è¿æ¥"></a>æŸ¥çœ‹mysqlæœåŠ¡è¢«å¤šå°‘ä¸ªå®¢æˆ·ç«¯è¿æ¥</h3><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">show <span class="hljs-built_in">processlist</span><br></code></pre></td></tr></table></figure><h3 id="ç©ºé—²è¿æ¥ä¼šä¸€ç›´å ç”¨å—"><a href="#ç©ºé—²è¿æ¥ä¼šä¸€ç›´å ç”¨å—" class="headerlink" title="ç©ºé—²è¿æ¥ä¼šä¸€ç›´å ç”¨å—"></a>ç©ºé—²è¿æ¥ä¼šä¸€ç›´å ç”¨å—</h3><p>ä¸æ˜¯ï¼Œç”±wait_timeoutå‚æ•°æ§åˆ¶ï¼Œé»˜è®¤8å°æ—¶</p><h3 id="æ‰‹åŠ¨æ–­å¼€è¿æ¥"><a href="#æ‰‹åŠ¨æ–­å¼€è¿æ¥" class="headerlink" title="æ‰‹åŠ¨æ–­å¼€è¿æ¥"></a>æ‰‹åŠ¨æ–­å¼€è¿æ¥</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">kill</span> connection +<span class="hljs-built_in">id</span><br></code></pre></td></tr></table></figure><h3 id="è¿æ¥æ•°æœ‰é™åˆ¶å—"><a href="#è¿æ¥æ•°æœ‰é™åˆ¶å—" class="headerlink" title="è¿æ¥æ•°æœ‰é™åˆ¶å—"></a>è¿æ¥æ•°æœ‰é™åˆ¶å—</h3><p>æœ‰ï¼Œç”±max_connections å‚æ•°æ§åˆ¶ï¼Œé»˜è®¤151ä¸ª</p><h3 id="çŸ­è¿æ¥ã€é•¿è¿æ¥"><a href="#çŸ­è¿æ¥ã€é•¿è¿æ¥" class="headerlink" title="çŸ­è¿æ¥ã€é•¿è¿æ¥"></a>çŸ­è¿æ¥ã€é•¿è¿æ¥</h3><p>æ¨èä½¿ç”¨é•¿è¿æ¥ï¼Œå‡å°‘è¿æ¥çš„æ¡æ‰‹å¼€é”€</p><p>mysqlä½¿ç”¨å†…å­˜ç®¡ç†è¿æ¥ï¼Œè¿æ¥æ•°é‡è¿‡å¤šä¼šæ¶ˆè€—å†…å­˜ç©ºé—´ï¼ŒæœåŠ¡æœ‰å¯èƒ½è¢«å¼ºåˆ¶æ€æ­»</p><h3 id="æ€ä¹ˆè§£å†³é•¿è¿æ¥å ç”¨å†…å­˜é—®é¢˜"><a href="#æ€ä¹ˆè§£å†³é•¿è¿æ¥å ç”¨å†…å­˜é—®é¢˜" class="headerlink" title="æ€ä¹ˆè§£å†³é•¿è¿æ¥å ç”¨å†…å­˜é—®é¢˜"></a>æ€ä¹ˆè§£å†³é•¿è¿æ¥å ç”¨å†…å­˜é—®é¢˜</h3><p>å®šæœŸæ–­å¼€é•¿è¿æ¥</p><p>å®¢æˆ·ç«¯ä¸»åŠ¨é‡ç½®è¿æ¥ï¼Œä¼šå°†è¿æ¥é‡ç½®ä¸ºåˆšåˆ›å»ºæ—¶çš„çŠ¶æ€ï¼Œé‡Šæ”¾å¤šä½™çš„å†…å­˜ã€‚</p><h2 id="æŸ¥è¯¢ç¼“å­˜"><a href="#æŸ¥è¯¢ç¼“å­˜" class="headerlink" title="æŸ¥è¯¢ç¼“å­˜"></a>æŸ¥è¯¢ç¼“å­˜</h2><h3 id="ç¼“å­˜"><a href="#ç¼“å­˜" class="headerlink" title="ç¼“å­˜"></a>ç¼“å­˜</h3><p>åªæœ‰selectè¯­å¥æ‰ä¼šå»æŸ¥è¯¢ç¼“å­˜ï¼Œç¼“å­˜æ˜¯ä»¥keyï¼Œvalueçš„å½¢å¼ä¿å­˜åœ¨å†…å­˜ä¸­çš„ï¼Œkeyä¸ºsqlæŸ¥è¯¢è¯­å¥ï¼Œvalueä¸ºsqlè¯­å¥çš„æŸ¥è¯¢ç»“æœ</p><p>å½“æ•°æ®åº“ä¸­æœ‰æ›´æ–°æ“ä½œæ—¶ï¼Œä¼šæ¸…ç©ºæŸ¥è¯¢ç¼“å­˜</p><p>mysqlåœ¨8.0ç‰ˆæœ¬å»æ‰äº†æŸ¥è¯¢ç¼“å­˜</p><h2 id="è§£æSQL"><a href="#è§£æSQL" class="headerlink" title="è§£æSQL"></a>è§£æSQL</h2><h3 id="è§£æå™¨"><a href="#è§£æå™¨" class="headerlink" title="è§£æå™¨"></a>è§£æå™¨</h3><h4 id="è¯æ³•åˆ†æ"><a href="#è¯æ³•åˆ†æ" class="headerlink" title="è¯æ³•åˆ†æ"></a>è¯æ³•åˆ†æ</h4><p>è¯†åˆ«å…³é”®å­—å’Œéå…³é”®å­—</p><table><thead><tr><th>å…³é”®å­—</th><th>éå…³é”®å­—</th><th>å…³é”®å­—</th><th>éå…³é”®å­—</th></tr></thead><tbody><tr><td>select</td><td>username</td><td>from</td><td>userinfo</td></tr></tbody></table><h4 id="è¯­æ³•åˆ†æ"><a href="#è¯­æ³•åˆ†æ" class="headerlink" title="è¯­æ³•åˆ†æ"></a>è¯­æ³•åˆ†æ</h4><p>å»ºç«‹è¯­æ³•æ ‘ï¼Œæ–¹ä¾¿åç»­æ¨¡å—è·å–sqlç±»å‹ï¼Œè¡¨åï¼Œå­—æ®µå</p><p><img src="/2025/07/17/mysql/db-mysql-sql-parser-2.png" alt="img"></p><h2 id="æ‰§è¡Œsql"><a href="#æ‰§è¡Œsql" class="headerlink" title="æ‰§è¡Œsql"></a>æ‰§è¡Œsql</h2><p>ä¸‰ä¸ªé˜¶æ®µ</p><p>prepareï¼Œé¢„å¤„ç†</p><p>optimizeï¼Œä¼˜åŒ–</p><p>executeï¼Œæ‰§è¡Œ</p><h3 id="é¢„å¤„ç†å™¨"><a href="#é¢„å¤„ç†å™¨" class="headerlink" title="é¢„å¤„ç†å™¨"></a>é¢„å¤„ç†å™¨</h3><ul><li>æ£€æŸ¥sqlæŸ¥è¯¢è¯­å¥ä¸­çš„è¡¨æˆ–è€…å­—æ®µæ˜¯å¦å­˜åœ¨</li><li>å°†select *ä¸­çš„æ˜Ÿå·æ‰©å±•ä¸ºè¡¨ä¸Šçš„æ‰€æœ‰åˆ—</li></ul><h3 id="ä¼˜åŒ–å™¨"><a href="#ä¼˜åŒ–å™¨" class="headerlink" title="ä¼˜åŒ–å™¨"></a>ä¼˜åŒ–å™¨</h3><p>ä¼˜åŒ–å™¨è´Ÿè´£ç¡®å®šæ‰§è¡Œæ–¹æ¡ˆï¼Œæ¯”å¦‚å…·ä½“ä½¿ç”¨å“ªä¸ªç´¢å¼•</p><h3 id="æ‰§è¡Œå™¨"><a href="#æ‰§è¡Œå™¨" class="headerlink" title="æ‰§è¡Œå™¨"></a>æ‰§è¡Œå™¨</h3><p>æ‰§è¡Œå™¨è°ƒç”¨å­˜å‚¨å¼•æ“çš„æ¥å£æŸ¥è¯¢æ•°æ®ï¼Œæ¯æ¥æ”¶åˆ°ä¸€æ¡å­˜å‚¨å¼•æ“å‘æ¥çš„æ•°æ®åéƒ½ä¼šåˆ¤æ–­æ˜¯å¦ç¬¦åˆæ¡ä»¶ï¼Œç¬¦åˆçš„è¯å°±å‘é€ç»™å®¢æˆ·ç«¯ï¼Œç„¶åå†å‘å­˜å‚¨å¼•æ“æŸ¥è¯¢ä¸‹ä¸€æ¡æ•°æ®ã€‚</p><p>ä¸‰ç§æ‰§è¡Œæ–¹å¼ï¼š</p><p>ä¸»é”®ç´¢å¼•æŸ¥è¯¢</p><p>å…¨è¡¨æ‰«æ</p><p>ç´¢å¼•ä¸‹æ¨ï¼šå­˜å‚¨å¼•æ“åœ¨äºŒçº§ç´¢å¼•ä¸­è¿›è¡ŒæŸ¥è¯¢æ—¶ï¼Œå®šä½åˆ°ä¸€æ¡æ•°æ®åï¼Œå…ˆä¸æ‰§è¡Œå›è¡¨æ“ä½œï¼Œè€Œæ˜¯åˆ¤æ–­ä¸€ä¸‹è¯¥äºŒçº§ç´¢å¼•çš„b+æ ‘ä¸­åŒ…å«çš„å…¶ä»–ç´¢å¼•æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼Œè‹¥ä¸æ»¡è¶³ï¼Œåˆ™æ²¡æœ‰å¿…è¦å›è¡¨æŸ¥è¯¢äº†ï¼Œç›´æ¥è·³è¿‡ã€‚</p><h2 id="äº‹åŠ¡çš„å››å¤§ç‰¹æ€§"><a href="#äº‹åŠ¡çš„å››å¤§ç‰¹æ€§" class="headerlink" title="äº‹åŠ¡çš„å››å¤§ç‰¹æ€§"></a>äº‹åŠ¡çš„å››å¤§ç‰¹æ€§</h2><p>åŸå­æ€§ï¼šè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥</p><p>ä¸€è‡´æ€§ï¼šäº‹åŠ¡å®Œæˆæ—¶ï¼Œæ‰€æœ‰æ•°æ®è¦ä¿æŒä¸€è‡´çš„çŠ¶æ€</p><p>éš”ç¦»æ€§ï¼šåœ¨ç‹¬ç«‹ç¯å¢ƒä¸‹è¿è¡Œï¼Œä¸å—å¤–éƒ¨å¹¶å‘æ“ä½œçš„å½±å“</p><p>æŒä¹…æ€§ï¼šäº‹åŠ¡ä¸€æ—¦æäº¤æˆ–å›æ»šï¼Œå¯¹æ•°æ®åº“ä¸­çš„æ•°æ®çš„æ”¹å˜æ˜¯æ°¸ä¹…çš„</p><h2 id="å¹¶å‘äº‹åŠ¡é—®é¢˜"><a href="#å¹¶å‘äº‹åŠ¡é—®é¢˜" class="headerlink" title="å¹¶å‘äº‹åŠ¡é—®é¢˜"></a>å¹¶å‘äº‹åŠ¡é—®é¢˜</h2><p>è„è¯»ï¼šä¸€ä¸ªäº‹åŠ¡è¯»åˆ°å¦ä¸€ä¸ªäº‹åŠ¡è¿˜æ²¡æäº¤çš„æ•°æ®</p><p>ä¸å¯é‡å¤è¯»ï¼šä¸€ä¸ªäº‹åŠ¡å…ˆåè¯»å–åŒä¸€æ¡è®°å½•ï¼Œä½†ä¸¤æ¬¡è¯»å–çš„æ•°æ®ä¸åŒ</p><p>å¹»è¯»ï¼šä¸€ä¸ªäº‹åŠ¡æŒ‰ç…§æ¡ä»¶æŸ¥è¯¢æ•°æ®çš„æ—¶å€™ï¼Œæ²¡æœ‰å¯¹åº”çš„æ•°æ®è¡Œï¼Œä½†æ˜¯åœ¨æ’å…¥æ•°æ®æ—¶ï¼Œåˆå‘ç°è¿™è¡Œæ•°æ®å·²ç»å­˜åœ¨ï¼Œå¥½åƒå‡ºç°äº†å¹»å½±</p><h2 id="äº‹åŠ¡éš”ç¦»çº§åˆ«"><a href="#äº‹åŠ¡éš”ç¦»çº§åˆ«" class="headerlink" title="äº‹åŠ¡éš”ç¦»çº§åˆ«"></a>äº‹åŠ¡éš”ç¦»çº§åˆ«</h2><p>ä¸ºäº†è§£å†³å¹¶å‘äº‹åŠ¡å‡ºç°çš„é—®é¢˜ï¼Œç³»ç»Ÿæ”¯æŒçš„éš”ç¦»çº§åˆ«ã€‚çº§åˆ«è¶Šé«˜ï¼Œæ•°æ®å®‰å…¨æ€§è¶Šé«˜ï¼Œå¹¶å‘äº‹åŠ¡é—®é¢˜è¶Šå°‘ï¼Œæ€§èƒ½è¶Šä½ã€‚</p><table><thead><tr><th>éš”ç¦»çº§åˆ«</th><th>è„è¯»</th><th>ä¸å¯é‡å¤è¯»</th><th>å¹»è¯»</th></tr></thead><tbody><tr><td>Read uncommitted</td><td>âˆš</td><td>âˆš</td><td>âˆš</td></tr><tr><td>Read committed</td><td>Ã—</td><td>âˆš</td><td>âˆš</td></tr><tr><td>Repeatable Readï¼ˆé»˜è®¤ï¼‰</td><td>Ã—</td><td>Ã—</td><td>âˆš</td></tr><tr><td>Serializable</td><td>Ã—</td><td>Ã—</td><td>Ã—</td></tr></tbody></table>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Goç®—æ³•é¢˜-å…­</title>
    <link href="/2025/06/12/Go%E7%AE%97%E6%B3%95%E9%A2%98-%E5%85%AD/"/>
    <url>/2025/06/12/Go%E7%AE%97%E6%B3%95%E9%A2%98-%E5%85%AD/</url>
    
    <content type="html"><![CDATA[<h1 id="Goç®—æ³•é¢˜-å…­"><a href="#Goç®—æ³•é¢˜-å…­" class="headerlink" title="Goç®—æ³•é¢˜-å…­"></a>Goç®—æ³•é¢˜-å…­</h1><h2 id="189-è½®è½¬æ•°ç»„"><a href="#189-è½®è½¬æ•°ç»„" class="headerlink" title="189. è½®è½¬æ•°ç»„"></a><a href="https://leetcode.cn/problems/rotate-array/">189. è½®è½¬æ•°ç»„</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">rotate</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>, k <span class="hljs-type">int</span>)</span></span>  &#123;<br>    k = k % <span class="hljs-built_in">len</span>(nums)<br>    reverse(nums)<br>    reverse(nums[:k])<br>    reverse(nums[k:])<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reverse</span><span class="hljs-params">(a []<span class="hljs-type">int</span>)</span></span> &#123;<br>    <span class="hljs-keyword">for</span> i, n := <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(a); i &lt; n / <span class="hljs-number">2</span>; i ++ &#123;<br>        a[i], a[n<span class="hljs-number">-1</span>-i] = a[n<span class="hljs-number">-1</span>-i], a[i]<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="73-çŸ©é˜µç½®é›¶"><a href="#73-çŸ©é˜µç½®é›¶" class="headerlink" title="73. çŸ©é˜µç½®é›¶"></a><a href="https://leetcode.cn/problems/set-matrix-zeroes/">73. çŸ©é˜µç½®é›¶</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">setZeroes</span><span class="hljs-params">(matrix [][]<span class="hljs-type">int</span>)</span></span>  &#123;<br>    row := <span class="hljs-built_in">make</span>([]<span class="hljs-type">bool</span>, <span class="hljs-built_in">len</span>(matrix))<br>    col := <span class="hljs-built_in">make</span>([]<span class="hljs-type">bool</span>, <span class="hljs-built_in">len</span>(matrix[<span class="hljs-number">0</span>]))<br><br>    <span class="hljs-keyword">for</span> i, r := <span class="hljs-keyword">range</span> matrix &#123;<br>        <span class="hljs-keyword">for</span> j, v := <span class="hljs-keyword">range</span> r &#123;<br>            <span class="hljs-keyword">if</span> v == <span class="hljs-number">0</span> &#123;<br>                row[i] = <span class="hljs-literal">true</span><br>                col[j] = <span class="hljs-literal">true</span><br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> i, r := <span class="hljs-keyword">range</span> matrix &#123;<br>        <span class="hljs-keyword">for</span> j := <span class="hljs-keyword">range</span> r &#123;<br>            <span class="hljs-keyword">if</span> row[i] || col[j] &#123;<br>                r[j] = <span class="hljs-number">0</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="138-éšæœºé“¾è¡¨çš„å¤åˆ¶"><a href="#138-éšæœºé“¾è¡¨çš„å¤åˆ¶" class="headerlink" title="138. éšæœºé“¾è¡¨çš„å¤åˆ¶"></a><a href="https://leetcode.cn/problems/copy-list-with-random-pointer/">138. éšæœºé“¾è¡¨çš„å¤åˆ¶</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a Node.</span><br><span class="hljs-comment"> * type Node struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *Node</span><br><span class="hljs-comment"> *     Random *Node</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">var</span> cachedNode <span class="hljs-keyword">map</span>[*Node]*Node<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">deepCopy</span><span class="hljs-params">(node *Node)</span></span> *Node &#123;<br>    <span class="hljs-keyword">if</span> node == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> n, has := cachedNode[node]; has &#123;<br>        <span class="hljs-keyword">return</span> n<br>    &#125;<br>    newNode := &amp;Node&#123;Val: node.Val&#125;<br>    cachedNode[node] = newNode<br>    newNode.Next = deepCopy(node.Next)<br>    newNode.Random = deepCopy(node.Random)<br>    <span class="hljs-keyword">return</span> newNode<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">copyRandomList</span><span class="hljs-params">(head *Node)</span></span> *Node &#123;<br>    cachedNode = <span class="hljs-keyword">map</span>[*Node]*Node&#123;&#125;<br>    <span class="hljs-keyword">return</span> deepCopy(head)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="108-å°†æœ‰åºæ•°ç»„è½¬æ¢ä¸ºäºŒå‰æœç´¢æ ‘"><a href="#108-å°†æœ‰åºæ•°ç»„è½¬æ¢ä¸ºäºŒå‰æœç´¢æ ‘" class="headerlink" title="108. å°†æœ‰åºæ•°ç»„è½¬æ¢ä¸ºäºŒå‰æœç´¢æ ‘"></a><a href="https://leetcode.cn/problems/convert-sorted-array-to-binary-search-tree/">108. å°†æœ‰åºæ•°ç»„è½¬æ¢ä¸ºäºŒå‰æœç´¢æ ‘</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sortedArrayToBST</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> *TreeNode &#123;<br>    <span class="hljs-keyword">return</span> helper(nums, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(nums)<span class="hljs-number">-1</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">helper</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>, left, right <span class="hljs-type">int</span>)</span></span> * TreeNode &#123;<br>    <span class="hljs-keyword">if</span> left &gt; right &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br>    mid := (left + right) / <span class="hljs-number">2</span><br>    root := &amp;TreeNode&#123;Val: nums[mid]&#125;<br>    root.Left = helper(nums, left, mid<span class="hljs-number">-1</span>)<br>    root.Right = helper(nums, mid+<span class="hljs-number">1</span>, right)<br>    <span class="hljs-keyword">return</span> root<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="114-äºŒå‰æ ‘å±•å¼€ä¸ºé“¾è¡¨"><a href="#114-äºŒå‰æ ‘å±•å¼€ä¸ºé“¾è¡¨" class="headerlink" title="114. äºŒå‰æ ‘å±•å¼€ä¸ºé“¾è¡¨"></a><a href="https://leetcode.cn/problems/flatten-binary-tree-to-linked-list/">114. äºŒå‰æ ‘å±•å¼€ä¸ºé“¾è¡¨</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">flatten</span><span class="hljs-params">(root *TreeNode)</span></span>  &#123;<br>    list := preorderTraversal(root)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; <span class="hljs-built_in">len</span>(list); i++ &#123;<br>        prev, curr := list[i<span class="hljs-number">-1</span>], list[i]<br>        prev.Left, prev.Right = <span class="hljs-literal">nil</span>, curr<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">preorderTraversal</span><span class="hljs-params">(root *TreeNode)</span></span> []*TreeNode &#123;<br>    list := []*TreeNode&#123;&#125;<br>    <span class="hljs-keyword">if</span> root != <span class="hljs-literal">nil</span> &#123;<br>        list = <span class="hljs-built_in">append</span>(list, root)<br>        list = <span class="hljs-built_in">append</span>(list, preorderTraversal(root.Left)...)<br>        list = <span class="hljs-built_in">append</span>(list, preorderTraversal(root.Right)...)<br>    &#125;<br>    <span class="hljs-keyword">return</span> list<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="437-è·¯å¾„æ€»å’Œ-III"><a href="#437-è·¯å¾„æ€»å’Œ-III" class="headerlink" title="437. è·¯å¾„æ€»å’Œ III"></a><a href="https://leetcode.cn/problems/path-sum-iii/">437. è·¯å¾„æ€»å’Œ III</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">pathSum</span><span class="hljs-params">(root *TreeNode, targetSum <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    ans := <span class="hljs-number">0</span><br>    preSum := <span class="hljs-keyword">map</span>[<span class="hljs-type">int64</span>]<span class="hljs-type">int</span>&#123;<span class="hljs-number">0</span>: <span class="hljs-number">1</span>&#125;<br>    <br>    <span class="hljs-keyword">var</span> dfs <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(*TreeNode, <span class="hljs-type">int64</span>)</span></span><br>    dfs = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(node *TreeNode, curr <span class="hljs-type">int64</span>)</span></span> &#123;<br>        <span class="hljs-keyword">if</span> node == <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        curr += <span class="hljs-type">int64</span>(node.Val)<br>        ans += preSum[curr-<span class="hljs-type">int64</span>(targetSum)]<br>        preSum[curr]++<br>        dfs(node.Left, curr)<br>        dfs(node.Right, curr)<br>        preSum[curr]--<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    dfs(root, <span class="hljs-number">0</span>)<br><br>    <span class="hljs-keyword">return</span> ans<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="994-è…çƒ‚çš„æ©˜å­"><a href="#994-è…çƒ‚çš„æ©˜å­" class="headerlink" title="994. è…çƒ‚çš„æ©˜å­"></a><a href="https://leetcode.cn/problems/rotting-oranges/">994. è…çƒ‚çš„æ©˜å­</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">orangesRotting</span><span class="hljs-params">(grid [][]<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-comment">// æ€»è¡Œæ•°</span><br>    R := <span class="hljs-built_in">len</span>(grid)<br>    <span class="hljs-comment">// æ€»åˆ—æ•°</span><br>    C := <span class="hljs-built_in">len</span>(grid[<span class="hljs-number">0</span>])<br><br>    <span class="hljs-comment">// ä¸Šä¸‹å·¦å³å››ä¸ªæ–¹å‘</span><br>    dr := []<span class="hljs-type">int</span>&#123;<span class="hljs-number">-1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>&#125;<br>    dc := []<span class="hljs-type">int</span>&#123;<span class="hljs-number">0</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>&#125;<br><br>    <span class="hljs-comment">// ç”¨äºè¾…åŠ©å±‚æ¬¡éå†</span><br>    queue := []<span class="hljs-type">int</span>&#123;&#125;<br><br>    <span class="hljs-comment">// ç”¨äºè®°å½•åˆ°è¾¾æ¯ä¸ªç‚¹ä½å¯¹åº”çš„æ·±åº¦</span><br>    depth := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>)<br><br>    <span class="hljs-comment">// è®°å½•é¦–å±‚ç‚¹ä½ï¼Œæ·±åº¦å‡ä¸º0</span><br>    <span class="hljs-keyword">for</span> r := <span class="hljs-number">0</span>; r &lt; R; r++ &#123;<br>        <span class="hljs-keyword">for</span> c := <span class="hljs-number">0</span>; c &lt; C; c++ &#123;<br>            <span class="hljs-keyword">if</span> grid[r][c] == <span class="hljs-number">2</span> &#123;<br>                code := r * C + c<br>                queue = <span class="hljs-built_in">append</span>(queue, code)<br>                depth[code] = <span class="hljs-number">0</span><br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">// è¿›è¡Œå±‚åºéå†</span><br>    ans := <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> <span class="hljs-built_in">len</span>(queue) &gt; <span class="hljs-number">0</span> &#123;<br>        code := queue[<span class="hljs-number">0</span>]<br>        queue = queue[<span class="hljs-number">1</span>:]<br>        r := code / C<br>        c := code % C<br>        <span class="hljs-keyword">for</span> k := <span class="hljs-number">0</span>; k &lt; <span class="hljs-number">4</span>; k++ &#123;<br>            nr := r + dr[k]<br>            nc := c + dc[k]<br>            <span class="hljs-keyword">if</span> nr &gt;= <span class="hljs-number">0</span> &amp;&amp; nr &lt; R &amp;&amp; nc &gt;= <span class="hljs-number">0</span> &amp;&amp; nc &lt; C &amp;&amp; grid[nr][nc] == <span class="hljs-number">1</span> &#123;<br>                grid[nr][nc] = <span class="hljs-number">2</span><br>                ncode := nr * C + nc<br>                queue = <span class="hljs-built_in">append</span>(queue, ncode)<br>                depth[ncode] = depth[code] + <span class="hljs-number">1</span><br>                <span class="hljs-comment">// æ¯æ¬¡è¿›å…¥è¯¥ifæ¡ä»¶ï¼Œåˆ™æ„å‘³ç€åˆ°è¾¾äº†ä¸€ä¸ªæ–°é²œæ©˜å­ï¼Œæ·±åº¦åŠ 1</span><br>                ans = depth[ncode]<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ–°é²œæ©˜å­</span><br>    <span class="hljs-keyword">for</span> _, row := <span class="hljs-keyword">range</span> grid &#123;<br>        <span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> row &#123;<br>            <span class="hljs-keyword">if</span> v == <span class="hljs-number">1</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> ans<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="207-è¯¾ç¨‹è¡¨"><a href="#207-è¯¾ç¨‹è¡¨" class="headerlink" title="207. è¯¾ç¨‹è¡¨"></a><a href="https://leetcode.cn/problems/course-schedule/">207. è¯¾ç¨‹è¡¨</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">canFinish</span><span class="hljs-params">(numCourses <span class="hljs-type">int</span>, prerequisites [][]<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-comment">// è®°å½•æ‰€æœ‰èŠ‚ç‚¹çš„è¾¹ï¼Œedges[i]å«ä¹‰ä¸ºç¬¬iä¸ªèŠ‚ç‚¹æ‰€æŒ‡å‘çš„æ‰€æœ‰èŠ‚ç‚¹</span><br>    edges := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">int</span>, numCourses)<br>    <span class="hljs-comment">// è®°å½•æ¯ä¸ªèŠ‚ç‚¹çš„å…¥åº¦ï¼Œå³æœ‰å¤šå°‘ä¸ªèŠ‚ç‚¹æŒ‡å‘å®ƒ</span><br>    indeg := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, numCourses)<br>    <span class="hljs-comment">// è®°å½•æ‹“æ‰‘æ’åºï¼Œå¦‚æœæ‰€æœ‰èŠ‚ç‚¹å­˜åœ¨æ‹“æ‰‘æ’åºï¼Œåˆ™è¯¾ç¨‹èƒ½æ­£å¸¸ä¿®å®Œ</span><br>    result := []<span class="hljs-type">int</span>&#123;&#125;<br><br>    <span class="hljs-comment">// ä¿å­˜æ‰€æœ‰èŠ‚ç‚¹çš„è¾¹å’Œå…¥åº¦</span><br>    <span class="hljs-keyword">for</span> _, info := <span class="hljs-keyword">range</span> prerequisites &#123;<br>        edges[info[<span class="hljs-number">1</span>]] = <span class="hljs-built_in">append</span>(edges[info[<span class="hljs-number">1</span>]], info[<span class="hljs-number">0</span>])<br>        indeg[info[<span class="hljs-number">0</span>]]++<br>    &#125;<br><br>    <span class="hljs-comment">// å…ˆå°†å…¥åº¦ä¸º0çš„èŠ‚ç‚¹å…¥é˜Ÿ</span><br>    q := []<span class="hljs-type">int</span>&#123;&#125;<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; numCourses; i++ &#123;<br>        <span class="hljs-keyword">if</span> indeg[i] == <span class="hljs-number">0</span> &#123;<br>            q = <span class="hljs-built_in">append</span>(q, i)<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// å¹¿åº¦ä¼˜å…ˆæœç´¢</span><br>    <span class="hljs-keyword">for</span> <span class="hljs-built_in">len</span>(q) &gt; <span class="hljs-number">0</span> &#123;<br>        u := q[<span class="hljs-number">0</span>]<br>        q = q[<span class="hljs-number">1</span>:]<br>        result = <span class="hljs-built_in">append</span>(result, u)<br>        <span class="hljs-comment">// å°†uå…¥é˜Ÿåï¼Œæ£€æŸ¥uæŒ‡å‘çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œå°†å…¶å…¥åº¦å‡1</span><br>        <span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> edges[u] &#123;<br>            indeg[v]--<br>            <span class="hljs-keyword">if</span> indeg[v] == <span class="hljs-number">0</span> &#123;<br>                q = <span class="hljs-built_in">append</span>(q, v)<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(result) == numCourses<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="208-å®ç°-Trie-å‰ç¼€æ ‘"><a href="#208-å®ç°-Trie-å‰ç¼€æ ‘" class="headerlink" title="208. å®ç° Trie (å‰ç¼€æ ‘)"></a><a href="https://leetcode.cn/problems/implement-trie-prefix-tree/">208. å®ç° Trie (å‰ç¼€æ ‘)</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Trie <span class="hljs-keyword">struct</span> &#123;<br>    children [<span class="hljs-number">26</span>]*Trie<br>    isEnd <span class="hljs-type">bool</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Constructor</span><span class="hljs-params">()</span></span> Trie &#123;<br>    <span class="hljs-keyword">return</span> Trie&#123;&#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *Trie)</span></span> Insert(word <span class="hljs-type">string</span>)  &#123;<br>    node := this<br>    <span class="hljs-keyword">for</span> _, ch := <span class="hljs-keyword">range</span> word &#123;<br>        ch -= <span class="hljs-string">&#x27;a&#x27;</span><br>        <span class="hljs-keyword">if</span> node.children[ch] == <span class="hljs-literal">nil</span> &#123;<br>            node.children[ch] = &amp;Trie&#123;&#125;<br>        &#125;<br>        node = node.children[ch]<br>    &#125;<br>    node.isEnd = <span class="hljs-literal">true</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *Trie)</span></span> SearchPrefix(prefix <span class="hljs-type">string</span>) *Trie &#123;<br>    node := this<br>    <span class="hljs-keyword">for</span> _, ch := <span class="hljs-keyword">range</span> prefix &#123;<br>        ch -= <span class="hljs-string">&#x27;a&#x27;</span><br>        <span class="hljs-keyword">if</span> node.children[ch] == <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>        &#125;<br>        node = node.children[ch]<br>    &#125;<br>    <span class="hljs-keyword">return</span> node<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *Trie)</span></span> Search(word <span class="hljs-type">string</span>) <span class="hljs-type">bool</span> &#123;<br>    node := this.SearchPrefix(word)<br>    <span class="hljs-keyword">return</span> node != <span class="hljs-literal">nil</span> &amp;&amp; node.isEnd<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *Trie)</span></span> StartsWith(prefix <span class="hljs-type">string</span>) <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">return</span> this.SearchPrefix(prefix) != <span class="hljs-literal">nil</span><br>&#125;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Your Trie object will be instantiated and called as such:</span><br><span class="hljs-comment"> * obj := Constructor();</span><br><span class="hljs-comment"> * obj.Insert(word);</span><br><span class="hljs-comment"> * param_2 := obj.Search(word);</span><br><span class="hljs-comment"> * param_3 := obj.StartsWith(prefix);</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h2 id="79-å•è¯æœç´¢"><a href="#79-å•è¯æœç´¢" class="headerlink" title="79. å•è¯æœç´¢"></a><a href="https://leetcode.cn/problems/word-search/">79. å•è¯æœç´¢</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> pair <span class="hljs-keyword">struct</span>&#123;<br>    x <span class="hljs-type">int</span><br>    y <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-keyword">var</span> directions = []pair&#123;&#123;<span class="hljs-number">-1</span>, <span class="hljs-number">0</span>&#125;, &#123;<span class="hljs-number">1</span>, <span class="hljs-number">0</span>&#125;, &#123;<span class="hljs-number">0</span>, <span class="hljs-number">-1</span>&#125;, &#123;<span class="hljs-number">0</span>, <span class="hljs-number">1</span>&#125;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">exist</span><span class="hljs-params">(board [][]<span class="hljs-type">byte</span>, word <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>    R := <span class="hljs-built_in">len</span>(board)<br>    C := <span class="hljs-built_in">len</span>(board[<span class="hljs-number">0</span>])<br><br>    visit := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">bool</span>, R)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> visit &#123;<br>        visit[i] = <span class="hljs-built_in">make</span>([]<span class="hljs-type">bool</span>, C)<br>    &#125;<br><br>    <span class="hljs-keyword">var</span> check <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, j, k <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span><br>    check = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, j, k <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>        <span class="hljs-keyword">if</span> board[i][j] != word[k] &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>        &#125;<br><br>        <span class="hljs-keyword">if</span> k == <span class="hljs-built_in">len</span>(word) - <span class="hljs-number">1</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>        &#125;<br><br>        visit[i][j] = <span class="hljs-literal">true</span><br>        <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            visit[i][j] = <span class="hljs-literal">false</span><br>        &#125;()<br><br>        <span class="hljs-keyword">for</span> _, dir := <span class="hljs-keyword">range</span> directions &#123;<br>            newI := i + dir.x<br>            newJ := j + dir.y<br>            <span class="hljs-keyword">if</span> newI &gt;= <span class="hljs-number">0</span> &amp;&amp; newI &lt; R &amp;&amp; newJ &gt;= <span class="hljs-number">0</span> &amp;&amp; newJ &lt; C &amp;&amp; !visit[newI][newJ] &#123;<br>                <span class="hljs-keyword">if</span> check(newI, newJ, k+<span class="hljs-number">1</span>) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>    &#125;<br><br>    <span class="hljs-keyword">for</span> i, row := <span class="hljs-keyword">range</span> board &#123;<br>        <span class="hljs-keyword">for</span> j := <span class="hljs-keyword">range</span> row &#123;<br>            <span class="hljs-keyword">if</span> check(i, j, <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="131-åˆ†å‰²å›æ–‡ä¸²"><a href="#131-åˆ†å‰²å›æ–‡ä¸²" class="headerlink" title="131. åˆ†å‰²å›æ–‡ä¸²"></a><a href="https://leetcode.cn/problems/palindrome-partitioning/">131. åˆ†å‰²å›æ–‡ä¸²</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">partition</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> [][]<span class="hljs-type">string</span> &#123;<br>    n := <span class="hljs-built_in">len</span>(s)<br>    f := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">bool</span>, n)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> f &#123;<br>        f[i] = <span class="hljs-built_in">make</span>([]<span class="hljs-type">bool</span>, n)<br>        <span class="hljs-keyword">for</span> j := <span class="hljs-keyword">range</span> f[i] &#123;<br>            f[i][j] = <span class="hljs-literal">true</span><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> i := n - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i-- &#123;<br>        <span class="hljs-keyword">for</span> j := i + <span class="hljs-number">1</span>; j &lt; n; j++ &#123;<br>            f[i][j] = s[i] == s[j] &amp;&amp; f[i+<span class="hljs-number">1</span>][j<span class="hljs-number">-1</span>]<br>        &#125;<br>    &#125;<br><br>    ans := [][]<span class="hljs-type">string</span>&#123;&#125;<br><br>    splits := []<span class="hljs-type">string</span>&#123;&#125;<br>    <span class="hljs-keyword">var</span> dfs <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span></span><br>    dfs = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> &#123;<br>        <span class="hljs-keyword">if</span> i == n &#123;<br>            ans = <span class="hljs-built_in">append</span>(ans, <span class="hljs-built_in">append</span>([]<span class="hljs-type">string</span>(<span class="hljs-literal">nil</span>), splits...))<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-keyword">for</span> j := i; j &lt; n; j++ &#123;<br>            <span class="hljs-keyword">if</span> f[i][j] &#123;<br>                splits = <span class="hljs-built_in">append</span>(splits, s[i:j+<span class="hljs-number">1</span>])<br>                dfs(j+<span class="hljs-number">1</span>)<br>                <span class="hljs-comment">// æ”¾å¼ƒå½“å‰æ‹†åˆ†æ–¹æ¡ˆï¼Œå›é€€åˆ°åŸçŠ¶</span><br>                splits = splits[:<span class="hljs-built_in">len</span>(splits)<span class="hljs-number">-1</span>]<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    dfs(<span class="hljs-number">0</span>)<br><br>    <span class="hljs-keyword">return</span> ans<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="51-N-çš‡å"><a href="#51-N-çš‡å" class="headerlink" title="51. N çš‡å"></a><a href="https://leetcode.cn/problems/n-queens/">51. N çš‡å</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> solutions [][]<span class="hljs-type">string</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">solveNQueens</span><span class="hljs-params">(n <span class="hljs-type">int</span>)</span></span> [][]<span class="hljs-type">string</span> &#123;<br>    <span class="hljs-comment">// ä¿å­˜æœ€ç»ˆç»“æœ</span><br>    solutions = [][]<span class="hljs-type">string</span>&#123;&#125;<br>    <span class="hljs-comment">// è®°å½•æ¯ä¸€è¡Œçš„çš‡åæ”¾ç½®åœ¨å“ªä¸€åˆ—</span><br>    queens := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, n)<br>    <span class="hljs-comment">// åˆå§‹åŒ–</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;<br>        queens[i] = <span class="hljs-number">-1</span><br>    &#125;<br>    <span class="hljs-comment">// è®°å½•å“ªäº›åˆ—å·²ç»æ”¾ç½®äº†çš‡å</span><br>    columns := <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">bool</span>&#123;&#125;<br>    <span class="hljs-comment">// è®°å½•å“ªäº›å¯¹è§’å·²ç»æ”¾ç½®äº†çš‡å</span><br>    diagonals1 := <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">bool</span>&#123;&#125;<br>    diagonals2 := <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">bool</span>&#123;&#125;<br><br>    backtrack(queens, n, <span class="hljs-number">0</span>, columns, diagonals1, diagonals2)<br><br>    <span class="hljs-keyword">return</span> solutions<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">backtrack</span><span class="hljs-params">(queens []<span class="hljs-type">int</span>, n, row <span class="hljs-type">int</span>, columns, diagonals1, diagonals2 <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">bool</span>)</span></span> &#123;<br>    <span class="hljs-comment">// å¦‚æœrow == n è¯´æ˜å·²ç»äº§ç”Ÿäº†ä¸€ä¸ªæ­£ç¡®ç­”æ¡ˆ</span><br>    <span class="hljs-keyword">if</span> row == n &#123;<br>        board := generateBoard(queens, n)<br>        solutions = <span class="hljs-built_in">append</span>(solutions, board)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-comment">// é’ˆå¯¹å½“å‰ç¬¬rowè¡Œï¼Œæšä¸¾æ¯ä¸ªåˆ—çš„ä½ç½®ï¼Œåˆ¤æ–­æ—¶å€™èƒ½æ”¾ç½®çš‡å</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;<br>        <span class="hljs-comment">// å¦‚æœè¯¥åˆ—å·²ç»æ”¾ç½®äº†çš‡åï¼Œç»§ç»­ä¸‹ä¸€åˆ—</span><br>        <span class="hljs-keyword">if</span> columns[i] &#123;<br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-comment">// å¦‚æœå¯¹è§’å·²ç»æ”¾ç½®äº†çš‡åï¼Œç»§ç»­ä¸‹ä¸€åˆ—</span><br>        diag1 := row - i<br>        <span class="hljs-keyword">if</span> diagonals1[diag1] &#123;<br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        diag2 := row + i<br>        <span class="hljs-keyword">if</span> diagonals2[diag2] &#123;<br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-comment">// è®°å½•ç¬¬rowè¡Œçš„çš‡åæ”¾ç½®ä½ç½®</span><br>        queens[row] = i<br>        <span class="hljs-comment">// æ ‡è®°ç¬¬iåˆ—å·²ç»æ”¾ç½®çš‡å</span><br>        columns[i] = <span class="hljs-literal">true</span><br>        <span class="hljs-comment">// æ ‡è®°å¯¹åº”çš„å¯¹è§’å·²ç»æ”¾ç½®äº†çš‡å</span><br>        diagonals1[diag1] = <span class="hljs-literal">true</span><br>        diagonals2[diag2] = <span class="hljs-literal">true</span><br><br>        <span class="hljs-comment">// åœ¨ç¬¬rowè¡Œæ”¾ç½®äº†ä¸€ä¸ªä½ç½®ä¹‹åï¼Œç»§ç»­è¿›è¡Œä¸‹ä¸€è¡Œåˆ¤æ–­</span><br>        backtrack(queens, n, row+<span class="hljs-number">1</span>, columns, diagonals1, diagonals2)<br><br>        <span class="hljs-comment">// æ¢å¤åŸæœ¬çŠ¶æ€ï¼Œç»§ç»­å¯»æ‰¾ç¬¬rowè¡Œçš„ä¸‹ä¸€ä¸ªè§£</span><br>        queens[row] = <span class="hljs-number">-1</span><br>        <span class="hljs-built_in">delete</span>(columns, i)<br>        <span class="hljs-built_in">delete</span>(diagonals1, diag1)<br>        <span class="hljs-built_in">delete</span>(diagonals2, diag2)<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">generateBoard</span><span class="hljs-params">(queens []<span class="hljs-type">int</span>, n <span class="hljs-type">int</span>)</span></span> []<span class="hljs-type">string</span> &#123;<br>    board := []<span class="hljs-type">string</span>&#123;&#125;<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;<br>        row := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, n)<br>        <span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; n; j++ &#123;<br>            row[j] = <span class="hljs-string">&#x27;.&#x27;</span><br>        &#125;<br>        row[queens[i]] = <span class="hljs-string">&#x27;Q&#x27;</span><br>        board = <span class="hljs-built_in">append</span>(board, <span class="hljs-type">string</span>(row))<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> board<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="153-å¯»æ‰¾æ—‹è½¬æ’åºæ•°ç»„ä¸­çš„æœ€å°å€¼"><a href="#153-å¯»æ‰¾æ—‹è½¬æ’åºæ•°ç»„ä¸­çš„æœ€å°å€¼" class="headerlink" title="153. å¯»æ‰¾æ—‹è½¬æ’åºæ•°ç»„ä¸­çš„æœ€å°å€¼"></a><a href="https://leetcode.cn/problems/find-minimum-in-rotated-sorted-array/">153. å¯»æ‰¾æ—‹è½¬æ’åºæ•°ç»„ä¸­çš„æœ€å°å€¼</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// æ ¸å¿ƒæ€æƒ³ï¼šå¦‚æœå³åŠè¾¹å‡åºï¼Œåˆ™æœ€å°å€¼ä¸€å®šåœ¨å·¦åŠè¾¹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">findMin</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    low := <span class="hljs-number">0</span><br>    high := <span class="hljs-built_in">len</span>(nums) - <span class="hljs-number">1</span><br>    <br>    <span class="hljs-keyword">for</span> low &lt; high &#123;<br>        mid := (low + high) / <span class="hljs-number">2</span><br>        <span class="hljs-keyword">if</span> nums[mid] &lt; nums[high] &#123;<br>            high = mid<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            low = mid + <span class="hljs-number">1</span><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> nums[low]<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="739-æ¯æ—¥æ¸©åº¦"><a href="#739-æ¯æ—¥æ¸©åº¦" class="headerlink" title="739. æ¯æ—¥æ¸©åº¦"></a><a href="https://leetcode.cn/problems/daily-temperatures/">739. æ¯æ—¥æ¸©åº¦</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">dailyTemperatures</span><span class="hljs-params">(temperatures []<span class="hljs-type">int</span>)</span></span> []<span class="hljs-type">int</span> &#123;<br>    n := <span class="hljs-built_in">len</span>(temperatures)<br>    ans := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, n)<br>    stack := []<span class="hljs-type">int</span>&#123;&#125;<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;<br>        t := temperatures[i]<br>        <span class="hljs-keyword">for</span> <span class="hljs-built_in">len</span>(stack) &gt; <span class="hljs-number">0</span> &amp;&amp; t &gt; temperatures[stack[<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>]] &#123;<br>            idx := stack[<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>]<br>            stack = stack[:<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>]<br>            ans[idx] = i - idx<br>        &#125;<br>        stack = <span class="hljs-built_in">append</span>(stack, i)<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> ans<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="347-å‰-K-ä¸ªé«˜é¢‘å…ƒç´ "><a href="#347-å‰-K-ä¸ªé«˜é¢‘å…ƒç´ " class="headerlink" title="347. å‰ K ä¸ªé«˜é¢‘å…ƒç´ "></a><a href="https://leetcode.cn/problems/top-k-frequent-elements/">347. å‰ K ä¸ªé«˜é¢‘å…ƒç´ </a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">topKFrequent</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>, k <span class="hljs-type">int</span>)</span></span> []<span class="hljs-type">int</span> &#123;<br>    occur := <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>&#123;&#125;<br>    <span class="hljs-keyword">for</span> _, num := <span class="hljs-keyword">range</span> nums &#123;<br>        occur[num]++<br>    &#125;<br><br>    h := &amp;IHeap&#123;&#125;<br>    heap.Init(h)<br><br>    <span class="hljs-keyword">for</span> key, value := <span class="hljs-keyword">range</span> occur &#123;<br>        heap.Push(h, [<span class="hljs-number">2</span>]<span class="hljs-type">int</span>&#123;key, value&#125;)<br>        <span class="hljs-keyword">if</span> h.Len() &gt; k &#123;<br>            heap.Pop(h)<br>        &#125;<br>    &#125;<br>    ret := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, k)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; k; i++ &#123;<br>        ret[k-i<span class="hljs-number">-1</span>] = heap.Pop(h).([<span class="hljs-number">2</span>]<span class="hljs-type">int</span>)[<span class="hljs-number">0</span>]<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> ret<br>&#125;<br><br><span class="hljs-keyword">type</span> IHeap [][<span class="hljs-number">2</span>]<span class="hljs-type">int</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h IHeap)</span></span> Len() <span class="hljs-type">int</span> &#123;<span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(h)&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h IHeap)</span></span> Less(i, j <span class="hljs-type">int</span>) <span class="hljs-type">bool</span> &#123;<span class="hljs-keyword">return</span> h[i][<span class="hljs-number">1</span>] &lt; h[j][<span class="hljs-number">1</span>]&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h IHeap)</span></span> Swap(i, j <span class="hljs-type">int</span>) &#123;h[i], h[j] = h[j], h[i]&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h *IHeap)</span></span> Push(x <span class="hljs-keyword">interface</span>&#123;&#125;) &#123;<br>    *h = <span class="hljs-built_in">append</span>(*h, x.([<span class="hljs-number">2</span>]<span class="hljs-type">int</span>))<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h *IHeap)</span></span> Pop() <span class="hljs-keyword">interface</span>&#123;&#125; &#123;<br>    old := *h<br>    n := <span class="hljs-built_in">len</span>(old)<br>    x := old[n<span class="hljs-number">-1</span>]<br>    *h = old[<span class="hljs-number">0</span>: n<span class="hljs-number">-1</span>]<br>    <span class="hljs-keyword">return</span> x<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="295-æ•°æ®æµçš„ä¸­ä½æ•°"><a href="#295-æ•°æ®æµçš„ä¸­ä½æ•°" class="headerlink" title="295. æ•°æ®æµçš„ä¸­ä½æ•°"></a><a href="https://leetcode.cn/problems/find-median-from-data-stream/">295. æ•°æ®æµçš„ä¸­ä½æ•°</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> MedianFinder <span class="hljs-keyword">struct</span> &#123;<br>    maxHeap *MaxHeap <span class="hljs-comment">// å­˜å‚¨è¾ƒå°çš„ä¸€åŠæ•°å­—</span><br>    minHeap *MinHeap <span class="hljs-comment">// å­˜å‚¨è¾ƒå¤§çš„ä¸€åŠæ•°å­—</span><br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Constructor</span><span class="hljs-params">()</span></span> MedianFinder &#123;<br>    mf := MedianFinder&#123;<br>        maxHeap: &amp;MaxHeap&#123;&#125;,<br>        minHeap: &amp;MinHeap&#123;&#125;,<br>    &#125;<br>    heap.Init(mf.maxHeap)<br>    heap.Init(mf.minHeap)<br>    <span class="hljs-keyword">return</span> mf<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *MedianFinder)</span></span> AddNum(num <span class="hljs-type">int</span>)  &#123;<br>    <span class="hljs-comment">// æ€»æ˜¯å…ˆåŠ å…¥æœ€å¤§å †</span><br>    heap.Push(this.maxHeap, num)<br><br>    <span class="hljs-comment">// å°†æœ€å¤§å †çš„æœ€å¤§å€¼ç§»åˆ°æœ€å°å †</span><br>    heap.Push(this.minHeap, heap.Pop(this.maxHeap))<br><br>    <span class="hljs-comment">// å¦‚æœæœ€å¤§å †çš„å¤§å°å°äºæœ€å°å †ï¼Œå¹³è¡¡ä¸¤ä¸ªå †</span><br>    <span class="hljs-keyword">if</span> this.maxHeap.Len() &lt; this.minHeap.Len() &#123;<br>        heap.Push(this.maxHeap, heap.Pop(this.minHeap))<br>    &#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *MedianFinder)</span></span> FindMedian() <span class="hljs-type">float64</span> &#123;<br>    <span class="hljs-keyword">if</span> this.maxHeap.Len() == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> <span class="hljs-comment">// æˆ–è€…æ ¹æ®éœ€æ±‚è¿”å›å…¶ä»–é»˜è®¤å€¼</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> this.maxHeap.Len() &gt; this.minHeap.Len() &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-type">float64</span>((*this.maxHeap)[<span class="hljs-number">0</span>])<br>    &#125;<br>    <span class="hljs-keyword">return</span> (<span class="hljs-type">float64</span>((*this.maxHeap)[<span class="hljs-number">0</span>]) + <span class="hljs-type">float64</span>((*this.minHeap)[<span class="hljs-number">0</span>])) / <span class="hljs-number">2</span><br>&#125;<br><br><span class="hljs-comment">// æœ€å¤§å †ï¼ˆå­˜å‚¨è¾ƒå°çš„ä¸€åŠæ•°å­—ï¼‰</span><br><span class="hljs-keyword">type</span> MaxHeap []<span class="hljs-type">int</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h MaxHeap)</span></span> Len() <span class="hljs-type">int</span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(h)&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h MaxHeap)</span></span> Less(i, j <span class="hljs-type">int</span>) <span class="hljs-type">bool</span> &#123; <span class="hljs-keyword">return</span> h[i] &gt; h[j]&#125; <span class="hljs-comment">// æ³¨æ„è¿™é‡Œæ˜¯ &gt;ï¼Œå®ç°æœ€å¤§å †</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h MaxHeap)</span></span> Swap(i, j <span class="hljs-type">int</span>) &#123; h[i], h[j] = h[j], h[i]&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h *MaxHeap)</span></span> Push(x any) &#123;*h = <span class="hljs-built_in">append</span>(*h, x.(<span class="hljs-type">int</span>))&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h *MaxHeap)</span></span> Pop() any &#123;<br>    old := *h<br>    n := <span class="hljs-built_in">len</span>(old)<br>    x := old[n<span class="hljs-number">-1</span>]<br>    *h = old[<span class="hljs-number">0</span>:n<span class="hljs-number">-1</span>]<br>    <span class="hljs-keyword">return</span> x<br>&#125;<br><br><span class="hljs-comment">// æœ€å°å †ï¼ˆå­˜å‚¨è¾ƒå¤§çš„ä¸€åŠæ•°å­—ï¼‰</span><br><span class="hljs-keyword">type</span> MinHeap []<span class="hljs-type">int</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h MinHeap)</span></span> Len() <span class="hljs-type">int</span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(h)&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h MinHeap)</span></span> Less(i, j <span class="hljs-type">int</span>) <span class="hljs-type">bool</span> &#123; <span class="hljs-keyword">return</span> h[i] &lt; h[j]&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h MinHeap)</span></span> Swap(i, j <span class="hljs-type">int</span>) &#123; h[i], h[j] = h[j], h[i]&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h *MinHeap)</span></span> Push(x any) &#123;*h = <span class="hljs-built_in">append</span>(*h, x.(<span class="hljs-type">int</span>))&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(h *MinHeap)</span></span> Pop() any &#123;<br>    old := *h<br>    n := <span class="hljs-built_in">len</span>(old)<br>    x := old[n<span class="hljs-number">-1</span>]<br>    *h = old[<span class="hljs-number">0</span>:n<span class="hljs-number">-1</span>]<br>    <span class="hljs-keyword">return</span> x<br>&#125;<br><br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Your MedianFinder object will be instantiated and called as such:</span><br><span class="hljs-comment"> * obj := Constructor();</span><br><span class="hljs-comment"> * obj.AddNum(num);</span><br><span class="hljs-comment"> * param_2 := obj.FindMedian();</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h2 id="516-æœ€é•¿å›æ–‡å­åºåˆ—"><a href="#516-æœ€é•¿å›æ–‡å­åºåˆ—" class="headerlink" title="516. æœ€é•¿å›æ–‡å­åºåˆ—"></a><a href="https://leetcode.cn/problems/longest-palindromic-subsequence/">516. æœ€é•¿å›æ–‡å­åºåˆ—</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">longestPalindromeSubseq</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    n := <span class="hljs-built_in">len</span>(s)<br>    dp := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">int</span>, n)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> dp &#123;<br>        dp[i] = <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, n)<br>    &#125;<br>    <span class="hljs-keyword">for</span> i := n - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i-- &#123;<br>        dp[i][i] = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">for</span> j := i + <span class="hljs-number">1</span>; j &lt; n; j++ &#123;<br>            <span class="hljs-keyword">if</span> s[i] == s[j] &#123;<br>                dp[i][j] = dp[i+<span class="hljs-number">1</span>][j<span class="hljs-number">-1</span>] + <span class="hljs-number">2</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                dp[i][j] = max(dp[i][j<span class="hljs-number">-1</span>], dp[i+<span class="hljs-number">1</span>][j])<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> dp[<span class="hljs-number">0</span>][n<span class="hljs-number">-1</span>]<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Linuxä¸‹æŸ¥çœ‹æ—¥å¿—å¸¸ç”¨å‘½ä»¤</title>
    <link href="/2025/05/25/Linux%E4%B8%8B%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    <url>/2025/05/25/Linux%E4%B8%8B%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<h2 id="LinuxæŸ¥çœ‹æ—¥å¿—å¸¸ç”¨å‘½ä»¤"><a href="#LinuxæŸ¥çœ‹æ—¥å¿—å¸¸ç”¨å‘½ä»¤" class="headerlink" title="LinuxæŸ¥çœ‹æ—¥å¿—å¸¸ç”¨å‘½ä»¤"></a>LinuxæŸ¥çœ‹æ—¥å¿—å¸¸ç”¨å‘½ä»¤</h2><h3 id="tail"><a href="#tail" class="headerlink" title="tail"></a>tail</h3><p>-f å®æ—¶ç›‘æ§</p><p>-n æŒ‡å®šè¡Œæ•°</p><p>-c æŒ‡å®šå­—ç¬¦æ•°</p><p><code>tail test.log</code> é»˜è®¤æ˜¾ç¤ºæœ€å10è¡Œ</p><p><code>tail -n +20 test.log</code> æ˜¾ç¤ºä»ç¬¬20è¡Œè‡³æœ«å°¾ã€‚</p><p><code>tail -f test.log</code> é»˜è®¤æ˜¾ç¤ºæœ€å10è¡Œï¼Œå¹¶å®æ—¶ç›‘æ§ï¼Œè‹¥æœ‰æ–°å¢åŠ çš„è¡Œåˆ™ç»§ç»­æ˜¾ç¤ºï¼Œç›´åˆ°é€€å‡ºç¨‹åºã€‚</p><p><code>tail -c 10 notes.log</code> æ˜¾ç¤ºæœ€å10ä¸ªå­—ç¬¦</p><h3 id="head"><a href="#head" class="headerlink" title="head"></a>head</h3><p>ä¸tailç›¸å</p><p><code>head test.log</code> é»˜è®¤æ˜¾ç¤ºå¼€å¤´10è¡Œ</p><p><code>head -n 20 test.log</code> æ˜¾ç¤ºå¼€å¤´20è¡Œ</p><p><code>head -c 20 test.log</code> æ˜¾ç¤ºå¼€å¤´20ä¸ªå­—ç¬¦</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Goç®—æ³•é¢˜-5</title>
    <link href="/2025/05/21/Go%E7%AE%97%E6%B3%95%E9%A2%98-%E4%BA%94/"/>
    <url>/2025/05/21/Go%E7%AE%97%E6%B3%95%E9%A2%98-%E4%BA%94/</url>
    
    <content type="html"><![CDATA[<h2 id="162-å¯»æ‰¾å³°å€¼"><a href="#162-å¯»æ‰¾å³°å€¼" class="headerlink" title="162. å¯»æ‰¾å³°å€¼"></a><a href="https://leetcode.cn/problems/find-peak-element/">162. å¯»æ‰¾å³°å€¼</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// åˆ©ç”¨æ€§è´¨ + æ¯æ¬¡äºŒåˆ†ä¸¢å¼ƒä¸€åŠé€‰é¡¹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">findPeakElement</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    n := <span class="hljs-built_in">len</span>(nums)<br><br>    <span class="hljs-comment">// è¾…åŠ©å‡½æ•°ï¼Œè¾“å…¥ä¸‹æ ‡ iï¼Œè¿”å› nums[i] çš„å€¼</span><br>    <span class="hljs-comment">// æ–¹ä¾¿å¤„ç† nums[-1] ä»¥åŠ nums[n] çš„è¾¹ç•Œæƒ…å†µ</span><br>    get := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>        <span class="hljs-keyword">if</span> i == <span class="hljs-number">-1</span> || i == n &#123;<br>            <span class="hljs-keyword">return</span> math.MinInt64<br>        &#125;<br>        <span class="hljs-keyword">return</span> nums[i]<br>    &#125;<br><br>    left := <span class="hljs-number">0</span><br>    right := n - <span class="hljs-number">1</span><br>    <span class="hljs-keyword">for</span> &#123;<br>        mid := (left + right) / <span class="hljs-number">2</span><br>        <span class="hljs-keyword">if</span> get(mid<span class="hljs-number">-1</span>) &lt; get(mid) &amp;&amp; get(mid) &gt; get(mid+<span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">return</span> mid<br>        &#125;<br>        <span class="hljs-keyword">if</span> get(mid) &lt; get(mid+<span class="hljs-number">1</span>) &#123;<br>            left = mid + <span class="hljs-number">1</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            right = mid - <span class="hljs-number">1</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="695-å²›å±¿çš„æœ€å¤§é¢ç§¯"><a href="#695-å²›å±¿çš„æœ€å¤§é¢ç§¯" class="headerlink" title="695. å²›å±¿çš„æœ€å¤§é¢ç§¯"></a><a href="https://leetcode.cn/problems/max-area-of-island/">695. å²›å±¿çš„æœ€å¤§é¢ç§¯</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">maxAreaOfIsland</span><span class="hljs-params">(grid [][]<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    res := <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(grid); i++ &#123;<br>        <span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; <span class="hljs-built_in">len</span>(grid[<span class="hljs-number">0</span>]); j++ &#123;<br>            res = max(dfs(grid, i, j), res)<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> res<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">dfs</span><span class="hljs-params">(grid [][]<span class="hljs-type">int</span>, i, j <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> i &lt; <span class="hljs-number">0</span> || j &lt; <span class="hljs-number">0</span> || i == <span class="hljs-built_in">len</span>(grid) || j == <span class="hljs-built_in">len</span>(grid[<span class="hljs-number">0</span>]) || grid[i][j] != <span class="hljs-number">1</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br>    grid[i][j] = <span class="hljs-number">0</span><br>    area := <span class="hljs-number">1</span><br>    di := []<span class="hljs-type">int</span>&#123;<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>&#125;<br>    dj := []<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>&#125;<br>    <span class="hljs-keyword">for</span> k := <span class="hljs-number">0</span>; k &lt; <span class="hljs-built_in">len</span>(di); k++ &#123;<br>        area += dfs(grid, i+di[k], j+dj[k])<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> area<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="113-è·¯å¾„æ€»å’Œ-II"><a href="#113-è·¯å¾„æ€»å’Œ-II" class="headerlink" title="113. è·¯å¾„æ€»å’Œ II"></a><a href="https://leetcode.cn/problems/path-sum-ii/">113. è·¯å¾„æ€»å’Œ II</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">pathSum</span><span class="hljs-params">(root *TreeNode, targetSum <span class="hljs-type">int</span>)</span></span> [][]<span class="hljs-type">int</span> &#123;<br>    sum := <span class="hljs-number">0</span><br>    nodes := []<span class="hljs-type">int</span>&#123;&#125;<br>    res := [][]<span class="hljs-type">int</span>&#123;&#125;<br>    <span class="hljs-keyword">var</span> dfs <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(*TreeNode)</span></span><br>    dfs = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(node *TreeNode)</span></span> &#123;<br>        <span class="hljs-keyword">if</span> node == <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        nodes = <span class="hljs-built_in">append</span>(nodes, node.Val)<br>        sum += node.Val<br>        <span class="hljs-keyword">if</span> sum == targetSum &#123;<br>            <span class="hljs-keyword">if</span> node.Left == <span class="hljs-literal">nil</span> &amp;&amp; node.Right == <span class="hljs-literal">nil</span> &#123;<br>                res = <span class="hljs-built_in">append</span>(res, <span class="hljs-built_in">append</span>([]<span class="hljs-type">int</span>&#123;&#125;, nodes...))<br>            &#125;<br>        &#125;<br>        dfs(node.Left)<br>        dfs(node.Right)<br>        sum -= node.Val<br>        nodes = nodes[:<span class="hljs-built_in">len</span>(nodes)<span class="hljs-number">-1</span>]<br>    &#125;<br><br>    dfs(root)<br><br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="62-ä¸åŒè·¯å¾„"><a href="#62-ä¸åŒè·¯å¾„" class="headerlink" title="62. ä¸åŒè·¯å¾„"></a><a href="https://leetcode.cn/problems/unique-paths/">62. ä¸åŒè·¯å¾„</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">uniquePaths</span><span class="hljs-params">(m <span class="hljs-type">int</span>, n <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    dp := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">int</span>, m)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; m; i++ &#123;<br>        dp[i] = <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, n)<br>        dp[i][<span class="hljs-number">0</span>] = <span class="hljs-number">1</span><br>    &#125;<br>    <span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; n; j++ &#123;<br>        dp[<span class="hljs-number">0</span>][j] = <span class="hljs-number">1</span><br>    &#125;<br><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; m; i++ &#123;<br>        <span class="hljs-keyword">for</span> j := <span class="hljs-number">1</span>; j &lt; n; j++ &#123;<br>            dp[i][j] = dp[i<span class="hljs-number">-1</span>][j] + dp[i][j<span class="hljs-number">-1</span>]<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> dp[m<span class="hljs-number">-1</span>][n<span class="hljs-number">-1</span>]<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="662-äºŒå‰æ ‘æœ€å¤§å®½åº¦"><a href="#662-äºŒå‰æ ‘æœ€å¤§å®½åº¦" class="headerlink" title="662. äºŒå‰æ ‘æœ€å¤§å®½åº¦"></a><a href="https://leetcode.cn/problems/maximum-width-of-binary-tree/">662. äºŒå‰æ ‘æœ€å¤§å®½åº¦</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// å¹¿åº¦ä¼˜å…ˆæœç´¢ + äºŒå‰æ ‘èŠ‚ç‚¹ç¼–å·æ€§è´¨</span><br><span class="hljs-keyword">type</span> pair <span class="hljs-keyword">struct</span> &#123;<br>    node *TreeNode<br>    index <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">widthOfBinaryTree</span><span class="hljs-params">(root *TreeNode)</span></span> <span class="hljs-type">int</span> &#123;<br>    res := <span class="hljs-number">0</span><br>    q := []pair&#123;&#123;root, <span class="hljs-number">1</span>&#125;&#125;<br>    <span class="hljs-keyword">for</span> <span class="hljs-built_in">len</span>(q) &gt; <span class="hljs-number">0</span> &#123;<br>        res = max(res, q[<span class="hljs-built_in">len</span>(q)<span class="hljs-number">-1</span>].index - q[<span class="hljs-number">0</span>].index + <span class="hljs-number">1</span>)<br>        tmp := []pair&#123;&#125;<br>        <span class="hljs-keyword">for</span> _, p := <span class="hljs-keyword">range</span> q &#123;<br>            <span class="hljs-keyword">if</span> p.node.Left != <span class="hljs-literal">nil</span> &#123;<br>                tmp = <span class="hljs-built_in">append</span>(tmp, pair&#123;p.node.Left, p.index * <span class="hljs-number">2</span>&#125;)<br>            &#125;<br>            <span class="hljs-keyword">if</span> p.node.Right != <span class="hljs-literal">nil</span> &#123;<br>                tmp = <span class="hljs-built_in">append</span>(tmp, pair&#123;p.node.Right, p.index * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>&#125;)<br>            &#125;<br>        &#125;<br>        q = tmp<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="152-ä¹˜ç§¯æœ€å¤§å­æ•°ç»„"><a href="#152-ä¹˜ç§¯æœ€å¤§å­æ•°ç»„" class="headerlink" title="152. ä¹˜ç§¯æœ€å¤§å­æ•°ç»„"></a><a href="https://leetcode.cn/problems/maximum-product-subarray/">152. ä¹˜ç§¯æœ€å¤§å­æ•°ç»„</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">maxProduct</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    res := nums[<span class="hljs-number">0</span>]<br>    mx := nums[<span class="hljs-number">0</span>]<br>    mn := nums[<span class="hljs-number">0</span>]<br><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; <span class="hljs-built_in">len</span>(nums); i++ &#123;<br>        <span class="hljs-comment">// è¿™é‡Œmxï¼Œmnçš„è®¡ç®—äº’ä¸å¹²æ‰°ï¼Œå‡ä½¿ç”¨ä¸Šä¸€æ¬¡çš„ç»“æœè®¡ç®—</span><br>        mx, mn = max(nums[i], max(mx * nums[i], mn * nums[i])), min(nums[i], min(mx * nums[i], mn * nums[i]))<br>        res = max(res, mx)<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="112-è·¯å¾„æ€»å’Œ"><a href="#112-è·¯å¾„æ€»å’Œ" class="headerlink" title="112. è·¯å¾„æ€»å’Œ"></a><a href="https://leetcode.cn/problems/path-sum/">112. è·¯å¾„æ€»å’Œ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">hasPathSum</span><span class="hljs-params">(root *TreeNode, targetSum <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> root.Left == <span class="hljs-literal">nil</span> &amp;&amp; root.Right == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> targetSum == root.Val<br>    &#125;<br>    <span class="hljs-keyword">return</span> hasPathSum(root.Left, targetSum - root.Val) || hasPathSum(root.Right, targetSum - root.Val)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="198-æ‰“å®¶åŠ«èˆ"><a href="#198-æ‰“å®¶åŠ«èˆ" class="headerlink" title="198. æ‰“å®¶åŠ«èˆ"></a><a href="https://leetcode.cn/problems/house-robber/">198. æ‰“å®¶åŠ«èˆ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">rob</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    n := <span class="hljs-built_in">len</span>(nums)<br>    <span class="hljs-keyword">if</span> n == <span class="hljs-number">1</span> &#123;<br>        <span class="hljs-keyword">return</span> nums[<span class="hljs-number">0</span>]<br>    &#125;<br>    <span class="hljs-keyword">if</span> n == <span class="hljs-number">2</span> &#123;<br>        <span class="hljs-keyword">return</span> max(nums[<span class="hljs-number">0</span>], nums[<span class="hljs-number">1</span>])<br>    &#125;<br><br>    dp := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, n)<br>    <span class="hljs-comment">// å¦‚æœåªæœ‰ä¸€é—´æˆ¿ï¼Œåˆ™å·å–è¯¥é—´æˆ¿</span><br>    dp[<span class="hljs-number">0</span>] = nums[<span class="hljs-number">0</span>]<br>    <span class="hljs-comment">// å¦‚æœæœ‰ä¸¤é—´æˆ¿ï¼Œåˆ™å·å–é‡‘é¢å¤§çš„é‚£ä¸€é—´</span><br>    dp[<span class="hljs-number">1</span>] = max(nums[<span class="hljs-number">0</span>], nums[<span class="hljs-number">1</span>])<br><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">2</span>; i &lt; n; i++ &#123;<br>        <span class="hljs-comment">// å¦‚æœå·å–ç¬¬ié—´æˆ¿ï¼Œåˆ™åˆ°è¾¾iä½ç½®æ—¶çš„æ€»é‡‘é¢ä¸ºï¼Œå‰i-2é—´æˆ¿å·åˆ°çš„æ•°é¢åŠ ä¸Šç¬¬ié—´æˆ¿</span><br>        <span class="hljs-comment">// å¦‚æœä¸å·ç¬¬ié—´æˆ¿ï¼Œåˆ™åˆ°è¾¾iä½ç½®æ—¶çš„æ€»é‡‘é¢ä¸ºï¼Œå‰i-1é—´æˆ¿å·åˆ°çš„æ€»æ•°é¢</span><br>        dp[i] = max(dp[i<span class="hljs-number">-2</span>] + nums[i], dp[i<span class="hljs-number">-1</span>])<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> dp[n<span class="hljs-number">-1</span>]<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="560-å’Œä¸º-K-çš„å­æ•°ç»„"><a href="#560-å’Œä¸º-K-çš„å­æ•°ç»„" class="headerlink" title="560. å’Œä¸º K çš„å­æ•°ç»„"></a><a href="https://leetcode.cn/problems/subarray-sum-equals-k/">560. å’Œä¸º K çš„å­æ•°ç»„</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">subarraySum</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>, k <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-comment">// è®°å½•æœ€ç»ˆç»“æœ</span><br>    count := <span class="hljs-number">0</span><br>    <span class="hljs-comment">// è®°å½•ä»å¼€å¤´åˆ°å½“å‰ä½ç½®çš„å’Œ</span><br>    pre := <span class="hljs-number">0</span><br>    <span class="hljs-comment">// keyï¼šå‰ç¼€å’Œï¼Œvalueï¼šä¸ªæ•°</span><br>    m := <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>&#123;&#125;<br>    m[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(nums); i++ &#123;<br>        pre += nums[i]<br>        <span class="hljs-keyword">if</span> _, ok := m[pre-k]; ok &#123;<br>            count += m[pre-k]<br>        &#125;<br>        m[pre] += <span class="hljs-number">1</span><br>    &#125;<br><br>    <span class="hljs-keyword">return</span> count<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="169-å¤šæ•°å…ƒç´ "><a href="#169-å¤šæ•°å…ƒç´ " class="headerlink" title="169. å¤šæ•°å…ƒç´ "></a><a href="https://leetcode.cn/problems/majority-element/">169. å¤šæ•°å…ƒç´ </a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// æ‘©å°”æŠ•ç¥¨æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">majorityElement</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    count := <span class="hljs-number">0</span><br>    candidate := nums[<span class="hljs-number">0</span>]<br><br>    <span class="hljs-keyword">for</span> _, num := <span class="hljs-keyword">range</span> nums &#123;<br>        <span class="hljs-keyword">if</span> count == <span class="hljs-number">0</span> &#123;<br>            candidate = num<br>        &#125;<br>        <span class="hljs-keyword">if</span> num == candidate &#123;<br>            count += <span class="hljs-number">1</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            count -= <span class="hljs-number">1</span><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> candidate<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="227-åŸºæœ¬è®¡ç®—å™¨-II"><a href="#227-åŸºæœ¬è®¡ç®—å™¨-II" class="headerlink" title="227. åŸºæœ¬è®¡ç®—å™¨ II"></a><a href="https://leetcode.cn/problems/basic-calculator-ii/">227. åŸºæœ¬è®¡ç®—å™¨ II</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">calculate</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    res := <span class="hljs-number">0</span><br>    stack := []<span class="hljs-type">int</span>&#123;&#125;<br>    preSign := <span class="hljs-string">&#x27;+&#x27;</span><br>    num := <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i, ch := <span class="hljs-keyword">range</span> s &#123;<br>        isDigit := <span class="hljs-string">&#x27;0&#x27;</span> &lt;= ch &amp;&amp; ch &lt;= <span class="hljs-string">&#x27;9&#x27;</span><br>        <span class="hljs-keyword">if</span> isDigit &#123;<br>            num = num*<span class="hljs-number">10</span> + <span class="hljs-type">int</span>(ch-<span class="hljs-string">&#x27;0&#x27;</span>)<br>        &#125;<br>        <span class="hljs-keyword">if</span> !isDigit &amp;&amp; ch != <span class="hljs-string">&#x27; &#x27;</span> || i == <span class="hljs-built_in">len</span>(s)<span class="hljs-number">-1</span> &#123;<br>            <span class="hljs-keyword">switch</span> preSign &#123;<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;+&#x27;</span>:<br>                    stack = <span class="hljs-built_in">append</span>(stack, num)<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;-&#x27;</span>:<br>                    stack = <span class="hljs-built_in">append</span>(stack, -num)<br>                <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;*&#x27;</span>:<br>                    stack[<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>] *= num<br>                <span class="hljs-keyword">default</span>:<br>                    stack[<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>] /= num<br>            &#125;<br>            preSign = ch<br>            num = <span class="hljs-number">0</span><br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> stack &#123;<br>        res += v<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="83-åˆ é™¤æ’åºé“¾è¡¨ä¸­çš„é‡å¤å…ƒç´ "><a href="#83-åˆ é™¤æ’åºé“¾è¡¨ä¸­çš„é‡å¤å…ƒç´ " class="headerlink" title="83. åˆ é™¤æ’åºé“¾è¡¨ä¸­çš„é‡å¤å…ƒç´ "></a><a href="https://leetcode.cn/problems/remove-duplicates-from-sorted-list/">83. åˆ é™¤æ’åºé“¾è¡¨ä¸­çš„é‡å¤å…ƒç´ </a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">deleteDuplicates</span><span class="hljs-params">(head *ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">if</span> head == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> head<br>    &#125;<br><br>    cur := head<br>    <span class="hljs-keyword">for</span> cur.Next != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">if</span> cur.Val == cur.Next.Val &#123;<br>            cur.Next = cur.Next.Next<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            cur = cur.Next<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> head<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="718-æœ€é•¿é‡å¤å­æ•°ç»„"><a href="#718-æœ€é•¿é‡å¤å­æ•°ç»„" class="headerlink" title="718. æœ€é•¿é‡å¤å­æ•°ç»„"></a><a href="https://leetcode.cn/problems/maximum-length-of-repeated-subarray/">718. æœ€é•¿é‡å¤å­æ•°ç»„</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">findLength</span><span class="hljs-params">(nums1 []<span class="hljs-type">int</span>, nums2 []<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    n := <span class="hljs-built_in">len</span>(nums1)<br>    m := <span class="hljs-built_in">len</span>(nums2)<br><br>    res := <span class="hljs-number">0</span><br>    <span class="hljs-comment">// dp[i][j]å«ä¹‰ï¼šnums1[:i+1]å’Œnums2[:j+1]çš„æœ€é•¿å…¬å…±åç¼€</span><br>    dp := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">int</span>, n)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;<br>        dp[i] = <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, m)<br>        <span class="hljs-keyword">if</span> nums1[i] == nums2[<span class="hljs-number">0</span>] &#123;<br>            dp[i][<span class="hljs-number">0</span>] = <span class="hljs-number">1</span><br>            res = <span class="hljs-number">1</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; m; j++ &#123;<br>        <span class="hljs-keyword">if</span> nums1[<span class="hljs-number">0</span>] == nums2[j] &#123;<br>            dp[<span class="hljs-number">0</span>][j] = <span class="hljs-number">1</span><br>            res = <span class="hljs-number">1</span><br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; n; i++ &#123;<br>        <span class="hljs-keyword">for</span> j := <span class="hljs-number">1</span>; j &lt; m; j++ &#123;<br>            <span class="hljs-keyword">if</span> nums1[i] == nums2[j] &#123;<br>                dp[i][j] = dp[i<span class="hljs-number">-1</span>][j<span class="hljs-number">-1</span>] + <span class="hljs-number">1</span><br>                res = max(res, dp[i][j])<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                dp[i][j] = <span class="hljs-number">0</span><br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Goç®—æ³•é¢˜-å››</title>
    <link href="/2025/05/19/Go%E7%AE%97%E6%B3%95%E9%A2%98-%E5%9B%9B/"/>
    <url>/2025/05/19/Go%E7%AE%97%E6%B3%95%E9%A2%98-%E5%9B%9B/</url>
    
    <content type="html"><![CDATA[<h2 id="39-ç»„åˆæ€»å’Œ"><a href="#39-ç»„åˆæ€»å’Œ" class="headerlink" title="39. ç»„åˆæ€»å’Œ"></a><a href="https://leetcode.cn/problems/combination-sum/">39. ç»„åˆæ€»å’Œ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">combinationSum</span><span class="hljs-params">(candidates []<span class="hljs-type">int</span>, target <span class="hljs-type">int</span>)</span></span> [][]<span class="hljs-type">int</span> &#123;<br>    res := [][]<span class="hljs-type">int</span>&#123;&#125;<br>    comb := []<span class="hljs-type">int</span>&#123;&#125;<br>    <span class="hljs-keyword">var</span> dfs <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(target, idx <span class="hljs-type">int</span>)</span></span><br>    dfs = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(target, idx <span class="hljs-type">int</span>)</span></span> &#123;<br>        <span class="hljs-comment">// å½“å‰ç´¢å¼•è¶…è¿‡äº†æ•°ç»„æ€»é•¿åº¦</span><br>        <span class="hljs-keyword">if</span> idx == <span class="hljs-built_in">len</span>(candidates) &#123;<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-comment">// targetå‡åˆ°äº†0ï¼Œè¯´æ˜æ‰¾åˆ°äº†ä¸€ä¸ªç­”æ¡ˆ</span><br>        <span class="hljs-keyword">if</span> target == <span class="hljs-number">0</span> &#123;<br>            res = <span class="hljs-built_in">append</span>(res, <span class="hljs-built_in">append</span>([]<span class="hljs-type">int</span>&#123;&#125;, comb...))<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-comment">// è€ƒè™‘é€‰æ‹©å½“å‰å…ƒç´ </span><br>        <span class="hljs-keyword">if</span> target - candidates[idx] &gt;= <span class="hljs-number">0</span> &#123;<br>            comb = <span class="hljs-built_in">append</span>(comb, candidates[idx])<br>            dfs(target-candidates[idx], idx)<br>            comb = comb[:<span class="hljs-built_in">len</span>(comb)<span class="hljs-number">-1</span>]<br>        &#125;<br>        <span class="hljs-comment">// ä¸è€ƒè™‘å½“å‰å…ƒç´ </span><br>        dfs(target, idx+<span class="hljs-number">1</span>)<br>    &#125;<br>    dfs(target, <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="394-å­—ç¬¦ä¸²è§£ç "><a href="#394-å­—ç¬¦ä¸²è§£ç " class="headerlink" title="394. å­—ç¬¦ä¸²è§£ç "></a><a href="https://leetcode.cn/problems/decode-string/">394. å­—ç¬¦ä¸²è§£ç </a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">decodeString</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>    stack := []<span class="hljs-type">string</span>&#123;&#125;<br>    p := <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> p &lt; <span class="hljs-built_in">len</span>(s) &#123;<br>        cur := s[p]<br>        <span class="hljs-comment">// å¦‚æœéå†åˆ°æ•°å­—ï¼Œå°±å–å‡ºæ‰€æœ‰çš„åç»­æ•°å­—ï¼Œå¾—åˆ°æ•´æ•°å­—ç¬¦ä¸²åï¼Œå°†å…¶å‹å…¥æ ˆä¸­</span><br>        <span class="hljs-keyword">if</span> cur &gt;= <span class="hljs-string">&#x27;0&#x27;</span> &amp;&amp; cur &lt;= <span class="hljs-string">&#x27;9&#x27;</span> &#123;<br>            digits := getDigits(s, &amp;p)<br>            stack = <span class="hljs-built_in">append</span>(stack, digits)<br>        <span class="hljs-comment">// å¦‚æœé‡åˆ°å­—ç¬¦æˆ–å·¦æ‹¬å·ï¼Œç›´æ¥å‹æ ˆ</span><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cur &gt;= <span class="hljs-string">&#x27;a&#x27;</span> &amp;&amp; cur &lt;= <span class="hljs-string">&#x27;z&#x27;</span> || cur &gt;= <span class="hljs-string">&#x27;A&#x27;</span> &amp;&amp; cur &lt;= <span class="hljs-string">&#x27;Z&#x27;</span>) || cur == <span class="hljs-string">&#x27;[&#x27;</span> &#123;<br>            stack = <span class="hljs-built_in">append</span>(stack, <span class="hljs-type">string</span>(cur))<br>            p++<br>        <span class="hljs-comment">// å¦‚æœé‡åˆ°å³æ‹¬å·</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// æŒç»­å‡ºæ ˆå­—ç¬¦ï¼Œç›´åˆ°é‡åˆ°å·¦æ‹¬å·ï¼Œæ­¤æ—¶subä¸­ä¿å­˜äº†æ‰€æœ‰çš„å‡ºæ ˆå­—ç¬¦</span><br>            sub := []<span class="hljs-type">string</span>&#123;&#125;<br>            <span class="hljs-keyword">for</span> stack[<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>] != <span class="hljs-string">&quot;[&quot;</span> &#123;<br>                sub = <span class="hljs-built_in">append</span>(sub, stack[<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>])<br>                stack = stack[:<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>]<br>            &#125;<br>            <span class="hljs-comment">// å°†subä¸­çš„å­—ç¬¦åè½¬ï¼Œå¾—åˆ°æ­£å¸¸çš„å­—ç¬¦é¡ºåº</span><br>            <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(sub)/<span class="hljs-number">2</span>; i++ &#123;<br>                sub[i], sub[<span class="hljs-built_in">len</span>(sub)<span class="hljs-number">-1</span>-i] = sub[<span class="hljs-built_in">len</span>(sub)<span class="hljs-number">-1</span>-i], sub[i]<br>            &#125;<br><br>            <span class="hljs-comment">// å°†å·¦æ‹¬å·å‡ºæ ˆ</span><br>            stack = stack[:<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>]<br><br>            <span class="hljs-comment">// æ­¤æ—¶æ ˆé¡¶ä¿å­˜çš„æ˜¯æ•´æ•°ï¼Œå°†æ­¤æ•´æ•°å‡ºæ ˆï¼Œå¹¶è¿›è¡Œé‡å¤å¤„ç†</span><br>            repTime, _ := strconv.Atoi(stack[<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>])<br>            stack = stack[:<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>]<br>            t := strings.Repeat(getString(sub), repTime)<br>            <span class="hljs-comment">// é‡ç‚¹ï¼Œå°†é‡å¤åçš„å­—ç¬¦ä¸²é‡æ–°å‹å…¥æ ˆä¸­</span><br>            stack = <span class="hljs-built_in">append</span>(stack, t)<br><br>            <span class="hljs-comment">// ç»§ç»­åˆ¤æ–­ä¸‹ä¸€ä¸ªå­—ç¬¦</span><br>            p++<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> getString(stack)<br>&#125;<br><br><span class="hljs-comment">// å–å‡ºæ‰€æœ‰çš„åç»­æ•°å­—ï¼Œç»„æˆä¸€ä¸ªæ•´æ•°å­—ç¬¦ä¸²</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getDigits</span><span class="hljs-params">(s <span class="hljs-type">string</span>, p *<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>    res := <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> ; s[*p] &gt;= <span class="hljs-string">&#x27;0&#x27;</span> &amp;&amp; s[*p] &lt;= <span class="hljs-string">&#x27;9&#x27;</span>; *p++ &#123;<br>        res += <span class="hljs-type">string</span>(s[*p])<br>    &#125;<br>    <span class="hljs-keyword">return</span> res<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getString</span><span class="hljs-params">(v []<span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>    res := <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> _, s := <span class="hljs-keyword">range</span> v &#123;<br>        res += s<br>    &#125;<br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="110-å¹³è¡¡äºŒå‰æ ‘"><a href="#110-å¹³è¡¡äºŒå‰æ ‘" class="headerlink" title="110. å¹³è¡¡äºŒå‰æ ‘"></a><a href="https://leetcode.cn/problems/balanced-binary-tree/">110. å¹³è¡¡äºŒå‰æ ‘</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">isBalanced</span><span class="hljs-params">(root *TreeNode)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> abs(height(root.Left) - height(root.Right)) &lt;= <span class="hljs-number">1</span> &amp;&amp; isBalanced(root.Left) &amp;&amp; isBalanced(root.Right)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">height</span><span class="hljs-params">(root *TreeNode)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> max(height(root.Left), height(root.Right)) + <span class="hljs-number">1</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">max</span><span class="hljs-params">(x, y <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> x &gt; y &#123;<br>        <span class="hljs-keyword">return</span> x<br>    &#125;<br>    <span class="hljs-keyword">return</span> y<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">abs</span><span class="hljs-params">(x <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> x &lt; <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span> * x<br>    &#125;<br>    <span class="hljs-keyword">return</span> x<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="64-æœ€å°è·¯å¾„å’Œ"><a href="#64-æœ€å°è·¯å¾„å’Œ" class="headerlink" title="64. æœ€å°è·¯å¾„å’Œ"></a><a href="https://leetcode.cn/problems/minimum-path-sum/">64. æœ€å°è·¯å¾„å’Œ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">minPathSum</span><span class="hljs-params">(grid [][]<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(grid) == <span class="hljs-number">0</span> || <span class="hljs-built_in">len</span>(grid[<span class="hljs-number">0</span>]) == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br>    rows := <span class="hljs-built_in">len</span>(grid)<br>    cols := <span class="hljs-built_in">len</span>(grid[<span class="hljs-number">0</span>])<br>    <br>    dp := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">int</span>, rows)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(dp); i++ &#123;<br>        dp[i] = <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, cols)<br>    &#125;<br><br>    dp[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] = grid[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; rows; i++ &#123;<br>        dp[i][<span class="hljs-number">0</span>] = dp[i<span class="hljs-number">-1</span>][<span class="hljs-number">0</span>] + grid[i][<span class="hljs-number">0</span>]<br>    &#125;<br>    <span class="hljs-keyword">for</span> j := <span class="hljs-number">1</span>; j &lt; cols; j++ &#123;<br>        dp[<span class="hljs-number">0</span>][j] = dp[<span class="hljs-number">0</span>][j<span class="hljs-number">-1</span>] + grid[<span class="hljs-number">0</span>][j]<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; rows; i++ &#123;<br>        <span class="hljs-keyword">for</span> j := <span class="hljs-number">1</span>; j &lt; cols; j++ &#123;<br>            dp[i][j] = min(dp[i][j<span class="hljs-number">-1</span>], dp[i<span class="hljs-number">-1</span>][j]) + grid[i][j]<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> dp[rows<span class="hljs-number">-1</span>][cols<span class="hljs-number">-1</span>]<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="48-æ—‹è½¬å›¾åƒ"><a href="#48-æ—‹è½¬å›¾åƒ" class="headerlink" title="48. æ—‹è½¬å›¾åƒ"></a><a href="https://leetcode.cn/problems/rotate-image/">48. æ—‹è½¬å›¾åƒ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-string">``</span><span class="hljs-string">`</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">## [470. ç”¨ Rand7() å®ç° Rand10()](https://leetcode.cn/problems/implement-rand10-using-rand7/)</span><br><span class="hljs-string"></span><br><span class="hljs-string">`</span><span class="hljs-string">``</span><span class="hljs-keyword">go</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">rand10</span><span class="hljs-params">()</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">for</span> &#123;<br>        row := rand7()<br>        col := rand7()<br>        idx := (row<span class="hljs-number">-1</span>)*<span class="hljs-number">7</span> + col<br>        <span class="hljs-keyword">if</span> idx &lt;= <span class="hljs-number">40</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span> + (idx<span class="hljs-number">-1</span>)%<span class="hljs-number">10</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="240-æœç´¢äºŒç»´çŸ©é˜µ-II"><a href="#240-æœç´¢äºŒç»´çŸ©é˜µ-II" class="headerlink" title="240. æœç´¢äºŒç»´çŸ©é˜µ II"></a><a href="https://leetcode.cn/problems/search-a-2d-matrix-ii/">240. æœç´¢äºŒç»´çŸ©é˜µ II</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">searchMatrix</span><span class="hljs-params">(matrix [][]<span class="hljs-type">int</span>, target <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>    m := <span class="hljs-built_in">len</span>(matrix)<br>    n := <span class="hljs-built_in">len</span>(matrix[<span class="hljs-number">0</span>])<br>    x := <span class="hljs-number">0</span><br>    y := n - <span class="hljs-number">1</span><br>    <span class="hljs-keyword">for</span> x &lt; m &amp;&amp; y &gt;= <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">if</span> matrix[x][y] == target &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>        &#125;<br>        <span class="hljs-comment">// å¦‚æœå½“å‰å…ƒç´ å¤§ï¼Œå°±å¾€å°äº†èµ°ï¼Œå¾€å°äº†èµ°å°±æ˜¯å¾€å·¦ç§»åŠ¨</span><br>        <span class="hljs-keyword">if</span> matrix[x][y] &gt; target &#123;<br>            y--<br>        <span class="hljs-comment">// å¦‚æœå½“å‰å…ƒç´ å°ï¼Œå°±å¾€å¤§äº†èµ°ï¼Œå¾€å¤§äº†èµ°å°±æ˜¯å¾€ä¸‹èµ°</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            x++<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="98-éªŒè¯äºŒå‰æœç´¢æ ‘"><a href="#98-éªŒè¯äºŒå‰æœç´¢æ ‘" class="headerlink" title="98. éªŒè¯äºŒå‰æœç´¢æ ‘"></a><a href="https://leetcode.cn/problems/validate-binary-search-tree/">98. éªŒè¯äºŒå‰æœç´¢æ ‘</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">isValidBST</span><span class="hljs-params">(root *TreeNode)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">return</span> helper(root, math.MinInt64, math.MaxInt64)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">helper</span><span class="hljs-params">(root *TreeNode, lower, upper <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> root.Val &lt;= lower || root.Val &gt;= upper &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> helper(root.Left, lower, root.Val) &amp;&amp; helper(root.Right, root.Val, upper)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="543-äºŒå‰æ ‘çš„ç›´å¾„"><a href="#543-äºŒå‰æ ‘çš„ç›´å¾„" class="headerlink" title="543. äºŒå‰æ ‘çš„ç›´å¾„"></a><a href="https://leetcode.cn/problems/diameter-of-binary-tree/">543. äºŒå‰æ ‘çš„ç›´å¾„</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">diameterOfBinaryTree</span><span class="hljs-params">(root *TreeNode)</span></span> <span class="hljs-type">int</span> &#123;<br>    res := <span class="hljs-number">1</span><br>    <span class="hljs-keyword">var</span> depth <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(root *TreeNode)</span></span> <span class="hljs-type">int</span><br>    depth = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(root *TreeNode)</span></span> <span class="hljs-type">int</span> &#123;<br>        <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>        &#125;<br>        l := depth(root.Left)<br>        r := depth(root.Right)<br><br>        res = max(res, l + r + <span class="hljs-number">1</span>)<br><br>        <span class="hljs-keyword">return</span> max(l, r) + <span class="hljs-number">1</span><br>    &#125;<br><br>    depth(root)<br><br>    <span class="hljs-keyword">return</span> res - <span class="hljs-number">1</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="221-æœ€å¤§æ­£æ–¹å½¢"><a href="#221-æœ€å¤§æ­£æ–¹å½¢" class="headerlink" title="221. æœ€å¤§æ­£æ–¹å½¢"></a><a href="https://leetcode.cn/problems/maximal-square/">221. æœ€å¤§æ­£æ–¹å½¢</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">maximalSquare</span><span class="hljs-params">(matrix [][]<span class="hljs-type">byte</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    maxSide := <span class="hljs-number">0</span><br><br>    dp := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">int</span>, <span class="hljs-built_in">len</span>(matrix))<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(matrix); i++ &#123;<br>        dp[i] = <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-built_in">len</span>(matrix[i]))<br>        <span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; <span class="hljs-built_in">len</span>(matrix[i]); j++ &#123;<br>            dp[i][j] = <span class="hljs-type">int</span>(matrix[i][j] - <span class="hljs-string">&#x27;0&#x27;</span>)<br>            <span class="hljs-keyword">if</span> dp[i][j] == <span class="hljs-number">1</span> &#123;<br>                maxSide = <span class="hljs-number">1</span><br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; <span class="hljs-built_in">len</span>(matrix); i++ &#123;<br>        <span class="hljs-keyword">for</span> j := <span class="hljs-number">1</span>; j &lt; <span class="hljs-built_in">len</span>(matrix[i]); j++ &#123;<br>            <span class="hljs-keyword">if</span> dp[i][j] == <span class="hljs-number">1</span> &#123;<br>                dp[i][j] = min(min(dp[i<span class="hljs-number">-1</span>][j], dp[i][j<span class="hljs-number">-1</span>]), dp[i<span class="hljs-number">-1</span>][j<span class="hljs-number">-1</span>]) + <span class="hljs-number">1</span><br>                <span class="hljs-keyword">if</span> dp[i][j] &gt; maxSide &#123;<br>                    maxSide = dp[i][j]<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> maxSide * maxSide<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="128-æœ€é•¿è¿ç»­åºåˆ—"><a href="#128-æœ€é•¿è¿ç»­åºåˆ—" class="headerlink" title="128. æœ€é•¿è¿ç»­åºåˆ—"></a><a href="https://leetcode.cn/problems/longest-consecutive-sequence/">128. æœ€é•¿è¿ç»­åºåˆ—</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">longestConsecutive</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    numSet := <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">bool</span>&#123;&#125;<br>    <span class="hljs-keyword">for</span> _, num := <span class="hljs-keyword">range</span> nums &#123;<br>        numSet[num] = <span class="hljs-literal">true</span><br>    &#125;<br><br>    maxLength := <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> num := <span class="hljs-keyword">range</span> numSet &#123;<br>        <span class="hljs-keyword">if</span> !numSet[num<span class="hljs-number">-1</span>] &#123;<br>            curNum := num<br>            curLength := <span class="hljs-number">1</span><br>            <span class="hljs-keyword">for</span> numSet[curNum+<span class="hljs-number">1</span>] &#123;<br>                curNum++<br>                curLength++<br>            &#125;<br>            <span class="hljs-keyword">if</span> curLength &gt; maxLength &#123;<br>                maxLength = curLength<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> maxLength<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="122-ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº-II"><a href="#122-ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº-II" class="headerlink" title="122. ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº II"></a><a href="https://leetcode.cn/problems/best-time-to-buy-and-sell-stock-ii/">122. ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº II</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// è´ªå¿ƒæ³•ï¼Œåªèƒ½ç”¨äºè®¡ç®—æœ€å¤§åˆ©æ¶¦</span><br><span class="hljs-comment">// æ€æƒ³ï¼šæ‰€æœ‰çš„åˆ©æ¶¦éƒ½è¦æœ‰ï¼Œæ‰€æœ‰çš„äºæŸéƒ½ä¸è¦ã€‚å³ï¼šåªè¦åä¸€å¤©æ¯”å‰ä¸€å¤©ä»·æ ¼é«˜ï¼Œè¿™éƒ¨åˆ†å·®ä»·å°±æ˜¯åˆ©æ¶¦</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">maxProfit</span><span class="hljs-params">(prices []<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    res := <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; <span class="hljs-built_in">len</span>(prices); i++ &#123;<br>        res += max(<span class="hljs-number">0</span>, prices[i]-prices[i<span class="hljs-number">-1</span>])<br>    &#125;<br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="234-å›æ–‡é“¾è¡¨"><a href="#234-å›æ–‡é“¾è¡¨" class="headerlink" title="234. å›æ–‡é“¾è¡¨"></a><a href="https://leetcode.cn/problems/palindrome-linked-list/">234. å›æ–‡é“¾è¡¨</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// // é€’å½’ï¼Œæœ¬è´¨æ˜¯åˆ©ç”¨æ ˆ</span><br><span class="hljs-comment">// func isPalindrome(head *ListNode) bool &#123;</span><br><span class="hljs-comment">//     // é€’å½’å‡½æ•°å¤–æŒ‡é’ˆï¼ŒæŒ‡å‘é“¾è¡¨å¤´éƒ¨</span><br><span class="hljs-comment">//     p := head</span><br><br><span class="hljs-comment">//     var check func(*ListNode) bool</span><br><span class="hljs-comment">//     check = func(node *ListNode) bool &#123;</span><br><span class="hljs-comment">//         if node != nil &#123;</span><br><span class="hljs-comment">//             // ä¸€å¼€å§‹å°±è¿›å…¥é€’å½’ï¼Œå®é™…æ•ˆæœä¸Šä¼šæŠŠå½“å‰èŠ‚ç‚¹å‹å…¥å‡½æ•°æ ˆä¸­ï¼Œå¹¶ä¸”ä¼šä¸€ç›´å‹åˆ°æœ€åä¸€ä¸ªèŠ‚ç‚¹</span><br><span class="hljs-comment">//             // å½“å¼€å§‹å‡ºæ ˆæ—¶ï¼Œå®é™…å°±æ˜¯ä»æœ€åä¸€ä¸ªèŠ‚ç‚¹å¾€å‰éå†äº†</span><br><span class="hljs-comment">//             if !check(node.Next) &#123;</span><br><span class="hljs-comment">//                 return false</span><br><span class="hljs-comment">//             &#125;</span><br><span class="hljs-comment">//             // åˆ¤æ–­é€’å½’å¤–æŒ‡é’ˆä¸å½“å‰èŠ‚ç‚¹çš„å€¼</span><br><span class="hljs-comment">//             if node.Val != p.Val &#123;</span><br><span class="hljs-comment">//                 return false</span><br><span class="hljs-comment">//             &#125;</span><br><span class="hljs-comment">//             // å¤–æŒ‡é’ˆå‘åç§»åŠ¨ä¸€ä½</span><br><span class="hljs-comment">//             p = p.Next</span><br><span class="hljs-comment">//         &#125;</span><br><span class="hljs-comment">//         return true</span><br><span class="hljs-comment">//     &#125;</span><br><br><span class="hljs-comment">//     return check(head)</span><br><span class="hljs-comment">// &#125;</span><br><br><span class="hljs-comment">// å¿«æ…¢æŒ‡é’ˆæ‰¾ä¸­ç‚¹ + åè½¬é“¾è¡¨ + éå†å¯¹æ¯”</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reverseList</span><span class="hljs-params">(head *ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">var</span> prev, cur *ListNode = <span class="hljs-literal">nil</span>, head<br>    <span class="hljs-keyword">for</span> cur != <span class="hljs-literal">nil</span> &#123;<br>        nextTmp := cur.Next<br>        cur.Next = prev<br>        prev = cur<br>        cur = nextTmp<br>    &#125;<br>    <span class="hljs-keyword">return</span> prev<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">endOfFirstHalf</span><span class="hljs-params">(head *ListNode)</span></span> *ListNode &#123;<br>    fast := head<br>    slow := head<br>    <span class="hljs-keyword">for</span> fast.Next != <span class="hljs-literal">nil</span> &amp;&amp; fast.Next.Next != <span class="hljs-literal">nil</span> &#123;<br>        fast = fast.Next.Next<br>        slow = slow.Next<br>    &#125;<br>    <span class="hljs-keyword">return</span> slow<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">isPalindrome</span><span class="hljs-params">(head *ListNode)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">if</span> head == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    &#125;<br><br>    <span class="hljs-comment">// æ‰¾åˆ°å‰åŠéƒ¨åˆ†é“¾è¡¨çš„å°¾èŠ‚ç‚¹å¹¶åè½¬ååŠéƒ¨åˆ†é“¾è¡¨</span><br>    firstHalfEnd := endOfFirstHalf(head)<br>    secondHalfStart := reverseList(firstHalfEnd.Next)<br><br>    <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦å›æ–‡</span><br>    p1 := head<br>    p2 := secondHalfStart<br>    result := <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">for</span> result &amp;&amp; p2 != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">if</span> p1.Val != p2.Val &#123;<br>            result = <span class="hljs-literal">false</span><br>        &#125;<br>        p1 = p1.Next<br>        p2 = p2.Next<br>    &#125;<br><br>    <span class="hljs-comment">// è¿˜åŸé“¾è¡¨å¹¶è¿”å›ç»“æœ</span><br>    firstHalfEnd.Next = reverseList(secondHalfStart)<br>    <span class="hljs-keyword">return</span> result<br>&#125;<br></code></pre></td></tr></table></figure><h2 id><a href="#" class="headerlink" title></a></h2>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Goç®—æ³•é¢˜-ä¸‰</title>
    <link href="/2025/05/13/Go%E7%AE%97%E6%B3%95%E9%A2%98-%E4%B8%89/"/>
    <url>/2025/05/13/Go%E7%AE%97%E6%B3%95%E9%A2%98-%E4%B8%89/</url>
    
    <content type="html"><![CDATA[<h2 id="704-äºŒåˆ†æŸ¥æ‰¾"><a href="#704-äºŒåˆ†æŸ¥æ‰¾" class="headerlink" title="704. äºŒåˆ†æŸ¥æ‰¾"></a><a href="https://leetcode.cn/problems/binary-search/">704. äºŒåˆ†æŸ¥æ‰¾</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">search</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>, target <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(nums) == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br>    &#125;<br>    l := <span class="hljs-number">0</span><br>    r := <span class="hljs-built_in">len</span>(nums) - <span class="hljs-number">1</span><br>    <span class="hljs-keyword">for</span> l &lt;= r &#123;<br>        mid := (l + r) / <span class="hljs-number">2</span><br>        <span class="hljs-keyword">if</span> nums[mid] == target &#123;<br>            <span class="hljs-keyword">return</span> mid<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> nums[mid] &lt; target &#123;<br>            l = mid + <span class="hljs-number">1</span><br>        &#125;<br>        <span class="hljs-keyword">if</span> nums[mid] &gt; target &#123;<br>            r = mid - <span class="hljs-number">1</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="232-ç”¨æ ˆå®ç°é˜Ÿåˆ—"><a href="#232-ç”¨æ ˆå®ç°é˜Ÿåˆ—" class="headerlink" title="232. ç”¨æ ˆå®ç°é˜Ÿåˆ—"></a><a href="https://leetcode.cn/problems/implement-queue-using-stacks/">232. ç”¨æ ˆå®ç°é˜Ÿåˆ—</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> MyQueue <span class="hljs-keyword">struct</span> &#123;<br>    inStack, outStack []<span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Constructor</span><span class="hljs-params">()</span></span> MyQueue &#123;<br>    <span class="hljs-keyword">return</span> MyQueue&#123;&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *MyQueue)</span></span> Push(x <span class="hljs-type">int</span>) &#123;<br>    q.inStack = <span class="hljs-built_in">append</span>(q.inStack, x)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *MyQueue)</span></span> in2out() &#123;<br>    <span class="hljs-keyword">for</span> <span class="hljs-built_in">len</span>(q.inStack) &gt; <span class="hljs-number">0</span> &#123;<br>        q.outStack = <span class="hljs-built_in">append</span>(q.outStack, q.inStack[<span class="hljs-built_in">len</span>(q.inStack)<span class="hljs-number">-1</span>])<br>        q.inStack = q.inStack[:<span class="hljs-built_in">len</span>(q.inStack)<span class="hljs-number">-1</span>]<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *MyQueue)</span></span> Pop() <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(q.outStack) == <span class="hljs-number">0</span> &#123;<br>        q.in2out()<br>    &#125;<br>    x := q.outStack[<span class="hljs-built_in">len</span>(q.outStack)<span class="hljs-number">-1</span>]<br>    q.outStack = q.outStack[:<span class="hljs-built_in">len</span>(q.outStack)<span class="hljs-number">-1</span>]<br>    <span class="hljs-keyword">return</span> x<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *MyQueue)</span></span> Peek() <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(q.outStack) == <span class="hljs-number">0</span> &#123;<br>        q.in2out()<br>    &#125;<br>    <span class="hljs-keyword">return</span> q.outStack[<span class="hljs-built_in">len</span>(q.outStack)<span class="hljs-number">-1</span>]<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *MyQueue)</span></span> Empty() <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(q.inStack) == <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-built_in">len</span>(q.outStack) == <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="148-æ’åºé“¾è¡¨"><a href="#148-æ’åºé“¾è¡¨" class="headerlink" title="148. æ’åºé“¾è¡¨"></a><a href="https://leetcode.cn/problems/sort-list/">148. æ’åºé“¾è¡¨</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// å½’å¹¶æ’åºä¸¤ä¸ªæœ‰åºé“¾è¡¨</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">merge</span><span class="hljs-params">(head1, head2 *ListNode)</span></span> *ListNode &#123;<br>    dummy := &amp;ListNode&#123;&#125;<br>    p, p1, p2 := dummy, head1, head2<br>    <span class="hljs-keyword">for</span> p1 != <span class="hljs-literal">nil</span> &amp;&amp; p2 != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">if</span> p1.Val &lt; p2.Val &#123;<br>            p.Next = p1<br>            p1 = p1.Next<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            p.Next = p2<br>            p2 = p2.Next<br>        &#125;<br>        p = p.Next<br>    &#125;<br>    <span class="hljs-keyword">if</span> p1 != <span class="hljs-literal">nil</span> &#123;<br>        p.Next = p1<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> p2 != <span class="hljs-literal">nil</span> &#123;<br>        p.Next = p2<br>    &#125;<br>    <span class="hljs-keyword">return</span> dummy.Next<br>&#125;<br><br><span class="hljs-comment">// æ‹†åˆ†ä¸€ä¸ªé“¾è¡¨ï¼Œåˆ†åˆ«é€’å½’æ’åºï¼Œå°†æ’å¥½åºçš„ä¸¤ä¸ªé“¾è¡¨åˆå¹¶</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sort</span><span class="hljs-params">(head, tail *ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">if</span> head == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> head<br>    &#125;<br>    <br>    <span class="hljs-comment">// ä¸¢å¼ƒå°¾éƒ¨èŠ‚ç‚¹ï¼Œé¿å…é‡å¤</span><br>    <span class="hljs-keyword">if</span> head.Next == tail &#123;<br>        head.Next = <span class="hljs-literal">nil</span><br>        <span class="hljs-keyword">return</span> head<br>    &#125;<br><br>    slow, fast := head, head<br>    <span class="hljs-keyword">for</span> fast != tail &#123;<br>        slow = slow.Next<br>        fast = fast.Next<br>        <span class="hljs-keyword">if</span> fast != tail &#123;<br>            fast = fast.Next<br>        &#125;<br>    &#125;<br><br>    mid := slow<br>    <span class="hljs-comment">// è¿™é‡Œå°†midåˆ†åˆ«ä½œä¸ºå¤´å’Œå°¾é€’å½’ä¼ é€’ï¼Œä½†ä½œä¸ºå°¾éƒ¨çš„midæœ€ç»ˆä¼šè¢«ä¸¢å¼ƒï¼Œä¸ä¼šå‡ºç°midèŠ‚ç‚¹é‡å¤çš„é—®é¢˜</span><br>    <span class="hljs-keyword">return</span> merge(sort(head, mid), sort(mid, tail))<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sortList</span><span class="hljs-params">(head *ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">return</span> sort(head, <span class="hljs-literal">nil</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="22-æ‹¬å·ç”Ÿæˆ"><a href="#22-æ‹¬å·ç”Ÿæˆ" class="headerlink" title="22. æ‹¬å·ç”Ÿæˆ"></a><a href="https://leetcode.cn/problems/generate-parentheses/">22. æ‹¬å·ç”Ÿæˆ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">generateParenthesis</span><span class="hljs-params">(n <span class="hljs-type">int</span>)</span></span> []<span class="hljs-type">string</span> &#123;<br>    <span class="hljs-comment">// ç”¨äºä¿å­˜ç»“æœé›†</span><br>    res := []<span class="hljs-type">string</span>&#123;&#125;<br>    <span class="hljs-comment">// ç”¨äºä¿å­˜æ¯ä¸€æ­¥çš„ç»“æœ</span><br>    tmp := []<span class="hljs-type">string</span>&#123;&#125;<br>    <span class="hljs-comment">// å›æº¯æ³•ï¼Œæ¯ä¸ªä½ç½®ä¸Šè¦ä¹ˆæ”¾å·¦æ‹¬å·ï¼Œè¦ä¹ˆæ”¾å³æ‹¬å·</span><br>    <span class="hljs-comment">// æ”¾çš„æ—¶å€™æ ¡éªŒä¸‹åˆä¸åˆæ³•</span><br>    <span class="hljs-keyword">var</span> backtrack <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(leftCount, rightCount <span class="hljs-type">int</span>)</span></span><br>    backtrack = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(leftCount, rightCount <span class="hljs-type">int</span>)</span></span> &#123;<br>        <span class="hljs-comment">// é•¿åº¦è¾¾åˆ°2nï¼Œæ‰¾åˆ°ä¸€ä¸ªç­”æ¡ˆï¼ŒåŠ å…¥ç»“æœé›†</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(tmp) == <span class="hljs-number">2</span>*n &#123;<br>            res = <span class="hljs-built_in">append</span>(res, strings.Join(tmp, <span class="hljs-string">&quot;&quot;</span>))<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-comment">// åªè¦å·¦æ‹¬å·æ•°é‡å°äºnï¼Œå½“å‰ä½ç½®æ”¾å·¦æ‹¬å·å°±æ˜¯åˆæ³•çš„</span><br>        <span class="hljs-keyword">if</span> leftCount &lt; n &#123;<br>            tmp = <span class="hljs-built_in">append</span>(tmp, <span class="hljs-string">&quot;(&quot;</span>)<br>            backtrack(leftCount+<span class="hljs-number">1</span>, rightCount)<br>            tmp = tmp[:<span class="hljs-built_in">len</span>(tmp)<span class="hljs-number">-1</span>]<br>        &#125;<br>        <span class="hljs-comment">// åªè¦å³æ‹¬å·æ•°é‡å°äºå·¦æ‹¬å·ï¼Œå½“å‰ä½ç½®æ”¾å³æ‹¬å·å°±æ˜¯åˆæ³•çš„</span><br>        <span class="hljs-keyword">if</span> rightCount &lt; leftCount &#123;<br>            tmp = <span class="hljs-built_in">append</span>(tmp, <span class="hljs-string">&quot;)&quot;</span>)<br>            backtrack(leftCount, rightCount+<span class="hljs-number">1</span>)<br>            tmp = tmp[:<span class="hljs-built_in">len</span>(tmp)<span class="hljs-number">-1</span>]<br>        &#125;<br>    &#125;<br><br>    backtrack(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="31-ä¸‹ä¸€ä¸ªæ’åˆ—"><a href="#31-ä¸‹ä¸€ä¸ªæ’åˆ—" class="headerlink" title="31. ä¸‹ä¸€ä¸ªæ’åˆ—"></a><a href="https://leetcode.cn/problems/next-permutation/">31. ä¸‹ä¸€ä¸ªæ’åˆ—</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å”‰ï¼ŒèƒŒè¯µé¢˜ï¼ŒåŸç†çœ‹é¢˜è§£å§</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">nextPermutation</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span>  &#123;<br>    n := <span class="hljs-built_in">len</span>(nums)<br>    i := n - <span class="hljs-number">2</span><br>    <span class="hljs-keyword">for</span> i &gt;= <span class="hljs-number">0</span> &amp;&amp; nums[i] &gt;= nums[i+<span class="hljs-number">1</span>] &#123;<br>        i--<br>    &#125;<br>    <span class="hljs-keyword">if</span> i &gt;= <span class="hljs-number">0</span> &#123;<br>        j := n - <span class="hljs-number">1</span><br>        <span class="hljs-keyword">for</span> j &gt;= <span class="hljs-number">0</span> &amp;&amp; nums[i] &gt;= nums[j] &#123;<br>            j--<br>        &#125;<br>        nums[i], nums[j] = nums[j], nums[i]<br>    &#125;<br>    reverse(nums[i+<span class="hljs-number">1</span>:])<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reverse</span><span class="hljs-params">(a []<span class="hljs-type">int</span>)</span></span> &#123;<br>    <span class="hljs-keyword">for</span> i, n := <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(a); i &lt; n/<span class="hljs-number">2</span>; i++ &#123;<br>        a[i], a[n<span class="hljs-number">-1</span>-i] = a[n<span class="hljs-number">-1</span>-i], a[i]<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="165-æ¯”è¾ƒç‰ˆæœ¬å·"><a href="#165-æ¯”è¾ƒç‰ˆæœ¬å·" class="headerlink" title="165. æ¯”è¾ƒç‰ˆæœ¬å·"></a><a href="https://leetcode.cn/problems/compare-version-numbers/">165. æ¯”è¾ƒç‰ˆæœ¬å·</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">compareVersion</span><span class="hljs-params">(version1 <span class="hljs-type">string</span>, version2 <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    v1 := strings.Split(version1, <span class="hljs-string">&quot;.&quot;</span>)<br>    v2 := strings.Split(version2, <span class="hljs-string">&quot;.&quot;</span>)<br><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(v1) || i &lt; <span class="hljs-built_in">len</span>(v2); i++ &#123;<br>        x, y := <span class="hljs-number">0</span>, <span class="hljs-number">0</span><br>        <span class="hljs-keyword">if</span> i &lt; <span class="hljs-built_in">len</span>(v1) &#123;<br>            x, _ = strconv.Atoi(v1[i])<br>        &#125;<br>        <span class="hljs-keyword">if</span> i &lt; <span class="hljs-built_in">len</span>(v2) &#123;<br>            y, _ = strconv.Atoi(v2[i])<br>        &#125;<br>        <span class="hljs-keyword">if</span> x &gt; y &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>        &#125;<br>        <span class="hljs-keyword">if</span> x &lt; y &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="69-x-çš„å¹³æ–¹æ ¹"><a href="#69-x-çš„å¹³æ–¹æ ¹" class="headerlink" title="69. x çš„å¹³æ–¹æ ¹ "></a><a href="https://leetcode.cn/problems/sqrtx/">69. x çš„å¹³æ–¹æ ¹ </a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mySqrt</span><span class="hljs-params">(x <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    l, r := <span class="hljs-number">0</span>, x<br>    ans := <span class="hljs-number">-1</span><br>    <span class="hljs-keyword">for</span> l &lt;= r &#123;<br>        mid := (l + r) / <span class="hljs-number">2</span><br>        <span class="hljs-keyword">if</span> mid * mid &lt;= x &#123;<br>            ans = mid<br>            l = mid + <span class="hljs-number">1</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            r = mid - <span class="hljs-number">1</span><br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> ans<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="8-å­—ç¬¦ä¸²è½¬æ¢æ•´æ•°-atoi"><a href="#8-å­—ç¬¦ä¸²è½¬æ¢æ•´æ•°-atoi" class="headerlink" title="8. å­—ç¬¦ä¸²è½¬æ¢æ•´æ•° (atoi)"></a><a href="https://leetcode.cn/problems/string-to-integer-atoi/">8. å­—ç¬¦ä¸²è½¬æ¢æ•´æ•° (atoi)</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;math&quot;</span><br><span class="hljs-string">&quot;strings&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">myAtoi</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">int</span> &#123;<br><span class="hljs-comment">// å»é™¤å‰å¯¼ç©ºæ ¼</span><br>s = strings.TrimLeft(s, <span class="hljs-string">&quot; &quot;</span>)<br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(s) == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>&#125;<br><br><span class="hljs-comment">// å¤„ç†ç¬¦å·</span><br>sign := <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> s[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;-&#x27;</span> &#123;<br>sign = <span class="hljs-number">-1</span><br>s = s[<span class="hljs-number">1</span>:]<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> s[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;+&#x27;</span> &#123;<br>s = s[<span class="hljs-number">1</span>:]<br>&#125;<br><br><span class="hljs-keyword">var</span> result <span class="hljs-type">int64</span> = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> _, ch := <span class="hljs-keyword">range</span> s &#123;<br><span class="hljs-comment">// é‡åˆ°éæ•°å­—å­—ç¬¦åˆ™åœæ­¢</span><br><span class="hljs-keyword">if</span> ch &lt; <span class="hljs-string">&#x27;0&#x27;</span> || ch &gt; <span class="hljs-string">&#x27;9&#x27;</span> &#123;<br><span class="hljs-keyword">break</span><br>&#125;<br><br>digit := <span class="hljs-type">int64</span>(ch - <span class="hljs-string">&#x27;0&#x27;</span>)<br>result = result*<span class="hljs-number">10</span> + digit<br><br><span class="hljs-comment">// æ£€æŸ¥æº¢å‡º</span><br><span class="hljs-keyword">if</span> sign == <span class="hljs-number">1</span> &amp;&amp; result &gt; math.MaxInt32 &#123;<br><span class="hljs-keyword">return</span> math.MaxInt32<br>&#125;<br><span class="hljs-keyword">if</span> sign == <span class="hljs-number">-1</span> &amp;&amp; -result &lt; math.MinInt32 &#123;<br><span class="hljs-keyword">return</span> math.MinInt32<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// åº”ç”¨ç¬¦å·</span><br>final := <span class="hljs-type">int64</span>(sign) * result<br><br><span class="hljs-comment">// ç¡®ä¿ç»“æœåœ¨32ä½æ•´æ•°èŒƒå›´å†…</span><br><span class="hljs-keyword">if</span> final &gt; math.MaxInt32 &#123;<br><span class="hljs-keyword">return</span> math.MaxInt32<br>&#125;<br><span class="hljs-keyword">if</span> final &lt; math.MinInt32 &#123;<br><span class="hljs-keyword">return</span> math.MinInt32<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-type">int</span>(final)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-ä¸¤æ•°ç›¸åŠ "><a href="#2-ä¸¤æ•°ç›¸åŠ " class="headerlink" title="2. ä¸¤æ•°ç›¸åŠ "></a><a href="https://leetcode.cn/problems/add-two-numbers/">2. ä¸¤æ•°ç›¸åŠ </a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">addTwoNumbers</span><span class="hljs-params">(l1 *ListNode, l2 *ListNode)</span></span> *ListNode &#123;<br>    dummy := &amp;ListNode&#123;&#125;<br>    p := dummy<br>    digit := <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> l1 != <span class="hljs-literal">nil</span> || l2 != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">var</span> v1, v2 <span class="hljs-type">int</span><br>        <span class="hljs-keyword">if</span> l1 != <span class="hljs-literal">nil</span> &#123;<br>            v1 = l1.Val<br>            l1 = l1.Next<br>        &#125;<br>        <span class="hljs-keyword">if</span> l2 != <span class="hljs-literal">nil</span> &#123;<br>            v2 = l2.Val<br>            l2 = l2.Next<br>        &#125;<br><br>        sum := v1 + v2 + digit<br>        <br>        val := sum % <span class="hljs-number">10</span><br><br>        node := &amp;ListNode&#123;Val: val&#125;<br>        p.Next = node<br>        p = p.Next<br><br>        digit = sum / <span class="hljs-number">10</span><br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> digit != <span class="hljs-number">0</span> &#123;<br>        p.Next = &amp;ListNode&#123;Val: digit&#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> dummy.Next<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="32-æœ€é•¿æœ‰æ•ˆæ‹¬å·"><a href="#32-æœ€é•¿æœ‰æ•ˆæ‹¬å·" class="headerlink" title="32. æœ€é•¿æœ‰æ•ˆæ‹¬å·"></a><a href="https://leetcode.cn/problems/longest-valid-parentheses/">32. æœ€é•¿æœ‰æ•ˆæ‹¬å·</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">longestValidParentheses</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-comment">// ç”¨äºä¿å­˜æœ€ç»ˆç»“æœ</span><br>    res := <span class="hljs-number">0</span><br>    <br>    stack := []<span class="hljs-type">int</span>&#123;&#125;<br>    <span class="hljs-comment">// ä¸ºäº†åˆå§‹æ—¶æ–¹ä¾¿ï¼Œæå‰å‹å…¥-1</span><br>    stack = <span class="hljs-built_in">append</span>(stack, <span class="hljs-number">-1</span>)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(s); i++ &#123;<br>        <span class="hljs-comment">// å¦‚æœæ˜¯å·¦æ‹¬å·ï¼Œå°±å‹å…¥æ ˆä¸­</span><br>        <span class="hljs-keyword">if</span> s[i] == <span class="hljs-string">&#x27;(&#x27;</span> &#123;<br>            stack = <span class="hljs-built_in">append</span>(stack, i)<br>        <span class="hljs-comment">// å¦‚æœæ˜¯å³æ‹¬å·ï¼Œå°±å°†æ ˆé¡¶å…ƒç´ å‡ºæ ˆï¼ˆé™¤äº†æ ˆåº•å…ƒç´ ï¼Œæ ˆä¸­è‚¯å®šå…¨éƒ¨éƒ½æ˜¯å·¦æ‹¬å·ã€‚æ ˆåº•å…ƒç´ æ˜¯éå†è¿‡çš„æœ€åçš„æ²¡æœ‰è¢«åŒ¹é…çš„å³æ‹¬å·ï¼‰</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            stack = stack[:<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>]<br>            <span class="hljs-comment">// å¦‚æœå‡ºæ ˆåæ ˆç©ºäº†ï¼Œå°±è¯´æ˜æ ˆåº•çš„å³æ‹¬å·è¢«å‡ºæ ˆäº†ï¼Œé‚£ä¹ˆå½“å‰çš„å³æ‹¬å·å°±æˆäº†æ–°çš„ä¸èƒ½è¢«åŒ¹é…çš„å³æ‹¬å·ï¼Œå‹å…¥æ ˆä¸­æˆä¸ºæ–°çš„æ ˆåº•</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(stack) == <span class="hljs-number">0</span> &#123;<br>                stack = <span class="hljs-built_in">append</span>(stack, i)<br>            <span class="hljs-comment">// å®æ—¶æ›´æ–°æœ€é•¿çš„åŒ¹é…é•¿åº¦</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                res = max(res, i - stack[<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>])<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="70-çˆ¬æ¥¼æ¢¯"><a href="#70-çˆ¬æ¥¼æ¢¯" class="headerlink" title="70. çˆ¬æ¥¼æ¢¯"></a><a href="https://leetcode.cn/problems/climbing-stairs/">70. çˆ¬æ¥¼æ¢¯</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">climbStairs</span><span class="hljs-params">(n <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> n == <span class="hljs-number">1</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> n == <span class="hljs-number">2</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span><br>    &#125;<br>    dp := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, n+<span class="hljs-number">1</span>)<br>    dp[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span><br>    dp[<span class="hljs-number">2</span>] = <span class="hljs-number">2</span><br><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">3</span>; i &lt; n + <span class="hljs-number">1</span>; i++ &#123;<br>        dp[i] = dp[i<span class="hljs-number">-1</span>] + dp[i<span class="hljs-number">-2</span>]<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> dp[n]<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="105-ä»å‰åºä¸ä¸­åºéå†åºåˆ—æ„é€ äºŒå‰æ ‘"><a href="#105-ä»å‰åºä¸ä¸­åºéå†åºåˆ—æ„é€ äºŒå‰æ ‘" class="headerlink" title="105. ä»å‰åºä¸ä¸­åºéå†åºåˆ—æ„é€ äºŒå‰æ ‘"></a><a href="https://leetcode.cn/problems/construct-binary-tree-from-preorder-and-inorder-traversal/">105. ä»å‰åºä¸ä¸­åºéå†åºåˆ—æ„é€ äºŒå‰æ ‘</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">buildTree</span><span class="hljs-params">(preorder []<span class="hljs-type">int</span>, inorder []<span class="hljs-type">int</span>)</span></span> *TreeNode &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(preorder) == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br><br>    root := &amp;TreeNode&#123;preorder[<span class="hljs-number">0</span>], <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>&#125;<br><br>    <span class="hljs-comment">// æ‰¾åˆ°ä¸­åºéå†ä¸­çš„æ ¹èŠ‚ç‚¹</span><br>    i := <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> ; i &lt; <span class="hljs-built_in">len</span>(inorder); i++ &#123;<br>        <span class="hljs-keyword">if</span> inorder[i] == preorder[<span class="hljs-number">0</span>] &#123;<br>            <span class="hljs-keyword">break</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// ä¸­åºéå†æ ¹èŠ‚ç‚¹å·¦è¾¹çš„èŠ‚ç‚¹ä¸ºå·¦å­æ ‘ï¼Œå³è¾¹çš„èŠ‚ç‚¹ä¸ºå³å­æ ‘</span><br>    root.Left = buildTree(preorder[<span class="hljs-number">1</span>:<span class="hljs-built_in">len</span>(inorder[:i])+<span class="hljs-number">1</span>], inorder[:i])<br>    root.Right = buildTree(preorder[<span class="hljs-built_in">len</span>(inorder[:i])+<span class="hljs-number">1</span>:], inorder[i+<span class="hljs-number">1</span>:])<br><br>    <span class="hljs-keyword">return</span> root<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="78-å­é›†"><a href="#78-å­é›†" class="headerlink" title="78. å­é›†"></a><a href="https://leetcode.cn/problems/subsets/">78. å­é›†</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">subsets</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> [][]<span class="hljs-type">int</span> &#123;<br>    res := [][]<span class="hljs-type">int</span>&#123;&#125;<br>    set := []<span class="hljs-type">int</span>&#123;&#125;<br><br>    <span class="hljs-keyword">var</span> dfs <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span></span><br>    dfs = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(cur <span class="hljs-type">int</span>)</span></span> &#123;<br>        <span class="hljs-comment">// å¦‚æœé•¿åº¦å·²ç»è¶…è¿‡äº†numsé•¿åº¦ï¼Œè¯´æ˜å·²ç»å¾—åˆ°äº†ä¸€ä¸ªç»“æœ</span><br>        <span class="hljs-keyword">if</span> cur == <span class="hljs-built_in">len</span>(nums) &#123;<br>            <span class="hljs-comment">// è¿™é‡Œè¦æ³¨æ„ï¼Œä¸è¦æŠŠsetç›´æ¥appendåˆ°ç»“æœé›†ä¸­ï¼Œå› ä¸ºåé¢è¿˜è¦å¯¹setè¿›è¡Œä¿®æ”¹ï¼Œå¼•ç”¨ä¼ é€’ï¼Œä¼šå—å½±å“</span><br>            <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°ç»„ï¼ŒåŠ å…¥ç»“æœé›†ä¸­</span><br>            res = <span class="hljs-built_in">append</span>(res, <span class="hljs-built_in">append</span>([]<span class="hljs-type">int</span>&#123;&#125;, set...))<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-comment">// é€‰æ‹©å½“å‰å…ƒç´ </span><br>        set = <span class="hljs-built_in">append</span>(set, nums[cur])<br>        dfs(cur+<span class="hljs-number">1</span>)<br><br>        <span class="hljs-comment">// ä¸é€‰æ‹©å½“å‰å…ƒç´ </span><br>        set = set[:<span class="hljs-built_in">len</span>(set)<span class="hljs-number">-1</span>]<br>        dfs(cur+<span class="hljs-number">1</span>)<br>    &#125;<br><br>    dfs(<span class="hljs-number">0</span>)<br>    <br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="151-åè½¬å­—ç¬¦ä¸²ä¸­çš„å•è¯"><a href="#151-åè½¬å­—ç¬¦ä¸²ä¸­çš„å•è¯" class="headerlink" title="151. åè½¬å­—ç¬¦ä¸²ä¸­çš„å•è¯"></a><a href="https://leetcode.cn/problems/reverse-words-in-a-string/">151. åè½¬å­—ç¬¦ä¸²ä¸­çš„å•è¯</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reverseWords</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>    <span class="hljs-comment">// å»é™¤ä¸¤ç«¯ç©ºæ ¼</span><br>    s = strings.Trim(s, <span class="hljs-string">&quot; &quot;</span>)<br><br>    <span class="hljs-comment">// åŒæŒ‡é’ˆ</span><br>    i := <span class="hljs-built_in">len</span>(s) - <span class="hljs-number">1</span><br>    j := <span class="hljs-built_in">len</span>(s) - <span class="hljs-number">1</span><br>    res := []<span class="hljs-type">string</span>&#123;&#125;<br><br>    <span class="hljs-comment">// ä»åå‘å‰éå†</span><br>    <span class="hljs-keyword">for</span> i &gt;= <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-comment">// æœç´¢é¦–ä¸ªç©ºæ ¼</span><br>        <span class="hljs-keyword">for</span> i &gt;= <span class="hljs-number">0</span> &amp;&amp; s[i] != <span class="hljs-string">&#x27; &#x27;</span> &#123;<br>            i -= <span class="hljs-number">1</span><br>        &#125;<br>        <span class="hljs-comment">// è®°å½•å•è¯</span><br>        res = <span class="hljs-built_in">append</span>(res, s[i+<span class="hljs-number">1</span>:j+<span class="hljs-number">1</span>])<br>        <span class="hljs-comment">// è·³è¿‡å•è¯é—´ç©ºæ ¼</span><br>        <span class="hljs-keyword">for</span> i &gt;= <span class="hljs-number">0</span> &amp;&amp; s[i] == <span class="hljs-string">&#x27; &#x27;</span> &#123;<br>            i -= <span class="hljs-number">1</span><br>        &#125;<br>        <span class="hljs-comment">// jæŒ‡å‘ä¸‹ä¸ªå•è¯çš„å°¾å­—ç¬¦</span><br>        j = i<br>    &#125;<br><br>    <span class="hljs-comment">// æ‹¼æ¥è¿”å›</span><br>    <span class="hljs-keyword">return</span> strings.Join(res, <span class="hljs-string">&quot; &quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="155-æœ€å°æ ˆ"><a href="#155-æœ€å°æ ˆ" class="headerlink" title="155. æœ€å°æ ˆ"></a><a href="https://leetcode.cn/problems/min-stack/">155. æœ€å°æ ˆ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// æ€è·¯ï¼šä½¿ç”¨ä¸€ä¸ªè¾…åŠ©æ ˆï¼Œæ¯æ¬¡å‹æ ˆæ—¶åŒæ­¥å¾€è¾…åŠ©æ ˆä¸­å‹å…¥å½“å‰æœ€å°å€¼ï¼Œå‡ºæ ˆæ—¶ä¹Ÿæ˜¯åŒæ­¥å‡ºæ ˆã€‚</span><br><span class="hljs-keyword">type</span> MinStack <span class="hljs-keyword">struct</span> &#123;<br>    stack []<span class="hljs-type">int</span><br>    minStack []<span class="hljs-type">int</span><br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Constructor</span><span class="hljs-params">()</span></span> MinStack &#123;<br>    <span class="hljs-keyword">return</span> MinStack&#123;<br>        stack: []<span class="hljs-type">int</span>&#123;&#125;,<br>        minStack: []<span class="hljs-type">int</span>&#123;math.MaxInt64&#125;,<br>    &#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *MinStack)</span></span> Push(val <span class="hljs-type">int</span>)  &#123;<br>    this.stack = <span class="hljs-built_in">append</span>(this.stack, val)<br>    top := this.minStack[<span class="hljs-built_in">len</span>(this.minStack)<span class="hljs-number">-1</span>]<br>    this.minStack = <span class="hljs-built_in">append</span>(this.minStack, min(val, top))<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *MinStack)</span></span> Pop()  &#123;<br>    this.stack = this.stack[:<span class="hljs-built_in">len</span>(this.stack)<span class="hljs-number">-1</span>]<br>    this.minStack = this.minStack[:<span class="hljs-built_in">len</span>(this.minStack)<span class="hljs-number">-1</span>]<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *MinStack)</span></span> Top() <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">return</span> this.stack[<span class="hljs-built_in">len</span>(this.stack)<span class="hljs-number">-1</span>]<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *MinStack)</span></span> GetMin() <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">return</span> this.minStack[<span class="hljs-built_in">len</span>(this.minStack)<span class="hljs-number">-1</span>]<br>&#125;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Your MinStack object will be instantiated and called as such:</span><br><span class="hljs-comment"> * obj := Constructor();</span><br><span class="hljs-comment"> * obj.Push(val);</span><br><span class="hljs-comment"> * obj.Pop();</span><br><span class="hljs-comment"> * param_3 := obj.Top();</span><br><span class="hljs-comment"> * param_4 := obj.GetMin();</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ä½¿ç”¨å•ä¸ªæ ˆçš„è§£æ³•ï¼Œé€šè¿‡å‘æ ˆä¸­å‹å…¥å·®å€¼å®ç°</span><br><span class="hljs-keyword">type</span> MinStack <span class="hljs-keyword">struct</span> &#123;<br>    stack []<span class="hljs-type">int</span><br>    minValue <span class="hljs-type">int</span><br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Constructor</span><span class="hljs-params">()</span></span> MinStack &#123;<br>    <span class="hljs-keyword">return</span> MinStack&#123;<br>        stack: []<span class="hljs-type">int</span>&#123;&#125;,<br>        minValue: <span class="hljs-number">-1</span>,<br>    &#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *MinStack)</span></span> Push(val <span class="hljs-type">int</span>)  &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(this.stack) == <span class="hljs-number">0</span> &#123;<br>        this.stack = <span class="hljs-built_in">append</span>(this.stack, <span class="hljs-number">0</span>)<br>        this.minValue = val<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        diff := val - this.minValue<br>        this.stack = <span class="hljs-built_in">append</span>(this.stack, diff)<br>        <span class="hljs-keyword">if</span> diff &lt; <span class="hljs-number">0</span> &#123;<br>            this.minValue = val<br>        &#125;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *MinStack)</span></span> Pop()  &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(this.stack) == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    diff := this.stack[<span class="hljs-built_in">len</span>(this.stack)<span class="hljs-number">-1</span>]<br>    this.stack = this.stack[:<span class="hljs-built_in">len</span>(this.stack)<span class="hljs-number">-1</span>]<br><br>    <span class="hljs-comment">// å¦‚æœdiffå°äº0ï¼Œåˆ™å½“å‰æœ€å°å€¼å°±æ˜¯æ ˆé¡¶çš„åŸå§‹å…ƒç´ </span><br>    <span class="hljs-comment">// å¹¶ä¸”ï¼Œå½“å‰æœ€å°å€¼ - diffå°±æ˜¯ä¸Šä¸€æ¬¡çš„æœ€å°å€¼ï¼ˆå‚è€ƒpushä¸­çš„é€»è¾‘ï¼‰</span><br>    <span class="hljs-comment">// è¿™é‡Œç›¸å½“äºåœ¨å‡ºæ ˆæ—¶æ¢å¤ä¸Šä¸€æ¬¡çš„æœ€å°å€¼ï¼Œæ˜¯å…³é”®çš„ä¸€æ­¥</span><br>    <span class="hljs-keyword">if</span> diff &lt; <span class="hljs-number">0</span> &#123;<br>        this.minValue = this.minValue - diff<br>    &#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *MinStack)</span></span> Top() <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> this.stack[<span class="hljs-built_in">len</span>(this.stack)<span class="hljs-number">-1</span>] &lt; <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> this.minValue<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> this.stack[<span class="hljs-built_in">len</span>(this.stack)<span class="hljs-number">-1</span>] + this.minValue<br>    &#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *MinStack)</span></span> GetMin() <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(this.stack) == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> this.minValue<br>&#125;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Your MinStack object will be instantiated and called as such:</span><br><span class="hljs-comment"> * obj := Constructor();</span><br><span class="hljs-comment"> * obj.Push(val);</span><br><span class="hljs-comment"> * obj.Pop();</span><br><span class="hljs-comment"> * param_3 := obj.Top();</span><br><span class="hljs-comment"> * param_4 := obj.GetMin();</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><h2 id="129-æ±‚æ ¹èŠ‚ç‚¹åˆ°å¶èŠ‚ç‚¹æ•°å­—ä¹‹å’Œ"><a href="#129-æ±‚æ ¹èŠ‚ç‚¹åˆ°å¶èŠ‚ç‚¹æ•°å­—ä¹‹å’Œ" class="headerlink" title="129. æ±‚æ ¹èŠ‚ç‚¹åˆ°å¶èŠ‚ç‚¹æ•°å­—ä¹‹å’Œ"></a><a href="https://leetcode.cn/problems/sum-root-to-leaf-numbers/">129. æ±‚æ ¹èŠ‚ç‚¹åˆ°å¶èŠ‚ç‚¹æ•°å­—ä¹‹å’Œ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sumNumbers</span><span class="hljs-params">(root *TreeNode)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">return</span> dfs(root, <span class="hljs-number">0</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">dfs</span><span class="hljs-params">(root *TreeNode, prevSum <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br>    sum := prevSum * <span class="hljs-number">10</span> + root.Val<br>    <span class="hljs-keyword">if</span> root.Left == <span class="hljs-literal">nil</span> &amp;&amp; root.Right == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> sum<br>    &#125;<br>    <span class="hljs-keyword">return</span> dfs(root.Left, sum) + dfs(root.Right, sum)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="101-å¯¹ç§°äºŒå‰æ ‘"><a href="#101-å¯¹ç§°äºŒå‰æ ‘" class="headerlink" title="101. å¯¹ç§°äºŒå‰æ ‘"></a><a href="https://leetcode.cn/problems/symmetric-tree/">101. å¯¹ç§°äºŒå‰æ ‘</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">isSymmetric</span><span class="hljs-params">(root *TreeNode)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">return</span> check(root.Left, root.Right)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">check</span><span class="hljs-params">(p, q *TreeNode)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">if</span> p == <span class="hljs-literal">nil</span> &amp;&amp; q == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> p == <span class="hljs-literal">nil</span> || q == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> p.Val == q.Val &amp;&amp; check(p.Left, q.Right) &amp;&amp; check(p.Right, q.Left)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="104-äºŒå‰æ ‘çš„æœ€å¤§æ·±åº¦"><a href="#104-äºŒå‰æ ‘çš„æœ€å¤§æ·±åº¦" class="headerlink" title="104. äºŒå‰æ ‘çš„æœ€å¤§æ·±åº¦"></a><a href="https://leetcode.cn/problems/maximum-depth-of-binary-tree/">104. äºŒå‰æ ‘çš„æœ€å¤§æ·±åº¦</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">maxDepth</span><span class="hljs-params">(root *TreeNode)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> max(maxDepth(root.Left), maxDepth(root.Right)) + <span class="hljs-number">1</span><br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="34-åœ¨æ’åºæ•°ç»„ä¸­æŸ¥æ‰¾å…ƒç´ çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªä½ç½®"><a href="#34-åœ¨æ’åºæ•°ç»„ä¸­æŸ¥æ‰¾å…ƒç´ çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªä½ç½®" class="headerlink" title="34. åœ¨æ’åºæ•°ç»„ä¸­æŸ¥æ‰¾å…ƒç´ çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªä½ç½®"></a><a href="https://leetcode.cn/problems/find-first-and-last-position-of-element-in-sorted-array/">34. åœ¨æ’åºæ•°ç»„ä¸­æŸ¥æ‰¾å…ƒç´ çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªä½ç½®</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// lowerBound è¿”å›æœ€å°çš„æ»¡è¶³ nums[i] &gt;= target çš„ä¸‹æ ‡ i</span><br><span class="hljs-comment">// å¦‚æœæ•°ç»„ä¸ºç©ºï¼Œæˆ–è€…æ‰€æœ‰æ•°éƒ½ &lt; targetï¼Œåˆ™è¿”å› len(nums)</span><br><span class="hljs-comment">// è¦æ±‚ nums æ˜¯éé€’å‡çš„ï¼Œå³ nums[i] &lt;= nums[i + 1]</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">lowerBound</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>, target <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    left, right := <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(nums)<span class="hljs-number">-1</span> <span class="hljs-comment">// é—­åŒºé—´ [left, right]</span><br>    <span class="hljs-keyword">for</span> left &lt;= right &#123; <span class="hljs-comment">// åŒºé—´ä¸ä¸ºç©º</span><br>        <span class="hljs-comment">// å¾ªç¯ä¸å˜é‡ï¼š</span><br>        <span class="hljs-comment">// nums[left-1] &lt; target</span><br>        <span class="hljs-comment">// nums[right+1] &gt;= target</span><br>        mid := left + (right-left)/<span class="hljs-number">2</span><br>        <span class="hljs-keyword">if</span> nums[mid] &gt;= target &#123;<br>            right = mid - <span class="hljs-number">1</span> <span class="hljs-comment">// èŒƒå›´ç¼©å°åˆ° [left, mid-1]</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            left = mid + <span class="hljs-number">1</span> <span class="hljs-comment">// èŒƒå›´ç¼©å°åˆ° [mid+1, right]</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// å¾ªç¯ç»“æŸå left = right+1</span><br>    <span class="hljs-comment">// æ­¤æ—¶ nums[left-1] &lt; target è€Œ nums[left] = nums[right+1] &gt;= target</span><br>    <span class="hljs-comment">// æ‰€ä»¥ left å°±æ˜¯ç¬¬ä¸€ä¸ª &gt;= target çš„å…ƒç´ ä¸‹æ ‡</span><br>    <span class="hljs-keyword">return</span> left<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">searchRange</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>, target <span class="hljs-type">int</span>)</span></span> []<span class="hljs-type">int</span> &#123;<br>    start := lowerBound(nums, target)<br>    <span class="hljs-keyword">if</span> start == <span class="hljs-built_in">len</span>(nums) || nums[start] != target &#123;<br>        <span class="hljs-keyword">return</span> []<span class="hljs-type">int</span>&#123;<span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>&#125; <span class="hljs-comment">// nums ä¸­æ²¡æœ‰ target</span><br>    &#125;<br>    <span class="hljs-comment">// å¦‚æœ start å­˜åœ¨ï¼Œé‚£ä¹ˆ end å¿…å®šå­˜åœ¨</span><br>    end := lowerBound(nums, target+<span class="hljs-number">1</span>) - <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> []<span class="hljs-type">int</span>&#123;start, end&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="144-äºŒå‰æ ‘çš„å‰åºéå†"><a href="#144-äºŒå‰æ ‘çš„å‰åºéå†" class="headerlink" title="144. äºŒå‰æ ‘çš„å‰åºéå†"></a><a href="https://leetcode.cn/problems/binary-tree-preorder-traversal/">144. äºŒå‰æ ‘çš„å‰åºéå†</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">preorderTraversal</span><span class="hljs-params">(root *TreeNode)</span></span> []<span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br>    res := []<span class="hljs-type">int</span>&#123;&#125;<br>    <span class="hljs-keyword">var</span> preorder <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(root *TreeNode)</span></span><br>    preorder = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(root *TreeNode)</span></span> &#123;<br>        <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        res = <span class="hljs-built_in">append</span>(res, root.Val)<br>        preorder(root.Left)<br>        preorder(root.Right)<br>    &#125;<br>    preorder(root)<br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>applyä¹‹åçš„æµç¨‹</title>
    <link href="/2025/04/28/apply%E4%B9%8B%E5%90%8E%E7%9A%84%E6%B5%81%E7%A8%8B/"/>
    <url>/2025/04/28/apply%E4%B9%8B%E5%90%8E%E7%9A%84%E6%B5%81%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="kubectl-apply-f-xxxx-yamlä¹‹åçš„è¿‡ç¨‹"><a href="#kubectl-apply-f-xxxx-yamlä¹‹åçš„è¿‡ç¨‹" class="headerlink" title="kubectl apply -f xxxx.yamlä¹‹åçš„è¿‡ç¨‹"></a>kubectl apply -f xxxx.yamlä¹‹åçš„è¿‡ç¨‹</h1><p>æ•´ä¸ªè¿‡ç¨‹é¦–å…ˆä»kubectlå‘èµ·ï¼Œä»¥kubeletç”Ÿæˆç›¸åº”çš„podä¸ºç»“æŸã€‚</p><ul><li>kubectl<ol><li>éªŒè¯å’Œç”Ÿæˆå™¨</li><li>API ç‰ˆæœ¬åå•†ä¸ API ç»„</li><li>å‘é€httpè¯·æ±‚åˆ°apiserver</li></ol></li><li>apiserver<ol><li>å®¢æˆ·ç«¯èº«ä»½è®¤è¯</li><li>æˆæƒ</li><li>å‡†å…¥æ§åˆ¶</li><li>æ•°æ®ååºåˆ—åŒ–ï¼Œå­˜å…¥etcd</li></ol></li><li>etcd<ol><li>è·å¾—æ•°æ®</li><li>åŒæ­¥æ•°æ®</li><li>ä¿å­˜æ•°æ®</li></ol></li><li>controller-manager<ol><li>deploy-controller</li><li>ReplicaSet-controller</li><li>pod-controller</li></ol></li><li>scheduler<ol><li>é¢„é€‰ç­–ç•¥</li><li>ä¼˜é€‰ç­–ç•¥</li><li>ç»‘å®šèŠ‚ç‚¹</li></ol></li><li>kubelet<ol><li>podæ•°æ®åŒæ­¥</li><li>åˆå§‹åŒ–ï¼Œèµ„æºï¼Œå·</li><li>CRIå’Œpauseå®¹å™¨</li><li>CNIå’Œpodç½‘ç»œ</li><li>å®¹å™¨å¯åŠ¨è¿‡ç¨‹</li></ol></li></ul><p><img src="/2025/04/28/apply%E4%B9%8B%E5%90%8E%E7%9A%84%E6%B5%81%E7%A8%8B/what-happens-when-k8s-c0b581cfa122439e84f0e697060fde49.svg" alt="whathappenswhenk8s.svg"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Goæ’åºåŒ…sort</title>
    <link href="/2025/04/23/Go%E6%8E%92%E5%BA%8F%E5%8C%85sort/"/>
    <url>/2025/04/23/Go%E6%8E%92%E5%BA%8F%E5%8C%85sort/</url>
    
    <content type="html"><![CDATA[<h1 id="Go-sortåŒ…"><a href="#Go-sortåŒ…" class="headerlink" title="Go sortåŒ…"></a>Go sortåŒ…</h1><p>å‚è€ƒï¼š<a href="https://juejin.cn/post/7140873783362977828">https://juejin.cn/post/7140873783362977828</a></p><h2 id="ä¸‰ç§åŸºæœ¬ç±»å‹å‡åºæ’åº"><a href="#ä¸‰ç§åŸºæœ¬ç±»å‹å‡åºæ’åº" class="headerlink" title="ä¸‰ç§åŸºæœ¬ç±»å‹å‡åºæ’åº"></a>ä¸‰ç§åŸºæœ¬ç±»å‹å‡åºæ’åº</h2><p>å¦‚æœè¦æ’åºçš„åˆ‡ç‰‡æ˜¯<code>int64, float64, string</code>ç±»å‹ï¼Œä¸”æ˜¯å‡åºæ’åºï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢ä¸‰ä¸ªå‡½æ•°è¿›è¡Œæ’åºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">sort.Ints(x []<span class="hljs-type">int</span>)<br>sort.Float64s(x []<span class="hljs-type">float64</span>)<br>sort.Strings(x []<span class="hljs-type">string</span>)<br></code></pre></td></tr></table></figure><h2 id="sort-Sort-data-Interface"><a href="#sort-Sort-data-Interface" class="headerlink" title="sort.Sort(data Interface)"></a>sort.Sort(data Interface)</h2><p>è¿™ä¸ªå‡½æ•°å¯ä»¥å¯¹è‡ªå®šä¹‰ç±»å‹çš„åˆ‡ç‰‡è¿›è¡Œæ’åºï¼Œå‰ææ˜¯è¿™ç§è‡ªå®šä¹‰ç±»å‹å¾—å®ç°<code>Interface</code>æ¥å£.</p><p>ä»»ä½•å®ç°äº†ä»¥ä¸‹æ¥å£çš„ç±»å‹ï¼Œéƒ½å¯ä»¥è°ƒç”¨<code>sort.Sort()</code>è¿›è¡Œæ’åº</p><p><strong>Interface</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Interface <span class="hljs-keyword">interface</span> &#123;<br>Len() <span class="hljs-type">int</span><br>Less(i, j <span class="hljs-type">int</span>) <span class="hljs-type">bool</span><br>Swap(i, j <span class="hljs-type">int</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>intç±»å‹ä¸¾ä¾‹</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> sortInt []<span class="hljs-type">int</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(arr sortInt)</span></span> Len() <span class="hljs-type">int</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(arr)<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(arr sortInt)</span></span> Less(i, j <span class="hljs-type">int</span>) <span class="hljs-type">bool</span> &#123;<br><span class="hljs-keyword">return</span> arr[i] &lt; arr[j]<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(arr sortInt)</span></span> Swap(i, j <span class="hljs-type">int</span>) &#123;<br>arr[i], arr[j] = arr[j], arr[i]<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>arr := []<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">3</span>, <span class="hljs-number">10</span>&#125;<br><span class="hljs-keyword">var</span> _arr sortInt = arr<br>sort.Sort(_arr)<br>sort.Sort(sort.Reverse(_arr))  <span class="hljs-comment">// é€†åºæ’åº</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>structç±»å‹ä¸¾ä¾‹</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> ä»£ç è§£è¯»å¤åˆ¶ä»£ç <span class="hljs-keyword">type</span> Students []Student<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s Students)</span></span> Len() <span class="hljs-type">int</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(s)<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s Students)</span></span> Less(i, j <span class="hljs-type">int</span>) <span class="hljs-type">bool</span> &#123;<br><span class="hljs-keyword">return</span> s[i].score &lt; s[j].score<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s Students)</span></span> Swap(i, j <span class="hljs-type">int</span>) &#123;<br>s[i], s[j] = s[j], s[i]<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> students Students<br>students = []Student&#123;<br>Student&#123;<span class="hljs-string">&quot;zhangsan&quot;</span>, <span class="hljs-number">89</span>&#125;,<br>Student&#123;<span class="hljs-string">&quot;lisi&quot;</span>, <span class="hljs-number">98</span>&#125;,<br>Student&#123;<span class="hljs-string">&quot;wangwu&quot;</span>, <span class="hljs-number">78</span>&#125;,<br>&#125;<br>sort.Sort(students)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="sort-Slice-x-interface-less-func-i-j-int-bool"><a href="#sort-Slice-x-interface-less-func-i-j-int-bool" class="headerlink" title="sort.Slice(x interface{}, less func(i, j int) bool)"></a>sort.Slice(x interface{}, less func(i, j int) bool)</h2><p>åªéœ€è¦ä¼ å…¥ä¸€ä¸ªè‡ªå®šä¹‰çš„æ¯”è¾ƒå‡½æ•°å°±å¯ä»¥å¯¹åˆ‡ç‰‡è¿›è¡Œæ’åºï¼Œæ–¹ä¾¿å¿«æ·ã€‚</p><p><strong>intç±»å‹ä¸¾ä¾‹</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go">arr := []<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">3</span>, <span class="hljs-number">10</span>&#125;<br>sort.Slice(arr, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, j <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br><span class="hljs-keyword">return</span> arr[i] &gt; arr[j]<br>&#125;)<br></code></pre></td></tr></table></figure><p><strong>structç±»å‹ä¸¾ä¾‹</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go">students := []Student&#123;<br>Student&#123;<span class="hljs-string">&quot;zhangsan&quot;</span>, <span class="hljs-number">89</span>&#125;,<br>Student&#123;<span class="hljs-string">&quot;lisi&quot;</span>, <span class="hljs-number">98</span>&#125;,<br>Student&#123;<span class="hljs-string">&quot;wangwu&quot;</span>, <span class="hljs-number">78</span>&#125;,<br>&#125;<br>sort.Slice(students, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, j <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br><span class="hljs-keyword">return</span> students[i].score &gt; students[j].score<br>&#125;)<br>fmt.Println(students)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Goç®—æ³•é¢˜-äºŒ</title>
    <link href="/2025/04/21/Go%E7%AE%97%E6%B3%95%E9%A2%98-%E4%BA%8C/"/>
    <url>/2025/04/21/Go%E7%AE%97%E6%B3%95%E9%A2%98-%E4%BA%8C/</url>
    
    <content type="html"><![CDATA[<h2 id="236-äºŒå‰æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ"><a href="#236-äºŒå‰æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ" class="headerlink" title="236. äºŒå‰æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ"></a><a href="https://leetcode.cn/problems/lowest-common-ancestor-of-a-binary-tree/">236. äºŒå‰æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-comment">// æ‰¾åˆ°æœ€è¿‘å…¬å…±ç¥–å…ˆ or æ‰¾åˆ°p/qæœ¬èº«</span><br> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">lowestCommonAncestor</span><span class="hljs-params">(root, p, q *TreeNode)</span></span> *TreeNode &#123;<br>    <span class="hljs-comment">// å¦‚æœå·²ç»åˆ°è¾¾åº•éƒ¨ï¼Œç›´æ¥è¿”å›</span><br>    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br><br>    <span class="hljs-comment">// å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯pæˆ–è€…qï¼Œè¿”å›è¯¥èŠ‚ç‚¹</span><br>    <span class="hljs-keyword">if</span> root.Val == p.Val || root.Val == q.Val &#123;<br>        <span class="hljs-keyword">return</span> root<br>    &#125;<br><br>    <span class="hljs-comment">// åœ¨å·¦å­æ ‘ä¸­æ‰¾åˆ°æœ€è¿‘å…¬å…±ç¥–å…ˆ æˆ– åœ¨å·¦å­æ ‘ä¸­æ‰¾åˆ°p/q</span><br>    left := lowestCommonAncestor(root.Left, p, q)<br><br>    <span class="hljs-comment">// åœ¨å³å­æ ‘ä¸­æ‰¾åˆ°æœ€è¿‘å…¬å…±ç¥–å…ˆ æˆ– åœ¨å³å­æ ‘ä¸­æ‰¾åˆ°p/q</span><br>    right := lowestCommonAncestor(root.Right, p, q)<br>    <br>    <span class="hljs-comment">// å·¦å­æ ‘ä¸­æ‰¾åˆ°äº†p/qï¼Œå³å­æ ‘ä¸­ä¹Ÿæ‰¾åˆ°äº†p/q</span><br>    <span class="hljs-comment">// åˆ™å½“å‰èŠ‚ç‚¹ä¸ºæœ€è¿‘å…¬å…±ç¥–å…ˆï¼ˆåªæœ‰æœ€è¿‘å…¬å…±ç¥–å…ˆæ»¡è¶³è¯¥æ¡ä»¶ï¼‰</span><br>    <span class="hljs-keyword">if</span> left != <span class="hljs-literal">nil</span> &amp;&amp; right != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> root<br>    &#125;<br><br>    <span class="hljs-comment">// å¦‚æœåªæ˜¯æ‰¾åˆ°äº†ä¸€ä¸ªï¼Œåˆ™è¿”å›æ‰¾åˆ°çš„é‚£ä¸ªï¼Œè¡¨ç¤ºä»è¯¥èŠ‚ç‚¹å¾€ä¸‹æœ‰ä¸€ä¸ªp/q</span><br>    <span class="hljs-comment">// å¦‚æœéƒ½æ²¡æ‰¾åˆ°ï¼Œè¿”å›nil</span><br>    <span class="hljs-keyword">if</span> left == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> right<br>    &#125;<br>    <span class="hljs-keyword">return</span> left<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="92-åè½¬é“¾è¡¨-II"><a href="#92-åè½¬é“¾è¡¨-II" class="headerlink" title="92. åè½¬é“¾è¡¨ II"></a><a href="https://leetcode.cn/problems/reverse-linked-list-ii/">92. åè½¬é“¾è¡¨ II</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-comment">// å¤´æ’æ³•ä¸€æ¬¡éå†</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reverseBetween</span><span class="hljs-params">(head *ListNode, left <span class="hljs-type">int</span>, right <span class="hljs-type">int</span>)</span></span> *ListNode &#123;<br>    <span class="hljs-comment">// è®¾ç½®dummyèŠ‚ç‚¹æ˜¯æ­¤ç±»é—®é¢˜çš„ä¸€èˆ¬åšæ³•</span><br>    dummy := &amp;ListNode&#123;Next: head&#125;<br>    pre := dummy<br><br>    <span class="hljs-comment">// æ‰¾åˆ°leftçš„å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä½œä¸ºpre</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; left<span class="hljs-number">-1</span>; i++ &#123;<br>        pre = pre.Next<br>    &#125;<br><br>    <span class="hljs-comment">// leftèŠ‚ç‚¹ä½œä¸ºcur</span><br>    cur := pre.Next<br><br>    <span class="hljs-comment">// ä»leftå¼€å§‹éå†ï¼Œæ¯æ¬¡å¾ªç¯æŠŠå½“å‰èŠ‚ç‚¹çš„åä¸€ä¸ªèŠ‚ç‚¹æ’å…¥åˆ°preåé¢ï¼ˆè¯¥æ®µé“¾è¡¨çš„å¤´éƒ¨ï¼‰</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; right-left; i++ &#123;<br>        next := cur.Next<br>        cur.Next = next.Next<br>        next.Next = pre.Next<br>        pre.Next = next<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> dummy.Next<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="322-é›¶é’±å…‘æ¢"><a href="#322-é›¶é’±å…‘æ¢" class="headerlink" title="322. é›¶é’±å…‘æ¢"></a><a href="https://leetcode.cn/problems/coin-change/">322. é›¶é’±å…‘æ¢</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">coinChange</span><span class="hljs-params">(coins []<span class="hljs-type">int</span>, amount <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> amount == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br>    <span class="hljs-comment">// dp[i]ä¸ºç»„æˆæ•°é‡ä¸ºiçš„é‡‘é¢æ‰€éœ€çš„æœ€å°ç¡¬å¸æ•°</span><br>    dp := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, amount+<span class="hljs-number">1</span>)<br>    dp[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span><br>    <span class="hljs-comment">// ä¸ºdp[i]èµ‹åˆå§‹å€¼</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt;= amount; i++ &#123;<br>        <span class="hljs-comment">// è¿™é‡Œçš„amount+1å¹¶æ²¡æœ‰å®é™…æ„ä¹‰ï¼Œä»…ä»…æ˜¯ä¸ºäº†æ–¹ä¾¿åˆ¤æ–­æ˜¯å¦æœ‰è§£ï¼Œä»»ä½•ä¸€ä¸ªå¤§äºamountçš„æ•°å‡å¯</span><br>        <span class="hljs-comment">// å› ä¸ºç»„æˆamountæ‰€éœ€çš„ç¡¬å¸æ•°é‡åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½ä¸ä¼šå¤§äºamount</span><br>        dp[i] = amount + <span class="hljs-number">1</span><br>    &#125;<br>    <br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt;= amount; i++ &#123;<br>        <span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; <span class="hljs-built_in">len</span>(coins); j++ &#123;<br>            <span class="hljs-keyword">if</span> coins[j] &lt;= i &#123;<br>                <span class="hljs-comment">// ç»„æˆi-coins[j]çš„æœ€å°ç¡¬å¸æ•°ï¼ŒåŠ ä¸Šæœ¬æ¬¡çš„ä¸€ä¸ªç¡¬å¸</span><br>                dp[i] = min(dp[i], dp[i-coins[j]] + <span class="hljs-number">1</span>)<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> dp[amount] &gt; amount &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> dp[amount]<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="54-èºæ—‹çŸ©é˜µ"><a href="#54-èºæ—‹çŸ©é˜µ" class="headerlink" title="54. èºæ—‹çŸ©é˜µ"></a><a href="https://leetcode.cn/problems/spiral-matrix/">54. èºæ—‹çŸ©é˜µ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">spiralOrder</span><span class="hljs-params">(matrix [][]<span class="hljs-type">int</span>)</span></span> []<span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(matrix) == <span class="hljs-number">0</span> || <span class="hljs-built_in">len</span>(matrix[<span class="hljs-number">0</span>]) == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> []<span class="hljs-type">int</span>&#123;&#125;<br>    &#125;<br><br>    rows, cols := <span class="hljs-built_in">len</span>(matrix), <span class="hljs-built_in">len</span>(matrix[<span class="hljs-number">0</span>])<br>    order := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, rows * cols)<br>    index := <span class="hljs-number">0</span><br>    <span class="hljs-comment">// è®°å½•è¾¹ç•Œ</span><br>    left, right, top, bottom := <span class="hljs-number">0</span>, cols - <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, rows - <span class="hljs-number">1</span><br><br>    <span class="hljs-comment">// åœ¨è¾¹ç•ŒèŒƒå›´å†…ç§»åŠ¨</span><br>    <span class="hljs-keyword">for</span> left &lt;= right &amp;&amp; top &lt;= bottom &#123;<br>        <span class="hljs-comment">// ä»å·¦å¾€å³ç§»åŠ¨ï¼Œä»æœ€å·¦ç«¯leftå¼€å§‹ï¼Œä¸€ç›´åˆ°æœ€å³ç«¯right</span><br>        <span class="hljs-keyword">for</span> col := left; col &lt;= right; col++ &#123;<br>            order[index] = matrix[top][col]<br>            index++<br>        &#125;<br>        <span class="hljs-comment">// ä»ä¸Šå¾€ä¸‹ç§»åŠ¨ï¼Œä»æœ€ä¸Šé¢çš„ä¸‹ä¸€ä¸ªå…ƒç´ å¼€å§‹ï¼Œåˆ°æœ€ä¸‹ç«¯</span><br>        <span class="hljs-keyword">for</span> row := top + <span class="hljs-number">1</span>; row &lt;= bottom; row++ &#123;<br>            order[index] = matrix[row][right]<br>            index++<br>        &#125;<br>        <span class="hljs-comment">// å› ä¸ºéœ€è¦å§‹ç»ˆæ»¡è¶³col &gt; leftå’Œrow &gt; topï¼Œè¿™é‡Œè¦ä¿è¯æ•°ç»„è®¿é—®ä¸è¶Šç•Œ</span><br>        <span class="hljs-keyword">if</span> left &lt; right &amp;&amp; top &lt; bottom &#123;<br>            <span class="hljs-comment">// ä»å³å¾€å·¦ç§»åŠ¨</span><br>            <span class="hljs-keyword">for</span> col := right - <span class="hljs-number">1</span>; col &gt; left; col-- &#123;<br>                order[index] = matrix[bottom][col]<br>                index++<br>            &#125;<br>            <span class="hljs-comment">// ä»ä¸‹å¾€ä¸Šç§»åŠ¨</span><br>            <span class="hljs-keyword">for</span> row := bottom; row &gt; top; row-- &#123;<br>                order[index] = matrix[row][left]<br>                index++<br>            &#125;<br>        &#125;<br>        left++<br>        right--<br>        top++<br>        bottom--<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> order<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="300-æœ€é•¿é€’å¢å­åºåˆ—"><a href="#300-æœ€é•¿é€’å¢å­åºåˆ—" class="headerlink" title="300. æœ€é•¿é€’å¢å­åºåˆ—"></a><a href="https://leetcode.cn/problems/longest-increasing-subsequence/">300. æœ€é•¿é€’å¢å­åºåˆ—</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">lengthOfLIS</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    n := <span class="hljs-built_in">len</span>(nums)<br>    <span class="hljs-keyword">if</span> n == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br>    d := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, n + <span class="hljs-number">1</span>)<br>    <span class="hljs-built_in">len</span> := <span class="hljs-number">1</span><br>    d[<span class="hljs-built_in">len</span>] = nums[<span class="hljs-number">0</span>]<br><br>    <span class="hljs-keyword">for</span> _, num := <span class="hljs-keyword">range</span> nums &#123;<br>        <span class="hljs-keyword">if</span> num &gt; d[<span class="hljs-built_in">len</span>] &#123;<br>            <span class="hljs-built_in">len</span>++<br>            d[<span class="hljs-built_in">len</span>] = num<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            l := <span class="hljs-number">1</span><br>            r := <span class="hljs-built_in">len</span><br>            pos := <span class="hljs-number">0</span><br>            <span class="hljs-comment">// æ‰¾åˆ°æ¯”numå°çš„æœ€å¤§çš„æ•°</span><br>            <span class="hljs-keyword">for</span> l &lt;= r &#123;<br>                mid := (l + r) &gt;&gt; <span class="hljs-number">1</span><br>                <span class="hljs-keyword">if</span> d[mid] &lt; num &#123;<br>                    pos = mid<br>                    l = mid + <span class="hljs-number">1</span><br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    r = mid - <span class="hljs-number">1</span><br>                &#125;<br>            &#125;<br>            d[pos+<span class="hljs-number">1</span>] = num<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="23-åˆå¹¶-K-ä¸ªå‡åºé“¾è¡¨"><a href="#23-åˆå¹¶-K-ä¸ªå‡åºé“¾è¡¨" class="headerlink" title="23. åˆå¹¶ K ä¸ªå‡åºé“¾è¡¨"></a><a href="https://leetcode.cn/problems/merge-k-sorted-lists/">23. åˆå¹¶ K ä¸ªå‡åºé“¾è¡¨</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mergeKLists</span><span class="hljs-params">(lists []*ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">return</span> merge(lists, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(lists)<span class="hljs-number">-1</span>)<br>&#125;<br><span class="hljs-comment">// é€’å½’æ‰§è¡Œï¼Œå°†æ•°ç»„æ‹†æˆå·¦å³ä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«åˆå¹¶ä¸ºä¸€ä¸ªé“¾è¡¨ï¼Œæœ€ç»ˆå†å°†ä¸¤ä¸ªé“¾è¡¨åˆå¹¶</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">merge</span><span class="hljs-params">(lists []*ListNode, l, r <span class="hljs-type">int</span>)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">if</span> l == r &#123;<br>        <span class="hljs-keyword">return</span> lists[l]<br>    &#125;<br>    <span class="hljs-keyword">if</span> l &gt; r &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br>    mid := (l + r) / <span class="hljs-number">2</span><br>    <span class="hljs-keyword">return</span> mergeTwoLists(merge(lists, l, mid), merge(lists, mid+<span class="hljs-number">1</span>, r))<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mergeTwoLists</span><span class="hljs-params">(a, b *ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">if</span> a == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> b<br>    &#125;<br>    <span class="hljs-keyword">if</span> b == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> a<br>    &#125;<br><br>    dummy := &amp;ListNode&#123;&#125;<br>    tail := dummy<br>    pa := a<br>    pb := b<br>    <span class="hljs-keyword">for</span> pa != <span class="hljs-literal">nil</span> &amp;&amp; pb != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">if</span> pa.Val &lt; pb.Val &#123;<br>            tail.Next = pa<br>            pa = pa.Next<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            tail.Next = pb<br>            pb = pb.Next<br>        &#125;<br>        tail = tail.Next<br>    &#125;<br>    <span class="hljs-keyword">if</span> pa != <span class="hljs-literal">nil</span> &#123;<br>        tail.Next = pa<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        tail.Next = pb<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> dummy.Next<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="143-é‡æ’é“¾è¡¨"><a href="#143-é‡æ’é“¾è¡¨" class="headerlink" title="143. é‡æ’é“¾è¡¨"></a><a href="https://leetcode.cn/problems/reorder-list/">143. é‡æ’é“¾è¡¨</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reorderList</span><span class="hljs-params">(head *ListNode)</span></span>  &#123;<br>    <span class="hljs-keyword">if</span> head == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    mid := middleNode(head)<br>    l1 := head<br>    l2 := mid.Next<br>    mid.Next = <span class="hljs-literal">nil</span><br><br>    l2 = reverseList(l2)<br><br>    mergeList(l1, l2)<br>&#125;<br><br><span class="hljs-comment">// å¿«æ…¢æŒ‡é’ˆæ‰¾ä¸­ç‚¹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">middleNode</span><span class="hljs-params">(head *ListNode)</span></span> *ListNode &#123;<br>    slow, fast := head, head<br>    <span class="hljs-keyword">for</span> fast.Next != <span class="hljs-literal">nil</span> &amp;&amp; fast.Next.Next != <span class="hljs-literal">nil</span> &#123;<br>        slow = slow.Next<br>        fast = fast.Next.Next<br>    &#125;<br>    <span class="hljs-keyword">return</span> slow<br>&#125;<br><br><span class="hljs-comment">// åè½¬é“¾è¡¨</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reverseList</span><span class="hljs-params">(head *ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">var</span> pre, cur *ListNode = <span class="hljs-literal">nil</span>, head<br>    <span class="hljs-keyword">for</span> cur != <span class="hljs-literal">nil</span> &#123;<br>        next := cur.Next<br>        cur.Next = pre<br>        pre = cur<br>        cur = next<br>    &#125;<br>    <span class="hljs-keyword">return</span> pre<br>&#125;<br><br><span class="hljs-comment">// äº¤æ›¿åˆå¹¶é“¾è¡¨</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mergeList</span><span class="hljs-params">(l1, l2 *ListNode)</span></span> &#123;<br>    <span class="hljs-keyword">for</span> l1 != <span class="hljs-literal">nil</span> &amp;&amp; l2 != <span class="hljs-literal">nil</span> &#123;<br>        l1Next := l1.Next<br>        l2Next := l2.Next<br><br>        l1.Next = l2<br>        l1 = l1Next<br><br>        l2.Next = l1<br>        l2 = l2Next<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="415-å­—ç¬¦ä¸²ç›¸åŠ "><a href="#415-å­—ç¬¦ä¸²ç›¸åŠ " class="headerlink" title="415. å­—ç¬¦ä¸²ç›¸åŠ "></a><a href="https://leetcode.cn/problems/add-strings/">415. å­—ç¬¦ä¸²ç›¸åŠ </a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">addStrings</span><span class="hljs-params">(num1 <span class="hljs-type">string</span>, num2 <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>    add := <span class="hljs-number">0</span><br>    ans := <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> i, j := <span class="hljs-built_in">len</span>(num1) - <span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(num2) - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span> || j &gt;= <span class="hljs-number">0</span> || add != <span class="hljs-number">0</span>; i, j = i - <span class="hljs-number">1</span>, j - <span class="hljs-number">1</span> &#123;<br>        <span class="hljs-keyword">var</span> x, y <span class="hljs-type">int</span><br>        <span class="hljs-keyword">if</span> i &gt;= <span class="hljs-number">0</span> &#123;<br>            x = <span class="hljs-type">int</span>(num1[i] - <span class="hljs-string">&#x27;0&#x27;</span>)<br>        &#125;<br>        <span class="hljs-keyword">if</span> j &gt;= <span class="hljs-number">0</span> &#123;<br>            y = <span class="hljs-type">int</span>(num2[j] - <span class="hljs-string">&#x27;0&#x27;</span>)<br>        &#125;<br>        result := x + y + add<br>        <span class="hljs-comment">// result % 10 ä¸ºå½“å‰ä½</span><br>        ans = strconv.Itoa(result % <span class="hljs-number">10</span>) + ans<br>        <span class="hljs-comment">// å‘ä¸‹ä¸€ä½çš„è¿›ä½</span><br>        add = result / <span class="hljs-number">10</span><br>    &#125;<br><br>    <span class="hljs-keyword">return</span> ans<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="160-ç›¸äº¤é“¾è¡¨"><a href="#160-ç›¸äº¤é“¾è¡¨" class="headerlink" title="160. ç›¸äº¤é“¾è¡¨"></a><a href="https://leetcode.cn/problems/intersection-of-two-linked-lists/">160. ç›¸äº¤é“¾è¡¨</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-comment">// å“ˆå¸Œè¡¨å­˜å‚¨</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getIntersectionNode</span><span class="hljs-params">(headA, headB *ListNode)</span></span> *ListNode &#123;<br>    vis := <span class="hljs-keyword">map</span>[*ListNode]<span class="hljs-type">bool</span>&#123;&#125;<br>    <span class="hljs-keyword">for</span> p := headA; p != <span class="hljs-literal">nil</span>; p = p.Next &#123;<br>        vis[p] = <span class="hljs-literal">true</span><br>    &#125;<br>    <span class="hljs-keyword">for</span> p := headB; p != <span class="hljs-literal">nil</span>; p = p.Next &#123;<br>        <span class="hljs-keyword">if</span> vis[p] &#123;<br>            <span class="hljs-keyword">return</span> p<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// åŒæŒ‡é’ˆåˆ†åˆ«ä»ä¸¤ä¸ªé“¾è¡¨å¤´éƒ¨å¼€å§‹éå†ï¼Œéå†å®Œåè½¬åˆ°å¦ä¸€æ¡é“¾è¡¨å¤´éƒ¨éå†</span><br><span class="hljs-comment">// è‹¥å­˜åœ¨ç›¸äº¤èŠ‚ç‚¹ï¼Œåˆ™å¿…å®šç›¸é‡ï¼ˆå› ä¸ºä¼šèµ°è¿‡ç›¸åŒè·ç¦»x1+y+x2ï¼‰</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getIntersectionNode</span><span class="hljs-params">(headA, headB *ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">if</span> headA == <span class="hljs-literal">nil</span> || headB == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br>    pa, pb := headA, headB<br>    <span class="hljs-keyword">for</span> pa != pb &#123;<br>        <span class="hljs-keyword">if</span> pa == <span class="hljs-literal">nil</span> &#123;<br>            pa = headB<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            pa = pa.Next<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> pb == <span class="hljs-literal">nil</span> &#123;<br>            pb = headA<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            pb = pb.Next<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> pa<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="56-åˆå¹¶åŒºé—´"><a href="#56-åˆå¹¶åŒºé—´" class="headerlink" title="56. åˆå¹¶åŒºé—´"></a><a href="https://leetcode.cn/problems/merge-intervals/">56. åˆå¹¶åŒºé—´</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs GO"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">merge</span><span class="hljs-params">(intervals [][]<span class="hljs-type">int</span>)</span></span> [][]<span class="hljs-type">int</span> &#123;<br>    <span class="hljs-comment">// å…ˆæŒ‰ç…§å·¦ç«¯ç‚¹è¿›è¡Œæ’åº</span><br>    sort.Slice(intervals, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, j <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>        <span class="hljs-keyword">return</span> intervals[i][<span class="hljs-number">0</span>] &lt; intervals[j][<span class="hljs-number">0</span>]<br>    &#125;)<br><br>    <span class="hljs-comment">// ç”¨äºä¿å­˜ç»“æœ</span><br>    res := [][]<span class="hljs-type">int</span>&#123;&#125;<br><br>    <span class="hljs-comment">// éå†æ’åºåçš„åŒºé—´</span><br>    <span class="hljs-keyword">for</span> _, interval := <span class="hljs-keyword">range</span> intervals &#123;<br>        n := <span class="hljs-built_in">len</span>(res)<br>        <span class="hljs-comment">// æ²¡æœ‰é‡åˆï¼šresä¸­æœ€åä¸€ä¸ªåŒºé—´çš„å³ç«¯ç‚¹å°äºå½“å‰åŒºé—´å·¦ç«¯ç‚¹</span><br>        <span class="hljs-keyword">if</span> n == <span class="hljs-number">0</span> || res[n<span class="hljs-number">-1</span>][<span class="hljs-number">1</span>] &lt; interval[<span class="hljs-number">0</span>] &#123;<br>            res = <span class="hljs-built_in">append</span>(res, interval)<br>        <span class="hljs-comment">// æœ‰é‡åˆï¼Œå°±æ‹“å±•resä¸­æœ€åä¸€ä¸ªåŒºé—´çš„å³è¾¹ç•Œ</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            res[n<span class="hljs-number">-1</span>][<span class="hljs-number">1</span>] = max(res[n<span class="hljs-number">-1</span>][<span class="hljs-number">1</span>], interval[<span class="hljs-number">1</span>])<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="42-æ¥é›¨æ°´"><a href="#42-æ¥é›¨æ°´" class="headerlink" title="42. æ¥é›¨æ°´"></a><a href="https://leetcode.cn/problems/trapping-rain-water/">42. æ¥é›¨æ°´</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">trap</span><span class="hljs-params">(height []<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    n := <span class="hljs-built_in">len</span>(height)<br>    <span class="hljs-keyword">if</span> n == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br><br>    <span class="hljs-comment">// leftMax[i]çš„å«ä¹‰æ˜¯ï¼Œä»iè¿™ä¸ªä½ç½®å¾€å·¦çœ‹ï¼Œæœ€é«˜çš„é«˜åº¦</span><br>    leftMax := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, n)<br>    leftMax[<span class="hljs-number">0</span>] = height[<span class="hljs-number">0</span>]<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; n; i++ &#123;<br>        leftMax[i] = max(leftMax[i<span class="hljs-number">-1</span>], height[i])<br>    &#125;<br><br>    <span class="hljs-comment">// rightMax[i]çš„å«ä¹‰æ˜¯ï¼Œä»iè¿™ä¸ªä½ç½®å¾€å³çœ‹ï¼Œæœ€é«˜çš„é«˜åº¦</span><br>    rightMax := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, n)<br>    rightMax[n<span class="hljs-number">-1</span>] = height[n<span class="hljs-number">-1</span>]<br>    <span class="hljs-keyword">for</span> i := n - <span class="hljs-number">2</span>; i &gt;= <span class="hljs-number">0</span>; i-- &#123;<br>        rightMax[i] = max(rightMax[i+<span class="hljs-number">1</span>], height[i])<br>    &#125;<br><br>    res := <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">for</span> i, h := <span class="hljs-keyword">range</span> height &#123;<br>        res += min(leftMax[i], rightMax[i]) - h<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="124-äºŒå‰æ ‘ä¸­çš„æœ€å¤§è·¯å¾„å’Œ"><a href="#124-äºŒå‰æ ‘ä¸­çš„æœ€å¤§è·¯å¾„å’Œ" class="headerlink" title="124. äºŒå‰æ ‘ä¸­çš„æœ€å¤§è·¯å¾„å’Œ"></a><a href="https://leetcode.cn/problems/binary-tree-maximum-path-sum/">124. äºŒå‰æ ‘ä¸­çš„æœ€å¤§è·¯å¾„å’Œ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">maxPathSum</span><span class="hljs-params">(root *TreeNode)</span></span> <span class="hljs-type">int</span> &#123;<br>    maxSum := math.MinInt32<br>    <span class="hljs-keyword">var</span> maxGain <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(*TreeNode)</span></span> <span class="hljs-type">int</span><br>    maxGain = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(node *TreeNode)</span></span> <span class="hljs-type">int</span> &#123;<br>        <span class="hljs-keyword">if</span> node == <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>        &#125;<br><br>        leftGain := max(maxGain(node.Left), <span class="hljs-number">0</span>)<br>        rightGain := max(maxGain(node.Right), <span class="hljs-number">0</span>)<br><br>        <span class="hljs-comment">// å°†å·¦å­æ ‘è·¯å¾„-å½“å‰èŠ‚ç‚¹-å³å­æ ‘è·¯å¾„ è¿æ¥èµ·æ¥ç»„æˆæ–°çš„ä¸€æ¡è·¯å¾„</span><br>        <span class="hljs-comment">// è®¡ç®—è¿™æ¡è·¯å¾„çš„å’Œ</span><br>        newPathPrice := node.Val + leftGain + rightGain<br><br>        <span class="hljs-comment">// æ›´æ–°ç­”æ¡ˆ</span><br>        maxSum = max(maxSum, newPathPrice)<br><br>        <span class="hljs-comment">// è¿”å›èŠ‚ç‚¹çš„æœ€å¤§è´¡çŒ®å€¼ã€‚è·¯å¾„åªå‘ä¸€ä¸ªå­æ ‘ä¸Šå»¶ç”³</span><br>        <span class="hljs-keyword">return</span> node.Val + max(leftGain, rightGain)<br>    &#125;<br><br>    maxGain(root)<br><br>    <span class="hljs-keyword">return</span> maxSum<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="142-ç¯å½¢é“¾è¡¨-II"><a href="#142-ç¯å½¢é“¾è¡¨-II" class="headerlink" title="142. ç¯å½¢é“¾è¡¨ II"></a><a href="https://leetcode.cn/problems/linked-list-cycle-ii/">142. ç¯å½¢é“¾è¡¨ II</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">detectCycle</span><span class="hljs-params">(head *ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">if</span> head == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br><br>    seen := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[*ListNode]<span class="hljs-type">bool</span>)<br><br>    <span class="hljs-keyword">for</span> head != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">if</span> _, ok := seen[head]; ok &#123;<br>            <span class="hljs-keyword">return</span> head<br>        &#125;<br>        seen[head] = <span class="hljs-literal">true</span><br>        head = head.Next<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1143-æœ€é•¿å…¬å…±å­åºåˆ—"><a href="#1143-æœ€é•¿å…¬å…±å­åºåˆ—" class="headerlink" title="1143. æœ€é•¿å…¬å…±å­åºåˆ—"></a><a href="https://leetcode.cn/problems/longest-common-subsequence/">1143. æœ€é•¿å…¬å…±å­åºåˆ—</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">longestCommonSubsequence</span><span class="hljs-params">(text1 <span class="hljs-type">string</span>, text2 <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    m, n := <span class="hljs-built_in">len</span>(text1), <span class="hljs-built_in">len</span>(text2)<br>    <span class="hljs-comment">// dp[i][j]å«ä¹‰ï¼šä»¥text1[i-1]ç»“å°¾çš„å­—ç¬¦ä¸²ï¼Œå’Œä»¥text2[j-1]ç»“å°¾çš„å­—ç¬¦ä¸²ä¹‹é—´çš„æœ€é•¿å…¬å…±å­åºåˆ—é•¿åº¦</span><br>    dp := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">int</span>, m+<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> dp &#123;<br>        dp[i] = <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, n+<span class="hljs-number">1</span>)<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> i, c1 := <span class="hljs-keyword">range</span> text1 &#123;<br>        <span class="hljs-keyword">for</span> j, c2 := <span class="hljs-keyword">range</span> text2 &#123;<br>            <span class="hljs-keyword">if</span> c1 == c2 &#123;<br>                dp[i+<span class="hljs-number">1</span>][j+<span class="hljs-number">1</span>] = dp[i][j] + <span class="hljs-number">1</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                dp[i+<span class="hljs-number">1</span>][j+<span class="hljs-number">1</span>] = max(dp[i][j+<span class="hljs-number">1</span>], dp[i+<span class="hljs-number">1</span>][j])<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> dp[m][n]<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="93-å¤åŸ-IP-åœ°å€"><a href="#93-å¤åŸ-IP-åœ°å€" class="headerlink" title="93. å¤åŸ IP åœ°å€"></a><a href="https://leetcode.cn/problems/restore-ip-addresses/">93. å¤åŸ IP åœ°å€</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> SEG_COUNT = <span class="hljs-number">4</span><br><br><span class="hljs-keyword">var</span> (<br>    ans []<span class="hljs-type">string</span><br>    segments []<span class="hljs-type">int</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">restoreIpAddresses</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> []<span class="hljs-type">string</span> &#123;<br>    segments = <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, SEG_COUNT)<br>    ans = []<span class="hljs-type">string</span>&#123;&#125;<br>    dfs(s, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> ans<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">dfs</span><span class="hljs-params">(s <span class="hljs-type">string</span>, segId, segStart <span class="hljs-type">int</span>)</span></span> &#123;<br>    <span class="hljs-comment">// segIdä»0å¼€å§‹çš„ï¼Œç­‰äºSEG_COUNTè¯´æ˜å·²ç»æ‰¾åˆ°äº†4æ®µ</span><br>    <span class="hljs-comment">// segStartä»0å¼€å§‹çš„ï¼Œç­‰äºlen(s)è¯´æ˜å­—ç¬¦ä¸²å·²ç»éå†å®Œäº†</span><br>    <span class="hljs-keyword">if</span> segId == SEG_COUNT &#123;<br>        <span class="hljs-keyword">if</span> segStart == <span class="hljs-built_in">len</span>(s) &#123;<br>            <span class="hljs-comment">// å°†dfsè¿‡ç¨‹ä¸­ä¿å­˜çš„segmentsæ•°ç»„è½¬åŒ–æˆçœŸæ­£çš„ipå­—ç¬¦ä¸²</span><br>            ipAddr := <span class="hljs-string">&quot;&quot;</span><br>            <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; SEG_COUNT; i++ &#123;<br>                ipAddr += strconv.Itoa(segments[i])<br>                <span class="hljs-keyword">if</span> i != SEG_COUNT - <span class="hljs-number">1</span> &#123;<br>                    ipAddr += <span class="hljs-string">&quot;.&quot;</span><br>                &#125;<br>            &#125;<br>            <span class="hljs-comment">// å°†ipå­—ç¬¦ä¸²åŠ å…¥åˆ°ç»“æœé›†ä¸­</span><br>            ans = <span class="hljs-built_in">append</span>(ans, ipAddr)<br>        &#125;<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    <span class="hljs-comment">// å¦‚æœè¿˜æ²¡æœ‰æ‰¾åˆ°4æ®µï¼Œä½†å­—ç¬¦ä¸²å·²ç»éå†å®Œäº†ï¼Œè¯´æ˜æœ¬æ¬¡å°è¯•æ— åŠŸè€Œè¿”ï¼Œä»€ä¹ˆä¹Ÿä¸åšï¼Œç›´æ¥è¿”å›</span><br>    <span class="hljs-keyword">if</span> segStart == <span class="hljs-built_in">len</span>(s) &#123;<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    <span class="hljs-comment">// å¦‚æœå½“å‰æ®µï¼Œé‡åˆ°çš„ç¬¬ä¸€ä¸ªæ•°å­—å°±æ˜¯0ï¼Œé‚£ä¹ˆæœ¬æ®µä¹Ÿåªèƒ½ä¸º0ã€‚ä¿å­˜æœ¬æ®µçš„0ï¼Œç„¶åå¼€å¯å‘ä¸‹çš„æœç´¢</span><br>    <span class="hljs-keyword">if</span> s[segStart] == <span class="hljs-string">&#x27;0&#x27;</span> &#123;<br>        segments[segId] = <span class="hljs-number">0</span><br>        dfs(s, segId + <span class="hljs-number">1</span>, segStart + <span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    <span class="hljs-comment">// ä¸€èˆ¬æƒ…å†µï¼Œæšä¸¾æ¯ä¸€ç§å¯èƒ½æ€§ï¼Œå¹¶å‘ä¸‹é€’å½’</span><br>    addr := <span class="hljs-number">0</span> <span class="hljs-comment">// ç”¨æ¥ä¿å­˜æœ¬æ®µipåœ°å€æ•°å€¼</span><br>    <span class="hljs-comment">// ä»segStartå¼€å§‹å°è¯•ï¼Œiçš„æ€»ä½“é™åˆ¶æ˜¯å°äºlen(s)ï¼Œä½†åœ¨å‰æœŸéå†è¿‡ç¨‹ä¸­è¾¾ä¸åˆ°len(s) addrå°±è¶…è¿‡255äº†</span><br>    <span class="hljs-comment">// æ‰€ä»¥è¿™é‡Œçš„forå¾ªç¯å¹¶ä¸ä¸€å®šä¼šéå†åˆ°len(s)ï¼Œè¶…è¿‡255é€€å‡ºå³å¯ï¼Œæ‰€æœ‰å¯èƒ½çš„ç»“æœéƒ½ä¼šåœ¨dfsè¿‡ç¨‹ä¸­éå†åˆ°</span><br>    <span class="hljs-keyword">for</span> i := segStart; i &lt; <span class="hljs-built_in">len</span>(s); i++ &#123;<br>        addr = addr * <span class="hljs-number">10</span> + <span class="hljs-type">int</span>(s[i] - <span class="hljs-string">&#x27;0&#x27;</span>)<br>        <span class="hljs-comment">// å¦‚æœæœ¬è½®å¾ªç¯å¾—åˆ°çš„addræ•°å€¼ç¬¦åˆè¦æ±‚ï¼Œé‚£ä¹ˆå°±æ‰¾åˆ°äº†æœ¬æ®µçš„ä¸€ä¸ªè§£ï¼Œè®°å½•ä¹‹åå‘ä¸‹é€’å½’å¯»æ‰¾ä¹‹åå‡ æ®µçš„è§£</span><br>        <span class="hljs-keyword">if</span> addr &gt; <span class="hljs-number">0</span> &amp;&amp; addr &lt;= <span class="hljs-number">0xFF</span> &#123;<br>            segments[segId] = addr<br>            dfs(s, segId + <span class="hljs-number">1</span>, i + <span class="hljs-number">1</span>)<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">break</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="19-åˆ é™¤é“¾è¡¨çš„å€’æ•°ç¬¬-N-ä¸ªç»“ç‚¹"><a href="#19-åˆ é™¤é“¾è¡¨çš„å€’æ•°ç¬¬-N-ä¸ªç»“ç‚¹" class="headerlink" title="19. åˆ é™¤é“¾è¡¨çš„å€’æ•°ç¬¬ N ä¸ªç»“ç‚¹"></a><a href="https://leetcode.cn/problems/remove-nth-node-from-end-of-list/">19. åˆ é™¤é“¾è¡¨çš„å€’æ•°ç¬¬ N ä¸ªç»“ç‚¹</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// åŒæŒ‡é’ˆ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">removeNthFromEnd</span><span class="hljs-params">(head *ListNode, n <span class="hljs-type">int</span>)</span></span> *ListNode &#123;<br>    dummy := &amp;ListNode&#123;<span class="hljs-number">0</span>, head&#125;<br>    first, second := head, dummy<br>    <span class="hljs-comment">// firstå…ˆå¾€å‰èµ°næ­¥</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;<br>        first = first.Next<br>    &#125;<br>    <span class="hljs-comment">// firstå’ŒsecondåŒæ—¶å¾€å‰èµ°</span><br>    <span class="hljs-keyword">for</span> ; first != <span class="hljs-literal">nil</span>; first = first.Next &#123;<br>        second = second.Next<br>    &#125;<br>    second.Next = second.Next.Next<br>    <span class="hljs-keyword">return</span> dummy.Next<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="82-åˆ é™¤æ’åºé“¾è¡¨ä¸­çš„é‡å¤å…ƒç´ -II"><a href="#82-åˆ é™¤æ’åºé“¾è¡¨ä¸­çš„é‡å¤å…ƒç´ -II" class="headerlink" title="82. åˆ é™¤æ’åºé“¾è¡¨ä¸­çš„é‡å¤å…ƒç´  II"></a><a href="https://leetcode.cn/problems/remove-duplicates-from-sorted-list-ii/">82. åˆ é™¤æ’åºé“¾è¡¨ä¸­çš„é‡å¤å…ƒç´  II</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">deleteDuplicates</span><span class="hljs-params">(head *ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">if</span> head == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br>    dummy := &amp;ListNode&#123;<span class="hljs-number">0</span>, head&#125;<br><br>    cur := dummy<br>    <span class="hljs-comment">// æ¯æ¬¡éƒ½æ˜¯å¯¹æ¯”å½“å‰èŠ‚ç‚¹çš„åä¸¤ä¸ªèŠ‚ç‚¹</span><br>    <span class="hljs-keyword">for</span> cur.Next != <span class="hljs-literal">nil</span> &amp;&amp; cur.Next.Next != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-comment">// å¦‚æœåä¸¤ä¸ªèŠ‚ç‚¹ç›¸ç­‰</span><br>        <span class="hljs-keyword">if</span> cur.Next.Val == cur.Next.Next.Val &#123;<br>            <span class="hljs-comment">// è®°å½•ç›¸ç­‰èŠ‚ç‚¹çš„å€¼</span><br>            x := cur.Next.Val<br>            <span class="hljs-comment">// ä¸åœçš„è·³è¿‡å€¼ä¸ºxçš„èŠ‚ç‚¹ï¼Œæ³¨æ„è¿™é‡Œcuræ˜¯ä¸€ç›´æ²¡å˜çš„ï¼Œå˜åŒ–çš„æ˜¯curçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œ</span><br>            <span class="hljs-comment">// ä¹Ÿå°±æ˜¯è¯´å¦‚æœcurçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å€¼ä¸ºxï¼Œé‚£ä¹ˆå®ƒå°±ä¼šè¢«è·³è¿‡</span><br>            <span class="hljs-keyword">for</span> cur.Next != <span class="hljs-literal">nil</span> &amp;&amp; cur.Next.Val == x &#123;<br>                cur.Next = cur.Next.Next<br>            &#125;<br>        <span class="hljs-comment">// åä¸¤ä¸ªèŠ‚ç‚¹ä¸ç›¸ç­‰çš„æƒ…å†µä¸‹ï¼Œcuræ‰å¾€åç§»åŠ¨ä¸€ä½</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            cur = cur.Next<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> dummy.Next<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="199-äºŒå‰æ ‘çš„å³è§†å›¾"><a href="#199-äºŒå‰æ ‘çš„å³è§†å›¾" class="headerlink" title="199. äºŒå‰æ ‘çš„å³è§†å›¾"></a><a href="https://leetcode.cn/problems/binary-tree-right-side-view/">199. äºŒå‰æ ‘çš„å³è§†å›¾</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br> <span class="hljs-comment">// å±‚åºéå†ï¼Œå³å­æ ‘å…ˆå…¥é˜Ÿï¼Œæ¯å±‚ä¿ç•™æœ€å³ä¾§èŠ‚ç‚¹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">rightSideView</span><span class="hljs-params">(root *TreeNode)</span></span> []<span class="hljs-type">int</span> &#123;<br>    res := []<span class="hljs-type">int</span>&#123;&#125;<br><br>    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> res<br>    &#125;<br><br>    q := []*TreeNode&#123;root&#125;<br>    <span class="hljs-keyword">for</span> <span class="hljs-built_in">len</span>(q) &gt; <span class="hljs-number">0</span> &#123;<br>        p := []*TreeNode&#123;&#125;<br>        res = <span class="hljs-built_in">append</span>(res, q[<span class="hljs-number">0</span>].Val)<br>        <span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; <span class="hljs-built_in">len</span>(q); j++ &#123;<br>            node := q[j]<br>            <span class="hljs-keyword">if</span> node.Right != <span class="hljs-literal">nil</span> &#123;<br>                p = <span class="hljs-built_in">append</span>(p, node.Right)<br>            &#125;<br>            <span class="hljs-keyword">if</span> node.Left != <span class="hljs-literal">nil</span> &#123;<br>                p = <span class="hljs-built_in">append</span>(p, node.Left)<br>            &#125;<br>        &#125;<br>        q = p<br>    &#125;<br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="94-äºŒå‰æ ‘çš„ä¸­åºéå†"><a href="#94-äºŒå‰æ ‘çš„ä¸­åºéå†" class="headerlink" title="94. äºŒå‰æ ‘çš„ä¸­åºéå†"></a><a href="https://leetcode.cn/problems/binary-tree-inorder-traversal/">94. äºŒå‰æ ‘çš„ä¸­åºéå†</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">inorderTraversal</span><span class="hljs-params">(root *TreeNode)</span></span> []<span class="hljs-type">int</span> &#123;<br>    res := []<span class="hljs-type">int</span>&#123;&#125;<br><br>    <span class="hljs-keyword">var</span> inorder <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(node *TreeNode)</span></span><br>    inorder = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(node * TreeNode)</span></span> &#123;<br>        <span class="hljs-keyword">if</span> node == <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        inorder(node.Left)<br>        res = <span class="hljs-built_in">append</span>(res, node.Val)<br>        inorder(node.Right)<br>    &#125;<br><br>    inorder(root)<br><br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ç®—æ³•é¢˜ç†è®º</title>
    <link href="/2025/04/20/%E7%AE%97%E6%B3%95%E9%A2%98%E7%90%86%E8%AE%BA/"/>
    <url>/2025/04/20/%E7%AE%97%E6%B3%95%E9%A2%98%E7%90%86%E8%AE%BA/</url>
    
    <content type="html"><![CDATA[<h1 id="ç®—æ³•é¢˜ç†è®º"><a href="#ç®—æ³•é¢˜ç†è®º" class="headerlink" title="ç®—æ³•é¢˜ç†è®º"></a>ç®—æ³•é¢˜ç†è®º</h1><h2 id="æ»¡äºŒå‰æ ‘ï¼š"><a href="#æ»¡äºŒå‰æ ‘ï¼š" class="headerlink" title="æ»¡äºŒå‰æ ‘ï¼š"></a>æ»¡äºŒå‰æ ‘ï¼š</h2><p>å®šä¹‰ï¼šé™¤æœ€åä¸€å±‚æ— ä»»ä½•å­èŠ‚ç‚¹å¤–ï¼Œæ¯ä¸€å±‚ä¸Šçš„æ‰€æœ‰ç»“ç‚¹éƒ½æœ‰ä¸¤ä¸ªå­ç»“ç‚¹äºŒå‰æ ‘ã€‚</p><p>æ€§è´¨ï¼šï¼ˆæ ¹èŠ‚ç‚¹ä¸ºç¬¬1å±‚ï¼Œé«˜åº¦ä¸ºk, ä»1å¼€å§‹ç¼–å·ï¼‰</p><ol><li>æ€»èŠ‚ç‚¹æ•°ï¼š2^(k+1) -1, k&gt;&#x3D;0</li><li>ç¼–å·ä¸ºiçš„èŠ‚ç‚¹ï¼Œi&gt;&#x3D;0ï¼Œå·¦å­èŠ‚ç‚¹ç¼–å·ä¸ºï¼š2i+1ï¼Œå³å­èŠ‚ç‚¹ç¼–å·ä¸ºï¼š2i+2ï¼Œçˆ¶èŠ‚ç‚¹ï¼š(i-1) &#x2F; 2</li></ol><h2 id="å®Œå…¨äºŒå‰æ ‘ï¼š"><a href="#å®Œå…¨äºŒå‰æ ‘ï¼š" class="headerlink" title="å®Œå…¨äºŒå‰æ ‘ï¼š"></a>å®Œå…¨äºŒå‰æ ‘ï¼š</h2><p>å®šä¹‰ï¼šä»¥æ»¡äºŒå‰æ ‘ä¸ºåŸºç¡€ï¼Œæœ€åä¸€å±‚å³ä¾§ç¼ºå¤±éƒ¨åˆ†èŠ‚ç‚¹çš„äºŒå‰æ ‘ã€‚</p><p>è‹¥ä¸€ä¸ªæ•°ç»„ä»£è¡¨å®Œå…¨äºŒå‰æ ‘å±‚åºéå†åçš„ç»“æœï¼Œåˆ™ç¬¬ä¸€ä¸ªéå¶å­èŠ‚ç‚¹çš„ç¼–å·ä¸ºï¼šarr.length&#x2F;2-1</p><p><img src="/2025/04/20/%E7%AE%97%E6%B3%95%E9%A2%98%E7%90%86%E8%AE%BA/image-20250419181304984.png" alt="image-20250419181304984"></p><h2 id="å †æ’åº"><a href="#å †æ’åº" class="headerlink" title="å †æ’åº"></a>å †æ’åº</h2><p>bç«™è§†é¢‘ï¼š<a href="https://www.bilibili.com/video/BV1Eb41147dK?spm_id_from=333.788.recommend_more_video.1&vd_source=387dd3d1bd16faa43e7a57664d7939b8">https://www.bilibili.com/video/BV1Eb41147dK?spm_id_from=333.788.recommend_more_video.1&amp;vd_source=387dd3d1bd16faa43e7a57664d7939b8</a></p><p>ä»æœ€åä¸€ä¸ªéå¶å­èŠ‚ç‚¹å¼€å§‹å»ºå †ï¼Œä¸€ç›´è¿›è¡Œåˆ°æ ¹èŠ‚ç‚¹ï¼Œæœ€åæ ¹èŠ‚ç‚¹çš„æ•°å€¼ä¸ºæ•´ä½“æœ€å¤§å€¼</p><p>äº¤æ¢æœ€å¤§å€¼ä¸æœ«å°¾èŠ‚ç‚¹å€¼ï¼Œå»é™¤æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œé‡æ–°è°ƒæ•´å †</p><p>å¾ªç¯ä¸Šä¸€æ­¥ï¼Œç›´åˆ°å †åªå‰©ä¸€ä¸ªå…ƒç´ </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span>(<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">swap</span><span class="hljs-params">(arr []<span class="hljs-type">int</span>, i, j <span class="hljs-type">int</span>)</span></span> &#123;<br>    tmp := arr[i]<br>    arr[i] = arr[j]<br>    arr[j] = tmp<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">heapify</span><span class="hljs-params">(tree []<span class="hljs-type">int</span>, n <span class="hljs-type">int</span>, i <span class="hljs-type">int</span>)</span></span> &#123;<br>    <span class="hljs-keyword">if</span> i &gt;= n &#123;<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    c1 := <span class="hljs-number">2</span> * i + <span class="hljs-number">1</span><br>    c2 := <span class="hljs-number">2</span> * i + <span class="hljs-number">2</span><br>    max := i<br>    <span class="hljs-keyword">if</span> c1 &lt; n &amp;&amp; tree[c1] &gt; tree[max] &#123;<br>        max = c1<br>    &#125;<br>    <span class="hljs-keyword">if</span> c2 &lt; n &amp;&amp; tree[c2] &gt; tree[max] &#123;<br>        max = c2<br>    &#125;<br>    <span class="hljs-keyword">if</span> max != i &#123;<br>        swap(tree, max, i)<br>        heapify(tree, n, max)<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">buildHeap</span><span class="hljs-params">(tree []<span class="hljs-type">int</span>, n <span class="hljs-type">int</span>)</span></span> &#123;<br>    lastNode := n <span class="hljs-number">-1</span><br>    parent := (lastNode - <span class="hljs-number">1</span>) / <span class="hljs-number">2</span><br>    <span class="hljs-keyword">for</span> i := parent; i &gt;= <span class="hljs-number">0</span>; i-- &#123;<br>        heapify(tree, n, i)<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">heapSort</span><span class="hljs-params">(tree []<span class="hljs-type">int</span>, n <span class="hljs-type">int</span>)</span></span> &#123;<br>    buildHeap(tree, n)<br>    <span class="hljs-keyword">for</span> i := n<span class="hljs-number">-1</span>; i &gt;= <span class="hljs-number">0</span>; i-- &#123;<br>        swap(tree, i, <span class="hljs-number">0</span>)<br>        heapify(tree, i, <span class="hljs-number">0</span>)<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    tree := []<span class="hljs-type">int</span>&#123;<span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">10</span>, <span class="hljs-number">4</span>&#125;<br>    n := <span class="hljs-number">6</span><br>    heapSort(tree, n)<br>    <br>    <span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> tree &#123;<br>        fmt.Printf(<span class="hljs-string">&quot;%d\n&quot;</span>, v)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="è®¡æ•°æ’åº"><a href="#è®¡æ•°æ’åº" class="headerlink" title="è®¡æ•°æ’åº"></a>è®¡æ•°æ’åº</h2><p>å‡è®¾æ‰€æœ‰å…ƒç´ å‡ä¸ºæ­£æ•°ï¼Œè‹¥æœ‰è´Ÿæ•°ï¼Œåˆ™é€šè¿‡æ¯ä¸ªå…ƒç´ éƒ½åŠ ä¸Šä¸€ä¸ªå›ºå®šå€¼ï¼ŒæŠŠæ‰€æœ‰å…ƒç´ éƒ½å˜æˆæ­£æ•°</p><ol><li>å…ˆéå†ä¸€éæ•°ç»„ï¼Œæ‰¾å‡ºæ•°ç»„ä¸­æœ€å¤§å€¼m</li><li>è®¾ç½®mä¸ªæ¡¶</li><li>éå†æ•°ç»„ï¼Œå°†å…ƒç´ æ”¾åˆ°å¯¹åº”çš„æ¡¶ä¸Šï¼Œæ¡¶çš„ä¸‹æ ‡å³ä¸ºå…ƒç´ å€¼æœ¬èº«</li><li>éå†æ¡¶ï¼Œå–å‡ºæ¡¶ä¸­å…ƒç´ å¹¶æŒ‰æ¬¡åºæ’åˆ—å¥½</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">countingSort</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(nums) &lt;= <span class="hljs-number">1</span> &#123;<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-comment">// æ‰¾åˆ°æœ€å¤§å€¼</span><br>    max := nums[<span class="hljs-number">0</span>]<br>    <span class="hljs-keyword">for</span> _, num := <span class="hljs-keyword">range</span> nums &#123;<br>        <span class="hljs-keyword">if</span> num &gt; max &#123;<br>            max = num<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">// è®¾ç½®è®¡æ•°æ¡¶</span><br>    buckets := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, max+<span class="hljs-number">1</span>)<br>    <br>    <span class="hljs-comment">// å°†å…ƒç´ æ”¾å…¥æ¡¶ä¸­</span><br>    <span class="hljs-keyword">for</span> _, num := <span class="hljs-keyword">range</span> nums &#123;<br>        buckets[num] += <span class="hljs-number">1</span><br>    &#125;<br>    <br>    <span class="hljs-comment">// éå†è®¡æ•°æ¡¶ï¼Œå–å‡ºå…ƒç´ æ’åº</span><br>    index := <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> elem, elemCount := <span class="hljs-keyword">range</span> buckets &#123;<br>        <span class="hljs-keyword">for</span> elemCount &gt; <span class="hljs-number">0</span> &#123;<br>            nums[index] = elem<br>            elemCount--<br>            index++<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    nums := []<span class="hljs-type">int</span>&#123;<span class="hljs-number">2</span>,<span class="hljs-number">5</span>,<span class="hljs-number">10</span>,<span class="hljs-number">3</span>,<span class="hljs-number">6</span>,<span class="hljs-number">4</span>&#125;<br>    countingSort(nums)<br>    fmt.Println(nums)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ¡¶æ’åº"><a href="#æ¡¶æ’åº" class="headerlink" title="æ¡¶æ’åº"></a>æ¡¶æ’åº</h2><p>æ¡¶æ’åºæ˜¯è®¡æ•°æ’åºçš„å˜ç§</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;sort&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">bucketSort</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(nums) &lt;= <span class="hljs-number">1</span> &#123;<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <br>    <span class="hljs-comment">// æ‰¾åˆ°æœ€å¤§å€¼å’Œæœ€å°å€¼</span><br>    max := nums[<span class="hljs-number">0</span>]<br>    min := nums[<span class="hljs-number">0</span>]<br>    <span class="hljs-keyword">for</span> _, num := <span class="hljs-keyword">range</span> nums &#123;<br>        <span class="hljs-keyword">if</span> num &gt; max &#123;<br>            max = num<br>        &#125;<br>        <span class="hljs-keyword">if</span> num &lt; min &#123;<br>            min = num<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">// è®¾ç½®æ¡¶</span><br>    defaultBucketSize := <span class="hljs-number">2</span><br>    bucketCount := (max - min) / defaultBucketSize + <span class="hljs-number">1</span><br>    buckets := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">int</span>, bucketCount)<br>    <br>    <span class="hljs-comment">// éå†æ•°ç»„ï¼Œå°†å…ƒç´ æ”¾å…¥æ¡¶ä¸­</span><br>    <span class="hljs-keyword">for</span> _, num := <span class="hljs-keyword">range</span> nums &#123;<br>        i := (num - min) / defaultBucketSize<br>        buckets[i] = <span class="hljs-built_in">append</span>(buckets[i], num)<br>    &#125;<br>    <br>    <span class="hljs-comment">// éå†æ¡¶ï¼Œå–å‡ºå…ƒç´ æ’åº</span><br>    index := <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> _, bucket := <span class="hljs-keyword">range</span> buckets &#123;<br>        <span class="hljs-comment">// æ¡¶å†…éƒ¨æ’åº</span><br>        sort.Slice(bucket, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, j <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>            <span class="hljs-keyword">return</span> bucket[i] &lt; bucket[j]<br>        &#125;)<br>        <span class="hljs-keyword">for</span> _, num := <span class="hljs-keyword">range</span> bucket &#123;<br>            nums[index] = num<br>            index++<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    nums := []<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">100</span>, <span class="hljs-number">49</span>, <span class="hljs-number">50</span>, <span class="hljs-number">98</span>, <span class="hljs-number">34</span>, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>&#125;<br>    bucketSort(nums)<br>    fmt.Println(nums)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="åŸºæ•°æ’åº"><a href="#åŸºæ•°æ’åº" class="headerlink" title="åŸºæ•°æ’åº"></a>åŸºæ•°æ’åº</h2><h2 id="å¿«é€Ÿæ’åº"><a href="#å¿«é€Ÿæ’åº" class="headerlink" title="å¿«é€Ÿæ’åº"></a>å¿«é€Ÿæ’åº</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">quickSort</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>, l, r <span class="hljs-type">int</span>)</span></span> &#123;<br><span class="hljs-keyword">if</span> l &lt; r &#123;<br>    index := partition(nums, l, r)<br>    fmt.Println(index)<br>    quickSort(nums, l, index<span class="hljs-number">-1</span>)<br>    quickSort(nums, index+<span class="hljs-number">1</span>, r)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">partition</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>, l, r <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>pivot := nums[l]<br><span class="hljs-keyword">for</span> l &lt; r &#123;<br><span class="hljs-keyword">for</span> l &lt; r &amp;&amp; nums[r] &gt; pivot &#123;<br>r--<br>&#125;<br>nums[l] = nums[r]<br><span class="hljs-keyword">for</span> l &lt; r &amp;&amp; nums[l] &lt;= pivot &#123;<br>l++<br>&#125;<br>nums[r] = nums[l]<br>&#125;<br>nums[l] = pivot<br><span class="hljs-keyword">return</span> l<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>nums := []<span class="hljs-type">int</span>&#123;<span class="hljs-number">2</span>, <span class="hljs-number">10</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">2</span>&#125;<br>quickSort(nums, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(nums)<span class="hljs-number">-1</span>)<br>fmt.Println(nums)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="é“¾è¡¨å®ç°é˜Ÿåˆ—"><a href="#é“¾è¡¨å®ç°é˜Ÿåˆ—" class="headerlink" title="é“¾è¡¨å®ç°é˜Ÿåˆ—"></a>é“¾è¡¨å®ç°é˜Ÿåˆ—</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Node <span class="hljs-keyword">struct</span> &#123;<br>    value <span class="hljs-type">int</span><br>    next  *Node<br>&#125;<br><br><span class="hljs-keyword">type</span> Queue <span class="hljs-keyword">struct</span> &#123;<br>    head *Node<br>    tail *Node<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewQueue</span><span class="hljs-params">()</span></span> *Queue &#123;<br>    <span class="hljs-keyword">return</span> &amp;Queue&#123;<br>        head: <span class="hljs-literal">nil</span>,<br>        tail: <span class="hljs-literal">nil</span>,<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *Queue)</span></span> Enqueue(val <span class="hljs-type">int</span>) &#123;<br>    newNode := &amp;Node&#123;value: val&#125;<br>    <span class="hljs-keyword">if</span> q.tail == <span class="hljs-literal">nil</span> &#123;<br>        q.head = newNode<br>        q.tail = newNode<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        q.tail.next = newNode<br>        q.tail = newNode<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *Queue)</span></span> Dequeue() <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> q.head == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;queue is empty&quot;</span>)<br>    &#125;<br>    val := q.head.value<br>    q.head = q.head.next<br>    <span class="hljs-keyword">if</span> q.head == <span class="hljs-literal">nil</span> &#123;<br>        q.tail = <span class="hljs-literal">nil</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> val<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *Queue)</span></span> IsEmpty() <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">return</span> q.head == <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ·±åº¦ä¼˜å…ˆæœç´¢DFS"><a href="#æ·±åº¦ä¼˜å…ˆæœç´¢DFS" class="headerlink" title="æ·±åº¦ä¼˜å…ˆæœç´¢DFS"></a>æ·±åº¦ä¼˜å…ˆæœç´¢DFS</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DFS</span><span class="hljs-params">(root *TreeNode)</span></span> &#123;<br>    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    fmt.Println(root.Val)<br>    <br>    DFS(root.Left)<br>    DFS(root.Right)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å¹¿åº¦ä¼˜å…ˆæœç´¢BFS"><a href="#å¹¿åº¦ä¼˜å…ˆæœç´¢BFS" class="headerlink" title="å¹¿åº¦ä¼˜å…ˆæœç´¢BFS"></a>å¹¿åº¦ä¼˜å…ˆæœç´¢BFS</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BFS</span><span class="hljs-params">(root *TreeNode)</span></span> &#123;<br>    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <br>    q := []*TreeNode<br>    <span class="hljs-keyword">for</span> <span class="hljs-built_in">len</span>(q) &gt; <span class="hljs-number">0</span> &#123;<br>        node := q[<span class="hljs-number">0</span>]<br>        q = q[<span class="hljs-number">1</span>:]<br>        <br>        fmt.Println(node.Val)<br>        <br>        <span class="hljs-keyword">if</span> node.Left != <span class="hljs-literal">nil</span> &#123;<br>            q = <span class="hljs-built_in">append</span>(q, node.Left)<br>        &#125;<br>        <span class="hljs-keyword">if</span> node.Right != <span class="hljs-literal">nil</span> &#123;<br>            q = <span class="hljs-built_in">append</span>(q, node.Right)<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Goç®—æ³•é¢˜</title>
    <link href="/2025/04/20/Go%E7%AE%97%E6%B3%95%E9%A2%98/"/>
    <url>/2025/04/20/Go%E7%AE%97%E6%B3%95%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h1 id="Goç®—æ³•é¢˜-ä¸€"><a href="#Goç®—æ³•é¢˜-ä¸€" class="headerlink" title="Goç®—æ³•é¢˜-ä¸€"></a>Goç®—æ³•é¢˜-ä¸€</h1><p>æŒ‰å‡ºç°é¢‘ç‡å¤§å°é€’å‡æ’åºï¼ˆå‚è€ƒ<a href="https://codetop.cc/home%EF%BC%89%EF%BC%9A">https://codetop.cc/homeï¼‰ï¼š</a></p><h2 id="3-æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²"><a href="#3-æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²" class="headerlink" title="3. æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²"></a><a href="https://leetcode.cn/problems/longest-substring-without-repeating-characters/">3. æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²</a></h2><p>(1) leetcode 3. ç»™å®šä¸€ä¸ªå­—ç¬¦ä¸² <code>s</code> ï¼Œè¯·ä½ æ‰¾å‡ºå…¶ä¸­ä¸å«æœ‰é‡å¤å­—ç¬¦çš„ <strong>æœ€é•¿ å­ä¸²</strong> çš„é•¿åº¦ã€‚</p><p><strong>ç¤ºä¾‹ 1:</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">è¾“å…¥: s = &quot;abcabcbb&quot;</span><br><span class="hljs-section">è¾“å‡º: 3 </span><br><span class="hljs-section">è§£é‡Š: å› ä¸ºæ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²æ˜¯ &quot;abc&quot;ï¼Œæ‰€ä»¥å…¶é•¿åº¦ä¸º 3ã€‚</span><br></code></pre></td></tr></table></figure><p><strong>ç¤ºä¾‹ 2:</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">è¾“å…¥: s = &quot;bbbbb&quot;</span><br><span class="hljs-section">è¾“å‡º: 1</span><br><span class="hljs-section">è§£é‡Š: å› ä¸ºæ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²æ˜¯ &quot;b&quot;ï¼Œæ‰€ä»¥å…¶é•¿åº¦ä¸º 1ã€‚</span><br></code></pre></td></tr></table></figure><p><strong>ç¤ºä¾‹ 3:</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">è¾“å…¥: s = &quot;pwwkew&quot;</span><br><span class="hljs-section">è¾“å‡º: 3</span><br><span class="hljs-section">è§£é‡Š: å› ä¸ºæ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²æ˜¯ &quot;wke&quot;ï¼Œæ‰€ä»¥å…¶é•¿åº¦ä¸º 3ã€‚</span><br>     è¯·æ³¨æ„ï¼Œä½ çš„ç­”æ¡ˆå¿…é¡»æ˜¯ å­ä¸² çš„é•¿åº¦ï¼Œ<span class="hljs-string">&quot;pwke&quot;</span> æ˜¯ä¸€ä¸ªå­åºåˆ—ï¼Œä¸æ˜¯å­ä¸²ã€‚<br></code></pre></td></tr></table></figure><p><strong>æç¤ºï¼š</strong></p><ul><li><code>0 &lt;= s.length &lt;= 5 * 104</code></li><li><code>s</code> ç”±è‹±æ–‡å­—æ¯ã€æ•°å­—ã€ç¬¦å·å’Œç©ºæ ¼ç»„æˆ</li></ul><p><strong>è§£ç­”ï¼š</strong></p><p> æ–¹æ³•ç‚¹ï¼š</p><ol><li>ä½¿ç”¨mapè®°å½•å­—ç¬¦ï¼Œç”¨æ¥åˆ¤æ–­æ˜¯å¦é‡å¤</li><li>å¦‚æœå½“å‰å­—ç¬¦ä¸å‰é¢æŸå­—ç¬¦é‡å¤ï¼Œå¯ä»¥ç›´æ¥è·³åˆ°é‡å¤å­—ç¬¦åé¢ï¼Œç»§ç»­æ¯”è¾ƒ</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// //å¤–å±‚å¾ªç¯æ‰©å±•å³è¾¹ç•Œï¼Œå†…å±‚å¾ªç¯æ‰©å±•å·¦è¾¹ç•Œ</span><br><span class="hljs-comment">// for (int l = 0, r = 0 ; r &lt; n ; r++) &#123;</span><br><span class="hljs-comment">// //å½“å‰è€ƒè™‘çš„å…ƒç´ </span><br><span class="hljs-comment">// while (l &lt;= r &amp;&amp; check()) &#123;//åŒºé—´[left,right]ä¸ç¬¦åˆé¢˜æ„</span><br><span class="hljs-comment">//         //æ‰©å±•å·¦è¾¹ç•Œ</span><br><span class="hljs-comment">//     &#125;</span><br><span class="hljs-comment">//     //åŒºé—´[left,right]ç¬¦åˆé¢˜æ„ï¼Œç»Ÿè®¡ç›¸å…³ä¿¡æ¯</span><br><span class="hljs-comment">// &#125;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">lengthOfLongestSubstring</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    m := <span class="hljs-keyword">map</span>[<span class="hljs-type">byte</span>]<span class="hljs-type">int</span>&#123;&#125;<br>    n := <span class="hljs-built_in">len</span>(s)<br>    l := <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> r:=<span class="hljs-number">0</span>, r&lt;n; r++ &#123;<br>        <span class="hljs-comment">// å¦‚æœé‡å¤ï¼Œä¸€ç›´è·³åˆ°é‡å¤å…ƒç´ çš„ä¸‹ä¸€ä½</span><br>        <span class="hljs-keyword">for</span> m[s[r]] != <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-built_in">delete</span>(m, s[l])<br>            l++<br>        &#125;<br>        m[s[r]] = <span class="hljs-number">1</span><br>        res = max(res, r-l+<span class="hljs-number">1</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰</p><h2 id="146-LRU-ç¼“å­˜"><a href="#146-LRU-ç¼“å­˜" class="headerlink" title="146. LRU ç¼“å­˜"></a><a href="https://leetcode.cn/problems/lru-cache/">146. LRU ç¼“å­˜</a></h2><p>leetcode 146. è¯·ä½ è®¾è®¡å¹¶å®ç°ä¸€ä¸ªæ»¡è¶³ <a href="https://baike.baidu.com/item/LRU">LRU (æœ€è¿‘æœ€å°‘ä½¿ç”¨) ç¼“å­˜</a> çº¦æŸçš„æ•°æ®ç»“æ„ã€‚</p><p>å®ç° <code>LRUCache</code> ç±»ï¼š</p><ul><li><code>LRUCache(int capacity)</code> ä»¥ <strong>æ­£æ•´æ•°</strong> ä½œä¸ºå®¹é‡ <code>capacity</code> åˆå§‹åŒ– LRU ç¼“å­˜</li><li><code>int get(int key)</code> å¦‚æœå…³é”®å­— <code>key</code> å­˜åœ¨äºç¼“å­˜ä¸­ï¼Œåˆ™è¿”å›å…³é”®å­—çš„å€¼ï¼Œå¦åˆ™è¿”å› <code>-1</code> ã€‚</li><li><code>void put(int key, int value)</code> å¦‚æœå…³é”®å­— <code>key</code> å·²ç»å­˜åœ¨ï¼Œåˆ™å˜æ›´å…¶æ•°æ®å€¼ <code>value</code> ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™å‘ç¼“å­˜ä¸­æ’å…¥è¯¥ç»„ <code>key-value</code> ã€‚å¦‚æœæ’å…¥æ“ä½œå¯¼è‡´å…³é”®å­—æ•°é‡è¶…è¿‡ <code>capacity</code> ï¼Œåˆ™åº”è¯¥ <strong>é€å‡º</strong> æœ€ä¹…æœªä½¿ç”¨çš„å…³é”®å­—ã€‚</li></ul><p>å‡½æ•° <code>get</code> å’Œ <code>put</code> å¿…é¡»ä»¥ <code>O(1)</code> çš„å¹³å‡æ—¶é—´å¤æ‚åº¦è¿è¡Œã€‚</p><p><strong>ç¤ºä¾‹ï¼š</strong></p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs dart">è¾“å…¥<br>[<span class="hljs-string">&quot;LRUCache&quot;</span>, <span class="hljs-string">&quot;put&quot;</span>, <span class="hljs-string">&quot;put&quot;</span>, <span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;put&quot;</span>, <span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;put&quot;</span>, <span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;get&quot;</span>]<br>[[<span class="hljs-number">2</span>], [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>], [<span class="hljs-number">2</span>, <span class="hljs-number">2</span>], [<span class="hljs-number">1</span>], [<span class="hljs-number">3</span>, <span class="hljs-number">3</span>], [<span class="hljs-number">2</span>], [<span class="hljs-number">4</span>, <span class="hljs-number">4</span>], [<span class="hljs-number">1</span>], [<span class="hljs-number">3</span>], [<span class="hljs-number">4</span>]]<br>è¾“å‡º<br>[<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">1</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">-1</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]<br><br>è§£é‡Š<br>LRUCache lRUCache = <span class="hljs-keyword">new</span> LRUCache(<span class="hljs-number">2</span>);<br>lRUCache.put(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">// ç¼“å­˜æ˜¯ &#123;1=1&#125;</span><br>lRUCache.put(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>); <span class="hljs-comment">// ç¼“å­˜æ˜¯ &#123;1=1, 2=2&#125;</span><br>lRUCache.<span class="hljs-keyword">get</span>(<span class="hljs-number">1</span>);    <span class="hljs-comment">// è¿”å› 1</span><br>lRUCache.put(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>); <span class="hljs-comment">// è¯¥æ“ä½œä¼šä½¿å¾—å…³é”®å­— 2 ä½œåºŸï¼Œç¼“å­˜æ˜¯ &#123;1=1, 3=3&#125;</span><br>lRUCache.<span class="hljs-keyword">get</span>(<span class="hljs-number">2</span>);    <span class="hljs-comment">// è¿”å› -1 (æœªæ‰¾åˆ°)</span><br>lRUCache.put(<span class="hljs-number">4</span>, <span class="hljs-number">4</span>); <span class="hljs-comment">// è¯¥æ“ä½œä¼šä½¿å¾—å…³é”®å­— 1 ä½œåºŸï¼Œç¼“å­˜æ˜¯ &#123;4=4, 3=3&#125;</span><br>lRUCache.<span class="hljs-keyword">get</span>(<span class="hljs-number">1</span>);    <span class="hljs-comment">// è¿”å› -1 (æœªæ‰¾åˆ°)</span><br>lRUCache.<span class="hljs-keyword">get</span>(<span class="hljs-number">3</span>);    <span class="hljs-comment">// è¿”å› 3</span><br>lRUCache.<span class="hljs-keyword">get</span>(<span class="hljs-number">4</span>);    <span class="hljs-comment">// è¿”å› 4</span><br></code></pre></td></tr></table></figure><p><strong>æç¤ºï¼š</strong></p><ul><li><code>1 &lt;= capacity &lt;= 3000</code></li><li><code>0 &lt;= key &lt;= 10000</code></li><li><code>0 &lt;= value &lt;= 105</code></li><li>æœ€å¤šè°ƒç”¨ <code>2 * 105</code> æ¬¡ <code>get</code> å’Œ <code>put</code></li></ul><p><strong>è§£ç­”ï¼š</strong></p><ol><li>ä½¿ç”¨mapæ¥ä¿å­˜cacheæ•°æ®</li><li>ä½¿ç”¨åŒå‘é“¾è¡¨æ¥ä¿å­˜è®¿é—®é¢‘ç‡ï¼Œæœ€è¿‘è®¿é—®çš„æ”¾åœ¨é“¾è¡¨å¤´éƒ¨ã€‚ï¼ˆåŒå‘é“¾è¡¨æ–¹ä¾¿å°¾éƒ¨åˆ é™¤èŠ‚ç‚¹ï¼‰</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> LRUCache <span class="hljs-keyword">struct</span> &#123;<br>    size <span class="hljs-type">int</span><br>    capacity <span class="hljs-type">int</span><br>    cache <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]*DLinkedNode<br>    head *DLinkedNode<br>    tail *DLinkedNode<br>&#125;<br><br><span class="hljs-keyword">type</span> DLinkedNode <span class="hljs-keyword">struct</span> &#123;<br>    key <span class="hljs-type">int</span><br>    value <span class="hljs-type">int</span><br>    prev *DLinkedNode<br>    next *DLinkedNode<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initDLinkedNode</span><span class="hljs-params">(key, value <span class="hljs-type">int</span>)</span></span> *DLinkedNode &#123;<br>    <span class="hljs-keyword">return</span> &amp;DLinkedNode&#123;<br>        key: key,<br>        value: value,<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Constructor</span><span class="hljs-params">(capacity <span class="hljs-type">int</span>)</span></span> LRUCache &#123;<br>    l := LRUCache&#123;<br>        cache: <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]*DLinkedNode&#123;&#125;,<br>        head: initDLinkedNode(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),<br>        tail: initDLinkedNode(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),<br>        capacity: capacity,<br>    &#125;<br>    l.head.next = l.tail<br>    l.tail.prev = l.head<br>    <span class="hljs-keyword">return</span> l<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *LRUCache)</span></span> Get(key <span class="hljs-type">int</span>) <span class="hljs-type">int</span> &#123;<br>    node, ok := this.cache[key]<br>    <span class="hljs-keyword">if</span> !ok &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br>    &#125;<br>    this.moveToHead(node)<br>    <span class="hljs-keyword">return</span> node.value<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *LRUCache)</span></span> Put(key <span class="hljs-type">int</span>, value <span class="hljs-type">int</span>)  &#123;<br>    node, ok := this.cache[key]<br>    <span class="hljs-keyword">if</span> !ok &#123;<br>        node := initDLinkedNode(key, value)<br>        this.cache[key] = node<br>        this.addToHead(node)<br>        this.size++<br>        <span class="hljs-keyword">if</span> this.size &gt; this.capacity &#123;<br>            removed := this.removeTail()<br>            <span class="hljs-built_in">delete</span>(this.cache, removed.key)<br>            this.size--<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        node.value = value<br>        this.moveToHead(node)<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *LRUCache)</span></span> addToHead(node *DLinkedNode) &#123;<br>    node.prev = this.head<br>    node.next = this.head.next<br>    <span class="hljs-comment">// ä»¥ä¸‹ä¸¤è¡Œé¡ºåºä¸èƒ½å</span><br>    this.head.next.prev = node<br>    this.head.next = node<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *LRUCache)</span></span> removeNode(node *DLinkedNode) &#123;<br>    node.prev.next = node.next<br>    node.next.prev = node.prev<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *LRUCache)</span></span> moveToHead(node *DLinkedNode) &#123;<br>    this.removeNode(node)<br>    this.addToHead(node)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(this *LRUCache)</span></span> removeTail() *DLinkedNode &#123;<br>    node := this.tail.prev<br>    this.removeNode(node)<br>    <span class="hljs-keyword">return</span> node<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Your LRUCache object will be instantiated and called as such:</span><br><span class="hljs-comment"> * obj := Constructor(capacity);</span><br><span class="hljs-comment"> * param_1 := obj.Get(key);</span><br><span class="hljs-comment"> * obj.Put(key,value);</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><p>(3) </p><h2 id="206-åè½¬é“¾è¡¨"><a href="#206-åè½¬é“¾è¡¨" class="headerlink" title="206. åè½¬é“¾è¡¨"></a><a href="https://leetcode.cn/problems/reverse-linked-list/">206. åè½¬é“¾è¡¨</a></h2><p>ç»™ä½ å•é“¾è¡¨çš„å¤´èŠ‚ç‚¹ <code>head</code> ï¼Œè¯·ä½ åè½¬é“¾è¡¨ï¼Œå¹¶è¿”å›åè½¬åçš„é“¾è¡¨ã€‚</p><p>è§£ç­”ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// è¿­ä»£è§£æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reverseList</span><span class="hljs-params">(head *ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">var</span> prev *ListNode<br>    curr := head<br>    <span class="hljs-keyword">for</span> curr != <span class="hljs-literal">nil</span> &#123;<br>        next := curr.Next<br>        curr.Next = prev<br>        prev = curr<br>        curr = next<br>    &#125;<br>    <span class="hljs-keyword">return</span> prev<br>&#125;<br><br><span class="hljs-comment">// é€’å½’è§£æ³•ï¼Œä¸å¥½ç†è§£</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reverseList</span><span class="hljs-params">(head *ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">if</span> head == <span class="hljs-literal">nil</span> || head.Next == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> head<br>    &#125;<br>    newHead := reverseList(head.Next)<br>    head.Next.Next = head<br>    head.Next = <span class="hljs-literal">nil</span><br>    <span class="hljs-keyword">return</span> newHead<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="25-K-ä¸ªä¸€ç»„ç¿»è½¬é“¾è¡¨"><a href="#25-K-ä¸ªä¸€ç»„ç¿»è½¬é“¾è¡¨" class="headerlink" title="25. K ä¸ªä¸€ç»„ç¿»è½¬é“¾è¡¨"></a><a href="https://leetcode.cn/problems/reverse-nodes-in-k-group/">25. K ä¸ªä¸€ç»„ç¿»è½¬é“¾è¡¨</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reverseKGroup</span><span class="hljs-params">(head *ListNode, k <span class="hljs-type">int</span>)</span></span> *ListNode &#123;<br>    dummy := &amp;ListNode&#123;Next: head&#125;<br>    <br>    <span class="hljs-comment">// è®°å½•æ¯ä¸€æ®µçš„å‰é©±èŠ‚ç‚¹</span><br>    pre := dummy<br><br>    <span class="hljs-comment">// æ¯æ¬¡å¾ªç¯å¤„ç†kä¸ª</span><br>    <span class="hljs-keyword">for</span> head != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-comment">// æ‰¾åˆ°ç¬¬kä¸ªèŠ‚ç‚¹ï¼Œä½œä¸ºtail</span><br>        tail := pre<br>        <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; k; i++ &#123;<br>            tail = tail.Next<br>            <span class="hljs-comment">// å¦‚æœè¿˜æ²¡æœ‰åˆ°kä¸ªï¼Œå·²ç»åˆ°äº†ç»“å°¾ï¼Œåˆ™æ•´ä½“åè½¬å·²å®Œæˆï¼Œè¿”å›å¤´èŠ‚ç‚¹</span><br>            <span class="hljs-keyword">if</span> tail == <span class="hljs-literal">nil</span> &#123;<br>                <span class="hljs-keyword">return</span> dummy.Next<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// è®°å½•ä¸‹ä¸€æ®µé“¾è¡¨çš„å¼€å¤´èŠ‚ç‚¹</span><br>        next := tail.Next<br><br>        <span class="hljs-comment">// åè½¬å½“å‰é“¾è¡¨æ®µï¼Œè·å–åˆ°æ–°çš„headå’Œtail</span><br>        head, tail = reverse(head, tail)<br><br>        <span class="hljs-comment">// å°†headè¿æ¥åˆ°ä¸Šä¸€æ®µé“¾è¡¨</span><br>        pre.Next = head<br><br>        <span class="hljs-comment">// å°†tailè¿æ¥åˆ°ä¸‹ä¸€æ®µé“¾è¡¨</span><br>        tail.Next = next<br><br>        <span class="hljs-comment">// æœ¬æ®µçš„æœ«å°¾è®°å½•ä¸ºä¸‹ä¸€æ®µçš„å‰é©±</span><br>        pre = tail<br><br>        <span class="hljs-comment">// headé‡ç½®ä¸ºä¸‹ä¸€æ®µçš„å¼€å¤´</span><br>        head = tail.Next<br>    &#125;<br>    <span class="hljs-keyword">return</span> dummy.Next<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">reverse</span><span class="hljs-params">(head, tail *ListNode)</span></span> (*ListNode, *ListNode) &#123;<br>    <span class="hljs-comment">// preç”¨äºè®°å½•å‰é©±èŠ‚ç‚¹</span><br>    <span class="hljs-keyword">var</span> pre *ListNode<br><br>    <span class="hljs-comment">// ä»headèŠ‚ç‚¹å¼€å§‹å¤„ç†</span><br>    curr := head<br><br>    <span class="hljs-comment">// ä¸€ç›´å¾ªç¯åˆ°preæŒ‡å‘æœ€åä¸€ä¸ªèŠ‚ç‚¹</span><br>    <span class="hljs-keyword">for</span> pre != tail &#123;<br>        <span class="hljs-comment">// å…ˆè®°å½•å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span><br>        nex := curr.Next <br>        <span class="hljs-comment">// å°†å½“å‰èŠ‚ç‚¹æŒ‡å‘å‰é©±èŠ‚ç‚¹</span><br>        curr.Next = pre<br>        <span class="hljs-comment">// preåç§»</span><br>        pre = curr<br>        <span class="hljs-comment">// curråç§»</span><br>        curr = nex<br>    &#125;<br>    <span class="hljs-comment">// åè½¬å®Œæˆï¼Œtailæˆä¸ºæ–°çš„å¤´ï¼Œheadæˆä¸ºæ–°çš„å°¾</span><br>    <span class="hljs-keyword">return</span> tail, head<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="15-ä¸‰æ•°ä¹‹å’Œ"><a href="#15-ä¸‰æ•°ä¹‹å’Œ" class="headerlink" title="15. ä¸‰æ•°ä¹‹å’Œ"></a><a href="https://leetcode.cn/problems/3sum/">15. ä¸‰æ•°ä¹‹å’Œ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">threeSum</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> (ans [][]<span class="hljs-type">int</span>) &#123;<br>    <span class="hljs-comment">// å…ˆæ’åºï¼Œä¸ç„¶æ²¡æ³•åš</span><br>    slices.Sort(nums)<br>    <span class="hljs-comment">// </span><br>    <span class="hljs-keyword">for</span> i, x := <span class="hljs-keyword">range</span> nums[:<span class="hljs-built_in">len</span>(nums)<span class="hljs-number">-2</span>]&#123;<br>        <span class="hljs-comment">// å½“å‰å…ƒç´ å’Œä¸Šä¸€ä¸ªå…ƒç´ ç›¸åŒï¼Œåˆ™è·³è¿‡</span><br>        <span class="hljs-keyword">if</span> i &gt; <span class="hljs-number">0</span> &amp;&amp; x == nums[i<span class="hljs-number">-1</span>] &#123;<br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-comment">// å½“å‰å…ƒç´ å’Œåä¸¤ä¸ªå…ƒç´ ç›¸åŠ å·²ç»å¤§äº0ï¼Œåˆ™æ­¤åæ‰€æœ‰å¾ªç¯è‚¯å®šéƒ½å¤§äº0ï¼Œç›´æ¥é€€å‡º</span><br>        <span class="hljs-keyword">if</span> x+nums[i+<span class="hljs-number">1</span>] + nums[i+<span class="hljs-number">2</span>] &gt; <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-keyword">break</span><br>        &#125;<br>        <span class="hljs-comment">// å½“å‰å…ƒç´ å’Œæœ€åä¸¤ä¸ªå…ƒç´ ç›¸åŠ ä»ç„¶å°äº0ï¼Œåˆ™æœ¬è½®å¾ªç¯ä¸­çš„å’Œå‡å°äº0ï¼Œè·³è¿‡æœ¬è½®å¾ªç¯</span><br>        <span class="hljs-keyword">if</span> x + nums[<span class="hljs-built_in">len</span>(nums)<span class="hljs-number">-2</span>] + nums[<span class="hljs-built_in">len</span>(nums)<span class="hljs-number">-1</span>] &lt; <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-comment">// jä»å½“å‰å…ƒç´ çš„åä¸€ä¸ªå…ƒç´ å¼€å§‹</span><br>        j := i+<span class="hljs-number">1</span><br>        <span class="hljs-comment">// kä»æœ€åä¸€ä¸ªå…ƒç´ å¼€å§‹</span><br>        k := <span class="hljs-built_in">len</span>(nums)<span class="hljs-number">-1</span><br>        <br>        <span class="hljs-keyword">for</span> j &lt; k &#123;<br>            s := x + nums[j] + nums[k]<br>            <span class="hljs-comment">// å¦‚æœå°äº0ï¼Œåˆ™å¢å¤§j</span><br>            <span class="hljs-keyword">if</span> s &lt; <span class="hljs-number">0</span> &#123;<br>                j++<br>            <span class="hljs-comment">// å¦‚æœå¤§äº0ï¼Œåˆ™å‡å°k</span><br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> s &gt; <span class="hljs-number">0</span> &#123;<br>                k--<br>            <span class="hljs-comment">// ç­‰äº0ï¼Œåˆ™æ‰¾åˆ°äº†ä¸€ä¸ªç­”æ¡ˆ</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                ans = <span class="hljs-built_in">append</span>(ans, []<span class="hljs-type">int</span>&#123;x, nums[j], nums[k]&#125;)<br>                <span class="hljs-keyword">for</span> j++; j &lt; k &amp;&amp; nums[j] == nums[j<span class="hljs-number">-1</span>]; j++ &#123;&#125; <span class="hljs-comment">// è·³è¿‡é‡å¤æ•°å­—</span><br>                <span class="hljs-keyword">for</span> k--; k &gt; j &amp;&amp; nums[k] == nums[k+<span class="hljs-number">1</span>]; k-- &#123;&#125; <span class="hljs-comment">// è·³è¿‡é‡å¤æ•°å­—</span><br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="53-æœ€å¤§å­æ•°ç»„å’Œ"><a href="#53-æœ€å¤§å­æ•°ç»„å’Œ" class="headerlink" title="53. æœ€å¤§å­æ•°ç»„å’Œ"></a><a href="https://leetcode.cn/problems/maximum-subarray/">53. æœ€å¤§å­æ•°ç»„å’Œ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// åŠ¨æ€è§„åˆ’</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">maxSubArray</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(nums) == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br>    n := <span class="hljs-built_in">len</span>(nums)<br>    <span class="hljs-comment">// sums[i]å€¼çš„å«ä¹‰æ˜¯ï¼Œä»¥nums[i]ä¸ºç»“å°¾çš„æ‰€æœ‰è¿ç»­å­æ•°ç»„çš„æœ€å¤§å’Œ</span><br>    sums := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-built_in">len</span>(nums))<br>    <span class="hljs-comment">// åˆå§‹æ—¶ï¼Œä»¥nums[0]ä¸ºç»“å°¾çš„å­æ•°ç»„å°±æ˜¯å®ƒæœ¬èº«</span><br>    sums[<span class="hljs-number">0</span>] = nums[<span class="hljs-number">0</span>]<br>    <span class="hljs-comment">// ansç”¨æ¥è®°å½•æ•´ä½“æœ€å¤§å’Œ</span><br>    ans := sums[<span class="hljs-number">0</span>]<br>    <span class="hljs-comment">// ä»nums[1]å¼€å§‹éå†</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; n; i++ &#123;<br>        <span class="hljs-comment">// å…³é”®ä»£ç </span><br>        <span class="hljs-comment">// 1. sums[i-1]ä¿å­˜äº†æ‰€æœ‰ä»¥nums[i-1]ä¸ºç»“å°¾å…ƒç´ çš„è¿ç»­å­æ•°ç»„çš„æœ€å¤§å’Œ</span><br>        <span class="hljs-comment">// 2. nums[i]è¦ä¹ˆåŠ å…¥åˆ°å‰é¢çš„è¿ç»­å­æ•°ç»„ï¼Œè¦ä¹ˆè‡ªå·±å•ç‹¬ä½œä¸ºä¸€ä¸ªå­æ•°ç»„</span><br>        sums[i] = max(sums[i<span class="hljs-number">-1</span>] + nums[i], nums[i])<br>        ans = max(ans, sums[i])<br>    &#125;<br>    <span class="hljs-keyword">return</span> ans<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="21-åˆå¹¶ä¸¤ä¸ªæœ‰åºé“¾è¡¨"><a href="#21-åˆå¹¶ä¸¤ä¸ªæœ‰åºé“¾è¡¨" class="headerlink" title="21. åˆå¹¶ä¸¤ä¸ªæœ‰åºé“¾è¡¨"></a><a href="https://leetcode.cn/problems/merge-two-sorted-lists/">21. åˆå¹¶ä¸¤ä¸ªæœ‰åºé“¾è¡¨</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// è¿­ä»£æ³•</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mergeTwoLists</span><span class="hljs-params">(list1 *ListNode, list2 *ListNode)</span></span> *ListNode &#123;<br>    dummy := &amp;ListNode&#123;&#125;<br>    p := dummy<br>    <span class="hljs-keyword">for</span> list1 != <span class="hljs-literal">nil</span> &amp;&amp; list2 != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">if</span> list1.Val &lt; list2.Val &#123;<br>            p.Next = list1<br>            list1 = list1.Next<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            p.Next = list2<br>            list2 = list2.Next<br>        &#125;<br>        p = p.Next<br>    &#125;<br>    <span class="hljs-keyword">if</span> list1 != <span class="hljs-literal">nil</span> &#123;<br>        p.Next = list1<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        p.Next = list2<br>    &#125;<br>   <br>    <span class="hljs-keyword">return</span> dummy.Next<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// é€’å½’æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mergeTwoLists</span><span class="hljs-params">(list1 *ListNode, list2 *ListNode)</span></span> *ListNode &#123;<br>    <span class="hljs-keyword">if</span> list1 == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> list2<br>    &#125;<br>    <span class="hljs-keyword">if</span> list2 == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> list1<br>    &#125;<br>    <span class="hljs-keyword">if</span> list1.Val &lt; list2.Val &#123;<br>        list1.Next = mergeTwoLists(list1.Next, list2)<br>        <span class="hljs-keyword">return</span> list1<br>    &#125;<br>    list2.Next = mergeTwoLists(list2.Next, list1)<br>    <span class="hljs-keyword">return</span> list2<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-æœ€é•¿å›æ–‡å­ä¸²"><a href="#5-æœ€é•¿å›æ–‡å­ä¸²" class="headerlink" title="5. æœ€é•¿å›æ–‡å­ä¸²"></a><a href="https://leetcode.cn/problems/longest-palindromic-substring/">5. æœ€é•¿å›æ–‡å­ä¸²</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// åŠ¨æ€è§„åˆ’</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">longestPalindrome</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>    n := <span class="hljs-built_in">len</span>(s)<br>    <span class="hljs-keyword">if</span> n &lt; <span class="hljs-number">2</span> &#123;<br>        <span class="hljs-keyword">return</span> s<br>    &#125;<br><br>    <span class="hljs-comment">// ç”¨äºè®°å½•æœ€é•¿å›æ–‡ä¸²é•¿åº¦åŠèµ·å§‹ä½ç½®</span><br>    maxLen := <span class="hljs-number">1</span><br>    begin := <span class="hljs-number">0</span><br><br>    <span class="hljs-comment">// åˆå§‹åŒ–dpæ•°ç»„ï¼Œå¹¶å°†dp[i][i]ç½®ä¸ºtrueï¼ˆæ¯ä¸ªå…ƒç´ éƒ½å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªå›æ–‡ä¸²ï¼‰</span><br>    dp := <span class="hljs-built_in">make</span>([][]<span class="hljs-type">bool</span>, n)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> n &#123;<br>        dp[i] = <span class="hljs-built_in">make</span>([]<span class="hljs-type">bool</span>, n)<br>        dp[i][i] = <span class="hljs-literal">true</span><br>    &#125;<br><br>    <span class="hljs-comment">// å¤–å±‚é•¿åº¦å¾ªç¯ï¼Œéå†æ‰€æœ‰é•¿åº¦çš„å­ä¸²</span><br>    <span class="hljs-keyword">for</span> l := <span class="hljs-number">2</span>; l &lt; n + <span class="hljs-number">1</span>; l++ &#123;<br>        <span class="hljs-comment">// å†…å±‚å¯¹èµ·å§‹ä½ç½®è¿›è¡Œå¾ªç¯ï¼Œéå†æ‰€æœ‰çš„èµ·å§‹ä½ç½®</span><br>        <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> n &#123;<br>            <span class="hljs-comment">// è®¡ç®—ç»“æŸä½ç½®</span><br>            j := i + l <span class="hljs-number">-1</span><br><br>            <span class="hljs-comment">// è‹¥ç»“æŸä½ç½®ä¸åˆæ³•ï¼Œåˆ™ç›´æ¥é€€å‡ºæœ¬è½®å¾ªç¯</span><br>            <span class="hljs-keyword">if</span> j &gt;= n &#123;<br>                <span class="hljs-keyword">break</span><br>            &#125;<br><br>            <span class="hljs-comment">// æ ¸å¿ƒä»£ç ï¼Œdp[i][j]æ˜¯å¦ä¸ºå›æ–‡ä¸²ï¼Œå–å†³äº</span><br>            <span class="hljs-comment">// 1. å†…å±‚dp[i+1][j-1]æ˜¯å›æ–‡ä¸²</span><br>            <span class="hljs-comment">// 2. s[i] == s[j]</span><br>            <span class="hljs-keyword">if</span> s[i] == s[j] &#123;<br>                <span class="hljs-keyword">if</span> j - i &lt;= <span class="hljs-number">2</span> &#123;<br>                    dp[i][j] = <span class="hljs-literal">true</span><br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    dp[i][j] = dp[i+<span class="hljs-number">1</span>][j<span class="hljs-number">-1</span>]<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-comment">// å®æ—¶æ›´æ–°æœ€é•¿å­ä¸²é•¿åº¦åŠèµ·å§‹ä½ç½®</span><br>            <span class="hljs-keyword">if</span> dp[i][j] &amp;&amp; j - i + <span class="hljs-number">1</span> &gt; maxLen &#123;<br>                maxLen = j - i + <span class="hljs-number">1</span><br>                begin = i<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// è¿”å›æœ€ç»ˆç»“æœ</span><br>    <span class="hljs-keyword">return</span> s[begin:begin+maxLen]<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="102-äºŒå‰æ ‘çš„å±‚åºéå†"><a href="#102-äºŒå‰æ ‘çš„å±‚åºéå†" class="headerlink" title="102. äºŒå‰æ ‘çš„å±‚åºéå†"></a><a href="https://leetcode.cn/problems/binary-tree-level-order-traversal/">102. äºŒå‰æ ‘çš„å±‚åºéå†</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">levelOrder</span><span class="hljs-params">(root *TreeNode)</span></span> [][]<span class="hljs-type">int</span> &#123;<br>    <span class="hljs-comment">// å®šä¹‰è¿”å›å€¼</span><br>    res := [][]<span class="hljs-type">int</span>&#123;&#125;<br>    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> res<br>    &#125;<br><br>    <span class="hljs-comment">// qç”¨äºä¿å­˜å¾…éå†çš„å…ƒç´ </span><br>    q := []*TreeNode&#123;root&#125;<br>    <span class="hljs-comment">// qä¸­ä¿å­˜çš„å§‹ç»ˆæ˜¯åŒä¸€å±‚çš„å…ƒç´ </span><br>    <span class="hljs-comment">// æ¯æ¬¡å¾ªç¯ä¸­æŠŠqä¸­æ‰€æœ‰å…ƒç´ éƒ½å–å‡ºï¼Œéƒ½å–å‡ºåå†å¡«å…¥ä¸‹ä¸€å±‚çš„å…ƒç´ </span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; <span class="hljs-built_in">len</span>(q) &gt; <span class="hljs-number">0</span>; i++ &#123;<br>        res = <span class="hljs-built_in">append</span>(res, []<span class="hljs-type">int</span>&#123;&#125;)<br>        <span class="hljs-comment">// å…³é”®ç‚¹ï¼Œç”¨ä¸´æ—¶çš„pæ¥ä¿å­˜ä¸‹å±‚å…ƒç´ ï¼Œå¾…æœ¬å±‚å…ƒç´ å¤„ç†å®Œåï¼Œç”¨pæ›¿æ¢q</span><br>        p := []*TreeNode&#123;&#125;<br>        <span class="hljs-comment">// å°†qä¸­å…ƒç´ å…¨éƒ¨éå†ï¼Œè¿‡ç¨‹ä¸­å°†ä¸‹å±‚å­èŠ‚ç‚¹åŠ å…¥p</span><br>        <span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; <span class="hljs-built_in">len</span>(q); j++ &#123;<br>            node := q[j]<br>            res[i] = <span class="hljs-built_in">append</span>(res[i], node.Val)<br>            <span class="hljs-keyword">if</span> node.Left != <span class="hljs-literal">nil</span> &#123;<br>                p = <span class="hljs-built_in">append</span>(p, node.Left)<br>            &#125;<br>            <span class="hljs-keyword">if</span> node.Right != <span class="hljs-literal">nil</span> &#123;<br>                p = <span class="hljs-built_in">append</span>(p, node.Right)<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// ç”¨pæ›¿æ¢qï¼Œè¿›å…¥æ–°ä¸€è½®å¾ªç¯</span><br>        q = p<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-ä¸¤æ•°ä¹‹å’Œ"><a href="#1-ä¸¤æ•°ä¹‹å’Œ" class="headerlink" title="1. ä¸¤æ•°ä¹‹å’Œ"></a><a href="https://leetcode.cn/problems/two-sum/">1. ä¸¤æ•°ä¹‹å’Œ</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">twoSum</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>, target <span class="hljs-type">int</span>)</span></span> []<span class="hljs-type">int</span> &#123;<br>    m := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>)<br>    <span class="hljs-keyword">for</span> i, v := <span class="hljs-keyword">range</span> nums &#123;<br>        <span class="hljs-keyword">if</span> idx, ok := m[target-v]; ok &#123;<br>            <span class="hljs-keyword">return</span> []<span class="hljs-type">int</span>&#123;i, idx&#125;<br>        &#125;<br>        m[v] = i<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="33-æœç´¢æ—‹è½¬æ’åºæ•°ç»„"><a href="#33-æœç´¢æ—‹è½¬æ’åºæ•°ç»„" class="headerlink" title="33. æœç´¢æ—‹è½¬æ’åºæ•°ç»„"></a><a href="https://leetcode.cn/problems/search-in-rotated-sorted-array/">33. æœç´¢æ—‹è½¬æ’åºæ•°ç»„</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">search</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>, target <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(nums) == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br>    &#125;<br><br>    n := <span class="hljs-built_in">len</span>(nums)<br>    l := <span class="hljs-number">0</span><br>    r := n - <span class="hljs-number">1</span><br>    <span class="hljs-comment">// æ€»ä½“æ˜¯äºŒåˆ†æŸ¥æ‰¾</span><br>    <span class="hljs-keyword">for</span> l &lt;= r &#123;<br>        <span class="hljs-comment">// è·å–ä¸­é—´ä½ç½®</span><br>        mid := (l + r) / <span class="hljs-number">2</span><br>        <span class="hljs-comment">// å¦‚æœå‘½ä¸­ï¼Œåˆ™è¿”å›</span><br>        <span class="hljs-keyword">if</span> nums[mid] == target &#123;<br>            <span class="hljs-keyword">return</span> mid<br>        &#125;<br>        <span class="hljs-comment">// å¦‚æœå·¦è¾¹æ˜¯å‡åº</span><br>        <span class="hljs-keyword">if</span> nums[<span class="hljs-number">0</span>] &lt;= nums[mid] &#123;<br>            <span class="hljs-comment">// å¹¶ä¸”targetåœ¨å·¦è¾¹</span><br>            <span class="hljs-keyword">if</span> nums[<span class="hljs-number">0</span>] &lt;= target &amp;&amp; target &lt; nums[mid] &#123;<br>                r = mid - <span class="hljs-number">1</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                l = mid + <span class="hljs-number">1</span><br>            &#125;<br>        <span class="hljs-comment">// å¦‚æœå³è¾¹æ˜¯å‡åº</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// å¹¶ä¸”targetåœ¨å³è¾¹</span><br>            <span class="hljs-keyword">if</span> nums[mid] &lt; target &amp;&amp; target &lt;= nums[n<span class="hljs-number">-1</span>] &#123;<br>                l = mid + <span class="hljs-number">1</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                r = mid - <span class="hljs-number">1</span><br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="200-å²›å±¿æ•°é‡"><a href="#200-å²›å±¿æ•°é‡" class="headerlink" title="200. å²›å±¿æ•°é‡"></a><a href="https://leetcode.cn/problems/number-of-islands/">200. å²›å±¿æ•°é‡</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// æ·±åº¦ä¼˜å…ˆæœç´¢</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">dfs</span><span class="hljs-params">(grid [][]<span class="hljs-type">byte</span>, r, c <span class="hljs-type">int</span>)</span></span> &#123;<br>    nr := <span class="hljs-built_in">len</span>(grid)<br>    nc := <span class="hljs-built_in">len</span>(grid[<span class="hljs-number">0</span>])<br><br>    <span class="hljs-comment">// å…ˆå°†éå†åˆ°çš„å…ƒç´ ç½®ä¸º0</span><br>    grid[r][c] = <span class="hljs-string">&#x27;0&#x27;</span><br>    <span class="hljs-comment">// å‘ä¸Šä¸‹å·¦å³éƒ½èµ°ä¸€æ­¥ï¼Œå¦‚æœå€¼ä¸º1ï¼Œåˆ™å¾€ä¸‹æœç´¢</span><br>    <span class="hljs-keyword">if</span> r - <span class="hljs-number">1</span> &gt;= <span class="hljs-number">0</span> &amp;&amp; grid[r<span class="hljs-number">-1</span>][c] == <span class="hljs-string">&#x27;1&#x27;</span> &#123;<br>        dfs(grid, r<span class="hljs-number">-1</span>, c)<br>    &#125;<br>    <span class="hljs-keyword">if</span> r + <span class="hljs-number">1</span> &lt; nr &amp;&amp; grid[r+<span class="hljs-number">1</span>][c] == <span class="hljs-string">&#x27;1&#x27;</span> &#123;<br>        dfs(grid, r+<span class="hljs-number">1</span>, c)<br>    &#125;<br>    <span class="hljs-keyword">if</span> c - <span class="hljs-number">1</span> &gt;= <span class="hljs-number">0</span> &amp;&amp; grid[r][c<span class="hljs-number">-1</span>] == <span class="hljs-string">&#x27;1&#x27;</span> &#123;<br>        dfs(grid, r, c<span class="hljs-number">-1</span>)<br>    &#125;<br>    <span class="hljs-keyword">if</span> c + <span class="hljs-number">1</span> &lt; nc &amp;&amp; grid[r][c+<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;1&#x27;</span> &#123;<br>        dfs(grid, r, c+<span class="hljs-number">1</span>)<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">numIslands</span><span class="hljs-params">(grid [][]<span class="hljs-type">byte</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    nr := <span class="hljs-built_in">len</span>(grid)<br>    <span class="hljs-keyword">if</span> nr == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br>    nc := <span class="hljs-built_in">len</span>(grid[<span class="hljs-number">0</span>])<br>    <span class="hljs-keyword">if</span> nc == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br><br>    <span class="hljs-keyword">var</span> numIslands <span class="hljs-type">int</span><br>    <span class="hljs-comment">// å°†æ‰€æœ‰å…ƒç´ éå†ä¸€éï¼Œå¦‚æœé‡åˆ°1å°±æ·±åº¦ä¼˜å…ˆæœç´¢</span><br>    <span class="hljs-comment">// åœ¨æ·±åº¦ä¼˜å…ˆæœç´¢ä¸­ï¼Œä¼šå°†éå†åˆ°çš„å…ƒç´ ç½®ä¸º0</span><br>    <span class="hljs-comment">// æœ€ç»ˆæ‰§è¡Œçš„æœç´¢æ¬¡æ•°å³ä¸ºå²›å±¿æ•°é‡</span><br>    <span class="hljs-keyword">for</span> r := <span class="hljs-number">0</span>; r &lt; nr; r++ &#123;<br>        <span class="hljs-keyword">for</span> c := <span class="hljs-number">0</span>; c &lt; nc; c++ &#123;<br>            <span class="hljs-keyword">if</span> grid[r][c] == <span class="hljs-string">&#x27;1&#x27;</span> &#123;<br>                numIslands++<br>                dfs(grid, r, c)<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> numIslands<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="46-å…¨æ’åˆ—"><a href="#46-å…¨æ’åˆ—" class="headerlink" title="46. å…¨æ’åˆ—"></a><a href="https://leetcode.cn/problems/permutations/">46. å…¨æ’åˆ—</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å›æº¯æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">permute</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> [][]<span class="hljs-type">int</span> &#123;<br>    res := [][]<span class="hljs-type">int</span>&#123;&#125;<br>    n := <span class="hljs-built_in">len</span>(nums)<br><br>    <span class="hljs-keyword">var</span> backtrack <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span></span><br>    <span class="hljs-comment">// å¯¹posè¿™ä¸ªä½ç½®ï¼Œä½¿ç”¨å¾…æ’åˆ—çš„æ‰€æœ‰æ•°å­—å°è¯•ä¸€é</span><br>    backtrack = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(pos <span class="hljs-type">int</span>)</span></span> &#123;<br>        <span class="hljs-comment">// å¦‚æœç´¢å¼•åˆ°äº†nï¼Œåˆ™è¯´æ˜å¾—åˆ°äº†ä¸€ä¸ªå…¨æ’åˆ—ï¼Œå°†ç»“æœåŠ å…¥åˆ°ç»“æœé›†ä¸­</span><br>        <span class="hljs-keyword">if</span> pos == n &#123;<br>            res = <span class="hljs-built_in">append</span>(res, <span class="hljs-built_in">append</span>([]<span class="hljs-type">int</span>&#123;&#125;, nums...))<br>        &#125;<br>        <span class="hljs-comment">// å¯¹posè¿™ä¸ªä½ç½®å°è¯•æ‰€æœ‰å¾…ä½¿ç”¨å…ƒç´ </span><br>        <span class="hljs-keyword">for</span> i := pos; i &lt; n; i++ &#123;<br>            <span class="hljs-comment">// æŠŠç¬¬iä¸ªä½ç½®çš„å…ƒç´ æ”¾åˆ°posä½ç½®ä¸Š</span><br>            nums[pos], nums[i] = nums[i], nums[pos]<br>            <span class="hljs-comment">// å¾—åˆ°posåé¢æ‰€æœ‰å­—ç¬¦çš„ç»“æœé›†</span><br>            backtrack(pos+<span class="hljs-number">1</span>)<br>            <span class="hljs-comment">// æ¢å¤poså’Œiå…ƒç´ çš„åˆå§‹ä½ç½®ï¼Œä»¥ä¾¿ä¸‹ä¸€æ¬¡å¾ªç¯ä½¿ç”¨å¦å¤–çš„å…ƒç´ </span><br>            nums[pos], nums[i] = nums[i], nums[pos]<br>        &#125;<br>    &#125;<br><br>    backtrack(<span class="hljs-number">0</span>)<br><br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="20-æœ‰æ•ˆçš„æ‹¬å·"><a href="#20-æœ‰æ•ˆçš„æ‹¬å·" class="headerlink" title="20. æœ‰æ•ˆçš„æ‹¬å·"></a><a href="https://leetcode.cn/problems/valid-parentheses/">20. æœ‰æ•ˆçš„æ‹¬å·</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">isValid</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>    n := <span class="hljs-built_in">len</span>(s)<br>    <span class="hljs-comment">// å¦‚æœå­—ç¬¦æ˜¯å¥‡æ•°ä¸ªï¼Œåˆ™è‚¯å®šä¸èƒ½å®Œå…¨åŒ¹é…</span><br>    <span class="hljs-keyword">if</span> n % <span class="hljs-number">2</span> == <span class="hljs-number">1</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>    &#125;<br><br>    <span class="hljs-comment">// è®°å½•å³æ‹¬å·å¯¹åº”çš„å·¦æ‹¬å·</span><br>    pairs := <span class="hljs-keyword">map</span>[<span class="hljs-type">byte</span>]<span class="hljs-type">byte</span>&#123;<br>        <span class="hljs-string">&#x27;)&#x27;</span>: <span class="hljs-string">&#x27;(&#x27;</span>,<br>        <span class="hljs-string">&#x27;]&#x27;</span>: <span class="hljs-string">&#x27;[&#x27;</span>,<br>        <span class="hljs-string">&#x27;&#125;&#x27;</span>: <span class="hljs-string">&#x27;&#123;&#x27;</span>,<br>    &#125;<br><br>    stack := []<span class="hljs-type">byte</span>&#123;&#125;<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n; i++ &#123;<br>        <span class="hljs-comment">// å¦‚æœæ‹¿åˆ°äº†ä¸€ä¸ªå³æ‹¬å·</span><br>        <span class="hljs-keyword">if</span> v, ok := pairs[s[i]]; ok &#123;<br>            <span class="hljs-comment">// å¦‚æœæ ˆä¸ºç©ºï¼Œæˆ–è€…æ ˆé¡¶å…ƒç´ ä¸å½“å‰å³æ‹¬å·ä¸åŒ¹é…ï¼Œå°±ç›´æ¥è¿”å›false</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(stack) == <span class="hljs-number">0</span> || stack[<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>] != v &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>            &#125;<br>            <span class="hljs-comment">// å¦‚æœåŒ¹é…å°±æŠŠæ ˆé¡¶å…ƒç´ å‡ºæ ˆ</span><br>            stack = stack[:<span class="hljs-built_in">len</span>(stack)<span class="hljs-number">-1</span>]<br>        <span class="hljs-comment">// å¦‚æœæ‹¿åˆ°çš„æ˜¯å·¦æ‹¬å·ï¼Œå°±å‹æ ˆ</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            stack = <span class="hljs-built_in">append</span>(stack, s[i])<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// æ ˆä¸­å‰©ä½™å…ƒç´ å°±æ˜¯æ²¡æœ‰åŒ¹é…æˆåŠŸçš„</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(stack) == <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="121-ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº"><a href="#121-ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº" class="headerlink" title="121. ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº"></a><a href="https://leetcode.cn/problems/best-time-to-buy-and-sell-stock/">121. ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// æ ¸å¿ƒæ€æƒ³ï¼šç¬¬iå¤©å–å‡ºå¾—åˆ°çš„æœ€å¤§åˆ©æ¶¦ï¼Œä¹°å…¥ä»·æ ¼ä¸€å®šæ˜¯å‰i-1å¤©ä¸­çš„æœ€ä½ä»·æ ¼</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">maxProfit</span><span class="hljs-params">(prices []<span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(prices) == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>    &#125;<br>    <span class="hljs-comment">// è®°å½•â€œå†å²â€æœ€ä½ä»·æ ¼</span><br>    minPrice := prices[<span class="hljs-number">0</span>]<br>    <span class="hljs-comment">// è®°å½•æœ€å¤§åˆ©æ¶¦</span><br>    maxProfit := <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> _, price := <span class="hljs-keyword">range</span> prices &#123;<br>        <span class="hljs-comment">// æ›´æ–°æœ€å¤§åˆ©æ¶¦</span><br>        maxProfit = max(maxProfit, price - minPrice)<br>        <span class="hljs-comment">// æ›´æ–°å†å²æœ€ä½ä»·æ ¼</span><br>        minPrice = min(minPrice, price)<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> maxProfit<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="88-åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„"><a href="#88-åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„" class="headerlink" title="88. åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„"></a><a href="https://leetcode.cn/problems/merge-sorted-array/">88. åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">merge</span><span class="hljs-params">(nums1 []<span class="hljs-type">int</span>, m <span class="hljs-type">int</span>, nums2 []<span class="hljs-type">int</span>, n <span class="hljs-type">int</span>)</span></span>  &#123;<br>    <span class="hljs-comment">// ä»åå‘å‰éå†</span><br>    <span class="hljs-comment">// p1æŒ‡å‘nums1å¾…æ’å…ƒç´ ï¼Œp2æŒ‡å‘nums2å¾…æ’å…ƒç´ ï¼ŒtailæŒ‡å‘è¦æ”¾å…¥çš„ä½ç½®</span><br>    <span class="hljs-keyword">for</span> p1, p2, tail := m<span class="hljs-number">-1</span>, n<span class="hljs-number">-1</span>, m+n<span class="hljs-number">-1</span>; p1 &gt;=<span class="hljs-number">0</span> || p2 &gt;= <span class="hljs-number">0</span>; tail-- &#123;<br>        <span class="hljs-comment">// å½“å‰è¦å¤„ç†çš„å…ƒç´ æ˜¯ä»€ä¹ˆ</span><br>        <span class="hljs-keyword">var</span> cur <span class="hljs-type">int</span><br>        <span class="hljs-comment">// å¦‚æœnums1å·²ç»éå†å®Œäº†</span><br>        <span class="hljs-keyword">if</span> p1 == <span class="hljs-number">-1</span> &#123;<br>            <span class="hljs-comment">// ä»nums2ä¸­å–</span><br>            cur = nums2[p2]<br>            p2--<br>        <span class="hljs-comment">// å¦‚æœnums2å·²ç»éå†å®Œäº†</span><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> p2 == <span class="hljs-number">-1</span> &#123;<br>            <span class="hljs-comment">// ä»nums1ä¸­å–</span><br>            cur = nums1[p1]<br>            p1--<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> nums1[p1] &gt; nums2[p2] &#123;<br>            cur = nums1[p1]<br>            p1--<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            cur = nums2[p2]<br>            p2--<br>        &#125;<br>        nums1[tail] = cur<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="103-äºŒå‰æ ‘çš„é”¯é½¿å½¢å±‚åºéå†"><a href="#103-äºŒå‰æ ‘çš„é”¯é½¿å½¢å±‚åºéå†" class="headerlink" title="103. äºŒå‰æ ‘çš„é”¯é½¿å½¢å±‚åºéå†"></a><a href="https://leetcode.cn/problems/binary-tree-zigzag-level-order-traversal/">103. äºŒå‰æ ‘çš„é”¯é½¿å½¢å±‚åºéå†</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for a binary tree node.</span><br><span class="hljs-comment"> * type TreeNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Left *TreeNode</span><br><span class="hljs-comment"> *     Right *TreeNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">zigzagLevelOrder</span><span class="hljs-params">(root *TreeNode)</span></span> [][]<span class="hljs-type">int</span> &#123;<br>    res := [][]<span class="hljs-type">int</span>&#123;&#125;<br>    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> res<br>    &#125;<br>    <span class="hljs-comment">// è¾…åŠ©å±‚åºéå†</span><br>    queue := []*TreeNode&#123;root&#125;<br>    <span class="hljs-keyword">for</span> level := <span class="hljs-number">0</span>; <span class="hljs-built_in">len</span>(queue) &gt; <span class="hljs-number">0</span>; level++ &#123;<br>        vals := []<span class="hljs-type">int</span>&#123;&#125;<br>        <span class="hljs-comment">// qæ¥æ”¶æœ¬å±‚å…ƒç´ ï¼Œç”¨äºéå†ï¼Œqueueä¿å­˜ä¸‹å±‚å…ƒç´ </span><br>        q := queue<br>        queue = <span class="hljs-literal">nil</span><br>        <span class="hljs-keyword">for</span> _, node := <span class="hljs-keyword">range</span> q &#123;<br>            vals = <span class="hljs-built_in">append</span>(vals, node.Val)<br>            <span class="hljs-keyword">if</span> node.Left != <span class="hljs-literal">nil</span> &#123;<br>                queue = <span class="hljs-built_in">append</span>(queue, node.Left)<br>            &#125;<br>            <span class="hljs-keyword">if</span> node.Right != <span class="hljs-literal">nil</span> &#123;<br>                queue = <span class="hljs-built_in">append</span>(queue, node.Right)<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// å¦‚æœæœ¬å±‚ä¸ºå¥‡æ•°å±‚ï¼Œå°†å¾—åˆ°çš„éå†ç»“æœåè½¬ï¼Œå†åŠ å…¥ç»“æœé›†</span><br>        <span class="hljs-keyword">if</span> level % <span class="hljs-number">2</span> == <span class="hljs-number">1</span> &#123;<br>            n := <span class="hljs-built_in">len</span>(vals)<br>            <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; n/<span class="hljs-number">2</span>; i++ &#123;<br>                vals[i], vals[n<span class="hljs-number">-1</span>-i] = vals[n<span class="hljs-number">-1</span>-i], vals[i]<br>            &#125;<br>        &#125;<br>        res = <span class="hljs-built_in">append</span>(res, vals)<br>    &#125;<br>    <span class="hljs-keyword">return</span> res<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="141-ç¯å½¢é“¾è¡¨"><a href="#141-ç¯å½¢é“¾è¡¨" class="headerlink" title="141. ç¯å½¢é“¾è¡¨"></a><a href="https://leetcode.cn/problems/linked-list-cycle/">141. ç¯å½¢é“¾è¡¨</a></h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Definition for singly-linked list.</span><br><span class="hljs-comment"> * type ListNode struct &#123;</span><br><span class="hljs-comment"> *     Val int</span><br><span class="hljs-comment"> *     Next *ListNode</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// å“ˆå¸Œè¡¨</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">hasCycle</span><span class="hljs-params">(head *ListNode)</span></span> <span class="hljs-type">bool</span> &#123;<br>    seen := <span class="hljs-keyword">map</span>[*ListNode]<span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br>    <span class="hljs-keyword">for</span> head != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">if</span> _, ok := seen[head]; ok &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>        &#125;<br>        seen[head] = <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br>        head = head.Next<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å¿«æ…¢æŒ‡é’ˆ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">hasCycle</span><span class="hljs-params">(head *ListNode)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">if</span> head == <span class="hljs-literal">nil</span> || head.Next == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>    &#125;<br>    <span class="hljs-comment">// æ…¢æŒ‡é’ˆæ¯æ¬¡èµ°ä¸€æ­¥ï¼Œå¿«æŒ‡é’ˆæ¯æ¬¡èµ°ä¸¤æ­¥</span><br>    <span class="hljs-comment">// æ¯æ¬¡ç§»åŠ¨å¿«æ…¢æŒ‡é’ˆä¹‹é—´çš„è·ç¦»ä¼šåŠ 1ï¼Œå¦‚æœæœ‰ç¯çš„è¯ï¼Œå¿«æ…¢æŒ‡é’ˆç»ˆä¼šç›¸é‡</span><br>    slow, fast := head, head.Next<br>    <span class="hljs-keyword">for</span> slow != fast &#123;<br>        <span class="hljs-keyword">if</span> fast == <span class="hljs-literal">nil</span> || fast.Next == <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>        &#125;<br>        slow = slow.Next<br>        fast = fast.Next.Next<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>metrics-serveræºç è§£è¯»</title>
    <link href="/2025/04/08/metrics-server%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"/>
    <url>/2025/04/08/metrics-server%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/</url>
    
    <content type="html"><![CDATA[<h1 id="metrics-serveræºç è§£è¯»"><a href="#metrics-serveræºç è§£è¯»" class="headerlink" title="metrics-serveræºç è§£è¯»"></a>metrics-serveræºç è§£è¯»</h1><p>è½¬è‡ªï¼š<a href="https://yost.top/2020/05/17/about-metric-server/">https://yost.top/2020/05/17/about-metric-server/</a></p><h3 id="1ã€é¡¹ç›®æ¦‚å†µ"><a href="#1ã€é¡¹ç›®æ¦‚å†µ" class="headerlink" title="1ã€é¡¹ç›®æ¦‚å†µ"></a>1ã€é¡¹ç›®æ¦‚å†µ</h3><p>é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/kubernetes-sigs/metrics-server">https://github.com/kubernetes-sigs/metrics-server</a></p><p>åœ¨<code>k8s</code>é›†ç¾¤ä¸­ï¼Œå¦‚æœä½ æƒ³è¦å»åšå¼¹æ€§ä¼¸ç¼©ï¼Œæˆ–è€…æƒ³è¦ä½¿ç”¨<code>kubectl top</code>å‘½ä»¤ï¼Œé‚£ä¹ˆ<code>metric-server</code>æ˜¯ä½ ç»•ä¸å¼€çš„ç»„ä»¶ã€‚<code>metric-server</code>ä¸»è¦ç”¨æ¥é€šè¿‡<code>aggregate api</code>å‘å…¶å®ƒç»„ä»¶æä¾›é›†ç¾¤ä¸­çš„<code>pod</code>å’Œ<code>node</code>çš„<code>cpu</code>å’Œ<code>memory</code>çš„ç›‘æ§æŒ‡æ ‡ï¼Œå¼¹æ€§ä¼¸ç¼©ä¸­çš„<code>podautoscaler</code>å°±æ˜¯é€šè¿‡è°ƒç”¨è¿™ä¸ªæ¥å£æ¥æŸ¥çœ‹podçš„å½“å‰èµ„æºä½¿ç”¨é‡æ¥è¿›è¡Œpodçš„æ‰©ç¼©å®¹çš„ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p><ul><li><code>metric-server</code>æä¾›çš„æ˜¯å®æ—¶çš„æŒ‡æ ‡ï¼ˆå®é™…æ˜¯æœ€è¿‘ä¸€æ¬¡é‡‡é›†çš„æ•°æ®ï¼Œä¿å­˜åœ¨å†…å­˜ä¸­ï¼‰ï¼Œå¹¶æ²¡æœ‰æ•°æ®åº“æ¥å­˜å‚¨</li><li>è¿™äº›æ•°æ®æŒ‡æ ‡å¹¶éç”±<code>metric-server</code>æœ¬èº«é‡‡é›†ï¼Œè€Œæ˜¯ç”±æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„<code>cadvisor</code>é‡‡é›†ï¼Œ<code>metric-server</code>åªæ˜¯å‘è¯·æ±‚ç»™<code>cadvisor</code>å¹¶å°†<code>metric</code>æ ¼å¼çš„æ•°æ®è½¬æ¢æˆ<code>aggregate api</code></li><li>ç”±äºéœ€è¦é€šè¿‡<code>aggregate api</code>æ¥æä¾›æ¥å£ï¼Œéœ€è¦é›†ç¾¤ä¸­çš„<code>kube-apiserver</code>å¼€å¯è¯¥åŠŸèƒ½ï¼ˆå¼€å¯æ–¹æ³•å¯ä»¥å‚è€ƒå®˜æ–¹ç¤¾åŒºçš„æ–‡æ¡£ï¼‰</li></ul><h3 id="2ã€éƒ¨ç½²æ–¹æ³•"><a href="#2ã€éƒ¨ç½²æ–¹æ³•" class="headerlink" title="2ã€éƒ¨ç½²æ–¹æ³•"></a>2ã€éƒ¨ç½²æ–¹æ³•</h3><p><code>metric-server</code>æœ€ä½³çš„å®‰è£…æ–¹æ³•æ˜¯é€šè¿‡<code>deployment</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.3.6/components.yaml<br></code></pre></td></tr></table></figure><p>è¯¥<code>yaml</code>ä¸­ä¸»è¦çš„<code>deployment</code>å‚æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">metrics-server</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">metrics-server</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">metrics-server</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">metrics-server</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">metrics-server</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">metrics-server</span><br>      <span class="hljs-attr">volumes:</span><br>      <span class="hljs-comment"># mount in tmp so we can safely use from-scratch images and/or read-only containers</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">tmp-dir</span><br>        <span class="hljs-attr">emptyDir:</span> &#123;&#125;<br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">metrics-server</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">k8s.gcr.io/metrics-server-amd64:v0.3.6</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-attr">args:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">--cert-dir=/tmp</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">--secure-port=4443</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">main-port</span><br>          <span class="hljs-attr">containerPort:</span> <span class="hljs-number">4443</span><br>          <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>        <span class="hljs-attr">securityContext:</span><br>          <span class="hljs-attr">readOnlyRootFilesystem:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-attr">runAsNonRoot:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-attr">runAsUser:</span> <span class="hljs-number">1000</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">tmp-dir</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/tmp</span><br>      <span class="hljs-attr">nodeSelector:</span><br>        <span class="hljs-attr">kubernetes.io/os:</span> <span class="hljs-string">linux</span><br>        <span class="hljs-attr">kubernetes.io/arch:</span> <span class="hljs-string">&quot;amd64&quot;</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­è¿˜æœ‰ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„èµ„æºæ˜¯ä¸€ä¸ª<code>APIService</code>ï¼Œè¿™ä¸ªèµ„æºä¸»è¦å°±æ˜¯å°†<code>metrics-server</code>æ³¨å†Œåˆ°<code>aggregate api</code>ä¸­ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apiregistration.k8s.io/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">APIService</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">v1beta1.metrics.k8s.io</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">service:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">metrics-server</span><br>    <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">group:</span> <span class="hljs-string">metrics.k8s.io</span><br>  <span class="hljs-attr">version:</span> <span class="hljs-string">v1beta1</span><br>  <span class="hljs-attr">insecureSkipTLSVerify:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">groupPriorityMinimum:</span> <span class="hljs-number">100</span><br>  <span class="hljs-attr">versionPriority:</span> <span class="hljs-number">100</span><br></code></pre></td></tr></table></figure><h3 id="3ã€å¯åŠ¨å‚æ•°"><a href="#3ã€å¯åŠ¨å‚æ•°" class="headerlink" title="3ã€å¯åŠ¨å‚æ•°"></a>3ã€å¯åŠ¨å‚æ•°</h3><table><thead><tr><th align="left">å‚æ•°åç§°</th><th align="left">å‚æ•°è§£é‡Š</th></tr></thead><tbody><tr><td align="left">metric-resolution</td><td align="left">å‘¨æœŸæ€§è°ƒç”¨æ¥å£è·å–metricåŸå§‹æ•°æ®çš„æ—¶é—´é—´éš”ï¼Œé»˜è®¤60s</td></tr><tr><td align="left">kubelet-insecure-tls</td><td align="left">è®¿é—®kubeletæ—¶ä¸å¯¹å…¶è¯ä¹¦è¿›è¡Œcaæ ¡éªŒï¼Œä»…æµ‹è¯•æ—¶ä½¿ç”¨</td></tr><tr><td align="left">kubelet-port</td><td align="left">è°ƒç”¨èŠ‚ç‚¹ä¸Šçš„kubeletè·å–metricçš„ç«¯å£ï¼Œé»˜è®¤10250ç«¯å£</td></tr><tr><td align="left">kubeconfig</td><td align="left">è°ƒç”¨kube-apiserverå’Œkubeletä½¿ç”¨çš„kubeconfigæ–‡ä»¶è·¯å¾„</td></tr><tr><td align="left">kubelet-preferred-address-types</td><td align="left">è°ƒç”¨kubeletä½¿ç”¨çš„ipåœ°å€ä¼˜å…ˆçº§</td></tr><tr><td align="left">kubelet-certificate-authority</td><td align="left">è®¿é—®kubeletä½¿ç”¨çš„caè¯ä¹¦</td></tr><tr><td align="left">deprecated-kubelet-completely-insecure</td><td align="left">ä½¿ç”¨éå®‰å…¨æ–¹å¼è®¿é—®kubeletï¼ˆå³å°†åºŸå¼ƒï¼‰</td></tr></tbody></table><h3 id="4ã€ä»£ç åˆ†æ"><a href="#4ã€ä»£ç åˆ†æ" class="headerlink" title="4ã€ä»£ç åˆ†æ"></a>4ã€ä»£ç åˆ†æ</h3><p>åœ¨å¼€å§‹èµ°è¯»<code>metrics-server</code>çš„ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥æ ¹æ®å…¶åŠŸèƒ½æ¥çŒœæµ‹ä¸€ä¸‹å®ƒçš„ä»£ç é€»è¾‘ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œé€šè¿‡èŠ‚ç‚¹ä¸Šçš„<code>cadvisor</code>æ¥å£è·å–åˆ°çš„æ•°æ®ä¸€èˆ¬æ˜¯è¿™æ ·çš„ï¼ŒåŒ…å«çš„ä¿¡æ¯å¤ªå¤šï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@node1 ~]# curl -k https://172.17.8.101:10250/stats/summary?only_cpu_and_memory=true<br>&#123;<br>  &quot;node&quot;: &#123;<br>    &quot;nodeName&quot;: &quot;node1&quot;,<br>    &quot;systemContainers&quot;: [<br>      &#123;<br>        &quot;name&quot;: &quot;kubelet&quot;,<br>        &quot;startTime&quot;: &quot;2020-05-24T12:54:13Z&quot;,<br>        &quot;cpu&quot;: &#123;<br>          &quot;time&quot;: &quot;2020-05-24T14:12:31Z&quot;,<br>          &quot;usageNanoCores&quot;: 20686133,<br>          &quot;usageCoreNanoSeconds&quot;: 156089526198<br>        &#125;,<br>        &quot;memory&quot;: &#123;<br>          &quot;time&quot;: &quot;2020-05-24T14:12:31Z&quot;,<br>          &quot;usageBytes&quot;: 170590208,<br>          &quot;workingSetBytes&quot;: 122531840,<br>          &quot;rssBytes&quot;: 66949120,<br>          &quot;pageFaults&quot;: 763727,<br>          &quot;majorPageFaults&quot;: 85<br>        &#125;,<br>        &quot;userDefinedMetrics&quot;: null<br>      &#125;,<br>      &#123;<br>        &quot;name&quot;: &quot;runtime&quot;,<br>        &quot;startTime&quot;: &quot;2020-05-24T12:54:13Z&quot;,<br>        &quot;cpu&quot;: &#123;<br>          &quot;time&quot;: &quot;2020-05-24T14:12:31Z&quot;,<br>          &quot;usageNanoCores&quot;: 20686133,<br>          &quot;usageCoreNanoSeconds&quot;: 156089526198<br>        &#125;,<br>        &quot;memory&quot;: &#123;<br>          &quot;time&quot;: &quot;2020-05-24T14:12:31Z&quot;,<br>          &quot;usageBytes&quot;: 170590208,<br>          &quot;workingSetBytes&quot;: 122531840,<br>          &quot;rssBytes&quot;: 66949120,<br>          &quot;pageFaults&quot;: 763727,<br>          &quot;majorPageFaults&quot;: 85<br>        &#125;,<br>        &quot;userDefinedMetrics&quot;: null<br>      &#125;,<br>      &#123;<br>        &quot;name&quot;: &quot;pods&quot;,<br>        &quot;startTime&quot;: &quot;2020-05-24T12:54:13Z&quot;,<br>        &quot;cpu&quot;: &#123;<br>          &quot;time&quot;: &quot;2020-05-24T14:12:39Z&quot;,<br>          &quot;usageNanoCores&quot;: 0,<br>          &quot;usageCoreNanoSeconds&quot;: 42207538504<br>        &#125;,<br>        &quot;memory&quot;: &#123;<br>          &quot;time&quot;: &quot;2020-05-24T14:12:39Z&quot;,<br>          &quot;availableBytes&quot;: 1910824960,<br>          &quot;usageBytes&quot;: 33480704,<br>          &quot;workingSetBytes&quot;: 16498688,<br>          &quot;rssBytes&quot;: 36864,<br>          &quot;pageFaults&quot;: 0,<br>          &quot;majorPageFaults&quot;: 0<br>        &#125;,<br>        &quot;userDefinedMetrics&quot;: null<br>      &#125;<br>    ],<br>    &quot;startTime&quot;: &quot;2020-05-24T12:52:24Z&quot;,<br>    &quot;cpu&quot;: &#123;<br>      &quot;time&quot;: &quot;2020-05-24T14:12:39Z&quot;,<br>      &quot;usageNanoCores&quot;: 888521168,<br>      &quot;usageCoreNanoSeconds&quot;: 776524490477<br>    &#125;,<br>    &quot;memory&quot;: &#123;<br>      &quot;time&quot;: &quot;2020-05-24T14:12:39Z&quot;,<br>      &quot;availableBytes&quot;: 891166720,<br>      &quot;usageBytes&quot;: 1627074560,<br>      &quot;workingSetBytes&quot;: 1036156928,<br>      &quot;rssBytes&quot;: 359944192,<br>      &quot;pageFaults&quot;: 1850284,<br>      &quot;majorPageFaults&quot;: 1987<br>    &#125;<br>  &#125;,<br>  &quot;pods&quot;: [<br>    &#123;<br>      &quot;podRef&quot;: &#123;<br>        &quot;name&quot;: &quot;metrics-server-7668599459-2jxq5&quot;,<br>        &quot;namespace&quot;: &quot;kube-system&quot;,<br>        &quot;uid&quot;: &quot;f5af876f-03de-43e5-902b-79bece68c508&quot;<br>      &#125;,<br>      &quot;startTime&quot;: &quot;2020-05-24T13:27:42Z&quot;,<br>      &quot;containers&quot;: null,<br>      &quot;cpu&quot;: &#123;<br>        &quot;time&quot;: &quot;2020-05-24T14:12:36Z&quot;,<br>        &quot;usageNanoCores&quot;: 0,<br>        &quot;usageCoreNanoSeconds&quot;: 6297886<br>      &#125;,<br>      &quot;memory&quot;: &#123;<br>        &quot;time&quot;: &quot;2020-05-24T14:12:36Z&quot;,<br>        &quot;usageBytes&quot;: 434176,<br>        &quot;workingSetBytes&quot;: 249856,<br>        &quot;rssBytes&quot;: 36864,<br>        &quot;pageFaults&quot;: 0,<br>        &quot;majorPageFaults&quot;: 0<br>      &#125;<br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œæˆ‘ä»¬é€šè¿‡<code>metrics-server</code>è·å¾—çš„æ•°æ®åˆ™æ˜¯è¿™æ ·ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@node1 ~]# curl http://172.17.8.101:8080/apis/metrics.k8s.io/v1beta1/namespaces/kube-system/pods/metrics-server-7668599459-2jxq5<br>&#123;<br>  &quot;kind&quot;: &quot;PodMetrics&quot;,<br>  &quot;apiVersion&quot;: &quot;metrics.k8s.io/v1beta1&quot;,<br>  &quot;metadata&quot;: &#123;<br>    &quot;name&quot;: &quot;metrics-server-7668599459-2jxq5&quot;,<br>    &quot;namespace&quot;: &quot;kube-system&quot;,<br>    &quot;selfLink&quot;: &quot;/apis/metrics.k8s.io/v1beta1/namespaces/kube-system/pods/metrics-server-7668599459-2jxq5&quot;,<br>    &quot;creationTimestamp&quot;: &quot;2020-05-24T13:27:42Z&quot;<br>  &#125;,<br>  &quot;timeStamp&quot;: &quot;2020-05-24T13:27:42Z&quot;,<br>  &quot;window&quot;: &quot;30s&quot;,<br>  &quot;containers&quot;: [<br>    &#123;<br>      &quot;name&quot;: &quot;metrics-server&quot;,<br>      &quot;usage&quot;: &#123;<br>        &quot;cpu&quot;: &quot;0&quot;,<br>        &quot;memory&quot;: &quot;424Ki&quot;<br>      &#125;<br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæœ¬è´¨ä¸Š<code>metrics-server</code>ç›¸å½“äºåšäº†ä¸€æ¬¡æ•°æ®çš„è½¬æ¢ï¼ŒæŠŠ<code>cadvisor</code>æ ¼å¼çš„æ•°æ®è½¬æ¢æˆäº†<code>k8s</code>çš„<code>api</code>çš„<code>json</code>æ ¼å¼ã€‚ç”±æ­¤æˆ‘ä»¬ä¸éš¾çŒœæµ‹ï¼Œ<code>metrics-server</code>çš„ä»£ç ä¸­å¿…ç„¶å­˜åœ¨è¿™ç§å…ˆä»metricä¸­è·å–æ¥å£ä¸­çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå†è§£æå‡ºå…¶ä¸­çš„æ•°æ®çš„è¿‡ç¨‹ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬å¯èƒ½ä¹Ÿä¼šæœ‰ä¸€ä¸ªç–‘æƒ‘ï¼Œé‚£å°±æ˜¯ï¼šæˆ‘ä»¬ç»™<code>metric-server</code>å‘é€è¯·æ±‚æ—¶ï¼Œ<code>metric-server</code>æ˜¯é©¬ä¸Šå‘<code>cadvisor</code>å‘é€è¯·æ±‚ç„¶åè§£æè¯·æ±‚ä¸­çš„æ•°æ®å†è¿”å›å›æ¥ï¼Œè¿˜æ˜¯<code>metrics-server</code>ä¸­å·²ç»å®šæœŸä»ä¸­<code>cadvisor</code>è·å–å¥½æ•°æ®äº†ï¼ˆå¯èƒ½ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼‰ï¼Œå½“è¯·æ±‚å‘è¿‡æ¥æ—¶ç›´æ¥è¿”å›ç¼“å­˜ä¸­çš„æ•°æ®ã€‚æˆ‘ä»¬å¯ä»¥å¸¦ç€è¿™ä¸ªç–‘é—®ç›´æ¥å»çœ‹æºç ã€‚</p><h4 id="4-1ã€å¯åŠ¨ç¨‹åº"><a href="#4-1ã€å¯åŠ¨ç¨‹åº" class="headerlink" title="4.1ã€å¯åŠ¨ç¨‹åº"></a>4.1ã€å¯åŠ¨ç¨‹åº</h4><p><code>metric-server</code>çš„å¯åŠ¨æµç¨‹ä½¿ç”¨çš„ä¹Ÿæ˜¯<code>github.com/spf13/cobra</code>æ¡†æ¶ï¼Œå¯¹è¿™ä¸ªåº“æ„Ÿå…´è¶£çš„å¯ä»¥å»<a href="https://github.com/spf13/cobra"><code>github</code></a>ä¸Šäº†è§£ä¸€ä¸‹ï¼Œè¯¥æ¡†æ¶å®é™…æ‰§è¡Œçš„æ˜¯<code>MetricsServerOptions</code>å®ç°çš„Runå‡½æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// cmd/metrics-server/app/start.go</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(o MetricsServerOptions)</span></span> Run(stopCh &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;) <span class="hljs-type">error</span> &#123;<br><span class="hljs-comment">// 1ã€ç”Ÿæˆmetric-serverè‡ªå·±çš„serverç«¯é…ç½®</span><br>config, err := o.Config()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br>config.GenericConfig.EnableMetrics = <span class="hljs-literal">true</span><br><br><span class="hljs-comment">// 2ã€ç”Ÿæˆmetric-serverè‡ªå·±çš„clientç«¯é…ç½®</span><br>    <span class="hljs-comment">// åŒ…å«å¯¹kube-apiserverçš„clientï¼ˆè·å–é›†ç¾¤nodeä¿¡æ¯ï¼‰å’Œå¯¹cadvisorçš„clientï¼ˆè·å–åŸå§‹ç›‘æ§æ•°æ®ï¼‰</span><br><span class="hljs-keyword">var</span> clientConfig *rest.Config<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(o.Kubeconfig) &gt; <span class="hljs-number">0</span> &#123;<br>loadingRules := &amp;clientcmd.ClientConfigLoadingRules&#123;ExplicitPath: o.Kubeconfig&#125;<br>loader := clientcmd.NewNonInteractiveDeferredLoadingClientConfig(loadingRules, &amp;clientcmd.ConfigOverrides&#123;&#125;)<br>clientConfig, err = loader.ClientConfig()<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>clientConfig, err = rest.InClusterConfig()<br>&#125;<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;unable to construct lister client config: %v&quot;</span>, err)<br>&#125;<br><span class="hljs-comment">// Use protobufs for communication with apiserver</span><br>clientConfig.ContentType = <span class="hljs-string">&quot;application/vnd.kubernetes.protobuf&quot;</span><br><br><span class="hljs-comment">// 2.1ã€é€šè¿‡åˆšæ‰çš„clienté…ç½®å‚æ•°åˆ›å»ºkube-apiserverçš„client</span><br>kubeClient, err := kubernetes.NewForConfig(clientConfig)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;unable to construct lister client: %v&quot;</span>, err)<br>&#125;<br><span class="hljs-comment">// æ ¹æ®clientåˆ›å»ºå¯¹åº”çš„informerï¼Œåˆ°è¿™é‡Œä¸kuber-apiserveré€šä¿¡çš„éƒ¨åˆ†å°±è®¾ç½®å¥½äº†</span><br>informerFactory := informers.NewSharedInformerFactory(kubeClient, <span class="hljs-number">0</span>)<br><br><span class="hljs-comment">// 2.2ã€è¿™é‡Œå¼€å§‹åˆ›å»ºä¸èŠ‚ç‚¹ä¸Šçš„metricæ¥å£ç›¸å…³çš„client</span><br>kubeletRestCfg := rest.CopyConfig(clientConfig)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(o.KubeletCAFile) &gt; <span class="hljs-number">0</span> &#123;<br>kubeletRestCfg.TLSClientConfig.CAFile = o.KubeletCAFile<br>kubeletRestCfg.TLSClientConfig.CAData = <span class="hljs-literal">nil</span><br>&#125;<br>kubeletConfig := summary.GetKubeletConfig(kubeletRestCfg, o.KubeletPort, o.InsecureKubeletTLS, o.DeprecatedCompletelyInsecureKubelet)<br>kubeletClient, err := summary.KubeletClientFor(kubeletConfig)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;unable to construct a client to connect to the kubelets: %v&quot;</span>, err)<br>&#125;<br><br><span class="hljs-comment">// è®¾ç½®è®¿é—®nodeçš„ipçš„ä¼˜å…ˆçº§ï¼ˆnodeä¸­ä¿å­˜æœ‰å„ç§addressï¼ŒåŒ…æ‹¬InternalIPã€ExternalIPç­‰ï¼‰</span><br>addrPriority := <span class="hljs-built_in">make</span>([]corev1.NodeAddressType, <span class="hljs-built_in">len</span>(o.KubeletPreferredAddressTypes))<br><span class="hljs-keyword">for</span> i, addrType := <span class="hljs-keyword">range</span> o.KubeletPreferredAddressTypes &#123;<br>addrPriority[i] = corev1.NodeAddressType(addrType)<br>&#125;<br>addrResolver := summary.NewPriorityNodeAddressResolver(addrPriority)<br>    <span class="hljs-comment">// sourceProvideræ˜¯å°†å‰é¢çš„ä¸¤ä¸ªclientåˆå¹¶åˆ°ä¸€èµ·ä»cadvisoræŠ“å–æ•°æ®</span><br>    <span class="hljs-comment">// informerè´Ÿè´£è·å–é›†ç¾¤ä¸­çš„èŠ‚ç‚¹ç›¸å…³çš„ä¿¡æ¯ï¼ŒkubeletClientåˆ™è°ƒç”¨è¿™äº›èŠ‚ç‚¹ä¸Šçš„cadvisoræ¥å£</span><br>    <span class="hljs-comment">// æ³¨æ„è¿™é‡Œåªä¼ å…¥äº†NodeListerï¼Œä¹Ÿå°±æ˜¯æ˜¯è¯´åªéœ€è¦list nodeç›¸å…³çš„ä¿¡æ¯å°±å¯ä»¥äº†</span><br>sourceProvider := summary.NewSummaryProvider(informerFactory.Core().V1().Nodes().Lister(), kubeletClient, addrResolver)<br>scrapeTimeout := time.Duration(<span class="hljs-type">float64</span>(o.MetricResolution) * <span class="hljs-number">0.90</span>) <span class="hljs-comment">// scrape timeout is 90% of the scrape interval</span><br>    <span class="hljs-comment">// å°†æŠ“å–æ—¶é—´é—´éš”æ”¾åˆ°æœ¬serverçš„metricæ¥å£ä¸­ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªsourceManager</span><br>sources.RegisterDurationMetrics(scrapeTimeout)<br>sourceManager := sources.NewSourceManager(sourceProvider, scrapeTimeout)<br><br><span class="hljs-comment">// 3ã€åˆ›å»ºmetricSinkç”¨æ¥ä¿å­˜è·å–å¹¶è§£æå‡ºæ¥çš„ç›‘æ§æ•°æ®ï¼ˆä»…ä¿å­˜åœ¨å†…å­˜ä¸­ï¼‰</span><br>    <span class="hljs-comment">//    éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„metricSinkå’ŒmetricsProvideræ˜¯åŒä¸€ä¸ªsinkMetricsProviderå®ä¾‹</span><br>metricSink, metricsProvider := sink.NewSinkProvider()<br><br><span class="hljs-comment">// 4ã€åˆ›å»ºä¸€ä¸ªManagerç”¨æ¥å°†å‰é¢çš„sourceProviderå’ŒmetricSinkç®¡ç†èµ·æ¥ï¼Œå‰è€…æŠ“æ•°æ®ï¼Œåè€…å­˜æ•°æ®</span><br>manager.RegisterDurationMetrics(o.MetricResolution)<br>mgr := manager.NewManager(sourceManager, metricSink, o.MetricResolution)<br><br><span class="hljs-comment">// 1.1ã€å°†åˆšæ‰çš„metricSinkä¼ å…¥åˆ°serverçš„é…ç½®ä¸­å»ï¼Œè¿™æ ·http serverç›´æ¥ä»metricSinkä¸­è·å–æ•°æ®ï¼Œç„¶åç›´æ¥è¿”å›ç»™clientå°±å¯ä»¥äº†ï¼Œä¸éœ€è¦å†å»è°ƒç”¨cadvisoræŸ¥metricæ•°æ®</span><br>config.ProviderConfig.Node = metricsProvider<br>config.ProviderConfig.Pod = metricsProvider<br><br><span class="hljs-comment">// 1.2ã€é€šè¿‡configç»™å°†è¦å¯åŠ¨çš„serveråšä¸€äº›åˆå§‹åŒ–çš„åŠ¨ä½œï¼ŒåŒæ—¶ä¹Ÿå°†informerFactoryä¼ è¿›å»</span><br>server, err := config.Complete(informerFactory).New()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-comment">// add health checks</span><br>server.AddHealthzChecks(healthz.NamedCheck(<span class="hljs-string">&quot;healthz&quot;</span>, mgr.CheckHealth))<br><br><span class="hljs-comment">// 5ã€å°†åˆšæ‰çš„managerè¿è¡Œèµ·æ¥ï¼ˆè°ƒç”¨cadvisorçš„æ¥å£è·å–å¹¶è§£ææ•°æ®ï¼Œç„¶åå­˜åˆ°metricSinkä¸­ï¼‰</span><br>mgr.RunUntil(stopCh)<br>    <span class="hljs-comment">// 1.3ã€æ ¹æ®1ä¸­çš„é…ç½®å°†metric-serverå¯åŠ¨èµ·æ¥</span><br><span class="hljs-keyword">return</span> server.GenericAPIServer.PrepareRun().Run(stopCh)<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»è¿™æ®µä»£ç ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œæ•°æ®çš„æŠ“å–å’Œç¼“å­˜ä¸<code>server</code>æ˜¯ä¸¤ä¸ªä¸åŒçš„å¤„ç†æµç¨‹ï¼Œä»–ä»¬ä¹‹é—´é€šè¿‡å…±äº«å†…å­˜æ¥é…åˆï¼Œæ•°æ®å®šæœŸæŠ“å–å®Œä¹‹åç¼“å­˜åˆ°<code>metricSink</code>ï¼ˆå…¶å®ä¹Ÿå°±æ˜¯<code>metricsProvider</code>ï¼‰ä¸­ï¼Œè€Œ<code>server</code>æ”¶åˆ°è¯·æ±‚æ—¶ä»<code>metricSink</code>ä¸­è¯»å–æ•°æ®å¹¶è¿”å›ç»™<code>client</code>ã€‚è¿™ä¸ªè¿‡ç¨‹ä¹Ÿæ­£å¥½å›ç­”äº†æˆ‘ä»¬ä¹‹å‰çš„é—®é¢˜ï¼Œ<code>metrics-server</code>ä¸­å·²ç»å®šæœŸä»ä¸­<code>cadvisor</code>è·å–å¥½æ•°æ®äº†ï¼Œå½“è¯·æ±‚å‘è¿‡æ¥æ—¶ç›´æ¥è¿”å›ç¼“å­˜ä¸­çš„æ•°æ®ã€‚</p><h4 id="4-2ã€æ•°æ®æŠ“å–ä¸ç¼“å­˜"><a href="#4-2ã€æ•°æ®æŠ“å–ä¸ç¼“å­˜" class="headerlink" title="4.2ã€æ•°æ®æŠ“å–ä¸ç¼“å­˜"></a>4.2ã€æ•°æ®æŠ“å–ä¸ç¼“å­˜</h4><p>4.1ç« èŠ‚ä»£ç æ³¨é‡Šä¸­çš„2&#x2F;3&#x2F;4&#x2F;5å°èŠ‚å°±æ˜¯<code>metric-server</code>çš„æ•°æ®æŠ“å–æµç¨‹çš„å¯åŠ¨è¿‡ç¨‹ï¼Œæˆ‘ä»¬æš‚ä¸”ç§°ä¹‹ä¸º<code>manager</code>ï¼Œæˆ‘ä»¬çœ‹åˆ°è¿™å…¶ä¸­ä¸»è¦æ˜¯èµ·äº†ä¸¤ä¸ª<code>client</code>ï¼Œä¸€ä¸ªæ˜¯<code>kube-apiserver</code>çš„<code>client</code>ç”¨æ¥è·å–é›†ç¾¤ä¸­<code>node</code>èµ„æºï¼Œå¦ä¸€ä¸ªclientåˆ™æ˜¯è°ƒç”¨èŠ‚ç‚¹ä¸Š<code>cadvisor</code>çš„æ¥å£è·å–èŠ‚ç‚¹å’Œ<code>pod</code>çš„<code>cpu</code>å’Œ<code>memory</code>ç›‘æ§æ•°æ®ï¼ŒåŒæ—¶ä¹Ÿåˆ›å»ºäº†ä¸€ä¸ª<code>metricSink</code>ç”¨æ¥ä¿å­˜è·å–çš„ç›‘æ§æ•°æ®ã€‚è¯ä¸å¤šè¯´ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ª<code>manager</code>æ˜¯å¦‚ä½•è¿è½¬çš„ã€‚</p><p>æˆ‘ä»¬å°†4.1ç« èŠ‚ä»£ç æ³¨é‡Šä¸­çš„4å’Œ5è¿åœ¨ä¸€èµ·å°±æ˜¯<code>manager</code>çš„å¯åŠ¨è¿‡ç¨‹ï¼Œåˆ›å»ºä¸€ä¸ª<code>manager</code>ç„¶åè¿è¡Œèµ·æ¥ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go">manager.RegisterDurationMetrics(o.MetricResolution)<br>mgr := manager.NewManager(sourceManager, metricSink, o.MetricResolution)<br><br>mgr.RunUntil(stopCh)<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„å¯åŠ¨è¿‡ç¨‹å®é™…å¦‚ä¸‹ï¼Œåˆ›å»ºå¥½çš„<code>manager</code>è¿è¡Œæ˜¯å…¶å®å°±æ˜¯å‘¨æœŸæ€§åœ°æ‰§è¡Œå…¶<code>Collect</code>å‡½æ•°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// pkg/manager/manager.go</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewManager</span><span class="hljs-params">(metricSrc sources.MetricSource, metricSink sink.MetricSink, resolution time.Duration)</span></span> *Manager &#123;<br>manager := Manager&#123;<br>source:     metricSrc, <span class="hljs-comment">// æŠ“å–metricçš„interfaceï¼Œéœ€è¦å®ç°Collect</span><br>sink:       metricSink, <span class="hljs-comment">// ä¿å­˜æŠ“å–æ•°æ®çš„æ¥æ”¶å™¨ï¼Œéœ€è¦å®ç°Receive</span><br>resolution: resolution, <span class="hljs-comment">// æŠ“å–metricçš„æ—¶é—´é—´éš”</span><br>&#125;<br><br><span class="hljs-keyword">return</span> &amp;manager<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rm *Manager)</span></span> RunUntil(stopCh &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;) &#123;<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªå‘¨æœŸæ€§çš„å®šæ—¶å™¨</span><br>ticker := time.NewTicker(rm.resolution)<br><span class="hljs-keyword">defer</span> ticker.Stop()<br>rm.Collect(time.Now())<br><br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br>            <span class="hljs-comment">// å‘¨æœŸæ€§æ‰§è¡ŒCollect</span><br><span class="hljs-keyword">case</span> startTime := &lt;-ticker.C:<br>rm.Collect(startTime) <span class="hljs-comment">// å®é™…å‘¨æœŸæ€§æ‰§è¡Œçš„æ˜¯è¿™é‡Œçš„Collectå‡½æ•°</span><br><span class="hljs-keyword">case</span> &lt;-stopCh:<br><span class="hljs-keyword">return</span><br>&#125;<br>&#125;<br>&#125;()<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥çœ‹<code>Collect</code>å‡½æ•°ä¸­çš„é€»è¾‘å°±å¾ˆç®€ä»‹æ˜äº†äº†ï¼Œä¸»è¦åšäº†ä¸¤ä»¶äº‹ä»¶ï¼š</p><ul><li>è°ƒç”¨sourceManagerå®ç°çš„Collectå‡½æ•°è·å–metricæ•°æ®</li><li>å°†è·å–åˆ°çš„åŸå§‹metricæ•°æ®è§£ææˆpodå’Œnodeçš„æ•°å€¼å¹¶ä¿å­˜metricSinkä¸­å»</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rm *Manager)</span></span> Collect(startTime time.Time) &#123;<br>rm.healthMu.Lock()<br>rm.lastTickStart = startTime<br>rm.healthMu.Unlock()<br><br>healthyTick := <span class="hljs-literal">true</span><br><br>    <span class="hljs-comment">// ç»™å‘requestçš„contextä¸­è®¾ç½®è¶…æ—¶æ—¶é—´ä¸ºmanagerçš„æ£€æŸ¥å‘¨æœŸ</span><br>ctx, cancelTimeout := context.WithTimeout(context.Background(), rm.resolution)<br><span class="hljs-keyword">defer</span> cancelTimeout()<br><br>klog.V(<span class="hljs-number">6</span>).Infof(<span class="hljs-string">&quot;Beginning cycle, collecting metrics...&quot;</span>)<br>    <span class="hljs-comment">// 1ã€æ‰§è¡ŒsourceManagerå®ç°çš„Collectå‡½æ•°è·å–metricæ•°æ®</span><br>data, collectErr := rm.source.Collect(ctx)<br>    <br>    <span class="hljs-comment">// çœç•¥å¼‚å¸¸å¤„ç†çš„é€»è¾‘</span><br><br>klog.V(<span class="hljs-number">6</span>).Infof(<span class="hljs-string">&quot;...Storing metrics...&quot;</span>)<br>    <span class="hljs-comment">// 2ã€å°†è·å–åˆ°çš„åŸå§‹metricæ•°æ®ä¿å­˜åˆ°metricSinkä¸­å»</span><br>recvErr := rm.sink.Receive(data)<br>    <br>    <span class="hljs-comment">// çœç•¥å¼‚å¸¸å¤„ç†çš„é€»è¾‘</span><br><br>    <span class="hljs-comment">// å°†å®é™…çš„collectå¤„ç†æ—¶é—´æ”¾åˆ°è‡ªå·±çš„metricæ¥å£ä¸­</span><br>collectTime := time.Since(startTime)<br>tickDuration.Observe(<span class="hljs-type">float64</span>(collectTime) / <span class="hljs-type">float64</span>(time.Second))<br>klog.V(<span class="hljs-number">6</span>).Infof(<span class="hljs-string">&quot;...Cycle complete&quot;</span>)<br><br>rm.healthMu.Lock()<br>rm.lastOk = healthyTick<br>rm.healthMu.Unlock()<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="4-2-1ã€è·å–metricæ•°æ®ï¼ˆrm-source-Collect-ctx-ï¼‰"><a href="#4-2-1ã€è·å–metricæ•°æ®ï¼ˆrm-source-Collect-ctx-ï¼‰" class="headerlink" title="4.2.1ã€è·å–metricæ•°æ®ï¼ˆrm.source.Collect(ctx)ï¼‰"></a>4.2.1ã€è·å–<code>metric</code>æ•°æ®ï¼ˆ<code>rm.source.Collect(ctx)</code>ï¼‰</h5><p>è·å–<code>metric</code>æ•°æ®æœ¬è´¨ä¸Šå°±æ˜¯è°ƒæ¥å£è·å–ç¬¬4ç« èŠ‚å¼€å¤´è¯´çš„<code>/metric</code>æ ¼å¼çš„æ•°æ®ï¼Œè€Œè¿™ä¸ªæ¥å£æœ¬è´¨ä¸Šå°±æ˜¯k8sé›†ç¾¤ä¸­èŠ‚ç‚¹ä¸Šçš„<code>cadvisor</code>ï¼ˆå®é™…ç”±<code>kubelet</code>æš´éœ²ï¼‰ï¼Œå› æ­¤è¿™éƒ¨åˆ†çš„é€»è¾‘å°±æ˜¯å›´ç»•è¿™ä¸ªæ€è·¯å±•å¼€ã€‚</p><ul><li>é¦–å…ˆéœ€è¦çŸ¥é“è¿™ä¸ªé›†ç¾¤ä¸­æœ‰å“ªäº›èŠ‚ç‚¹ï¼Œå¹¶è·å–è¿™äº›èŠ‚ç‚¹ä¸Šè·å–<code>metric</code>çš„<code>ip</code>å’Œç«¯å£</li><li>åˆ†åˆ«è°ƒç”¨è¿™äº›èŠ‚ç‚¹ä¸Šçš„<code>metric</code>æ¥å£å¹¶è§£æå…¶ä¸­<code>node</code>å’Œ<code>pod</code>çš„<code>cpu</code>å’Œ<code>memory</code>æ•°å€¼</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// pkg/sources/manager.go</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *sourceManager)</span></span> Collect(baseCtx context.Context) (*MetricsBatch, <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-comment">// 1ã€è·å–éœ€è¦æŠ“å–æ•°æ®çš„æ‰€æœ‰æºå¤´ï¼Œå³é›†ç¾¤ä¸­èŠ‚ç‚¹ä¸Šçš„cadvisoræ¥å£</span><br>sources, err := m.srcProv.GetMetricSources()<br><span class="hljs-keyword">var</span> errs []<span class="hljs-type">error</span><br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>errs = <span class="hljs-built_in">append</span>(errs, err)<br>&#125;<br>klog.V(<span class="hljs-number">1</span>).Infof(<span class="hljs-string">&quot;Scraping metrics from %v sources&quot;</span>, <span class="hljs-built_in">len</span>(sources))<br>    <span class="hljs-comment">// åˆ›å»ºæ¥å—æ•°æ®å’Œé”™è¯¯çš„channel</span><br>responseChannel := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *MetricsBatch, <span class="hljs-built_in">len</span>(sources))<br>errChannel := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">error</span>, <span class="hljs-built_in">len</span>(sources))<br><span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(responseChannel)<br><span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(errChannel)<br>startTime := time.Now()<br>delayMs := delayPerSourceMs * <span class="hljs-built_in">len</span>(sources)<br><span class="hljs-keyword">if</span> delayMs &gt; maxDelayMs &#123;<br>delayMs = maxDelayMs<br>&#125;<br><span class="hljs-keyword">for</span> _, source := <span class="hljs-keyword">range</span> sources &#123;<br>        <span class="hljs-comment">// 2ã€åˆ†åˆ«èµ·ä¸€ä¸ªåç¨‹å»è°ƒæ¯ä¸ªsourceçš„æ¥å£æŠ“å–æ•°æ®ï¼Œå¹¶å†™å…¥åˆ°channelä¸­</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(source MetricSource)</span></span> &#123;<br>            <span class="hljs-comment">// æ¯ä¸ªåç¨‹ä¸­éšæœºsleepä¸€æ®µæ—¶é—´ï¼Œé˜²æ­¢å‡ ä¸ªåç¨‹åŒæ—¶å‘è¯·æ±‚é€ æˆç½‘ç»œæ‹¥å¡</span><br>sleepDuration := time.Duration(rand.Intn(delayMs)) * time.Millisecond<br>time.Sleep(sleepDuration)<br><span class="hljs-comment">// è¶…æ—¶æ—¶é—´å‡å»åˆšæ‰sleepçš„æ—¶é—´</span><br>ctx, cancelTimeout := context.WithTimeout(baseCtx, m.scrapeTimeout-sleepDuration)<br><span class="hljs-keyword">defer</span> cancelTimeout()<br>klog.V(<span class="hljs-number">2</span>).Infof(<span class="hljs-string">&quot;Querying source: %s&quot;</span>, source)<br>            <span class="hljs-comment">// æŠ“å–æ•°æ®</span><br>metrics, err := scrapeWithMetrics(ctx, source)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>err = fmt.Errorf(<span class="hljs-string">&quot;unable to fully scrape metrics from source %s: %v&quot;</span>, source.Name(), err)<br>&#125;<br>responseChannel &lt;- metrics<br>errChannel &lt;- err<br>&#125;(source)<br>&#125;<br>res := &amp;MetricsBatch&#123;&#125;<br><span class="hljs-keyword">for</span> <span class="hljs-keyword">range</span> sources &#123;<br>        <span class="hljs-comment">// å°†æŠ“å–çš„æ•°æ®åˆ†æˆnodeå’Œpodçš„ä¿å­˜ä¸‹æ¥å¹¶è¿”å›</span><br>err := &lt;-errChannel<br>srcBatch := &lt;-responseChannel<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>errs = <span class="hljs-built_in">append</span>(errs, err)<br>&#125;<br><span class="hljs-keyword">if</span> srcBatch == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><br>res.Nodes = <span class="hljs-built_in">append</span>(res.Nodes, srcBatch.Nodes...)<br>res.Pods = <span class="hljs-built_in">append</span>(res.Pods, srcBatch.Pods...)<br>&#125;<br><br>klog.V(<span class="hljs-number">1</span>).Infof(<span class="hljs-string">&quot;ScrapeMetrics: time: %s, nodes: %v, pods: %v&quot;</span>, time.Since(startTime), <span class="hljs-built_in">len</span>(res.Nodes), <span class="hljs-built_in">len</span>(res.Pods))<br><span class="hljs-keyword">return</span> res, utilerrors.NewAggregate(errs)<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä¸Šè¿°ä¸¤ä¸ªå…³é”®ç‚¹çš„ç»†èŠ‚éƒ½å°è£…èµ·æ¥äº†ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªæ¥çœ‹ï¼š</p><ol><li><h6 id="è·å–æºå¤´m-srcProv-GetMetricSources"><a href="#è·å–æºå¤´m-srcProv-GetMetricSources" class="headerlink" title="è·å–æºå¤´m.srcProv.GetMetricSources()"></a>è·å–æºå¤´<code>m.srcProv.GetMetricSources()</code></h6><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// pkg/sources/summary/summary.go</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *summaryProvider)</span></span> GetMetricSources() ([]sources.MetricSource, <span class="hljs-type">error</span>) &#123;<br>sources := []sources.MetricSource&#123;&#125;<br>    <span class="hljs-comment">// è°ƒç”¨k8sæ¥å£Listæ‰€æœ‰èŠ‚ç‚¹çš„ä¿¡æ¯</span><br>nodes, err := p.nodeLister.List(labels.Everything())<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;unable to list nodes: %v&quot;</span>, err)<br>&#125;<br><br><span class="hljs-keyword">var</span> errs []<span class="hljs-type">error</span><br><span class="hljs-keyword">for</span> _, node := <span class="hljs-keyword">range</span> nodes &#123;<br>        <span class="hljs-comment">// ä»èŠ‚ç‚¹çš„ç»“æ„ä½“ä¸­è·å–è¿™ä¸ªèŠ‚ç‚¹çš„IPå’Œnameï¼Œå¹¶å’ŒkubeletClientä¸€èµ·ç»„è£…åˆ°sourceä¸­å»</span><br>        <span class="hljs-comment">// æ³¨æ„èŠ‚ç‚¹çš„IPæ—¶æ ¹æ®å¯åŠ¨å‚æ•°kubelet-preferred-address-typesä¼˜å…ˆçº§æ¥è·å–çš„</span><br>info, err := p.getNodeInfo(node)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>errs = <span class="hljs-built_in">append</span>(errs, fmt.Errorf(<span class="hljs-string">&quot;unable to extract connection information for node %q: %v&quot;</span>, node.Name, err))<br><span class="hljs-keyword">continue</span><br>&#125;<br>        <span class="hljs-comment">// æ³¨æ„æ‰€æœ‰sourceçš„kubeletClientæ˜¯å…±ç”¨çš„ï¼Œç«¯å£éƒ½æ˜¯ä¸€æ ·ï¼ŒåŒºåˆ«æ˜¯IPä¸åŒ</span><br>sources = <span class="hljs-built_in">append</span>(sources, NewSummaryMetricsSource(info, p.kubeletClient))<br>&#125;<br><span class="hljs-keyword">return</span> sources, utilerrors.NewAggregate(errs)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewSummaryMetricsSource</span><span class="hljs-params">(node NodeInfo, client KubeletInterface)</span></span> sources.MetricSource &#123;<br><span class="hljs-keyword">return</span> &amp;summaryMetricsSource&#123;<br>node:          node,<br>kubeletClient: client,<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><h6 id="æŠ“å–æ•°æ®å¹¶è§£ææ•°æ®scrapeWithMetrics-ctx-source"><a href="#æŠ“å–æ•°æ®å¹¶è§£ææ•°æ®scrapeWithMetrics-ctx-source" class="headerlink" title="æŠ“å–æ•°æ®å¹¶è§£ææ•°æ®scrapeWithMetrics(ctx, source)"></a>æŠ“å–æ•°æ®å¹¶è§£ææ•°æ®<code>scrapeWithMetrics(ctx, source)</code></h6></li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// pkg/sources/manager.go</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">scrapeWithMetrics</span><span class="hljs-params">(ctx context.Context, s MetricSource)</span></span> (*MetricsBatch, <span class="hljs-type">error</span>) &#123;<br>sourceName := s.Name()<br>startTime := time.Now()<br><span class="hljs-keyword">defer</span> lastScrapeTimestamp.<br>WithLabelValues(sourceName).<br>Set(<span class="hljs-type">float64</span>(time.Now().Unix()))<br><span class="hljs-keyword">defer</span> scraperDuration.<br>WithLabelValues(sourceName).<br>Observe(<span class="hljs-type">float64</span>(time.Since(startTime)) / <span class="hljs-type">float64</span>(time.Second))<br>    <span class="hljs-comment">// å®é™…è°ƒç”¨MetricSourceçš„Collectæ¥å£</span><br><span class="hljs-keyword">return</span> s.Collect(ctx)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>s.Collect(ctx)</code>å®é™…ä¸Šå°±æ˜¯æ­¥éª¤1ä¸­<code>NewSummaryMetricsSource</code>åˆ›å»ºå‡ºæ¥çš„<code>MetricSource</code>çš„<code>Collect</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// pkg/sources/summary/summary.go</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(src *summaryMetricsSource)</span></span> Collect(ctx context.Context) (*sources.MetricsBatch, <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-comment">// å…³é”®é€»è¾‘ï¼Œé€šè¿‡å½“å‰sourceçš„kubeletClientè·å–èŠ‚ç‚¹ä¸Šçš„metricæ•°æ®ï¼Œå¹¶è§£æåˆ°summaryä¸­</span><br>    <span class="hljs-comment">// è¿™é‡Œä¹‹æ‰€ä»¥æŠŠè¿™æ®µé€»è¾‘åç¨‹é—­åŒ…æ˜¯ä¸ºäº†åœ¨GetSummaryæ‰§è¡Œå®Œä¹‹åå°±é©¬ä¸Šæ‰§è¡Œdeferä¸­çš„é€»è¾‘</span><br>summary, err := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> (*stats.Summary, <span class="hljs-type">error</span>) &#123;<br>startTime := time.Now()<br><span class="hljs-keyword">defer</span> summaryRequestLatency.WithLabelValues(src.node.Name).Observe(<span class="hljs-type">float64</span>(time.Since(startTime)) / <span class="hljs-type">float64</span>(time.Second))  <span class="hljs-comment">// é©¬ä¸Šå°†æ‰§è¡Œæ—¶é—´å†™å…¥è‡ªå·±çš„metricä¸­</span><br><span class="hljs-keyword">return</span> src.kubeletClient.GetSummary(ctx, src.node.ConnectAddress)<br>&#125;()<br>    <span class="hljs-comment">// éƒ¨åˆ†çœç•¥</span><br>res := &amp;sources.MetricsBatch&#123;<br>Nodes: <span class="hljs-built_in">make</span>([]sources.NodeMetricsPoint, <span class="hljs-number">1</span>),<br>Pods:  <span class="hljs-built_in">make</span>([]sources.PodMetricsPoint, <span class="hljs-built_in">len</span>(summary.Pods)),<br>&#125;<br>    <br>    <span class="hljs-comment">// çœç•¥éƒ¨åˆ†è§£æsummaryä¸­nodeå’Œpodæ•°æ®çš„é€»è¾‘</span><br><br><span class="hljs-keyword">return</span> res, utilerrors.NewAggregate(errs)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>Collect</code>çš„é€»è¾‘æœ¬è´¨ä¸Šæ˜¯æ‰§è¡Œäº†<code>GetSummary</code>ï¼Œè¿™é‡Œèµ·äº†ä¸€ä¸ª<code>http client</code>ï¼Œç„¶åç»™<code>https://&#123;node ip&#125;:&#123;port&#125;/stats/summary?only_cpu_and_memory=true</code>å‘äº†ä¸€ä¸ª<code>GET</code>è¯·æ±‚å¹¶è·å–äº†è¿”å›çš„<code>body</code>ä½“ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// pkg/sources/summary/client.go</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(kc *kubeletClient)</span></span> GetSummary(ctx context.Context, host <span class="hljs-type">string</span>) (*stats.Summary, <span class="hljs-type">error</span>) &#123;<br>scheme := <span class="hljs-string">&quot;https&quot;</span><br><span class="hljs-keyword">if</span> kc.deprecatedNoTLS &#123;<br>scheme = <span class="hljs-string">&quot;http&quot;</span><br>&#125;<br>url := url.URL&#123;<br>Scheme:   scheme,<br>Host:     net.JoinHostPort(host, strconv.Itoa(kc.port)),<br>Path:     <span class="hljs-string">&quot;/stats/summary&quot;</span>,<br>RawQuery: <span class="hljs-string">&quot;only_cpu_and_memory=true&quot;</span>,<br>&#125;<br><br>req, err := http.NewRequest(<span class="hljs-string">&quot;GET&quot;</span>, url.String(), <span class="hljs-literal">nil</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br>summary := &amp;stats.Summary&#123;&#125;<br>client := kc.client<br><span class="hljs-keyword">if</span> client == <span class="hljs-literal">nil</span> &#123;<br>client = http.DefaultClient<br>&#125;<br>    <span class="hljs-comment">// æ‰§è¡Œreqå¹¶å°†responseä¸­çš„bodyä½“ä¿å­˜åˆ°summaryä¸­</span><br>err = kc.makeRequestAndGetValue(client, req.WithContext(ctx), summary)<br><span class="hljs-keyword">return</span> summary, err<br>&#125;<br></code></pre></td></tr></table></figure><ol><li><h6 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h6></li></ol><p>é€šè¿‡4.2.1ä¸­çš„ä»£ç åˆ†ææˆ‘ä»¬å°è¯ä¹‹å‰çš„è¿‡ç¨‹ï¼Œè·å–<code>metric</code>æ•°æ®æœ¬è´¨ä¸Šå°±æ˜¯è°ƒç”¨<code>cadvisor</code>çš„æ¥å£æ¥è·å–æ•°æ®è€Œå·²ã€‚è¿™é‡Œæˆ‘ä»¬æœ‰å¿…è¦æ¥çœ‹ä¸€ä¸‹ä¹‹å‰æˆ‘ä»¬å¿½ç•¥æ‰çš„å…³é”®æ•°æ®ç»“æ„<code>MetricsBatch</code>ï¼Œè¿™æ˜¯æœ€ç»ˆè§£æå‡ºæ¥çš„åŒ…å«äº†<code>node</code>å’Œ<code>pod</code>çš„<code>cpu</code>å’Œ<code>memory</code>ä¿¡æ¯çš„å¯¹è±¡ï¼Œä¹Ÿæ˜¯ä¼ é€’ç»™<code>metricSink</code>çš„æ•°æ®ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// pkg/sources/interfaces.go</span><br><span class="hljs-comment">// MetricsBatchæ˜¯æ‰€æœ‰nodeå’Œæ‰€æœ‰podçš„metricæ•°æ®</span><br><span class="hljs-keyword">type</span> MetricsBatch <span class="hljs-keyword">struct</span> &#123;<br>Nodes []NodeMetricsPoint<br>Pods  []PodMetricsPoint<br>&#125;<br><span class="hljs-comment">// NodeMetricsPointåŒ…å«è¿™ä¸ªèŠ‚ç‚¹çš„metricæ•°æ®</span><br><span class="hljs-keyword">type</span> NodeMetricsPoint <span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-type">string</span><br>MetricsPoint<br>&#125;<br><span class="hljs-comment">// PodMetricsPointåŒ…å«äº†è¿™ä¸ªpodæ‰€æœ‰å®¹å™¨çš„metricæ•°æ®</span><br><span class="hljs-keyword">type</span> PodMetricsPoint <span class="hljs-keyword">struct</span> &#123;<br>Name      <span class="hljs-type">string</span><br>Namespace <span class="hljs-type">string</span><br>Containers []ContainerMetricsPoint<br>&#125;<br><span class="hljs-comment">// ContainerMetricsPointåŒ…å«è¿™ä¸ªå®¹å™¨çš„metricæ•°æ®</span><br><span class="hljs-keyword">type</span> ContainerMetricsPoint <span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-type">string</span><br>MetricsPoint<br>&#125;<br><span class="hljs-comment">// MetricsPointæ˜¯nodeå’Œå®¹å™¨metricæ•°æ®çš„åŸºæœ¬å•ä½ï¼Œå…¶ä¸­åŒ…å«äº†cpuå’Œmemoryåº¦é‡</span><br><span class="hljs-keyword">type</span> MetricsPoint <span class="hljs-keyword">struct</span> &#123;<br>Timestamp time.Time<br><span class="hljs-comment">// CpuUsage is the CPU usage rate, in cores</span><br>CpuUsage resource.Quantity<br><span class="hljs-comment">// MemoryUsage is the working set size, in bytes.</span><br>MemoryUsage resource.Quantity<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="4-2-2ã€ä¿å­˜metricæ•°æ®ï¼ˆrm-sink-Receive-data-ï¼‰"><a href="#4-2-2ã€ä¿å­˜metricæ•°æ®ï¼ˆrm-sink-Receive-data-ï¼‰" class="headerlink" title="4.2.2ã€ä¿å­˜metricæ•°æ®ï¼ˆrm.sink.Receive(data)ï¼‰"></a>4.2.2ã€ä¿å­˜<code>metric</code>æ•°æ®ï¼ˆ<code>rm.sink.Receive(data)</code>ï¼‰</h5><p>4.2.1ä¸­å·²ç»è°ƒç”¨é›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹çš„<code>cadvisor</code>æ¥å£å¹¶è·å–äº†æ‰€æœ‰èŠ‚ç‚¹å’Œ<code>pod</code>çš„<code>metric</code>æ•°æ®ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ä¿å­˜åˆ°ç¼“å­˜ä¸­äº†ã€‚å‰é¢å·²ç»å°†è·å–åˆ°çš„æ•°æ®å­˜åœ¨äº†<code>data</code>ï¼ˆæœ¬è´¨ä¸Šå°±æ˜¯4.2.1æ€»ç»“æ—¶è¯´åˆ°çš„<code>MetricsBatch</code>ï¼‰å˜é‡ä¸­ï¼Œæ¥ä¸‹æ¥å°±æ—¶å¯¹è¿™ä¸ªå˜é‡è¿›è¡Œå¤„ç†äº†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// pkg/provider/sink/sinkprov.go</span><br><span class="hljs-comment">// sinkMetricsProvideræ—¢å®ç°äº†provider.MetricsProviderï¼ˆæä¾›serveræ—¶ä½¿ç”¨ï¼‰ä¹Ÿå®ç°äº†sink.MetricSinkï¼ˆæŠ“å–åç¼“å­˜æ•°æ®ç”¨ï¼‰</span><br><span class="hljs-comment">// sinkMetricsProvideræœ¬è´¨ä¸Šå°±æ˜¯ä¸¤ä¸ªmapï¼Œä¸€ä¸ªä¿å­˜nodeï¼Œä¸€ä¸ªä¿å­˜pod</span><br><span class="hljs-keyword">type</span> sinkMetricsProvider <span class="hljs-keyword">struct</span> &#123;<br>mu    sync.RWMutex<br>nodes <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]sources.NodeMetricsPoint<br>pods  <span class="hljs-keyword">map</span>[apitypes.NamespacedName]sources.PodMetricsPoint<br>&#125;<br><span class="hljs-comment">// metric-serveræ”¶åˆ°nodeçš„GETè¯·æ±‚è°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥è·å–metricæ•°æ®</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *sinkMetricsProvider)</span></span> GetNodeMetrics(nodes ...<span class="hljs-type">string</span>) ([]provider.TimeInfo, []corev1.ResourceList, <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-comment">// ä»£ç é€»è¾‘ç•¥</span><br>&#125;<br><span class="hljs-comment">// metric-serveræ”¶åˆ°podçš„GETè¯·æ±‚è°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥è·å–metricæ•°æ®</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *sinkMetricsProvider)</span></span> GetContainerMetrics(pods ...apitypes.NamespacedName) ([]provider.TimeInfo, [][]metrics.ContainerMetrics, <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-comment">// ä»£ç é€»è¾‘ç•¥ï¼Œ4.3èŠ‚çš„metric-serverå†è®²</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *sinkMetricsProvider)</span></span> Receive(batch *sources.MetricsBatch) <span class="hljs-type">error</span> &#123;<br>    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„nodeçš„mapï¼Œå¹¶å°†æ•°æ®å»é‡å†™å…¥</span><br>newNodes := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]sources.NodeMetricsPoint, <span class="hljs-built_in">len</span>(batch.Nodes))<br><span class="hljs-keyword">for</span> _, nodePoint := <span class="hljs-keyword">range</span> batch.Nodes &#123;<br><span class="hljs-keyword">if</span> _, exists := newNodes[nodePoint.Name]; exists &#123;<br>klog.Errorf(<span class="hljs-string">&quot;duplicate node %s received&quot;</span>, nodePoint.Name)<br><span class="hljs-keyword">continue</span><br>&#125;<br>newNodes[nodePoint.Name] = nodePoint<br>&#125;<br>    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„podçš„mapï¼Œå¹¶å°†æ•°æ®å»é‡å†™å…¥</span><br>newPods := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[apitypes.NamespacedName]sources.PodMetricsPoint, <span class="hljs-built_in">len</span>(batch.Pods))<br><span class="hljs-keyword">for</span> _, podPoint := <span class="hljs-keyword">range</span> batch.Pods &#123;<br>podIdent := apitypes.NamespacedName&#123;Name: podPoint.Name, Namespace: podPoint.Namespace&#125;<br><span class="hljs-keyword">if</span> _, exists := newPods[podIdent]; exists &#123;<br>klog.Errorf(<span class="hljs-string">&quot;duplicate pod %s received&quot;</span>, podIdent)<br><span class="hljs-keyword">continue</span><br>&#125;<br>newPods[podIdent] = podPoint<br>&#125;<br><br>p.mu.Lock()<br><span class="hljs-keyword">defer</span> p.mu.Unlock()<br>    <span class="hljs-comment">// å°†åˆšåˆ›å»ºçš„æ–°mapèµ‹å€¼ç»™providerï¼Œæ³¨æ„ä¹‹å‰çš„æ—§mapå°±ç›´æ¥å›æ”¶äº†</span><br>p.nodes = newNodes<br>p.pods = newPods<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>sinkMetricsProvider</code>æ•°æ®çš„ç»“æ„ä½“æœ¬è´¨ä¸Šå°±æ˜¯ä¸¤ä¸ª<code>map</code>è€Œå·²ï¼Œè€Œä¿å­˜çš„é€»è¾‘ä¹Ÿéå¸¸ç®€å•ï¼Œç›´æ¥åˆ›å»ºä¸¤ä¸ªæ–°mapå¹¶èµ‹å€¼è¿‡å»å°±å¯ä»¥ï¼Œå¹¶ä¸éœ€è¦å¤„ç†ä¹‹å‰çš„æ—§æ•°æ®ï¼Œç®€å•ç²—æš´ã€‚</p><h4 id="4-3ã€metric-server"><a href="#4-3ã€metric-server" class="headerlink" title="4.3ã€metric-server"></a>4.3ã€<code>metric-server</code></h4><p>åœ¨4.1èŠ‚çš„å¯åŠ¨ç¨‹åºä¸­å·²ç»è¯´æ˜äº†<code>metric-server</code>çš„å¯åŠ¨è¿‡ç¨‹ï¼Œç»è¿‡4.2.2çš„ä»£ç åˆ†æä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥çŒœæµ‹<code>metric-server</code>æœ¬è´¨ä¸Šå°±æ˜¯æ”¶åˆ°è¯·æ±‚ä¹‹ååˆ°<code>sinkMetricsProvider</code>çš„ä¸¤ä¸ª<code>map</code>ä¸­è¯»å–æ•°æ®å¹¶è¿”å›è€Œå·²ã€‚</p><p>æˆ‘ä»¬å›åˆ°å¯åŠ¨ç¨‹åºä¸­ï¼Œè¿™é‡ŒåŒ…å«äº†ä¸¤ä¸ªæ­¥éª¤ï¼Œä¸€ä¸ªæ˜¯åˆ›å»ºå¥½ä¸€ä¸ª<code>server</code>ï¼ˆæœ¬è´¨ä¸Šæ˜¯<code>k8s.io/apiserver</code>åº“çš„ä¸€ä¸ª<code>GenericAPIServer</code>ï¼‰ï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯ç›´æ¥å°†è¿™ä¸ª<code>server</code>è¿è¡Œèµ·æ¥ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å…³é”®é€»è¾‘ï¼šé€šè¿‡é…ç½®æ–‡ä»¶åˆ›å»ºå¥½å¯¹åº”çš„GenericAPIServer</span><br>server, err := config.Complete(informerFactory).New()<br><span class="hljs-comment">// å°†GenericAPIServerè¿è¡Œèµ·æ¥</span><br><span class="hljs-keyword">return</span> server.GenericAPIServer.PrepareRun().Run(stopCh)<br></code></pre></td></tr></table></figure><p>ç”±äº<code>k8s.io/apiserver</code>åº“çš„åŸç†æ¯”è¾ƒå¤æ‚ï¼Œæš‚ä¸”ä¸è¡¨ï¼Œæˆ‘ä»¬åªè®²åˆ›å»º<code>GenericAPIServer</code>çš„åˆ›å»ºæµç¨‹å¹¶è¯´æ˜<code>server</code>æ˜¯å¦‚ä½•ä½¿ç”¨çš„ã€‚å¯¹äº<code>metric-server</code>è€Œè¨€ï¼Œéœ€è¦å…ˆåˆ›å»ºä¸€ä¸ª<code>GenericAPIServer</code>ï¼Œç„¶åå°†<code>metric-server</code>è‡ªå·±çš„<code>API</code>ä¸å¯¹åº”çš„å¤„ç†<code>handler</code>æ³¨å†Œè¿›æ¥å³å¯ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// pkg/apiserver/config.go</span><br><span class="hljs-keyword">type</span> MetricsServer <span class="hljs-keyword">struct</span> &#123;<br>*genericapiserver.GenericAPIServer<br>&#125;<br><span class="hljs-comment">// New returns a new instance of MetricsServer from the given config.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c completedConfig)</span></span> New() (*MetricsServer, <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªåä¸º&quot;metrics-server&quot;çš„genericServer</span><br>genericServer, err := c.CompletedConfig.New(<span class="hljs-string">&quot;metrics-server&quot;</span>, genericapiserver.NewEmptyDelegate()) <span class="hljs-comment">// completion is done in Complete, no need for a second time</span><br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br>    <span class="hljs-comment">// å…³é”®é€»è¾‘ï¼šå°†metric-serverçš„å¤„ç†å®ä½“æ³¨å†Œåˆ°genericServerä¸­ï¼Œä¸‹æ–‡ç»§ç»­è®²è§£</span><br><span class="hljs-keyword">if</span> err := generic.InstallStorage(c.ProviderConfig, c.SharedInformerFactory.Core().V1(), genericServer); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><br><span class="hljs-keyword">return</span> &amp;MetricsServer&#123;<br>GenericAPIServer: genericServer,<br>&#125;, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨æ³¨å†Œ<code>metric-server</code>è‡ªå·±çš„<code>API</code>æ—¶ï¼Œéœ€è¦å…ˆåˆ›å»ºä¸€ä¸ª<code>APIGroup</code>ï¼ˆå³<code>metrics.k8s.io</code>ï¼‰ï¼Œç„¶åå°†è¿™ä¸ª<code>Group</code>ä¸‹é¢çš„å„ä¸ªèµ„æºï¼ˆä¾‹å¦‚è¿™é‡Œçš„<code>&quot;nodes&quot;</code>å’Œ<code>&quot;pods&quot;</code>ï¼‰çš„<code>Storage</code>æ³¨å†Œåˆ°<code>VersionedResourcesStorageMap</code>ä¸­ï¼Œè¿™é‡Œé¢æœ€å…³é”®çš„å°±æ˜¯æ¯ä¸ªèµ„æºçš„<code>Storage</code>éœ€è¦å®ç°å¤„ç†è¯·æ±‚çš„restæ¥å£ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// pkg/apiserver/generic/storage.go</span><br><span class="hljs-comment">// InstallStorageæ„é€ ä¸€ä¸ªmetrics.k8s.ioçš„apiGroupå¹¶æ³¨å†Œåˆ°genericServerä¸­</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InstallStorage</span><span class="hljs-params">(providers *ProviderConfig, informers coreinf.Interface, server *genericapiserver.GenericAPIServer)</span></span> <span class="hljs-type">error</span> &#123;<br>    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªAPIGroup</span><br>info := BuildStorage(providers, informers)<br>    <span class="hljs-comment">// å°†è¿™ä¸ªAPIGroupæ³¨å†Œåˆ°GenericAPIServerä¸­</span><br><span class="hljs-keyword">return</span> server.InstallAPIGroup(&amp;info)<br>&#125;<br><br><span class="hljs-comment">// BuildStorageæ„é€ ä¸€ä¸ªåä¸º&quot;metrics.k8s.io&quot;çš„apiGroup</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BuildStorage</span><span class="hljs-params">(providers *ProviderConfig, informers coreinf.Interface)</span></span> genericapiserver.APIGroupInfo &#123;<br>    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªåä¸º&quot;metrics.k8s.io&quot;çš„apiGroup</span><br>apiGroupInfo := genericapiserver.NewDefaultAPIGroupInfo(metrics.GroupName, Scheme, metav1.ParameterCodec, Codecs)<br>    <span class="hljs-comment">// åˆ›å»ºnodeçš„storageï¼Œè¿™ä¸ªstorageè·Ÿpodçš„ç±»ä¼¼ï¼Œä¸‹æ–‡ä»¥podä¸ºä¾‹</span><br>nodemetricsStorage := nodemetricsstorage.NewStorage(metrics.Resource(<span class="hljs-string">&quot;nodemetrics&quot;</span>), providers.Node, informers.Nodes().Lister())<br>    <span class="hljs-comment">// åˆ›å»ºpodçš„storageï¼Œè¿™ä¸ªstorageä¸­å®ç°äº†æ”¶åˆ°è¯·æ±‚ä¹‹åçš„å¤„ç†é€»è¾‘ï¼Œä¸‹æ–‡ç»§ç»­è®²è§£</span><br>podmetricsStorage := podmetricsstorage.NewStorage(metrics.Resource(<span class="hljs-string">&quot;podmetrics&quot;</span>), providers.Pod, informers.Pods().Lister())<br>    <span class="hljs-comment">// å°†nodeå’Œpodçš„Storageå­˜æ”¾åˆ°mapä¸­</span><br>metricsServerResources := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]rest.Storage&#123;<br><span class="hljs-string">&quot;nodes&quot;</span>: nodemetricsStorage,<br><span class="hljs-string">&quot;pods&quot;</span>:  podmetricsStorage,<br>&#125;<br>    <span class="hljs-comment">// åœ¨&quot;metrics.k8s.io&quot;è¿™ä¸ªapiGroupä¸­æ³¨å†Œ&quot;v1beta1&quot;è¿™ä¸ªversionçš„Storageå¤„ç†map</span><br>apiGroupInfo.VersionedResourcesStorageMap[v1beta1.SchemeGroupVersion.Version] = metricsServerResources<br><span class="hljs-keyword">return</span> apiGroupInfo<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä»¥<code>pod</code>çš„<code>MetricStorage</code>çš„<code>Getter</code>æ¥å£ä¸ºä¾‹ï¼Œè¿™é‡Œå®ç°çš„<code>Get</code>å‡½æ•°å°±æ˜¯å½“<code>metric-server</code>æ”¶åˆ°è·å–æŸä¸ª<code>pod</code>çš„<code>metric</code>çš„è¯·æ±‚æ—¶å¤„ç†è¯¥è¯·æ±‚çš„Handlerã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// pkg/storage/podmetrics/reststorage.go</span><br><span class="hljs-keyword">type</span> MetricStorage <span class="hljs-keyword">struct</span> &#123;<br>groupResource schema.GroupResource<br>prov          provider.PodMetricsProvider<br>podLister     v1listers.PodLister<br>&#125;<br><span class="hljs-comment">// ç”¨æ¥æ£€æŸ¥MetricStorageå·²ç»å®ç°äº†restçš„è¿™4ä¸ªæ¥å£</span><br><span class="hljs-keyword">var</span> _ rest.KindProvider = &amp;MetricStorage&#123;&#125;<br><span class="hljs-keyword">var</span> _ rest.Storage = &amp;MetricStorage&#123;&#125;<br><span class="hljs-keyword">var</span> _ rest.Getter = &amp;MetricStorage&#123;&#125;<br><span class="hljs-keyword">var</span> _ rest.Lister = &amp;MetricStorage&#123;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewStorage</span><span class="hljs-params">(groupResource schema.GroupResource, prov provider.PodMetricsProvider, podLister v1listers.PodLister)</span></span> *MetricStorage &#123;<br><span class="hljs-keyword">return</span> &amp;MetricStorage&#123;<br>groupResource: groupResource,<br>prov:          prov,<br>podLister:     podLister,<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// å®ç°rest.Getteræ¥å£</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *MetricStorage)</span></span> Get(ctx context.Context, name <span class="hljs-type">string</span>, opts *metav1.GetOptions) (runtime.Object, <span class="hljs-type">error</span>) &#123;<br>namespace := genericapirequest.NamespaceValue(ctx)<br>    <span class="hljs-comment">// ä»k8sçš„clientç¼“å­˜ä¸­è·å–podä¿¡æ¯</span><br>pod, err := m.podLister.Pods(namespace).Get(name)<br>    <br>    <span class="hljs-comment">// çœç•¥å¼‚å¸¸å¤„ç†çš„é€»è¾‘</span><br>    <br>    <span class="hljs-comment">// ä»ä¹‹å‰çš„sinkMetricç¼“å­˜ä¸­è·å–è¿™ä¸ªpodçš„</span><br>podMetrics, err := m.getPodMetrics(pod)<br>    <br>    <span class="hljs-comment">// çœç•¥å¼‚å¸¸å¤„ç†çš„é€»è¾‘</span><br>    <br><span class="hljs-keyword">return</span> &amp;podMetrics[<span class="hljs-number">0</span>], <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *MetricStorage)</span></span> getPodMetrics(pods ...*v1.Pod) ([]metrics.PodMetrics, <span class="hljs-type">error</span>) &#123;<br>namespacedNames := <span class="hljs-built_in">make</span>([]apitypes.NamespacedName, <span class="hljs-built_in">len</span>(pods))<br><span class="hljs-keyword">for</span> i, pod := <span class="hljs-keyword">range</span> pods &#123;<br>namespacedNames[i] = apitypes.NamespacedName&#123;<br>Name:      pod.Name,<br>Namespace: pod.Namespace,<br>&#125;<br>&#125;<br>    <span class="hljs-comment">// ä»ç¼“å­˜ä¸­è·å–podçš„metricæ•°æ®ï¼Œè¿™å…¶å®å°±æ˜¯è°ƒç”¨çš„4.2.2èŠ‚ä¸­çš„GetContainerMetrics</span><br>timestamps, containerMetrics, err := m.prov.GetContainerMetrics(namespacedNames...)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br>res := <span class="hljs-built_in">make</span>([]metrics.PodMetrics, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(pods))<br><span class="hljs-keyword">for</span> i, pod := <span class="hljs-keyword">range</span> pods &#123;<br>        <span class="hljs-comment">// çœç•¥podçŠ¶æ€ä¸ä¸ºRunningå’Œmetricæ•°æ®ä¸ºç©ºçš„continueé€»è¾‘</span><br><br>        <span class="hljs-comment">// åˆ›å»ºè¿”å›ä½“çš„å†…å®¹</span><br>res = <span class="hljs-built_in">append</span>(res, metrics.PodMetrics&#123;<br>ObjectMeta: metav1.ObjectMeta&#123;<br>Name:              pod.Name,<br>Namespace:         pod.Namespace,<br>CreationTimestamp: metav1.NewTime(time.Now()),<br>&#125;,<br>Timestamp:  metav1.NewTime(timestamps[i].Timestamp),<br>Window:     metav1.Duration&#123;Duration: timestamps[i].Window&#125;,<br>Containers: containerMetrics[i],<br>&#125;)<br>&#125;<br><span class="hljs-keyword">return</span> res, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ç»ˆäºåˆå›åˆ°äº†4.2.2ä¸­çš„<code>sinkMetricsProvider</code>ï¼Œè¿™ä¸è¿‡è¿™æ¬¡æ˜¯ä»å…¶<code>map</code>ä¸­è¯»å–æ•°æ®ã€‚åœ¨æ­¤æ•°æ®æŠ“å–å’Œ<code>metric-server</code>è¿™ä¸¤éƒ¨åˆ†å°±è¿åˆ°ä¸€èµ·äº†ï¼Œæˆ‘ä»¬å…¶å®ä¹Ÿå¯ä»¥æŠŠè¿™ä¸¤éƒ¨åˆ†å½“æˆä¸€ä¸ªç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼ï¼Œå‰è€…è´Ÿè´£ç”Ÿäº§æ•°æ®ï¼Œåè€…åˆ™è¯»å–æ•°æ®ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// pkg/provider/sink/sinkprov.go</span><br><span class="hljs-comment">// metric-serveræ”¶åˆ°podçš„GETè¯·æ±‚è°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥è·å–metricæ•°æ®</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *sinkMetricsProvider)</span></span> GetContainerMetrics(pods ...apitypes.NamespacedName) ([]provider.TimeInfo, [][]metrics.ContainerMetrics, <span class="hljs-type">error</span>) &#123;<br>p.mu.RLock()<br><span class="hljs-keyword">defer</span> p.mu.RUnlock()<br><br>timestamps := <span class="hljs-built_in">make</span>([]provider.TimeInfo, <span class="hljs-built_in">len</span>(pods))<br>resMetrics := <span class="hljs-built_in">make</span>([][]metrics.ContainerMetrics, <span class="hljs-built_in">len</span>(pods))<br><br><span class="hljs-keyword">for</span> i, pod := <span class="hljs-keyword">range</span> pods &#123;<br>        <span class="hljs-comment">// ä»podçš„mapä¸­è·å–metricæ•°æ®</span><br>metricPoint, present := p.pods[pod]<br><span class="hljs-keyword">if</span> !present &#123;<br><span class="hljs-keyword">continue</span><br>&#125;<br><br><span class="hljs-comment">// çœç•¥ä¸­é—´çš„å¤„ç†é€»è¾‘</span><br>resMetrics[i] = contMetrics<br>&#125;<br><span class="hljs-keyword">return</span> timestamps, resMetrics, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go-syncåŒ…ä»‹ç»</title>
    <link href="/2025/04/06/Go-sync%E5%8C%85%E4%BB%8B%E7%BB%8D/"/>
    <url>/2025/04/06/Go-sync%E5%8C%85%E4%BB%8B%E7%BB%8D/</url>
    
    <content type="html"><![CDATA[<h1 id="Go-syncåŒ…ä»‹ç»"><a href="#Go-syncåŒ…ä»‹ç»" class="headerlink" title="Go syncåŒ…ä»‹ç»"></a>Go syncåŒ…ä»‹ç»</h1><p>è½¬è‡ªï¼š<a href="https://segmentfault.com/a/1190000022545889">https://segmentfault.com/a/1190000022545889</a></p><p>åœ¨å¹¶å‘ç¼–ç¨‹ä¸­åŒæ­¥åŸè¯­ä¹Ÿå°±æ˜¯æˆ‘ä»¬é€šå¸¸è¯´çš„é”çš„ä¸»è¦ä½œç”¨æ˜¯ä¿è¯å¤šä¸ªçº¿ç¨‹æˆ–è€… <code>goroutine</code>åœ¨è®¿é—®åŒä¸€ç‰‡å†…å­˜æ—¶ä¸ä¼šå‡ºç°æ··ä¹±çš„é—®é¢˜ã€‚<code>Go</code>è¯­è¨€çš„<code>sync</code>åŒ…æä¾›äº†å¸¸è§çš„å¹¶å‘ç¼–ç¨‹åŒæ­¥åŸè¯­ï¼Œä¸Šä¸€æœŸè½¬è½½çš„æ–‡ç« ã€Š<a href="https://link.segmentfault.com/?enc=TitSKVQMWEaJuZcPts3ceg==.DQeNe2dUjbZ5w8XBZWYnqG9IQ9bmqH7xPSzEs29VV09MGt1b7UbWVV9D361cVn6/9EWIIRQjWarFH9kvaUODTMIOJxOr7hvsEHpdOKVGFy6tLC+cONb4Prn1ibnUH5iw0XrF4+OvcHDtu4DBJ3vnG3gBAm7yoezP/nBtoPqkMK5HfdVxdGnSrEuWIHlNgPnU1vKykAzZ4T4SEeggLQ29AxR2OhCY0BXdBD5roFvJtj5lwTPTXCi35C5BM990jIMd+QYouz3ZiekEpGI992udCQLrGKK2K4f3dKrgZe5nozk6I6/W5cxaxjSG51Zq7aqepcgXXhPyafsXj0j69QvYog==">Golang å¹¶å‘ç¼–ç¨‹ä¹‹åŒæ­¥åŸè¯­</a>ã€‹ä¸­ä¹Ÿè¯¦è¿°äº† <code>Mutex</code>ã€<code>RWMutex</code>ã€<code>WaitGroup</code>ã€<code>Once</code> å’Œ <code>Cond</code> è¿™äº›åŒæ­¥åŸè¯­çš„å®ç°åŸç†ã€‚ä»Šå¤©çš„æ–‡ç« é‡Œè®©æˆ‘ä»¬å›åˆ°åº”ç”¨å±‚ï¼Œèšç„¦<code>sync</code>åŒ…é‡Œè¿™äº›åŒæ­¥åŸè¯­çš„åº”ç”¨åœºæ™¯ï¼ŒåŒæ—¶ä¹Ÿä¼šä»‹ç»<code>sync</code>åŒ…ä¸­çš„<code>Pool</code>å’Œ<code>Map</code>çš„åº”ç”¨åœºæ™¯å’Œä½¿ç”¨æ–¹æ³•ã€‚è¯ä¸å¤šè¯´ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ã€‚</p><h2 id="sync-Mutex"><a href="#sync-Mutex" class="headerlink" title="sync.Mutex"></a>sync.Mutex</h2><p><code>sync.Mutex</code>å¯èƒ½æ˜¯<code>sync</code>åŒ…ä¸­ä½¿ç”¨æœ€å¹¿æ³›çš„åŸè¯­ã€‚å®ƒå…è®¸åœ¨å…±äº«èµ„æºä¸Šäº’æ–¥è®¿é—®ï¼ˆä¸èƒ½åŒæ—¶è®¿é—®ï¼‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go">mutex := &amp;sync.Mutex&#123;&#125;<br><br>mutex.Lock()<br><span class="hljs-comment">// Updateå…±äº«å˜é‡ (æ¯”å¦‚åˆ‡ç‰‡ï¼Œç»“æ„ä½“æŒ‡é’ˆç­‰)</span><br>mutex.Unlock()<br></code></pre></td></tr></table></figure><p>å¿…é¡»æŒ‡å‡ºçš„æ˜¯ï¼Œåœ¨ç¬¬ä¸€æ¬¡è¢«ä½¿ç”¨åï¼Œä¸èƒ½å†å¯¹<code>sync.Mutex</code>è¿›è¡Œå¤åˆ¶ã€‚ï¼ˆ<code>sync</code>åŒ…çš„æ‰€æœ‰åŸè¯­éƒ½ä¸€æ ·ï¼‰ã€‚å¦‚æœç»“æ„ä½“å…·æœ‰åŒæ­¥åŸè¯­å­—æ®µï¼Œåˆ™å¿…é¡»é€šè¿‡æŒ‡é’ˆä¼ é€’å®ƒã€‚</p><h2 id="sync-RWMutex"><a href="#sync-RWMutex" class="headerlink" title="sync.RWMutex"></a>sync.RWMutex</h2><p><code>sync.RWMutex</code>æ˜¯ä¸€ä¸ªè¯»å†™äº’æ–¥é”ï¼Œå®ƒæä¾›äº†æˆ‘ä»¬ä¸Šé¢çš„åˆšåˆšçœ‹åˆ°çš„<code>sync.Mutex</code>çš„<code>Lock</code>å’Œ<code>UnLock</code>æ–¹æ³•ï¼ˆå› ä¸ºè¿™ä¸¤ä¸ªç»“æ„éƒ½å®ç°äº†<code>sync.Locker</code>æ¥å£ï¼‰ã€‚ä½†æ˜¯ï¼Œå®ƒè¿˜å…è®¸ä½¿ç”¨<code>RLock</code>å’Œ<code>RUnlock</code>æ–¹æ³•è¿›è¡Œå¹¶å‘è¯»å–ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go">mutex := &amp;sync.RWMutex&#123;&#125;<br><br>mutex.Lock()<br><span class="hljs-comment">// Update å…±äº«å˜é‡</span><br>mutex.Unlock()<br><br>mutex.RLock()<br><span class="hljs-comment">// Read å…±äº«å˜é‡</span><br>mutex.RUnlock()<br></code></pre></td></tr></table></figure><p><code>sync.RWMutex</code>å…è®¸è‡³å°‘ä¸€ä¸ªè¯»é”æˆ–ä¸€ä¸ªå†™é”å­˜åœ¨ï¼Œè€Œ<code>sync.Mutex</code>å…è®¸ä¸€ä¸ªè¯»é”æˆ–ä¸€ä¸ªå†™é”å­˜åœ¨ã€‚</p><p>é€šè¿‡åŸºå‡†æµ‹è¯•æ¥æ¯”è¾ƒè¿™å‡ ä¸ªæ–¹æ³•çš„æ€§èƒ½ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">BenchmarkMutexLock-4       83497579         17.7 ns/op<br>BenchmarkRWMutexLock-4     35286374         44.3 ns/op<br>BenchmarkRWMutexRLock-4    89403342         15.3 ns/op<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°é”å®š&#x2F;è§£é”<code>sync.RWMutex</code>è¯»é”çš„é€Ÿåº¦æ¯”é”å®š&#x2F;è§£é”<code>sync.Mutex</code>æ›´å¿«ï¼Œå¦ä¸€æ–¹é¢ï¼Œåœ¨<code>sync.RWMutex</code>ä¸Šè°ƒç”¨<code>Lock()</code>&#x2F; <code>Unlock()</code>æ˜¯æœ€æ…¢çš„æ“ä½œã€‚</p><p>å› æ­¤ï¼Œåªæœ‰åœ¨é¢‘ç¹è¯»å–å’Œä¸é¢‘ç¹å†™å…¥çš„åœºæ™¯é‡Œï¼Œæ‰åº”è¯¥ä½¿ç”¨<code>sync.RWMutex</code>ã€‚</p><h2 id="sync-WaitGroup"><a href="#sync-WaitGroup" class="headerlink" title="sync.WaitGroup"></a>sync.WaitGroup</h2><p><code>sync.WaitGroup</code>ä¹Ÿæ˜¯ä¸€ä¸ªç»å¸¸ä¼šç”¨åˆ°çš„åŒæ­¥åŸè¯­ï¼Œå®ƒçš„ä½¿ç”¨åœºæ™¯æ˜¯åœ¨ä¸€ä¸ª<code>goroutine</code>ç­‰å¾…ä¸€ç»„<code>goroutine</code>æ‰§è¡Œå®Œæˆã€‚</p><p><code>sync.WaitGroup</code>æ‹¥æœ‰ä¸€ä¸ªå†…éƒ¨è®¡æ•°å™¨ã€‚å½“è®¡æ•°å™¨ç­‰äº<code>0</code>æ—¶ï¼Œåˆ™<code>Wait()</code>æ–¹æ³•ä¼šç«‹å³è¿”å›ã€‚å¦åˆ™å®ƒå°†é˜»å¡æ‰§è¡Œ<code>Wait()</code>æ–¹æ³•çš„<code>goroutine</code>ç›´åˆ°è®¡æ•°å™¨ç­‰äº<code>0</code>æ—¶ä¸ºæ­¢ã€‚</p><p>è¦å¢åŠ è®¡æ•°å™¨ï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨<code>Add(int)</code>æ–¹æ³•ã€‚è¦å‡å°‘å®ƒï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>Done()</code>ï¼ˆå°†è®¡æ•°å™¨å‡<code>1</code>ï¼‰ï¼Œä¹Ÿå¯ä»¥ä¼ é€’è´Ÿæ•°ç»™<code>Add</code>æ–¹æ³•æŠŠè®¡æ•°å™¨å‡å°‘æŒ‡å®šå¤§å°ï¼Œ<code>Done()</code>æ–¹æ³•åº•å±‚å°±æ˜¯é€šè¿‡<code>Add(-1)</code>å®ç°çš„ã€‚</p><p>åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†å¯åŠ¨å…«ä¸ª<code>goroutine</code>ï¼Œå¹¶ç­‰å¾…ä»–ä»¬å®Œæˆï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go">wg := &amp;sync.WaitGroup&#123;&#125;<br><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++ &#123;<br>  wg.Add(<span class="hljs-number">1</span>)<br>  <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">// Do something</span><br>    wg.Done()<br>  &#125;()<br>&#125;<br><br>wg.Wait()<br><span class="hljs-comment">// ç»§ç»­å¾€ä¸‹æ‰§è¡Œ...</span><br></code></pre></td></tr></table></figure><p>æ¯æ¬¡åˆ›å»º<code>goroutine</code>æ—¶ï¼Œæˆ‘ä»¬éƒ½ä¼šä½¿ç”¨<code>wg.Add(1)</code>æ¥å¢åŠ <code>wg</code>çš„å†…éƒ¨è®¡æ•°å™¨ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨<code>for</code>å¾ªç¯ä¹‹å‰è°ƒç”¨<code>wg.Add(8)</code>ã€‚</p><p>ä¸æ­¤åŒæ—¶ï¼Œæ¯ä¸ª<code>goroutine</code>å®Œæˆæ—¶ï¼Œéƒ½ä¼šä½¿ç”¨<code>wg.Done()</code>å‡å°‘<code>wg</code>çš„å†…éƒ¨è®¡æ•°å™¨ã€‚</p><p><code>main goroutine</code>ä¼šåœ¨å…«ä¸ª<code>goroutine</code>éƒ½æ‰§è¡Œ<code>wg.Done()</code>å°†è®¡æ•°å™¨å˜ä¸º<code>0</code>åæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚</p><h2 id="sync-Map"><a href="#sync-Map" class="headerlink" title="sync.Map"></a>sync.Map</h2><p><code>sync.Map</code>æ˜¯ä¸€ä¸ªå¹¶å‘ç‰ˆæœ¬çš„<code>Go</code>è¯­è¨€çš„<code>map</code>ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š</p><ul><li>ä½¿ç”¨<code>Store(interface &#123;&#125;ï¼Œinterface &#123;&#125;)</code>æ·»åŠ å…ƒç´ ã€‚</li><li>ä½¿ç”¨<code>Load(interface &#123;&#125;) interface &#123;&#125;</code>æ£€ç´¢å…ƒç´ ã€‚</li><li>ä½¿ç”¨<code>Delete(interface &#123;&#125;)</code>åˆ é™¤å…ƒç´ ã€‚</li><li>ä½¿ç”¨<code>LoadOrStore(interface &#123;&#125;ï¼Œinterface &#123;&#125;) (interface &#123;&#125;ï¼Œbool)</code>æ£€ç´¢æˆ–æ·»åŠ ä¹‹å‰ä¸å­˜åœ¨çš„å…ƒç´ ã€‚å¦‚æœé”®ä¹‹å‰åœ¨<code>map</code>ä¸­å­˜åœ¨ï¼Œåˆ™è¿”å›çš„å¸ƒå°”å€¼ä¸º<code>true</code>ã€‚</li><li>ä½¿ç”¨<code>Range</code>éå†å…ƒç´ ã€‚</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go">m := &amp;sync.Map&#123;&#125;<br><br><span class="hljs-comment">// æ·»åŠ å…ƒç´ </span><br>m.Store(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;one&quot;</span>)<br>m.Store(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;two&quot;</span>)<br><br><span class="hljs-comment">// è·å–å…ƒç´ 1</span><br>value, contains := m.Load(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">if</span> contains &#123;<br>  fmt.Printf(<span class="hljs-string">&quot;%s\n&quot;</span>, value.(<span class="hljs-type">string</span>))<br>&#125;<br><br><span class="hljs-comment">// è¿”å›å·²å­˜valueï¼Œå¦åˆ™æŠŠæŒ‡å®šçš„é”®å€¼å­˜å‚¨åˆ°mapä¸­</span><br>value, loaded := m.LoadOrStore(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;three&quot;</span>)<br><span class="hljs-keyword">if</span> !loaded &#123;<br>  fmt.Printf(<span class="hljs-string">&quot;%s\n&quot;</span>, value.(<span class="hljs-type">string</span>))<br>&#125;<br><br>m.Delete(<span class="hljs-number">3</span>)<br><br><span class="hljs-comment">// è¿­ä»£æ‰€æœ‰å…ƒç´ </span><br>m.Range(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(key, value <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> <span class="hljs-type">bool</span> &#123;<br>  fmt.Printf(<span class="hljs-string">&quot;%d: %s\n&quot;</span>, key.(<span class="hljs-type">int</span>), value.(<span class="hljs-type">string</span>))<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;)<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„ç¨‹åºä¼šè¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">one<br>three<br>1: one<br>2: two<br></code></pre></td></tr></table></figure><p>å¦‚ä½ æ‰€è§ï¼Œ<code>Range</code>æ–¹æ³•æ¥æ”¶ä¸€ä¸ªç±»å‹ä¸º<code>func(keyï¼Œvalue interface &#123;&#125;)bool</code>çš„å‡½æ•°å‚æ•°ã€‚å¦‚æœå‡½æ•°è¿”å›äº†<code>false</code>ï¼Œåˆ™åœæ­¢è¿­ä»£ã€‚æœ‰è¶£çš„äº‹å®æ˜¯ï¼Œå³ä½¿æˆ‘ä»¬åœ¨æ’å®šæ—¶é—´åè¿”å›<code>false</code>ï¼Œæœ€åæƒ…å†µä¸‹çš„æ—¶é—´å¤æ‚åº¦ä»ä¸º<code>O(n)</code>ã€‚</p><p>æˆ‘ä»¬åº”è¯¥åœ¨ä»€ä¹ˆæ—¶å€™ä½¿ç”¨<code>sync.Map</code>è€Œä¸æ˜¯åœ¨æ™®é€šçš„<code>map</code>ä¸Šä½¿ç”¨<code>sync.Mutex</code>ï¼Ÿ</p><ul><li>å½“æˆ‘ä»¬å¯¹<code>map</code>æœ‰é¢‘ç¹çš„è¯»å–å’Œä¸é¢‘ç¹çš„å†™å…¥æ—¶ã€‚</li><li>å½“å¤šä¸ª<code>goroutine</code>è¯»å–ï¼Œå†™å…¥å’Œè¦†ç›–ä¸ç›¸äº¤çš„é”®æ—¶ã€‚å…·ä½“æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªåˆ†ç‰‡å®ç°ï¼Œå…¶ä¸­åŒ…å«ä¸€ç»„4ä¸ª<code>goroutine</code>ï¼Œæ¯ä¸ª<code>goroutine</code>è´Ÿè´£25ï¼…çš„é”®ï¼ˆæ¯ä¸ªè´Ÿè´£çš„é”®ä¸å†²çªï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>sync.Map</code>æ˜¯é¦–é€‰ã€‚</li></ul><h2 id="sync-Pool"><a href="#sync-Pool" class="headerlink" title="sync.Pool"></a>sync.Pool</h2><p><code>sync.Pool</code>æ˜¯ä¸€ä¸ªå¹¶å‘æ± ï¼Œè´Ÿè´£å®‰å…¨åœ°ä¿å­˜ä¸€ç»„å¯¹è±¡ã€‚å®ƒæœ‰ä¸¤ä¸ªå¯¼å‡ºæ–¹æ³•ï¼š</p><ul><li><code>Get() interface&#123;&#125;</code> ç”¨æ¥ä»å¹¶å‘æ± ä¸­å–å‡ºå…ƒç´ ã€‚</li><li><code>Put(interface&#123;&#125;)</code> å°†ä¸€ä¸ªå¯¹è±¡åŠ å…¥å¹¶å‘æ± ã€‚</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go">pool := &amp;sync.Pool&#123;&#125;<br><br>pool.Put(NewConnection(<span class="hljs-number">1</span>))<br>pool.Put(NewConnection(<span class="hljs-number">2</span>))<br>pool.Put(NewConnection(<span class="hljs-number">3</span>))<br><br>connection := pool.Get().(*Connection)<br>fmt.Printf(<span class="hljs-string">&quot;%d\n&quot;</span>, connection.id)<br>connection = pool.Get().(*Connection)<br>fmt.Printf(<span class="hljs-string">&quot;%d\n&quot;</span>, connection.id)<br>connection = pool.Get().(*Connection)<br>fmt.Printf(<span class="hljs-string">&quot;%d\n&quot;</span>, connection.id)<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">1<br>3<br>2<br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯<code>Get()</code>æ–¹æ³•ä¼šä»å¹¶å‘æ± ä¸­éšæœºå–å‡ºå¯¹è±¡ï¼Œæ— æ³•ä¿è¯ä»¥å›ºå®šçš„é¡ºåºè·å–å¹¶å‘æ± ä¸­å­˜å‚¨çš„å¯¹è±¡ã€‚</p><p>è¿˜å¯ä»¥ä¸º<code>sync.Pool</code>æŒ‡å®šä¸€ä¸ªåˆ›å»ºè€…æ–¹æ³•ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">pool := &amp;sync.Pool&#123;<br>  New: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">interface</span>&#123;&#125; &#123;<br>    <span class="hljs-keyword">return</span> NewConnection()<br>  &#125;,<br>&#125;<br><br>connection := pool.Get().(*Connection)<br></code></pre></td></tr></table></figure><p>è¿™æ ·æ¯æ¬¡è°ƒç”¨<code>Get()</code>æ—¶ï¼Œå°†è¿”å›ç”±åœ¨<code>pool.New</code>ä¸­æŒ‡å®šçš„å‡½æ•°åˆ›å»ºçš„å¯¹è±¡ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸ºæŒ‡é’ˆï¼‰ã€‚</p><p>é‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä½¿ç”¨sync.Poolï¼Ÿæœ‰ä¸¤ä¸ªç”¨ä¾‹ï¼š</p><p>ç¬¬ä¸€ä¸ªæ˜¯å½“æˆ‘ä»¬å¿…é¡»é‡ç”¨å…±äº«çš„å’Œé•¿æœŸå­˜åœ¨çš„å¯¹è±¡ï¼ˆä¾‹å¦‚ï¼Œæ•°æ®åº“è¿æ¥ï¼‰æ—¶ã€‚ç¬¬äºŒä¸ªæ˜¯ç”¨äºä¼˜åŒ–å†…å­˜åˆ†é…ã€‚</p><p>è®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸ªå†™å…¥ç¼“å†²åŒºå¹¶å°†ç»“æœæŒä¹…ä¿å­˜åˆ°æ–‡ä»¶ä¸­çš„å‡½æ•°ç¤ºä¾‹ã€‚ä½¿ç”¨<code>sync.Pool</code>ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ä¸åŒçš„å‡½æ•°è°ƒç”¨ä¹‹é—´é‡ç”¨åŒä¸€å¯¹è±¡æ¥é‡ç”¨ä¸ºç¼“å†²åŒºåˆ†é…çš„ç©ºé—´ã€‚<br>ç¬¬ä¸€æ­¥æ˜¯æ£€ç´¢å…ˆå‰åˆ†é…çš„ç¼“å†²åŒºï¼ˆå¦‚æœæ˜¯ç¬¬ä¸€ä¸ªè°ƒç”¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªç¼“å†²åŒºï¼Œä½†è¿™æ˜¯æŠ½è±¡çš„ï¼‰ã€‚ç„¶åï¼Œ<code>defer</code>æ“ä½œæ˜¯å°†ç¼“å†²åŒºæ”¾å›<code>sync.Pool</code>ä¸­ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">writeFile</span><span class="hljs-params">(pool *sync.Pool, filename <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> &#123;<br>    buf := pool.Get().(*bytes.Buffer)<br><br>  <span class="hljs-keyword">defer</span> pool.Put(buf)<br><br>    <span class="hljs-comment">// Reset ç¼“å­˜åŒºï¼Œä¸ç„¶ä¼šè¿æ¥ä¸Šæ¬¡è°ƒç”¨æ—¶ä¿å­˜åœ¨ç¼“å­˜åŒºé‡Œçš„å­—ç¬¦ä¸²foo</span><br>    <span class="hljs-comment">// ç¼–ç¨‹foofoo ä»¥æ­¤ç±»æ¨</span><br>    buf.Reset()<br><br>    buf.WriteString(<span class="hljs-string">&quot;foo&quot;</span>)<br><br>    <span class="hljs-keyword">return</span> ioutil.WriteFile(filename, buf.Bytes(), <span class="hljs-number">0644</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="sync-Once"><a href="#sync-Once" class="headerlink" title="sync.Once"></a>sync.Once</h2><p><code>sync.Once</code>æ˜¯ä¸€ä¸ªç®€å•è€Œå¼ºå¤§çš„åŸè¯­ï¼Œå¯ç¡®ä¿ä¸€ä¸ªå‡½æ•°ä»…æ‰§è¡Œä¸€æ¬¡ã€‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œåªæœ‰ä¸€ä¸ª<code>goroutine</code>ä¼šæ˜¾ç¤ºè¾“å‡ºæ¶ˆæ¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go">once := &amp;sync.Once&#123;&#125;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++ &#123;<br>    i := i<br>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        once.Do(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            fmt.Printf(<span class="hljs-string">&quot;first %d\n&quot;</span>, i)<br>        &#125;)<br>    &#125;()<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä½¿ç”¨äº†<code>Do(func ())</code>æ–¹æ³•æ¥æŒ‡å®šåªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡çš„éƒ¨åˆ†ã€‚</p><h2 id="sync-Cond"><a href="#sync-Cond" class="headerlink" title="sync.Cond"></a>sync.Cond</h2><p><code>sync.Cond</code>å¯èƒ½æ˜¯<code>sync</code>åŒ…æä¾›çš„åŒæ­¥åŸè¯­ä¸­æœ€ä¸å¸¸ç”¨çš„ä¸€ä¸ªï¼Œå®ƒç”¨äºå‘å‡ºä¿¡å·ï¼ˆä¸€å¯¹ä¸€ï¼‰æˆ–å¹¿æ’­ä¿¡å·ï¼ˆä¸€å¯¹å¤šï¼‰åˆ°<code>goroutine</code>ã€‚è®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸ªåœºæ™¯ï¼Œæˆ‘ä»¬å¿…é¡»å‘ä¸€ä¸ª<code>goroutine</code>æŒ‡ç¤ºå…±äº«åˆ‡ç‰‡çš„ç¬¬ä¸€ä¸ªå…ƒç´ å·²æ›´æ–°ã€‚åˆ›å»º<code>sync.Cond</code>éœ€è¦<code>sync.Locker</code>å¯¹è±¡ï¼ˆ<code>sync.Mutex</code>æˆ–<code>sync.RWMutex</code>ï¼‰ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">cond := sync.<span class="hljs-built_in">NewCond</span>(&amp;sync.Mutex&#123;&#125;)<br></code></pre></td></tr></table></figure><p>ç„¶åï¼Œè®©æˆ‘ä»¬ç¼–å†™è´Ÿè´£æ˜¾ç¤ºåˆ‡ç‰‡çš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">printFirstElement</span><span class="hljs-params">(s []<span class="hljs-type">int</span>, cond *sync.Cond)</span></span> &#123;<br>    cond.L.Lock()<br>    cond.Wait()<br>    fmt.Printf(<span class="hljs-string">&quot;%d\n&quot;</span>, s[<span class="hljs-number">0</span>])<br>    cond.L.Unlock()<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>cond.L</code>è®¿é—®å†…éƒ¨çš„äº’æ–¥é”ã€‚ä¸€æ—¦è·å¾—äº†é”ï¼Œæˆ‘ä»¬å°†è°ƒç”¨<code>cond.Wait()</code>ï¼Œè¿™ä¼šè®©å½“å‰<code>goroutine</code>åœ¨æ”¶åˆ°ä¿¡å·å‰ä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ã€‚</p><p>è®©æˆ‘ä»¬å›åˆ°<code>main goroutine</code>ã€‚æˆ‘ä»¬å°†é€šè¿‡ä¼ é€’å…±äº«åˆ‡ç‰‡å’Œå…ˆå‰åˆ›å»ºçš„<code>sync.Cond</code>æ¥åˆ›å»º<code>printFirstElement</code>æ± ã€‚ç„¶åæˆ‘ä»¬è°ƒç”¨<code>get()</code>å‡½æ•°ï¼Œå°†ç»“æœå­˜å‚¨åœ¨<code>s[0]</code>ä¸­å¹¶å‘å‡ºä¿¡å·ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go">s := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-number">1</span>)<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; runtime.NumCPU(); i++ &#123;<br>    <span class="hljs-keyword">go</span> printFirstElement(s, cond)<br>&#125;<br><br>i := get()<br>cond.L.Lock()<br>s[<span class="hljs-number">0</span>] = i<br>cond.Signal()<br>cond.L.Unlock()<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªä¿¡å·ä¼šè§£é™¤ä¸€ä¸ª<code>goroutine</code>çš„é˜»å¡çŠ¶æ€ï¼Œè§£é™¤é˜»å¡çš„<code>goroutine</code>å°†ä¼šæ˜¾ç¤º<code>s[0]</code>ä¸­å­˜å‚¨çš„å€¼ã€‚</p><p>ä½†æ˜¯ï¼Œæœ‰çš„äººå¯èƒ½ä¼šäº‰è¾©è¯´æˆ‘ä»¬çš„ä»£ç ç ´åäº†<code>Go</code>çš„æœ€åŸºæœ¬åŸåˆ™ä¹‹ä¸€ï¼š</p><blockquote><p>ä¸è¦é€šè¿‡å…±äº«å†…å­˜è¿›è¡Œé€šä¿¡ï¼›è€Œæ˜¯é€šè¿‡é€šä¿¡å…±äº«å†…å­˜ã€‚</p></blockquote><p>ç¡®å®ï¼Œåœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæœ€å¥½ä½¿ç”¨<code>channel</code>æ¥ä¼ é€’<code>get()</code>è¿”å›çš„å€¼ã€‚ä½†æ˜¯æˆ‘ä»¬ä¹Ÿæåˆ°äº†<code>sync.Cond</code>ä¹Ÿå¯ä»¥ç”¨äºå¹¿æ’­ä¿¡å·ã€‚æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ä¸Šé¢çš„ç¤ºä¾‹ï¼ŒæŠŠ<code>Signal()</code>è°ƒç”¨æ”¹ä¸ºè°ƒç”¨<code>Broadcast()</code>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go">i := get()<br>cond.L.Lock()<br>s[<span class="hljs-number">0</span>] = i<br>cond.Broadcast()<br>cond.L.Unlock()<br></code></pre></td></tr></table></figure><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‰€æœ‰goroutineéƒ½å°†è¢«è§¦å‘ã€‚<br>ä¼—æ‰€å‘¨çŸ¥ï¼Œ<code>channel</code>é‡Œçš„å…ƒç´ åªä¼šç”±ä¸€ä¸ª<code>goroutine</code>æ¥æ”¶åˆ°ã€‚é€šè¿‡<code>channel</code>æ¨¡æ‹Ÿå¹¿æ’­çš„å”¯ä¸€æ–¹æ³•æ˜¯å…³é—­<code>channel</code>ã€‚</p><blockquote><p>å½“ä¸€ä¸ªchannelè¢«å…³é—­åï¼Œchannelä¸­å·²ç»å‘é€çš„æ•°æ®éƒ½è¢«æˆåŠŸæ¥æ”¶åï¼Œåç»­çš„æ¥æ”¶æ“ä½œå°†ä¸å†é˜»å¡ï¼Œå®ƒä»¬ä¼šç«‹å³è¿”å›ä¸€ä¸ªé›¶å€¼ã€‚</p></blockquote><p>ä½†æ˜¯è¿™ç§æ–¹å¼åªèƒ½å¹¿æ’­ä¸€æ¬¡ã€‚å› æ­¤ï¼Œå°½ç®¡å­˜åœ¨å¾ˆå¤§äº‰è®®ï¼Œä½†è¿™æ— ç–‘æ˜¯<code>sync.Cond</code>çš„ä¸€ä¸ªæœ‰è¶£çš„åŠŸèƒ½ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>golang</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kubernetesä¹‹client-goä¹‹informerå·¥ä½œåŸç†æºç è§£æ</title>
    <link href="/2025/04/03/kubernetes%E4%B9%8Bclient-go%E4%B9%8Binformer%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2025/04/03/kubernetes%E4%B9%8Bclient-go%E4%B9%8Binformer%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<p>è½¬è‡ªï¼š<a href="https://blog.haohtml.com/archives/32179/">https://blog.haohtml.com/archives/32179/</a></p><h1 id="kubernetes-ä¹‹-client-go-ä¹‹-informer-å·¥ä½œåŸç†æºç è§£æ"><a href="#kubernetes-ä¹‹-client-go-ä¹‹-informer-å·¥ä½œåŸç†æºç è§£æ" class="headerlink" title="kubernetes ä¹‹ client-go ä¹‹ informer å·¥ä½œåŸç†æºç è§£æ"></a>kubernetes ä¹‹ client-go ä¹‹ informer å·¥ä½œåŸç†æºç è§£æ</h1><p>æœ¬æ–‡ä¸»è¦ä»‹ç»æœ‰å…³ <code>client go</code> æ¶æ„å®ç°åŸç†ï¼Œåœ¨æ•´ä¸ªclient-goæ¶æ„ä¸­æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ç»„ä»¶å°±æ˜¯ <code>informer</code>ï¼Œæœ¬èŠ‚æˆ‘ä»¬é‡ç‚¹å¯¹å…¶è¿›è¡Œä¸€äº›ä»‹ç»ã€‚</p><h1 id="Informer-æœºåˆ¶"><a href="#Informer-æœºåˆ¶" class="headerlink" title="Informer æœºåˆ¶"></a>Informer æœºåˆ¶</h1><p>é‡‡ç”¨ k8s HTTP API å¯ä»¥æŸ¥è¯¢é›†ç¾¤ä¸­æ‰€æœ‰çš„èµ„æºå¯¹è±¡å¹¶ Watch å…¶å˜åŒ–ï¼Œä½†å¤§é‡çš„ HTTP è°ƒç”¨ä¼šå¯¹ API Server é€ æˆè¾ƒå¤§çš„è´Ÿè·ï¼Œè€Œä¸”ç½‘ç»œè°ƒç”¨å¯èƒ½å­˜åœ¨è¾ƒå¤§çš„å»¶è¿Ÿã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå¼€å‘è€…è¿˜éœ€è¦åœ¨ç¨‹åºä¸­å¤„ç†èµ„æºçš„ç¼“å­˜ï¼ŒHTTP é“¾æ¥å‡ºé—®é¢˜åçš„é‡è¿ç­‰ã€‚ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜å¹¶ç®€åŒ– Controller çš„å¼€å‘å·¥ä½œï¼ŒK8s åœ¨ client go ä¸­æä¾›äº†ä¸€ä¸ª <code>informer</code> å®¢æˆ·ç«¯åº“ï¼Œå¯ä»¥è§†å…¶ä¸ºä¸€ä¸ªç»„ä»¶ã€‚</p><p>åœ¨ Kubernetes ä¸­ï¼Œ<code>Informer</code> å¯ä»¥ç”¨äºç›‘è§† Kubernetes API æœåŠ¡å™¨ä¸­çš„èµ„æºå¹¶å°†å®ƒä»¬çš„å½“å‰çŠ¶æ€ç¼“å­˜åˆ°æœ¬åœ°(<code>index -&gt; store)</code> ï¼Œè¿™æ ·å°±é¿å…äº†å®¢æˆ·ç«¯ä¸æ–­åœ°å‘ API æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œç›´æ¥ä»æœ¬åœ°å³å¯ã€‚</p><p>ç›¸æ¯”ç›´æ¥é‡‡ç”¨ HTTP Watchï¼Œä½¿ç”¨ Kubernetes Informer æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p><ul><li>å‡å°‘ API æœåŠ¡å™¨çš„è´Ÿè½½ï¼šé€šè¿‡åœ¨æœ¬åœ°ç¼“å­˜èµ„æºä¿¡æ¯ï¼ŒInformer å‡å°‘äº†éœ€è¦å‘ API æœåŠ¡å™¨å‘å‡ºçš„è¯·æ±‚æ•°é‡ã€‚è¿™å¯ä»¥é˜²æ­¢ç”±äº API æœåŠ¡å™¨è¿‡è½½è€Œå½±å“æ•´ä¸ªé›†ç¾¤çš„æ€§èƒ½ã€‚</li><li>æé«˜åº”ç”¨ç¨‹åºæ€§èƒ½ï¼šä½¿ç”¨ç¼“å­˜çš„æ•°æ®ï¼Œå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºå¯ä»¥å¿«é€Ÿè®¿é—®èµ„æºä¿¡æ¯ï¼Œè€Œæ— éœ€ç­‰å¾… API æœåŠ¡å™¨å“åº”ã€‚è¿™å¯ä»¥æé«˜åº”ç”¨ç¨‹åºæ€§èƒ½å¹¶å‡å°‘å»¶è¿Ÿã€‚</li><li>ç®€åŒ–ä»£ç ï¼šInformer æä¾›äº†ä¸€ç§æ›´ç®€å•ã€æ›´æµç•…çš„æ–¹å¼æ¥ç›‘è§† Kubernetes ä¸­çš„èµ„æºæ›´æ”¹ã€‚å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨ç°æœ‰çš„ Informer åº“æ¥å¤„ç†è¿™äº›ä»»åŠ¡ï¼Œè€Œæ— éœ€ç¼–å†™å¤æ‚çš„ä»£ç æ¥ç®¡ç†ä¸ API æœåŠ¡å™¨çš„è¿æ¥å¹¶å¤„ç†æ›´æ–°ã€‚</li><li>æ›´é«˜çš„å¯é æ€§ï¼šç”±äº Informer åœ¨æœ¬åœ°ç¼“å­˜æ•°æ®ï¼Œå› æ­¤å³ä½¿ API æœåŠ¡å™¨ä¸å¯ç”¨æˆ–å­˜åœ¨é—®é¢˜ï¼Œå®ƒä»¬ä¹Ÿå¯ä»¥ç»§ç»­å·¥ä½œã€‚è¿™å¯ä»¥ç¡®ä¿å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºå³ä½¿åœ¨åº•å±‚ Kubernetes åŸºç¡€ç»“æ„å‡ºç°é—®é¢˜æ—¶ä¹Ÿèƒ½ä¿æŒåŠŸèƒ½ã€‚</li></ul><p>ä¸‹é¢ä¸€èµ·çœ‹ä¸€ä¸‹ client-go åº“çš„å®ç°åŸç†</p><h1 id="æ¶æ„ä»‹ç»"><a href="#æ¶æ„ä»‹ç»" class="headerlink" title="æ¶æ„ä»‹ç»"></a>æ¶æ„ä»‹ç»</h1><p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹æ¥è‡ª <a href="https://github.com/kubernetes/sample-controller/blob/master/docs/images/client-go-controller-interaction.jpeg">å®˜æ–¹</a> çš„ <code>client-go</code> æ¶æ„å›¾</p><p><img src="/2025/04/03/kubernetes%E4%B9%8Bclient-go%E4%B9%8Binformer%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/client-go-controller-interaction.jpeg" alt="client-go-controller-interaction.jpeg"></p><p>æ•´ä¸ªæ¶æ„å›¾åˆ†ä¸Šã€ä¸‹ä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­ä¸Šéƒ¨åˆ†ä¸º <code>client-go</code> çš„å®ç°ï¼Œè€Œä¸‹éƒ¨åˆ†æ˜¯æˆ‘ä»¬è‡ªå·±è¦å®ç°çš„ <code>Custom Controller</code>ï¼Œæ¯éƒ¨åˆ†ç”±ä¸åŒçš„ç»„ä»¶ç»„æˆï¼Œä¸Šä¸‹ä¸¤éƒ¨åˆ†é€šè¿‡è™šçº¿è¿æ¥èµ·æ¥ã€‚å…¶ä»‹ç»è¯·å‚è€ƒ <a href="https://github.com/kubernetes/sample-controller/blob/master/docs/controller-client-go.md">https://github.com/kubernetes/sample-controller/blob/master/docs/controller-client-go.md</a></p><blockquote><p>æœ‰æ—¶å€™ <code>Controller</code> ä¹Ÿè¢«å«åš <code>Operator</code>ï¼Œè¿™ä¸¤ä¸ªæœ¯è¯­çš„æ··ç”¨æœ‰æ—¶è®©äººæ„Ÿåˆ°è¿·æƒ‘ã€‚ <code>Controller</code> æ˜¯ä¸€ä¸ªé€šç”¨çš„æœ¯è¯­ï¼Œå‡¡æ˜¯éµå¾ª â€œWatch K8s èµ„æºå¹¶æ ¹æ®èµ„æºå˜åŒ–è¿›è¡Œè°ƒè°â€ æ¨¡å¼çš„æ§åˆ¶ç¨‹åºéƒ½å¯ä»¥å«åš <code>Controller</code>ã€‚è€Œ <code>Operator</code> æ˜¯ä¸€ç§ä¸“ç”¨çš„ <code>Controller</code>ï¼Œç”¨äºåœ¨ Kubernetes ä¸­ç®¡ç†ä¸€äº›å¤æ‚çš„ <strong>æœ‰çŠ¶æ€</strong> çš„åº”ç”¨ç¨‹åºã€‚ä¾‹å¦‚åœ¨ Kubernetes ä¸­ç®¡ç† MySQL æ•°æ®åº“çš„ MySQL Operatorã€‚</p></blockquote><p>åœ¨å®ç° <code>controller</code> æ—¶ä¸€èˆ¬åœ¨ <code>Informer</code> é…ç½®å›è°ƒå‡½æ•° <code>Callbacksï¼ˆResourceEventHandlersï¼‰</code>æ¥å®ç° <code>Informer</code> å’Œ <code>Custom Controller</code> ä¸Šä¸‹ä¸¤éƒ¨åˆ†ä¹‹é—´çš„é€šè®¯ï¼Œè¿™ä¸ªåœ¨ä¸Šé¢çš„é“¾æ¥é‡Œå‡æœ‰ä»‹ç»ã€‚å¦‚æœä¸Šå›¾ä¸å®¹æ˜“ç†è§£çš„è¯ï¼Œä¹Ÿå¯ä»¥å‚è€ƒä¸‹é¢ä¸¤å¼ æ¶æ„å›¾ã€‚<img src="https://blogstatic.haohtml.com/uploads/2023/04/d2b5ca33bd970f64a6301fa75ae2eb22-3.png" alt="img"><img src="https://blogstatic.haohtml.com/uploads/2023/04/d2b5ca33bd970f64a6301fa75ae2eb22-2.png" alt="img"></p><p>æ³¨æ„è¿™é‡Œå†™å…¥ <code>workqueue</code> é˜Ÿåˆ—çš„æ˜¯APIå¯¹è±¡çš„ <code>key</code>ï¼Œ å³ <code>namespace/name</code>ï¼›æ¥ç€åœ¨æ§åˆ¶å¾ªç¯ <code>Control Loop</code> é‡Œå…ˆä» <code>workqueue</code> è¯»å–è¿™ä¸ª <code>key</code>ï¼›ç„¶åæ ¹æ® <code>key</code>ä» <code>indexer</code> ç¼“å­˜é‡Œè¯»å–å¯¹è±¡ã€‚å¦‚æœå¯¹è±¡ä¸å­˜åœ¨åˆ™è¯´æ˜å‰é¢æ˜¯é€šè¿‡ <code>DeleteFunc</code> å†™å…¥çš„ï¼Œåˆ™éœ€è¦åˆ é™¤keyï¼Œ å¦åˆ™è¿›è¡Œå…¶å®ƒå¤„ç†ï¼Œæ‰§è¡Œæ§åˆ¶å™¨æ¨¡å¼é‡Œçš„å¯¹æ¯”â€œ<code>æœŸæœ›çŠ¶æ€</code>â€ å’Œ â€œ<code>å®é™…çŠ¶æ€</code>â€çš„é€»è¾‘äº†ã€‚</p><p>ä¸‹é¢æ ¹æ®å®˜ç½‘ç»™å‡ºçš„æ¶æ„å›¾ï¼Œæˆ‘ä»¬ä¸€èµ·çœ‹ä¸€ä¸‹å®ƒçš„å®ç°ä»£ç ã€‚</p><h1 id="æ¶æ„å®ç°æºç åˆ†æ"><a href="#æ¶æ„å®ç°æºç åˆ†æ" class="headerlink" title="æ¶æ„å®ç°æºç åˆ†æ"></a>æ¶æ„å®ç°æºç åˆ†æ</h1><p>è¿™é‡Œä»¥å®˜æ–¹æä¾›çš„ <a href="https://github.com/kubernetes/client-go/blob/v12.0.0/examples/workqueue/README.md">workqueue</a> ç¤ºä¾‹ä¸ºä¾‹ï¼ŒæŒ‰ç…§ä¸Šæ–¹çš„æ¶æ„å›¾å¯¹å…¶ <strong>æ¯ä¸€ä¸ªæ­¥éª¤</strong> è¿›è¡Œæºç åˆ†æ</p><p>å…¥å£å‡½æ•°ä¸º mainå‡½æ•°ä¸­çš„ <code>go controller.Run(1, stop)</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// /examples/workqueue/main.go</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>...<br><br><span class="hljs-comment">// create the pod watcher</span><br>podListWatcher := cache.NewListWatchFromClient(clientset.CoreV1().RESTClient(), <span class="hljs-string">&quot;pods&quot;</span>, v1.NamespaceDefault, fields.Everything())<br><br><span class="hljs-comment">// create the workqueue</span><br>queue := workqueue.NewRateLimitingQueue(workqueue.DefaultControllerRateLimiter())<br><br><span class="hljs-comment">// åˆ›å»º indexer å’Œ informer</span><br>indexer, informer := cache.NewIndexerInformer(podListWatcher, &amp;v1.Pod&#123;&#125;, <span class="hljs-number">0</span>, cache.ResourceEventHandlerFuncs&#123;&#125;<br><br>controller := NewController(queue, indexer, informer)<br><br>stop := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)<br><span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(stop)<br><span class="hljs-keyword">go</span> controller.Run(<span class="hljs-number">1</span>, stop)<br><br><span class="hljs-keyword">select</span> &#123;&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewController</span><span class="hljs-params">(queue workqueue.RateLimitingInterface, indexer cache.Indexer, informer cache.Controller)</span></span> *Controller &#123;<br><span class="hljs-keyword">return</span> &amp;Controller&#123;<br>informer: informer,<br>indexer:  indexer,<br>queue:    queue,<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œåˆ›å»ºçš„æ˜¯ä¸€ä¸ª <code>pods</code> ç±»å‹çš„ <code>ListWatch</code>, æ¥ç€åˆ›å»ºäº†ä¸€ä¸ªå¸¦ <strong>é™é€Ÿç‡</strong> åŠŸèƒ½çš„ <code>workqueue</code>ï¼ˆåº•å±‚queue çš„å®ç°å¯¹åº”ä»£ç ä¸º <a href="https://github.com/kubernetes/client-go/blob/v12.0.0/util/workqueue/queue.go#L64-L88%EF%BC%89">https://github.com/kubernetes/client-go/blob/v12.0.0/util/workqueue/queue.go#L64-L88ï¼‰</a>, ç„¶åè°ƒç”¨ <code>cache.NewIndexInformer</code> æ¥åˆ›å»º <code>indexer</code> å’Œ <code>informer</code>ã€‚</p><p>è¿™é‡Œçš„ <code>workqueue</code> ä¸»è¦æ˜¯åœ¨ <code>ResoureEventHandlers</code> å›è°ƒæ—¶è°ƒç”¨ï¼Œå¯¹åº”çš„æ˜¯ç¬¬ <code>7) Enqueue Object Key</code> æ­¥éª¤ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// /examples/workqueue/main.go</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Controller)</span></span> Run(threadiness <span class="hljs-type">int</span>, stopCh <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;) &#123;<br><span class="hljs-keyword">defer</span> runtime.HandleCrash()<br><br><span class="hljs-comment">// Let the workers stop when we are done</span><br><span class="hljs-keyword">defer</span> c.queue.ShutDown()<br>klog.Info(<span class="hljs-string">&quot;Starting Pod controller&quot;</span>)<br><br><span class="hljs-comment">// å¯ç”¨ informer æœåŠ¡</span><br><span class="hljs-keyword">go</span> c.informer.Run(stopCh)<br><br><span class="hljs-comment">// Wait for all involved caches to be synced, before processing items from the queue is started</span><br><span class="hljs-keyword">if</span> !cache.WaitForCacheSync(stopCh, c.informer.HasSynced) &#123;<br>runtime.HandleError(fmt.Errorf(<span class="hljs-string">&quot;Timed out waiting for caches to sync&quot;</span>))<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">// ä¸šåŠ¡é€»è¾‘å›è°ƒ c.runWorker</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; threadiness; i++ &#123;<br><span class="hljs-keyword">go</span> wait.Until(c.runWorker, time.Second, stopCh)<br>&#125;<br><br>&lt;-stopCh<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œé¦–å…ˆè°ƒç”¨ <code>go c.informer.Run()</code> æ¥å¯ç”¨ informer æœåŠ¡ï¼Œè®©å…¶åœ¨ä¸€ä¸ªå•ç‹¬çš„ <code>goroutine</code> è¿è¡Œï¼Œ å…¶å®ç°å¯¹åº”æ¶æ„å›¾ä¸­çš„ 1~7 æ­¥éª¤ã€‚</p><p>æ¥ç€å†è°ƒç”¨ <code>go wait.Until(c.runWorker, time.Second, stopCh)</code> æ¥å®ç°è‡ªå®šä¹‰æ§åˆ¶å™¨çš„é€»è¾‘ï¼Œå…¶å¯¹åº”æ¶æ„å›¾ä¸­çš„ 8~9 æ­¥éª¤ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ <code>informer</code> æœåŠ¡çš„å®ç° ï¼ˆ <a href="https://github.com/kubernetes/client-go/blob/v12.0.0/tools/cache/controller.go#L97-L125%EF%BC%89%E3%80%82">https://github.com/kubernetes/client-go/blob/v12.0.0/tools/cache/controller.go#L97-L125ï¼‰ã€‚</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// /tools/cache/controller.go</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *controller)</span></span> Run(stopCh &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;) &#123;<br><br>    <span class="hljs-comment">// é¦–å…ˆåˆ›å»º Reflector</span><br>    r := NewReflector(<br>        c.config.ListerWatcher,<br>        c.config.ObjectType,<br>        c.config.Queue,<br>        c.config.FullResyncPeriod,<br>    )<br><br><br>    <span class="hljs-comment">// å¯ç”¨ Reflector æœåŠ¡</span><br>    wg.StartWithChannel(stopCh, r.Run)<br><br>&#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ª <code>Reflector</code> å¯¹è±¡ï¼Œå¹¶æ³¨å…¥ <code>podListWatcher</code> å’Œ <code>Delta Fifo Queue</code> é˜Ÿåˆ—ï¼Œ å…¶ä¸­ <code>ObjectType</code> ä¸º <code>&amp;v1.Pod&#123;&#125;</code>ï¼Œæ¥ç€å¯ç”¨ <code>Reflector</code> æœåŠ¡ï¼ˆ<a href="https://github.com/kubernetes/client-go/blob/v12.0.0/tools/cache/reflector.go#L119-L128%EF%BC%89">https://github.com/kubernetes/client-go/blob/v12.0.0/tools/cache/reflector.go#L119-L128ï¼‰</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// /tools/cache/reflector.go</span><br><span class="hljs-comment">// Run starts a watch and handles watch events. Will restart the watch if it is closed.</span><br><span class="hljs-comment">// Run will exit when stopCh is closed.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Reflector)</span></span> Run(stopCh &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;) &#123;<br>    <span class="hljs-comment">// å¯ç”¨ ListAndWatch</span><br>    wait.Until(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        <span class="hljs-keyword">if</span> err := r.ListAndWatch(stopCh); err != <span class="hljs-literal">nil</span> &#123;<br>            utilruntime.HandleError(err)<br>        &#125;<br>    &#125;, r.period, stopCh)<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ç€çœ‹ä¸€ä¸‹ <code>r.ListAndWatch()</code> å®ç° ï¼ˆ<a href="https://github.com/kubernetes/client-go/blob/v12.0.0/tools/cache/reflector.go#L156-L307%EF%BC%89">https://github.com/kubernetes/client-go/blob/v12.0.0/tools/cache/reflector.go#L156-L307ï¼‰</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// It returns error if ListAndWatch didn&#x27;t even try to initialize watch.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Reflector)</span></span> ListAndWatch(stopCh &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;) <span class="hljs-type">error</span> &#123;<br><br>    <span class="hljs-comment">// å½“å‰ä¸ºå®¢æˆ·ç«¯é¦–æ¬¡è¯·æ±‚èµ„æºçš„æƒ…å†µ</span><br>    <span class="hljs-keyword">if</span> err := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> &#123;<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>                <span class="hljs-keyword">if</span> r := <span class="hljs-built_in">recover</span>(); r != <span class="hljs-literal">nil</span> &#123;<br>                    panicCh &lt;- r<br>                &#125;<br>            &#125;()<br><br>            <span class="hljs-comment">// 1. å‘ apiserver å‘é€è¯·æ±‚</span><br>            <span class="hljs-comment">// å¦‚æœæ”¯æŒ listerWatcherï¼Œåˆ™å°è¯•ä»¥ chunks çš„æ–¹å¼è·å–èµ„æºåˆ—è¡¨; å¦åˆ™ç¬¬ä¸€ä¸ªåˆ—è¡¨å°±è¿”å›å®Œæ•´çš„å“åº”</span><br>            pager := pager.New(pager.SimplePageFunc(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(opts metav1.ListOptions)</span></span> (runtime.Object, <span class="hljs-type">error</span>) &#123;<br>                <span class="hljs-keyword">return</span> r.listerWatcher.List(opts)<br>            &#125;))<br>            <span class="hljs-keyword">if</span> r.WatchListPageSize != <span class="hljs-number">0</span> &#123;<br>                pager.PageSize = r.WatchListPageSize<br>            &#125;<br>            <span class="hljs-comment">// Pager falls back to full list if paginated list calls fail due to an &quot;Expired&quot; error.</span><br>            list, err = pager.List(context.Background(), options)<br>            <span class="hljs-built_in">close</span>(listCh)<br>        &#125;()<br><br>        <span class="hljs-comment">// 2. è¯»å–å“åº” ä»¥ channelé€šé“çš„æ–¹å¼è·å–ä¸Šé¢ goroutine çš„å“åº”ç»“æœ</span><br>        <span class="hljs-keyword">select</span> &#123;<br>        <span class="hljs-keyword">case</span> &lt;-stopCh:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>        <span class="hljs-keyword">case</span> r := &lt;-panicCh:<br>            <span class="hljs-built_in">panic</span>(r)<br>        <span class="hljs-keyword">case</span> &lt;-listCh:<br>        &#125;<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;%s: Failed to list %v: %v&quot;</span>, r.name, r.expectedType, err)<br>        &#125;<br><br>        <span class="hljs-comment">// 3.1 ä»å“åº”ç»“æœåˆ—è¡¨é‡Œè·å–ç‰ˆæœ¬å·ä¿¡æ¯</span><br>        listMetaInterface, err := meta.ListAccessor(list)<br>        resourceVersion = listMetaInterface.GetResourceVersion()<br><br>        items, err := meta.ExtractList(list)<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;%s: Unable to understand list result %#v (%v)&quot;</span>, r.name, list, err)<br>        &#125;<br><br>        <span class="hljs-comment">// 3.2 æ ¹æ®ä¸Šæ¬¡è·å–çš„ç‰ˆæœ¬å·åŒæ­¥æœ€æ–°è®°å½•, æ›´æ–° Store(Delta FIIO queue) ä¸ºæœ€æ–°å†…å®¹</span><br>        <span class="hljs-keyword">if</span> err := r.syncWith(items, resourceVersion); err != <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;%s: Unable to sync list result: %v&quot;</span>, r.name, err)<br>        &#125;<br><br>        <span class="hljs-comment">// 3.3 æ›´æ–°æœ€æ–°ç‰ˆæœ¬å·</span><br>        r.setLastSyncResourceVersion(resourceVersion)<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br><br><br>    <span class="hljs-comment">// éé¦–æ¬¡åˆ™æ ¹æ®ç‰ˆæœ¬å·æ¥è·å–æœ€æ–°å˜æ›´èµ„æº</span><br>    <span class="hljs-keyword">for</span> &#123;<br>        <span class="hljs-comment">// give the stopCh a chance to stop the loop, even in case of continue statements further down on errors</span><br>        <span class="hljs-keyword">select</span> &#123;<br>        <span class="hljs-keyword">case</span> &lt;-stopCh:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>        <span class="hljs-keyword">default</span>:<br>        &#125;<br><br>        timeoutSeconds := <span class="hljs-type">int64</span>(minWatchTimeout.Seconds() * (rand.Float64() + <span class="hljs-number">1.0</span>))<br>        options = metav1.ListOptions&#123;<br>            ResourceVersion: resourceVersion,<br>            TimeoutSeconds: &amp;timeoutSeconds,<br>            AllowWatchBookmarks: <span class="hljs-literal">false</span>,<br>        &#125;<br><br>        <span class="hljs-comment">// æ ¹æ®ç‰ˆæœ¬å·è·å–æœ€æ–°èµ„æºï¼Œå¹¶å°†æ›´æ–°ä¿¡æ¯å†™å…¥ Delta Fifo Queue</span><br>        w, err := r.listerWatcher.Watch(options)<br>        <span class="hljs-keyword">if</span> err := r.watchHandler(w, &amp;resourceVersion, resyncerrc, stopCh); err != <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">if</span> err != errorStopRequested &#123;<br>                klog.Warningf(<span class="hljs-string">&quot;%s: watch of %v ended with: %v&quot;</span>, r.name, r.expectedType, err)<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹äºé¦–æ¬¡è®¿é—® <code>apiserver</code>ï¼Œå¦‚æœæ”¯æŒ <code>listerWatcher</code> çš„è¯ï¼Œåˆ™ä»¥ <code>chunk</code> çš„æ–¹å¼è·å–èµ„æº ï¼Œå¦åˆ™ä¸€æ¬¡æ€§è·å–å®Œæ•´çš„èµ„æºä¿¡æ¯ï¼Œç„¶åå†ä»å“åº”ç»“æœé‡Œè¯»å–å½“å‰èµ„æºä¿¡æ¯å·ã€‚</p><p>å½“è·å–èµ„æºåˆ—è¡¨åï¼Œå¯¹äºä»¥åæ›´æ–°çš„èµ„æºï¼Œåˆ™éœ€è¦æ ¹æ® <code>ä¸Šæ¬¡çš„ç‰ˆæœ¬å·</code> æ¥ç›‘æ§ä»¥åå˜æ›´çš„èµ„æºï¼Œè¿™æ ·å°±å¯ä»¥åªç›‘æ§åç»­å˜æ›´çš„èµ„æºå³å¯ï¼Œå¤§å¤§å‡å°‘æ•°æ®çš„ä¼ è¾“ï¼Œå³è¿™é‡Œæ˜¯ä»¥ <code>å¢é‡</code> æ–¹å¼è·å–èµ„æºï¼Œåç»­çš„æ“ä½œä»è¿™ä¸ª <code>å¢é‡é˜Ÿåˆ—</code> é‡Œè·å–èµ„æºä¿¡æ¯å³å¯ã€‚</p><p>ä¸Šé¢è¿™äº›å¯¹åº”çš„æ­£æ˜¯æ¶æ„å›¾ä¸­çš„ <code>1) List &amp; Watch</code> æ­¥éª¤ã€‚</p><p>æˆ‘ä»¬å†çœ‹ä¸€ä¸‹ <code>r.watchHandler</code> çš„å®ç°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// watchHandler watches w and keeps *resourceVersion up to date.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Reflector)</span></span> watchHandler(w watch.Interface, resourceVersion *<span class="hljs-type">string</span>, errc <span class="hljs-keyword">chan</span> <span class="hljs-type">error</span>, stopCh &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;) <span class="hljs-type">error</span> &#123;<br><br>    ...<br><br>loop:<br>    <span class="hljs-keyword">for</span> &#123;<br>        <span class="hljs-keyword">select</span> &#123;<br>        <span class="hljs-keyword">case</span> &lt;-stopCh:<br>            <span class="hljs-keyword">return</span> errorStopRequested<br>        <span class="hljs-keyword">case</span> err := &lt;-errc:<br>            <span class="hljs-keyword">return</span> err<br>        <span class="hljs-keyword">case</span> event, ok := &lt;-w.ResultChan():<br>            <span class="hljs-keyword">if</span> !ok &#123;<br>                <span class="hljs-keyword">break</span> loop<br>            &#125;<br>            <span class="hljs-keyword">if</span> event.Type == watch.Error &#123;<br>                <span class="hljs-keyword">return</span> apierrs.FromObject(event.Object)<br>            &#125;<br>            <span class="hljs-keyword">if</span> e, a := r.expectedType, reflect.TypeOf(event.Object); e != <span class="hljs-literal">nil</span> &amp;&amp; e != a &#123;<br>                utilruntime.HandleError(fmt.Errorf(<span class="hljs-string">&quot;%s: expected type %v, but watch event object had type %v&quot;</span>, r.name, e, a))<br>                <span class="hljs-keyword">continue</span><br>            &#125;<br>            meta, err := meta.Accessor(event.Object)<br>            <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>                utilruntime.HandleError(fmt.Errorf(<span class="hljs-string">&quot;%s: unable to understand watch event %#v&quot;</span>, r.name, event))<br>                <span class="hljs-keyword">continue</span><br>            &#125;<br>            newResourceVersion := meta.GetResourceVersion()<br><br>            <span class="hljs-comment">// æ›´æ–° Delta Fifo Queue</span><br>            <span class="hljs-keyword">switch</span> event.Type &#123;<br>            <span class="hljs-keyword">case</span> watch.Added:<br>                <span class="hljs-comment">// å¯¹åº” tools/cache/delta_fifo.go#L171-L178</span><br>                err := r.store.Add(event.Object)<br>                <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>                    utilruntime.HandleError(fmt.Errorf(<span class="hljs-string">&quot;%s: unable to add watch event object (%#v) to store: %v&quot;</span>, r.name, event.Object, err))<br>                &#125;<br>            <span class="hljs-keyword">case</span> watch.Modified:<br>                err := r.store.Update(event.Object)<br>                <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>                    utilruntime.HandleError(fmt.Errorf(<span class="hljs-string">&quot;%s: unable to update watch event object (%#v) to store: %v&quot;</span>, r.name, event.Object, err))<br>                &#125;<br>            <span class="hljs-keyword">case</span> watch.Deleted:<br>                err := r.store.Delete(event.Object)<br>                <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>                    utilruntime.HandleError(fmt.Errorf(<span class="hljs-string">&quot;%s: unable to delete watch event object (%#v) from store: %v&quot;</span>, r.name, event.Object, err))<br>                &#125;<br>            <span class="hljs-keyword">case</span> watch.Bookmark:<br>                <span class="hljs-comment">// A `Bookmark` means watch has synced here, just update the resourceVersion</span><br>            <span class="hljs-keyword">default</span>:<br>                utilruntime.HandleError(fmt.Errorf(<span class="hljs-string">&quot;%s: unable to understand watch event %#v&quot;</span>, r.name, event))<br>            &#125;<br>            *resourceVersion = newResourceVersion<br>            r.setLastSyncResourceVersion(newResourceVersion)<br>            eventCount++<br>        &#125;<br>    &#125;<br><br>    watchDuration := r.clock.Since(start)<br>    <span class="hljs-keyword">if</span> watchDuration &lt; <span class="hljs-number">1</span>*time.Second &amp;&amp; eventCount == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;very short watch: %s: Unexpected watch close - watch lasted less than a second and no items received&quot;</span>, r.name)<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œåªæ˜¯å¯¹å¢é‡é˜Ÿåˆ— <code>Delta Fifo queue</code> é‡Œçš„èµ„æºè¿›è¡Œäº†æ›´æ–°æ“ä½œï¼Œå…¶å®ç°ä»£ç è§ <a href="https://github.com/kubernetes/client-go/blob/v12.0.0/tools/cache/delta_fifo.go#L171-L220">https://github.com/kubernetes/client-go/blob/v12.0.0/tools/cache/delta_fifo.go#L171-L220</a> ï¼Œ å…¶å¯¹åº”çš„æ­£æ˜¯ <code>2ï¼‰Add Object</code> è¿™ä¸€æ­¥ã€‚</p><p>å¯¹äº <code>3ï¼‰Pop Object</code> è¿™ä¸ªæ“ä½œå…¥å£å‡½æ•°ä¸º <code>processLoop</code> ( <a href="https://github.com/kubernetes/client-go/blob/v12.0.0/tools/cache/controller.go#L139-L161">https://github.com/kubernetes/client-go/blob/v12.0.0/tools/cache/controller.go#L139-L161</a>)</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// /tools/cache/controller.go</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *controller)</span></span> processLoop() &#123;<br><span class="hljs-keyword">for</span> &#123;<br><br><span class="hljs-comment">// ä» Delta Fifo Queue è¯»å–å¯¹è±¡</span><br>obj, err := c.config.Queue.Pop(PopProcessFunc(c.config.Process))<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">if</span> err == FIFOClosedError &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-keyword">if</span> c.config.RetryOnError &#123;<br><span class="hljs-comment">// This is the safe way to re-enqueue.</span><br>c.config.Queue.AddIfNotPresent(obj)<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶å¢é‡é˜Ÿåˆ—Popå®ç°è§</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// /tools/cache/delta_fifo.go</span><br><span class="hljs-comment">// Pop returns a &#x27;Deltas&#x27;, which has a complete list of all the things</span><br><span class="hljs-comment">// that happened to the object (deltas) while it was sitting in the queue.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *DeltaFIFO)</span></span> Pop(process PopProcessFunc) (<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-type">error</span>) &#123;<br>    f.lock.Lock()<br>    <span class="hljs-keyword">defer</span> f.lock.Unlock()<br>    <span class="hljs-keyword">for</span> &#123;<br>        <span class="hljs-keyword">for</span> <span class="hljs-built_in">len</span>(f.queue) == <span class="hljs-number">0</span> &#123;<br>            <span class="hljs-comment">// é˜»å¡æ–¹å¼è·å–ä¸€ä¸ªå¯¹è±¡</span><br>            <span class="hljs-comment">// When the queue is empty, invocation of Pop() is blocked until new item is enqueued.</span><br>            <span class="hljs-comment">// When Close() is called, the f.closed is set and the condition is broadcasted.</span><br>            <span class="hljs-comment">// Which causes this loop to continue and return from the Pop().</span><br>            <span class="hljs-keyword">if</span> f.IsClosed() &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, FIFOClosedError<br>            &#125;<br><br>            f.cond.Wait()<br>        &#125;<br><br>        <span class="hljs-comment">// f.queue æ˜¯ä¸€ä¸ªslice, è¿™é‡Œè·å–é¦–ä¸ªå…ƒç´ åå¹¶æ›´æ–°è¿™ä¸ªåˆ‡ç‰‡</span><br>        id := f.queue[<span class="hljs-number">0</span>]<br>        f.queue = f.queue[<span class="hljs-number">1</span>:]<br>        <span class="hljs-keyword">if</span> f.initialPopulationCount &gt; <span class="hljs-number">0</span> &#123;<br>            f.initialPopulationCount--<br>        &#125;<br><br>        <span class="hljs-comment">// å°†idä½œä¸ºkeyä»itemsè¿™ä¸ª map ä¸­è·å– Deltas ä¿¡æ¯</span><br>        item, ok := f.items[id]<br>        <span class="hljs-keyword">if</span> !ok &#123;<br>            <span class="hljs-comment">// Item may have been deleted subsequently.</span><br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-built_in">delete</span>(f.items, id)<br><br>        <span class="hljs-comment">// è¿™é‡Œ process æ˜¯ä¸‹ä¸€æ­¥çš„è¿›å…¥</span><br>        err := process(item)<br>        <span class="hljs-keyword">if</span> e, ok := err.(ErrRequeue); ok &#123;<br>            f.addIfNotPresent(id, item)<br>            err = e.Err<br>        &#125;<br>        <span class="hljs-comment">// Don&#x27;t need to copyDeltas here, because we&#x27;re transferring</span><br>        <span class="hljs-comment">// ownership to the caller.</span><br>        <span class="hljs-keyword">return</span> item, err<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ª <code>process</code> å‡½æ•°åœ¨è¿™é‡Œæ˜¯ä½œä¸ºä¸€ä¸ªå‚æ•°ä¼ é€’è¿‡æ¥çš„ï¼Œå…¶å£°æ˜ä½ç½®ä¸º</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// /tools/cache/controller.go</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newInformer</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    lw ListerWatcher,</span></span><br><span class="hljs-params"><span class="hljs-function">    objType runtime.Object,</span></span><br><span class="hljs-params"><span class="hljs-function">    resyncPeriod time.Duration,</span></span><br><span class="hljs-params"><span class="hljs-function">    h ResourceEventHandler,</span></span><br><span class="hljs-params"><span class="hljs-function">    clientState Store,</span></span><br><span class="hljs-params"><span class="hljs-function">)</span></span> Controller &#123;<br>    ...<br><br>    cfg := &amp;Config&#123;<br>        ...<br><br>        Process: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(obj <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> <span class="hljs-type">error</span> &#123;<br>            <span class="hljs-comment">// from oldest to newest</span><br>            <span class="hljs-keyword">for</span> _, d := <span class="hljs-keyword">range</span> obj.(Deltas) &#123;<br>                <span class="hljs-keyword">switch</span> d.Type &#123;<br>                <span class="hljs-keyword">case</span> Sync, Added, Updated:<br>                    <span class="hljs-keyword">if</span> old, exists, err := clientState.Get(d.Object); err == <span class="hljs-literal">nil</span> &amp;&amp; exists &#123;<br>                        <span class="hljs-comment">// å¯¹åº”ç¬¬ 4ï¼‰ å’Œ 5) æ­¥éª¤</span><br>                        <span class="hljs-keyword">if</span> err := clientState.Update(d.Object); err != <span class="hljs-literal">nil</span> &#123;<br>                            <span class="hljs-keyword">return</span> err<br>                        &#125;<br>                        h.OnUpdate(old, d.Object)<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-keyword">if</span> err := clientState.Add(d.Object); err != <span class="hljs-literal">nil</span> &#123;<br>                            <span class="hljs-keyword">return</span> err<br>                        &#125;<br>                        h.OnAdd(d.Object)<br>                    &#125;<br>                <span class="hljs-keyword">case</span> Deleted:<br>                    <span class="hljs-keyword">if</span> err := clientState.Delete(d.Object); err != <span class="hljs-literal">nil</span> &#123;<br>                        <span class="hljs-keyword">return</span> err<br>                    &#125;<br>                    h.OnDelete(d.Object)<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>        &#125;,<br>    &#125;<br>        <span class="hljs-keyword">return</span> New(cfg)<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹åº”çš„æ˜¯ <code>Config.Process</code> è¿™ä¸ªå‡½æ•°ã€‚</p><p>å¯¹äºæ¶æ„å›¾ä¸­çš„ <code>4)Add Object</code> å’Œ <code>5ï¼‰Store Object &amp; Key</code> å¯¹åº”çš„åˆ™æ˜¯å¯¹ <code>clientState</code> çš„è°ƒç”¨ã€‚</p><p>è€Œ <code>6ï¼‰Dispatch Event Handler functions</code> åˆ™ä¸ºå¯¹ å¯¹è±¡ <code>h</code> çš„è°ƒç”¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªå®ç°äº† <code>Resource Event Handlers</code> æ¥å£çš„ç»“æ„ä½“ï¼Œå®ƒæœ‰ä¸‰ä¸ªå®ç°æ–¹æ³• <code>h.OnAdd</code> ã€<code>h.OnUpdate</code> å’Œ <code>h.OnDelete</code>ï¼Œè€Œè¿™ä¸‰ä¸ªæ–¹æ³•åŸå‹å·²åœ¨ main å‡½æ•°é‡Œå®ç°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// /examples/workqueue/main.go</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    ...<br><br>    <span class="hljs-comment">// Bind the workqueue to a cache with the help of an informer. This way we make sure that</span><br>    <span class="hljs-comment">// whenever the cache is updated, the pod key is added to the workqueue.</span><br>    <span class="hljs-comment">// Note that when we finally process the item from the workqueue, we might see a newer version</span><br>    <span class="hljs-comment">// of the Pod than the version which was responsible for triggering the update.</span><br>    indexer, informer := cache.NewIndexerInformer(podListWatcher, &amp;v1.Pod&#123;&#125;, <span class="hljs-number">0</span>, cache.ResourceEventHandlerFuncs&#123;<br>        AddFunc: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(obj <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>            key, err := cache.MetaNamespaceKeyFunc(obj)<br>            <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br>                queue.Add(key)<br>            &#125;<br>        &#125;,<br>        UpdateFunc: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(old <span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-built_in">new</span> <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>            key, err := cache.MetaNamespaceKeyFunc(<span class="hljs-built_in">new</span>)<br>            <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br>                queue.Add(key)<br>            &#125;<br>        &#125;,<br>        DeleteFunc: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(obj <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>            <span class="hljs-comment">// IndexerInformer uses a delta queue, therefore for deletes we have to use this</span><br>            <span class="hljs-comment">// key function.</span><br>            key, err := cache.DeletionHandlingMetaNamespaceKeyFunc(obj)<br>            <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br>                queue.Add(key)<br>            &#125;<br>        &#125;,<br>    &#125;, cache.Indexers&#123;&#125;)<br><br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨çš„ç»“æ„ä½“åä¸º <code>cache.ResourceEventHandlerFuncs</code> ()</p><p>åœ¨ main å‡½æ•°é‡Œçš„ <code>queue.Add(key)</code> åˆ™å¯¹åº”çš„æ˜¯æ­¥éª¤ <code>7) Enqueue Object key</code>, å°† <code>key</code> å†™å…¥ä¸€ä¸ª <code>workqueue</code> é˜Ÿåˆ—ã€‚</p><p>è€Œå¯¹äº <code>8ï¼‰Get key</code> åˆ™å¯¹åº”çš„æ˜¯ <a href="https://github.com/kubernetes/client-go/blob/v12.0.0/examples/workqueue/main.go#L51-L67">controller.processNextItem()</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// /examples/workqueue/main.go</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Controller)</span></span> processNextItem() <span class="hljs-type">bool</span> &#123;<br><span class="hljs-comment">// Wait until there is a new item in the working queue</span><br><span class="hljs-comment">// å¯¹åº” 8 æ­¥éª¤ï¼Œä»wprkqueue é‡Œè¯»å–ä¸€ä¸ª key</span><br>key, quit := c.queue.Get()<br><span class="hljs-keyword">if</span> quit &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-comment">// Tell the queue that we are done with processing this key. This unblocks the key for other workers</span><br><span class="hljs-comment">// This allows safe parallel processing because two pods with the same key are never processed in</span><br><span class="hljs-comment">// parallel.</span><br><span class="hljs-keyword">defer</span> c.queue.Done(key)<br><br><span class="hljs-comment">// Invoke the method containing the business logic</span><br>err := c.syncToStdout(key.(<span class="hljs-type">string</span>))<br><br><span class="hljs-comment">// å‡ºé”™ï¼Œé‡è¯• 5 æ¬¡</span><br><span class="hljs-comment">// Handle the error if something went wrong during the execution of the business logic</span><br>c.handleErr(err, key)<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä» <code>workqueue</code> é‡Œè·å–ä¸€ä¸ªkeyï¼Œ é€šè¿‡ <a href="https://github.com/kubernetes/client-go/blob/v12.0.0/examples/workqueue/main.go#L69-L88">controller.syncToStdout()</a> <code>9) Get Object for key</code>å¤„ç†ã€‚æœ€åè°ƒç”¨ <code>c.queue.Done()</code> è¡¨ç¤ºå½“å‰ <code>key</code> å¤„ç†å®Œæ¯•ã€‚</p><p>è€Œ <code>9) Get Object for key</code> å¯¹åº” <a href="https://github.com/kubernetes/client-go/blob/v12.0.0/examples/workqueue/main.go#L69-L88">controller.syncToStdout()</a> å‡½æ•°çš„å®ç°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// /examples/workqueue/main.go</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Controller)</span></span> syncToStdout(key <span class="hljs-type">string</span>) <span class="hljs-type">error</span> &#123;<br><span class="hljs-comment">// å¯¹åº”æ­¥éª¤ 9ï¼Œä» index é‡Œè¯»å–å¯¹è±¡</span><br>obj, exists, err := c.indexer.GetByKey(key)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>klog.Errorf(<span class="hljs-string">&quot;Fetching object with key %s from store failed with %v&quot;</span>, key, err)<br><span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-keyword">if</span> !exists &#123;<br><span class="hljs-comment">// Below we will warm up our cache with a Pod, so that we will see a delete for one pod</span><br>fmt.Printf(<span class="hljs-string">&quot;Pod %s does not exist anymoren&quot;</span>, key)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// Note that you also have to check the uid if you have a local controlled resource, which</span><br><span class="hljs-comment">// is dependent on the actual instance, to detect that a Pod was recreated with the same name</span><br>fmt.Printf(<span class="hljs-string">&quot;Sync/Add/Update for Pod %sn&quot;</span>, obj.(*v1.Pod).GetName())<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å¯¹ <code>workqueue</code> çš„å†™å…¥ä¸è¯»å–å…¨éƒ¨åœ¨ <code>Custom Controller</code> éƒ¨åˆ†æ¥å®ç°çš„ï¼Œæœ‰æ—¶å€™å¯¹ä¸€ä¸ªå¯¹è±¡å¤„ç†ä¼šå‡ºç°å¤±è´¥çš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µä¸‹å°±éœ€è¦å¯¹å…¶ key è¿›è¡Œ <code>RateLimited</code> äº†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// handleErr checks if an error happened and makes sure we will retry later.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Controller)</span></span> handleErr(err <span class="hljs-type">error</span>, key <span class="hljs-keyword">interface</span>&#123;&#125;) &#123;<br><span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-comment">// Forget about the #AddRateLimited history of the key on every successful synchronization.</span><br><span class="hljs-comment">// This ensures that future processing of updates for this key is not delayed because of</span><br><span class="hljs-comment">// an outdated error history.</span><br>c.queue.Forget(key)<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">// This controller retries 5 times if something goes wrong. After that, it stops trying.</span><br><span class="hljs-keyword">if</span> c.queue.NumRequeues(key) &lt; <span class="hljs-number">5</span> &#123;<br>klog.Infof(<span class="hljs-string">&quot;Error syncing pod %v: %v&quot;</span>, key, err)<br><br><span class="hljs-comment">// Re-enqueue the key rate limited. Based on the rate limiter on the</span><br><span class="hljs-comment">// queue and the re-enqueue history, the key will be processed later again.</span><br>c.queue.AddRateLimited(key)<br><span class="hljs-keyword">return</span><br>&#125;<br><br>c.queue.Forget(key)<br><span class="hljs-comment">// Report to an external entity that, even after several retries, we could not successfully process this key</span><br>runtime.HandleError(err)<br>klog.Infof(<span class="hljs-string">&quot;Dropping pod %q out of the queue: %v&quot;</span>, key, err)<br>&#125;<br></code></pre></td></tr></table></figure><p><code>queue.AddRateLimted(key)</code> è¡¨ç¤º <strong>è¿‡ä¸€æ®µæ—¶é—´</strong> å°†å½“å‰ keyé‡æ–°å†™å…¥ <code>workqueue</code> é‡Œï¼ŒåŒæ—¶ç´¯è®¡å½“å‰keyçš„é‡è¯•æ¬¡æ•°, å¦‚æœé‡è¯•å¤šæ¬¡ï¼ˆå½“å‰ç¤ºä¾‹ä¸º5æ¬¡ï¼‰ä»å¤±è´¥çš„è¯ï¼Œåˆ™è°ƒç”¨ <code>runtime.HandleError(err)</code> å¤„ç†ã€‚</p><p><code>c.queue.Forget</code> è¡¨ç¤ºä¸€æ—¦keyå®Œæˆï¼Œåˆ™æ¸…é™¤å…¶é‡è¯•è®°å½•ï¼Œé¿å…å½±å“ä¸‹æ¬¡é‡è¯•ï¼Œå¯ä»¥çœ‹å‡ºæ¥ <code>Forget</code> æ˜¯å¯¹é‡è¯•è¡Œä¸ºçš„å¤„ç†ï¼Œè¿™ä¸ªä¸ <code>c.queue.Done()</code> çš„ä½œç”¨æ˜¯ä¸ä¸€æ ·çš„ã€‚</p><p>è‡³æ­¤æ•´ä¸ªæ¶æ„å›¾ä¸­çš„æ¯ä¸ªæ­¥éª¤æˆ‘ä»¬åŸºæœ¬ä»‹ç»å®Œäº†ï¼Œå¯¹äºéƒ¨åˆ†ç»†èŠ‚é—®é¢˜å¯èƒ½è¿˜éœ€è¦èŠ±ä¸€äº›æ—¶é—´è¿›è¡Œæ¶ˆåŒ–ã€‚</p><h1 id="SharedInformer"><a href="#SharedInformer" class="headerlink" title="SharedInformer"></a>SharedInformer</h1><p>å¦‚æœåœ¨ä¸€ä¸ªåº”ç”¨ä¸­æœ‰å¤šå¤„ç›¸äº’ç‹¬ç«‹çš„ä¸šåŠ¡é€»è¾‘éƒ½éœ€è¦ç›‘æ§åŒä¸€ç§èµ„æºå¯¹è±¡ï¼Œç”¨æˆ·ä¼šç¼–å†™å¤šä¸ª <code>Informer</code> æ¥è¿›è¡Œå¤„ç†ã€‚è¿™ä¼šå¯¼è‡´åº”ç”¨ä¸­å‘èµ·å¯¹ K8s <code>API Server</code> åŒä¸€èµ„æºçš„å¤šæ¬¡ <code>ListAndWatch</code> è°ƒç”¨ï¼Œå¹¶ä¸”æ¯ä¸€ä¸ª <code>Informer</code> ä¸­éƒ½æœ‰ä¸€ä»½å•ç‹¬çš„æœ¬åœ°ç¼“å­˜ï¼Œå¢åŠ äº†å†…å­˜å ç”¨ã€‚</p><p>K8s åœ¨ <code>client go</code> ä¸­åŸºäº <code>Informer</code> ä¹‹ä¸Šå†æ¬¡åšäº†ä¸€å±‚å°è£…ï¼Œæä¾›äº† <code>SharedInformer</code> æœºåˆ¶ã€‚é‡‡ç”¨ <code>SharedInformer</code> åï¼Œå®¢æˆ·ç«¯å¯¹åŒä¸€ç§èµ„æºå¯¹è±¡åªä¼šæœ‰ä¸€ä¸ªå¯¹ <code>API Server</code> çš„ <code>ListAndWatch</code> è°ƒç”¨ï¼Œå¤šä¸ª <code>Informer</code> ä¹Ÿä¼šå…±ç”¨åŒä¸€ä»½ç¼“å­˜ï¼Œå‡å°‘äº†å¯¹ <code>API Server</code> çš„è¯·æ±‚ï¼Œæé«˜äº†æ€§èƒ½ã€‚</p><p>è€Œå¯¹ <code>SharedInformer</code> å¯¹è±¡çš„è·å–ä¸€èˆ¬æ˜¯é€šè¿‡ <em><code>SharedInformerFactory</code></em> å·¥å‚æ¨¡å¼æ¥è·å–</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// SharedInformerFactory provides shared informers for resources in all known</span><br><span class="hljs-comment">// API group versions.</span><br></code></pre></td></tr></table></figure><p>åœ¨å†…éƒ¨é€šè¿‡è°ƒç”¨ <code>InformerFor()</code> æ–¹æ³•ä» <code>cache</code> ä¸­è·å–æŸä¸€èµ„æºå¯¹åº”çš„ <code>Informer</code>ï¼Œå¦‚æœç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œåˆ™éœ€è¦é€šè¿‡æŒ‡å®šçš„å‡½æ•°å…ˆåˆ›å»ºå¹¶åŠ å…¥ç¼“å­˜ï¼Œç„¶åè¿”å›ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// client-go/informers/factory.go#L1870-L208</span><br><span class="hljs-comment">// InternalInformerFor returns the SharedIndexInformer for obj using an internal client.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *sharedInformerFactory)</span></span> InformerFor(obj runtime.Object, newFunc internalinterfaces.NewInformerFunc) cache.SharedIndexInformer &#123;<br>f.lock.Lock()<br><span class="hljs-keyword">defer</span> f.lock.Unlock()<br><br>informerType := reflect.TypeOf(obj)<br>informer, exists := f.informers[informerType]<br><span class="hljs-keyword">if</span> exists &#123;<br><span class="hljs-keyword">return</span> informer<br>&#125;<br><br>resyncPeriod, exists := f.customResync[informerType]<br><span class="hljs-keyword">if</span> !exists &#123;<br>resyncPeriod = f.defaultResync<br>&#125;<br><br>informer = newFunc(f.client, resyncPeriod)<br>f.informers[informerType] = informer<br><br><span class="hljs-keyword">return</span> informer<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ‰€è°“çš„ <code>cache</code> å…¶å®å°±æ˜¯ä¸€ä¸ª <code>map</code> å¯¹è±¡ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> sharedInformerFactory <span class="hljs-keyword">struct</span> &#123;<br>        informers <span class="hljs-keyword">map</span>[reflect.Type]cache.SharedIndexInformer<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹äºè‡ªå®šä¹‰æ§åˆ¶å™¨å¼€å‘ï¼Œå³å¯ä»¥ç›´æ¥é€‰æ‹©ä½¿ç”¨ <a href="https://github.com/kubernetes-sigs/controller-runtime">Controller Runtime</a> (<a href="https://github.com/kubernetes-sigs/controller-runtime/blob/main/examples/README.md">å®˜æ–¹Example</a>)åº“å¼€å‘ï¼Œä¹Ÿå¯ä»¥åŸºäº <a href="https://github.com/operator-framework/operator-sdk">Operator SDK</a>. å¼€å‘ï¼Œè¿˜å¯ä»¥åŸºäº <a href="https://book.kubebuilder.io/">kubebuilder</a> å¼€å‘æ¡†æ¶ï¼Œå…¶ä¸­åä¸¤è€…éƒ½ä¼šä½¿ç”¨ Controller Runtime åº“ï¼Œè€Œ kubebuiler ä½œä¸ºä¸€æ¬¾å¼€å‘æ¡†æ¶ï¼Œç”±äºå…¶å¯¹å¼€å‘è€…æå…¶å‹å¥½ï¼Œå› æ­¤æ˜¯ç›®å‰æœ€ä¼˜å…ˆçš„è€ƒè™‘ï¼Œå‚è€ƒ  <a href="https://book.kubebuilder.io/quick-start.html">Kubebuilderâ€™s Quick Start</a> äº†è§£å…¶ç”¨æ³•ã€‚</p><p><strong><code>CRD</code> ã€<code>CR</code> å’Œ <code>æ§åˆ¶å™¨</code> çš„åŒºåˆ«</strong><img src="https://blogstatic.haohtml.com/uploads/2023/08/d2b5ca33bd970f64a6301fa75ae2eb22-1.png" alt="img"></p><p><code>CRD</code> ç”¨äºå®šä¹‰è‡ªå®šä¹‰èµ„æºç±»å‹, å¦‚æœç¨‹åºå¼€å‘ä¸­å®šä¹‰çš„ç±»å¯¹è±¡ï¼Œè„±ç¦»äº†æ§åˆ¶å™¨æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼› <code>CR</code> ï¼ˆCustom Resourceï¼‰æ˜¯ <code>CRD</code> å®šä¹‰çš„èµ„æºçš„å®ä¾‹åŒ–å¯¹è±¡ï¼Œæ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„èµ„æºç±»å‹çš„å…·ä½“å®ä¾‹ï¼Œç±»ä¼¼äºæ ¹æ®ç±»å®ä¾‹åŒ–äº†ä¸€ä¸ªå¯¹è±¡ã€‚<img src="https://blogstatic.haohtml.com/uploads/2023/08/d2b5ca33bd970f64a6301fa75ae2eb22-2.png" alt="img"></p><p><code>è‡ªå®šä¹‰æ§åˆ¶å™¨</code> ç”¨äºç®¡ç†å’Œæ§åˆ¶<code>CRD</code>æ‰€å®šä¹‰çš„è‡ªå®šä¹‰èµ„æºçš„è¡Œä¸ºï¼Œç±»ä¼¼äº <code>é’ˆå¯¹å®ä¾‹åŒ–å¯¹è±¡</code> çš„ä¸€äº›åŸºæœ¬ä¿¡æ¯åšå‡ºç›¸åº”çš„åŠ¨ä½œæˆ–è¡Œä¸ºï¼ˆå®ç°æœŸæœ›çŠ¶æ€ä¸å®é™…çŠ¶æ€ä¸€è‡´ï¼‰çš„æ§åˆ¶å™¨ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>åœ¨Kuberneteså¼€å‘ä¸­ï¼Œ<code>client-go</code> å’Œ <code>Informers</code> æ˜¯ä¸¤ä¸ªå¯†åˆ‡ç›¸å…³çš„æ¦‚å¿µã€‚</p><p><code>client-go</code> æ˜¯ Kubernetes å®˜æ–¹æä¾›çš„Goè¯­è¨€å®¢æˆ·ç«¯åº“ï¼Œç”¨äºä¸ <code>Kubernetes API</code> è¿›è¡Œé€šä¿¡ã€‚å®ƒå°è£…äº†å¯¹ <code>Kubernetes API</code> çš„å„ç§æ“ä½œï¼ŒåŒ…æ‹¬åˆ›å»ºã€è·å–ã€æ›´æ–°å’Œåˆ é™¤èµ„æºç­‰ï¼Œæä¾›äº†ä¸€ç»„ç®€å•æ˜“ç”¨çš„APIæ¥å£ï¼Œæ–¹ä¾¿å¼€å‘äººå‘˜è¿›è¡Œä¸Kubernetesé›†ç¾¤çš„äº¤äº’ã€‚</p><p>è€Œ <code>Informers</code> æ˜¯ <code>client-go</code> åº“ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæ˜¯ä¸€ç§å®ç°äº†ç¼“å­˜å’Œäº‹ä»¶é€šçŸ¥æœºåˆ¶çš„æœºåˆ¶ã€‚<code>Informers</code> é€šè¿‡ç›‘å¬ Kubernetes <code>API Server</code>ä¸Šçš„èµ„æºå˜æ›´äº‹ä»¶ï¼Œå°†è¿™äº›äº‹ä»¶è½¬æ¢ä¸ºç›¸åº”çš„é€šçŸ¥ï¼Œæä¾›ç»™å¼€å‘äººå‘˜ä½¿ç”¨ã€‚è¿™æ ·ï¼Œå¼€å‘äººå‘˜å°±å¯ä»¥åœ¨è‡ªå·±çš„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨Informersæ¥è·å–æœ€æ–°çš„èµ„æºä¿¡æ¯ï¼Œå¹¶è¿›è¡Œç›¸åº”çš„æ“ä½œã€‚</p><p>ä½¿ç”¨ <code>Informers</code> çš„å¥½å¤„æ˜¯ï¼Œé¿å…äº†é¢‘ç¹åœ°å‘ Kubernetes <code>API Server</code> å‘é€è¯·æ±‚æ¥è·å–æœ€æ–°çš„èµ„æºä¿¡æ¯ï¼Œè€Œæ˜¯é€šè¿‡ç¼“å­˜å’Œäº‹ä»¶é€šçŸ¥æ¥è·å–å¹¶åŒæ­¥èµ„æºçš„å˜æ›´ã€‚è¿™æ ·å¯ä»¥å‡è½»Kubernetes <code>API Server</code> çš„è´Ÿæ‹…ï¼Œæé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½å’Œæ•ˆç‡ã€‚</p><p>å› æ­¤ï¼Œå¯ä»¥è¯´ <code>client-go</code> æ˜¯Kuberneteså¼€å‘ä¸­ä¸ <code>API Server</code> è¿›è¡Œäº¤äº’çš„æ ¸å¿ƒç»„ä»¶ï¼Œè€Œ<code>Informers</code> æ˜¯ <code>client-go</code> çš„ä¸€éƒ¨åˆ†ï¼Œæä¾›äº†ç¼“å­˜å’Œäº‹ä»¶é€šçŸ¥çš„æœºåˆ¶ï¼Œæ–¹ä¾¿å¼€å‘äººå‘˜ä½¿ç”¨ã€‚åœ¨ä½¿ç”¨ <code>client-go</code> è¿›è¡ŒKuberneteså¼€å‘æ—¶ï¼Œå¯ä»¥é€‰æ‹©æ˜¯å¦ä½¿ç”¨ <code>Informers</code> æ¥è·å–æœ€æ–°çš„èµ„æºä¿¡æ¯ã€‚</p><h1 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a><strong>å‚è€ƒæ–‡ç« </strong></h1><ul><li><a href="https://github.com/kubernetes-sigs/controller-runtime/blob/main/examples/README.md">https://github.com/kubernetes-sigs/controller-runtime/blob/main/examples/README.md</a></li><li><a href="https://time.geekbang.org/column/article/42076">æ·±å…¥è§£æå£°æ˜å¼APIï¼ˆäºŒï¼‰ï¼šç¼–å†™è‡ªå®šä¹‰æ§åˆ¶å™¨</a></li><li><a href="https://blog.csdn.net/weixin_37546425/article/details/118758066">kubebuilderä¹‹ä¸€ï¼škubernetes operatorå·¥ä½œåŸç†</a></li><li><a href="https://www.cnblogs.com/charlieroro/p/10330390.html">kubernetes client-goè§£æ</a></li><li><a href="https://hliangzhao.cn/articles/000001640262318a67c149f524b43a6b2796c4ae753cf2b000">è‡ªå®šä¹‰èµ„æºå¯¹è±¡ä¸æ§åˆ¶å™¨çš„å®ç°</a></li><li><a href="https://so.csdn.net/so/search?q=%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAkubernetes%E4%B9%8Bclient-go&t=blog&u=weixin_42663840">æ·±å…¥æµ…å‡ºkubernetesä¹‹client-go</a></li><li><a href="https://mp.weixin.qq.com/s/TyA1bNXLQs1mXzZbw2PHfw?vid=1688850245817352&deviceid=6239469c-f992-42d3-a9b7-4313801e1c91&version=4.1.3.6008&platform=win">Kubernetes Controller æœºåˆ¶è¯¦è§£ï¼ˆä¸€ï¼‰</a></li><li><a href="https://github.com/kubernetes/kubernetes/blob/master/staging/README.md">å®˜æ–¹æ‰€æœ‰ä¾èµ–ä»“åº“æ¸…å•</a></li><li><a href="https://github.com/kubernetes-sigs/kubebuilder">https://github.com/kubernetes-sigs/kubebuilder</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Client-goæºç åˆ†æä¹‹ListerWatcher</title>
    <link href="/2025/04/02/Client-go%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BListerWatcher/"/>
    <url>/2025/04/02/Client-go%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BListerWatcher/</url>
    
    <content type="html"><![CDATA[<h2 id="ä¸€-èƒŒæ™¯"><a href="#ä¸€-èƒŒæ™¯" class="headerlink" title="ä¸€ èƒŒæ™¯"></a>ä¸€ èƒŒæ™¯</h2><p>kubernetesæ‰€æœ‰APIå¯¹è±¡éƒ½å­˜å‚¨åœ¨etcdä¸­ï¼Œå¹¶åªèƒ½é€šè¿‡apiserverè®¿é—®ã€‚å¦‚æœå¾ˆå¤šå®¢æˆ·ç«¯é¢‘ç¹çš„åˆ—ä¸¾å…¨é‡å¯¹è±¡ï¼ˆæ¯”å¦‚åˆ—ä¸¾æ‰€æœ‰çš„Podï¼‰ï¼Œè¿™ä¼šé€ æˆapiserverä¸å ªé‡è´Ÿã€‚</p><p>ListerWatcheræ˜¯Listerå’ŒWatcherçš„ç»“åˆä½“ï¼ŒListerWatcherè´Ÿè´£åˆ—ä¸¾å…¨é‡å¯¹è±¡ï¼ŒWatcherè´Ÿè´£ç›‘è§†ï¼ˆæœ¬æ–‡å°†watchç¿»è¯‘ä¸ºç›‘è§†ï¼‰å¯¹è±¡çš„å¢é‡å˜åŒ–ã€‚</p><p>é€šè¿‡å®¢æˆ·ç«¯ç¼“å­˜ï¼Œè‡³åœ¨æ²¡æœ‰ä»»ä½•çŠ¶æ€å˜åŒ–çš„æƒ…å†µä¸‹åªéœ€è¦è¯»å–æœ¬åœ°ç¼“å­˜å³å¯ï¼Œå‡å°‘å¯¹API-serverçš„å‹åŠ›æ•ˆç‡æå‡æ˜¾è€Œæ˜“è§ã€‚é€šè¿‡åˆ—ä¸¾å…¨é‡å¯¹è±¡å®Œæˆæœ¬åœ°ç¼“å­˜ï¼Œè€Œç›‘è§†å¢é‡åˆ™æ˜¯ä¸ºäº†åŠæ—¶çš„å°†apiserverçš„çŠ¶æ€å˜åŒ–æ›´æ–°åˆ°æœ¬åœ°ç¼“å­˜ã€‚æ‰€ä»¥ï¼Œåœ¨apiserverä¸å®¢æˆ·ç«¯ä¹‹é—´ç»å¤§éƒ¨åˆ†ä¼ è¾“çš„æ˜¯å¯¹è±¡çš„å¢é‡å˜åŒ–ï¼Œå½“ç„¶åœ¨å¼‚å¸¸çš„æƒ…å†µä¸‹è¿˜æ˜¯è¦é‡æ–°åˆ—ä¸¾ä¸€æ¬¡å…¨é‡å¯¹è±¡ã€‚</p><p>æœ¬æ–‡å€¼å¾—å®¢æˆ·ç«¯æœ¬åœ°ç¼“å­˜å°±æ˜¯Indexerï¼Œclient-goä¸ä»…å®ç°äº†ç¼“å­˜ï¼ŒåŒæ—¶è¿˜åŠ äº†ç´¢å¼•ï¼Œè¿›ä¸€æ­¥æå‡äº†æ£€ç´¢æ•ˆç‡ã€‚</p><h2 id="äºŒ-ListerWatcher"><a href="#äºŒ-ListerWatcher" class="headerlink" title="äºŒ ListerWatcher"></a>äºŒ ListerWatcher</h2><p>Kubernetes æ§åˆ¶é¢ (control plane) çš„æ ¸å¿ƒæ˜¯ **API æœåŠ¡å™¨ (API server)**ã€‚API æœåŠ¡å™¨è´Ÿè´£æä¾› HTTP APIï¼Œä»¥ä¾›ç”¨æˆ·ï¼Œé›†ç¾¤ä¸­çš„ä¸åŒéƒ¨åˆ†å’Œé›†ç¾¤å¤–éƒ¨ç»„ä»¶ç›¸äº’é€šä¿¡ã€‚æ§åˆ¶å™¨ä¹Ÿä¸ä¾‹å¤–ï¼Œæ‰€æœ‰æ§åˆ¶å™¨éƒ½é€šè¿‡ API è·å–é›†ç¾¤çš„å½“å‰çŠ¶æ€ï¼Œä¹Ÿé€šè¿‡ API å¯¹é›†ç¾¤çŠ¶æ€è¿›è¡Œä¿®æ”¹ã€‚</p><p>list-watchï¼Œä½œä¸ºk8sç³»ç»Ÿä¸­ç»Ÿä¸€çš„å¼‚æ­¥æ¶ˆæ¯ä¼ é€’æ–¹å¼ï¼Œå¯¹ç³»ç»Ÿçš„æ€§èƒ½ã€æ•°æ®ä¸€è‡´æ€§èµ·åˆ°å…³é”®æ€§çš„ä½œç”¨ã€‚</p><p><img src="/2025/04/02/Client-go%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BListerWatcher/20220120151429.png" alt="img"></p><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒKubernetes æä¾›äº† watch æœºåˆ¶æ–¹ä¾¿å®¢æˆ·ç«¯å®æ—¶è·å–é›†ç¾¤çŠ¶æ€ï¼Œæœ‰äº†è¿™ä¸ªæ¥å£ï¼Œæ§åˆ¶å™¨æ‰å¾—ä»¥æ— å»¶è¿Ÿï¼ˆå‡†ç¡®åœ°è¯´æ˜¯ä½å»¶è¿Ÿï¼‰åœ°å¯¹çŠ¶æ€å˜æ›´ä½œå‡ºå“åº”ã€‚è¿™é‡ŒæŒ‡çš„ â€œçŠ¶æ€å˜æ›´â€ï¼Œå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„**äº‹ä»¶ (event)**ã€‚</p><h3 id="2-1-EventType"><a href="#2-1-EventType" class="headerlink" title="2.1 EventType"></a>2.1 EventType</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// EventType defines the possible types of events.</span><br><span class="hljs-keyword">type</span> EventType <span class="hljs-type">string</span><br><br><span class="hljs-keyword">const</span> (<br>Added    EventType = <span class="hljs-string">&quot;ADDED&quot;</span><br>Modified EventType = <span class="hljs-string">&quot;MODIFIED&quot;</span><br>Deleted  EventType = <span class="hljs-string">&quot;DELETED&quot;</span><br>Bookmark EventType = <span class="hljs-string">&quot;BOOKMARK&quot;</span><br>Error    EventType = <span class="hljs-string">&quot;ERROR&quot;</span><br>)<br></code></pre></td></tr></table></figure><h3 id="2-2-ListerWatcherå®šä¹‰"><a href="#2-2-ListerWatcherå®šä¹‰" class="headerlink" title="2.2 ListerWatcherå®šä¹‰"></a>2.2 ListerWatcherå®šä¹‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å¤åˆ¶ä»£ç </span><br><span class="hljs-comment">// client-go/tools/cache/listwatch.go</span><br><span class="hljs-comment">// Lister is any object that knows how to perform an initial list.</span><br><span class="hljs-keyword">type</span> Lister <span class="hljs-keyword">interface</span> &#123;<br><span class="hljs-comment">// List should return a list type object; the Items field will be extracted, and the</span><br><span class="hljs-comment">// ResourceVersion field will be used to start the watch in the right place.</span><br>List(options metav1.ListOptions) (runtime.Object, <span class="hljs-type">error</span>)<br>&#125;<br><br><span class="hljs-comment">// Watcher is any object that knows how to start a watch on a resource.</span><br><span class="hljs-keyword">type</span> Watcher <span class="hljs-keyword">interface</span> &#123;<br><span class="hljs-comment">// Watch should begin a watch at the specified version.</span><br>Watch(options metav1.ListOptions) (watch.Interface, <span class="hljs-type">error</span>)<br>&#125;<br><br><span class="hljs-comment">// ListerWatcher is any object that knows how to perform an initial list and start a watch on a resource.</span><br><span class="hljs-keyword">type</span> ListerWatcher <span class="hljs-keyword">interface</span> &#123;<br>Lister<br>Watcher<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-3-åˆ›å»ºListWatcherå¯¹è±¡"><a href="#2-3-åˆ›å»ºListWatcherå¯¹è±¡" class="headerlink" title="2.3 åˆ›å»ºListWatcherå¯¹è±¡"></a>2.3 åˆ›å»ºListWatcherå¯¹è±¡</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// NewListWatchFromClient creates a new ListWatch from the specified client, resource, namespace and field selector.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewListWatchFromClient</span><span class="hljs-params">(c Getter, resource <span class="hljs-type">string</span>, namespace <span class="hljs-type">string</span>, fieldSelector fields.Selector)</span></span> *ListWatch &#123;<br>optionsModifier := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(options *metav1.ListOptions)</span></span> &#123;<br>options.FieldSelector = fieldSelector.String()<br>&#125;<br><span class="hljs-keyword">return</span> NewFilteredListWatchFromClient(c, resource, namespace, optionsModifier)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ä¸‰-å°è¯•ç‰›åˆ€"><a href="#ä¸‰-å°è¯•ç‰›åˆ€" class="headerlink" title="ä¸‰ å°è¯•ç‰›åˆ€"></a>ä¸‰ å°è¯•ç‰›åˆ€</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">kubectl proxy</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">è¿›è¡Œlistwatch defaultåç§°ç©ºé—´ä¸‹çš„pods</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">curl <span class="hljs-string">&quot;127.0.0.1:8001/api/v1/namespaces/default/pods?watch=1&quot;</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">åˆ›å»ºpodè¿›è¡Œè§‚å¯Ÿ</span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">kubectl run nginx --image=nginx</span><br>&#123;&quot;type&quot;:&quot;ADDED&quot;,&quot;object&quot;:&#123;&quot;kind&quot;:&quot;Pod&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;metadata&quot;:&#123;&quot;name&quot;:&quot;nginx&quot;,&quot;namespace&quot;:&quot;default&quot;,&quot;uid&quot;:&quot;8d0548ce-fb67-4b71-93ec-59ad67b429d9&quot;,&quot;resourceVersion&quot;:&quot;2925331&quot;,&quot;creationTimestamp&quot;:&quot;2022-01-20T07:32:22Z&quot;,&quot;labels&quot;:&#123;&quot;run&quot;:&quot;nginx&quot;&#125;,&quot;managedFields&quot;:[&#123;&quot;manager&quot;:&quot;kubectl-run&quot;,&quot;operation&quot;:&quot;Update&quot;,&quot;apiVersion&quot;:&quot;v1&quot;,&quot;time&quot;:&quot;2022-01-20T07:32:22Z&quot;,&quot;fieldsType&quot;:&quot;FieldsV1&quot;,&quot;fieldsV1&quot;:&#123;&quot;f:metadata&quot;:&#123;&quot;f:labels&quot;:&#123;&quot;.&quot;:&#123;&#125;,&quot;f:run&quot;:&#123;&#125;&#125;&#125;,&quot;f:spec&quot;:&#123;&quot;f:containers&quot;:&#123;&quot;k:&#123;\&quot;name\&quot;:\&quot;nginx\&quot;&#125;&quot;:&#123;&quot;.&quot;:&#123;&#125;,&quot;f:image&quot;:&#123;&#125;,&quot;f:imagePullPolicy&quot;:&#123;&#125;,&quot;f:name&quot;:&#123;&#125;,&quot;f:resources&quot;:&#123;&#125;,&quot;f:terminationMessagePath&quot;:&#123;&#125;,&quot;f:terminationMessagePolicy&quot;:&#123;&#125;&#125;&#125;,&quot;f:dnsPolicy&quot;:&#123;&#125;,&quot;f:enableServiceLinks&quot;:&#123;&#125;,&quot;f:restartPolicy&quot;:&#123;&#125;,&quot;f:schedulerName&quot;:&#123;&#125;,&quot;f:securityContext&quot;:&#123;&#125;,&quot;f:terminationGracePeriodSeconds&quot;:&#123;&#125;&#125;&#125;&#125;]&#125;,&quot;spec&quot;:&#123;&quot;volumes&quot;:[&#123;&quot;name&quot;:&quot;kube-api-access-nc5v8&quot;,&quot;projected&quot;:&#123;&quot;sources&quot;:[&#123;&quot;serviceAccountToken&quot;:&#123;&quot;expirationSeconds&quot;:3607,&quot;path&quot;:&quot;token&quot;&#125;&#125;,&#123;&quot;configMap&quot;:&#123;&quot;name&quot;:&quot;kube-root-ca.crt&quot;,&quot;items&quot;:[&#123;&quot;key&quot;:&quot;ca.crt&quot;,&quot;path&quot;:&quot;ca.crt&quot;&#125;]&#125;&#125;,&#123;&quot;downwardAPI&quot;:&#123;&quot;items&quot;:[&#123;&quot;path&quot;:&quot;namespace&quot;,&quot;fieldRef&quot;:&#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;fieldPath&quot;:&quot;metadata.namespace&quot;&#125;&#125;]&#125;&#125;],&quot;defaultMode&quot;:420&#125;&#125;],&quot;containers&quot;:[&#123;&quot;name&quot;:&quot;nginx&quot;,&quot;image&quot;:&quot;nginx&quot;,&quot;resources&quot;:&#123;&#125;,&quot;volumeMounts&quot;:[&#123;&quot;name&quot;:&quot;kube-api-access-nc5v8&quot;,&quot;readOnly&quot;:true,&quot;mountPath&quot;:&quot;/var/run/secrets/kubernetes.io/serviceaccount&quot;&#125;],&quot;terminationMessagePath&quot;:&quot;/dev/termination-log&quot;,&quot;terminationMessagePolicy&quot;:&quot;File&quot;,&quot;imagePullPolicy&quot;:&quot;Always&quot;&#125;],&quot;restartPolicy&quot;:&quot;Always&quot;,&quot;terminationGracePeriodSeconds&quot;:30,&quot;dnsPolicy&quot;:&quot;ClusterFirst&quot;,&quot;serviceAccountName&quot;:&quot;default&quot;,&quot;serviceAccount&quot;:&quot;default&quot;,&quot;securityContext&quot;:&#123;&#125;,&quot;schedulerName&quot;:&quot;default-scheduler&quot;,&quot;tolerations&quot;:[&#123;&quot;key&quot;:&quot;node.kubernetes.io/not-ready&quot;,&quot;operator&quot;:&quot;Exists&quot;,&quot;effect&quot;:&quot;NoExecute&quot;,&quot;tolerationSeconds&quot;:300&#125;,&#123;&quot;key&quot;:&quot;node.kubernetes.io/unreachable&quot;,&quot;operator&quot;:&quot;Exists&quot;,&quot;effect&quot;:&quot;NoExecute&quot;,&quot;tolerationSeconds&quot;:300&#125;],&quot;priority&quot;:0,&quot;enableServiceLinks&quot;:true,&quot;preemptionPolicy&quot;:&quot;PreemptLowerPriority&quot;&#125;,&quot;status&quot;:&#123;&quot;phase&quot;:&quot;Pending&quot;,&quot;qosClass&quot;:&quot;BestEffort&quot;&#125;&#125;&#125;<br></code></pre></td></tr></table></figure><h2 id="å››-ä»£ç å®ç°"><a href="#å››-ä»£ç å®ç°" class="headerlink" title="å›› ä»£ç å®ç°"></a>å›› ä»£ç å®ç°</h2><p>ç¼–å†™ä»£ç å¯¹defaultåç§°ç©ºé—´ä¸‹çš„configmapè¿›è¡Œlist watchã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br>v1 <span class="hljs-string">&quot;k8s.io/api/core/v1&quot;</span><br><span class="hljs-string">&quot;k8s.io/apimachinery/pkg/api/meta&quot;</span><br>metav1 <span class="hljs-string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span><br><span class="hljs-string">&quot;k8s.io/apimachinery/pkg/fields&quot;</span><br><span class="hljs-string">&quot;k8s.io/client-go/kubernetes&quot;</span><br><span class="hljs-string">&quot;k8s.io/client-go/tools/cache&quot;</span><br><span class="hljs-string">&quot;k8s.io/client-go/tools/clientcmd&quot;</span><br><span class="hljs-string">&quot;k8s.io/client-go/util/homedir&quot;</span><br><span class="hljs-string">&quot;os&quot;</span><br><span class="hljs-string">&quot;os/signal&quot;</span><br><span class="hljs-string">&quot;path/filepath&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Must</span><span class="hljs-params">(e <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br><span class="hljs-keyword">if</span> e != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(e)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitClientSet</span><span class="hljs-params">()</span></span> (*kubernetes.Clientset, <span class="hljs-type">error</span>) &#123;<br>kubeconfig := filepath.Join(homedir.HomeDir(), <span class="hljs-string">&quot;.kube&quot;</span>, <span class="hljs-string">&quot;config&quot;</span>)<br>restConfig, err := clientcmd.BuildConfigFromFlags(<span class="hljs-string">&quot;&quot;</span>, kubeconfig)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><span class="hljs-keyword">return</span> kubernetes.NewForConfig(restConfig)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitListerWatcher</span><span class="hljs-params">(clientSet *kubernetes.Clientset, resource, namespace <span class="hljs-type">string</span>, fieldSelector fields.Selector)</span></span> cache.ListerWatcher &#123;<br>restClient := clientSet.CoreV1().RESTClient()<br><span class="hljs-keyword">return</span> cache.NewListWatchFromClient(restClient, resource, namespace, fieldSelector)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>clientSet, err := InitClientSet()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br><br><span class="hljs-comment">// ä»€ä¹ˆå¸¸é‡</span><br>resource := <span class="hljs-string">&quot;configmaps&quot;</span><br>namespace := <span class="hljs-string">&quot;default&quot;</span><br><br>configMapListerWatcher := InitListerWatcher(clientSet, resource, namespace, fields.Everything())<br><br><span class="hljs-comment">// 1. listæ“ä½œ</span><br>listObj, err := configMapListerWatcher.List(metav1.ListOptions&#123;&#125;)<br><br><span class="hljs-comment">// meta åŒ…å°è£…äº†ä¸€äº›å¤„ç† runtime.Object å¯¹è±¡çš„æ–¹æ³•ï¼Œå±è”½äº†åå°„å’Œç±»å‹è½¬æ¢çš„è¿‡ç¨‹ï¼Œ</span><br><span class="hljs-comment">// æå–å‡ºçš„ items ç±»å‹ä¸º []runtime.Object</span><br>items, err := meta.ExtractList(listObj)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>Must(err)<br>&#125;<br>fmt.Println(<span class="hljs-string">&quot;list result:&quot;</span>)<br><span class="hljs-keyword">for</span> _, item := <span class="hljs-keyword">range</span> items &#123;<br>configmaps, ok := item.(*v1.ConfigMap)<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br>fmt.Printf(<span class="hljs-string">&quot;namespace: %s, resource name:%s\n&quot;</span>, configmaps.Namespace, configmaps.Name)<br>&#125;<br><br><span class="hljs-comment">// 2. watch æ“ä½œ</span><br>listMetaInterface, err := meta.ListAccessor(listObj)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>Must(err)<br>&#125;<br>resourceVersion := listMetaInterface.GetResourceVersion()<br><br>watchObj, err := configMapListerWatcher.Watch(metav1.ListOptions&#123;<br>ResourceVersion: resourceVersion,<br>&#125;)<br><br><span class="hljs-comment">// æ¥æ”¶ä¿¡å·</span><br>stopCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> os.Signal)<br>signal.Notify(stopCh, os.Interrupt)<br>fmt.Println(<span class="hljs-string">&quot;Start watching...&quot;</span>)<br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-stopCh:<br>fmt.Println(<span class="hljs-string">&quot;exit&quot;</span>)<br><span class="hljs-keyword">return</span><br><span class="hljs-keyword">case</span> event, ok := &lt;-watchObj.ResultChan():<br><span class="hljs-keyword">if</span> !ok &#123;<br>fmt.Println(<span class="hljs-string">&quot;Broken channel&quot;</span>)<br><span class="hljs-keyword">break</span><br>&#125;<br>configmaps, ok := event.Object.(*v1.ConfigMap)<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br>fmt.Printf(<span class="hljs-string">&quot;eventType: %s, watch obj:%s\n&quot;</span>, event.Type, configmaps.Name)<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿›è¡Œåˆ›å»ºconfigmapæµ‹è¯•</p><p><img src="/2025/04/02/Client-go%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BListerWatcher/20220120153657.png" alt="img"></p><h2 id="äº”-æ€»ç»“"><a href="#äº”-æ€»ç»“" class="headerlink" title="äº” æ€»ç»“"></a>äº” æ€»ç»“</h2><ul><li>ListerWatcherå°±æ˜¯ä¸ºSharedIndexInformeråˆ—ä¸¾å…¨é‡å¯¹è±¡ã€ç›‘è§†å¯¹è±¡å¢é‡å˜åŒ–è®¾è®¡çš„æ¥å£ï¼Œå®ç°å°±æ˜¯Clientsetçš„Listå’ŒWatchå‡½æ•°ï¼›</li><li>SharedIndexInformeråˆ©ç”¨ListerWatcherå®ç°äº†æœ¬åœ°ç¼“å­˜ä¸apiserverä¹‹é—´çš„çŠ¶æ€ä¸€è‡´æ€§ï¼›</li><li>ä¸ä»…å¯ä»¥æå‡å®¢æˆ·ç«¯è®¿é—®APIå¯¹è±¡çš„æ•ˆç‡ï¼ŒåŒæ—¶å¯ä»¥å°†å¯¹è±¡çš„å¢é‡å˜åŒ–å›è°ƒç»™ä½¿ç”¨è€…ï¼›</li><li>ä»åŸç†ä¸Šè®²ï¼Œå¯ä»¥ç”¨etcdçš„clientv3.Clientå®ç°ListerWatcherï¼ŒSharedIndexInformeråŒæ­¥etcdçš„å¯¹è±¡ï¼Œè¿™æ ·ä¸€äº›ç®€å•çš„é†’ç›®å°±å¯ä»¥å¤ç”¨SharedIndexInformeräº†ï¼Œæ¯•ç«Ÿä¸æ˜¯æ‰€æœ‰çš„é¡¹ç›®éƒ½éœ€è¦ä¸€ä¸ªapiserverï¼›</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golangä¸­çš„Deferå¿…æŒæ¡çš„7çŸ¥è¯†ç‚¹</title>
    <link href="/2025/04/01/Golang%E4%B8%AD%E7%9A%84Defer%E5%BF%85%E6%8E%8C%E6%8F%A1%E7%9A%847%E7%9F%A5%E8%AF%86%E7%82%B9/"/>
    <url>/2025/04/01/Golang%E4%B8%AD%E7%9A%84Defer%E5%BF%85%E6%8E%8C%E6%8F%A1%E7%9A%847%E7%9F%A5%E8%AF%86%E7%82%B9/</url>
    
    <content type="html"><![CDATA[<h1 id="Golangä¸­çš„Deferå¿…æŒæ¡çš„7çŸ¥è¯†ç‚¹"><a href="#Golangä¸­çš„Deferå¿…æŒæ¡çš„7çŸ¥è¯†ç‚¹" class="headerlink" title="Golangä¸­çš„Deferå¿…æŒæ¡çš„7çŸ¥è¯†ç‚¹"></a>Golangä¸­çš„Deferå¿…æŒæ¡çš„7çŸ¥è¯†ç‚¹</h1><p>è½¬è‡ªï¼š<a href="https://www.yuque.com/aceld/golang/qnubsg">https://www.yuque.com/aceld/golang/qnubsg</a></p><p>çŸ¥è¯†ç‚¹1ï¼šdeferçš„æ‰§è¡Œé¡ºåº</p><p>å¤šä¸ªdeferå‡ºç°çš„æ—¶å€™ï¼Œå®ƒæ˜¯ä¸€ä¸ªâ€œæ ˆâ€çš„å…³ç³»ï¼Œä¹Ÿå°±æ˜¯å…ˆè¿›åå‡ºã€‚ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œå†™åœ¨å‰é¢çš„deferä¼šæ¯”å†™åœ¨åé¢çš„deferè°ƒç”¨çš„æ™šã€‚</p><p>ç¤ºä¾‹ä»£ç :</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">defer</span> func1()<br>    <span class="hljs-keyword">defer</span> func2()<br>    <span class="hljs-keyword">defer</span> func3()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">func1</span><span class="hljs-params">()</span></span> &#123;<br>    fmt.Println(<span class="hljs-string">&quot;A&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">func2</span><span class="hljs-params">()</span></span> &#123;<br>    fmt.Println(<span class="hljs-string">&quot;B&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">func3</span><span class="hljs-params">()</span></span> &#123;<br>    fmt.Println(<span class="hljs-string">&quot;C&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2025/04/01/Golang%E4%B8%AD%E7%9A%84Defer%E5%BF%85%E6%8E%8C%E6%8F%A1%E7%9A%847%E7%9F%A5%E8%AF%86%E7%82%B9/1651037338287-fd17c81d-a1ad-4bc7-ae7e-eec8a264af5f.webp" alt="112-defer2.jpeg"></p><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">C<br>B<br>A<br></code></pre></td></tr></table></figure><h3 id="çŸ¥è¯†ç‚¹2-deferä¸returnè°å…ˆè°å"><a href="#çŸ¥è¯†ç‚¹2-deferä¸returnè°å…ˆè°å" class="headerlink" title="çŸ¥è¯†ç‚¹2: deferä¸returnè°å…ˆè°å"></a>çŸ¥è¯†ç‚¹2: deferä¸returnè°å…ˆè°å</h3><p>ç¤ºä¾‹ä»£ç :</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">deferFunc</span><span class="hljs-params">()</span></span> <span class="hljs-type">int</span> &#123;<br>    fmt.Println(<span class="hljs-string">&quot;defer func called&quot;</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">returnFunc</span><span class="hljs-params">()</span></span> <span class="hljs-type">int</span> &#123;<br>    fmt.Println(<span class="hljs-string">&quot;return func called&quot;</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">returnAndDefer</span><span class="hljs-params">()</span></span> <span class="hljs-type">int</span> &#123;<br><br>    <span class="hljs-keyword">defer</span> deferFunc()<br><br>    <span class="hljs-keyword">return</span> returnFunc()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    returnAndDefer()<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">return</span> func called<br>defer func called<br></code></pre></td></tr></table></figure><p>ç»“è®ºä¸ºï¼š<strong>returnä¹‹åçš„è¯­å¥å…ˆæ‰§è¡Œï¼Œdeferåçš„è¯­å¥åæ‰§è¡Œ</strong></p><h3 id="çŸ¥è¯†ç‚¹3ï¼šå‡½æ•°çš„è¿”å›å€¼åˆå§‹åŒ–"><a href="#çŸ¥è¯†ç‚¹3ï¼šå‡½æ•°çš„è¿”å›å€¼åˆå§‹åŒ–" class="headerlink" title="çŸ¥è¯†ç‚¹3ï¼šå‡½æ•°çš„è¿”å›å€¼åˆå§‹åŒ–"></a>çŸ¥è¯†ç‚¹3ï¼šå‡½æ•°çš„è¿”å›å€¼åˆå§‹åŒ–</h3><p>è¯¥çŸ¥è¯†ç‚¹ä¸å±äºdeferæœ¬èº«ï¼Œä½†æ˜¯è°ƒç”¨çš„åœºæ™¯å´ä¸deferæœ‰è”ç³»ï¼Œæ‰€ä»¥ä¹Ÿç®—æ˜¯deferå¿…å¤‡äº†è§£çš„çŸ¥è¯†ç‚¹ä¹‹ä¸€ã€‚</p><p>å¦‚ ï¼š <code>func DeferFunc1(i int) (t int) &#123;&#125;</code><br>å…¶ä¸­è¿”å›å€¼<code>t int</code>ï¼Œè¿™ä¸ª<code>t</code>ä¼šåœ¨å‡½æ•°èµ·å§‹å¤„è¢«åˆå§‹åŒ–ä¸ºå¯¹åº”ç±»å‹çš„é›¶å€¼å¹¶ä¸”ä½œç”¨åŸŸä¸ºæ•´ä¸ªå‡½æ•°ã€‚</p><p><img src="/2025/04/01/Golang%E4%B8%AD%E7%9A%84Defer%E5%BF%85%E6%8E%8C%E6%8F%A1%E7%9A%847%E7%9F%A5%E8%AF%86%E7%82%B9/1651037374393-f3e9c019-5990-41a0-8774-d73d0a805a25.png" alt="img"></p><p>ç¤ºä¾‹ä»£ç :</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DeferFunc1</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> (t <span class="hljs-type">int</span>) &#123;<br><br>    fmt.Println(<span class="hljs-string">&quot;t = &quot;</span>, t)<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    DeferFunc11(<span class="hljs-number">10</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“æœ:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">t =  <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>è¯æ˜ï¼Œ<strong>åªè¦å£°æ˜å‡½æ•°çš„è¿”å›å€¼å˜é‡åç§°ï¼Œå°±ä¼šåœ¨å‡½æ•°åˆå§‹åŒ–æ—¶å€™ä¸ºä¹‹èµ‹å€¼ä¸º0ï¼Œè€Œä¸”åœ¨å‡½æ•°ä½“ä½œç”¨åŸŸå¯è§</strong>ã€‚</p><h3 id="çŸ¥è¯†ç‚¹4-æœ‰åå‡½æ•°è¿”å›å€¼é‡è§deferæƒ…å†µ"><a href="#çŸ¥è¯†ç‚¹4-æœ‰åå‡½æ•°è¿”å›å€¼é‡è§deferæƒ…å†µ" class="headerlink" title="çŸ¥è¯†ç‚¹4: æœ‰åå‡½æ•°è¿”å›å€¼é‡è§deferæƒ…å†µ"></a>çŸ¥è¯†ç‚¹4: æœ‰åå‡½æ•°è¿”å›å€¼é‡è§deferæƒ…å†µ</h3><p>åœ¨æ²¡æœ‰deferçš„æƒ…å†µä¸‹ï¼Œå…¶å®å‡½æ•°çš„è¿”å›å°±æ˜¯ä¸returnä¸€è‡´çš„ï¼Œä½†æ˜¯æœ‰äº†deferå°±ä¸ä¸€æ ·äº†ã€‚</p><p>æˆ‘ä»¬é€šè¿‡<strong>çŸ¥è¯†ç‚¹2</strong>å¾—çŸ¥ï¼Œå…ˆreturnï¼Œå†deferï¼Œæ‰€ä»¥åœ¨æ‰§è¡Œå®Œreturnä¹‹åï¼Œè¿˜è¦å†æ‰§è¡Œdeferé‡Œçš„è¯­å¥ï¼Œä¾ç„¶å¯ä»¥ä¿®æ”¹æœ¬åº”è¯¥è¿”å›çš„ç»“æœã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">returnButDefer</span><span class="hljs-params">()</span></span> (t <span class="hljs-type">int</span>) &#123;  <span class="hljs-comment">//tåˆå§‹åŒ–0ï¼Œ å¹¶ä¸”ä½œç”¨åŸŸä¸ºè¯¥å‡½æ•°å…¨åŸŸ</span><br><br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        t = t * <span class="hljs-number">10</span><br>    &#125;()<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    fmt.Println(returnButDefer())<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥<code>returnButDefer()</code>æœ¬åº”çš„è¿”å›å€¼æ˜¯<code>1</code>ï¼Œä½†æ˜¯åœ¨returnä¹‹åï¼Œåˆè¢«deferçš„åŒ¿åfuncå‡½æ•°æ‰§è¡Œï¼Œæ‰€ä»¥<code>t=t*10</code>è¢«æ‰§è¡Œï¼Œæœ€å<code>returnButDefer()</code>è¿”å›ç»™ä¸Šå±‚<code>main()</code>çš„ç»“æœä¸º<code>10</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ go run test.go<br>10<br></code></pre></td></tr></table></figure><h3 id="çŸ¥è¯†ç‚¹5-deferé‡è§panic"><a href="#çŸ¥è¯†ç‚¹5-deferé‡è§panic" class="headerlink" title="çŸ¥è¯†ç‚¹5: deferé‡è§panic"></a>çŸ¥è¯†ç‚¹5: deferé‡è§panic</h3><p>æˆ‘ä»¬çŸ¥é“ï¼Œèƒ½å¤Ÿè§¦å‘deferçš„æ˜¯é‡è§return(æˆ–å‡½æ•°ä½“åˆ°æœ«å°¾)å’Œé‡è§panicã€‚</p><p>æ ¹æ®<strong>çŸ¥è¯†ç‚¹2</strong>ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œdeferé‡è§returnæƒ…å†µå¦‚ä¸‹ï¼š</p><p><img src="/2025/04/01/Golang%E4%B8%AD%E7%9A%84Defer%E5%BF%85%E6%8E%8C%E6%8F%A1%E7%9A%847%E7%9F%A5%E8%AF%86%E7%82%B9/1651037399517-3b0df721-59da-4ce2-8cd2-2c178b7fa355.jpeg" alt="img"></p><p>é‚£ä¹ˆï¼Œé‡åˆ°panicæ—¶ï¼Œéå†æœ¬åç¨‹çš„deferé“¾è¡¨ï¼Œå¹¶æ‰§è¡Œdeferã€‚åœ¨æ‰§è¡Œdeferè¿‡ç¨‹ä¸­:é‡åˆ°recoveråˆ™åœæ­¢panicï¼Œè¿”å›recoverå¤„ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚å¦‚æœæ²¡æœ‰é‡åˆ°recoverï¼Œéå†å®Œæœ¬åç¨‹çš„deferé“¾è¡¨åï¼Œå‘stderræŠ›å‡ºpanicä¿¡æ¯ã€‚</p><p><img src="/2025/04/01/Golang%E4%B8%AD%E7%9A%84Defer%E5%BF%85%E6%8E%8C%E6%8F%A1%E7%9A%847%E7%9F%A5%E8%AF%86%E7%82%B9/1651037430519-67ffce42-f7eb-4698-8190-618c89274e2f.jpeg" alt="img"></p><h4 id="A-deferé‡è§panicï¼Œä½†æ˜¯å¹¶ä¸æ•è·å¼‚å¸¸çš„æƒ…å†µ"><a href="#A-deferé‡è§panicï¼Œä½†æ˜¯å¹¶ä¸æ•è·å¼‚å¸¸çš„æƒ…å†µ" class="headerlink" title="A. deferé‡è§panicï¼Œä½†æ˜¯å¹¶ä¸æ•è·å¼‚å¸¸çš„æƒ…å†µ"></a>A. deferé‡è§panicï¼Œä½†æ˜¯å¹¶ä¸æ•è·å¼‚å¸¸çš„æƒ…å†µ</h4><p>test10.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    defer_call()<br><br>    fmt.Println(<span class="hljs-string">&quot;main æ­£å¸¸ç»“æŸ&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">defer_call</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; fmt.Println(<span class="hljs-string">&quot;defer: panic ä¹‹å‰1&quot;</span>) &#125;()<br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; fmt.Println(<span class="hljs-string">&quot;defer: panic ä¹‹å‰2&quot;</span>) &#125;()<br><br>    <span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;å¼‚å¸¸å†…å®¹&quot;</span>)  <span class="hljs-comment">//è§¦å‘deferå‡ºæ ˆ</span><br><br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; fmt.Println(<span class="hljs-string">&quot;defer: panic ä¹‹åï¼Œæ°¸è¿œæ‰§è¡Œä¸åˆ°&quot;</span>) &#125;()<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ç»“æœ</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">defer: panic ä¹‹å‰2<br>defer: panic ä¹‹å‰1<br>panic: å¼‚å¸¸å†…å®¹<br>//... å¼‚å¸¸å †æ ˆä¿¡æ¯<br></code></pre></td></tr></table></figure><h4 id="B-deferé‡è§panicï¼Œå¹¶æ•è·å¼‚å¸¸"><a href="#B-deferé‡è§panicï¼Œå¹¶æ•è·å¼‚å¸¸" class="headerlink" title="B. deferé‡è§panicï¼Œå¹¶æ•è·å¼‚å¸¸"></a>B. deferé‡è§panicï¼Œå¹¶æ•è·å¼‚å¸¸</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    defer_call()<br><br>    fmt.Println(<span class="hljs-string">&quot;main æ­£å¸¸ç»“æŸ&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">defer_call</span><span class="hljs-params">()</span></span> &#123;<br><br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;defer: panic ä¹‹å‰1, æ•è·å¼‚å¸¸&quot;</span>)<br>        <span class="hljs-keyword">if</span> err := <span class="hljs-built_in">recover</span>(); err != <span class="hljs-literal">nil</span> &#123;<br>            fmt.Println(err)<br>        &#125;<br>    &#125;()<br><br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; fmt.Println(<span class="hljs-string">&quot;defer: panic ä¹‹å‰2, ä¸æ•è·&quot;</span>) &#125;()<br><br>    <span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;å¼‚å¸¸å†…å®¹&quot;</span>)  <span class="hljs-comment">//è§¦å‘deferå‡ºæ ˆ</span><br><br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; fmt.Println(<span class="hljs-string">&quot;defer: panic ä¹‹å, æ°¸è¿œæ‰§è¡Œä¸åˆ°&quot;</span>) &#125;()<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ç»“æœ</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">defer</span>: <span class="hljs-built_in">panic</span> ä¹‹å‰<span class="hljs-number">2</span>, ä¸æ•è·<br><span class="hljs-keyword">defer</span>: <span class="hljs-built_in">panic</span> ä¹‹å‰<span class="hljs-number">1</span>, æ•è·å¼‚å¸¸<br>å¼‚å¸¸å†…å®¹<br>main æ­£å¸¸ç»“æŸ<br></code></pre></td></tr></table></figure><p><strong>defer æœ€å¤§çš„åŠŸèƒ½æ˜¯ panic åä¾ç„¶æœ‰æ•ˆ</strong><br>æ‰€ä»¥deferå¯ä»¥ä¿è¯ä½ çš„ä¸€äº›èµ„æºä¸€å®šä¼šè¢«å…³é—­ï¼Œä»è€Œé¿å…ä¸€äº›å¼‚å¸¸å‡ºç°çš„é—®é¢˜ã€‚</p><h3 id="çŸ¥è¯†ç‚¹6-deferä¸­åŒ…å«panic"><a href="#çŸ¥è¯†ç‚¹6-deferä¸­åŒ…å«panic" class="headerlink" title="çŸ¥è¯†ç‚¹6: deferä¸­åŒ…å«panic"></a>çŸ¥è¯†ç‚¹6: deferä¸­åŒ…å«panic</h3><p>ç¼–è¯‘æ‰§è¡Œä¸‹é¢ä»£ç ä¼šå‡ºç°ä»€ä¹ˆ?</p><p>test16.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>  &#123;<br><br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>       <span class="hljs-keyword">if</span> err := <span class="hljs-built_in">recover</span>(); err != <span class="hljs-literal">nil</span>&#123;<br>           fmt.Println(err)<br>       &#125;<span class="hljs-keyword">else</span> &#123;<br>           fmt.Println(<span class="hljs-string">&quot;fatal&quot;</span>)<br>       &#125;<br>    &#125;()<br><br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        <span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;defer panic&quot;</span>)<br>    &#125;()<br><br>    <span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;panic&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ç»“æœ</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">defer panic<br></code></pre></td></tr></table></figure><p><strong>åˆ†æ</strong></p><p><strong>panicä»…æœ‰æœ€åä¸€ä¸ªå¯ä»¥è¢«revoveræ•è·</strong>ã€‚</p><p>è§¦å‘<code>panic(&quot;panic&quot;)</code>ådeferé¡ºåºå‡ºæ ˆæ‰§è¡Œï¼Œç¬¬ä¸€ä¸ªè¢«æ‰§è¡Œçš„deferä¸­ ä¼šæœ‰<code>panic(&quot;defer panic&quot;)</code>å¼‚å¸¸è¯­å¥ï¼Œè¿™ä¸ªå¼‚å¸¸å°†ä¼šè¦†ç›–æ‰mainä¸­çš„å¼‚å¸¸<code>panic(&quot;panic&quot;)</code>ï¼Œæœ€åè¿™ä¸ªå¼‚å¸¸è¢«ç¬¬äºŒä¸ªæ‰§è¡Œçš„deferæ•è·åˆ°ã€‚</p><h3 id="çŸ¥è¯†ç‚¹7-deferä¸‹çš„å‡½æ•°å‚æ•°åŒ…å«å­å‡½æ•°"><a href="#çŸ¥è¯†ç‚¹7-deferä¸‹çš„å‡½æ•°å‚æ•°åŒ…å«å­å‡½æ•°" class="headerlink" title="çŸ¥è¯†ç‚¹7: deferä¸‹çš„å‡½æ•°å‚æ•°åŒ…å«å­å‡½æ•°"></a>çŸ¥è¯†ç‚¹7: deferä¸‹çš„å‡½æ•°å‚æ•°åŒ…å«å­å‡½æ•°</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">function</span><span class="hljs-params">(index <span class="hljs-type">int</span>, value <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br><br>    fmt.Println(index)<br><br>    <span class="hljs-keyword">return</span> index<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">defer</span> function(<span class="hljs-number">1</span>, function(<span class="hljs-number">3</span>, <span class="hljs-number">0</span>))<br>    <span class="hljs-keyword">defer</span> function(<span class="hljs-number">2</span>, function(<span class="hljs-number">4</span>, <span class="hljs-number">0</span>))<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œæœ‰4ä¸ªå‡½æ•°ï¼Œä»–ä»¬çš„indexåºå·åˆ†åˆ«ä¸º1ï¼Œ2ï¼Œ3ï¼Œ4ã€‚</p><p>é‚£ä¹ˆè¿™4ä¸ªå‡½æ•°çš„å…ˆåæ‰§è¡Œé¡ºåºæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè¿™é‡Œé¢æœ‰ä¸¤ä¸ªdeferï¼Œ æ‰€ä»¥deferä¸€å…±ä¼šå‹æ ˆä¸¤æ¬¡ï¼Œå…ˆè¿›æ ˆ1ï¼Œåè¿›æ ˆ2ã€‚ é‚£ä¹ˆåœ¨å‹æ ˆfunction1çš„æ—¶å€™ï¼Œéœ€è¦è¿åŒå‡½æ•°åœ°å€ã€å‡½æ•°å½¢å‚ä¸€åŒè¿›æ ˆï¼Œé‚£ä¹ˆä¸ºäº†å¾—åˆ°function1çš„ç¬¬äºŒä¸ªå‚æ•°çš„ç»“æœï¼Œæ‰€ä»¥å°±éœ€è¦å…ˆæ‰§è¡Œfunction3å°†ç¬¬äºŒä¸ªå‚æ•°ç®—å‡ºï¼Œé‚£ä¹ˆfunction3å°±è¢«ç¬¬ä¸€ä¸ªæ‰§è¡Œã€‚åŒç†å‹æ ˆfunction2ï¼Œå°±éœ€è¦æ‰§è¡Œfunction4ç®—å‡ºfunction2ç¬¬äºŒä¸ªå‚æ•°çš„å€¼ã€‚ç„¶åå‡½æ•°ç»“æŸï¼Œå…ˆå‡ºæ ˆfuction2ã€å†å‡ºæ ˆfunction1.</p><p>æ‰€ä»¥é¡ºåºå¦‚ä¸‹ï¼š</p><ul><li>deferå‹æ ˆfunction1ï¼Œå‹æ ˆå‡½æ•°åœ°å€ã€å½¢å‚1ã€å½¢å‚2(è°ƒç”¨function3) â€“&gt; æ‰“å°3</li><li>deferå‹æ ˆfunction2ï¼Œå‹æ ˆå‡½æ•°åœ°å€ã€å½¢å‚1ã€å½¢å‚2(è°ƒç”¨function4) â€“&gt; æ‰“å°4</li><li>deferå‡ºæ ˆfunction2, è°ƒç”¨function2 â€“&gt; æ‰“å°2</li><li>deferå‡ºæ ˆfunction1, è°ƒç”¨function1â€“&gt; æ‰“å°1</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">3<br>4<br>2<br>1<br></code></pre></td></tr></table></figure><h3 id="ç»ƒä¹ ï¼šdeferé¢è¯•çœŸé¢˜"><a href="#ç»ƒä¹ ï¼šdeferé¢è¯•çœŸé¢˜" class="headerlink" title="ç»ƒä¹ ï¼šdeferé¢è¯•çœŸé¢˜"></a>ç»ƒä¹ ï¼šdeferé¢è¯•çœŸé¢˜</h3><p>äº†è§£ä»¥ä¸Š6ä¸ªdeferçš„çŸ¥è¯†ç‚¹ï¼Œæˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ç½‘ä¸Šçš„çœŸé¢˜å§ã€‚</p><p>ä¸‹é¢ä»£ç è¾“å‡ºä»€ä¹ˆï¼Ÿ</p><p>test11.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DeferFunc1</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> (t <span class="hljs-type">int</span>) &#123;<br>    t = i<br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        t += <span class="hljs-number">3</span><br>    &#125;()<br>    <span class="hljs-keyword">return</span> t<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DeferFunc2</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    t := i<br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        t += <span class="hljs-number">3</span><br>    &#125;()<br>    <span class="hljs-keyword">return</span> t<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DeferFunc3</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> (t <span class="hljs-type">int</span>) &#123;<br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        t += i<br>    &#125;()<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DeferFunc4</span><span class="hljs-params">()</span></span> (t <span class="hljs-type">int</span>) &#123;<br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> &#123;<br>        fmt.Println(i)<br>        fmt.Println(t)<br>    &#125;(t)<br>    t = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    fmt.Println(DeferFunc1(<span class="hljs-number">1</span>))<br>    fmt.Println(DeferFunc2(<span class="hljs-number">1</span>))<br>    fmt.Println(DeferFunc3(<span class="hljs-number">1</span>))<br>    DeferFunc4()<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ç»ƒä¹ é¢˜åˆ†æ"><a href="#ç»ƒä¹ é¢˜åˆ†æ" class="headerlink" title="ç»ƒä¹ é¢˜åˆ†æ"></a>ç»ƒä¹ é¢˜åˆ†æ</h3><h4 id="DeferFunc1"><a href="#DeferFunc1" class="headerlink" title="DeferFunc1"></a>DeferFunc1</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DeferFunc1</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> (t <span class="hljs-type">int</span>) &#123;<br>    t = i<br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        t += <span class="hljs-number">3</span><br>    &#125;()<br>    <span class="hljs-keyword">return</span> t<br>&#125;<br></code></pre></td></tr></table></figure><ol><li>å°†è¿”å›å€¼tèµ‹å€¼ä¸ºä¼ å…¥çš„iï¼Œæ­¤æ—¶tä¸º1</li><li>æ‰§è¡Œreturnè¯­å¥å°†tèµ‹å€¼ç»™tï¼ˆç­‰äºå•¥ä¹Ÿæ²¡åšï¼‰</li><li>æ‰§è¡Œdeferæ–¹æ³•ï¼Œå°†t + 3 &#x3D; 4</li><li>å‡½æ•°è¿”å› 4<br>å› ä¸ºtçš„ä½œç”¨åŸŸä¸ºæ•´ä¸ªå‡½æ•°æ‰€ä»¥ä¿®æ”¹æœ‰æ•ˆã€‚</li></ol><h4 id="DeferFunc2"><a href="#DeferFunc2" class="headerlink" title="DeferFunc2"></a>DeferFunc2</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DeferFunc2</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    t := i<br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        t += <span class="hljs-number">3</span><br>    &#125;()<br>    <span class="hljs-keyword">return</span> t<br>&#125;<br></code></pre></td></tr></table></figure><ol><li>åˆ›å»ºå˜é‡tå¹¶èµ‹å€¼ä¸º1</li><li>æ‰§è¡Œreturnè¯­å¥ï¼Œæ³¨æ„è¿™é‡Œæ˜¯å°†tèµ‹å€¼ç»™è¿”å›å€¼ï¼Œæ­¤æ—¶è¿”å›å€¼ä¸º1ï¼ˆè¿™ä¸ªè¿”å›å€¼å¹¶ä¸æ˜¯tï¼‰</li><li>æ‰§è¡Œdeferæ–¹æ³•ï¼Œå°†t + 3 &#x3D; 4</li><li>å‡½æ•°è¿”å›è¿”å›å€¼1</li></ol><p>ä¹Ÿå¯ä»¥æŒ‰ç…§å¦‚ä¸‹ä»£ç ç†è§£:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DeferFunc2</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> (result <span class="hljs-type">int</span>) &#123;<br>    t := i<br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        t += <span class="hljs-number">3</span><br>    &#125;()<br>    <span class="hljs-keyword">return</span> t<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç returnçš„æ—¶å€™ç›¸å½“äºå°†tèµ‹å€¼ç»™äº†resultï¼Œå½“deferä¿®æ”¹äº†tçš„å€¼ä¹‹åï¼Œå¯¹resultæ˜¯ä¸ä¼šé€ æˆå½±å“çš„ã€‚</p><h4 id="DeferFunc3"><a href="#DeferFunc3" class="headerlink" title="DeferFunc3"></a>DeferFunc3</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DeferFunc3</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> (t <span class="hljs-type">int</span>) &#123;<br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        t += i<br>    &#125;()<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span><br>&#125;<br></code></pre></td></tr></table></figure><ol><li>é¦–å…ˆæ‰§è¡Œreturnå°†è¿”å›å€¼tèµ‹å€¼ä¸º2</li><li>æ‰§è¡Œdeferæ–¹æ³•å°†t + 1</li><li>æœ€åè¿”å› 3</li></ol><h4 id="DeferFunc4"><a href="#DeferFunc4" class="headerlink" title="DeferFunc4"></a>DeferFunc4</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DeferFunc4</span><span class="hljs-params">()</span></span> (t <span class="hljs-type">int</span>) &#123;<br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> &#123;<br>        fmt.Println(i)<br>        fmt.Println(t)<br>    &#125;(t)<br>    t = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span><br>&#125;<br></code></pre></td></tr></table></figure><ol><li>åˆå§‹åŒ–è¿”å›å€¼tä¸ºé›¶å€¼ 0</li><li>é¦–å…ˆæ‰§è¡Œdeferçš„ç¬¬ä¸€æ­¥ï¼Œèµ‹å€¼deferä¸­çš„funcå…¥å‚tä¸º0</li><li>æ‰§è¡Œdeferçš„ç¬¬äºŒæ­¥ï¼Œå°†deferå‹æ ˆ</li><li>å°†tèµ‹å€¼ä¸º1</li><li>æ‰§è¡Œreturnè¯­å¥ï¼Œå°†è¿”å›å€¼tèµ‹å€¼ä¸º2</li><li>æ‰§è¡Œdeferçš„ç¬¬ä¸‰æ­¥ï¼Œå‡ºæ ˆå¹¶æ‰§è¡Œ<br>å› ä¸ºåœ¨å…¥æ ˆæ—¶deferæ‰§è¡Œçš„funcçš„å…¥å‚å·²ç»èµ‹å€¼äº†ï¼Œæ­¤æ—¶å®ƒä½œä¸ºçš„æ˜¯ä¸€ä¸ªå½¢å¼å‚æ•°ï¼Œæ‰€ä»¥æ‰“å°ä¸º0ï¼›ç›¸å¯¹åº”çš„å› ä¸ºæœ€åå·²ç»å°†tçš„å€¼ä¿®æ”¹ä¸º2ï¼Œæ‰€ä»¥å†æ‰“å°ä¸€ä¸ª2</li></ol><h4 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a><strong>ç»“æœ</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">4<br>1<br>3<br>0<br>2<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Golang</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ·±å…¥ç†è§£client-goä¸­çš„indexer</title>
    <link href="/2025/04/01/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3client-go%E4%B8%AD%E7%9A%84indexer/"/>
    <url>/2025/04/01/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3client-go%E4%B8%AD%E7%9A%84indexer/</url>
    
    <content type="html"><![CDATA[<h1 id="æ·±å…¥ç†è§£client-goä¸­çš„indexer"><a href="#æ·±å…¥ç†è§£client-goä¸­çš„indexer" class="headerlink" title="æ·±å…¥ç†è§£client-goä¸­çš„indexer"></a>æ·±å…¥ç†è§£client-goä¸­çš„indexer</h1><p>è½¬è‡ªï¼š<a href="https://cloud.tencent.com/developer/article/1692517?cps_key=1d358d18a7a17b4a6df8d67a62fd3d3d">https://cloud.tencent.com/developer/article/1692517?cps_key=1d358d18a7a17b4a6df8d67a62fd3d3d</a></p><p><img src="/2025/04/01/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3client-go%E4%B8%AD%E7%9A%84indexer/640.png" alt="å›¾ç‰‡"></p><p>å‰é¢æˆ‘ä»¬è®²åˆ° <a href="https://cloud.tencent.com/developer/tools/blog-entry?target=http://mp.weixin.qq.com/s?__biz=MzU4MjQ0MTU4Ng==&mid=2247485864&idx=1&sn=2011dfed276fe75a767d1e55f7d979ce&chksm=fdb906b5cace8fa3a01b911ac1004f6d6b57d8e0ae0d9a0e0746cdfa988947cc0e37ad2a980c&scene=21%23wechat_redirect&objectId=1692517&objectType=1&isNewArticle=undefined">DeltaFIFO ä¸­çš„å…ƒç´ é€šè¿‡ Pop å‡½æ•°å¼¹å‡ºå</a>ï¼Œåœ¨æŒ‡å®šçš„å›è°ƒå‡½æ•°ä¸­å°†å…ƒç´ æ·»åŠ åˆ°äº† Indexer ä¸­ã€‚Indexer æ˜¯ä»€ä¹ˆï¼Ÿå­—é¢æ„æ€æ˜¯ç´¢å¼•å™¨ï¼Œå®ƒå°±æ˜¯ Informer ä¸­çš„ LocalStore éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¯ä»¥å’Œ<a href="https://cloud.tencent.com/product/tencentdb-catalog?from_column=20065&from=20065">æ•°æ®åº“</a>è¿›è¡Œç±»æ¯”ï¼Œæ•°æ®åº“æ˜¯å»ºç«‹åœ¨å­˜å‚¨ä¹‹ä¸Šçš„ï¼Œç´¢å¼•ä¹Ÿæ˜¯æ„å»ºåœ¨å­˜å‚¨ä¹‹ä¸Šï¼Œåªæ˜¯å’Œæ•°æ®åšäº†ä¸€ä¸ªæ˜ å°„ï¼Œä½¿å¾—æŒ‰ç…§æŸäº›æ¡ä»¶æŸ¥è¯¢é€Ÿåº¦ä¼šéå¸¸å¿«ï¼Œæ‰€ä»¥è¯´ Indexer æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå­˜å‚¨ï¼Œåªæ˜¯å®ƒåœ¨å­˜å‚¨çš„åŸºç¡€ä¸Šæ‰©å±•äº†ç´¢å¼•åŠŸèƒ½ã€‚ä» Indexer æ¥å£çš„å®šä¹‰å¯ä»¥è¯æ˜è¿™ä¸€ç‚¹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// k8s.io/client-go/tools/cache/indexer.go</span><br><br><span class="hljs-comment">// Indexer ä½¿ç”¨å¤šä¸ªç´¢å¼•æ‰©å±•äº† Storeï¼Œå¹¶é™åˆ¶äº†æ¯ä¸ªç´¯åŠ å™¨åªèƒ½å®¹çº³å½“å‰å¯¹è±¡</span><br><span class="hljs-comment">// è¿™é‡Œæœ‰3ç§å­—ç¬¦ä¸²éœ€è¦è¯´æ˜ï¼š</span><br><span class="hljs-comment">// 1. ä¸€ä¸ªå­˜å‚¨é”®ï¼Œåœ¨ Store æ¥å£ä¸­å®šä¹‰ï¼ˆå…¶å®å°±æ˜¯å¯¹è±¡é”®ï¼‰</span><br><span class="hljs-comment">// 2. ä¸€ä¸ªç´¢å¼•çš„åç§°ï¼ˆç›¸å½“äºç´¢å¼•åˆ†ç±»åç§°ï¼‰</span><br><span class="hljs-comment">// 3. ç´¢å¼•é”®ï¼Œç”± IndexFunc ç”Ÿæˆï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªå­—æ®µå€¼æˆ–ä»å¯¹è±¡ä¸­è®¡ç®—å‡ºæ¥çš„ä»»ä½•å­—ç¬¦ä¸²</span><br><span class="hljs-keyword">type</span> Indexer <span class="hljs-keyword">interface</span> &#123;<br> Store  <span class="hljs-comment">// ç»§æ‰¿äº† Store å­˜å‚¨æ¥å£ï¼Œæ‰€ä»¥è¯´ Indexer ä¹Ÿæ˜¯å­˜å‚¨</span><br> <span class="hljs-comment">// indexName æ˜¯ç´¢å¼•ç±»åç§°ï¼Œobj æ˜¯å¯¹è±¡ï¼Œè®¡ç®— obj åœ¨ indexName ç´¢å¼•ç±»ä¸­çš„ç´¢å¼•é”®ï¼Œç„¶åé€šè¿‡ç´¢å¼•é”®æŠŠæ‰€æœ‰çš„å¯¹è±¡å–å‡ºæ¥</span><br>  <span class="hljs-comment">// è·å– obj å¯¹è±¡åœ¨ç´¢å¼•ç±»ä¸­çš„ç´¢å¼•é”®ç›¸åŒ¹é…çš„å¯¹è±¡</span><br> Index(indexName <span class="hljs-type">string</span>, obj <span class="hljs-keyword">interface</span>&#123;&#125;) ([]<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-type">error</span>)<br> <span class="hljs-comment">// indexKey æ˜¯ indexName ç´¢å¼•åˆ†ç±»ä¸­çš„ä¸€ä¸ªç´¢å¼•é”®</span><br>  <span class="hljs-comment">// å‡½æ•°è¿”å› indexKey æŒ‡å®šçš„æ‰€æœ‰å¯¹è±¡é”® IndexKeys </span><br> IndexKeys(indexName, indexedValue <span class="hljs-type">string</span>) ([]<span class="hljs-type">string</span>, <span class="hljs-type">error</span>)<br> ListIndexFuncValues(indexName <span class="hljs-type">string</span>) []<span class="hljs-type">string</span><br> ByIndex(indexName, indexedValue <span class="hljs-type">string</span>) ([]<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-type">error</span>)<br> GetIndexers() Indexers<br> <span class="hljs-comment">// æ·»åŠ æ–°çš„ç´¢å¼•åœ¨å­˜å‚¨ä¸­</span><br> AddIndexers(newIndexers Indexers) <span class="hljs-type">error</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Indexer"><a href="#Indexer" class="headerlink" title="Indexer"></a><strong>Indexer</strong></h3><p>åœ¨å»æŸ¥çœ‹ Indexer çš„æ¥å£å…·ä½“å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ Indexer ä¸­å‡ ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼š<code>Indices</code>ã€<code>Index</code>ã€<code>Indexers</code> åŠ <code>IndexFunc</code>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// k8s.io/client-go/tools/cache/indexer.go</span><br><br><span class="hljs-comment">// ç”¨äºè®¡ç®—ä¸€ä¸ªå¯¹è±¡çš„ç´¢å¼•é”®é›†åˆ</span><br><span class="hljs-keyword">type</span> IndexFunc <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(obj <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> ([]<span class="hljs-type">string</span>, <span class="hljs-type">error</span>)<br><br><span class="hljs-comment">// ç´¢å¼•é”®ä¸å¯¹è±¡é”®é›†åˆçš„æ˜ å°„</span><br><span class="hljs-keyword">type</span> Index <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]sets.String<br><br><span class="hljs-comment">// ç´¢å¼•å™¨åç§°ï¼ˆæˆ–è€…ç´¢å¼•åˆ†ç±»ï¼‰ä¸ IndexFunc çš„æ˜ å°„ï¼Œç›¸å½“äºå­˜å‚¨ç´¢å¼•çš„å„ç§åˆ†ç±»</span><br><span class="hljs-keyword">type</span> Indexers <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]IndexFunc<br><br><span class="hljs-comment">// ç´¢å¼•å™¨åç§°ä¸ Index ç´¢å¼•çš„æ˜ å°„</span><br><span class="hljs-keyword">type</span> Indices <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]Index<br></code></pre></td></tr></table></figure><p>è¿™4ä¸ªæ•°æ®ç»“æ„çš„å‘½åéå¸¸å®¹æ˜“è®©å¤§å®¶æ··æ·†ï¼Œç›´æ¥æŸ¥çœ‹æºç ä¹Ÿä¸æ˜¯é‚£ä¹ˆå®¹æ˜“çš„ã€‚è¿™é‡Œæˆ‘ä»¬æ¥ä»”ç»†è§£é‡Šä¸‹ã€‚é¦–å…ˆä»€ä¹ˆå«ç´¢å¼•ï¼Œç´¢å¼•å°±æ˜¯ä¸ºäº†å¿«é€ŸæŸ¥æ‰¾çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬éœ€è¦æŸ¥æ‰¾æŸä¸ªèŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰ Podï¼Œé‚£å°±è®© Pod æŒ‰ç…§èŠ‚ç‚¹åç§°æ’åºåˆ—ä¸¾å‡ºæ¥ï¼Œå¯¹åº”çš„å°±æ˜¯ Index è¿™ä¸ªç±»å‹ï¼Œå…·ä½“çš„å°±æ˜¯ <code>map[node]sets.pod</code>ï¼Œä½†æ˜¯å¦‚ä½•å»æŸ¥æ‰¾å¯ä»¥æœ‰å¤šç§æ–¹å¼ï¼Œå°±æ˜¯ä¸Šé¢çš„ Indexers è¿™ä¸ªç±»å‹çš„ä½œç”¨ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªæ¯”è¾ƒå…·ä½“çš„ç¤ºä¾‹æ¥è§£é‡Šä»–ä»¬çš„å…³ç³»å’Œå«ä¹‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br> <span class="hljs-string">&quot;fmt&quot;</span><br><br> v1 <span class="hljs-string">&quot;k8s.io/api/core/v1&quot;</span><br> <span class="hljs-string">&quot;k8s.io/apimachinery/pkg/api/meta&quot;</span><br> metav1 <span class="hljs-string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span><br> <span class="hljs-string">&quot;k8s.io/client-go/tools/cache&quot;</span><br>)<br><br><span class="hljs-keyword">const</span> (<br> NamespaceIndexName = <span class="hljs-string">&quot;namespace&quot;</span><br> NodeNameIndexName  = <span class="hljs-string">&quot;nodeName&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NamespaceIndexFunc</span><span class="hljs-params">(obj <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> ([]<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) &#123;<br> m, err := meta.Accessor(obj)<br> <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>  <span class="hljs-keyword">return</span> []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;&quot;</span>&#125;, fmt.Errorf(<span class="hljs-string">&quot;object has no meta: %v&quot;</span>, err)<br> &#125;<br> <span class="hljs-keyword">return</span> []<span class="hljs-type">string</span>&#123;m.GetNamespace()&#125;, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NodeNameIndexFunc</span><span class="hljs-params">(obj <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> ([]<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) &#123;<br> pod, ok := obj.(*v1.Pod)<br> <span class="hljs-keyword">if</span> !ok &#123;<br>  <span class="hljs-keyword">return</span> []<span class="hljs-type">string</span>&#123;&#125;, <span class="hljs-literal">nil</span><br> &#125;<br> <span class="hljs-keyword">return</span> []<span class="hljs-type">string</span>&#123;pod.Spec.NodeName&#125;, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br> index := cache.NewIndexer(cache.MetaNamespaceKeyFunc, cache.Indexers&#123;<br>  NamespaceIndexName: NamespaceIndexFunc,<br>  NodeNameIndexName:  NodeNameIndexFunc,<br> &#125;)<br><br> pod1 := &amp;v1.Pod&#123;<br>  ObjectMeta: metav1.ObjectMeta&#123;<br>   Name:      <span class="hljs-string">&quot;index-pod-1&quot;</span>,<br>   Namespace: <span class="hljs-string">&quot;default&quot;</span>,<br>  &#125;,<br>  Spec: v1.PodSpec&#123;NodeName: <span class="hljs-string">&quot;node1&quot;</span>&#125;,<br> &#125;<br> pod2 := &amp;v1.Pod&#123;<br>  ObjectMeta: metav1.ObjectMeta&#123;<br>   Name:      <span class="hljs-string">&quot;index-pod-2&quot;</span>,<br>   Namespace: <span class="hljs-string">&quot;default&quot;</span>,<br>  &#125;,<br>  Spec: v1.PodSpec&#123;NodeName: <span class="hljs-string">&quot;node2&quot;</span>&#125;,<br> &#125;<br> pod3 := &amp;v1.Pod&#123;<br>  ObjectMeta: metav1.ObjectMeta&#123;<br>   Name:      <span class="hljs-string">&quot;index-pod-3&quot;</span>,<br>   Namespace: <span class="hljs-string">&quot;kube-system&quot;</span>,<br>  &#125;,<br>  Spec: v1.PodSpec&#123;NodeName: <span class="hljs-string">&quot;node2&quot;</span>&#125;,<br> &#125;<br><br> _ = index.Add(pod1)<br> _ = index.Add(pod2)<br> _ = index.Add(pod3)<br><br> <span class="hljs-comment">// ByIndex ä¸¤ä¸ªå‚æ•°ï¼šIndexNameï¼ˆç´¢å¼•å™¨åç§°ï¼‰å’Œ indexKeyï¼ˆéœ€è¦æ£€ç´¢çš„keyï¼‰</span><br> pods, err := index.ByIndex(NamespaceIndexName, <span class="hljs-string">&quot;default&quot;</span>)<br> <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>  <span class="hljs-built_in">panic</span>(err)<br> &#125;<br> <span class="hljs-keyword">for</span> _, pod := <span class="hljs-keyword">range</span> pods &#123;<br>  fmt.Println(pod.(*v1.Pod).Name)<br> &#125;<br><br> fmt.Println(<span class="hljs-string">&quot;==========================&quot;</span>)<br><br> pods, err = index.ByIndex(NodeNameIndexName, <span class="hljs-string">&quot;node2&quot;</span>)<br> <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>  <span class="hljs-built_in">panic</span>(err)<br> &#125;<br> <span class="hljs-keyword">for</span> _, pod := <span class="hljs-keyword">range</span> pods &#123;<br>  fmt.Println(pod.(*v1.Pod).Name)<br> &#125;<br><br>&#125;<br><br><span class="hljs-comment">// è¾“å‡ºç»“æœä¸ºï¼š</span><br>index-pod<span class="hljs-number">-1</span><br>index-pod<span class="hljs-number">-2</span><br>==========================<br>index-pod<span class="hljs-number">-2</span><br>index-pod<span class="hljs-number">-3</span><br></code></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­é¦–å…ˆé€šè¿‡ NewIndexer å‡½æ•°å®ä¾‹åŒ– Indexer å¯¹è±¡ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ç”¨äºè®¡ç®—èµ„æºå¯¹è±¡é”®çš„å‡½æ•°ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ <code>MetaNamespaceKeyFunc</code> è¿™ä¸ªé»˜è®¤çš„å¯¹è±¡é”®å‡½æ•°ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯ Indexersï¼Œä¹Ÿå°±æ˜¯å­˜å‚¨ç´¢å¼•å™¨ï¼Œä¸Šé¢æˆ‘ä»¬çŸ¥é“ <code>Indexers</code> çš„å®šä¹‰ä¸º <code>map[string]IndexFunc</code>ï¼Œä¸ºä»€ä¹ˆè¦å®šä¹‰æˆä¸€ä¸ª map å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ç±»æ¯”æ•°æ®åº“ä¸­ï¼Œæˆ‘ä»¬è¦æŸ¥è¯¢æŸé¡¹æ•°æ®ï¼Œç´¢å¼•çš„æ–¹å¼æ˜¯ä¸æ˜¯å¤šç§å¤šæ ·å•Šï¼Ÿä¸ºäº†æ‰©å±•ï¼ŒKubernetes ä¸­å°±ä½¿ç”¨ä¸€ä¸ª map æ¥å­˜å‚¨å„ç§å„æ ·çš„å­˜å‚¨ç´¢å¼•å™¨ï¼Œè‡³äºå­˜å‚¨ç´¢å¼•å™¨å¦‚ä½•ç”Ÿæˆï¼Œå°±ä½¿ç”¨ä¸€ä¸ª <code>IndexFunc</code> æš´éœ²å‡ºå»ï¼Œç»™ä½¿ç”¨è€…è‡ªå·±å®ç°å³å¯ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬å®šä¹‰çš„äº†ä¸¤ä¸ªç´¢å¼•é”®ç”Ÿæˆå‡½æ•°ï¼š<code>NamespaceIndexFunc</code> ä¸ <code>NodeNameIndexFunc</code>ï¼Œä¸€ä¸ªæ ¹æ®èµ„æºå¯¹è±¡çš„å‘½åç©ºé—´æ¥è¿›è¡Œç´¢å¼•ï¼Œä¸€ä¸ªæ ¹æ®èµ„æºå¯¹è±¡æ‰€åœ¨çš„èŠ‚ç‚¹è¿›è¡Œç´¢å¼•ã€‚ç„¶åå®šä¹‰äº†3ä¸ª Podï¼Œå‰ä¸¤ä¸ªåœ¨ default å‘½åç©ºé—´ä¸‹é¢ï¼Œå¦å¤–ä¸€ä¸ªåœ¨ kube-system å‘½åç©ºé—´ä¸‹é¢ï¼Œç„¶åé€šè¿‡ <code>index.Add</code> å‡½æ•°æ·»åŠ è¿™3ä¸ª Pod èµ„æºå¯¹è±¡ã€‚ç„¶åé€šè¿‡ <code>index.ByIndex</code> å‡½æ•°æŸ¥è¯¢åœ¨åä¸º <code>namespace</code> çš„ç´¢å¼•å™¨ä¸‹é¢åŒ¹é…ç´¢å¼•é”®ä¸º <code>default</code> çš„ Pod åˆ—è¡¨ã€‚ä¹Ÿå°±æ˜¯æŸ¥è¯¢ default è¿™ä¸ªå‘½åç©ºé—´ä¸‹é¢çš„æ‰€æœ‰ Podï¼Œè¿™é‡Œå°±æ˜¯å‰ä¸¤ä¸ªå®šä¹‰çš„ Podã€‚</p><p>å¯¹ä¸Šé¢çš„ç¤ºä¾‹å¦‚æœæˆ‘ä»¬ç†è§£äº†ï¼Œé‚£ä¹ˆå°±å¾ˆå®¹æ˜“ç†è§£ä¸Šé¢å®šä¹‰çš„4ä¸ªæ•°æ®ç»“æ„äº†ï¼š</p><ul><li>IndexFuncï¼šç´¢å¼•å™¨å‡½æ•°ï¼Œç”¨äºè®¡ç®—ä¸€ä¸ªèµ„æºå¯¹è±¡çš„ç´¢å¼•å€¼åˆ—è¡¨ï¼Œä¸Šé¢ç¤ºä¾‹æ˜¯æŒ‡å®šå‘½åç©ºé—´ä¸ºç´¢å¼•å€¼ç»“æœï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ ¹æ®éœ€æ±‚å®šä¹‰å…¶ä»–çš„ï¼Œæ¯”å¦‚æ ¹æ® Label æ ‡ç­¾ã€Annotation ç­‰å±æ€§æ¥ç”Ÿæˆç´¢å¼•å€¼åˆ—è¡¨ã€‚</li><li>Indexï¼šå­˜å‚¨æ•°æ®ï¼Œå¯¹äºä¸Šé¢çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬è¦æŸ¥æ‰¾æŸä¸ªå‘½åç©ºé—´ä¸‹é¢çš„ Podï¼Œé‚£å°±è¦è®© Pod æŒ‰ç…§å…¶å‘½åç©ºé—´è¿›è¡Œç´¢å¼•ï¼Œå¯¹åº”çš„ Index ç±»å‹å°±æ˜¯ <code>map[namespace]sets.pod</code>ã€‚</li><li>Indexersï¼šå­˜å‚¨ç´¢å¼•å™¨ï¼Œkey ä¸ºç´¢å¼•å™¨åç§°ï¼Œvalue ä¸ºç´¢å¼•å™¨çš„å®ç°å‡½æ•°ï¼Œä¸Šé¢çš„ç¤ºä¾‹å°±æ˜¯ <code>map[&quot;namespace&quot;]MetaNamespaceIndexFunc</code>ã€‚</li><li>Indicesï¼šå­˜å‚¨ç¼“å­˜å™¨ï¼Œkey ä¸ºç´¢å¼•å™¨åç§°ï¼Œvalue ä¸ºç¼“å­˜çš„æ•°æ®ï¼Œå¯¹äºä¸Šé¢çš„ç¤ºä¾‹å°±æ˜¯ <code>map[&quot;namespace&quot;]map[namespace]sets.pod</code>ã€‚</li></ul><p>å¯èƒ½æœ€å®¹æ˜“æ··æ·†çš„æ˜¯ Indexers å’Œ Indices è¿™ä¸¤ä¸ªæ¦‚å¿µï¼Œå› ä¸ºå¹³æ—¶å¾ˆå¤šæ—¶å€™æˆ‘ä»¬æ²¡æœ‰æ€ä¹ˆåŒºåˆ†äºŒè€…çš„å…³ç³»ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥è¿™æ ·ç†è§£ï¼šIndexers æ˜¯å­˜å‚¨ç´¢å¼•ï¼ˆç”Ÿæˆç´¢å¼•é”®ï¼‰çš„ï¼ŒIndices é‡Œé¢æ˜¯å­˜å‚¨çš„çœŸæ­£çš„æ•°æ®ï¼ˆå¯¹è±¡é”®ï¼‰ï¼Œè¿™æ ·å¯èƒ½æ›´å¥½ç†è§£ã€‚</p><p><img src="/2025/04/01/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3client-go%E4%B8%AD%E7%9A%84indexer/658k4cmdot.png" alt="img"></p><p><img src="/2025/04/01/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3client-go%E4%B8%AD%E7%9A%84indexer/640-1743599934675-3.webp" alt="å›¾ç‰‡"></p><p>æŒ‰ç…§ä¸Šé¢çš„ç†è§£æˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸Šé¢ç¤ºä¾‹çš„ç´¢å¼•æ•°æ®å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Indexers å°±æ˜¯åŒ…å«çš„æ‰€æœ‰ç´¢å¼•å™¨(åˆ†ç±»)ä»¥åŠå¯¹åº”å®ç°</span><br>Indexers: &#123;  <br>  <span class="hljs-string">&quot;namespace&quot;</span>: NamespaceIndexFunc,<br>  <span class="hljs-string">&quot;nodeName&quot;</span>: NodeNameIndexFunc,<br>&#125;<br><span class="hljs-comment">// Indices å°±æ˜¯åŒ…å«çš„æ‰€æœ‰ç´¢å¼•åˆ†ç±»ä¸­æ‰€æœ‰çš„ç´¢å¼•æ•°æ®</span><br>Indices: &#123;<br> <span class="hljs-string">&quot;namespace&quot;</span>: &#123;  <span class="hljs-comment">//namespace è¿™ä¸ªç´¢å¼•åˆ†ç±»ä¸‹çš„æ‰€æœ‰ç´¢å¼•æ•°æ®</span><br>  <span class="hljs-string">&quot;default&quot;</span>: [<span class="hljs-string">&quot;pod-1&quot;</span>, <span class="hljs-string">&quot;pod-2&quot;</span>],  <span class="hljs-comment">// Index å°±æ˜¯ä¸€ä¸ªç´¢å¼•é”®ä¸‹æ‰€æœ‰çš„å¯¹è±¡é”®åˆ—è¡¨</span><br>  <span class="hljs-string">&quot;kube-system&quot;</span>: [<span class="hljs-string">&quot;pod-3&quot;</span>]   <span class="hljs-comment">// Index</span><br> &#125;,<br> <span class="hljs-string">&quot;nodeName&quot;</span>: &#123;  <span class="hljs-comment">//nodeName è¿™ä¸ªç´¢å¼•åˆ†ç±»ä¸‹çš„æ‰€æœ‰ç´¢å¼•æ•°æ®(å¯¹è±¡é”®åˆ—è¡¨)</span><br>  <span class="hljs-string">&quot;node1&quot;</span>: [<span class="hljs-string">&quot;pod-1&quot;</span>],  <span class="hljs-comment">// Index</span><br>  <span class="hljs-string">&quot;node2&quot;</span>: [<span class="hljs-string">&quot;pod-2&quot;</span>, <span class="hljs-string">&quot;pod-3&quot;</span>]  <span class="hljs-comment">// Index</span><br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ThreadSafeMap"><a href="#ThreadSafeMap" class="headerlink" title="ThreadSafeMap"></a><strong>ThreadSafeMap</strong></h3><p>ä¸Šé¢æˆ‘ä»¬ç†è§£äº† Indexer ä¸­çš„å‡ ä¸ªé‡è¦çš„æ•°æ®ç±»å‹ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹ Indexer æ¥å£çš„å…·ä½“å®ç° cacheï¼Œä½äºæ–‡ä»¶ <code>k8s.io/client-go/tools/cache/store.go</code> ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// [k8s.io/client-go/tools/cache/store.go](http://k8s.io/client-go/tools/cache/store.go)</span><br><br><span class="hljs-comment">// cache ç”¨ä¸€ä¸ª ThreadSafeStore å’Œä¸€ä¸ªå…³è”çš„ KeyFunc æ¥å®ç° Indexer</span><br><span class="hljs-keyword">type</span> cache <span class="hljs-keyword">struct</span> &#123;<br> <span class="hljs-comment">// cacheStorage æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å­˜å‚¨</span><br> cacheStorage ThreadSafeStore<br>  <span class="hljs-comment">// keyFunc ç”¨äºè®¡ç®—å¯¹è±¡é”®</span><br> keyFunc KeyFunc<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ª cache åŒ…å«ä¸€ä¸ª <code>ThreadSafeStore</code> çš„å±æ€§ï¼Œè¿™æ˜¯ä¸€ä¸ªå¹¶å‘å®‰å…¨çš„å­˜å‚¨ï¼Œå› ä¸ºæ˜¯å­˜å‚¨ï¼Œæ‰€ä»¥è‡ªç„¶å°±æœ‰å­˜å‚¨ç›¸å…³çš„å¢ã€åˆ ã€æ”¹ã€æŸ¥ç­‰æ“ä½œï¼ŒIndexer å°±æ˜¯åœ¨ ThreadSafeMap åŸºç¡€ä¸Šè¿›è¡Œå°è£…çš„ï¼Œå®ç°äº†ç´¢å¼•ç›¸å…³çš„åŠŸèƒ½ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ ThreadSafeStore çš„å®šä¹‰ï¼Œä½äº <code>k8s.io/client-go/tools/cache/thread_safe_store.go</code> æ–‡ä»¶ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> ThreadSafeStore <span class="hljs-keyword">interface</span> &#123;<br> Add(key <span class="hljs-type">string</span>, obj <span class="hljs-keyword">interface</span>&#123;&#125;)<br> Update(key <span class="hljs-type">string</span>, obj <span class="hljs-keyword">interface</span>&#123;&#125;)<br> Delete(key <span class="hljs-type">string</span>)<br> Get(key <span class="hljs-type">string</span>) (item <span class="hljs-keyword">interface</span>&#123;&#125;, exists <span class="hljs-type">bool</span>)<br> List() []<span class="hljs-keyword">interface</span>&#123;&#125;<br> ListKeys() []<span class="hljs-type">string</span><br> Replace(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-type">string</span>)<br> Index(indexName <span class="hljs-type">string</span>, obj <span class="hljs-keyword">interface</span>&#123;&#125;) ([]<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-type">error</span>)<br> IndexKeys(indexName, indexKey <span class="hljs-type">string</span>) ([]<span class="hljs-type">string</span>, <span class="hljs-type">error</span>)<br> ListIndexFuncValues(name <span class="hljs-type">string</span>) []<span class="hljs-type">string</span><br> ByIndex(indexName, indexKey <span class="hljs-type">string</span>) ([]<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-type">error</span>)<br> GetIndexers() Indexers<br><br> AddIndexers(newIndexers Indexers) <span class="hljs-type">error</span><br> Resync() <span class="hljs-type">error</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä»æ¥å£çš„å®šä¹‰å¯ä»¥çœ‹å‡º ThreadSafeStore å’Œ Index åŸºæœ¬ä¸Šå·®ä¸å¤šï¼Œä½†è¿˜æ˜¯æœ‰ä¸€äº›åŒºåˆ«çš„ï¼Œè¿™ä¸ªæ¥å£æ˜¯éœ€è¦é€šè¿‡å¯¹è±¡é”®æ¥è¿›è¡Œç´¢å¼•çš„ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªæ¥å£çš„å…·ä½“å®ç° threadSafeMap çš„å®šä¹‰ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// k8s.io/client-go/tools/cache/thread_safe_store.go</span><br><br><span class="hljs-comment">// threadSafeMap å®ç°äº† ThreadSafeStore</span><br><span class="hljs-keyword">type</span> threadSafeMap <span class="hljs-keyword">struct</span> &#123;<br> lock  sync.RWMutex<br>  <span class="hljs-comment">// å­˜å‚¨èµ„æºå¯¹è±¡æ•°æ®ï¼Œkey(å¯¹è±¡é”®) é€šè¿‡ keyFunc å¾—åˆ°</span><br>  <span class="hljs-comment">// è¿™å°±æ˜¯çœŸæ­£å­˜å‚¨çš„æ•°æ®ï¼ˆå¯¹è±¡é”® -&gt; å¯¹è±¡ï¼‰</span><br> items <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;<br><br> <span class="hljs-comment">// indexers ç´¢å¼•åˆ†ç±»ä¸ç´¢å¼•é”®å‡½æ•°çš„æ˜ å°„</span><br> indexers Indexers<br> <span class="hljs-comment">// indices é€šè¿‡ç´¢å¼•å¯ä»¥å¿«é€Ÿæ‰¾åˆ°å¯¹è±¡é”®</span><br> indices Indices<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸è¦æŠŠç´¢å¼•é”®å’Œå¯¹è±¡é”®ææ··äº†ï¼Œç´¢å¼•é”®æ˜¯ç”¨äºå¯¹è±¡å¿«é€ŸæŸ¥æ‰¾çš„ï¼›å¯¹è±¡é”®æ˜¯å¯¹è±¡åœ¨å­˜å‚¨ä¸­çš„å”¯ä¸€å‘½åï¼Œå¯¹è±¡æ˜¯é€šè¿‡åå­—+å¯¹è±¡çš„æ–¹å¼å­˜å‚¨çš„ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä»”ç»†çœ‹ä¸‹æ¥å£çš„å…·ä½“å®ç°ï¼Œé¦–å…ˆè¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ Addã€Deleteã€Update å‡ ä¸ªå‡½æ•°çš„å®ç°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// k8s.io/client-go/tools/cache/thread_safe_store.go</span><br><br><span class="hljs-comment">// æ·»åŠ å¯¹è±¡</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *threadSafeMap)</span></span> Add(key <span class="hljs-type">string</span>, obj <span class="hljs-keyword">interface</span>&#123;&#125;) &#123;<br> c.lock.Lock()<br> <span class="hljs-keyword">defer</span> c.lock.Unlock()<br>  <span class="hljs-comment">// è·å–è€çš„å¯¹è±¡</span><br> oldObject := c.items[key]<br>  <span class="hljs-comment">// å†™å…¥æ–°çš„å¯¹è±¡ï¼Œitems ä¸­å­˜çš„æ˜¯ objKey -&gt; obj çš„æ˜ å°„</span><br> c.items[key] = obj<br>  <span class="hljs-comment">// æ·»åŠ äº†æ–°çš„å¯¹è±¡ï¼Œæ‰€ä»¥è¦æ›´æ–°ç´¢å¼•</span><br> c.updateIndices(oldObject, obj, key)<br>&#125;<br><br><span class="hljs-comment">// æ›´æ–°å¯¹è±¡ï¼Œå¯ä»¥çœ‹åˆ°å®ç°å’Œ Add æ˜¯ä¸€æ ·çš„</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *threadSafeMap)</span></span> Update(key <span class="hljs-type">string</span>, obj <span class="hljs-keyword">interface</span>&#123;&#125;) &#123;<br> c.lock.Lock()<br> <span class="hljs-keyword">defer</span> c.lock.Unlock()<br> oldObject := c.items[key]<br> c.items[key] = obj<br> c.updateIndices(oldObject, obj, key)<br>&#125;<br><br><span class="hljs-comment">// åˆ é™¤å¯¹è±¡</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *threadSafeMap)</span></span> Delete(key <span class="hljs-type">string</span>) &#123;<br> c.lock.Lock()<br> <span class="hljs-keyword">defer</span> c.lock.Unlock()<br>  <span class="hljs-comment">// åˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨æ‰æ‰§è¡Œåˆ é™¤æ“ä½œ</span><br> <span class="hljs-keyword">if</span> obj, exists := c.items[key]; exists &#123;<br>    <span class="hljs-comment">// åˆ é™¤å¯¹è±¡ç´¢å¼•</span><br>  c.deleteFromIndices(obj, key)<br>    <span class="hljs-comment">// åˆ é™¤å¯¹è±¡æœ¬èº«</span><br>  <span class="hljs-built_in">delete</span>(c.items, key)<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åŸºæœ¬çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯æ·»åŠ ã€æ›´æ–°ã€åˆ é™¤å¯¹è±¡æ•°æ®åï¼Œç„¶åæ›´æ–°æˆ–åˆ é™¤å¯¹åº”çš„ç´¢å¼•ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æŸ¥çœ‹ä¸‹æ›´æ–°æˆ–åˆ é™¤ç´¢å¼•çš„å…·ä½“å®ç°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// k8s.io/client-go/tools/cache/thread_safe_store.go</span><br><br><span class="hljs-comment">// updateIndices æ›´æ–°ç´¢å¼•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *threadSafeMap)</span></span> updateIndices(oldObj <span class="hljs-keyword">interface</span>&#123;&#125;, newObj <span class="hljs-keyword">interface</span>&#123;&#125;, key <span class="hljs-type">string</span>) &#123;<br> <span class="hljs-comment">// å¦‚æœæœ‰æ—§çš„å¯¹è±¡ï¼Œéœ€è¦å…ˆä»ç´¢å¼•ä¸­åˆ é™¤è¿™ä¸ªå¯¹è±¡</span><br> <span class="hljs-keyword">if</span> oldObj != <span class="hljs-literal">nil</span> &#123;<br>  c.deleteFromIndices(oldObj, key)<br> &#125;<br>  <span class="hljs-comment">// å¾ªç¯æ‰€æœ‰çš„ç´¢å¼•å™¨</span><br> <span class="hljs-keyword">for</span> name, indexFunc := <span class="hljs-keyword">range</span> c.indexers &#123;<br>    <span class="hljs-comment">// è·å–å¯¹è±¡çš„ç´¢å¼•é”®</span><br>  indexValues, err := indexFunc(newObj)<br>  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>   <span class="hljs-built_in">panic</span>(fmt.Errorf(<span class="hljs-string">&quot;unable to calculate an index entry for key %q on index %q: %v&quot;</span>, key, name, err))<br>  &#125;<br>    <span class="hljs-comment">// å¾—åˆ°å½“å‰ç´¢å¼•å™¨çš„ç´¢å¼•</span><br>  index := c.indices[name]<br>  <span class="hljs-keyword">if</span> index == <span class="hljs-literal">nil</span> &#123;<br>      <span class="hljs-comment">// æ²¡æœ‰å¯¹åº”çš„ç´¢å¼•ï¼Œåˆ™åˆå§‹åŒ–ä¸€ä¸ªç´¢å¼•</span><br>   index = Index&#123;&#125;<br>   c.indices[name] = index<br>  &#125;<br>    <span class="hljs-comment">// å¾ªç¯æ‰€æœ‰çš„ç´¢å¼•é”®</span><br>  <span class="hljs-keyword">for</span> _, indexValue := <span class="hljs-keyword">range</span> indexValues &#123;<br>      <span class="hljs-comment">// å¾—åˆ°ç´¢å¼•é”®å¯¹åº”çš„å¯¹è±¡é”®åˆ—è¡¨</span><br>   set := index[indexValue]<br>   <span class="hljs-keyword">if</span> set == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-comment">// æ²¡æœ‰å¯¹è±¡é”®åˆ—è¡¨åˆ™åˆå§‹åŒ–ä¸€ä¸ªç©ºåˆ—è¡¨</span><br>    set = sets.String&#123;&#125;<br>    index[indexValue] = set<br>   &#125;<br>      <span class="hljs-comment">// å°†å¯¹è±¡é”®æ’å…¥åˆ°é›†åˆä¸­ï¼Œæ–¹ä¾¿ç´¢å¼•</span><br>   set.Insert(key)<br>  &#125;<br> &#125;<br>&#125;<br><br><span class="hljs-comment">// deleteFromIndices åˆ é™¤å¯¹è±¡ç´¢å¼•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *threadSafeMap)</span></span> deleteFromIndices(obj <span class="hljs-keyword">interface</span>&#123;&#125;, key <span class="hljs-type">string</span>) &#123;<br> <span class="hljs-comment">// å¾ªç¯æ‰€æœ‰çš„ç´¢å¼•å™¨</span><br> <span class="hljs-keyword">for</span> name, indexFunc := <span class="hljs-keyword">range</span> c.indexers &#123;<br>  <span class="hljs-comment">// è·å–åˆ é™¤å¯¹è±¡çš„ç´¢å¼•é”®åˆ—è¡¨</span><br>  indexValues, err := indexFunc(obj)<br>  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>   <span class="hljs-built_in">panic</span>(fmt.Errorf(<span class="hljs-string">&quot;unable to calculate an index entry for key %q on index %q: %v&quot;</span>, key, name, err))<br>  &#125;<br>  <span class="hljs-comment">// è·å–å½“å‰ç´¢å¼•å™¨çš„ç´¢å¼•</span><br>  index := c.indices[name]<br>  <span class="hljs-keyword">if</span> index == <span class="hljs-literal">nil</span> &#123;<br>   <span class="hljs-keyword">continue</span><br>  &#125;<br>  <span class="hljs-comment">// å¾ªç¯æ‰€æœ‰ç´¢å¼•é”®</span><br>  <span class="hljs-keyword">for</span> _, indexValue := <span class="hljs-keyword">range</span> indexValues &#123;<br>   <span class="hljs-comment">// è·å–ç´¢å¼•é”®å¯¹åº”çš„å¯¹è±¡é”®åˆ—è¡¨</span><br>   set := index[indexValue]<br>   <span class="hljs-keyword">if</span> set != <span class="hljs-literal">nil</span> &#123;<br>    <span class="hljs-comment">// ä»å¯¹è±¡é”®åˆ—è¡¨ä¸­åˆ é™¤å½“å‰è¦åˆ é™¤çš„å¯¹è±¡é”®</span><br>    set.Delete(key)<br><br>    <span class="hljs-comment">// å¦‚æœå½“é›†åˆä¸ºç©ºçš„æ—¶å€™ä¸åˆ é™¤setï¼Œé‚£ä¹ˆå…·æœ‰é«˜åŸºæ•°çš„çŸ­ç”Ÿå‘½èµ„æºçš„ indices ä¼šå¯¼è‡´æœªä½¿ç”¨çš„ç©ºé›†åˆéšæ—¶é—´å¢åŠ å†…å­˜ã€‚</span><br>    <span class="hljs-comment">// `kubernetes/kubernetes/issues/84959`.</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(set) == <span class="hljs-number">0</span> &#123;<br>     <span class="hljs-built_in">delete</span>(index, indexValue)<br>    &#125;<br>   &#125;<br>  &#125;<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ·»åŠ ç´¢å¼•å’Œåˆ é™¤ç´¢å¼•çš„å®ç°éƒ½æŒºç®€å•çš„ï¼Œå…¶å®ä¸»è¦è¿˜æ˜¯è¦å¯¹ indicesã€indexs è¿™äº›æ•°æ®ç»“æ„éå¸¸äº†è§£ï¼Œè¿™æ ·å°±éå¸¸å®¹æ˜“äº†ï¼Œæˆ‘ä»¬å¯ä»¥å°† indexFunc å½“æˆå½“å‰å¯¹è±¡çš„å‘½åç©ºé—´æ¥çœ‹å¾…ï¼Œè¿™æ ·å¯¹äºä¸Šé¢çš„ç´¢å¼•æ›´æ–°å’Œåˆ é™¤çš„ç†è§£å°±è‚¯å®šæ²¡é—®é¢˜äº†ã€‚</p><p>ç„¶åæ¥ä¸‹æ¥å°±æ˜¯å‡ ä¸ªæŸ¥è¯¢ç›¸å…³çš„æ¥å£å®ç°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// k8s.io/client-go/tools/cache/thread_safe_store.go</span><br><br><span class="hljs-comment">// è·å–å¯¹è±¡</span><br><span class="hljs-title function_">func</span> (c *threadSafeMap) <span class="hljs-title class_">Get</span>(key string) (item interface&#123;&#125;, exists bool) &#123;<br> c.<span class="hljs-property">lock</span>.<span class="hljs-title class_">RLock</span>()  <span class="hljs-comment">// åªéœ€è¦è¯»é”</span><br> defer c.<span class="hljs-property">lock</span>.<span class="hljs-title class_">RUnlock</span>()<br>  <span class="hljs-comment">// ç›´æ¥ä» map ä¸­è¯»å–å€¼</span><br> item, exists = c.<span class="hljs-property">items</span>[key]<br> <span class="hljs-keyword">return</span> item, exists<br>&#125;<br><br><span class="hljs-comment">// å¯¹è±¡åˆ—ä¸¾</span><br><span class="hljs-title function_">func</span> (c *threadSafeMap) <span class="hljs-title class_">List</span>() []interface&#123;&#125; &#123;<br> c.<span class="hljs-property">lock</span>.<span class="hljs-title class_">RLock</span>()<br> defer c.<span class="hljs-property">lock</span>.<span class="hljs-title class_">RUnlock</span>()<br> list := <span class="hljs-title function_">make</span>([]interface&#123;&#125;, <span class="hljs-number">0</span>, <span class="hljs-title function_">len</span>(c.<span class="hljs-property">items</span>))<br> <span class="hljs-keyword">for</span> _, item := range c.<span class="hljs-property">items</span> &#123;<br>  list = <span class="hljs-title function_">append</span>(list, item)<br> &#125;<br> <span class="hljs-keyword">return</span> list<br>&#125;<br><br><span class="hljs-comment">// è¿”å› threadSafeMap ä¸­æ‰€æœ‰çš„å¯¹è±¡é”®åˆ—è¡¨</span><br><span class="hljs-title function_">func</span> (c *threadSafeMap) <span class="hljs-title class_">ListKeys</span>() []string &#123;<br> c.<span class="hljs-property">lock</span>.<span class="hljs-title class_">RLock</span>()<br> defer c.<span class="hljs-property">lock</span>.<span class="hljs-title class_">RUnlock</span>()<br> list := <span class="hljs-title function_">make</span>([]string, <span class="hljs-number">0</span>, <span class="hljs-title function_">len</span>(c.<span class="hljs-property">items</span>))<br> <span class="hljs-keyword">for</span> key := range c.<span class="hljs-property">items</span> &#123;<br>  list = <span class="hljs-title function_">append</span>(list, key)<br> &#125;<br> <span class="hljs-keyword">return</span> list<br>&#125;<br><br><span class="hljs-comment">// æ›¿æ¢æ‰€æœ‰å¯¹è±¡ï¼Œç›¸å½“äºé‡æ–°æ„å»ºç´¢å¼•</span><br><span class="hljs-title function_">func</span> (c *threadSafeMap) <span class="hljs-title class_">Replace</span>(items map[string]interface&#123;&#125;, resourceVersion string) &#123;<br> c.<span class="hljs-property">lock</span>.<span class="hljs-title class_">Lock</span>()<br> defer c.<span class="hljs-property">lock</span>.<span class="hljs-title class_">Unlock</span>()<br>  <span class="hljs-comment">// ç›´æ¥è¦†ç›–ä¹‹å‰çš„å¯¹è±¡</span><br> c.<span class="hljs-property">items</span> = items<br><br> <span class="hljs-comment">// é‡æ–°æ„å»ºç´¢å¼•</span><br> c.<span class="hljs-property">indices</span> = <span class="hljs-title class_">Indices</span>&#123;&#125;<br> <span class="hljs-keyword">for</span> key, item := range c.<span class="hljs-property">items</span> &#123;<br>    <span class="hljs-comment">// æ›´æ–°å…ƒç´ çš„ç´¢å¼•</span><br>  c.<span class="hljs-title function_">updateIndices</span>(nil, item, key)<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åæ¥ä¸‹æ¥å°±æ˜¯å’Œç´¢å¼•ç›¸å…³çš„å‡ ä¸ªæ¥å£å®ç°ï¼Œç¬¬ä¸€ä¸ªå°±æ˜¯ Index å‡½æ•°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// k8s.io/client-go/tools/cache/thread_safe_store.go</span><br><br><span class="hljs-comment">// é€šè¿‡æŒ‡å®šçš„ç´¢å¼•å™¨å’Œå¯¹è±¡è·å–ç¬¦åˆè¿™ä¸ªå¯¹è±¡ç‰¹å¾çš„æ‰€æœ‰å¯¹è±¡</span><br><span class="hljs-title function_">func</span> (c *threadSafeMap) <span class="hljs-title class_">Index</span>(indexName string, obj interface&#123;&#125;) ([]interface&#123;&#125;, error) &#123;<br> c.<span class="hljs-property">lock</span>.<span class="hljs-title class_">RLock</span>()<br> defer c.<span class="hljs-property">lock</span>.<span class="hljs-title class_">RUnlock</span>()<br>  <span class="hljs-comment">// è·å¾—ç´¢å¼•å™¨ indexName çš„ç´¢å¼•é”®è®¡ç®—å‡½æ•°</span><br> indexFunc := c.<span class="hljs-property">indexers</span>[indexName]<br> <span class="hljs-keyword">if</span> indexFunc == nil &#123;<br>  <span class="hljs-keyword">return</span> nil, fmt.<span class="hljs-title class_">Errorf</span>(<span class="hljs-string">&quot;Index with name %s does not exist&quot;</span>, indexName)<br> &#125;<br>  <span class="hljs-comment">// è·å–æŒ‡å®š obj å¯¹è±¡çš„ç´¢å¼•é”®</span><br> indexedValues, err := <span class="hljs-title function_">indexFunc</span>(obj)<br> <span class="hljs-keyword">if</span> err != nil &#123;<br>  <span class="hljs-keyword">return</span> nil, err<br> &#125;<br>  <span class="hljs-comment">// è·å¾—ç´¢å¼•å™¨ indexName çš„æ‰€æœ‰ç´¢å¼•</span><br> index := c.<span class="hljs-property">indices</span>[indexName]<br> <br>  <span class="hljs-comment">// ç”¨æ¥å­˜å‚¨å¯¹è±¡é”®çš„é›†åˆ</span><br> <span class="hljs-keyword">var</span> storeKeySet sets.<span class="hljs-property">String</span><br> <span class="hljs-keyword">if</span> <span class="hljs-title function_">len</span>(indexedValues) == <span class="hljs-number">1</span> &#123;<br>    <span class="hljs-comment">// å¤§å¤šæ•°æƒ…å†µä¸‹åªæœ‰ä¸€ä¸ªå€¼åŒ¹é…ï¼ˆé»˜è®¤è·å–çš„ç´¢å¼•é”®å°±æ˜¯å¯¹è±¡çš„ namespaceï¼‰</span><br>    <span class="hljs-comment">// ç›´æ¥æ‹¿åˆ°è¿™ä¸ªç´¢å¼•é”®çš„å¯¹è±¡é”®é›†åˆ</span><br>  storeKeySet = index[indexedValues[<span class="hljs-number">0</span>]]<br> &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// ç”±äºæœ‰å¤šä¸ªç´¢å¼•é”®ï¼Œåˆ™å¯èƒ½æœ‰é‡å¤çš„å¯¹è±¡é”®å‡ºç°ï¼Œç´¢å¼•éœ€è¦å»é‡</span><br>  storeKeySet = sets.<span class="hljs-property">String</span>&#123;&#125;<br>    <span class="hljs-comment">// å¾ªç¯ç´¢å¼•é”®</span><br>  <span class="hljs-keyword">for</span> _, indexedValue := range indexedValues &#123;<br>      <span class="hljs-comment">// å¾ªç¯ç´¢å¼•é”®ä¸‹é¢çš„å¯¹è±¡é”®ï¼Œå› ä¸ºè¦å»é‡</span><br>   <span class="hljs-keyword">for</span> key := range index[indexedValue] &#123;<br>    storeKeySet.<span class="hljs-title class_">Insert</span>(key)<br>   &#125;<br>  &#125;<br> &#125;<br>  <span class="hljs-comment">// æ‹¿åˆ°äº†æ‰€æœ‰çš„å¯¹è±¡é”®é›†åˆè¿‡åï¼Œå¾ªç¯æ‹¿åˆ°æ‰€æœ‰çš„å¯¹è±¡é›†åˆ</span><br> list := <span class="hljs-title function_">make</span>([]interface&#123;&#125;, <span class="hljs-number">0</span>, storeKeySet.<span class="hljs-title class_">Len</span>())<br> <span class="hljs-keyword">for</span> storeKey := range storeKeySet &#123;<br>  list = <span class="hljs-title function_">append</span>(list, c.<span class="hljs-property">items</span>[storeKey])<br> &#125;<br> <span class="hljs-keyword">return</span> list, nil<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ª Index å‡½æ•°å°±æ˜¯è·å–ä¸€ä¸ªæŒ‡å®šå¯¹è±¡çš„ç´¢å¼•é”®ï¼Œç„¶åæŠŠè¿™ä¸ªç´¢å¼•é”®ä¸‹é¢çš„æ‰€æœ‰çš„å¯¹è±¡å…¨éƒ¨è·å–åˆ°ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦è·å–ä¸€ä¸ª Pod æ‰€åœ¨å‘½åç©ºé—´ä¸‹é¢çš„æ‰€æœ‰ Podï¼Œå¦‚æœæ›´æŠ½è±¡ä¸€ç‚¹ï¼Œå°±æ˜¯ç¬¦åˆå¯¹è±¡<em>æŸäº›ç‰¹å¾</em>çš„æ‰€æœ‰å¯¹è±¡ï¼Œè€Œè¿™ä¸ªç‰¹å¾å°±æ˜¯æˆ‘ä»¬æŒ‡å®šçš„ç´¢å¼•é”®å‡½æ•°è®¡ç®—å‡ºæ¥çš„ã€‚ç„¶åæ¥ä¸‹æ¥å°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„ ByIndex å‡½æ•°çš„å®ç°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// k8s.io/client-go/tools/cache/thread_safe_store.go</span><br><br><span class="hljs-comment">// å’Œä¸Šé¢çš„ Index å‡½æ•°ç±»ä¼¼ï¼Œåªæ˜¯æ˜¯ç›´æ¥æŒ‡å®šçš„ç´¢å¼•é”®</span><br><span class="hljs-title function_">func</span> (c *threadSafeMap) <span class="hljs-title class_">ByIndex</span>(indexName, indexedValue string) ([]interface&#123;&#125;, error) &#123;<br> c.<span class="hljs-property">lock</span>.<span class="hljs-title class_">RLock</span>()<br> defer c.<span class="hljs-property">lock</span>.<span class="hljs-title class_">RUnlock</span>()<br>  <br>  <span class="hljs-comment">// è·å¾—ç´¢å¼•å™¨ indexName çš„ç´¢å¼•é”®è®¡ç®—å‡½æ•°</span><br> indexFunc := c.<span class="hljs-property">indexers</span>[indexName]<br> <span class="hljs-keyword">if</span> indexFunc == nil &#123;<br>  <span class="hljs-keyword">return</span> nil, fmt.<span class="hljs-title class_">Errorf</span>(<span class="hljs-string">&quot;Index with name %s does not exist&quot;</span>, indexName)<br> &#125;<br>  <span class="hljs-comment">// è·å¾—ç´¢å¼•å™¨ indexName çš„æ‰€æœ‰ç´¢å¼•</span><br> index := c.<span class="hljs-property">indices</span>[indexName]<br>  <span class="hljs-comment">// è·å–æŒ‡å®šç´¢å¼•é”®çš„æ‰€æœ‰æ‰€æœ‰å¯¹è±¡é”®</span><br> set := index[indexedValue]<br>  <span class="hljs-comment">// ç„¶åæ ¹æ®å¯¹è±¡é”®éå†è·å–å¯¹è±¡</span><br> list := <span class="hljs-title function_">make</span>([]interface&#123;&#125;, <span class="hljs-number">0</span>, set.<span class="hljs-title class_">Len</span>())<br> <span class="hljs-keyword">for</span> key := range set &#123;<br>  list = <span class="hljs-title function_">append</span>(list, c.<span class="hljs-property">items</span>[key])<br> &#125;<br><br> <span class="hljs-keyword">return</span> list, nil<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥å¾ˆæ¸…æ¥šåœ°çœ‹åˆ° ByIndex å‡½æ•°å’Œ Index å‡½æ•°æ¯”è¾ƒç±»ä¼¼ï¼Œä½†æ˜¯æ›´ç®€å•äº†ï¼Œç›´æ¥è·å–ä¸€ä¸ªæŒ‡å®šçš„ç´¢å¼•é”®çš„å…¨éƒ¨èµ„æºå¯¹è±¡ã€‚ç„¶åæ˜¯å…¶ä»–å‡ ä¸ªç´¢å¼•ç›¸å…³çš„å‡½æ•°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// k8s.io/client-go/tools/cache/thread_safe_store.go</span><br><br><span class="hljs-comment">// IndexKeys å’Œä¸Šé¢çš„ ByIndex å‡ ä¹æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯è¿™é‡Œæ˜¯ç›´æ¥è¿”å›å¯¹è±¡é”®åˆ—è¡¨</span><br><span class="hljs-title function_">func</span> (c *threadSafeMap) <span class="hljs-title class_">IndexKeys</span>(indexName, indexedValue string) ([]string, error) &#123;<br> c.<span class="hljs-property">lock</span>.<span class="hljs-title class_">RLock</span>()<br> defer c.<span class="hljs-property">lock</span>.<span class="hljs-title class_">RUnlock</span>()<br>  <span class="hljs-comment">// è·å–ç´¢å¼•å™¨ indexName çš„ç´¢å¼•é”®è®¡ç®—å‡½æ•°</span><br> indexFunc := c.<span class="hljs-property">indexers</span>[indexName]<br> <span class="hljs-keyword">if</span> indexFunc == nil &#123;<br>  <span class="hljs-keyword">return</span> nil, fmt.<span class="hljs-title class_">Errorf</span>(<span class="hljs-string">&quot;Index with name %s does not exist&quot;</span>, indexName)<br> &#125;<br>  <span class="hljs-comment">// è·å–ç´¢å¼•å™¨ indexName çš„æ‰€æœ‰ç´¢å¼•</span><br> index := c.<span class="hljs-property">indices</span>[indexName]<br> <span class="hljs-comment">// ç›´æ¥è·å–æŒ‡å®šç´¢å¼•é”®çš„å¯¹è±¡é”®é›†åˆ</span><br> set := index[indexedValue]<br> <span class="hljs-keyword">return</span> set.<span class="hljs-title class_">List</span>(), nil<br>&#125;<br><br><span class="hljs-comment">// è·å–ç´¢å¼•å™¨ä¸‹é¢çš„æ‰€æœ‰ç´¢å¼•é”®</span><br><span class="hljs-title function_">func</span> (c *threadSafeMap) <span class="hljs-title class_">ListIndexFuncValues</span>(indexName string) []string &#123;<br> c.<span class="hljs-property">lock</span>.<span class="hljs-title class_">RLock</span>()<br> defer c.<span class="hljs-property">lock</span>.<span class="hljs-title class_">RUnlock</span>()<br>  <span class="hljs-comment">// è·å–ç´¢å¼•å™¨ indexName çš„æ‰€æœ‰ç´¢å¼•</span><br> index := c.<span class="hljs-property">indices</span>[indexName]<br> names := <span class="hljs-title function_">make</span>([]string, <span class="hljs-number">0</span>, <span class="hljs-title function_">len</span>(index))<br>  <span class="hljs-comment">// éå†ç´¢å¼•å¾—åˆ°ç´¢å¼•é”®</span><br> <span class="hljs-keyword">for</span> key := range index &#123;<br>  names = <span class="hljs-title function_">append</span>(names, key)<br> &#125;<br> <span class="hljs-keyword">return</span> names<br>&#125;<br><br><span class="hljs-comment">// ç›´æ¥è¿”å› indexers</span><br><span class="hljs-title function_">func</span> (c *threadSafeMap) <span class="hljs-title class_">GetIndexers</span>() <span class="hljs-title class_">Indexers</span> &#123;<br> <span class="hljs-keyword">return</span> c.<span class="hljs-property">indexers</span><br>&#125;<br><br><span class="hljs-comment">// æ·»åŠ ä¸€ä¸ªæ–°çš„ Indexers</span><br><span class="hljs-title function_">func</span> (c *threadSafeMap) <span class="hljs-title class_">AddIndexers</span>(newIndexers <span class="hljs-title class_">Indexers</span>) error &#123;<br> c.<span class="hljs-property">lock</span>.<span class="hljs-title class_">Lock</span>()<br> defer c.<span class="hljs-property">lock</span>.<span class="hljs-title class_">Unlock</span>()<br><br> <span class="hljs-keyword">if</span> <span class="hljs-title function_">len</span>(c.<span class="hljs-property">items</span>) &gt; <span class="hljs-number">0</span> &#123;<br>  <span class="hljs-keyword">return</span> fmt.<span class="hljs-title class_">Errorf</span>(<span class="hljs-string">&quot;cannot add indexers to running index&quot;</span>)<br> &#125;<br>  <span class="hljs-comment">// è·å–æ—§çš„ç´¢å¼•å™¨å’Œæ–°çš„ç´¢å¼•å™¨keys</span><br> oldKeys := sets.<span class="hljs-title class_">StringKeySet</span>(c.<span class="hljs-property">indexers</span>)<br> newKeys := sets.<span class="hljs-title class_">StringKeySet</span>(newIndexers)<br>  <br>  <span class="hljs-comment">// å¦‚æœåŒ…å«æ–°çš„ç´¢å¼•å™¨ï¼Œåˆ™æç¤ºå†²çª</span><br> <span class="hljs-keyword">if</span> oldKeys.<span class="hljs-title class_">HasAny</span>(newKeys.<span class="hljs-title class_">List</span>()...) &#123;<br>  <span class="hljs-keyword">return</span> fmt.<span class="hljs-title class_">Errorf</span>(<span class="hljs-string">&quot;indexer conflict: %v&quot;</span>, oldKeys.<span class="hljs-title class_">Intersection</span>(newKeys))<br> &#125;<br>  <span class="hljs-comment">// å°†æ–°çš„ç´¢å¼•å™¨æ·»åŠ åˆ° Indexers ä¸­</span><br> <span class="hljs-keyword">for</span> k, v := range newIndexers &#123;<br>  c.<span class="hljs-property">indexers</span>[k] = v<br> &#125;<br> <span class="hljs-keyword">return</span> nil<br>&#125;<br><br><span class="hljs-comment">// æ²¡æœ‰çœŸæ­£å®ç° Resync æ“ä½œ </span><br><span class="hljs-title function_">func</span> (c *threadSafeMap) <span class="hljs-title class_">Resync</span>() error &#123;<br> <span class="hljs-keyword">return</span> nil<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å°±å°† ThreadSafeMap çš„å®ç°è¿›è¡Œäº†åˆ†æè¯´æ˜ã€‚æ•´ä½“æ¥è¯´æ¯”è¾ƒæ–¹ä¾¿ï¼Œä¸€ä¸ªå°±æ˜¯å°†å¯¹è±¡æ•°æ®å­˜å…¥åˆ°ä¸€ä¸ª map ä¸­ï¼Œç„¶åå°±æ˜¯ç»´æŠ¤ç´¢å¼•ï¼Œæ–¹ä¾¿æ ¹æ®ç´¢å¼•æ¥æŸ¥æ‰¾åˆ°å¯¹åº”çš„å¯¹è±¡ã€‚</p><h3 id="cache"><a href="#cache" class="headerlink" title="cache"></a><strong>cache</strong></h3><p>æ¥ä¸‹æ¥å†å›è¿‡å¤´å»çœ‹ cache çš„å®ç°å°±éå¸¸ç®€å•äº†ï¼Œå› ä¸º cache å°±æ˜¯å¯¹ ThreadSafeStore çš„ä¸€ä¸ªå†æ¬¡å°è£…ï¼Œå¾ˆå¤šæ“ä½œéƒ½æ˜¯ç›´æ¥è°ƒç”¨çš„ <code>ThreadSafeStore</code> çš„æ“ä½œå®ç°çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// k8s.io/client-go/tools/cache/store.go</span><br><br><span class="hljs-comment">// Add æ’å…¥ä¸€ä¸ªå…ƒç´ åˆ° cache ä¸­</span><br><span class="hljs-title function_">func</span> (c *cache) <span class="hljs-title class_">Add</span>(obj interface&#123;&#125;) error &#123;<br> key, err := c.<span class="hljs-title function_">keyFunc</span>(obj)  <span class="hljs-comment">// ç”Ÿæˆå¯¹è±¡é”®</span><br> <span class="hljs-keyword">if</span> err != nil &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">KeyError</span>&#123;obj, err&#125;<br> &#125;<br>  <span class="hljs-comment">// å°†å¯¹è±¡æ·»åŠ åˆ°åº•å±‚çš„ ThreadSafeStore ä¸­</span><br> c.<span class="hljs-property">cacheStorage</span>.<span class="hljs-title class_">Add</span>(key, obj)<br> <span class="hljs-keyword">return</span> nil<br>&#125;<br><br><span class="hljs-comment">// æ›´æ–°cacheä¸­çš„å¯¹è±¡</span><br><span class="hljs-title function_">func</span> (c *cache) <span class="hljs-title class_">Update</span>(obj interface&#123;&#125;) error &#123;<br> key, err := c.<span class="hljs-title function_">keyFunc</span>(obj)<br> <span class="hljs-keyword">if</span> err != nil &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">KeyError</span>&#123;obj, err&#125;<br> &#125;<br> c.<span class="hljs-property">cacheStorage</span>.<span class="hljs-title class_">Update</span>(key, obj)<br> <span class="hljs-keyword">return</span> nil<br>&#125;<br><br><span class="hljs-comment">// åˆ é™¤cacheä¸­çš„å¯¹è±¡</span><br><span class="hljs-title function_">func</span> (c *cache) <span class="hljs-title class_">Delete</span>(obj interface&#123;&#125;) error &#123;<br> key, err := c.<span class="hljs-title function_">keyFunc</span>(obj)<br> <span class="hljs-keyword">if</span> err != nil &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">KeyError</span>&#123;obj, err&#125;<br> &#125;<br> c.<span class="hljs-property">cacheStorage</span>.<span class="hljs-title class_">Delete</span>(key)<br> <span class="hljs-keyword">return</span> nil<br>&#125;<br><br><span class="hljs-comment">// å¾—åˆ°cacheä¸­æ‰€æœ‰çš„å¯¹è±¡</span><br><span class="hljs-title function_">func</span> (c *cache) <span class="hljs-title class_">List</span>() []interface&#123;&#125; &#123;<br> <span class="hljs-keyword">return</span> c.<span class="hljs-property">cacheStorage</span>.<span class="hljs-title class_">List</span>()<br>&#125;<br><br><span class="hljs-comment">// å¾—åˆ°cacheä¸­æ‰€æœ‰çš„å¯¹è±¡é”®</span><br><span class="hljs-title function_">func</span> (c *cache) <span class="hljs-title class_">ListKeys</span>() []string &#123;<br> <span class="hljs-keyword">return</span> c.<span class="hljs-property">cacheStorage</span>.<span class="hljs-title class_">ListKeys</span>()<br>&#125;<br><br><span class="hljs-comment">// å¾—åˆ°cacheä¸­çš„Indexers</span><br><span class="hljs-title function_">func</span> (c *cache) <span class="hljs-title class_">GetIndexers</span>() <span class="hljs-title class_">Indexers</span> &#123;<br> <span class="hljs-keyword">return</span> c.<span class="hljs-property">cacheStorage</span>.<span class="hljs-title class_">GetIndexers</span>()<br>&#125;<br><br><span class="hljs-comment">// å¾—åˆ°å¯¹è±¡objä¸indexNameç´¢å¼•å™¨å…³è”çš„æ‰€æœ‰å¯¹è±¡</span><br><span class="hljs-title function_">func</span> (c *cache) <span class="hljs-title class_">Index</span>(indexName string, obj interface&#123;&#125;) ([]interface&#123;&#125;, error) &#123;<br> <span class="hljs-keyword">return</span> c.<span class="hljs-property">cacheStorage</span>.<span class="hljs-title class_">Index</span>(indexName, obj)<br>&#125;<br><br><span class="hljs-title function_">func</span> (c *cache) <span class="hljs-title class_">IndexKeys</span>(indexName, indexKey string) ([]string, error) &#123;<br> <span class="hljs-keyword">return</span> c.<span class="hljs-property">cacheStorage</span>.<span class="hljs-title class_">IndexKeys</span>(indexName, indexKey)<br>&#125;<br><br><span class="hljs-title function_">func</span> (c *cache) <span class="hljs-title class_">ListIndexFuncValues</span>(indexName string) []string &#123;<br> <span class="hljs-keyword">return</span> c.<span class="hljs-property">cacheStorage</span>.<span class="hljs-title class_">ListIndexFuncValues</span>(indexName)<br>&#125;<br><br><span class="hljs-title function_">func</span> (c *cache) <span class="hljs-title class_">ByIndex</span>(indexName, indexKey string) ([]interface&#123;&#125;, error) &#123;<br> <span class="hljs-keyword">return</span> c.<span class="hljs-property">cacheStorage</span>.<span class="hljs-title class_">ByIndex</span>(indexName, indexKey)<br>&#125;<br><br><span class="hljs-title function_">func</span> (c *cache) <span class="hljs-title class_">AddIndexers</span>(newIndexers <span class="hljs-title class_">Indexers</span>) error &#123;<br> <span class="hljs-keyword">return</span> c.<span class="hljs-property">cacheStorage</span>.<span class="hljs-title class_">AddIndexers</span>(newIndexers)<br>&#125;<br><br><span class="hljs-title function_">func</span> (c *cache) <span class="hljs-title class_">Get</span>(obj interface&#123;&#125;) (item interface&#123;&#125;, exists bool, err error) &#123;<br> key, err := c.<span class="hljs-title function_">keyFunc</span>(obj)<br> <span class="hljs-keyword">if</span> err != nil &#123;<br>  <span class="hljs-keyword">return</span> nil, <span class="hljs-literal">false</span>, <span class="hljs-title class_">KeyError</span>&#123;obj, err&#125;<br> &#125;<br> <span class="hljs-keyword">return</span> c.<span class="hljs-title class_">GetByKey</span>(key)<br>&#125;<br><br><span class="hljs-title function_">func</span> (c *cache) <span class="hljs-title class_">GetByKey</span>(key string) (item interface&#123;&#125;, exists bool, err error) &#123;<br> item, exists = c.<span class="hljs-property">cacheStorage</span>.<span class="hljs-title class_">Get</span>(key)<br> <span class="hljs-keyword">return</span> item, exists, nil<br>&#125;<br><br><span class="hljs-comment">// æ›¿æ¢cacheä¸­æ‰€æœ‰çš„å¯¹è±¡</span><br><span class="hljs-title function_">func</span> (c *cache) <span class="hljs-title class_">Replace</span>(list []interface&#123;&#125;, resourceVersion string) error &#123;<br> items := <span class="hljs-title function_">make</span>(map[string]interface&#123;&#125;, <span class="hljs-title function_">len</span>(list))<br> <span class="hljs-keyword">for</span> _, item := range list &#123;<br>  key, err := c.<span class="hljs-title function_">keyFunc</span>(item)<br>  <span class="hljs-keyword">if</span> err != nil &#123;<br>   <span class="hljs-keyword">return</span> <span class="hljs-title class_">KeyError</span>&#123;item, err&#125;<br>  &#125;<br>  items[key] = item<br> &#125;<br> c.<span class="hljs-property">cacheStorage</span>.<span class="hljs-title class_">Replace</span>(items, resourceVersion)<br> <span class="hljs-keyword">return</span> nil<br>&#125;<br><br><span class="hljs-title function_">func</span> (c *cache) <span class="hljs-title class_">Resync</span>() error &#123;<br> <span class="hljs-keyword">return</span> nil<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° cache æ²¡æœ‰è‡ªå·±ç‹¬ç‰¹çš„å®ç°æ–¹å¼ï¼Œéƒ½æ˜¯è°ƒç”¨çš„åŒ…å«çš„ <code>ThreadSafeStore</code> æ“ä½œæ¥å£ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a><strong>æ€»ç»“</strong></h3><p>å‰é¢æˆ‘ä»¬å·²ç»çŸ¥é“äº† Reflector é€šè¿‡ ListAndWatch æŠŠæ•°æ®ä¼ å…¥ DeltaFIFO åï¼Œç»è¿‡ DeltaFIFO çš„ Pop å‡½æ•°å°†èµ„æºå¯¹è±¡å­˜å…¥åˆ°äº†æœ¬åœ°çš„ä¸€ä¸ªå­˜å‚¨ Indexer ä¸­ï¼Œè€Œè¿™ä¸ªåº•å±‚çœŸæ­£çš„å­˜å‚¨å…¶å®å°±æ˜¯ä¸Šé¢çš„ ThreadSafeStoreã€‚</p><p>è¦ç†è§£ Indexer ç»„ä»¶ï¼Œæœ€ä¸»è¦å°±æ˜¯è¦æŠŠç´¢å¼•ã€ç´¢å¼•å™¨ï¼ˆç´¢å¼•åˆ†ç±»ï¼‰ã€ç´¢å¼•é”®ã€å¯¹è±¡é”®è¿™å‡ ä¸ªæ¦‚å¿µå¼„æ¸…æ¥šï¼Œæœ‰æ—¶å€™ç¡®å®å®¹æ˜“æ··ä¹±ï¼Œæˆ‘ä»¬å°†ä¸Šé¢çš„ç¤ºä¾‹ç†è§£äº†åº”è¯¥å°±å¾ˆå¥½ç†è§£äº†ï¼Œæ¯”å¦‚æˆ‘ä»¬æŒ‰ç…§å‘½åç©ºé—´æ¥è¿›è¡Œç´¢å¼•ï¼Œå¯ä»¥ç®€å•çš„ç†è§£ä¸ºè¿™ä¸ª Indexer å°±æ˜¯ç®€å•çš„æŠŠç›¸åŒå‘½åç©ºé—´çš„å¯¹è±¡æ”¾åœ¨ä¸€ä¸ªé›†åˆä¸­ï¼Œç„¶ååŸºäºå‘½åç©ºé—´æ¥æŸ¥æ‰¾å¯¹è±¡ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>podåˆ›å»ºè¿‡ç¨‹</title>
    <link href="/2025/03/31/pod%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B/"/>
    <url>/2025/03/31/pod%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h2 id="Podåˆ›å»ºè¿‡ç¨‹"><a href="#Podåˆ›å»ºè¿‡ç¨‹" class="headerlink" title="Podåˆ›å»ºè¿‡ç¨‹"></a><a href="https://www.cnblogs.com/love-DanDan/p/18402153">Podåˆ›å»ºè¿‡ç¨‹</a></h2><p>ä»¥ä¸‹æ˜¯ä¸ºKubernetesåˆå­¦è€…è®¾è®¡çš„ã€ŠPodåˆ›å»ºå…¨æµç¨‹è¯¦è§£ã€‹æ•™å­¦è®²ä¹‰ï¼Œç»“åˆæŠ€æœ¯ç»†èŠ‚ä¸æ•™å­¦é€»è¾‘ï¼Œå¸®åŠ©å­¦ç”Ÿæ·±å…¥ç†è§£Kuberneteså†…éƒ¨æœºåˆ¶ï¼š</p><hr><h3 id="Kubernetes-Podåˆ›å»ºå…¨æµç¨‹æ•™å­¦è®²ä¹‰"><a href="#Kubernetes-Podåˆ›å»ºå…¨æµç¨‹æ•™å­¦è®²ä¹‰" class="headerlink" title="Kubernetes Podåˆ›å»ºå…¨æµç¨‹æ•™å­¦è®²ä¹‰"></a><strong>Kubernetes Podåˆ›å»ºå…¨æµç¨‹æ•™å­¦è®²ä¹‰</strong></h3><p><strong>ç›®æ ‡</strong>ï¼šç†è§£ä»<code>kubectl create</code>åˆ°Podè¿è¡Œçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ<br><strong>éš¾åº¦</strong>ï¼šä¸­çº§<br><strong>é¢„è®¡æ—¶é•¿</strong>ï¼š45åˆ†é’Ÿ<br><strong>æ ¸å¿ƒæ¦‚å¿µå›¾</strong>ï¼š<br><code>ç”¨æˆ·è¯·æ±‚ â†’ API Server â†’ æŒä¹…åŒ– â†’ æ§åˆ¶å™¨ â†’ è°ƒåº¦ â†’ èŠ‚ç‚¹æ‰§è¡Œ</code></p><hr><h4 id="ä¸€ã€å‰ç½®çŸ¥è¯†å›é¡¾ï¼ˆ5åˆ†é’Ÿï¼‰"><a href="#ä¸€ã€å‰ç½®çŸ¥è¯†å›é¡¾ï¼ˆ5åˆ†é’Ÿï¼‰" class="headerlink" title="ä¸€ã€å‰ç½®çŸ¥è¯†å›é¡¾ï¼ˆ5åˆ†é’Ÿï¼‰"></a><strong>ä¸€ã€å‰ç½®çŸ¥è¯†å›é¡¾ï¼ˆ5åˆ†é’Ÿï¼‰</strong></h4><ol><li><strong>Podæ˜¯ä»€ä¹ˆ</strong>  <ul><li>Kubernetesæœ€å°è°ƒåº¦å•å…ƒ</li><li>ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨çš„é€»è¾‘é›†åˆï¼ˆå…±äº«ç½‘ç»œ&#x2F;å­˜å‚¨å‘½åç©ºé—´ï¼‰</li></ul></li><li><strong>å…³é”®ç»„ä»¶è§’è‰²</strong>  <pre><code class=" mermaid">graph LRA[kubectl] --&gt; B[API Server]B --&gt; C[etcd]B --&gt; D[Controller Manager]B --&gt; E[Scheduler]E --&gt; F[Kubelet]F --&gt; G[Container Runtime]</code></pre></li></ol><hr><h4 id="äºŒã€Podåˆ›å»ºå…¨æµç¨‹è¯¦è§£ï¼ˆ30åˆ†é’Ÿï¼‰"><a href="#äºŒã€Podåˆ›å»ºå…¨æµç¨‹è¯¦è§£ï¼ˆ30åˆ†é’Ÿï¼‰" class="headerlink" title="äºŒã€Podåˆ›å»ºå…¨æµç¨‹è¯¦è§£ï¼ˆ30åˆ†é’Ÿï¼‰"></a><strong>äºŒã€Podåˆ›å»ºå…¨æµç¨‹è¯¦è§£ï¼ˆ30åˆ†é’Ÿï¼‰</strong></h4><h5 id="é˜¶æ®µ1ï¼šç”¨æˆ·æäº¤è¯·æ±‚ï¼ˆClient-Sideï¼‰"><a href="#é˜¶æ®µ1ï¼šç”¨æˆ·æäº¤è¯·æ±‚ï¼ˆClient-Sideï¼‰" class="headerlink" title="é˜¶æ®µ1ï¼šç”¨æˆ·æäº¤è¯·æ±‚ï¼ˆClient Sideï¼‰"></a><strong>é˜¶æ®µ1ï¼šç”¨æˆ·æäº¤è¯·æ±‚ï¼ˆClient Sideï¼‰</strong></h5><ol><li><strong>å‘½ä»¤è§£æ</strong>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl apply -f pod.yaml â†’ <br>  kubectl å°†YAMLè½¬æ¢ä¸ºJSON â†’ <br>  é€šè¿‡kubeconfigæ‰¾åˆ°APIServeråœ°å€<br></code></pre></td></tr></table></figure></li><li><strong>è®¤è¯ä¸æˆæƒ</strong>  <ul><li>è®¤è¯æ–¹å¼ï¼šX.509è¯ä¹¦&#x2F;Bearer Token&#x2F;ServiceAccount</li><li>æˆæƒæ£€æŸ¥ï¼šRBACéªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰<code>create pod</code>æƒé™</li></ul></li></ol><h5 id="é˜¶æ®µ2ï¼šAPI-Serverå¤„ç†"><a href="#é˜¶æ®µ2ï¼šAPI-Serverå¤„ç†" class="headerlink" title="é˜¶æ®µ2ï¼šAPI Serverå¤„ç†"></a><strong>é˜¶æ®µ2ï¼šAPI Serverå¤„ç†</strong></h5><ol><li><strong>è¯·æ±‚æ¥æ”¶</strong>  <ul><li>ç›‘å¬ç«¯å£ï¼š6443 (HTTPS)</li><li>è¯·æ±‚ç¤ºä¾‹ï¼š<code>POST /api/v1/namespaces/default/pods</code></li></ul></li><li><strong>å‡†å…¥æ§åˆ¶ï¼ˆAdmission Controlï¼‰</strong>  <ul><li>ä¿®æ”¹&#x2F;éªŒè¯è¯·æ±‚çš„æ‹¦æˆªé“¾  </li><li>å…³é”®æ’ä»¶ï¼š  <ul><li><code>NamespaceLifecycle</code>ï¼šæ£€æŸ¥å‘½åç©ºé—´æ˜¯å¦å­˜åœ¨  </li><li><code>ResourceQuota</code>ï¼šæ˜¯å¦è¶…è¿‡èµ„æºé…é¢  </li><li><code>DefaultStorageClass</code>ï¼šè‡ªåŠ¨æ·»åŠ å­˜å‚¨ç±»  </li><li><strong>ç¤ºä¾‹</strong>ï¼šMutatingWebhookè‡ªåŠ¨æ³¨å…¥Sidecarå®¹å™¨</li></ul></li></ul></li></ol><h5 id="é˜¶æ®µ3ï¼šæŒä¹…åŒ–å­˜å‚¨ï¼ˆetcdï¼‰"><a href="#é˜¶æ®µ3ï¼šæŒä¹…åŒ–å­˜å‚¨ï¼ˆetcdï¼‰" class="headerlink" title="é˜¶æ®µ3ï¼šæŒä¹…åŒ–å­˜å‚¨ï¼ˆetcdï¼‰"></a><strong>é˜¶æ®µ3ï¼šæŒä¹…åŒ–å­˜å‚¨ï¼ˆetcdï¼‰</strong></h5><ol><li><strong>æ•°æ®å†™å…¥</strong>  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">API Server â†’ å°†Podå¯¹è±¡ â†’ å­˜å‚¨ä¸ºetcdçš„key-value<br><span class="hljs-comment">// Keyè·¯å¾„ç¤ºä¾‹ï¼š/registry/pods/default/my-pod</span><br></code></pre></td></tr></table></figure></li><li><strong>è¿”å›ç»“æœ</strong>  <ul><li>è¿”å›HTTP 201 Created â†’ <code>kubectl</code>æ˜¾ç¤ºâ€pod&#x2F;my-pod createdâ€</li></ul></li></ol><h5 id="é˜¶æ®µ4ï¼šæ§åˆ¶å™¨å“åº”ï¼ˆControl-Loopï¼‰"><a href="#é˜¶æ®µ4ï¼šæ§åˆ¶å™¨å“åº”ï¼ˆControl-Loopï¼‰" class="headerlink" title="é˜¶æ®µ4ï¼šæ§åˆ¶å™¨å“åº”ï¼ˆControl Loopï¼‰"></a><strong>é˜¶æ®µ4ï¼šæ§åˆ¶å™¨å“åº”ï¼ˆControl Loopï¼‰</strong></h5><ol><li><strong>Informerç›‘å¬æœºåˆ¶</strong>  <ul><li>Controller Managerä¸­çš„<code>ReplicationController</code>æŒç»­watch etcdå˜åŒ–</li><li>å‘ç°æ–°Podå¯¹è±¡ â†’ åŠ å…¥å·¥ä½œé˜Ÿåˆ—</li></ul></li><li><strong>èŠ‚ç‚¹è°ƒåº¦å†³ç­–</strong>  <ul><li><strong>è°ƒåº¦å™¨å·¥ä½œæµç¨‹</strong>ï¼š<pre><code class=" mermaid">graph TDA[è·å–æœªè°ƒåº¦Pod] --&gt; B&#123;é¢„é€‰é˜¶æ®µ&#125;B --&gt; C[è¿‡æ»¤ä¸æ»¡è¶³èŠ‚ç‚¹ï¼šèµ„æº/æ±¡ç‚¹ç­‰]C --&gt; D&#123;ä¼˜é€‰é˜¶æ®µ&#125;D --&gt; E[èŠ‚ç‚¹æ‰“åˆ†ï¼šèµ„æºå‡è¡¡/äº²å’Œæ€§]E --&gt; F[ç»‘å®šèŠ‚ç‚¹ï¼šå†™å…¥Pod.spec.nodeName]</code></pre></li><li><strong>å…³é”®ç®—æ³•</strong>ï¼š  <ul><li>é¢„é€‰(Predicates)ï¼šèŠ‚ç‚¹CPU&#x2F;Memoryæ˜¯å¦å……è¶³  </li><li>ä¼˜é€‰(Priorities)ï¼šé€‰æ‹©èµ„æºåˆ©ç”¨ç‡æœ€ä½çš„èŠ‚ç‚¹</li></ul></li></ul></li></ol><h5 id="é˜¶æ®µ5ï¼šèŠ‚ç‚¹æ‰§è¡Œï¼ˆNode-Levelï¼‰"><a href="#é˜¶æ®µ5ï¼šèŠ‚ç‚¹æ‰§è¡Œï¼ˆNode-Levelï¼‰" class="headerlink" title="é˜¶æ®µ5ï¼šèŠ‚ç‚¹æ‰§è¡Œï¼ˆNode Levelï¼‰"></a><strong>é˜¶æ®µ5ï¼šèŠ‚ç‚¹æ‰§è¡Œï¼ˆNode Levelï¼‰</strong></h5><ol><li><p><strong>Kubeletæ¥ç®¡</strong>  </p><ul><li>Watchåˆ°ç»‘å®šæœ¬èŠ‚ç‚¹çš„Pod â†’ è°ƒç”¨CRIï¼ˆContainer Runtime Interfaceï¼‰</li></ul></li><li><p><strong>å®¹å™¨å¯åŠ¨æµç¨‹</strong>  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sequence">Kubeletâ†’CRI: åˆ›å»ºPodæ²™ç›’ï¼ˆpauseå®¹å™¨ï¼‰<br>CRIâ†’Runtime: åˆ›å»ºå®¹å™¨ç»„<br>Runtimeâ†’Container: å¯åŠ¨ä¸šåŠ¡å®¹å™¨<br>Containerâ†’Kubelet: çŠ¶æ€åé¦ˆ<br></code></pre></td></tr></table></figure></li><li><p><strong>çŠ¶æ€ä¸ŠæŠ¥</strong>  </p><ul><li>KubeletæŒç»­ç›‘æ§ â†’ é€šè¿‡API Serveræ›´æ–°PodçŠ¶æ€è‡³etcd</li></ul></li></ol><hr><h4 id="ä¸‰ã€æ ¸å¿ƒæ•…éšœç‚¹ä¸æ’é”™ï¼ˆ7åˆ†é’Ÿï¼‰"><a href="#ä¸‰ã€æ ¸å¿ƒæ•…éšœç‚¹ä¸æ’é”™ï¼ˆ7åˆ†é’Ÿï¼‰" class="headerlink" title="ä¸‰ã€æ ¸å¿ƒæ•…éšœç‚¹ä¸æ’é”™ï¼ˆ7åˆ†é’Ÿï¼‰"></a><strong>ä¸‰ã€æ ¸å¿ƒæ•…éšœç‚¹ä¸æ’é”™ï¼ˆ7åˆ†é’Ÿï¼‰</strong></h4><table><thead><tr><th>é˜¶æ®µ</th><th>å¸¸è§é”™è¯¯</th><th>è¯Šæ–­å‘½ä»¤</th></tr></thead><tbody><tr><td>è°ƒåº¦é˜¶æ®µ</td><td>PendingçŠ¶æ€</td><td><code>kubectl describe pod</code> æŸ¥çœ‹Events</td></tr><tr><td>é•œåƒæ‹‰å–</td><td>ImagePullBackOff</td><td><code>kubectl logs -p</code></td></tr><tr><td>èŠ‚ç‚¹èµ„æº</td><td>Insufficient cpu&#x2F;memory</td><td><code>kubectl top nodes</code></td></tr><tr><td>ç½‘ç»œé…ç½®</td><td>CNIæ’ä»¶æœªå°±ç»ª</td><td>æ£€æŸ¥<code>kube-system</code>çš„DaemonSet</td></tr></tbody></table><hr><h4 id="å››ã€å®éªŒä¸éªŒè¯ï¼ˆ8åˆ†é’Ÿï¼‰"><a href="#å››ã€å®éªŒä¸éªŒè¯ï¼ˆ8åˆ†é’Ÿï¼‰" class="headerlink" title="å››ã€å®éªŒä¸éªŒè¯ï¼ˆ8åˆ†é’Ÿï¼‰"></a><strong>å››ã€å®éªŒä¸éªŒè¯ï¼ˆ8åˆ†é’Ÿï¼‰</strong></h4><ol><li><strong>å®æ—¶è§‚å¯Ÿåˆ›å»ºæµç¨‹</strong>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ç»ˆç«¯1ï¼šäº‹ä»¶ç›‘å¬</span><br>kubectl get events -w<br><br><span class="hljs-comment"># ç»ˆç«¯2ï¼šåˆ›å»ºPod</span><br>kubectl apply -f https://k8s.io/examples/pods/simple-pod.yaml<br></code></pre></td></tr></table></figure></li><li><strong>å…³é”®çŠ¶æ€æ£€æŸ¥ç‚¹</strong>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl get pod -o wide -w  <span class="hljs-comment"># è§‚å¯Ÿè°ƒåº¦èŠ‚ç‚¹</span><br>kubectl describe pod nginx  <span class="hljs-comment"># æŸ¥çœ‹è¯¦ç»†ç”Ÿå‘½å‘¨æœŸäº‹ä»¶</span><br></code></pre></td></tr></table></figure></li></ol><hr><h4 id="äº”ã€è¿›é˜¶æ€è€ƒé¢˜"><a href="#äº”ã€è¿›é˜¶æ€è€ƒé¢˜" class="headerlink" title="äº”ã€è¿›é˜¶æ€è€ƒé¢˜"></a><strong>äº”ã€è¿›é˜¶æ€è€ƒé¢˜</strong></h4><ol><li>å¦‚æœAPI Serveré‡å¯ï¼Œå·²åˆ›å»ºä½†æœªè°ƒåº¦çš„Podä¼šä¸¢å¤±å—ï¼Ÿ<br><strong>ç­”æ¡ˆ</strong>ï¼šä¸ä¼šï¼ŒçŠ¶æ€å·²æŒä¹…åŒ–åœ¨etcd</li><li>å¦‚ä½•å®ç°Podè·¨å¯ç”¨åŒºçš„é«˜å¯ç”¨è°ƒåº¦ï¼Ÿ<br><strong>æç¤º</strong>ï¼šåˆ©ç”¨<code>podAntiAffinity</code> + å¤šèŠ‚ç‚¹ç»„</li></ol><h2 id="Controller-Managerå’ŒScheduleråœ¨Podåˆ›å»ºä¸­çš„ä½œç”¨"><a href="#Controller-Managerå’ŒScheduleråœ¨Podåˆ›å»ºä¸­çš„ä½œç”¨" class="headerlink" title="Controller Managerå’ŒScheduleråœ¨Podåˆ›å»ºä¸­çš„ä½œç”¨"></a>Controller Managerå’ŒScheduleråœ¨Podåˆ›å»ºä¸­çš„ä½œç”¨</h2><hr><h3 id="æ§åˆ¶å™¨å“åº”é˜¶æ®µæ·±åº¦è§£æ"><a href="#æ§åˆ¶å™¨å“åº”é˜¶æ®µæ·±åº¦è§£æ" class="headerlink" title="æ§åˆ¶å™¨å“åº”é˜¶æ®µæ·±åº¦è§£æ"></a><strong>æ§åˆ¶å™¨å“åº”é˜¶æ®µæ·±åº¦è§£æ</strong></h3><h4 id="æ ¸å¿ƒç»„ä»¶åˆ†å·¥"><a href="#æ ¸å¿ƒç»„ä»¶åˆ†å·¥" class="headerlink" title="æ ¸å¿ƒç»„ä»¶åˆ†å·¥"></a><strong>æ ¸å¿ƒç»„ä»¶åˆ†å·¥</strong></h4><pre><code class=" mermaid">graph LRA[Controller Manager] --&gt;|ç®¡ç†å·¥ä½œè´Ÿè½½æ§åˆ¶å™¨| B[ReplicaSet/Deploymentç­‰]C[Scheduler] --&gt;|ä¸“å±è°ƒåº¦å™¨| D[ç»‘å®šèŠ‚ç‚¹]E[æ— ä¸»Pod] --&gt;|ç›´æ¥è¿›å…¥| CB --&gt;|åˆ›å»ºå‰¯æœ¬Pod| C</code></pre><hr><h3 id="ä¸€ã€Controller-Managerçš„ä½œç”¨ï¼ˆæ§åˆ¶é¢ç®¡å®¶ï¼‰"><a href="#ä¸€ã€Controller-Managerçš„ä½œç”¨ï¼ˆæ§åˆ¶é¢ç®¡å®¶ï¼‰" class="headerlink" title="ä¸€ã€Controller Managerçš„ä½œç”¨ï¼ˆæ§åˆ¶é¢ç®¡å®¶ï¼‰"></a><strong>ä¸€ã€Controller Managerçš„ä½œç”¨ï¼ˆæ§åˆ¶é¢ç®¡å®¶ï¼‰</strong></h3><p><strong>èŒè´£</strong>ï¼šç®¡ç†å„ç±»<strong>å·¥ä½œè´Ÿè½½æ§åˆ¶å™¨</strong>ï¼Œç¡®ä¿ç³»ç»ŸçŠ¶æ€ç¬¦åˆç”¨æˆ·å£°æ˜<br><strong>æ¶‰åŠæ§åˆ¶å™¨</strong>ï¼š  </p><ol><li><strong>ReplicaSetæ§åˆ¶å™¨</strong>ï¼ˆè‹¥Podç”±Deploymentåˆ›å»ºï¼‰<ul><li>ç›‘å¬åˆ°Deploymentåˆ›å»º â†’ ç”ŸæˆReplicaSet â†’ ReplicaSetåˆ›å»ºPodå‰¯æœ¬</li><li>æŒç»­æ£€æŸ¥ï¼šå®é™…Podæ•° vs æœŸæœ›å‰¯æœ¬æ•°</li></ul></li><li><strong>DaemonSetæ§åˆ¶å™¨</strong>ï¼ˆè‹¥ä¸ºDaemonSet Podï¼‰<ul><li>ç¡®ä¿æ¯ä¸ªåŒ¹é…èŠ‚ç‚¹è¿è¡Œä¸€ä¸ªPodå‰¯æœ¬</li></ul></li><li><strong>Jobæ§åˆ¶å™¨</strong>ï¼ˆä¸€æ¬¡æ€§ä»»åŠ¡ï¼‰<ul><li>åˆ›å»ºPodç›´åˆ°å®Œæˆä»»åŠ¡è®¡æ•°</li></ul></li></ol><p><strong>å…³é”®åŠ¨ä½œ</strong>ï¼š  </p><ul><li><strong>åˆ›å»ºè£¸Podæ—¶</strong>ï¼šController Manager<strong>ä¸ä¼šä»‹å…¥</strong>ï¼ˆæ— å…³è”æ§åˆ¶å™¨ï¼‰</li><li><strong>å·¥ä½œè´Ÿè½½Podåˆ›å»ºæ—¶</strong>ï¼š  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ä¼ªä»£ç æµç¨‹</span><br><span class="hljs-keyword">if</span> ç”¨æˆ·åˆ›å»ºDeployment &#123;<br>  ReplicaSetæ§åˆ¶å™¨åˆ›å»ºPodå¯¹è±¡ï¼ˆæœªè°ƒåº¦çŠ¶æ€ï¼‰<br>  å†™å…¥etcd â†’ è§¦å‘è°ƒåº¦å™¨å·¥ä½œ<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><hr><h3 id="äºŒã€Schedulerçš„ä½œç”¨ï¼ˆè°ƒåº¦ä¸“å®¶ï¼‰"><a href="#äºŒã€Schedulerçš„ä½œç”¨ï¼ˆè°ƒåº¦ä¸“å®¶ï¼‰" class="headerlink" title="äºŒã€Schedulerçš„ä½œç”¨ï¼ˆè°ƒåº¦ä¸“å®¶ï¼‰"></a><strong>äºŒã€Schedulerçš„ä½œç”¨ï¼ˆè°ƒåº¦ä¸“å®¶ï¼‰</strong></h3><p><strong>ä¸“å±èŒè´£</strong>ï¼šä¸º<strong>æœªåˆ†é…èŠ‚ç‚¹çš„Pod</strong>é€‰æ‹©æœ€ä½³è¿è¡ŒèŠ‚ç‚¹<br><strong>è§¦å‘æ¡ä»¶</strong>ï¼šPodæ»¡è¶³ <code>spec.nodeName == &quot;&quot;</code><br><strong>å·¥ä½œæµç¨‹</strong>ï¼š  </p><pre><code class=" mermaid">sequenceDiagram    Scheduler-&gt;&gt;API Server: Watchæœªè°ƒåº¦Pod    API Server-&gt;&gt;etcd: æŒä¹…åŒ–PodçŠ¶æ€    Scheduler-&gt;&gt;Scheduler: æ‰§è¡Œè°ƒåº¦ç®—æ³•    Scheduler-&gt;&gt;API Server: å‘é€Bindingè¯·æ±‚    API Server-&gt;&gt;etcd: æ›´æ–°Pod.spec.nodeName</code></pre><p><strong>å…·ä½“å†³ç­–æ­¥éª¤</strong>ï¼š  </p><ol><li><strong>é¢„é€‰ï¼ˆPredicatesï¼‰</strong>ï¼šç¡¬ä»¶è¿‡æ»¤  <ul><li>æ£€æŸ¥å€™é€‰èŠ‚ç‚¹ï¼šCPU&#x2F;Memoryæ˜¯å¦å……è¶³ã€ç«¯å£å†²çªã€èŠ‚ç‚¹æ±¡ç‚¹å®¹å¿ç­‰  </li><li><em>ç¤ºä¾‹</em>ï¼šæ’é™¤åªæœ‰4GBå†…å­˜çš„èŠ‚ç‚¹ï¼ˆPodè¯·æ±‚8GBï¼‰</li></ul></li><li><strong>ä¼˜é€‰ï¼ˆPrioritiesï¼‰</strong>ï¼šè½¯æ€§è¯„åˆ†  <ul><li>è®¡ç®—èŠ‚ç‚¹å¾—åˆ†ï¼šèµ„æºå¹³è¡¡ï¼ˆé€‰æ‹©ç©ºé—²CPUæœ€å¤šçš„ï¼‰ã€äº²å’Œæ€§ç­–ç•¥ç­‰  </li><li><em>ç¤ºä¾‹</em>ï¼šç»™åŒå¯ç”¨åŒºçš„èŠ‚ç‚¹+10åˆ†</li></ul></li><li><strong>ç»‘å®šï¼ˆBindï¼‰</strong>ï¼š  <ul><li>å°†æœ€ä¼˜èŠ‚ç‚¹åå†™å…¥Podçš„<code>spec.nodeName</code>å­—æ®µ  </li><li><strong>æ³¨æ„</strong>ï¼šSchedulerä¸ç›´æ¥æ“ä½œkubeletï¼Œåªæ›´æ–°APIå¯¹è±¡</li></ul></li></ol><hr><h3 id="ä¸‰ã€å…³é”®äº¤äº’æ¡ˆä¾‹"><a href="#ä¸‰ã€å…³é”®äº¤äº’æ¡ˆä¾‹" class="headerlink" title="ä¸‰ã€å…³é”®äº¤äº’æ¡ˆä¾‹"></a><strong>ä¸‰ã€å…³é”®äº¤äº’æ¡ˆä¾‹</strong></h3><h4 id="åœºæ™¯1ï¼šåˆ›å»ºè£¸Podï¼ˆæ— æ§åˆ¶å™¨ç®¡ç†ï¼‰"><a href="#åœºæ™¯1ï¼šåˆ›å»ºè£¸Podï¼ˆæ— æ§åˆ¶å™¨ç®¡ç†ï¼‰" class="headerlink" title="åœºæ™¯1ï¼šåˆ›å»ºè£¸Podï¼ˆæ— æ§åˆ¶å™¨ç®¡ç†ï¼‰"></a><strong>åœºæ™¯1ï¼šåˆ›å»ºè£¸Podï¼ˆæ— æ§åˆ¶å™¨ç®¡ç†ï¼‰</strong></h4><ol><li><code>kubectl create -f pod.yaml</code> â†’ API Serverç›´å†™etcd</li><li><strong>Scheduler</strong> æ£€æµ‹åˆ°è¯¥Podæ— èŠ‚ç‚¹ â†’ å¯åŠ¨è°ƒåº¦æµç¨‹</li><li>ç»‘å®šèŠ‚ç‚¹å â†’ ç›®æ ‡èŠ‚ç‚¹<strong>kubelet</strong>æ¥ç®¡</li></ol><h4 id="åœºæ™¯2ï¼šé€šè¿‡Deploymentåˆ›å»ºPod"><a href="#åœºæ™¯2ï¼šé€šè¿‡Deploymentåˆ›å»ºPod" class="headerlink" title="åœºæ™¯2ï¼šé€šè¿‡Deploymentåˆ›å»ºPod"></a><strong>åœºæ™¯2ï¼šé€šè¿‡Deploymentåˆ›å»ºPod</strong></h4><ol><li>ç”¨æˆ·åˆ›å»ºDeployment â†’ <strong>Controller Manager</strong>ä¸­çš„Deploymentæ§åˆ¶å™¨æ¿€æ´»</li><li>Deploymentåˆ›å»ºReplicaSet â†’ <strong>ReplicaSetæ§åˆ¶å™¨</strong>ç”ŸæˆPodæ¨¡æ¿ï¼ˆæœªè°ƒåº¦ï¼‰</li><li><strong>Scheduler</strong> å‘ç°æœªè°ƒåº¦Pod â†’ æ‰§è¡ŒèŠ‚ç‚¹ç»‘å®š</li><li><strong>kubelet</strong> å¯åŠ¨å®¹å™¨ â†’ ReplicaSetæ§åˆ¶å™¨æŒç»­ç›‘æ§PodçŠ¶æ€</li></ol><hr><h3 id="å››ã€æ•…éšœæ’æŸ¥èšç„¦ç‚¹"><a href="#å››ã€æ•…éšœæ’æŸ¥èšç„¦ç‚¹" class="headerlink" title="å››ã€æ•…éšœæ’æŸ¥èšç„¦ç‚¹"></a><strong>å››ã€æ•…éšœæ’æŸ¥èšç„¦ç‚¹</strong></h3><table><thead><tr><th>ç»„ä»¶</th><th>æ•…éšœè¡¨ç°</th><th>æ’æŸ¥å‘½ä»¤</th><th>æ—¥å¿—ä½ç½®</th></tr></thead><tbody><tr><td>Controller Manager</td><td>Podæœªè¢«åˆ›å»º</td><td><code>kubectl get rs -o wide</code></td><td>MasterèŠ‚ç‚¹<code>/var/log/kube-controller-manager.log</code></td></tr><tr><td>Scheduler</td><td>Podå¡åœ¨Pending</td><td><code>kubectl describe pod</code> çœ‹Events</td><td>MasterèŠ‚ç‚¹<code>/var/log/kube-scheduler.log</code></td></tr><tr><td>kubelet</td><td>Podå¯åŠ¨å¤±è´¥</td><td><code>journalctl -u kubelet</code></td><td>WorkerèŠ‚ç‚¹<code>/var/log/kubelet.log</code></td></tr></tbody></table><hr><h3 id="äº”ã€å®éªŒéªŒè¯ï¼ˆåŠ¨æ‰‹ç†è§£ï¼‰"><a href="#äº”ã€å®éªŒéªŒè¯ï¼ˆåŠ¨æ‰‹ç†è§£ï¼‰" class="headerlink" title="äº”ã€å®éªŒéªŒè¯ï¼ˆåŠ¨æ‰‹ç†è§£ï¼‰"></a><strong>äº”ã€å®éªŒéªŒè¯ï¼ˆåŠ¨æ‰‹ç†è§£ï¼‰</strong></h3><ol><li><p><strong>è§‚å¯Ÿè°ƒåº¦å™¨å†³ç­–</strong>ï¼š  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># è·Ÿè¸ªè°ƒåº¦æ—¥å¿—ï¼ˆéœ€é…ç½®æ—¥å¿—çº§åˆ«ï¼‰</span><br>kubectl logs -n kube-system &lt;scheduler-pod&gt; --<span class="hljs-built_in">tail</span>=50 | grep <span class="hljs-string">&quot;Scheduling&quot;</span><br></code></pre></td></tr></table></figure><p><strong>è¾“å‡ºç¤ºä¾‹</strong>ï¼š<br><code>&quot;Successfully assigned default/nginx-5ffd6d7cdf-abc12 to worker-02&quot;</code></p></li><li><p><strong>æ¨¡æ‹Ÿè°ƒåº¦å¤±è´¥</strong>ï¼š  </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># åˆ›å»ºå¿…å®šè°ƒåº¦å¤±è´¥çš„Pod</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">impossible-pod</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">test</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-attr">requests:</span><br>        <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;999&quot;</span>  <span class="hljs-comment"># è¶…è¿‡èŠ‚ç‚¹æ€»CPU</span><br>  <span class="hljs-attr">nodeSelector:</span><br>    <span class="hljs-attr">disktype:</span> <span class="hljs-string">ssd</span>   <span class="hljs-comment"># èŠ‚ç‚¹æ— æ­¤æ ‡ç­¾</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl describe pod impossible-pod<br><span class="hljs-comment"># Eventsæ˜¾ç¤ºï¼š</span><br><span class="hljs-comment"># 0/3 nodes available: 1 node(s) didn&#x27;t match Pod&#x27;s node affinity...</span><br></code></pre></td></tr></table></figure></li></ol><hr><h3 id="å…³é”®ç»“è®º"><a href="#å…³é”®ç»“è®º" class="headerlink" title="å…³é”®ç»“è®º"></a><strong>å…³é”®ç»“è®º</strong></h3><ol><li><strong>Controller Manager</strong>  <ul><li>ç®¡ç†<strong>å·¥ä½œè´Ÿè½½æ§åˆ¶å™¨</strong>ï¼ˆReplicaSet&#x2F;DaemonSetç­‰ï¼‰  </li><li><strong>ä¸ç›´æ¥å¤„ç†è°ƒåº¦</strong>ï¼Œåªç¡®ä¿Podå‰¯æœ¬æ•°ç¬¦åˆé¢„æœŸ</li></ul></li><li><strong>Scheduler</strong>  <ul><li>ä¸“å±å¤„ç†<strong>èŠ‚ç‚¹ç»‘å®šå†³ç­–</strong>  </li><li>ç‹¬ç«‹äºController Managerè¿è¡Œ  </li><li>åªå…³å¿ƒ <code>spec.nodeName==&quot;&quot;</code> çš„Pod</li></ul></li><li><strong>åä½œæœ¬è´¨</strong>ï¼š  <pre><code class=" mermaid">graph LRetcd--&gt;|çŠ¶æ€å­˜å‚¨| A[Controller Manager]etcd--&gt;|çŠ¶æ€å­˜å‚¨| B[Scheduler]A--&gt;|åˆ›å»ºæœªè°ƒåº¦Pod| etcdB--&gt;|ç›‘å¬æœªè°ƒåº¦Pod| etcd</code></pre></li></ol><blockquote><p>æ•™å­¦å»ºè®®ï¼šç”¨ä¹é«˜ç§¯æœ¨æ¯”å–»â€”â€”Controller Manageræ˜¯ç”Ÿäº§ç§¯æœ¨çš„å·¥å‚ï¼ŒScheduleræ˜¯å†³å®šç§¯æœ¨æ”¾åœ¨å“ªä¸ªä½ç½®çš„åˆ†é…å‘˜ï¼Œkubeletæ˜¯æœ€ç»ˆæ‹¼è£…ç§¯æœ¨çš„å·¥äººã€‚</p></blockquote>]]></content>
    
    
    
    <tags>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>k8så¹³å°æ’é”™ä¸€è§ˆå›¾</title>
    <link href="/2025/03/31/k8s%E5%B9%B3%E5%8F%B0%E6%8E%92%E9%94%99%E4%B8%80%E8%A7%88%E5%9B%BE/"/>
    <url>/2025/03/31/k8s%E5%B9%B3%E5%8F%B0%E6%8E%92%E9%94%99%E4%B8%80%E8%A7%88%E5%9B%BE/</url>
    
    <content type="html"><![CDATA[<h1 id="k8sæ’é”™ä¸€è§ˆå›¾"><a href="#k8sæ’é”™ä¸€è§ˆå›¾" class="headerlink" title="k8sæ’é”™ä¸€è§ˆå›¾"></a>k8sæ’é”™ä¸€è§ˆå›¾</h1><p>è½¬è‡ªï¼š<a href="https://dbwu.tech/posts/k8s/source_code/pod_create/">https://dbwu.tech/posts/k8s/source_code/pod_create/</a></p><p><img src="/2025/03/31/k8s%E5%B9%B3%E5%8F%B0%E6%8E%92%E9%94%99%E4%B8%80%E8%A7%88%E5%9B%BE/k8s-pod-debug-flow.jpeg" alt="Pod Debug æµç¨‹å›¾"></p>]]></content>
    
    
    
    <tags>
      
      <tag>k8szh</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golangå®ç°M:Nç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹</title>
    <link href="/2025/03/31/Golang%E5%AE%9E%E7%8E%B0M-N%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9E%8B/"/>
    <url>/2025/03/31/Golang%E5%AE%9E%E7%8E%B0M-N%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="Golangå®ç°M-Nç”Ÿäº§è€…æ¶ˆè´¹è€…é˜Ÿåˆ—ï¼ˆå¸¦5ç§’è¶…æ—¶ä¸¢å¼ƒæœºåˆ¶ï¼‰"><a href="#Golangå®ç°M-Nç”Ÿäº§è€…æ¶ˆè´¹è€…é˜Ÿåˆ—ï¼ˆå¸¦5ç§’è¶…æ—¶ä¸¢å¼ƒæœºåˆ¶ï¼‰" class="headerlink" title="Golangå®ç°M:Nç”Ÿäº§è€…æ¶ˆè´¹è€…é˜Ÿåˆ—ï¼ˆå¸¦5ç§’è¶…æ—¶ä¸¢å¼ƒæœºåˆ¶ï¼‰"></a>Golangå®ç°M:Nç”Ÿäº§è€…æ¶ˆè´¹è€…é˜Ÿåˆ—ï¼ˆå¸¦5ç§’è¶…æ—¶ä¸¢å¼ƒæœºåˆ¶ï¼‰</h1><p>ä¸‹é¢æ˜¯ä¸€ä¸ªå®Œæ•´çš„Goå®ç°ï¼ŒåŒ…å«Mä¸ªç”Ÿäº§è€…å’ŒNä¸ªæ¶ˆè´¹è€…çš„é˜Ÿåˆ—ç³»ç»Ÿï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ½æœ‰5ç§’è¶…æ—¶ä¸¢å¼ƒæœºåˆ¶ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;context&quot;</span><br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;math/rand&quot;</span><br><span class="hljs-string">&quot;sync&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> Task <span class="hljs-keyword">struct</span> &#123;<br>ID       <span class="hljs-type">int</span><br>Data     <span class="hljs-keyword">interface</span>&#123;&#125;<br>produced time.Time<br>&#125;<br><br><span class="hljs-keyword">type</span> Queue <span class="hljs-keyword">struct</span> &#123;<br>tasks      <span class="hljs-keyword">chan</span> Task<br>timeout    time.Duration<br>producerWg sync.WaitGroup<br>consumerWg sync.WaitGroup<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewQueue</span><span class="hljs-params">(bufferSize <span class="hljs-type">int</span>, timeout time.Duration)</span></span> *Queue &#123;<br><span class="hljs-keyword">return</span> &amp;Queue&#123;<br>tasks:   <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> Task, bufferSize),<br>timeout: timeout,<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Producer ç”Ÿäº§è€…</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *Queue)</span></span> Producer(id <span class="hljs-type">int</span>, ctx context.Context) &#123;<br><span class="hljs-keyword">defer</span> q.producerWg.Done()<br><br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-ctx.Done():<br>fmt.Printf(<span class="hljs-string">&quot;Producer %d exiting\n&quot;</span>, id)<br><span class="hljs-keyword">return</span><br><span class="hljs-keyword">default</span>:<br><span class="hljs-comment">// æ¨¡æ‹Ÿç”Ÿäº§ä»»åŠ¡</span><br>task := Task&#123;<br>ID:       rand.Intn(<span class="hljs-number">1000</span>),<br>Data:     fmt.Sprintf(<span class="hljs-string">&quot;Data from producer %d&quot;</span>, id),<br>produced: time.Now(),<br>&#125;<br><br><span class="hljs-comment">// å°è¯•å‘é€ä»»åŠ¡ï¼Œå¸¦è¶…æ—¶</span><br>ctxSend, cancel := context.WithTimeout(ctx, q.timeout)<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> q.tasks &lt;- task:<br>fmt.Printf(<span class="hljs-string">&quot;Producer %d produced task %d\n&quot;</span>, id, task.ID)<br><span class="hljs-keyword">case</span> &lt;-ctxSend.Done():<br>fmt.Printf(<span class="hljs-string">&quot;Producer %d timeout, discarding task %d\n&quot;</span>, id, task.ID)<br>&#125;<br>cancel()<br><br><span class="hljs-comment">// æ¨¡æ‹Ÿç”Ÿäº§é—´éš”</span><br>time.Sleep(time.Duration(rand.Intn(<span class="hljs-number">1500</span>)) * time.Millisecond)<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Consumer æ¶ˆè´¹è€…</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *Queue)</span></span> Consumer(id <span class="hljs-type">int</span>, ctx context.Context) &#123;<br><span class="hljs-keyword">defer</span> q.consumerWg.Done()<br><br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-ctx.Done():<br>fmt.Printf(<span class="hljs-string">&quot;Consumer %d exiting\n&quot;</span>, id)<br><span class="hljs-keyword">return</span><br><span class="hljs-keyword">default</span>:<br><span class="hljs-comment">// å°è¯•æ¥æ”¶ä»»åŠ¡ï¼Œå¸¦è¶…æ—¶</span><br>ctxRecv, cancel := context.WithTimeout(ctx, q.timeout)<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> task := &lt;-q.tasks:<br><span class="hljs-comment">// æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å·²ç»è¶…æ—¶ï¼ˆä»ç”Ÿäº§åˆ°æ¶ˆè´¹ï¼‰</span><br><span class="hljs-keyword">if</span> time.Since(task.produced) &gt; q.timeout &#123;<br>fmt.Printf(<span class="hljs-string">&quot;Consumer %d discarded expired task %d (age: %v)\n&quot;</span>, <br>id, task.ID, time.Since(task.produced))<br><span class="hljs-keyword">continue</span><br>&#125;<br><span class="hljs-comment">// å¤„ç†ä»»åŠ¡</span><br>fmt.Printf(<span class="hljs-string">&quot;Consumer %d processing task %d: %v\n&quot;</span>, id, task.ID, task.Data)<br><span class="hljs-comment">// æ¨¡æ‹Ÿå¤„ç†æ—¶é—´</span><br>time.Sleep(time.Duration(rand.Intn(<span class="hljs-number">2000</span>)) * time.Millisecond)<br><span class="hljs-keyword">case</span> &lt;-ctxRecv.Done():<br>fmt.Printf(<span class="hljs-string">&quot;Consumer %d timeout waiting for task\n&quot;</span>, id)<br>&#125;<br>cancel()<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// é…ç½®å‚æ•°</span><br><span class="hljs-keyword">const</span> (<br>producerCount = <span class="hljs-number">3</span><br>consumerCount = <span class="hljs-number">2</span><br>bufferSize    = <span class="hljs-number">10</span><br>timeout       = <span class="hljs-number">5</span> * time.Second<br>runtime       = <span class="hljs-number">20</span> * time.Second<br>)<br><br><span class="hljs-comment">// åˆ›å»ºé˜Ÿåˆ—</span><br>queue := NewQueue(bufferSize, timeout)<br><br><span class="hljs-comment">// åˆ›å»ºä¸Šä¸‹æ–‡ï¼Œç”¨äºæ§åˆ¶goroutineé€€å‡º</span><br>ctx, cancel := context.WithTimeout(context.Background(), runtime)<br><span class="hljs-keyword">defer</span> cancel()<br><br><span class="hljs-comment">// å¯åŠ¨ç”Ÿäº§è€…</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt;= producerCount; i++ &#123;<br>queue.producerWg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> queue.Producer(i, ctx)<br>&#125;<br><br><span class="hljs-comment">// å¯åŠ¨æ¶ˆè´¹è€…</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt;= consumerCount; i++ &#123;<br>queue.consumerWg.Add(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">go</span> queue.Consumer(i, ctx)<br>&#125;<br><br><span class="hljs-comment">// ç­‰å¾…æ‰€æœ‰ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é€€å‡º</span><br>queue.producerWg.Wait()<br><span class="hljs-built_in">close</span>(queue.tasks) <span class="hljs-comment">// å…³é—­é€šé“ï¼Œæ¶ˆè´¹è€…å¯ä»¥é€€å‡º</span><br>queue.consumerWg.Wait()<br><br>fmt.Println(<span class="hljs-string">&quot;All producers and consumers exited&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="åŠŸèƒ½è¯´æ˜"><a href="#åŠŸèƒ½è¯´æ˜" class="headerlink" title="åŠŸèƒ½è¯´æ˜"></a>åŠŸèƒ½è¯´æ˜</h2><ol><li><strong>ç”Ÿäº§è€…è¶…æ—¶æœºåˆ¶</strong>ï¼š<ul><li>æ¯ä¸ªç”Ÿäº§è€…å°è¯•å°†ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—æ—¶ï¼Œæœ‰5ç§’çš„è¶…æ—¶é™åˆ¶</li><li>å¦‚æœ5ç§’å†…æ— æ³•æ”¾å…¥é˜Ÿåˆ—ï¼ˆé˜Ÿåˆ—æ»¡ï¼‰ï¼Œåˆ™ä¸¢å¼ƒè¯¥ä»»åŠ¡</li></ul></li><li><strong>æ¶ˆè´¹è€…è¶…æ—¶æœºåˆ¶</strong>ï¼š<ul><li>æ¯ä¸ªæ¶ˆè´¹è€…å°è¯•ä»é˜Ÿåˆ—è·å–ä»»åŠ¡æ—¶ï¼Œæœ‰5ç§’çš„è¶…æ—¶é™åˆ¶</li><li>å¦‚æœ5ç§’å†…æ²¡æœ‰è·å–åˆ°ä»»åŠ¡ï¼Œåˆ™ç»§ç»­å°è¯•</li></ul></li><li><strong>ä»»åŠ¡è¿‡æœŸæ£€æŸ¥</strong>ï¼š<ul><li>æ¶ˆè´¹è€…è·å–ä»»åŠ¡åï¼Œä¼šæ£€æŸ¥ä»»åŠ¡ä»ç”Ÿäº§åˆ°ç°åœ¨æ˜¯å¦å·²è¶…è¿‡5ç§’</li><li>å¦‚æœè¶…è¿‡ï¼Œåˆ™ç›´æ¥ä¸¢å¼ƒè¯¥ä»»åŠ¡</li></ul></li><li><strong>ä¼˜é›…é€€å‡º</strong>ï¼š<ul><li>ä½¿ç”¨contextæ§åˆ¶æ‰€æœ‰goroutineçš„é€€å‡º</li><li>ä¸»ç¨‹åºè¿è¡Œ20ç§’åè‡ªåŠ¨å…³é—­</li></ul></li></ol><h2 id="è¿è¡Œç¤ºä¾‹"><a href="#è¿è¡Œç¤ºä¾‹" class="headerlink" title="è¿è¡Œç¤ºä¾‹"></a>è¿è¡Œç¤ºä¾‹</h2><p>ç¨‹åºè¾“å‡ºç¤ºä¾‹ï¼ˆéƒ¨åˆ†ï¼‰ï¼š</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs gradle">Producer <span class="hljs-number">1</span> produced <span class="hljs-keyword">task</span> <span class="hljs-number">81</span><br>Producer <span class="hljs-number">2</span> produced <span class="hljs-keyword">task</span> <span class="hljs-number">887</span><br>Consumer <span class="hljs-number">1</span> processing <span class="hljs-keyword">task</span> <span class="hljs-number">81</span>: Data <span class="hljs-keyword">from</span> producer <span class="hljs-number">1</span><br>Consumer <span class="hljs-number">2</span> processing <span class="hljs-keyword">task</span> <span class="hljs-number">887</span>: Data <span class="hljs-keyword">from</span> producer <span class="hljs-number">2</span><br>Producer <span class="hljs-number">3</span> produced <span class="hljs-keyword">task</span> <span class="hljs-number">847</span><br>Producer <span class="hljs-number">1</span> timeout, discarding <span class="hljs-keyword">task</span> <span class="hljs-number">318</span><br>Consumer <span class="hljs-number">1</span> timeout waiting <span class="hljs-keyword">for</span> <span class="hljs-keyword">task</span><br>Consumer <span class="hljs-number">2</span> processing <span class="hljs-keyword">task</span> <span class="hljs-number">847</span>: Data <span class="hljs-keyword">from</span> producer <span class="hljs-number">3</span><br>...<br>All producers and consumers exited<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå®ç°æä¾›äº†å®Œæ•´çš„M:Nç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼Œå¹¶ç¡®ä¿äº†ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ½æœ‰5ç§’çš„è¶…æ—¶ä¸¢å¼ƒæœºåˆ¶ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>Golang</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golang-channelå®ç°åŸç†</title>
    <link href="/2025/03/31/Golang-channel%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/"/>
    <url>/2025/03/31/Golang-channel%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/</url>
    
    <content type="html"><![CDATA[<p>è½¬è‡ªï¼š<a href="https://zhuanlan.zhihu.com/p/597232906">https://zhuanlan.zhihu.com/p/597232906</a></p><p><img src="/2025/03/31/Golang-channel%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/v2-0f42d64ad820157d0bcf6370ded4abb0_1440w.jpg" alt="img"></p><p>ç”¨è¿‡ go çš„éƒ½çŸ¥é“ <a href="https://zhida.zhihu.com/search?content_id=220851325&content_type=Article&match_order=1&q=channel&zhida_source=entity">channel</a>ï¼Œæ— éœ€å¤šè¨€ï¼Œç›´æ¥å¼€æ•´ï¼</p><h2 id="1-æ ¸å¿ƒæ•°æ®ç»“æ„"><a href="#1-æ ¸å¿ƒæ•°æ®ç»“æ„" class="headerlink" title="1 æ ¸å¿ƒæ•°æ®ç»“æ„"></a>1 æ ¸å¿ƒæ•°æ®ç»“æ„</h2><p><img src="/2025/03/31/Golang-channel%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/v2-33e6558c73c76c439818cb4477bfb14a_1440w.jpg" alt="img"></p><h3 id="1-1-hchan"><a href="#1-1-hchan" class="headerlink" title="1.1 hchan"></a>1.1 hchan</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> hchan <span class="hljs-keyword">struct</span> &#123;<br>    qcount   <span class="hljs-type">uint</span>           <span class="hljs-comment">// total data in the queue</span><br>    dataqsiz <span class="hljs-type">uint</span>           <span class="hljs-comment">// size of the circular queue</span><br>    buf      unsafe.Pointer <span class="hljs-comment">// points to an array of dataqsiz elements</span><br>    elemsize <span class="hljs-type">uint16</span><br>    closed   <span class="hljs-type">uint32</span><br>    elemtype *_type <span class="hljs-comment">// element type</span><br>    sendx    <span class="hljs-type">uint</span>   <span class="hljs-comment">// send index</span><br>    recvx    <span class="hljs-type">uint</span>   <span class="hljs-comment">// receive index</span><br>    recvq    waitq  <span class="hljs-comment">// list of recv waiters</span><br>    sendq    waitq  <span class="hljs-comment">// list of send waiters</span><br><br>    lock mutex<br>&#125;<br></code></pre></td></tr></table></figure><p>hchanï¼š channel æ•°æ®ç»“æ„</p><p>ï¼ˆ1ï¼‰qcountï¼šå½“å‰ channel ä¸­å­˜åœ¨å¤šå°‘ä¸ªå…ƒç´ ï¼›</p><p>ï¼ˆ2ï¼‰dataqsize: å½“å‰ channel èƒ½å­˜æ”¾çš„å…ƒç´ å®¹é‡ï¼›</p><p>ï¼ˆ3ï¼‰bufï¼šchannel ä¸­ç”¨äºå­˜æ”¾å…ƒç´ çš„ç¯å½¢ç¼“å†²åŒºï¼›</p><p>ï¼ˆ4ï¼‰elemsizeï¼šchannel å…ƒç´ ç±»å‹çš„å¤§å°ï¼›</p><p>ï¼ˆ5ï¼‰closedï¼šæ ‡è¯† channel æ˜¯å¦å…³é—­ï¼›</p><p>ï¼ˆ6ï¼‰elemtypeï¼šchannel å…ƒç´ ç±»å‹ï¼›</p><p>ï¼ˆ7ï¼‰sendxï¼šå‘é€å…ƒç´ è¿›å…¥ç¯å½¢ç¼“å†²åŒºçš„ indexï¼›</p><p>ï¼ˆ8ï¼‰recvxï¼šæ¥æ”¶å…ƒç´ æ‰€å¤„çš„ç¯å½¢ç¼“å†²åŒºçš„ indexï¼›</p><p>ï¼ˆ9ï¼‰recvqï¼šå› æ¥æ”¶è€Œé™·å…¥é˜»å¡çš„åç¨‹é˜Ÿåˆ—ï¼›</p><p>ï¼ˆ10ï¼‰sendqï¼šå› å‘é€è€Œé™·å…¥é˜»å¡çš„åç¨‹é˜Ÿåˆ—ï¼›</p><h3 id="1-2-waitq"><a href="#1-2-waitq" class="headerlink" title="1.2 waitq"></a>1.2 waitq</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> waitq <span class="hljs-keyword">struct</span> &#123;<br>    first *sudog<br>    last  *sudog<br>&#125;<br></code></pre></td></tr></table></figure><p>waitqï¼šé˜»å¡çš„åç¨‹é˜Ÿåˆ—</p><p>ï¼ˆ1ï¼‰firstï¼šé˜Ÿåˆ—å¤´éƒ¨</p><p>ï¼ˆ2ï¼‰lastï¼šé˜Ÿåˆ—å°¾éƒ¨</p><h3 id="1-3-sudog"><a href="#1-3-sudog" class="headerlink" title="1.3 sudog"></a>1.3 sudog</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> sudog <span class="hljs-keyword">struct</span> &#123;<br>    g *g<br><br>    next *sudog<br>    prev *sudog<br>    elem unsafe.Pointer <span class="hljs-comment">// data element (may point to stack)</span><br>    <span class="hljs-comment">// ...</span><br>    c        *hchan <br>&#125;<br></code></pre></td></tr></table></figure><p>sudogï¼šç”¨äºåŒ…è£…åç¨‹çš„èŠ‚ç‚¹</p><p>ï¼ˆ1ï¼‰gï¼š<a href="https://zhida.zhihu.com/search?content_id=220851325&content_type=Article&match_order=1&q=goroutine&zhida_source=entity">goroutine</a>ï¼Œåç¨‹ï¼›</p><p>ï¼ˆ2ï¼‰nextï¼šé˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼›</p><p>ï¼ˆ3ï¼‰prevï¼šé˜Ÿåˆ—ä¸­çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼›</p><p>ï¼ˆ4ï¼‰elem: è¯»å–&#x2F;å†™å…¥ channel çš„æ•°æ®çš„å®¹å™¨;</p><p>ï¼ˆ5ï¼‰cï¼šæ ‡è¯†ä¸å½“å‰ sudog äº¤äº’çš„ chan.</p><h2 id="2-æ„é€ å™¨å‡½æ•°"><a href="#2-æ„é€ å™¨å‡½æ•°" class="headerlink" title="2 æ„é€ å™¨å‡½æ•°"></a>2 æ„é€ å™¨å‡½æ•°</h2><p><img src="/2025/03/31/Golang-channel%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/v2-112b94a7ac698ee34d0b4a7c5641f388_1440w.jpg" alt="img"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">makechan</span><span class="hljs-params">(t *chantype, size <span class="hljs-type">int</span>)</span></span> *hchan &#123;<br>    elem := t.elem<br><br>    <span class="hljs-comment">// ...</span><br>    mem, overflow := math.MulUintptr(elem.size, <span class="hljs-type">uintptr</span>(size))<br>    <span class="hljs-keyword">if</span> overflow || mem &gt; maxAlloc-hchanSize || size &lt; <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-built_in">panic</span>(plainError(<span class="hljs-string">&quot;makechan: size out of range&quot;</span>))<br>    &#125;<br><br>    <span class="hljs-keyword">var</span> c *hchan<br>    <span class="hljs-keyword">switch</span> &#123;<br>    <span class="hljs-keyword">case</span> mem == <span class="hljs-number">0</span>:<br>        <span class="hljs-comment">// Queue or element size is zero.</span><br>        c = (*hchan)(mallocgc(hchanSize, <span class="hljs-literal">nil</span>, <span class="hljs-literal">true</span>))<br>    <span class="hljs-keyword">case</span> elem.ptrdata == <span class="hljs-number">0</span>:<br>        <span class="hljs-comment">// Elements do not contain pointers.</span><br>        <span class="hljs-comment">// Allocate hchan and buf in one call.</span><br>        c = (*hchan)(mallocgc(hchanSize+mem, <span class="hljs-literal">nil</span>, <span class="hljs-literal">true</span>))<br>        c.buf = add(unsafe.Pointer(c), hchanSize)<br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-comment">// Elements contain pointers.</span><br>        c = <span class="hljs-built_in">new</span>(hchan)<br>        c.buf = mallocgc(mem, elem, <span class="hljs-literal">true</span>)<br>    &#125;<br><br>    c.elemsize = <span class="hljs-type">uint16</span>(elem.size)<br>    c.elemtype = elem<br>    c.dataqsiz = <span class="hljs-type">uint</span>(size)<br>    <br>    lockInit(&amp;c.lock, lockRankHchan)<br><br>    <span class="hljs-keyword">return</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ1ï¼‰åˆ¤æ–­ç”³è¯·å†…å­˜ç©ºé—´å¤§å°æ˜¯å¦è¶Šç•Œï¼Œmem å¤§å°ä¸º element ç±»å‹å¤§å°ä¸ element ä¸ªæ•°ç›¸ä¹˜åå¾—åˆ°ï¼Œä»…å½“æ— ç¼“å†²å‹ channel æ—¶ï¼Œå› ä¸ªæ•°ä¸º 0 å¯¼è‡´å¤§å°ä¸º 0ï¼›</p><p>ï¼ˆ2ï¼‰æ ¹æ®ç±»å‹ï¼Œåˆå§‹ channelï¼Œåˆ†ä¸º æ— ç¼“å†²å‹ã€æœ‰ç¼“å†²å…ƒç´ ä¸º struct å‹ã€æœ‰ç¼“å†²å…ƒç´ ä¸º pointer å‹ channel;</p><p>ï¼ˆ3ï¼‰å€˜è‹¥ä¸ºæ— ç¼“å†²å‹ï¼Œåˆ™ä»…ç”³è¯·ä¸€ä¸ªå¤§å°ä¸ºé»˜è®¤å€¼ 96 çš„ç©ºé—´ï¼›</p><p>ï¼ˆ4ï¼‰å¦‚è‹¥æœ‰ç¼“å†²çš„ struct å‹ï¼Œåˆ™ä¸€æ¬¡æ€§åˆ†é…å¥½ 96 + mem å¤§å°çš„ç©ºé—´ï¼Œå¹¶ä¸”è°ƒæ•´ chan çš„ buf æŒ‡å‘ mem çš„èµ·å§‹ä½ç½®ï¼›</p><p>ï¼ˆ5ï¼‰å€˜è‹¥ä¸ºæœ‰ç¼“å†²çš„ pointer å‹ï¼Œåˆ™åˆ†åˆ«ç”³è¯· chan å’Œ buf çš„ç©ºé—´ï¼Œä¸¤è€…æ— éœ€è¿ç»­ï¼›</p><p>ï¼ˆ6ï¼‰å¯¹ channel çš„å…¶ä½™å­—æ®µè¿›è¡Œåˆå§‹åŒ–ï¼ŒåŒ…æ‹¬å…ƒç´ ç±»å‹å¤§å°ã€å…ƒç´ ç±»å‹ã€å®¹é‡ä»¥åŠé”çš„åˆå§‹åŒ–.</p><h2 id="3-å†™æµç¨‹"><a href="#3-å†™æµç¨‹" class="headerlink" title="3 å†™æµç¨‹"></a>3 å†™æµç¨‹</h2><h3 id="3-1-ä¸¤ç±»å¼‚å¸¸æƒ…å†µå¤„ç†"><a href="#3-1-ä¸¤ç±»å¼‚å¸¸æƒ…å†µå¤„ç†" class="headerlink" title="3.1 ä¸¤ç±»å¼‚å¸¸æƒ…å†µå¤„ç†"></a>3.1 ä¸¤ç±»å¼‚å¸¸æƒ…å†µå¤„ç†</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">chansend1</span><span class="hljs-params">(c *hchan, elem unsafe.Pointer)</span></span> &#123;<br>    chansend(c, elem, <span class="hljs-literal">true</span>, getcallerpc())<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">chansend</span><span class="hljs-params">(c *hchan, ep unsafe.Pointer, block <span class="hljs-type">bool</span>, callerpc <span class="hljs-type">uintptr</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">if</span> c == <span class="hljs-literal">nil</span> &#123;<br>        gopark(<span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, waitReasonChanSendNilChan, traceEvGoStop, <span class="hljs-number">2</span>)<br>        throw(<span class="hljs-string">&quot;unreachable&quot;</span>)<br>    &#125;<br><br><br>    lock(&amp;c.lock)<br><br><br>    <span class="hljs-keyword">if</span> c.closed != <span class="hljs-number">0</span> &#123;<br>        unlock(&amp;c.lock)<br>        <span class="hljs-built_in">panic</span>(plainError(<span class="hljs-string">&quot;send on closed channel&quot;</span>))<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ1ï¼‰å¯¹äºæœªåˆå§‹åŒ–çš„ chanï¼Œå†™å…¥æ“ä½œä¼šå¼•å‘æ­»é”ï¼›</p><p>ï¼ˆ2ï¼‰å¯¹äºå·²å…³é—­çš„ chanï¼Œå†™å…¥æ“ä½œä¼šå¼•å‘ panic.</p><h3 id="3-2-case1ï¼šå†™æ—¶å­˜åœ¨é˜»å¡è¯»åç¨‹"><a href="#3-2-case1ï¼šå†™æ—¶å­˜åœ¨é˜»å¡è¯»åç¨‹" class="headerlink" title="3.2 case1ï¼šå†™æ—¶å­˜åœ¨é˜»å¡è¯»åç¨‹"></a>3.2 case1ï¼šå†™æ—¶å­˜åœ¨é˜»å¡è¯»åç¨‹</h3><p><img src="/2025/03/31/Golang-channel%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/v2-aeebdcfb97a933e7ab5a6629a9ec385c_1440w.jpg" alt="img"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">chansend</span><span class="hljs-params">(c *hchan, ep unsafe.Pointer, block <span class="hljs-type">bool</span>, callerpc <span class="hljs-type">uintptr</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-comment">// ...</span><br><br>    lock(&amp;c.lock)<br><br>    <span class="hljs-comment">// ...</span><br><br>    <span class="hljs-keyword">if</span> sg := c.recvq.dequeue(); sg != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-comment">// Found a waiting receiver. We pass the value we want to send</span><br>        <span class="hljs-comment">// directly to the receiver, bypassing the channel buffer (if any).</span><br>        send(c, sg, ep, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; unlock(&amp;c.lock) &#125;, <span class="hljs-number">3</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    &#125;<br>    <br>    <span class="hljs-comment">// ..</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ1ï¼‰åŠ é”ï¼›</p><p>ï¼ˆ2ï¼‰ä»é˜»å¡åº¦åç¨‹é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ª goroutine çš„å°è£…å¯¹è±¡ sudogï¼›</p><p>ï¼ˆ3ï¼‰åœ¨ send æ–¹æ³•ä¸­ï¼Œä¼šåŸºäº memmove æ–¹æ³•ï¼Œç›´æ¥å°†å…ƒç´ æ‹·è´äº¤ç»™ sudog å¯¹åº”çš„ goroutineï¼›</p><p>ï¼ˆ4ï¼‰åœ¨ send æ–¹æ³•ä¸­ä¼šå®Œæˆè§£é”åŠ¨ä½œ.</p><h3 id="3-3-case2ï¼šå†™æ—¶æ— é˜»å¡è¯»åç¨‹ä½†ç¯å½¢ç¼“å†²åŒºä»æœ‰ç©ºé—´"><a href="#3-3-case2ï¼šå†™æ—¶æ— é˜»å¡è¯»åç¨‹ä½†ç¯å½¢ç¼“å†²åŒºä»æœ‰ç©ºé—´" class="headerlink" title="3.3 case2ï¼šå†™æ—¶æ— é˜»å¡è¯»åç¨‹ä½†ç¯å½¢ç¼“å†²åŒºä»æœ‰ç©ºé—´"></a>3.3 case2ï¼šå†™æ—¶æ— é˜»å¡è¯»åç¨‹ä½†ç¯å½¢ç¼“å†²åŒºä»æœ‰ç©ºé—´</h3><p><img src="/2025/03/31/Golang-channel%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/v2-bbf306ebfd01a163e961ac366edd7f21_1440w.jpg" alt="img"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">chansend</span><span class="hljs-params">(c *hchan, ep unsafe.Pointer, block <span class="hljs-type">bool</span>, callerpc <span class="hljs-type">uintptr</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-comment">// ...</span><br>    lock(&amp;c.lock)<br>    <span class="hljs-comment">// ...</span><br>    <span class="hljs-keyword">if</span> c.qcount &lt; c.dataqsiz &#123;<br>        <span class="hljs-comment">// Space is available in the channel buffer. Enqueue the element to send.</span><br>        qp := chanbuf(c, c.sendx)<br>        typedmemmove(c.elemtype, qp, ep)<br>        c.sendx++<br>        <span class="hljs-keyword">if</span> c.sendx == c.dataqsiz &#123;<br>            c.sendx = <span class="hljs-number">0</span><br>        &#125;<br>        c.qcount++<br>        unlock(&amp;c.lock)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    &#125;<br><br><br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ1ï¼‰åŠ é”ï¼›</p><p>ï¼ˆ2ï¼‰å°†å½“å‰å…ƒç´ æ·»åŠ åˆ°ç¯å½¢ç¼“å†²åŒº sendx å¯¹åº”çš„ä½ç½®ï¼›</p><p>ï¼ˆ3ï¼‰sendx++;</p><p>ï¼ˆ4ï¼‰qcount++;</p><p>ï¼ˆ4ï¼‰è§£é”ï¼Œè¿”å›.</p><h3 id="3-4-case3ï¼šå†™æ—¶æ— é˜»å¡è¯»åç¨‹ä¸”ç¯å½¢ç¼“å†²åŒºæ— ç©ºé—´"><a href="#3-4-case3ï¼šå†™æ—¶æ— é˜»å¡è¯»åç¨‹ä¸”ç¯å½¢ç¼“å†²åŒºæ— ç©ºé—´" class="headerlink" title="3.4 case3ï¼šå†™æ—¶æ— é˜»å¡è¯»åç¨‹ä¸”ç¯å½¢ç¼“å†²åŒºæ— ç©ºé—´"></a>3.4 case3ï¼šå†™æ—¶æ— é˜»å¡è¯»åç¨‹ä¸”ç¯å½¢ç¼“å†²åŒºæ— ç©ºé—´</h3><p><img src="/2025/03/31/Golang-channel%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/v2-0add82424b36cbd0a5edf54d115cf4db_1440w.jpg" alt="img"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">chansend</span><span class="hljs-params">(c *hchan, ep unsafe.Pointer, block <span class="hljs-type">bool</span>, callerpc <span class="hljs-type">uintptr</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-comment">// ...</span><br>    lock(&amp;c.lock)<br><br>    <span class="hljs-comment">// ...</span><br>    gp := getg()<br>    mysg := acquireSudog()<br>    mysg.elem = ep<br>    mysg.g = gp<br>    mysg.c = c<br>    gp.waiting = mysg<br>    c.sendq.enqueue(mysg)<br>    <br>    atomic.Store8(&amp;gp.parkingOnChan, <span class="hljs-number">1</span>)<br>    gopark(chanparkcommit, unsafe.Pointer(&amp;c.lock), waitReasonChanSend, traceEvGoBlockSend, <span class="hljs-number">2</span>)<br>    <br>    gp.waiting = <span class="hljs-literal">nil</span><br>    closed := !mysg.success<br>    gp.param = <span class="hljs-literal">nil</span><br>    mysg.c = <span class="hljs-literal">nil</span><br>    releaseSudog(mysg)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ1ï¼‰åŠ é”ï¼›</p><p>ï¼ˆ2ï¼‰æ„é€ å°è£…å½“å‰ goroutine çš„ sudog å¯¹è±¡ï¼›</p><p>ï¼ˆ3ï¼‰å®ŒæˆæŒ‡é’ˆæŒ‡å‘ï¼Œå»ºç«‹ sudogã€goroutineã€channel ä¹‹é—´çš„æŒ‡å‘å…³ç³»ï¼›</p><p>ï¼ˆ4ï¼‰æŠŠ sudog æ·»åŠ åˆ°å½“å‰ channel çš„é˜»å¡å†™åç¨‹é˜Ÿåˆ—ä¸­ï¼›</p><p>ï¼ˆ5ï¼‰park å½“å‰åç¨‹ï¼›</p><p>ï¼ˆ6ï¼‰å€˜è‹¥åç¨‹ä» park ä¸­è¢«å”¤é†’ï¼Œåˆ™å›æ”¶ sudogï¼ˆsudogèƒ½è¢«å”¤é†’ï¼Œå…¶å¯¹åº”çš„å…ƒç´ å¿…ç„¶å·²ç»è¢«è¯»åç¨‹å–èµ°ï¼‰ï¼›</p><p>ï¼ˆ7ï¼‰è§£é”ï¼Œè¿”å›</p><h3 id="3-5-å†™æµç¨‹æ•´ä½“ä¸²è”"><a href="#3-5-å†™æµç¨‹æ•´ä½“ä¸²è”" class="headerlink" title="3.5 å†™æµç¨‹æ•´ä½“ä¸²è”"></a>3.5 å†™æµç¨‹æ•´ä½“ä¸²è”</h3><p><img src="/2025/03/31/Golang-channel%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/v2-152528930008eb3508fcb0b5ffe480a3_1440w.jpg" alt="img"></p><h2 id="4-è¯»æµç¨‹"><a href="#4-è¯»æµç¨‹" class="headerlink" title="4 è¯»æµç¨‹"></a>4 è¯»æµç¨‹</h2><h3 id="4-1-å¼‚å¸¸-case1ï¼šè¯»ç©º-channel"><a href="#4-1-å¼‚å¸¸-case1ï¼šè¯»ç©º-channel" class="headerlink" title="4.1 å¼‚å¸¸ case1ï¼šè¯»ç©º channel"></a>4.1 å¼‚å¸¸ case1ï¼šè¯»ç©º channel</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">chanrecv</span><span class="hljs-params">(c *hchan, ep unsafe.Pointer, block <span class="hljs-type">bool</span>)</span></span> (selected, received <span class="hljs-type">bool</span>) &#123;<br>    <span class="hljs-keyword">if</span> c == <span class="hljs-literal">nil</span> &#123;<br>        gopark(<span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, waitReasonChanReceiveNilChan, traceEvGoStop, <span class="hljs-number">2</span>)<br>        throw(<span class="hljs-string">&quot;unreachable&quot;</span>)<br>    &#125;<br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ1ï¼‰park æŒ‚èµ·ï¼Œå¼•èµ·æ­»é”ï¼›</p><h3 id="4-2-å¼‚å¸¸-case2ï¼šchannel-å·²å…³é—­ä¸”å†…éƒ¨æ— å…ƒç´ "><a href="#4-2-å¼‚å¸¸-case2ï¼šchannel-å·²å…³é—­ä¸”å†…éƒ¨æ— å…ƒç´ " class="headerlink" title="4.2 å¼‚å¸¸ case2ï¼šchannel å·²å…³é—­ä¸”å†…éƒ¨æ— å…ƒç´ "></a>4.2 å¼‚å¸¸ case2ï¼šchannel å·²å…³é—­ä¸”å†…éƒ¨æ— å…ƒç´ </h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">chanrecv</span><span class="hljs-params">(c *hchan, ep unsafe.Pointer, block <span class="hljs-type">bool</span>)</span></span> (selected, received <span class="hljs-type">bool</span>) &#123;<br>  <br>    lock(&amp;c.lock)<br><br><br>    <span class="hljs-keyword">if</span> c.closed != <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">if</span> c.qcount == <span class="hljs-number">0</span> &#123;<br>            unlock(&amp;c.lock)<br>            <span class="hljs-keyword">if</span> ep != <span class="hljs-literal">nil</span> &#123;<br>                typedmemclr(c.elemtype, ep)<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span><br>        &#125;<br>        <span class="hljs-comment">// The channel has been closed, but the channel&#x27;s buffer have data.</span><br>    &#125; <br><br><br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ1ï¼‰ç›´æ¥è§£é”è¿”å›å³å¯</p><h3 id="4-3-case3ï¼šè¯»æ—¶æœ‰é˜»å¡çš„å†™åç¨‹"><a href="#4-3-case3ï¼šè¯»æ—¶æœ‰é˜»å¡çš„å†™åç¨‹" class="headerlink" title="4.3 case3ï¼šè¯»æ—¶æœ‰é˜»å¡çš„å†™åç¨‹"></a>4.3 case3ï¼šè¯»æ—¶æœ‰é˜»å¡çš„å†™åç¨‹</h3><p><img src="/2025/03/31/Golang-channel%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/v2-867428e66aeded401bb24ef760d99269_1440w.jpg" alt="img"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">chanrecv</span><span class="hljs-params">(c *hchan, ep unsafe.Pointer, block <span class="hljs-type">bool</span>)</span></span> (selected, received <span class="hljs-type">bool</span>) &#123;<br>   <br>    lock(&amp;c.lock)<br><br><br>    <span class="hljs-comment">// Just found waiting sender with not closed.</span><br>    <span class="hljs-keyword">if</span> sg := c.sendq.dequeue(); sg != <span class="hljs-literal">nil</span> &#123;<br>        recv(c, sg, ep, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; unlock(&amp;c.lock) &#125;, <span class="hljs-number">3</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span><br>     &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">recv</span><span class="hljs-params">(c *hchan, sg *sudog, ep unsafe.Pointer, unlockf <span class="hljs-keyword">func</span>()</span></span>, skip <span class="hljs-type">int</span>) &#123;<br><span class="hljs-keyword">if</span> c.dataqsiz == <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">if</span> ep != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-comment">// copy data from sender</span><br>recvDirect(c.elemtype, sg, ep)<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// Queue is full. Take the item at the</span><br><span class="hljs-comment">// head of the queue. Make the sender enqueue</span><br><span class="hljs-comment">// its item at the tail of the queue. Since the</span><br><span class="hljs-comment">// queue is full, those are both the same slot.</span><br>qp := chanbuf(c, c.recvx)<br><span class="hljs-keyword">if</span> ep != <span class="hljs-literal">nil</span> &#123;<br>typedmemmove(c.elemtype, ep, qp)<br>&#125;<br><br>typedmemmove(c.elemtype, qp, sg.elem)<br>c.recvx++<br><span class="hljs-keyword">if</span> c.recvx == c.dataqsiz &#123;<br>c.recvx = <span class="hljs-number">0</span><br>&#125;<br>c.sendx = c.recvx <span class="hljs-comment">// c.sendx = (c.sendx+1) % c.dataqsiz</span><br>&#125;<br>sg.elem = <span class="hljs-literal">nil</span><br>gp := sg.g<br>unlockf()<br>gp.param = unsafe.Pointer(sg)<br>sg.success = <span class="hljs-literal">true</span><br>goready(gp, skip+<span class="hljs-number">1</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ1ï¼‰åŠ é”ï¼›</p><p>ï¼ˆ2ï¼‰ä»é˜»å¡å†™åç¨‹é˜Ÿåˆ—ä¸­è·å–åˆ°ä¸€ä¸ªå†™åç¨‹ï¼›</p><p>ï¼ˆ3ï¼‰å€˜è‹¥ channel æ— ç¼“å†²åŒºï¼Œåˆ™ç›´æ¥è¯»å–å†™åç¨‹å…ƒç´ ï¼Œå¹¶å”¤é†’å†™åç¨‹ï¼›</p><p>ï¼ˆ4ï¼‰å€˜è‹¥ channel æœ‰ç¼“å†²åŒºï¼Œåˆ™è¯»å–ç¼“å†²åŒºå¤´éƒ¨å…ƒç´ ï¼Œå¹¶å°†å†™åç¨‹å…ƒç´ å†™å…¥ç¼“å†²åŒºå°¾éƒ¨åå”¤é†’å†™å†™æˆï¼›</p><p>ï¼ˆ5ï¼‰è§£é”ï¼Œè¿”å›.</p><h3 id="4-4-case4ï¼šè¯»æ—¶æ— é˜»å¡å†™åç¨‹ä¸”ç¼“å†²åŒºæœ‰å…ƒç´ "><a href="#4-4-case4ï¼šè¯»æ—¶æ— é˜»å¡å†™åç¨‹ä¸”ç¼“å†²åŒºæœ‰å…ƒç´ " class="headerlink" title="4.4 case4ï¼šè¯»æ—¶æ— é˜»å¡å†™åç¨‹ä¸”ç¼“å†²åŒºæœ‰å…ƒç´ "></a>4.4 case4ï¼šè¯»æ—¶æ— é˜»å¡å†™åç¨‹ä¸”ç¼“å†²åŒºæœ‰å…ƒç´ </h3><p><img src="https://pic1.zhimg.com/v2-354eb67a148726103d12d08b9d5c3b04_1440w.jpg" alt="img"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">chanrecv</span><span class="hljs-params">(c *hchan, ep unsafe.Pointer, block <span class="hljs-type">bool</span>)</span></span> (selected, received <span class="hljs-type">bool</span>) &#123;<br><br><br>    lock(&amp;c.lock)<br><br><br>    <span class="hljs-keyword">if</span> c.qcount &gt; <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-comment">// Receive directly from queue</span><br>        qp := chanbuf(c, c.recvx)<br>        <span class="hljs-keyword">if</span> ep != <span class="hljs-literal">nil</span> &#123;<br>            typedmemmove(c.elemtype, ep, qp)<br>        &#125;<br>        typedmemclr(c.elemtype, qp)<br>        c.recvx++<br>        <span class="hljs-keyword">if</span> c.recvx == c.dataqsiz &#123;<br>            c.recvx = <span class="hljs-number">0</span><br>        &#125;<br>        c.qcount--<br>        unlock(&amp;c.lock)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ1ï¼‰åŠ é”ï¼›</p><p>ï¼ˆ2ï¼‰è·å–åˆ° recvx å¯¹åº”ä½ç½®çš„å…ƒç´ ï¼›</p><p>ï¼ˆ3ï¼‰recvx++</p><p>ï¼ˆ4ï¼‰qcountâ€“</p><p>ï¼ˆ5ï¼‰è§£é”ï¼Œè¿”å›</p><h3 id="4-5-case5ï¼šè¯»æ—¶æ— é˜»å¡å†™åç¨‹ä¸”ç¼“å†²åŒºæ— å…ƒç´ "><a href="#4-5-case5ï¼šè¯»æ—¶æ— é˜»å¡å†™åç¨‹ä¸”ç¼“å†²åŒºæ— å…ƒç´ " class="headerlink" title="4.5 case5ï¼šè¯»æ—¶æ— é˜»å¡å†™åç¨‹ä¸”ç¼“å†²åŒºæ— å…ƒç´ "></a>4.5 case5ï¼šè¯»æ—¶æ— é˜»å¡å†™åç¨‹ä¸”ç¼“å†²åŒºæ— å…ƒç´ </h3><p><img src="/2025/03/31/Golang-channel%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/v2-b3070eedf5f179b7a7515dc0ec5892d0_1440w.jpg" alt="img"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">chanrecv</span><span class="hljs-params">(c *hchan, ep unsafe.Pointer, block <span class="hljs-type">bool</span>)</span></span> (selected, received <span class="hljs-type">bool</span>) &#123;<br>    lock(&amp;c.lock)<br><br>    gp := getg()<br>    mysg := acquireSudog()<br>    mysg.elem = ep<br>    gp.waiting = mysg<br>    mysg.g = gp<br>    mysg.c = c<br>    gp.param = <span class="hljs-literal">nil</span><br>    c.recvq.enqueue(mysg)<br>    atomic.Store8(&amp;gp.parkingOnChan, <span class="hljs-number">1</span>)<br>    gopark(chanparkcommit, unsafe.Pointer(&amp;c.lock), waitReasonChanReceive, traceEvGoBlockRecv, <span class="hljs-number">2</span>)<br><br>    gp.waiting = <span class="hljs-literal">nil</span><br>    success := mysg.success<br>    gp.param = <span class="hljs-literal">nil</span><br>    mysg.c = <span class="hljs-literal">nil</span><br>    releaseSudog(mysg)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, success<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ1ï¼‰åŠ é”ï¼›</p><p>ï¼ˆ2ï¼‰æ„é€ å°è£…å½“å‰ goroutine çš„ sudog å¯¹è±¡ï¼›</p><p>ï¼ˆ3ï¼‰å®ŒæˆæŒ‡é’ˆæŒ‡å‘ï¼Œå»ºç«‹ sudogã€goroutineã€channel ä¹‹é—´çš„æŒ‡å‘å…³ç³»ï¼›</p><p>ï¼ˆ4ï¼‰æŠŠ sudog æ·»åŠ åˆ°å½“å‰ channel çš„é˜»å¡è¯»åç¨‹é˜Ÿåˆ—ä¸­ï¼›</p><p>ï¼ˆ5ï¼‰park å½“å‰åç¨‹ï¼›</p><p>ï¼ˆ6ï¼‰å€˜è‹¥åç¨‹ä» park ä¸­è¢«å”¤é†’ï¼Œåˆ™å›æ”¶ sudogï¼ˆsudogèƒ½è¢«å”¤é†’ï¼Œå…¶å¯¹åº”çš„å…ƒç´ å¿…ç„¶å·²ç»è¢«å†™å…¥ï¼‰ï¼›</p><p>ï¼ˆ7ï¼‰è§£é”ï¼Œè¿”å›</p><h3 id="4-6-è¯»æµç¨‹æ•´ä½“ä¸²è”"><a href="#4-6-è¯»æµç¨‹æ•´ä½“ä¸²è”" class="headerlink" title="4.6 è¯»æµç¨‹æ•´ä½“ä¸²è”"></a>4.6 è¯»æµç¨‹æ•´ä½“ä¸²è”</h3><p><img src="/2025/03/31/Golang-channel%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/v2-26a783d36cc511f5d57706cb2076d526_1440w.jpg" alt="img"></p><h2 id="5-é˜»å¡ä¸éé˜»å¡æ¨¡å¼"><a href="#5-é˜»å¡ä¸éé˜»å¡æ¨¡å¼" class="headerlink" title="5 é˜»å¡ä¸éé˜»å¡æ¨¡å¼"></a>5 é˜»å¡ä¸éé˜»å¡æ¨¡å¼</h2><p>åœ¨ä¸Šè¿°æºç åˆ†ææµç¨‹ä¸­ï¼Œå‡æ˜¯ä»¥é˜»å¡æ¨¡å¼ä¸ºä¸»çº¿è¿›è¡Œè®²è¿°ï¼Œå¿½ç•¥éé˜»å¡æ¨¡å¼çš„æœ‰å…³å¤„ç†é€»è¾‘.</p><p>æ­¤å¤„é˜æ˜ä¸¤ä¸ªé—®é¢˜ï¼š</p><p>ï¼ˆ1ï¼‰éé˜»å¡æ¨¡å¼ä¸‹ï¼Œæµç¨‹é€»è¾‘æœ‰ä½•åŒºåˆ«ï¼Ÿ</p><p>ï¼ˆ2ï¼‰ä½•æ—¶ä¼šè¿›å…¥éé˜»å¡æ¨¡å¼ï¼Ÿ</p><h3 id="5-1-éé˜»å¡æ¨¡å¼é€»è¾‘åŒºåˆ«"><a href="#5-1-éé˜»å¡æ¨¡å¼é€»è¾‘åŒºåˆ«" class="headerlink" title="5.1 éé˜»å¡æ¨¡å¼é€»è¾‘åŒºåˆ«"></a>5.1 éé˜»å¡æ¨¡å¼é€»è¾‘åŒºåˆ«</h3><p>éé˜»å¡æ¨¡å¼ä¸‹ï¼Œè¯»&#x2F;å†™ channel æ–¹æ³•é€šè¿‡ä¸€ä¸ª bool å‹çš„å“åº”å‚æ•°ï¼Œç”¨ä»¥æ ‡è¯†æ˜¯å¦è¯»å–&#x2F;å†™å…¥æˆåŠŸ.</p><p>ï¼ˆ1ï¼‰æ‰€æœ‰éœ€è¦ä½¿å¾—å½“å‰ goroutine è¢«æŒ‚èµ·çš„æ“ä½œï¼Œåœ¨éé˜»å¡æ¨¡å¼ä¸‹éƒ½ä¼šè¿”å› falseï¼›</p><p>ï¼ˆ2ï¼‰æ‰€æœ‰æ˜¯çš„å½“å‰ goroutine ä¼šè¿›å…¥æ­»é”çš„æ“ä½œï¼Œåœ¨éé˜»å¡æ¨¡å¼ä¸‹éƒ½ä¼šè¿”å› falseï¼›</p><p>ï¼ˆ3ï¼‰æ‰€æœ‰èƒ½ç«‹å³å®Œæˆè¯»å–&#x2F;å†™å…¥æ“ä½œçš„æ¡ä»¶ä¸‹ï¼Œéé˜»å¡æ¨¡å¼ä¸‹ä¼šè¿”å› true.</p><h3 id="5-2-ä½•æ—¶è¿›å…¥éé˜»å¡æ¨¡å¼"><a href="#5-2-ä½•æ—¶è¿›å…¥éé˜»å¡æ¨¡å¼" class="headerlink" title="5.2 ä½•æ—¶è¿›å…¥éé˜»å¡æ¨¡å¼"></a>5.2 ä½•æ—¶è¿›å…¥éé˜»å¡æ¨¡å¼</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯»&#x2F;å†™ channel éƒ½æ˜¯é˜»å¡æ¨¡å¼ï¼Œåªæœ‰åœ¨ select è¯­å¥ç»„æˆçš„å¤šè·¯å¤ç”¨åˆ†æ”¯ä¸­ï¼Œä¸ channel çš„äº¤äº’ä¼šå˜æˆéé˜»å¡æ¨¡å¼ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go">ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)<br><span class="hljs-keyword">select</span>&#123;<br>  <span class="hljs-keyword">case</span> &lt;- ch:<br>  <span class="hljs-keyword">default</span>:<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-3-ä»£ç ä¸€è§ˆ"><a href="#5-3-ä»£ç ä¸€è§ˆ" class="headerlink" title="5.3 ä»£ç ä¸€è§ˆ"></a>5.3 ä»£ç ä¸€è§ˆ</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">selectnbsend</span><span class="hljs-params">(c *hchan, elem unsafe.Pointer)</span></span> (selected <span class="hljs-type">bool</span>) &#123;<br><span class="hljs-keyword">return</span> chansend(c, elem, <span class="hljs-literal">false</span>, getcallerpc())<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">selectnbrecv</span><span class="hljs-params">(elem unsafe.Pointer, c *hchan)</span></span> (selected, received <span class="hljs-type">bool</span>) &#123;<br><span class="hljs-keyword">return</span> chanrecv(c, elem, <span class="hljs-literal">false</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ select è¯­å¥åŒ…è£¹çš„å¤šè·¯å¤ç”¨åˆ†æ”¯ä¸­ï¼Œè¯»å’Œå†™ channel æ“ä½œä¼šè¢«æ±‡ç¼–ä¸º selectnbrecv å’Œ selectnbsend æ–¹æ³•ï¼Œåº•å±‚åŒæ ·å¤ç”¨ chanrecv å’Œ chansend æ–¹æ³•ï¼Œä½†æ­¤æ—¶ç”±äºç¬¬ä¸‰ä¸ªå…¥å‚ block è¢«è®¾ç½®ä¸º falseï¼Œå¯¼è‡´åç»­ä¼šèµ°è¿›éé˜»å¡çš„å¤„ç†åˆ†æ”¯.</p><h2 id="6-ä¸¤ç§è¯»-channel-çš„åè®®"><a href="#6-ä¸¤ç§è¯»-channel-çš„åè®®" class="headerlink" title="6 ä¸¤ç§è¯» channel çš„åè®®"></a>6 ä¸¤ç§è¯» channel çš„åè®®</h2><p>è¯»å– channel æ—¶ï¼Œå¯ä»¥æ ¹æ®ç¬¬äºŒä¸ª bool å‹çš„è¿”å›å€¼ç”¨ä»¥åˆ¤æ–­å½“å‰ channel æ˜¯å¦å·²å¤„äºå…³é—­çŠ¶æ€ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, <span class="hljs-number">2</span>)<br>got1 := &lt;- ch<br>got2,ok := &lt;- ch<br></code></pre></td></tr></table></figure><p>å®ç°ä¸Šè¿°åŠŸèƒ½çš„åŸå› æ˜¯ï¼Œä¸¤ç§æ ¼å¼ä¸‹ï¼Œè¯» channel æ“ä½œä¼šè¢«æ±‡ç¼–æˆä¸åŒçš„æ–¹æ³•ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">chanrecv1</span><span class="hljs-params">(c *hchan, elem unsafe.Pointer)</span></span> &#123;<br>    chanrecv(c, elem, <span class="hljs-literal">true</span>)<br>&#125;<br><br><br><span class="hljs-comment">//go:nosplit</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">chanrecv2</span><span class="hljs-params">(c *hchan, elem unsafe.Pointer)</span></span> (received <span class="hljs-type">bool</span>) &#123;<br>    _, received = chanrecv(c, elem, <span class="hljs-literal">true</span>)<br>    <span class="hljs-keyword">return</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="7-å…³é—­"><a href="#7-å…³é—­" class="headerlink" title="7 å…³é—­"></a>7 å…³é—­</h2><p><img src="/2025/03/31/Golang-channel%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/v2-46c42a11be76b1e553f5ee79acbcacab_1440w.jpg" alt="img"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">closechan</span><span class="hljs-params">(c *hchan)</span></span> &#123;<br>    <span class="hljs-keyword">if</span> c == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-built_in">panic</span>(plainError(<span class="hljs-string">&quot;close of nil channel&quot;</span>))<br>    &#125;<br><br>    lock(&amp;c.lock)<br>    <span class="hljs-keyword">if</span> c.closed != <span class="hljs-number">0</span> &#123;<br>        unlock(&amp;c.lock)<br>        <span class="hljs-built_in">panic</span>(plainError(<span class="hljs-string">&quot;close of closed channel&quot;</span>))<br>    &#125;<br><br>    c.closed = <span class="hljs-number">1</span><br><br>    <span class="hljs-keyword">var</span> glist gList<br>    <span class="hljs-comment">// release all readers</span><br>    <span class="hljs-keyword">for</span> &#123;<br>        sg := c.recvq.dequeue()<br>        <span class="hljs-keyword">if</span> sg == <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">break</span><br>        &#125;<br>        <span class="hljs-keyword">if</span> sg.elem != <span class="hljs-literal">nil</span> &#123;<br>            typedmemclr(c.elemtype, sg.elem)<br>            sg.elem = <span class="hljs-literal">nil</span><br>        &#125;<br>        gp := sg.g<br>        gp.param = unsafe.Pointer(sg)<br>        sg.success = <span class="hljs-literal">false</span><br>        glist.push(gp)<br>    &#125;<br><br>    <span class="hljs-comment">// release all writers (they will panic)</span><br>    <span class="hljs-keyword">for</span> &#123;<br>        sg := c.sendq.dequeue()<br>        <span class="hljs-keyword">if</span> sg == <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">break</span><br>        &#125;<br>        sg.elem = <span class="hljs-literal">nil</span><br>        gp := sg.g<br>        gp.param = unsafe.Pointer(sg)<br>        sg.success = <span class="hljs-literal">false</span><br>        glist.push(gp)<br>    &#125;<br>    unlock(&amp;c.lock)<br><br>    <span class="hljs-comment">// Ready all Gs now that we&#x27;ve dropped the channel lock.</span><br>    <span class="hljs-keyword">for</span> !glist.empty() &#123;<br>        gp := glist.pop()<br>        gp.schedlink = <span class="hljs-number">0</span><br>        goready(gp, <span class="hljs-number">3</span>)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ1ï¼‰å…³é—­æœªåˆå§‹åŒ–è¿‡çš„ channel ä¼š panicï¼›</p><p>ï¼ˆ2ï¼‰åŠ é”ï¼›</p><p>ï¼ˆ3ï¼‰é‡å¤å…³é—­ channel ä¼š panicï¼›</p><p>ï¼ˆ4ï¼‰å°†é˜»å¡è¯»åç¨‹é˜Ÿåˆ—ä¸­çš„åç¨‹èŠ‚ç‚¹ç»Ÿä¸€æ·»åŠ åˆ° glistï¼›</p><p>ï¼ˆ5ï¼‰å°†é˜»å¡å†™åç¨‹é˜Ÿåˆ—ä¸­çš„åç¨‹èŠ‚ç‚¹ç»Ÿä¸€æ·»åŠ åˆ° glistï¼›</p><p>ï¼ˆ6ï¼‰å”¤é†’ glist å½“ä¸­çš„æ‰€æœ‰åç¨‹.</p><h2 id="8-ä¸€é“è€ƒé¢˜"><a href="#8-ä¸€é“è€ƒé¢˜" class="headerlink" title="8 ä¸€é“è€ƒé¢˜"></a>8 ä¸€é“è€ƒé¢˜</h2><p>è¦æ±‚å®ç°ä¸€ä¸ª mapï¼š</p><p>ï¼ˆ1ï¼‰é¢å‘é«˜å¹¶å‘ï¼›</p><p>ï¼ˆ2ï¼‰åªå­˜åœ¨æ’å…¥å’ŒæŸ¥è¯¢æ“ä½œ O(1)ï¼›</p><p>ï¼ˆ3ï¼‰æŸ¥è¯¢æ—¶ï¼Œè‹¥ key å­˜åœ¨ï¼Œç›´æ¥è¿”å› valï¼›è‹¥ key ä¸å­˜åœ¨ï¼Œé˜»å¡ç›´åˆ° key val å¯¹è¢«æ”¾å…¥åï¼Œè·å– val è¿”å›ï¼› ç­‰å¾…æŒ‡å®šæ—¶é•¿ä»æœªæ”¾å…¥ï¼Œè¿”å›è¶…æ—¶é”™è¯¯ï¼›</p><p>ï¼ˆ4ï¼‰å†™å‡ºçœŸå®ä»£ç ï¼Œä¸èƒ½æœ‰æ­»é”æˆ–è€… panic é£é™©.</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> MyConcurrentMap <span class="hljs-keyword">struct</span>&#123;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *MyConcurrentMap)</span></span>Put(k,v <span class="hljs-type">int</span>)&#123;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *MyConcurrentMap)</span></span>Get(k <span class="hljs-type">int</span>, maxWaitingDuration time.Duration)(<span class="hljs-type">int</span>,<span class="hljs-type">error</span>)&#123;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="é«˜å¹¶å‘é˜»å¡å¼-Map-å®ç°"><a href="#é«˜å¹¶å‘é˜»å¡å¼-Map-å®ç°" class="headerlink" title="é«˜å¹¶å‘é˜»å¡å¼ Map å®ç°"></a>é«˜å¹¶å‘é˜»å¡å¼ Map å®ç°</h1><p>ä¸‹é¢æ˜¯ä¸€ä¸ªæ»¡è¶³æ‰€æœ‰è¦æ±‚çš„ <code>MyConcurrentMap</code> å®ç°ï¼Œå®ƒä½¿ç”¨ Go çš„ <code>sync.RWMutex</code> å’Œ <code>sync.Cond</code> æ¥å®ç°é«˜æ•ˆçš„å¹¶å‘æ§åˆ¶å’Œé˜»å¡ç­‰å¾…åŠŸèƒ½ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;errors&quot;</span><br><span class="hljs-string">&quot;sync&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> MyConcurrentMap <span class="hljs-keyword">struct</span> &#123;<br>mu    sync.RWMutex<br>data  <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span><br>conds <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]*sync.Cond<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewMyConcurrentMap</span><span class="hljs-params">()</span></span> *MyConcurrentMap &#123;<br><span class="hljs-keyword">return</span> &amp;MyConcurrentMap&#123;<br>data:  <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>),<br>conds: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]*sync.Cond),<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *MyConcurrentMap)</span></span> Put(k, v <span class="hljs-type">int</span>) &#123;<br>m.mu.Lock()<br><span class="hljs-keyword">defer</span> m.mu.Unlock()<br><br><span class="hljs-comment">// æ”¾å…¥æ•°æ®</span><br>m.data[k] = v<br><br><span class="hljs-comment">// å¦‚æœæœ‰ç­‰å¾…è¯¥keyçš„goroutineï¼Œåˆ™é€šçŸ¥å®ƒä»¬</span><br><span class="hljs-keyword">if</span> cond, ok := m.conds[k]; ok &#123;<br>cond.Broadcast()<br><span class="hljs-comment">// é€šçŸ¥ååˆ é™¤condï¼Œé¿å…å†…å­˜æ³„æ¼</span><br><span class="hljs-built_in">delete</span>(m.conds, k)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *MyConcurrentMap)</span></span> Get(k <span class="hljs-type">int</span>, maxWaitingDuration time.Duration) (<span class="hljs-type">int</span>, <span class="hljs-type">error</span>) &#123;<br>m.mu.RLock()<br><span class="hljs-comment">// å…ˆå¿«é€Ÿæ£€æŸ¥ä¸€æ¬¡</span><br><span class="hljs-keyword">if</span> val, ok := m.data[k]; ok &#123;<br>m.mu.RUnlock()<br><span class="hljs-keyword">return</span> val, <span class="hljs-literal">nil</span><br>&#125;<br>m.mu.RUnlock()<br><br>m.mu.Lock()<br><span class="hljs-comment">// å†æ¬¡æ£€æŸ¥ï¼Œé˜²æ­¢åœ¨è§£é”å’ŒåŠ é”ä¹‹é—´æœ‰Putæ“ä½œ</span><br><span class="hljs-keyword">if</span> val, ok := m.data[k]; ok &#123;<br>m.mu.Unlock()<br><span class="hljs-keyword">return</span> val, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// ä¸ºå½“å‰keyåˆ›å»ºcondï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰</span><br>cond, ok := m.conds[k]<br><span class="hljs-keyword">if</span> !ok &#123;<br>cond = sync.NewCond(&amp;m.mu)<br>m.conds[k] = cond<br>&#125;<br><br><span class="hljs-comment">// è®¾ç½®è¶…æ—¶</span><br>timeout := time.After(maxWaitingDuration)<br>done := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)<br><br><span class="hljs-keyword">var</span> val <span class="hljs-type">int</span><br><span class="hljs-keyword">var</span> err <span class="hljs-type">error</span><br><br><span class="hljs-comment">// å¯åŠ¨goroutineç­‰å¾…æ¡ä»¶</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(done)<br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-comment">// å†æ¬¡æ£€æŸ¥ï¼Œé˜²æ­¢åœ¨ç­‰å¾…å‰å·²ç»æœ‰Putæ“ä½œ</span><br><span class="hljs-keyword">if</span> v, exists := m.data[k]; exists &#123;<br>val = v<br><span class="hljs-keyword">return</span><br>&#125;<br><br>cond.Wait() <span class="hljs-comment">// ç­‰å¾…é€šçŸ¥</span><br><br><span class="hljs-comment">// è¢«å”¤é†’åæ£€æŸ¥æ˜¯å¦æœ‰å€¼</span><br><span class="hljs-keyword">if</span> v, exists := m.data[k]; exists &#123;<br>val = v<br><span class="hljs-keyword">return</span><br>&#125;<br>&#125;<br>&#125;()<br><br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-done:<br>m.mu.Unlock()<br><span class="hljs-keyword">return</span> val, <span class="hljs-literal">nil</span><br><span class="hljs-keyword">case</span> &lt;-timeout:<br><span class="hljs-comment">// è¶…æ—¶ï¼Œéœ€è¦å–æ¶ˆç­‰å¾…</span><br>cond.Broadcast() <span class="hljs-comment">// å”¤é†’æ‰€æœ‰ç­‰å¾…æ­¤æ¡ä»¶çš„goroutine</span><br>m.mu.Unlock()<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, errors.New(<span class="hljs-string">&quot;timeout waiting for key&quot;</span>)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ä»£ç è¯´æ˜"><a href="#ä»£ç è¯´æ˜" class="headerlink" title="ä»£ç è¯´æ˜"></a>ä»£ç è¯´æ˜</h2><ol><li><strong>å¹¶å‘æ§åˆ¶</strong>ï¼š<ul><li>ä½¿ç”¨ <code>sync.RWMutex</code> å®ç°è¯»å†™é”ï¼Œå…è®¸å¤šä¸ªè¯»æ“ä½œå¹¶å‘æ‰§è¡Œ</li><li>å†™æ“ä½œï¼ˆPutï¼‰è·å–æ’ä»–é”</li></ul></li><li><strong>é˜»å¡ç­‰å¾…</strong>ï¼š<ul><li>ä½¿ç”¨ <code>sync.Cond</code> å®ç°æ¡ä»¶å˜é‡ï¼Œå½“ key ä¸å­˜åœ¨æ—¶è®© Get æ“ä½œç­‰å¾…</li><li>æ¯ä¸ª key æœ‰è‡ªå·±çš„æ¡ä»¶å˜é‡ï¼Œé¿å…ä¸å¿…è¦çš„å”¤é†’</li></ul></li><li><strong>è¶…æ—¶å¤„ç†</strong>ï¼š<ul><li>ä½¿ç”¨ <code>select</code> å’Œ <code>time.After</code> å®ç°è¶…æ—¶æ§åˆ¶</li><li>è¶…æ—¶åè¿”å›é”™è¯¯å¹¶å–æ¶ˆç­‰å¾…</li></ul></li><li><strong>å†…å­˜ç®¡ç†</strong>ï¼š<ul><li>åœ¨ Put æ“ä½œåæ¸…ç†æ¡ä»¶å˜é‡ï¼Œé¿å…å†…å­˜æ³„æ¼</li><li>ä½¿ç”¨ defer ç¡®ä¿é”è¢«é‡Šæ”¾</li></ul></li><li><strong>åŒé‡æ£€æŸ¥</strong>ï¼š<ul><li>Get æ“ä½œä¸­è¿›è¡Œäº†ä¸¤æ¬¡æ£€æŸ¥ï¼Œé˜²æ­¢åœ¨é”è½¬æ¢é—´éš™æœ‰ Put æ“ä½œ</li></ul></li></ol><h2 id="ä½¿ç”¨ç¤ºä¾‹"><a href="#ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="ä½¿ç”¨ç¤ºä¾‹"></a>ä½¿ç”¨ç¤ºä¾‹</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go">m := NewMyConcurrentMap()<br><br><span class="hljs-comment">// å¹¶å‘Put</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>    time.Sleep(<span class="hljs-number">100</span> * time.Millisecond)<br>    m.Put(<span class="hljs-number">1</span>, <span class="hljs-number">42</span>)<br>&#125;()<br><br><span class="hljs-comment">// å¹¶å‘Get</span><br>val, err := m.Get(<span class="hljs-number">1</span>, <span class="hljs-number">200</span>*time.Millisecond)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Error:&quot;</span>, err)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Value:&quot;</span>, val) <span class="hljs-comment">// è¾“å‡º Value: 42</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå®ç°æ»¡è¶³æ‰€æœ‰è¦æ±‚ï¼Œå¹¶ä¸”æ²¡æœ‰æ­»é”æˆ– panic çš„é£é™©ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>Golang</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä½¿ç”¨kubebuilderå®ç°ä¸€ä¸ªoperator</title>
    <link href="/2025/03/30/%E4%BD%BF%E7%94%A8kubebuilder%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAoperator/"/>
    <url>/2025/03/30/%E4%BD%BF%E7%94%A8kubebuilder%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAoperator/</url>
    
    <content type="html"><![CDATA[<p>è½¬è‡ªï¼š<a href="https://qingwave.github.io/how-to-write-a-k8s-operator/">https://qingwave.github.io/how-to-write-a-k8s-operator/</a></p><p>Kubernetes æä¾›äº†ä¼—å¤šçš„æ‰©å±•åŠŸèƒ½ï¼Œæ¯”å¦‚ CRDã€CRIã€CSI ç­‰ç­‰ï¼Œå¼ºå¤§çš„æ‰©å±•åŠŸèƒ½è®© k8s è¿…é€Ÿå é¢†å¸‚åœºã€‚<a href="https://kubernetes.io/zh/docs/concepts/extend-kubernetes/operator/">Operator</a>æ¨¡å¼å¯ä»¥å®ç° CRD å¹¶ç®¡ç†è‡ªå®šä¹‰èµ„æºçš„ç”Ÿå‘½å‘¨æœŸï¼Œæœ¬æ–‡åŸºäº<a href="https://kubebuilder.io/">kubebuilder</a>å¿«é€Ÿå®ç°ä¸€ä¸ª Operatorï¼Œç¤ºä¾‹æºç è§<a href="https://github.com/qingwave/mygame">mygame</a>ã€‚</p><h2 id="Kubebuilder"><a href="#Kubebuilder" class="headerlink" title="Kubebuilder"></a>Kubebuilder</h2><p><code>kubebuilder</code>æ˜¯ä¸€ä¸ªå®˜æ–¹æä¾›å¿«é€Ÿå®ç° Operator çš„å·¥å…·åŒ…ï¼Œå¯å¿«é€Ÿç”Ÿæˆ k8s çš„ CRDã€Controllerã€Webhookï¼Œç”¨æˆ·åªéœ€è¦å®ç°ä¸šåŠ¡é€»è¾‘ã€‚</p><blockquote><p>ç±»ä¼¼å·¥å…·è¿˜æœ‰<a href="https://sdk.operatorframework.io/">operader-sdk</a>ï¼Œç›®å‰æ­£åœ¨ä¸<code>Kubebuilder</code>èåˆ</p></blockquote><p>kubebuilder å°è£…äº†<code>controller-runtime</code>ä¸<code>controller-tools</code>ï¼Œé€šè¿‡<code>controller-gen</code>æ¥ç”Ÿäº§ä»£ç ï¼Œç®€åŒ–äº†ç”¨æˆ·åˆ›å»º Operator çš„æ­¥éª¤ã€‚</p><p>ä¸€èˆ¬åˆ›å»º Operator æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>åˆ›å»ºå·¥ä½œç›®å½•ï¼Œåˆå§‹åŒ–é¡¹ç›®</li><li>åˆ›å»º APIï¼Œå¡«å……å­—æ®µ</li><li>åˆ›å»º Controllerï¼Œç¼–å†™æ ¸å¿ƒåè°ƒé€»è¾‘(Reconcile)</li><li>åˆ›å»º Webhookï¼Œå®ç°æ¥å£ï¼Œå¯é€‰</li><li>éªŒè¯æµ‹è¯•</li><li>å‘å¸ƒåˆ°é›†ç¾¤ä¸­</li></ol><h2 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h2><p>æˆ‘ä»¬å‡†å¤‡åˆ›å»ºä¸€ä¸ª 2048 çš„æ¸¸æˆï¼Œå¯¹å¤–å¯ä»¥æä¾›æœåŠ¡ï¼Œä¹Ÿèƒ½æ–¹ä¾¿åœ°æ‰©ç¼©å®¹ã€‚</p><h3 id="å‡†å¤‡ç¯å¢ƒ"><a href="#å‡†å¤‡ç¯å¢ƒ" class="headerlink" title="å‡†å¤‡ç¯å¢ƒ"></a>å‡†å¤‡ç¯å¢ƒ</h3><p>é¦–å…ˆä½ éœ€è¦æœ‰ Kubernetesã€Dockerã€Golang ç›¸å…³ç¯å¢ƒã€‚ Linux ä¸‹å®‰è£… kubebuilder</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -L -o kubebuilder https://go.kubebuilder.io/dl/latest/$(go <span class="hljs-built_in">env</span> GOOS)/$(go <span class="hljs-built_in">env</span> GOARCH)<br><span class="hljs-built_in">chmod</span> +x kubebuilder &amp;&amp; <span class="hljs-built_in">mv</span> kubebuilder /usr/local/bin/<br></code></pre></td></tr></table></figure><h3 id="åˆ›å»ºé¡¹ç›®"><a href="#åˆ›å»ºé¡¹ç›®" class="headerlink" title="åˆ›å»ºé¡¹ç›®"></a>åˆ›å»ºé¡¹ç›®</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">mkdir -<span class="hljs-selector-tag">p</span> ~/work/mygame &amp;&amp; cd $_<br>kubebuilder init <span class="hljs-attr">--domain</span> qingwave<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.io</span> <span class="hljs-attr">--repo</span> qingwave<span class="hljs-selector-class">.github</span>.io/mygame<br></code></pre></td></tr></table></figure><h3 id="åˆ›å»º-API"><a href="#åˆ›å»º-API" class="headerlink" title="åˆ›å»º API"></a>åˆ›å»º API</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs css">kubebuilder create api <span class="hljs-attr">--group</span> myapp <span class="hljs-attr">--version</span> v1 <span class="hljs-attr">--kind</span> Game<br><br>Create Resource <span class="hljs-selector-attr">[y/n]</span><br><span class="hljs-attribute">y</span> #ç”ŸæˆCR<br>Create Controller <span class="hljs-selector-attr">[y/n]</span><br><span class="hljs-attribute">y</span> #ç”ŸæˆController<br></code></pre></td></tr></table></figure><p>ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">â”œâ”€â”€ api<br>â”‚   â””â”€â”€ <span class="hljs-built_in">v1</span> <span class="hljs-comment"># CRDå®šä¹‰</span><br>â”œâ”€â”€ <span class="hljs-keyword">bin</span><br><span class="hljs-keyword"></span>â”‚   â””â”€â”€ controller-gen<br>â”œâ”€â”€ <span class="hljs-built_in">config</span><br>â”‚   â”œâ”€â”€ crd <span class="hljs-comment"># crdé…ç½®</span><br>â”‚   â”œâ”€â”€ default<br>â”‚   â”œâ”€â”€ manager <span class="hljs-comment"># operatoréƒ¨ç½²æ–‡ä»¶</span><br>â”‚   â”œâ”€â”€ prometheus<br>â”‚   â”œâ”€â”€ rbac<br>â”‚   â””â”€â”€ samples <span class="hljs-comment"># crç¤ºä¾‹</span><br>â”œâ”€â”€ controllers<br>â”‚   â”œâ”€â”€ game_controller.go <span class="hljs-comment"># controlleré€»è¾‘</span><br>â”‚   â””â”€â”€ suite_test.go<br>â”œâ”€â”€ Dockerfile<br>â”œâ”€â”€ go.mod<br>â”œâ”€â”€ go.sum<br>â”œâ”€â”€ hack<br>â”‚   â””â”€â”€ <span class="hljs-keyword">boilerplate.go.txt </span><span class="hljs-comment"># å¤´æ–‡ä»¶æ¨¡æ¿</span><br>â”œâ”€â”€ main.go <span class="hljs-comment"># é¡¹ç›®ä¸»å‡½æ•°</span><br>â”œâ”€â”€ Makefile<br>â””â”€â”€ PROJECT <span class="hljs-comment">#é¡¹ç›®å…ƒæ•°æ®</span><br></code></pre></td></tr></table></figure><h3 id="ç¼–å†™-API"><a href="#ç¼–å†™-API" class="headerlink" title="ç¼–å†™ API"></a>ç¼–å†™ API</h3><p>åœ¨<code>mygame/api/v1/game_types.go</code>å®šä¹‰æˆ‘ä»¬éœ€è¦çš„å­—æ®µ</p><p><code>Spec</code>é…ç½®å¦‚ä¸‹</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">type</span> <span class="hljs-type">GameSpec</span> <span class="hljs-keyword">struct</span> &#123;<br><span class="hljs-comment">// Number of desired pods. This is a pointer to distinguish between explicit</span><br><span class="hljs-comment">// zero and not specified. Defaults to 1.</span><br><span class="hljs-comment">// +optional</span><br><span class="hljs-comment">//+kubebuilder:default:=1</span><br><span class="hljs-comment">//+kubebuilder:validation:Minimum:=1</span><br><span class="hljs-type">Replicas</span> *<span class="hljs-built_in">int32</span> `json:<span class="hljs-string">&quot;replicas,omitempty&quot;</span> protobuf:<span class="hljs-string">&quot;varint,1,opt,name=replicas&quot;</span>`<br><br><span class="hljs-comment">// Docker image name</span><br><span class="hljs-comment">// +optional</span><br><span class="hljs-type">Image</span> <span class="hljs-built_in">string</span> `json:<span class="hljs-string">&quot;image,omitempty&quot;</span>`<br><br><span class="hljs-comment">// Ingress Host name</span><br><span class="hljs-type">Host</span> <span class="hljs-built_in">string</span> `json:<span class="hljs-string">&quot;host,omitempty&quot;</span>`<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p><code>kubebuilder:default</code>å¯ä»¥è®¾ç½®é»˜è®¤å€¼</p></blockquote><p><code>Status</code>å®šä¹‰å¦‚ä¸‹</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">const (<br>Running  = &quot;Running&quot;<br>Pending  = &quot;Pending&quot;<br>NotReady = &quot;NotReady&quot;<br>Failed   = &quot;Failed&quot;<br>)<br><br><span class="hljs-keyword">type</span> GameStatus struct &#123;<br>// Phase <span class="hljs-keyword">is</span> the phase <span class="hljs-keyword">of</span> guestbook<br>Phase string `<span class="hljs-type">json</span>:&quot;phase,omitempty&quot;`<br><br>// replicas <span class="hljs-keyword">is</span> the number <span class="hljs-keyword">of</span> Pods created <span class="hljs-keyword">by</span> the StatefulSet controller.<br>Replicas int32 `<span class="hljs-type">json</span>:&quot;replicas&quot;`<br><br>// readyReplicas <span class="hljs-keyword">is</span> the number <span class="hljs-keyword">of</span> Pods created <span class="hljs-keyword">by</span> the StatefulSet controller that have a Ready Condition.<br>ReadyReplicas int32 `<span class="hljs-type">json</span>:&quot;readyReplicas&quot;`<br><br>// LabelSelector <span class="hljs-keyword">is</span> label selectors <span class="hljs-keyword">for</span> query <span class="hljs-keyword">over</span> pods that should match the <span class="hljs-keyword">replica</span> count used <span class="hljs-keyword">by</span> HPA.<br>LabelSelector string `<span class="hljs-type">json</span>:&quot;labelSelector,omitempty&quot;`<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦å¤–éœ€è¦æ·»åŠ <code>scale</code>æ¥å£</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-string">//</span>+kubebuilder<span class="hljs-function">:subresource</span><span class="hljs-function">:scale</span><span class="hljs-function">:specpath</span>=<span class="hljs-string">.spec.replicas</span>,statuspath=<span class="hljs-string">.status.replicas</span>,selectorpath=<span class="hljs-string">.status.labelSelector</span><br></code></pre></td></tr></table></figure><p>æ·»åŠ <code>kubectl</code>å±•ç¤ºå‚æ•°</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">//+kubebuilder:printcolumn:<span class="hljs-type">name</span>=&quot;Phase&quot;,<span class="hljs-keyword">type</span>=&quot;string&quot;,JSONPath=&quot;.status.phase&quot;,description=&quot;The phase of game.&quot;<br>//+kubebuilder:printcolumn:<span class="hljs-type">name</span>=&quot;Host&quot;,<span class="hljs-keyword">type</span>=&quot;string&quot;,JSONPath=&quot;.spec.host&quot;,description=&quot;The Host Address.&quot;<br>//+kubebuilder:printcolumn:<span class="hljs-type">name</span>=&quot;DESIRED&quot;,<span class="hljs-keyword">type</span>=&quot;integer&quot;,JSONPath=&quot;.spec.replicas&quot;,description=&quot;The desired number of pods.&quot;<br>//+kubebuilder:printcolumn:<span class="hljs-type">name</span>=&quot;CURRENT&quot;,<span class="hljs-keyword">type</span>=&quot;integer&quot;,JSONPath=&quot;.status.replicas&quot;,description=&quot;The number of currently all pods.&quot;<br>//+kubebuilder:printcolumn:<span class="hljs-type">name</span>=&quot;READY&quot;,<span class="hljs-keyword">type</span>=&quot;integer&quot;,JSONPath=&quot;.status.readyReplicas&quot;,description=&quot;The number of pods ready.&quot;<br>//+kubebuilder:printcolumn:<span class="hljs-type">name</span>=&quot;AGE&quot;,<span class="hljs-keyword">type</span>=&quot;date&quot;,JSONPath=&quot;.metadata.creationTimestamp&quot;,description=&quot;CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC.&quot;<br></code></pre></td></tr></table></figure><h3 id="ç¼–å†™-Controller-é€»è¾‘"><a href="#ç¼–å†™-Controller-é€»è¾‘" class="headerlink" title="ç¼–å†™ Controller é€»è¾‘"></a>ç¼–å†™ Controller é€»è¾‘</h3><p>Controller çš„æ ¸å¿ƒé€»è¾‘åœ¨<code>Reconcile</code>ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦å¡«å……è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *GameReconciler)</span></span> Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, <span class="hljs-type">error</span>) &#123;<br>logger := log.FromContext(ctx)<br>logger.Info(<span class="hljs-string">&quot;revice reconcile event&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>, req.String())<br><br><span class="hljs-comment">// è·å–gameå¯¹è±¡</span><br>game := &amp;myappv1.Game&#123;&#125;<br><span class="hljs-keyword">if</span> err := r.Get(ctx, req.NamespacedName, game); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> ctrl.Result&#123;&#125;, client.IgnoreNotFound(err)<br>&#125;<br><br>  <span class="hljs-comment">// å¦‚æœå¤„åœ¨åˆ é™¤ä¸­ç›´æ¥è·³è¿‡</span><br><span class="hljs-keyword">if</span> game.DeletionTimestamp != <span class="hljs-literal">nil</span> &#123;<br>logger.Info(<span class="hljs-string">&quot;game in deleting&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>, req.String())<br><span class="hljs-keyword">return</span> ctrl.Result&#123;&#125;, <span class="hljs-literal">nil</span><br>&#125;<br><br>  <span class="hljs-comment">// åŒæ­¥èµ„æºï¼Œå¦‚æœèµ„æºä¸å­˜åœ¨åˆ›å»ºdeploymentã€ingressã€serviceï¼Œå¹¶æ›´æ–°status</span><br><span class="hljs-keyword">if</span> err := r.syncGame(ctx, game); err != <span class="hljs-literal">nil</span> &#123;<br>logger.Error(err, <span class="hljs-string">&quot;failed to sync game&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>, req.String())<br><span class="hljs-keyword">return</span> ctrl.Result&#123;&#125;, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-keyword">return</span> ctrl.Result&#123;&#125;, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ·»åŠ  rbac é…ç½®</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-operator">+</span>kubebuilder:rbac:<span class="hljs-keyword">groups</span><span class="hljs-operator">=</span>apps,resources<span class="hljs-operator">=</span>deployments,verbs<span class="hljs-operator">=</span><span class="hljs-keyword">get</span>;list;watch;<span class="hljs-keyword">create</span>;<span class="hljs-keyword">update</span>;patch;<span class="hljs-keyword">delete</span><br><span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-operator">+</span>kubebuilder:rbac:<span class="hljs-keyword">groups</span><span class="hljs-operator">=</span>apps,resources<span class="hljs-operator">=</span>deployments<span class="hljs-operator">/</span>status,verbs<span class="hljs-operator">=</span><span class="hljs-keyword">get</span>;<span class="hljs-keyword">update</span>;patch<br><span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-operator">+</span>kubebuilder:rbac:<span class="hljs-keyword">groups</span><span class="hljs-operator">=</span>core,resources<span class="hljs-operator">=</span>services,verbs<span class="hljs-operator">=</span><span class="hljs-keyword">get</span>;list;watch;<span class="hljs-keyword">create</span>;<span class="hljs-keyword">update</span>;patch;<span class="hljs-keyword">delete</span><br><span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-operator">+</span>kubebuilder:rbac:<span class="hljs-keyword">groups</span><span class="hljs-operator">=</span>networking,resources<span class="hljs-operator">=</span>ingresses,verbs<span class="hljs-operator">=</span><span class="hljs-keyword">get</span>;list;watch;<span class="hljs-keyword">create</span>;<span class="hljs-keyword">update</span>;patch;<span class="hljs-keyword">delete</span><br></code></pre></td></tr></table></figure><p>å…·ä½“<code>syncGame</code>é€»è¾‘å¦‚ä¸‹</p><figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs roboconf">func (r *GameReconciler) syncGame(ctx context.Context, obj *myappv1.Game) error &#123;<br><span class="hljs-attribute">logger</span> := log<span class="hljs-variable">.FromContext</span>(ctx)<br><br>game := obj<span class="hljs-variable">.DeepCopy</span>()<br>name := types<span class="hljs-variable">.NamespacedName</span>&#123;<br>Namespace: game<span class="hljs-variable">.Namespace</span>,<br>Name:      game<span class="hljs-variable">.Name</span>,<br>&#125;<br><br>  // æ„é€ owner<br>owner := []metav1<span class="hljs-variable">.OwnerReference</span>&#123;<br>&#123;<br>APIVersion:         game<span class="hljs-variable">.APIVersion</span>,<br>Kind:               game<span class="hljs-variable">.Kind</span>,<br>Name:               game<span class="hljs-variable">.Name</span>,<br>Controller:         pointer<span class="hljs-variable">.BoolPtr</span>(true),<br>BlockOwnerDeletion: pointer<span class="hljs-variable">.BoolPtr</span>(true),<br>UID:                game<span class="hljs-variable">.UID</span>,<br>&#125;,<br>&#125;<br><br>labels := game<span class="hljs-variable">.Labels</span><br>labels[gameLabelName] = game<span class="hljs-variable">.Name</span><br>meta := metav1<span class="hljs-variable">.ObjectMeta</span>&#123;<br>Name:            game<span class="hljs-variable">.Name</span>,<br>Namespace:       game<span class="hljs-variable">.Namespace</span>,<br>Labels:          labels,<br>OwnerReferences: owner,<br>&#125;<br><br>  // è·å–å¯¹åº”deployment, å¦‚ä¸å­˜åœ¨åˆ™åˆ›å»º<br>deploy := &amp;appsv1<span class="hljs-variable">.Deployment</span>&#123;&#125;<br>if err := r<span class="hljs-variable">.Get</span>(ctx, name, deploy); <span class="hljs-attribute">err != nil &#123;</span><br><span class="hljs-attribute">if !errors.IsNotFound(err) &#123;</span><br><span class="hljs-attribute">return err</span><br><span class="hljs-attribute">&#125;</span><br><span class="hljs-attribute">deploy = &amp;appsv1.Deployment&#123;</span><br><span class="hljs-attribute">ObjectMeta</span>: meta,<br>Spec:       getDeploymentSpec(game, labels),<br>&#125;<br>if err := r<span class="hljs-variable">.Create</span>(ctx, deploy); <span class="hljs-attribute">err != nil &#123;</span><br><span class="hljs-attribute">return err</span><br><span class="hljs-attribute">&#125;</span><br><span class="hljs-attribute">logger.Info(&quot;create deployment success&quot;, &quot;name&quot;, name.String())</span><br><span class="hljs-attribute">&#125; else &#123;</span><br><span class="hljs-attribute">    // å¦‚æœå­˜åœ¨å¯¹æ¯”å’Œgameç”Ÿæˆçš„deploymentæ˜¯å¦ä¸€è‡´ï¼Œä¸ä¸€è‡´åˆ™æ›´æ–°</span><br><span class="hljs-attribute">want</span> := getDeploymentSpec(game, labels)<br>get := getSpecFromDeployment(deploy)<br>if !reflect<span class="hljs-variable">.DeepEqual</span>(want, get) &#123;<br>deploy = &amp;appsv1<span class="hljs-variable">.Deployment</span>&#123;<br>ObjectMeta: meta,<br>Spec:       want,<br>&#125;<br>if err := r<span class="hljs-variable">.Update</span>(ctx, deploy); <span class="hljs-attribute">err != nil &#123;</span><br><span class="hljs-attribute">return err</span><br><span class="hljs-attribute">&#125;</span><br><span class="hljs-attribute">logger.Info(&quot;update deployment success&quot;, &quot;name&quot;, name.String())</span><br><span class="hljs-attribute">&#125;</span><br><span class="hljs-attribute">&#125;</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">  //serviceåˆ›å»º</span><br><span class="hljs-attribute">svc</span> := &amp;corev1<span class="hljs-variable">.Service</span>&#123;&#125;<br>if err := r<span class="hljs-variable">.Get</span>(ctx, name, svc); <span class="hljs-attribute">err != nil &#123;</span><br><span class="hljs-attribute">  ...</span><br><span class="hljs-attribute">&#125;</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">  // ingressåˆ›å»º</span><br><span class="hljs-attribute">ing</span> := &amp;networkingv1<span class="hljs-variable">.Ingress</span>&#123;&#125;<br>if err := r<span class="hljs-variable">.Get</span>(ctx, name, ing); <span class="hljs-attribute">err != nil &#123;</span><br><span class="hljs-attribute">...</span><br><span class="hljs-attribute">&#125;</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">newStatus</span> := myappv1<span class="hljs-variable">.GameStatus</span>&#123;<br>Replicas:      *game<span class="hljs-variable">.Spec</span><span class="hljs-variable">.Replicas</span>,<br>ReadyReplicas: deploy<span class="hljs-variable">.Status</span><span class="hljs-variable">.ReadyReplicas</span>,<br>&#125;<br><br>if newStatus<span class="hljs-variable">.Replicas</span> == newStatus<span class="hljs-variable">.ReadyReplicas</span> &#123;<br>newStatus<span class="hljs-variable">.Phase</span> = myappv1<span class="hljs-variable">.Running</span><br>&#125; else &#123;<br>newStatus<span class="hljs-variable">.Phase</span> = myappv1<span class="hljs-variable">.NotReady</span><br>&#125;<br><br>  // æ›´æ–°çŠ¶æ€<br>if !reflect<span class="hljs-variable">.DeepEqual</span>(game<span class="hljs-variable">.Status</span>, newStatus) &#123;<br>game<span class="hljs-variable">.Status</span> = newStatus<br>logger<span class="hljs-variable">.Info</span>(&quot;update game status&quot;, &quot;name&quot;, name<span class="hljs-variable">.String</span>())<br>return r<span class="hljs-variable">.Client</span><span class="hljs-variable">.Status</span>()<span class="hljs-variable">.Update</span>(ctx, game)<br>&#125;<br><br>return nil<br>&#125;<br></code></pre></td></tr></table></figure><p>é»˜è®¤æƒ…å†µä¸‹ç”Ÿæˆçš„ controller åªç›‘å¬è‡ªå®šä¹‰èµ„æºï¼Œåœ¨ç¤ºä¾‹ä¸­æˆ‘ä»¬ä¹Ÿéœ€è¦ç›‘å¬<code>game</code>çš„å­èµ„æºï¼Œå¦‚ç›‘å¬<code>deployment</code>æ˜¯å¦ç¬¦åˆé¢„æœŸ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// SetupWithManager sets up the controller with the Manager.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *GameReconciler)</span></span> SetupWithManager(mgr ctrl.Manager) <span class="hljs-type">error</span> &#123;<br><span class="hljs-comment">// åˆ›å»ºcontroller</span><br>c, err := controller.New(<span class="hljs-string">&quot;game-controller&quot;</span>, mgr, controller.Options&#123;<br>Reconciler:              r,<br>MaxConcurrentReconciles: <span class="hljs-number">3</span>, <span class="hljs-comment">//controllerè¿è¡Œçš„workeræ•°</span><br>&#125;)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-comment">//ç›‘å¬è‡ªå®šä¹‰èµ„æº</span><br><span class="hljs-keyword">if</span> err := c.Watch(&amp;source.Kind&#123;Type: &amp;myappv1.Game&#123;&#125;&#125;, &amp;handler.EnqueueRequestForObject&#123;&#125;); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-comment">//ç›‘å¬deployment,å°†ownerä¿¡æ¯å³game namespace/nameæ·»åŠ åˆ°é˜Ÿåˆ—</span><br><span class="hljs-keyword">if</span> err := c.Watch(&amp;source.Kind&#123;Type: &amp;appsv1.Deployment&#123;&#125;&#125;, &amp;handler.EnqueueRequestForOwner&#123;<br>OwnerType:    &amp;myappv1.Game&#123;&#125;,<br>IsController: <span class="hljs-literal">true</span>,<br>&#125;); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="éƒ¨ç½²éªŒè¯"><a href="#éƒ¨ç½²éªŒè¯" class="headerlink" title="éƒ¨ç½²éªŒè¯"></a>éƒ¨ç½²éªŒè¯</h3><p>å®‰è£… CRD</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">make <span class="hljs-keyword">install</span><br></code></pre></td></tr></table></figure><p>æœ¬åœ°è¿è¡Œ operator</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-built_in">make</span> <span class="hljs-keyword">run</span><br></code></pre></td></tr></table></figure><p>ä¿®æ”¹ sample æ–‡ä»¶<code>config/samples/myapp_v1_game.yaml</code></p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">apiVersion:</span> myapp.qingwave.github.io/v1<br><span class="hljs-symbol">kind:</span> Game<br><span class="hljs-symbol">metadata:</span><br><span class="hljs-symbol">  name:</span> game-sample<br><span class="hljs-symbol">spec:</span><br><span class="hljs-symbol">  replicas:</span> <span class="hljs-number">1</span><br><span class="hljs-symbol">  image:</span> alexwhen/docker<span class="hljs-number">-2048</span><br><span class="hljs-symbol">  host:</span> mygame.io<br></code></pre></td></tr></table></figure><p>éƒ¨ç½²<code>game-sample</code></p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">kubectl apply -f config/samples/myapp_v1_game.yaml<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹<code>game</code>è‡ªå®šä¹‰èµ„æºçŠ¶æ€</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># æŸ¥çœ‹game</span><br><span class="hljs-attribute">kubectl</span> get game<br><span class="hljs-attribute">NAME</span>          PHASE     HOST        DESIRED   CURRENT   READY   AGE<br><span class="hljs-attribute">game</span>-sample   Running   mygame.io   <span class="hljs-number">1</span>         <span class="hljs-number">1</span>         <span class="hljs-number">1</span>       <span class="hljs-number">6</span>m<br><br><span class="hljs-comment"># æŸ¥çœ‹deploy</span><br><span class="hljs-attribute">kubectl</span> get deploy game-sample<br><span class="hljs-attribute">NAME</span>          READY   UP-TO-DATE   AVAILABLE   AGE<br><span class="hljs-attribute">game</span>-sample   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-number">1</span>            <span class="hljs-number">1</span>           <span class="hljs-number">6</span>m<br><br><span class="hljs-comment"># æŸ¥çœ‹ingress</span><br><span class="hljs-attribute">kubectl</span> get ing game-sample<br><span class="hljs-attribute">NAME</span>          CLASS    HOSTS       ADDRESS        PORTS   AGE<br><span class="hljs-attribute">game</span>-sample   &lt;none&gt;   mygame.io   <span class="hljs-number">192.168.49.2</span>   <span class="hljs-number">80</span>      <span class="hljs-number">7</span>m<br></code></pre></td></tr></table></figure><p>éªŒè¯åº”ç”¨ï¼Œåœ¨<code>/etc/hosts</code>ä¸­æ·»åŠ <code>&lt;Ingress ADDRESS Ip&gt; mygame.io</code>ï¼Œè®¿é—®æµè§ˆå™¨å¦‚ä¸‹å›¾æ‰€ç¤º<img src="/2025/03/30/%E4%BD%BF%E7%94%A8kubebuilder%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAoperator/crd_mygame.png" alt="2048"></p><p>éªŒè¯æ‰©å®¹</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">kubectl</span> scale games.myapp.qingwave.github.io game-sample --replicas <span class="hljs-number">2</span><br><span class="hljs-attribute">game</span>.myapp.qingwave.github.io/game-sample scaled<br><br><span class="hljs-comment"># æ‰©å®¹å</span><br><span class="hljs-attribute">kubectl</span> get games.myapp.qingwave.github.io<br><span class="hljs-attribute">NAME</span>          PHASE     HOST        DESIRED   CURRENT   READY   AGE<br><span class="hljs-attribute">game</span>-sample   Running   mygame.io   <span class="hljs-number">2</span>         <span class="hljs-number">2</span>         <span class="hljs-number">2</span>       <span class="hljs-number">7</span>m<br></code></pre></td></tr></table></figure><p>å¦‚éœ€éƒ¨ç½²<code>Operator</code>åˆ°é›†ç¾¤ä¸­ï¼Œå¯å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œåˆ¶ä½œé•œåƒå¹¶ä¸Šä¼ ï¼Œè¿è¡Œ<code>make deploy</code></p><h3 id="Webhook"><a href="#Webhook" class="headerlink" title="Webhook"></a>Webhook</h3><p>é€šå¸¸æˆ‘ä»¬éœ€è¦ä¸ CR è‡ªå®šä¹‰èµ„æºè®¾ç½®éƒ¨åˆ†å­—æ®µçš„é»˜è®¤å€¼ï¼Œæˆ–è€…éªŒè¯å­—æ®µæ˜¯å¦åˆæ³•ï¼Œè¿™å°±éœ€è¦è‡ªå·±å®ç°<code>Webhook</code>ï¼Œ<code>Kubebuilder</code>ä¹Ÿæä¾›äº†<code>Webhook</code>çš„åŠŸèƒ½ã€‚</p><p>é€šè¿‡è®¾ç½®<code>--defaulting</code>å¯åˆ›å»º<a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#mutatingadmissionwebhook">mutatingadmissionwebhook</a>ç±»å‹å‡†å…¥æ§åˆ¶å™¨ï¼Œç”¨æ¥ä¿®æ”¹ä¼ å…¥èµ„æºï¼›å‚æ•°<code>--programmatic-validation</code>å¯åˆ›å»º<a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#validatingadmissionwebhook">validatingadmissionwebhook</a>ï¼Œç”¨æ¥éªŒè¯ä¼ å…¥èµ„æº</p><blockquote><p>åœ¨èµ„æºåˆ›å»ºã€ä¿®æ”¹æ—¶<code>apiserver</code>ä¼šé€šè¿‡ http è°ƒç”¨<code>webhook</code>æä¾›çš„æ¥å£ï¼Œæ‰€ä»¥ä¼šå¸¦æ¥é¢å¤–å¼€é”€ï¼Œç®€å•çš„éªŒè¯å·¥ä½œå¯é€šè¿‡<code>//+kubebuilder:validation</code>æ³¨è§£ï¼Œç›´æ¥é€šè¿‡<code>openapi</code>éªŒè¯ï¼Œæ€§èƒ½æ›´å¥½</p></blockquote><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">kubebuilder create webhook</span> <span class="hljs-literal">--</span><span class="hljs-comment">group myapp</span> <span class="hljs-literal">--</span><span class="hljs-comment">version v1</span> <span class="hljs-literal">--</span><span class="hljs-comment">kind Game</span> <span class="hljs-literal">--</span><span class="hljs-comment">defaulting</span> <span class="hljs-literal">--</span><span class="hljs-comment">programmatic</span><span class="hljs-literal">-</span><span class="hljs-comment">validation</span><br></code></pre></td></tr></table></figure><p>ç”Ÿæˆæ–‡ä»¶åœ¨<code>api/v1/game_webhook.go</code></p><p><code>Default</code>æ¥å£å¯å®ç°ä¿®æ”¹èµ„æºï¼Œæ ¹æ® kubebuilder æ³¨é‡Š,å½“<code>game</code>èµ„æº<code>create</code>ä¸<code>update</code>æ—¶ï¼Œè°ƒç”¨è¿™ä¸ªæ¥å£</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">//+kubebuilder:webhook:<span class="hljs-type">path</span>=/mutate-myapp-qingwave-github-io-v1-game,mutating=<span class="hljs-keyword">true</span>,failurePolicy=fail,sideEffects=<span class="hljs-keyword">None</span>,<span class="hljs-keyword">groups</span>=myapp.qingwave.github.io,resources=games,verbs=<span class="hljs-keyword">create</span>;<span class="hljs-keyword">update</span>,versions=v1,<span class="hljs-type">name</span>=mgame.kb.io,admissionReviewVersions=&#123;v1,v1beta1&#125;<br>const (<br>defaultImage = `alexwhen/docker<span class="hljs-number">-2048</span>`<br>)<br><br>// <span class="hljs-keyword">Default</span> implements webhook.Defaulter so a webhook will be registered <span class="hljs-keyword">for</span> the <span class="hljs-keyword">type</span><br>func (r *Game) <span class="hljs-keyword">Default</span>() &#123;<br>gamelog.<span class="hljs-keyword">Info</span>(&quot;default&quot;, &quot;name&quot;, r.Name)<br><br>// è®¾ç½®é»˜è®¤é•œåƒ<br><span class="hljs-keyword">if</span> r.Spec.Image == &quot;&quot; &#123;<br>r.Spec.Image = defaultImage<br>&#125;<br><br>// è®¾ç½®é»˜è®¤Host<br><span class="hljs-keyword">if</span> r.Spec.Host == &quot;&quot; &#123;<br>r.Spec.Host = fmt.Sprintf(&quot;%s.%s.mygame.io&quot;, r.Name, r.Namespace)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åŒæ ·çš„é€šè¿‡<code>ValidateCreate</code>ã€<code>ValidateUpdate</code>å¯å®ç°<code>validating webhook</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Game)</span></span> ValidateCreate() <span class="hljs-type">error</span> &#123;<br>gamelog.Info(<span class="hljs-string">&quot;validate create&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>, r.Name)<br><br><span class="hljs-comment">// Hostä¸èƒ½åŒ…æ‹¬é€šé…ç¬¦</span><br><span class="hljs-keyword">if</span> strings.Contains(r.Spec.Host, <span class="hljs-string">&quot;*&quot;</span>) &#123;<br><span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;host should not contain *&quot;</span>)<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æœ¬åœ°éªŒè¯ webhook éœ€è¦é…ç½®è¯ä¹¦ï¼Œåœ¨é›†ç¾¤ä¸­æµ‹è¯•æ›´æ–¹ä¾¿ç‚¹ï¼Œå¯å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†ä¸€ä¸ªåŠŸèƒ½å®Œå…¨çš„<code>game-operator</code>ï¼Œå¯ä»¥ç®¡ç†<code>game</code>èµ„æºçš„ç”Ÿå‘½å‘¨æœŸï¼Œåˆ›å»º&#x2F;æ›´æ–° game æ—¶ä¼šè‡ªåŠ¨åˆ›å»º<code>deploymentã€serviceã€ingress</code>ç­‰èµ„æºï¼Œå½“<code>deployment</code>è¢«è¯¯åˆ æˆ–è€…è¯¯ä¿®æ”¹æ—¶ä¹Ÿå¯ä»¥è‡ªåŠ¨å›å¤åˆ°æœŸæœ›çŠ¶æ€ï¼Œä¹Ÿå®ç°äº†<code>scale</code>æ¥å£ã€‚</p><p>é€šè¿‡<code>kubebuiler</code>å¤§å¤§ç®€åŒ–äº†å¼€å‘<code>operator</code>çš„æˆæœ¬ï¼Œæˆ‘ä»¬åªéœ€è¦å…³å¿ƒä¸šåŠ¡é€»è¾‘å³å¯ï¼Œä¸éœ€è¦å†æ‰‹åŠ¨å»åˆ›å»º<code>client/controller</code>ç­‰ï¼Œä½†åŒæ—¶<code>kubebuilder</code>ç”Ÿæˆçš„ä»£ç ä¸­å±è”½äº†å¾ˆå¤šç»†èŠ‚ï¼Œæ¯”å¦‚<code>controller</code>çš„æœ€å¤§ worker æ•°ã€åŒæ­¥æ—¶é—´ã€é˜Ÿåˆ—ç±»å‹ç­‰å‚æ•°è®¾ç½®ï¼Œåªæœ‰äº†è§£<code>operator</code>çš„åŸç†æ‰æ›´å¥½åº”ç”¨äºç”Ÿäº§ã€‚</p><h2 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h2><ul><li><a href="https://book.kubebuilder.io/">https://book.kubebuilder.io/</a></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>k8sè¯ä¹¦</title>
    <link href="/2025/03/30/k8s%E8%AF%81%E4%B9%A6/"/>
    <url>/2025/03/30/k8s%E8%AF%81%E4%B9%A6/</url>
    
    <content type="html"><![CDATA[<p>è½¬è‡ªï¼š<a href="https://www.zhaohuabing.com/post/2020-05-19-k8s-certificate/">https://www.zhaohuabing.com/post/2020-05-19-k8s-certificate/</a></p><p>æ¥è§¦ Kubernetes ä»¥æ¥ï¼Œæˆ‘ç»å¸¸çœ‹åˆ° Kubernetes åœ¨ä¸åŒçš„åœ°æ–¹ä½¿ç”¨äº†è¯ä¹¦ï¼ˆCertificateï¼‰ï¼Œåœ¨ Kubernetes å®‰è£…å’Œç»„ä»¶å¯åŠ¨å‚æ•°ä¸­ä¹Ÿéœ€è¦é…ç½®å¤§é‡è¯ä¹¦ç›¸å…³çš„å‚æ•°ã€‚ä½†æ˜¯ Kubernetes çš„æ–‡æ¡£åœ¨è§£é‡Šè¿™äº›è¯ä¹¦çš„å·¥ä½œæœºåˆ¶æ–¹é¢åšå¾—å¹¶ä¸æ˜¯å¤ªå¥½ã€‚ç»è¿‡å¤§é‡çš„ç›¸å…³é˜…è¯»å’Œåˆ†æå·¥ä½œåï¼Œæˆ‘åŸºæœ¬å¼„æ¸…æ¥šäº† Kubernetes ä¸­è¯ä¹¦çš„ä½¿ç”¨æ–¹å¼ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†è¯•å›¾ä»¥ä¸€ç§æ¯”å®˜æ–¹æ–‡æ¡£æ›´å®¹æ˜“ç†è§£çš„æ–¹å¼æ¥è¯´æ˜ Kubernetes ä¸­è¯ä¹¦ç›¸å…³çš„å·¥ä½œæœºåˆ¶ï¼Œå¦‚æœä½ ä¹Ÿå­˜åœ¨è¿™æ–¹é¢çš„ç–‘æƒ‘ï¼Œå¸Œæœ›è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚</p><h1 id="Kubernetes-ç»„ä»¶çš„è®¤è¯æ–¹å¼"><a href="#Kubernetes-ç»„ä»¶çš„è®¤è¯æ–¹å¼" class="headerlink" title="Kubernetes ç»„ä»¶çš„è®¤è¯æ–¹å¼"></a>Kubernetes ç»„ä»¶çš„è®¤è¯æ–¹å¼</h1><p>é¦–å…ˆè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ Kubernetes ä¸­çš„ç»„ä»¶ï¼šåœ¨ Kubernetes ä¸­åŒ…å«å¤šä¸ªä»¥ç‹¬ç«‹è¿›ç¨‹å½¢å¼è¿è¡Œçš„ç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶ä¹‹é—´é€šè¿‡ HTTP&#x2F;GRPC ç›¸äº’é€šä¿¡ï¼Œä»¥ååŒå®Œæˆé›†ç¾¤ä¸­åº”ç”¨çš„éƒ¨ç½²å’Œç®¡ç†å·¥ä½œã€‚</p><p><img src="/2025/03/30/k8s%E8%AF%81%E4%B9%A6/components-of-kubernetes.png" alt="img">kubernetes ç»„ä»¶ï¼Œå›¾ç‰‡æ¥æº<a href="https://kubernetes.io/zh/docs/concepts/overview/components/">kubernetes.io</a></p><p>ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒKubernetes æ§åˆ¶å¹³é¢ä¸­åŒ…å«äº† etctdï¼Œkube-api-serverï¼Œkube-schedulerï¼Œkube-controller-manager ç­‰ç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶ä¼šç›¸äº’è¿›è¡Œè¿œç¨‹è°ƒç”¨ï¼Œä¾‹å¦‚ kube-api-server ä¼šè°ƒç”¨ etcd æ¥å£å­˜å‚¨æ•°æ®ï¼Œkube-controller-manager ä¼šè°ƒç”¨ kube-api-server æ¥å£æŸ¥è¯¢é›†ç¾¤ä¸­çš„å¯¹è±¡çŠ¶æ€ï¼›åŒæ—¶ï¼Œkube-api-server ä¹Ÿä¼šå’Œåœ¨å·¥ä½œèŠ‚ç‚¹ä¸Šçš„ kubelet å’Œ kube-proxy è¿›è¡Œé€šä¿¡ï¼Œä»¥åœ¨å·¥ä½œèŠ‚ç‚¹ä¸Šéƒ¨ç½²å’Œç®¡ç†åº”ç”¨ã€‚</p><p>ä»¥ä¸Šè¿™äº›ç»„ä»¶ä¹‹é—´çš„ç›¸äº’è°ƒç”¨éƒ½æ˜¯é€šè¿‡ç½‘ç»œè¿›è¡Œçš„ã€‚åœ¨è¿›è¡Œç½‘ç»œé€šä¿¡æ—¶ï¼Œé€šä¿¡åŒæ–¹éœ€è¦éªŒè¯å¯¹æ–¹çš„èº«ä»½ï¼Œä»¥é¿å…æ¶æ„ç¬¬ä¸‰æ–¹ä¼ªé€ èº«ä»½çªƒå–ä¿¡æ¯æˆ–è€…å¯¹ç³»ç»Ÿè¿›è¡Œæ”»å‡»ã€‚ä¸ºäº†ç›¸äº’éªŒè¯å¯¹æ–¹çš„èº«ä»½ï¼Œé€šä¿¡åŒæ–¹ä¸­çš„ä»»ä½•ä¸€æ–¹éƒ½éœ€è¦åšä¸‹é¢ä¸¤ä»¶äº‹æƒ…ï¼š</p><ul><li>å‘å¯¹æ–¹æä¾›æ ‡æ˜è‡ªå·±èº«ä»½çš„ä¸€ä¸ªè¯ä¹¦</li><li>éªŒè¯å¯¹æ–¹æä¾›çš„èº«ä»½è¯ä¹¦æ˜¯å¦åˆæ³•ï¼Œæ˜¯å¦ä¼ªé€ çš„ï¼Ÿ</li></ul><p>åœ¨ Kubernetes ä¸­ä½¿ç”¨äº†æ•°å­—è¯ä¹¦æ¥æä¾›èº«ä»½è¯æ˜ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ•°å­—è¯ä¹¦ç®€å•ç†è§£ä¸ºæˆ‘ä»¬åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­ä½¿ç”¨çš„â€œèº«ä»½è¯â€ï¼Œä¸Šé¢æ ‡æ³¨äº†è¯ä¹¦æ‹¥æœ‰è€…çš„èº«ä»½ä¿¡æ¯ï¼Œä¾‹å¦‚åç§°ï¼Œæ‰€å±ç»„ç»‡æœºæ„ç­‰ã€‚ä¸ºäº†ä¿è¯è¯ä¹¦çš„æƒå¨æ€§ï¼Œä¼šé‡‡ç”¨ä¸€ä¸ªé€šä¿¡åŒæ–¹éƒ½ä¿¡ä»»çš„ CAï¼ˆè¯ä¹¦æœºæ„ï¼ŒCertificate Authorityï¼‰æ¥é¢å‘è¯ä¹¦ã€‚è¿™å°±ç±»ä¼¼äºç°å®ç”Ÿæ´»ä¸­é¢å‘â€œèº«ä»½è¯â€çš„æ”¿åºœæœºæ„ã€‚æ•°å­—è¯ä¹¦ä¸­æœ€é‡è¦çš„å†…å®¹å®é™…ä¸Šæ˜¯è¯ä¹¦æ‹¥æœ‰è€…çš„å…¬é’¥ï¼Œè¯¥å…¬é’¥ä»£è¡¨äº†ç”¨æˆ·çš„èº«ä»½ã€‚æœ¬æ–‡å‡è®¾è¯»è€…å·²ç»äº†è§£æ•°å­—è¯ä¹¦å’Œ CA çš„åŸºæœ¬åŸç†ï¼Œå¦‚æœä½ å¯¹æ­¤ä¸å¤ªæ¸…æ¥šï¼Œæˆ–è€…å¸Œæœ›é‡æ–°æ¸©ä¹ ä¸€ä¸‹ç›¸å…³çŸ¥è¯†ï¼Œå¯ä»¥å…ˆé˜…è¯»ä¸€ä¸‹è¿™ç¯‡æ–‡ç« <a href="https://zhaohuabing.com/post/2020-03-19-pki">ã€Šæ•°å­—è¯ä¹¦åŸç†ã€‹</a>ã€‚</p><p><img src="/2025/03/30/k8s%E8%AF%81%E4%B9%A6/ca.png" alt="img"></p><p>CA ï¼ˆè¯ä¹¦æœºæ„ï¼‰ï¼Œå›¾ç‰‡æ¥æº<a href="https://www.trustauth.cn/ca-question/1791.html">www.trustauth.cn</a></p><p>åœ¨ Kubernetes çš„ç»„ä»¶ä¹‹é—´è¿›è¡Œé€šä¿¡æ—¶ï¼Œæ•°å­—è¯ä¹¦çš„éªŒè¯æ˜¯åœ¨åè®®å±‚é¢é€šè¿‡ TLS å®Œæˆçš„ï¼Œé™¤äº†éœ€è¦åœ¨å»ºç«‹é€šä¿¡æ—¶æä¾›ç›¸å…³çš„è¯ä¹¦å’Œå¯†é’¥å¤–ï¼Œåœ¨åº”ç”¨å±‚é¢å¹¶ä¸éœ€è¦è¿›è¡Œç‰¹æ®Šå¤„ç†ã€‚é‡‡ç”¨ TLS è¿›è¡ŒéªŒè¯æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ul><li>æœåŠ¡å™¨å•å‘è®¤è¯ï¼šåªéœ€è¦æœåŠ¡å™¨ç«¯æä¾›è¯ä¹¦ï¼Œå®¢æˆ·ç«¯é€šè¿‡æœåŠ¡å™¨ç«¯è¯ä¹¦éªŒè¯æœåŠ¡çš„èº«ä»½ï¼Œä½†æœåŠ¡å™¨å¹¶ä¸éªŒè¯å®¢æˆ·ç«¯çš„èº«ä»½ã€‚è¿™ç§æƒ…å†µä¸€èˆ¬é€‚ç”¨äºå¯¹ Internet å¼€æ”¾çš„æœåŠ¡ï¼Œä¾‹å¦‚æœç´¢å¼•æ“ç½‘ç«™ï¼Œä»»ä½•å®¢æˆ·ç«¯éƒ½å¯ä»¥è¿æ¥åˆ°æœåŠ¡å™¨ä¸Šè¿›è¡Œè®¿é—®ï¼Œä½†å®¢æˆ·ç«¯éœ€è¦éªŒè¯æœåŠ¡å™¨çš„èº«ä»½ï¼Œä»¥é¿å…è¿æ¥åˆ°ä¼ªé€ çš„æ¶æ„æœåŠ¡å™¨ã€‚</li><li>åŒå‘ TLS è®¤è¯ï¼šé™¤äº†å®¢æˆ·ç«¯éœ€è¦éªŒè¯æœåŠ¡å™¨çš„è¯ä¹¦ï¼ŒæœåŠ¡å™¨ä¹Ÿè¦é€šè¿‡å®¢æˆ·ç«¯è¯ä¹¦éªŒè¯å®¢æˆ·ç«¯çš„èº«ä»½ã€‚è¿™ç§æƒ…å†µä¸‹æœåŠ¡å™¨æä¾›çš„æ˜¯æ•æ„Ÿä¿¡æ¯ï¼Œåªå…è®¸ç‰¹å®šèº«ä»½çš„å®¢æˆ·ç«¯è®¿é—®ã€‚</li></ul><p>åœ¨ Kubernetes ä¸­ï¼Œå„ä¸ªç»„ä»¶æä¾›çš„æ¥å£ä¸­åŒ…å«äº†é›†ç¾¤çš„å†…éƒ¨ä¿¡æ¯ã€‚å¦‚æœè¿™äº›æ¥å£è¢«éæ³•è®¿é—®ï¼Œå°†å½±å“é›†ç¾¤çš„å®‰å…¨ï¼Œå› æ­¤ç»„ä»¶ä¹‹é—´çš„é€šä¿¡éœ€è¦é‡‡ç”¨åŒå‘ TLS è®¤è¯ã€‚å³å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯éƒ½éœ€è¦éªŒè¯å¯¹æ–¹çš„èº«ä»½ä¿¡æ¯ã€‚åœ¨ä¸¤ä¸ªç»„ä»¶è¿›è¡ŒåŒå‘è®¤è¯æ—¶ï¼Œä¼šæ¶‰åŠåˆ°ä¸‹é¢è¿™äº›è¯ä¹¦ç›¸å…³çš„æ–‡ä»¶ï¼š</p><ul><li>æœåŠ¡å™¨ç«¯è¯ä¹¦ï¼šæœåŠ¡å™¨ç”¨äºè¯æ˜è‡ªèº«èº«ä»½çš„æ•°å­—è¯ä¹¦ï¼Œé‡Œé¢ä¸»è¦åŒ…å«äº†æœåŠ¡å™¨ç«¯çš„å…¬é’¥ä»¥åŠæœåŠ¡å™¨çš„èº«ä»½ä¿¡æ¯ã€‚</li><li>æœåŠ¡å™¨ç«¯ç§é’¥ï¼šæœåŠ¡å™¨ç«¯è¯ä¹¦ä¸­åŒ…å«çš„å…¬é’¥æ‰€å¯¹åº”çš„ç§é’¥ã€‚å…¬é’¥å’Œç§é’¥æ˜¯æˆå¯¹ä½¿ç”¨çš„ï¼Œåœ¨è¿›è¡Œ TLS éªŒè¯æ—¶ï¼ŒæœåŠ¡å™¨ä½¿ç”¨è¯¥ç§é’¥æ¥å‘å®¢æˆ·ç«¯è¯æ˜è‡ªå·±æ˜¯æœåŠ¡å™¨ç«¯è¯ä¹¦çš„æ‹¥æœ‰è€…ã€‚</li><li>å®¢æˆ·ç«¯è¯ä¹¦ï¼šå®¢æˆ·ç«¯ç”¨äºè¯æ˜è‡ªèº«èº«ä»½çš„æ•°å­—è¯ä¹¦ï¼Œé‡Œé¢ä¸»è¦åŒ…å«äº†å®¢æˆ·ç«¯çš„å…¬é’¥ä»¥åŠå®¢æˆ·ç«¯çš„èº«ä»½ä¿¡æ¯ã€‚</li><li>å®¢æˆ·ç«¯ç§é’¥ï¼šå®¢æˆ·ç«¯è¯ä¹¦ä¸­åŒ…å«çš„å…¬é’¥æ‰€å¯¹åº”çš„ç§é’¥ï¼ŒåŒç†ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨è¯¥ç§é’¥æ¥å‘æœåŠ¡å™¨ç«¯è¯æ˜è‡ªå·±æ˜¯å®¢æˆ·ç«¯è¯ä¹¦çš„æ‹¥æœ‰è€…ã€‚</li><li>æœåŠ¡å™¨ç«¯ CA æ ¹è¯ä¹¦ï¼šç­¾å‘æœåŠ¡å™¨ç«¯è¯ä¹¦çš„ CA æ ¹è¯ä¹¦ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨è¯¥ CA æ ¹è¯ä¹¦æ¥éªŒè¯æœåŠ¡å™¨ç«¯è¯ä¹¦çš„åˆæ³•æ€§ã€‚</li><li>å®¢æˆ·ç«¯ç«¯ CA æ ¹è¯ä¹¦ï¼šç­¾å‘å®¢æˆ·ç«¯è¯ä¹¦çš„ CA æ ¹è¯ä¹¦ï¼ŒæœåŠ¡å™¨ç«¯ä½¿ç”¨è¯¥ CA æ ¹è¯ä¹¦æ¥éªŒè¯å®¢æˆ·ç«¯è¯ä¹¦çš„åˆæ³•æ€§ã€‚</li></ul><p>ä¸‹é¢è¿™å¼ æ¥è‡ª<a href="https://medium.com/sitewards/the-magic-of-tls-x509-and-mutual-authentication-explained-b2162dec4401">The magic of TLS, X509 and mutual authentication explained</a> æ–‡ç« ä¸­çš„å›¾å½¢è±¡åœ°è§£é‡Šäº†åŒå‘ TLS è®¤è¯çš„åŸç†ã€‚å¦‚æœä½ éœ€è¦äº†è§£æ›´å¤šå…³äº TLS è®¤è¯çš„åŸç†ï¼Œå¯ä»¥é˜…è¯»ä¸€ä¸‹ medium ä¸Šçš„åŸæ–‡ã€‚</p><p><img src="/2025/03/30/k8s%E8%AF%81%E4%B9%A6/mutual-tls.png" alt="img"></p><p>å›¾ç‰‡æ¥æº<a href="https://medium.com/sitewards/the-magic-of-tls-x509-and-mutual-authentication-explained-b2162dec4401">The magic of TLS, X509 and mutual authentication explained</a></p><h1 id="Kubernetes-ä¸­ä½¿ç”¨åˆ°çš„CAå’Œè¯ä¹¦"><a href="#Kubernetes-ä¸­ä½¿ç”¨åˆ°çš„CAå’Œè¯ä¹¦" class="headerlink" title="Kubernetes ä¸­ä½¿ç”¨åˆ°çš„CAå’Œè¯ä¹¦"></a>Kubernetes ä¸­ä½¿ç”¨åˆ°çš„CAå’Œè¯ä¹¦</h1><p>Kubernetes ä¸­ä½¿ç”¨äº†å¤§é‡çš„è¯ä¹¦ï¼Œæœ¬æ–‡ä¸ä¼šè¯•å›¾è¦†ç›–åˆ°æ‰€æœ‰å¯èƒ½ä½¿ç”¨åˆ°çš„è¯ä¹¦ï¼Œä½†ä¼šè®¨è®ºåˆ°ä¸»è¦çš„è¯ä¹¦ã€‚ç†è§£äº†è¿™äº›è¯ä¹¦çš„ä½¿ç”¨æ–¹æ³•å’ŒåŸç†åï¼Œä¹Ÿèƒ½å¾ˆå¿«ç†è§£å…¶ä»–å¯èƒ½é‡åˆ°çš„è¯ä¹¦æ–‡ä»¶ã€‚ä¸‹å›¾æ ‡è¯†å‡ºäº†åœ¨ kubernetes ä¸­ä¸»è¦ä½¿ç”¨åˆ°çš„è¯ä¹¦å’Œå…¶ä½¿ç”¨çš„ä½ç½®ï¼š</p><p><img src="/2025/03/30/k8s%E8%AF%81%E4%B9%A6/kubernetes-certificate-usage.png" alt="img"></p><p>Kubernetes ä¸­ä½¿ç”¨åˆ°çš„ä¸»è¦è¯ä¹¦</p><p>ä¸Šå›¾ä¸­ä½¿ç”¨åºå·å¯¹è¯ä¹¦è¿›è¡Œäº†æ ‡æ³¨ã€‚å›¾ä¸­çš„ç®­å¤´è¡¨æ˜äº†ç»„ä»¶çš„è°ƒç”¨æ–¹å‘ï¼Œç®­å¤´æ‰€æŒ‡æ–¹å‘ä¸ºæœåŠ¡æä¾›æ–¹ï¼Œå¦ä¸€å¤´ä¸ºæœåŠ¡è°ƒç”¨æ–¹ã€‚ä¸ºäº†å®ç° TLS åŒå‘è®¤è¯ï¼ŒæœåŠ¡æä¾›æ–¹éœ€è¦ä½¿ç”¨ä¸€ä¸ªæœåŠ¡å™¨è¯ä¹¦ï¼ŒæœåŠ¡è°ƒç”¨æ–¹åˆ™éœ€è¦æä¾›ä¸€ä¸ªå®¢æˆ·ç«¯è¯ä¹¦ï¼Œå¹¶ä¸”åŒæ–¹éƒ½éœ€è¦ä½¿ç”¨ä¸€ä¸ª CA è¯ä¹¦æ¥éªŒè¯å¯¹æ–¹æä¾›çš„è¯ä¹¦ã€‚ä¸ºäº†ç®€æ˜èµ·è§ï¼Œä¸Šå›¾ä¸­åªæ ‡æ³¨äº†è¯ä¹¦ä½¿ç”¨æ–¹æä¾›çš„è¯ä¹¦ï¼Œå¹¶æ²¡æœ‰æ ‡æ³¨è¯ä¹¦çš„éªŒè¯æ–¹éªŒè¯ä½¿ç”¨çš„ CA è¯ä¹¦ã€‚å›¾ä¸­æ ‡æ³¨çš„è¿™äº›è¯ä¹¦çš„ä½œç”¨åˆ†åˆ«å¦‚ä¸‹ï¼š</p><ol><li>etcd é›†ç¾¤ä¸­å„ä¸ªèŠ‚ç‚¹ä¹‹é—´ç›¸äº’é€šä¿¡ä½¿ç”¨çš„è¯ä¹¦ã€‚ç”±äºä¸€ä¸ª etctd èŠ‚ç‚¹æ—¢ä¸ºå…¶ä»–èŠ‚ç‚¹æä¾›æœåŠ¡ï¼Œåˆéœ€è¦ä½œä¸ºå®¢æˆ·ç«¯è®¿é—®å…¶ä»–èŠ‚ç‚¹ï¼Œå› æ­¤è¯¥è¯ä¹¦åŒæ—¶ç”¨ä½œæœåŠ¡å™¨è¯ä¹¦å’Œå®¢æˆ·ç«¯è¯ä¹¦ã€‚</li><li>etcd é›†ç¾¤å‘å¤–æä¾›æœåŠ¡ä½¿ç”¨çš„è¯ä¹¦ã€‚è¯¥è¯ä¹¦æ˜¯æœåŠ¡å™¨è¯ä¹¦ã€‚</li><li>kube-apiserver ä½œä¸ºå®¢æˆ·ç«¯è®¿é—® etcd ä½¿ç”¨çš„è¯ä¹¦ã€‚è¯¥è¯ä¹¦æ˜¯å®¢æˆ·ç«¯è¯ä¹¦ã€‚</li><li>kube-apiserver å¯¹å¤–æä¾›æœåŠ¡ä½¿ç”¨çš„è¯ä¹¦ã€‚è¯¥è¯ä¹¦æ˜¯æœåŠ¡å™¨è¯ä¹¦ã€‚</li><li>kube-controller-manager ä½œä¸ºå®¢æˆ·ç«¯è®¿é—® kube-apiserver ä½¿ç”¨çš„è¯ä¹¦,è¯¥è¯ä¹¦æ˜¯å®¢æˆ·ç«¯è¯ä¹¦ã€‚</li><li>kube-scheduler ä½œä¸ºå®¢æˆ·ç«¯è®¿é—® kube-apiserver ä½¿ç”¨çš„è¯ä¹¦,è¯¥è¯ä¹¦æ˜¯å®¢æˆ·ç«¯è¯ä¹¦ã€‚</li><li>kube-proxy ä½œä¸ºå®¢æˆ·ç«¯è®¿é—® kube-apiserver ä½¿ç”¨çš„è¯ä¹¦,è¯¥è¯ä¹¦æ˜¯å®¢æˆ·ç«¯è¯ä¹¦ã€‚</li><li>kubelet ä½œä¸ºå®¢æˆ·ç«¯è®¿é—® kube-apiserver ä½¿ç”¨çš„è¯ä¹¦,è¯¥è¯ä¹¦æ˜¯å®¢æˆ·ç«¯è¯ä¹¦ã€‚</li><li>ç®¡ç†å‘˜ç”¨æˆ·é€šè¿‡ kubectl è®¿é—® kube-apiserver ä½¿ç”¨çš„è¯ä¹¦,è¯¥è¯ä¹¦æ˜¯å®¢æˆ·ç«¯è¯ä¹¦ã€‚</li><li>kubelet å¯¹å¤–æä¾›æœåŠ¡ä½¿ç”¨çš„è¯ä¹¦ã€‚è¯¥è¯ä¹¦æ˜¯æœåŠ¡å™¨è¯ä¹¦ã€‚</li><li>kube-apiserver ä½œä¸ºå®¢æˆ·ç«¯è®¿é—® kubelet é‡‡ç”¨çš„è¯ä¹¦ã€‚è¯¥è¯ä¹¦æ˜¯å®¢æˆ·ç«¯è¯ä¹¦ã€‚</li><li>kube-controller-manager ç”¨äºç”Ÿæˆå’ŒéªŒè¯ service-account token çš„è¯ä¹¦ã€‚è¯¥è¯ä¹¦å¹¶ä¸ä¼šåƒå…¶ä»–è¯ä¹¦ä¸€æ ·ç”¨äºèº«ä»½è®¤è¯ï¼Œè€Œæ˜¯å°†è¯ä¹¦ä¸­çš„å…¬é’¥&#x2F;ç§é’¥å¯¹ç”¨äº service account token çš„ç”Ÿæˆå’ŒéªŒè¯ã€‚kube-controller-manager ä¼šç”¨è¯¥è¯ä¹¦çš„ç§é’¥æ¥ç”Ÿæˆ service account tokenï¼Œç„¶åä»¥ secret çš„æ–¹å¼åŠ è½½åˆ° pod ä¸­ã€‚pod ä¸­çš„åº”ç”¨å¯ä»¥ä½¿ç”¨è¯¥ token æ¥è®¿é—® kube-apiserverï¼Œ kube-apiserver ä¼šä½¿ç”¨è¯¥è¯ä¹¦ä¸­çš„å…¬é’¥æ¥éªŒè¯è¯·æ±‚ä¸­çš„ tokenã€‚æˆ‘ä»¬å°†åœ¨æ–‡ä¸­ç¨åéƒ¨åˆ†è¯¦ç»†ä»‹ç»è¯¥è¯ä¹¦çš„ä½¿ç”¨æ–¹æ³•ã€‚</li></ol><p>é€šè¿‡è¿™å¼ å›¾ï¼Œå¯¹è¯ä¹¦æœºåˆ¶æ¯”è¾ƒäº†è§£çš„è¯»è€…å¯èƒ½å·²ç»çœ‹å‡ºï¼Œæˆ‘ä»¬å…¶å®å¯ä»¥ä½¿ç”¨å¤šä¸ªä¸åŒçš„ CA æ¥é¢å‘è¿™äº›è¯ä¹¦ã€‚åªè¦åœ¨é€šä¿¡çš„ç»„ä»¶ä¸­æ­£ç¡®é…ç½®ç”¨äºéªŒè¯å¯¹æ–¹è¯ä¹¦çš„ CA æ ¹è¯ä¹¦ï¼Œå°±å¯ä»¥ä½¿ç”¨ä¸åŒçš„ CA æ¥é¢å‘ä¸åŒç”¨é€”çš„è¯ä¹¦ã€‚ä½†æˆ‘ä»¬ä¸€èˆ¬å»ºè®®é‡‡ç”¨ç»Ÿä¸€çš„ CA æ¥é¢å‘ kubernetes é›†ç¾¤ä¸­çš„æ‰€æœ‰è¯ä¹¦ï¼Œè¿™æ˜¯å› ä¸ºé‡‡ç”¨ä¸€ä¸ªé›†ç¾¤æ ¹ CA çš„æ–¹å¼æ¯”é‡‡ç”¨å¤šä¸ª CA çš„æ–¹å¼æ›´å®¹æ˜“ç®¡ç†ï¼Œå¯ä»¥é¿å…å¤šä¸ªCA å¯¼è‡´çš„å¤æ‚çš„è¯ä¹¦é…ç½®ã€æ›´æ–°ç­‰é—®é¢˜ï¼Œå‡å°‘ç”±äºè¯ä¹¦é…ç½®é”™è¯¯å¯¼è‡´çš„é›†ç¾¤æ•…éšœã€‚</p><h1 id="Kubernetes-ä¸­çš„è¯ä¹¦é…ç½®"><a href="#Kubernetes-ä¸­çš„è¯ä¹¦é…ç½®" class="headerlink" title="Kubernetes ä¸­çš„è¯ä¹¦é…ç½®"></a>Kubernetes ä¸­çš„è¯ä¹¦é…ç½®</h1><p>å‰é¢æˆ‘ä»¬ä»‹ç»äº† Kubernetes é›†ç¾¤ä¸­ä¸»è¦ä½¿ç”¨åˆ°çš„è¯ä¹¦ã€‚ä¸‹é¢æˆ‘ä»¬åˆ†åˆ«çœ‹ä¸€ä¸‹å¦‚ä½•å°†è¿™äº›è¯ä¹¦åŠå…¶å¯¹åº”çš„ç§é’¥å’Œ CA æ ¹è¯ä¹¦éœ€è¦é…ç½®åˆ° Kubernetes ä¸­å„ä¸ªç»„ä»¶ä¸­ï¼Œä»¥ä¾›å„ä¸ªç»„ä»¶è¿›è¡Œä½¿ç”¨ã€‚è¿™é‡Œå‡è®¾ä½¿ç”¨ä¸€ä¸ªé›†ç¾¤æ ¹ CA æ¥é¢å‘æ‰€æœ‰ç›¸å…³è¯ä¹¦ï¼Œå› æ­¤æ¶‰åŠåˆ° CA çš„é…ç½®å¯¹åº”çš„è¯ä¹¦æ–‡ä»¶åéƒ½æ˜¯ç›¸åŒçš„ã€‚</p><h2 id="etcd-è¯ä¹¦é…ç½®"><a href="#etcd-è¯ä¹¦é…ç½®" class="headerlink" title="etcd è¯ä¹¦é…ç½®"></a>etcd è¯ä¹¦é…ç½®</h2><p>éœ€è¦åœ¨ etcd çš„å¯åŠ¨å‘½ä»¤è¡Œä¸­é…ç½®ä»¥ä¸‹è¯ä¹¦ç›¸å…³å‚æ•°ï¼š</p><ul><li>etcd å¯¹å¤–æä¾›æœåŠ¡çš„æœåŠ¡å™¨è¯ä¹¦åŠç§é’¥ã€‚</li><li>etcd èŠ‚ç‚¹ä¹‹é—´ç›¸äº’è¿›è¡Œè®¤è¯çš„ peer è¯ä¹¦ã€ç§é’¥ä»¥åŠéªŒè¯ peer çš„ CAã€‚</li><li>etcd éªŒè¯è®¿é—®å…¶æœåŠ¡çš„å®¢æˆ·ç«¯çš„ CAã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">/usr/local/bin/etcd \\<br>  --cert-file=/etc/etcd/kube-etcd.pem \\                   <span class="hljs-comment"># å¯¹å¤–æä¾›æœåŠ¡çš„æœåŠ¡å™¨è¯ä¹¦</span><br>  --key-file=/etc/etcd/kube-etcd-key.pem \\                <span class="hljs-comment"># æœåŠ¡å™¨è¯ä¹¦å¯¹åº”çš„ç§é’¥</span><br>  --peer-cert-file=/etc/etcd/kube-etcd-peer.pem \\         <span class="hljs-comment"># peer è¯ä¹¦ï¼Œç”¨äº etcd èŠ‚ç‚¹ä¹‹é—´çš„ç›¸äº’è®¿é—®</span><br>  --peer-key-file=/etc/etcd/kube-etcd-peer-key.pem \\      <span class="hljs-comment"># peer è¯ä¹¦å¯¹åº”çš„ç§é’¥</span><br>  --trusted-ca-file=/etc/etcd/cluster-root-ca.pem \\       <span class="hljs-comment"># ç”¨äºéªŒè¯è®¿é—® etcd æœåŠ¡å™¨çš„å®¢æˆ·ç«¯è¯ä¹¦çš„ CA æ ¹è¯ä¹¦</span><br>  --peer-trusted-ca-file=/etc/etcd/cluster-root-ca.pem\\   <span class="hljs-comment"># ç”¨äºéªŒè¯ peer è¯ä¹¦çš„ CA æ ¹è¯ä¹¦</span><br>  ...<br></code></pre></td></tr></table></figure><h2 id="kube-apiserver-è¯ä¹¦é…ç½®"><a href="#kube-apiserver-è¯ä¹¦é…ç½®" class="headerlink" title="kube-apiserver è¯ä¹¦é…ç½®"></a>kube-apiserver è¯ä¹¦é…ç½®</h2><p>éœ€è¦åœ¨ kube-apiserver ä¸­é…ç½®ä»¥ä¸‹è¯ä¹¦ç›¸å…³å‚æ•°ï¼š</p><ul><li>kube-apiserver å¯¹å¤–æä¾›æœåŠ¡çš„æœåŠ¡å™¨è¯ä¹¦åŠç§é’¥ã€‚</li><li>kube-apiserver è®¿é—® etcd æ‰€éœ€çš„å®¢æˆ·ç«¯è¯ä¹¦åŠç§é’¥ã€‚</li><li>kube-apiserver è®¿é—® kubelet æ‰€éœ€çš„å®¢æˆ·ç«¯è¯ä¹¦åŠç§é’¥ã€‚</li><li>éªŒè¯è®¿é—®å…¶æœåŠ¡çš„å®¢æˆ·ç«¯çš„ CAã€‚</li><li>éªŒè¯ etcd æœåŠ¡å™¨è¯ä¹¦çš„ CA æ ¹è¯ä¹¦ã€‚</li><li>éªŒè¯ service account token çš„å…¬é’¥ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">/usr/local/bin/kube-apiserver \\ <br>  --tls-cert-file=/var/lib/kubernetes/kube-apiserver.pem \\                             <span class="hljs-comment"># ç”¨äºå¯¹å¤–æä¾›æœåŠ¡çš„æœåŠ¡å™¨è¯ä¹¦</span><br>  --tls-private-key-file=/var/lib/kubernetes/kube-apiserver-key.pem \\                  <span class="hljs-comment"># æœåŠ¡å™¨è¯ä¹¦å¯¹åº”çš„ç§é’¥</span><br>  --etcd-certfile=/var/lib/kubernetes/kube-apiserver-etcd-client.pem \\                 <span class="hljs-comment"># ç”¨äºè®¿é—® etcd çš„å®¢æˆ·ç«¯è¯ä¹¦</span><br>  --etcd-keyfile=/var/lib/kubernetes/kube-apiserver-etcd-client-key.pem \\              <span class="hljs-comment"># ç”¨äºè®¿é—® etcd çš„å®¢æˆ·ç«¯è¯ä¹¦çš„ç§é’¥</span><br>  --kubelet-client-certificate=/var/lib/kubernetes/kube-apiserver-kubelet-client.pem \\ <span class="hljs-comment"># ç”¨äºè®¿é—® kubelet çš„å®¢æˆ·ç«¯è¯ä¹¦</span><br>  --kubelet-client-key=/var/lib/kubernetes/kube-apiserver-kubelet-client-key.pem \\     <span class="hljs-comment"># ç”¨äºè®¿é—® kubelet çš„å®¢æˆ·ç«¯è¯ä¹¦çš„ç§é’¥</span><br>  --client-ca-file=/var/lib/kubernetes/cluster-root-ca.pem \\                           <span class="hljs-comment"># ç”¨äºéªŒè¯è®¿é—® kube-apiserver çš„å®¢æˆ·ç«¯çš„è¯ä¹¦çš„ CA æ ¹è¯ä¹¦</span><br>  --etcd-cafile=/var/lib/kubernetes/cluster-root-ca.pem \\                              <span class="hljs-comment"># ç”¨äºéªŒè¯ etcd æœåŠ¡å™¨è¯ä¹¦çš„ CA æ ¹è¯ä¹¦  </span><br>  --kubelet-certificate-authority=/var/lib/kubernetes/cluster-root-ca.pem \\            <span class="hljs-comment"># ç”¨äºéªŒè¯ kubelet æœåŠ¡å™¨è¯ä¹¦çš„ CA æ ¹è¯ä¹¦</span><br>  --service-account-key-file=/var/lib/kubernetes/service-account.pem \\                 <span class="hljs-comment"># ç”¨äºéªŒè¯ service account token çš„å…¬é’¥</span><br>  ...<br></code></pre></td></tr></table></figure><h2 id="é‡‡ç”¨-kubeconfig-è®¿é—®-kube-apiserver"><a href="#é‡‡ç”¨-kubeconfig-è®¿é—®-kube-apiserver" class="headerlink" title="é‡‡ç”¨ kubeconfig è®¿é—® kube-apiserver"></a>é‡‡ç”¨ kubeconfig è®¿é—® kube-apiserver</h2><p>Kubernetes ä¸­çš„å„ä¸ªç»„ä»¶ï¼ŒåŒ…æ‹¬kube-controller-manangerã€kube-schedulerã€kube-proxyã€kubeletç­‰ï¼Œé‡‡ç”¨ä¸€ä¸ªkubeconfig æ–‡ä»¶ä¸­é…ç½®çš„ä¿¡æ¯æ¥è®¿é—® kube-apiserverã€‚è¯¥æ–‡ä»¶ä¸­åŒ…å«äº† kube-apiserver çš„åœ°å€ï¼ŒéªŒè¯ kube-apiserver æœåŠ¡å™¨è¯ä¹¦çš„ CA è¯ä¹¦ï¼Œè‡ªå·±çš„å®¢æˆ·ç«¯è¯ä¹¦å’Œç§é’¥ç­‰è®¿é—®ä¿¡æ¯ã€‚</p><p>åœ¨ä¸€ä¸ªä½¿ç”¨ minikube å®‰è£…çš„é›†ç¾¤ä¸­ï¼Œç”Ÿæˆçš„ kubeconfig é…ç½®æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼Œè¿™å››ä¸ªæ–‡ä»¶åˆ†åˆ«ä¸º admin ç”¨æˆ·ï¼Œ kube-controller-manangerã€kubelet å’Œ kube-scheduler çš„kubeconfigé…ç½®æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ <span class="hljs-built_in">ls</span> /etc/kubernetes/<br>admin.conf  controller-manager.conf  kubelet.conf  scheduler.conf<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æ‰“å¼€ controller-manager.conf æ¥çœ‹ä¸€ä¸‹ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">clusters:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">cluster:</span> <br>    <span class="hljs-comment"># ç”¨äºéªŒè¯ kube-apiserver æœåŠ¡å™¨è¯ä¹¦çš„ CA æ ¹è¯ä¹¦ </span><br>    <span class="hljs-attr">certificate-authority-data:</span> <span class="hljs-string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM1ekNDQWMrZ0F3SUJBZ0lCQVRBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwdGFXNXAKYTNWaVpVTkJNQjRYRFRJd01ETXdOekF3TXpjeE1Wb1hEVE13TURNd05qQXdNemN4TVZvd0ZURVRNQkVHQTFVRQpBeE1LYldsdWFXdDFZbVZEUVRDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTTczCkdIMWxqNkxEUm1FLy9hQ2cvNUlmampKYy8zOGcyMVpITXJDMkx5RGVqZWhrdWUwZFB1WTJ0L2JjTjJYM1dGNEsKaWNzNmhhWnBDbFVxL3pteVRITWhhZnlmVVF5MDFJZmhDV2I5NXI4akpHZ2NyU3U3UUtXM3ZOd1Z1TmhJNmd6SApSWW45Ry82VHJKTjdOMWRjejNmMlU1OFRjUHVCQzZOUzVTc1JmemFSczVDZnd0UTNaa2czQUFVYTlQSDZFVmtDCkIvRGR1bXBialZGakMwSllOWlFVNTlGNUxDeHJ0bEYvOUJsSVhnZGw0ZlNCNzQ0ZW1UelcySEZQek9lTklYYnUKYTJPa0FFTDdJc3hSRTFBaEFKZ1h6cFNmdi9paDBuMEJpQ1VaV1hLZjg2UjZJL2xlK2docG51c21kTXUwbkNEUApHMm9laXhRTit5NzFQU2tGcGdzQ0F3RUFBYU5DTUVBd0RnWURWUjBQQVFIL0JBUURBZ0trTUIwR0ExVWRKUVFXCk1CUUdDQ3NHQVFVRkJ3TUNCZ2dyQmdFRkJRY0RBVEFQQmdOVkhSTUJBZjhFQlRBREFRSC9NQTBHQ1NxR1NJYjMKRFFFQkN3VUFBNElCQVFCaWpXYlpPNU9uaU9lNHRHUlQvRGFXaFBkY2ZwbE8vcVQ5WkFqU1hXZU41TStubExQZQpGV1NLRGRWU1NzajJ6UVdMU3A1Vjc3MkFoa2NYQlM0a2ZiY2ZCTUl2ejVsYXJZeHgxcnduTzZLbVZSTHdkNUNkCnRER2RjUjF0UzdqeTRSV05ISlAyNWZhZHB5TE9KVzJlZkdLRmRiSnZyRjljekV1ODR5a1drdThtVnNNa0RzTXkKbnVFNGtXblNvODgweFpxVG9QN01qM3hkRlNYYWdoNytwK3FMazk1VjhBNTRUNmRKa2VjSGg4SzdNYVRxdWVOVgpzOVhuZDA2WEJGQWFCVXRsSGZybmRXUzhmaTQ5dTY0NEFWOWJHclNYRnR1Q0lydnIxVkY2d0R3dEJYZi9UUStrCkx3Zk1oNVZDVWt1bEJqWEpqK1ZvRnBLZm5Qck9nbEExZzRtUgotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><br>    <span class="hljs-attr">server:</span> <span class="hljs-string">https://localhost:8443</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes</span><br><span class="hljs-attr">contexts:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">context:</span><br>    <span class="hljs-attr">cluster:</span> <span class="hljs-string">kubernetes</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">system:kube-controller-manager</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">system:kube-controller-manager@kubernetes</span><br><span class="hljs-attr">current-context:</span> <span class="hljs-string">system:kube-controller-manager@kubernetes</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Config</span><br><span class="hljs-attr">preferences:</span> &#123;&#125;<br><span class="hljs-attr">users:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">system:kube-controller-manager</span><br>  <span class="hljs-attr">user:</span><br>    <span class="hljs-comment"># ç”¨äºè®¿é—® kube-apiserver çš„å®¢æˆ·ç«¯è¯ä¹¦</span><br>    <span class="hljs-attr">client-certificate-data:</span> <span class="hljs-string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM1ekNDQWMrZ0F3SUJBZ0lJZVE4aDNXSlNmZEF3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2JXbHVhV3QxWW1WRFFUQWVGdzB5TURBek1EY3dNRE0zTVRGYUZ3MHlNVEExTVRrd05qVTNNemxhTUNreApKekFsQmdOVkJBTVRIbk41YzNSbGJUcHJkV0psTFdOdmJuUnliMnhzWlhJdGJXRnVZV2RsY2pDQ0FTSXdEUVlKCktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQU5DTzJpTEZzNGRTTW9sR2plN2tjY1VFbURDVjEvbWQKV1p1cS9DT0RvV1p2Uy80clNrOXNsaFQvektIVTVkVmg3SFV4TGNWU1RkQXZScGEwN3dXK3h2eWlDR3Y5UmMyVAp0bkFnUFFhQ2VkOC8zZlFpMzI1QmZCZVl4UjRTTm8raEM1b0ZYYkhpdC9OWWlQTVMvM1hFOGVCc0dEZCtjd1pzCnhNTDZzc0pJNzVOSmNXckV3eXlMbzIrb1JSRmJ2TlpJWFRZekJpRGd3QkZxNUkzZVA5QTl2d29rUG5STFBSdlYKQU9SV3hUZDMyblJLOTY1SU9uV25mNzY0bHhSeEV6bHIyS09rSzc5NlVJWTlyL0lYOWdGQjNqbGZFK1lBOE5VLwpuV2x3cElNL0ZpMk9hL1hjNnQzNUJHSnNXcTR4bHQ5RDdqS3V2bTNONmJlanJPOFZNODU5QU44Q0F3RUFBYU1uCk1DVXdEZ1lEVlIwUEFRSC9CQVFEQWdXZ01CTUdBMVVkSlFRTU1Bb0dDQ3NHQVFVRkJ3TUNNQTBHQ1NxR1NJYjMKRFFFQkN3VUFBNElCQVFCZVg4QmVuTlJoUTVWaVpMMjRxcWxIMjRlMDVyYWVVTFZJQlQzWE90cmdQcXF1WXRGWgptRG9naEpuSW05aVVMcHFTTUxHMlJrQ0RBMEk2Rit0SGVFVHRMRDlNdjA2N1huQ2VCclhkTFVTYzkwaHNZWm1KClNsVG11c21TZGUxUXJsRnFxQVRZY2VCVWgwM0lSbXZIL1BtS21va1FUZDZER0paVVVhM3ducEN6Nko4aGcySGwKWlZFaURKcHNoeXNBaVdCUWZBN01TRlFlb0poSjhUdHgzdEhNZDlaaHlmcVVHOVByUGJkMUlBQTIrRlVudXRsNwpoRmdZdTBxbG5aZFZCWE9JM1dvZndWZ2dDTEQrbFVCeGgzNVhLNStxYXhWNVlDTit0ZTNFeDJERHVmRW1UV0FoCkwwUVNTc0RTZGd0Vi9TNFhvV2xQcXU0Q2lRVnZydUg3WHkxMwotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><br>    <span class="hljs-comment"># å®¢æˆ·ç«¯è¯ä¹¦å¯¹åº”çš„ç§é’¥</span><br>    <span class="hljs-attr">client-key-data:</span> <span class="hljs-string">LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBMEk3YUlzV3poMUl5aVVhTjd1Unh4UVNZTUpYWCtaMVptNnI4STRPaFptOUwvaXRLClQyeVdGUC9Nb2RUbDFXSHNkVEV0eFZKTjBDOUdsclR2QmI3Ry9LSUlhLzFGelpPMmNDQTlCb0o1M3ovZDlDTGYKYmtGOEY1akZIaEkyajZFTG1nVmRzZUszODFpSTh4TC9kY1R4NEd3WU4zNXpCbXpFd3ZxeXdranZrMGx4YXNURApMSXVqYjZoRkVWdTgxa2hkTmpNR0lPREFFV3JramQ0LzBEMi9DaVErZEVzOUc5VUE1RmJGTjNmYWRFcjNya2c2CmRhZC92cmlYRkhFVE9XdllvNlFydjNwUWhqMnY4aGYyQVVIZU9WOFQ1Z0R3MVQrZGFYQ2tnejhXTFk1cjlkenEKM2ZrRVlteGFyakdXMzBQdU1xNitiYzNwdDZPczd4VXp6bjBBM3dJREFRQUJBb0lCQVFDRDVMT2pKZkJoZGVRcgoySWpPT1g2Um9GUTI5YXgrV2JwZnJnU0MyUzNyUUJ1SkJBdWNxd2xIQW5hQktjaW41NlBJZ1c5MnlKUVpRcXliCmhwVmF4c25FM3h3QVgwNFRzb1MvNkVOdnFIZzJiWWVLYTd0dFdOQ0hnNysxUXNOcWxlaG1ZVnBkc3dtdVJhRm0KUis5eXBUaHFPeklkZGtSOEhiRlp0WDN6VEhqbVpYaUhGdlIvMFhYK1BVbDR6SllSWjlCbVBnY2Ric2tSTldScgo0Qk8wUmlQQWRKVEo2VHZLMGhxT1g1UHo4ekl3S1ZzYjdyYndUdXArTGs4eWNCVUd3Q1N3RzEyanVNQW1kYkJJClZmdmlFK1VYRHRIQXdLWXlnMEhCVitJVlEvcVNwSVJ1WXQ4SmY1MWVKN1VEbHhiN3ZRTStEYVNsNjVaMVNyWUcKQU9UTGpPVkJBb0dCQU5PYzB0OG5ybmhUR3V0MGhMdVp6SWs4ekFranhYYWtiSURlZi9XeXlQdW94Z3J2ZGMzcwpsbHV0U3hSOFV4WGVuQjBLZFpnYnNoc1ozeW9GbEI0YThTMzI1UFRsYm9xOVB0TDRaOFBzczQ3L0l1bHYxTk10CnZzZjdKZ1FuaFRCVndkdjN6OXFpdml6bjB4Mk9CdURxdzNSYXcvWEhwRy9RczJ5WmF4S29GNW9SQW9HQkFQeE8KQVBDUXQ2Q2swOFF2WTE4VjFLQXA0d2h1YWEyMS9MeC9rZUZJSURRd0tZZnFHRGdBWUYvQzJUbC9xc29TMXAvTwpFcFVkVkRBNHVpblFVbnFhNGg0a0JOYjRXTFhrSXhRdXdjWHdJNjRMNWR3ZWJHalhxUWUwbnkxQkhkTmU2Z0dqClorbit4OUJLWnJmcEliYkQ2blpYUUREbS9jZWYyWU5NVWRqVWpudnZBb0dBQnlIMUZhSi94ZngvSHNxWm9yMG4KWU1UVTE4WUY1TjdiN1dnU2hoU1ZvNjNucHZ5MVN0Q2JyTkZsZzNaQlVxNWpNck5ralZENXF1SXZYSG85cU5vZApvUC8rYmFiQ0dCa1M0Z2VQYjlJdHB6ZEFWUC80KzNsQ1FmbGNLYTJ2VnBhOVp3MnVTdDlMYTdZUXJxRlg2QUxoCnZhMUZoNlpJQzZETU8yL2NaUStYWkJFQ2dZQnNGMHNGeFNvMlU0YzZISWM1SEZRc2plVnJIa3ArRm1LQnF6R24KVDB3a3I2R0xUZm8wTzgwT0daOFFxQ1pXVGozTzF1MVZIdXlMZ0RJWmFkdDhGVkRjVXRnVDlPK2tkV21sNHVZMwpVOHNsYklsOGhUZ3lybm9IQ0JYTndJRHpwazBnaUk0alRIajBQbnZGUE1hcDAwTm1rYmk1ZXF5czBrblFtMmpSCk9UY1Yxd0tCZ0RNUWZSVlNNNXlGcjVIalJ4UXcwRDdrUWhONDlLbngrMWs2bWRORWJ6VG9rQ1RRcWlSeUJQdGgKcjlqZk0rRXFZcnZ1elRmRVpiS1VBMEZac09yeStxMHpXb29mTURLajFGV3BaTXJBSmdxdDFlcWtFbVFrVi8vSApQMzF3ejZDa1RneDdJby9iZ09PbmhsbUplU3NHaXpqenV2TjFEcWtjNVR3M3oxUSs1dmxmCi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè®¿é—® kube-apiserver æ‰€éœ€è¦çš„ç›¸å…³è¯ä¹¦å†…å®¹å·²ç»è¢«é‡‡ç”¨ base64 ç¼–ç å†™å…¥äº†æ–‡ä»¶ä¸­ã€‚å…¶ä»–å‡ ä¸ªæ–‡ä»¶ä¸­çš„å†…å®¹ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œåªæ˜¯é…ç½®çš„ç”¨æˆ·åå’Œå®¢æˆ·ç«¯è¯ä¹¦æœ‰æ‰€ä¸åŒã€‚</p><p>åœ¨å¯åŠ¨è¿™äº›ç»„ä»¶æ—¶ï¼Œéœ€è¦åœ¨å‚æ•°ä¸­æŒ‡å‡º kubeconfig æ–‡ä»¶çš„è·¯å¾„ï¼Œä¾‹å¦‚ kube-controller-manager çš„å¯åŠ¨å‘½ä»¤å¦‚ä¸‹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">/usr/local/bin/kube-controller-manager \\<br>--kubeconfig=/etc/kubernetes/controller-manager.conf <br><span class="hljs-comment"># ä¸‹é¢å‡ ä¸ªè¯ä¹¦å’Œè®¿é—® kube-apiserver æ— å…³ï¼Œæˆ‘ä»¬ä¼šåœ¨åé¢ä»‹ç»åˆ°</span><br>--cluster-signing-cert-file=/var/lib/kubernetes/cluster-root-ca.pem             <span class="hljs-comment"># ç”¨äºç­¾å‘è¯ä¹¦çš„ CA æ ¹è¯ä¹¦</span><br>--cluster-signing-key-file=/var/lib/kubernetes/cluster-root-ca-key.pem          <span class="hljs-comment"># ç”¨äºç­¾å‘è¯ä¹¦çš„ CA æ ¹è¯ä¹¦çš„ç§é’¥  </span><br>--service-account-private-key-file=/var/lib/kubernetes/service-account-key.pem  <span class="hljs-comment"># ç”¨äºå¯¹ service account token è¿›è¡Œç­¾åçš„ç§é’¥</span><br>... <br></code></pre></td></tr></table></figure><h2 id="Service-Account-è¯ä¹¦"><a href="#Service-Account-è¯ä¹¦" class="headerlink" title="Service Account è¯ä¹¦"></a>Service Account è¯ä¹¦</h2><p>Kubernetes ä¸­æœ‰ä¸¤ç±»ç”¨æˆ·ï¼Œä¸€ç±»ä¸º user accountï¼Œä¸€ç±»ä¸º service accountã€‚ service account ä¸»è¦è¢« pod ç”¨äºè®¿é—® kube-apiserverã€‚ åœ¨ä¸ºä¸€ä¸ª pod æŒ‡å®šäº† service account åï¼Œkubernetes ä¼šä¸ºè¯¥ service account ç”Ÿæˆä¸€ä¸ª JWT tokenï¼Œå¹¶ä½¿ç”¨ secret å°†è¯¥ service account token åŠ è½½åˆ° pod ä¸Šã€‚pod ä¸­çš„åº”ç”¨å¯ä»¥ä½¿ç”¨ service account token æ¥è®¿é—® api serverã€‚service account è¯ä¹¦è¢«ç”¨äºç”Ÿæˆå’ŒéªŒè¯ service account tokenã€‚è¯¥è¯ä¹¦çš„ç”¨æ³•å’Œå‰é¢ä»‹ç»çš„å…¶ä»–è¯ä¹¦ä¸åŒï¼Œå› ä¸ºå®é™…ä¸Šä½¿ç”¨çš„æ˜¯å…¶å…¬é’¥å’Œç§é’¥ï¼Œè€Œå¹¶ä¸éœ€è¦å¯¹è¯ä¹¦è¿›è¡ŒéªŒè¯ã€‚</p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° service account è¯ä¹¦çš„å…¬é’¥å’Œç§é’¥åˆ†åˆ«è¢«é…ç½®åˆ°äº† kube-apiserver å’Œ kube-controller-manager çš„å‘½ä»¤è¡Œå‚æ•°ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">/usr/local/bin/kube-apiserver \\ <br>  --service-account-key-file=/var/lib/kubernetes/service-account.pem \\          <span class="hljs-comment"># ç”¨äºéªŒè¯ service account token çš„å…¬é’¥</span><br>  ...<br>  <br> /usr/local/bin/kube-controller-manager \\<br> --service-account-private-key-file=/var/lib/kubernetes/service-account-key.pem  <span class="hljs-comment"># ç”¨äºå¯¹ service account token è¿›è¡Œç­¾åçš„ç§é’¥</span><br> ... <br></code></pre></td></tr></table></figure><p>ä¸‹å›¾å±•ç¤ºäº† kubernetes ä¸­ç”Ÿæˆã€ä½¿ç”¨å’ŒéªŒè¯ service account token çš„è¿‡ç¨‹ã€‚</p><p><img src="/2025/03/30/k8s%E8%AF%81%E4%B9%A6/service-account-token.png" alt="img"></p><h3 id="è®¤è¯æ–¹æ³•ï¼šå®¢æˆ·ç«¯è¯ä¹¦è¿˜æ˜¯-token-ï¼Ÿ"><a href="#è®¤è¯æ–¹æ³•ï¼šå®¢æˆ·ç«¯è¯ä¹¦è¿˜æ˜¯-token-ï¼Ÿ" class="headerlink" title="è®¤è¯æ–¹æ³•ï¼šå®¢æˆ·ç«¯è¯ä¹¦è¿˜æ˜¯ token ï¼Ÿ"></a>è®¤è¯æ–¹æ³•ï¼šå®¢æˆ·ç«¯è¯ä¹¦è¿˜æ˜¯ token ï¼Ÿ</h3><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒKubernetes æä¾›äº†ä¸¤ç§å®¢æˆ·ç«¯è®¤è¯çš„æ–¹æ³•ï¼Œæ§åˆ¶é¢ç»„ä»¶é‡‡ç”¨çš„æ˜¯å®¢æˆ·ç«¯æ•°å­—è¯ä¹¦;è€Œåœ¨é›†ç¾¤ä¸­éƒ¨ç½²çš„åº”ç”¨åˆ™é‡‡ç”¨äº† service account token çš„æ–¹å¼ã€‚ä¸ºä»€ä¹ˆ Kubernetes ä¸ä¸º service account ä¹Ÿç”Ÿæˆä¸€ä¸ªè¯ä¹¦ï¼Œå¹¶é‡‡ç”¨è¯¥è¯ä¹¦è¿›è¡Œèº«ä»½è®¤è¯å‘¢ï¼Ÿ å®é™…ä¸Š Istio å°±æ˜¯è¿™æ ·åšçš„ï¼ŒIstio ä¼šè‡ªåŠ¨ä¸ºæ¯ä¸ª service account ç”Ÿæˆä¸€ä¸ªè¯ä¹¦ï¼Œå¹¶ä½¿ç”¨è¯¥è¯ä¹¦æ¥åœ¨ pod ä¸­çš„åº”ç”¨ä¹‹é—´å»ºç«‹åŒå‘ tls è®¤è¯ã€‚æˆ‘æ²¡æœ‰æ‰¾åˆ° Kubernetes è¿™ä¸ªè®¾è®¡å†³ç­–çš„ç›¸å…³è¯´æ˜ï¼Œå¦‚æœä½ çŸ¥é“åŸå› æˆ–å¯¹æ­¤æœ‰è‡ªå·±çš„è§è§£ï¼Œæ¬¢è¿è”ç³»æˆ‘è¿›è¡Œæ¢è®¨ã€‚</p><h2 id="Kubernetes-è¯ä¹¦ç­¾å‘"><a href="#Kubernetes-è¯ä¹¦ç­¾å‘" class="headerlink" title="Kubernetes è¯ä¹¦ç­¾å‘"></a>Kubernetes è¯ä¹¦ç­¾å‘</h2><p>Kubernetes æä¾›äº†ä¸€ä¸ª <code>certificates.k8s.io</code> APIï¼Œå¯ä»¥ä½¿ç”¨é…ç½®çš„ CA æ ¹è¯ä¹¦æ¥ç­¾å‘ç”¨æˆ·è¯ä¹¦ã€‚è¯¥ API ç”± kube-controller-manager å®ç°ï¼Œå…¶ç­¾å‘è¯ä¹¦ä½¿ç”¨çš„æ ¹è¯ä¹¦åœ¨ä¸‹é¢çš„å‘½ä»¤è¡Œä¸­è¿›è¡Œé…ç½®ã€‚æˆ‘ä»¬å¸Œæœ› Kubernetes é‡‡ç”¨é›†ç¾¤æ ¹ CA æ¥ç­¾å‘ç”¨æˆ·è¯ä¹¦ï¼Œå› æ­¤åœ¨ kube-controller-manager çš„å‘½ä»¤è¡Œå‚æ•°ä¸­å°†ç›¸å…³å‚æ•°é…ç½®ä¸ºäº†é›†ç¾¤æ ¹ CAã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">/usr/local/bin/kube-controller-manager \\<br>--cluster-signing-cert-file=/var/lib/kubernetes/cluster-root-ca.pem             <span class="hljs-comment"># ç”¨äºç­¾å‘è¯ä¹¦çš„ CA æ ¹è¯ä¹¦</span><br>--cluster-signing-key-file=/var/lib/kubernetes/cluster-root-ca-key.pem          <span class="hljs-comment"># ç”¨äºç­¾å‘è¯ä¹¦çš„ CA æ ¹è¯ä¹¦çš„ç§é’¥  </span><br>... <br></code></pre></td></tr></table></figure><p>å…³äºæ›´å¤š Kubernetes è¯ä¹¦ç­¾å‘ API çš„å†…å®¹ï¼Œå¯ä»¥å‚è§ <a href="https://kubernetes.io/zh/docs/tasks/tls/managing-tls-in-a-cluster/">ç®¡ç†é›†ç¾¤ä¸­çš„ TLS è®¤è¯</a>ã€‚</p><h2 id="ä½¿ç”¨-TLS-bootstrapping-ç®€åŒ–-Kubelet-è¯ä¹¦åˆ¶ä½œ"><a href="#ä½¿ç”¨-TLS-bootstrapping-ç®€åŒ–-Kubelet-è¯ä¹¦åˆ¶ä½œ" class="headerlink" title="ä½¿ç”¨ TLS bootstrapping ç®€åŒ– Kubelet è¯ä¹¦åˆ¶ä½œ"></a>ä½¿ç”¨ TLS bootstrapping ç®€åŒ– Kubelet è¯ä¹¦åˆ¶ä½œ</h2><p>åœ¨å®‰è£… Kubernetes æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæ¯ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šçš„ Kubelet åˆ†åˆ«ç”Ÿæˆä¸€ä¸ªè¯ä¹¦ã€‚ç”±äºå·¥ä½œèŠ‚ç‚¹å¯èƒ½å¾ˆå¤šï¼Œæ‰‹åŠ¨ç”Ÿæˆ Kubelet è¯ä¹¦çš„è¿‡ç¨‹ä¼šæ¯”è¾ƒç¹çã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒKubernetes æä¾›äº† <a href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/">TLS bootstrapping </a>çš„æ–¹å¼æ¥ç®€åŒ– Kubelet è¯ä¹¦çš„ç”Ÿæˆè¿‡ç¨‹ã€‚å…¶åŸç†æ˜¯é¢„å…ˆæä¾›ä¸€ä¸ª bootstrapping tokenï¼Œkubelet é‡‡ç”¨è¯¥ bootstrapping token è¿›è¡Œå®¢æˆ·ç«¯éªŒè¯ï¼Œè°ƒç”¨ kube-apiserver çš„è¯ä¹¦ç­¾å‘ API æ¥ç”Ÿæˆ è‡ªå·±éœ€è¦çš„è¯ä¹¦ã€‚è¦å¯ç”¨è¯¥åŠŸèƒ½ï¼Œéœ€è¦åœ¨ kube-apiserver ä¸­å¯ç”¨ <code>--enable-bootstrap-token-auth</code> ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª kubelet è®¿é—® kube-apiserver ä½¿ç”¨çš„ bootstrap token secretã€‚å¦‚æœä½¿ç”¨ kubeadmin å®‰è£…ï¼Œå¯ä»¥ä½¿ç”¨ <code>kubeadm token create</code>å‘½ä»¤æ¥åˆ›å»º tokenã€‚</p><p>é‡‡ç”¨TLS bootstrapping ç”Ÿæˆè¯ä¹¦çš„æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>è°ƒç”¨ kube-apiserver ç”Ÿæˆä¸€ä¸ª bootstrap tokenã€‚</li><li>å°†è¯¥ bootstrap token å†™å…¥åˆ°ä¸€ä¸ª kubeconfig æ–‡ä»¶ä¸­ï¼Œä½œä¸º kubelet è°ƒç”¨ kube-apiserver çš„å®¢æˆ·ç«¯éªŒè¯æ–¹å¼ã€‚</li><li>é€šè¿‡ <code>--bootstrap-kubeconfig</code> å¯åŠ¨å‚æ•°å°† bootstrap token ä¼ é€’ç»™ kubelet è¿›ç¨‹ã€‚</li><li>Kubelet é‡‡ç”¨bootstrap token è°ƒç”¨ kube-apiserver APIï¼Œç”Ÿæˆè‡ªå·±æ‰€éœ€çš„æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯è¯ä¹¦ã€‚</li><li>è¯ä¹¦ç”Ÿæˆåï¼ŒKubelet é‡‡ç”¨ç”Ÿæˆçš„è¯ä¹¦å’Œ kube-apiserver è¿›è¡Œé€šä¿¡ï¼Œå¹¶åˆ é™¤æœ¬åœ°çš„ kubeconfig æ–‡ä»¶ï¼Œä»¥é¿å… bootstrap token æ³„æ¼é£é™©ã€‚</li></ol><h1 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h1><p>Kubernetes ä¸­ä½¿ç”¨äº†å¤§é‡çš„è¯ä¹¦æ¥ç¡®ä¿é›†ç¾¤çš„å®‰å…¨ï¼Œå¼„æ¸…æ¥šè¿™äº›è¯ä¹¦çš„ç”¨é€”å’Œé…ç½®æ–¹æ³•å°†æœ‰åŠ©äºæˆ‘ä»¬æ·±å…¥ç†è§£ kubernetes çš„å®‰è£…è¿‡ç¨‹å’Œç»„ä»¶çš„é…ç½®ã€‚æœ¬æ–‡æ˜¯ç¬”è€…åœ¨å­¦ä¹  è¿‡ç¨‹ä¸­æ•´ç†çš„ Kubernetes é›†ç¾¤ä¸­ä¸»è¦ä½¿ç”¨åˆ°çš„è¯ä¹¦ï¼Œç”±äºç¬”è€…å¯¹ Kubernetes çš„ç†è§£æœ‰é™ï¼Œæ–‡ç« ä¸­éš¾å…å­˜åœ¨éƒ¨åˆ†é”™è¯¯ï¼Œæ¬¢è¿æŒ‡æ­£ã€‚</p><h1 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h1><ul><li><a href="https://kubernetes.io/zh/docs/setup/best-practices/certificates/">Kubernetes PKI è¯ä¹¦å’Œè¦æ±‚</a></li><li><a href="https://github.com/kelseyhightower/kubernetes-the-hard-wa">kubernetes the hard way</a></li><li><a href="https://blog.51cto.com/13210651/2361208">Kubernetes ä¹‹ äºŒè¿›åˆ¶å®‰è£…(äºŒ) è¯ä¹¦è¯¦è§£</a></li><li><a href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/">TLS bootstrapping</a></li><li><a href="https://zhaohuabing.com/post/2020-03-19-pki/">æ•°å­—è¯ä¹¦åŸç†</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>k8s</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>k8s-é€‰ä¸»-å®æˆ˜éªŒè¯</title>
    <link href="/2025/03/27/k8s-%E9%80%89%E4%B8%BB-%E5%AE%9E%E6%88%98%E9%AA%8C%E8%AF%81/"/>
    <url>/2025/03/27/k8s-%E9%80%89%E4%B8%BB-%E5%AE%9E%E6%88%98%E9%AA%8C%E8%AF%81/</url>
    
    <content type="html"><![CDATA[<h1 id="k8s-é€‰ä¸»-å®æˆ˜éªŒè¯"><a href="#k8s-é€‰ä¸»-å®æˆ˜éªŒè¯" class="headerlink" title="k8s-é€‰ä¸»-å®æˆ˜éªŒè¯"></a>k8s-é€‰ä¸»-å®æˆ˜éªŒè¯</h1><p>è½¬è‡ªï¼š<a href="https://blog.csdn.net/boling_cavalry/article/details/132129123">https://blog.csdn.net/boling_cavalry/article/details/132129123</a></p><h4 id="æœ¬ç¯‡æ¦‚è§ˆ"><a href="#æœ¬ç¯‡æ¦‚è§ˆ" class="headerlink" title="æœ¬ç¯‡æ¦‚è§ˆ"></a>æœ¬ç¯‡æ¦‚è§ˆ</h4><p>â€¢æœ¬æ–‡æ˜¯ã€Šclient-goå®æˆ˜ã€‹ç³»åˆ—çš„ç¬¬åäºŒç¯‡ï¼Œåˆæœ‰ä¸€ä¸ªç²¾å½©çš„çŸ¥è¯†ç‚¹åœ¨æœ¬ç« å‘ˆç°ï¼šé€‰ä¸»(leader-election)â€¢åœ¨è§£é‡Šä»€ä¹ˆæ˜¯é€‰ä¸»ä¹‹å‰ï¼Œå’±ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªåœºæ™¯ï¼ˆæœ‰çœŸå®é€‚ç”¨åœºæ™¯çš„æŠ€æœ¯ï¼Œå­¦èµ·æ¥æ‰æœ‰åŠ¨åŠ›ï¼‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆç¨åæœ‰è¯¦ç»†è¯´æ˜ï¼‰</p><p><img src="/2025/03/27/k8s-%E9%80%89%E4%B8%BB-%E5%AE%9E%E6%88%98%E9%AA%8C%E8%AF%81/230a3f9ae9a956d7d112c28c02a38ff4.png" alt="Image 32: åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ä¸Šå›¾æ‰€æè¿°çš„ä¸šåŠ¡åœºæ™¯æ˜¯ä¸ªæ™®é€šçš„controlleråº”ç”¨ï¼š</p><p>1.å³ä¾§æ˜¯äººå·¥æ“ä½œï¼Œé€šè¿‡kubectlå‘½ä»¤ä¿®æ”¹äº†serviceèµ„æº2.å·¦ä¾§çš„ä¸šåŠ¡åº”ç”¨è®¢é˜…äº†serviceçš„å˜åŒ–ï¼Œåœ¨æ”¶åˆ°serviceå˜æ›´çš„äº‹ä»¶åï¼Œå¯¹podè¿›è¡Œå†™æ“ä½œï¼ˆä¾‹å¦‚å°†æ”¶åˆ°äº‹ä»¶çš„æ—¶é—´å†™å…¥podçš„labelï¼‰</p><p>â€¢ä»¥ä¸Šçš„ä¸šåŠ¡åº”ç”¨å°±æ˜¯ä¸ªå¾ˆæ™®é€šçš„controllerï¼Œå¾ˆç®€å•ï¼Œè¿è¡Œèµ·æ¥ä¹Ÿæ²¡å•¥é—®é¢˜ï¼Œä½†æ˜¯ï¼Œå¦‚æœè¿™ä¸ªä¸šåŠ¡åº”ç”¨æœ‰å¤šä¸ªå®ä¾‹å‘¢ï¼Ÿ</p><h4 id="å¤šå®ä¾‹çš„é—®é¢˜"><a href="#å¤šå®ä¾‹çš„é—®é¢˜" class="headerlink" title="å¤šå®ä¾‹çš„é—®é¢˜"></a>å¤šå®ä¾‹çš„é—®é¢˜</h4><p>â€¢æ‰€è°“å¤šä¸ªå®ä¾‹ï¼Œå°±æ˜¯åŒæ ·çš„ä¸šåŠ¡åº”ç”¨æˆ‘ä»¬è¿è¡Œäº†å¤šä¸ªè¿›ç¨‹ï¼ˆä¾‹å¦‚ä¸‰ä¸ªï¼‰ï¼Œä¸ºä»€ä¹ˆå¤šä¸ªè¿›ç¨‹ï¼ŸåŒä¸€ä¸ªåº”ç”¨è¿è¡Œå¤šä¸ªè¿›ç¨‹ä¸æ˜¯å¾ˆæ­£å¸¸ä¹ˆï¼Ÿæ¨ªå‘æ‰©å®¹ä¸å°±æ˜¯å¤šè¿›ç¨‹å˜›â€¢å¤šä¸ªè¿›ç¨‹è¿è¡Œçš„æ—¶å€™ï¼Œå¦‚æœserviceå‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆæ¯ä¸ªè¿›ç¨‹éƒ½ä¼šå»ä¿®æ”¹podçš„labelï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼ˆåªè¦ä¿®æ”¹ä¸€æ¬¡å°±è¡Œäº†ï¼‰â€¢æ‰€ä»¥ï¼Œå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿä¸‰ä¸ªè¿›ç¨‹éƒ½æ˜¯åŒä¸€å¥—ä»£ç ï¼Œéƒ½ä¼šè®¢é˜…serviceçš„å˜åŒ–ï¼Œä½†æ˜¯æœ€ç»ˆåªä¿®æ”¹ä¸€æ¬¡podâ€¢ç»éªŒä¸°å¯Œçš„æ‚¨åº”è¯¥ä¼šæƒ³åˆ°åˆ†å¸ƒå¼é”ï¼Œä¸‰ä¸ªè¿›ç¨‹å»æŠ¢åˆ†å¸ƒå¼é”ï¼ŒæŠ¢åˆ°çš„è´Ÿè´£æ›´æ–°ï¼Œæ²¡é”™ï¼Œè¿™æ˜¯ä¸€ä¸ªæ­£ç¡®çš„è§£æ³•â€¢ä½†æ˜¯ï¼Œåˆ†å¸ƒå¼é”éœ€è¦å¼•å…¥ç›¸å…³ç»„ä»¶å§ï¼Œredisçš„setnxï¼Œæˆ–è€…mysqlçš„ä¹è§‚é”ï¼Œè¿™æ ·å°±éœ€è¦ç»´æŠ¤æ–°çš„ç»„ä»¶äº†â€¢å…¶å®è¿™åœ¨kubernetesæ˜¯ä¸ªå¾ˆå…¸å‹çš„é—®é¢˜ï¼Œæ¯•ç«Ÿpodå¤šå®ä¾‹åœ¨kubernetesæ˜¯å¸¸æ€äº†ï¼Œæ‰€ä»¥å½“ç„¶ä¹Ÿæœ‰å®˜æ–¹çš„è§£æ³•ï¼Œé¡µå°±æ˜¯æœ¬æ–‡çš„ä¸»é¢˜ï¼šé€‰ä¸»(leader-election)</p><h4 id="é€‰ä¸»-leader-election"><a href="#é€‰ä¸»-leader-election" class="headerlink" title="é€‰ä¸»(leader-election)"></a>é€‰ä¸»(leader-election)</h4><p>â€¢è¯´åˆ°è¿™é‡Œæ‚¨åº”è¯¥èƒ½ç†è§£é€‰ä¸»çš„å«ä¹‰äº†ï¼šå¤šä¸ªè¿›ç¨‹ç«äº‰æŸä¸ªkeyçš„leaderï¼Œå’±ä»¬å¯ä»¥æŠŠç‰¹å®šçš„ä»£ç æ”¾åœ¨ç«äº‰æˆåŠŸåå†æ‰§è¡Œï¼Œç”±äºåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªè¿›ç¨‹å¯ä»¥ç«äº‰æˆåŠŸï¼Œè¿™å°±ç›¸å½“äºåœ¨ä¸å¼•å…¥é¢å¤–ç»„ä»¶çš„æƒ…å†µä¸‹ï¼Œåªç”¨client-goå°±å®ç°äº†åˆ†å¸ƒå¼é”â€¢ç”±äºé€‰ä¸»åªæ˜¯ä¸ªç‰¹å®šçš„å°çŸ¥è¯†ç‚¹ï¼Œæœ¬ç¯‡å°±æ²¡ä»€ä¹ˆå¤šä½™çš„ç†è®ºè¦ç ”ç©¶äº†ï¼Œæ¥ä¸‹æ¥ç›´æ¥å¼€å§‹å®æˆ˜ï¼Œç¼–ç å®ç°ä¸€ä¸ªåŠŸèƒ½æ¥è¯´æ˜é€‰ä¸»çš„ç”¨æ³•â€¢å®æˆ˜çš„ä¸šåŠ¡éœ€æ±‚å¦‚ä¸‹</p><p>1.å¼€å‘ä¸€ä¸ªåº”ç”¨ï¼Œè¯¥åº”ç”¨åŒæ—¶è¿è¡Œå¤šä¸ªè¿›ç¨‹2.å½“kubernetesçš„æŒ‡å®šnamespaceä¸‹çš„serviceå‘ç”Ÿå˜åŒ–æ—¶ï¼Œåœ¨podçš„labelä¸­è®°å½•è¿™ä¸ªserviceçš„å˜åŒ–æ—¶é—´3.æ¯æ¬¡serivceå˜åŒ–ï¼Œpodçš„labelåªèƒ½ä¿®æ”¹ä¸€æ¬¡ï¼ˆå°½ç®¡æ­¤æ—¶æœ‰å¤šä¸ªè¿›ç¨‹ï¼‰</p><p>â€¢è®©æˆ‘ä»¬å°‘äº›å¥—è·¯ï¼Œå¤šä¸€ç‚¹çœŸè¯šï¼Œä¸è¯´åºŸè¯ï¼Œç›´æ¥å¼€å§‹åŠ¨æ‰‹å®æˆ˜å§</p><h4 id="æºç ä¸‹è½½"><a href="#æºç ä¸‹è½½" class="headerlink" title="æºç ä¸‹è½½"></a>æºç ä¸‹è½½</h4><p>â€¢å¦‚æœæ‚¨ä¸æƒ³ç¼–å†™ä»£ç ï¼Œä¹Ÿå¯ä»¥ä»GitHubä¸Šç›´æ¥ä¸‹è½½ï¼Œåœ°å€å’Œé“¾æ¥ä¿¡æ¯å¦‚ä¸‹è¡¨æ‰€ç¤º(<a href="https://github.com/zq2599/blog/_demos)%EF%BC%9A">https://github.com/zq2599/blog\_demos)ï¼š</a></p><table><thead><tr><th>åç§°</th><th>é“¾æ¥</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>é¡¹ç›®ä¸»é¡µ</td><td><a href="https://github.com/zq2599/blog/_demos">https://github.com/zq2599/blog\_demos</a></td><td>è¯¥é¡¹ç›®åœ¨GitHubä¸Šçš„ä¸»é¡µ</td></tr><tr><td>gitä»“åº“åœ°å€(https)</td><td><a href="https://github.com/zq2599/blog/_demos.git">https://github.com/zq2599/blog\_demos.git</a></td><td>è¯¥é¡¹ç›®æºç çš„ä»“åº“åœ°å€ï¼Œhttpsåè®®</td></tr><tr><td>gitä»“åº“åœ°å€(ssh)</td><td><a href="mailto:&#x67;&#105;&#x74;&#x40;&#103;&#x69;&#116;&#104;&#117;&#98;&#46;&#99;&#x6f;&#x6d;">&#x67;&#105;&#x74;&#x40;&#103;&#x69;&#116;&#104;&#117;&#98;&#46;&#99;&#x6f;&#x6d;</a>:zq2599&#x2F;blog_demos.git</td><td>è¯¥é¡¹ç›®æºç çš„ä»“åº“åœ°å€ï¼Œsshåè®®</td></tr></tbody></table><p>â€¢è¿™ä¸ªgité¡¹ç›®ä¸­æœ‰å¤šä¸ªæ–‡ä»¶å¤¹ï¼Œæœ¬ç¯‡çš„æºç åœ¨leader-tutorialsæ–‡ä»¶å¤¹ä¸‹ï¼Œå¦‚ä¸‹å›¾é»„æ¡†æ‰€ç¤ºï¼š</p><p><img src="/2025/03/27/k8s-%E9%80%89%E4%B8%BB-%E5%AE%9E%E6%88%98%E9%AA%8C%E8%AF%81/fc33e0f2da6fec4b7043fc97415dd155.png" alt="Image 33: åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><h4 id="æå‰äº†è§£é€‰ä¸»çš„ä»£ç "><a href="#æå‰äº†è§£é€‰ä¸»çš„ä»£ç " class="headerlink" title="æå‰äº†è§£é€‰ä¸»çš„ä»£ç "></a>æå‰äº†è§£é€‰ä¸»çš„ä»£ç </h4><p>â€¢æ¥ä¸‹æ¥ä¼šå¼€å‘ä¸€ä¸ªå®Œæ•´çš„controlleråº”ç”¨ï¼Œä»¥æ­¤æ¥è¯´æ˜é€‰ä¸»åŠŸèƒ½â€¢å¦‚æœæ‚¨è§‰å¾—å®Œæ•´åº”ç”¨çš„ä»£ç å¤ªå¤šï¼Œæ‡’å¾—çœ‹ï¼Œåªæƒ³äº†è§£é€‰ä¸»éƒ¨åˆ†ï¼Œé‚£å°±åœ¨æ­¤æå‰å°†æ•´ä¸ªå·¥ç¨‹ä¸­é€‰ä¸»ç›¸å…³çš„ä»£ç è´´å‡ºæ¥â€¢æ ¸å¿ƒä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼Œå…ˆåˆ›å»ºé”å¯¹è±¡ï¼Œå°±åƒåˆ†å¸ƒå¼é”ä¸€æ ·ï¼Œæ€»è¦æœ‰ä¸ªkeyï¼Œç„¶åæ‰§è¡Œleaderelection.RunOrDieæ–¹æ³•å‚ä¸é€‰ä¸»ï¼Œä¸€æ—¦æœ‰äº†ç»“æœï¼ŒOnNewLeaderæ–¹æ³•ä¼šè¢«å›è°ƒï¼Œè¿™æ—¶å€™é€šè¿‡è‡ªèº«idå’Œleaderçš„idæ¯”è¾ƒå°±çŸ¥é“æ˜¯ä¸æ˜¯è‡ªå·±äº†ï¼Œå¦å¤–ï¼Œå½“OnStartedLeadingè¢«æ‰§è¡Œçš„æ—¶å€™ï¼Œå°±æ„å‘³ç€å½“å‰è¿›ç¨‹å°±æ˜¯leaderï¼Œå¹¶ä¸”å¯ä»¥ç«‹å³å¼€å§‹æ‰§è¡Œåªæœ‰leaderæ‰èƒ½åšçš„äº‹æƒ…äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// startLeaderElection é€‰ä¸»çš„æ ¸å¿ƒé€»è¾‘ä»£ç </span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">startLeaderElection</span><span class="hljs-params">(ctx context.Context, clientset *kubernetes.Clientset, stop <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)</span></span> &#123;<br>    klog.Infof(<span class="hljs-string">&quot;[%s]åˆ›å»ºé€‰ä¸»æ‰€éœ€çš„é”å¯¹è±¡&quot;</span>, processIndentify)<br>    <span class="hljs-comment">// åˆ›å»ºé”å¯¹è±¡</span><br>    lock := &amp;resourcelock.LeaseLock&#123;<br>        LeaseMeta: metav1.ObjectMeta&#123;<br>            Name:      <span class="hljs-string">&quot;leader-tutorials&quot;</span>,<br>            Namespace: NAMESPACE,<br>        &#125;,<br>        Client: clientset.CoordinationV1(),<br>        LockConfig: resourcelock.ResourceLockConfig&#123;<br>            Identity: processIndentify,<br>        &#125;,<br>    &#125;<br>    klog.Infof(<span class="hljs-string">&quot;[%s]å¼€å§‹é€‰ä¸»&quot;</span>, processIndentify)<br>    <span class="hljs-comment">// å¯åŠ¨é€‰ä¸»æ“ä½œ</span><br>    leaderelection.RunOrDie(ctx, leaderelection.LeaderElectionConfig&#123;<br>        Lock:            lock,<br>        ReleaseOnCancel: <span class="hljs-literal">true</span>,<br>        LeaseDuration:   <span class="hljs-number">10</span> * time.Second,<br>        RenewDeadline:   <span class="hljs-number">5</span> * time.Second,<br>        RetryPeriod:     <span class="hljs-number">2</span> * time.Second,<br>        Callbacks: leaderelection.LeaderCallbacks&#123;<br>            OnStartedLeading: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context)</span></span> &#123;<br>                klog.Infof(<span class="hljs-string">&quot;[%s]å½“å‰è¿›ç¨‹æ˜¯leaderï¼Œåªæœ‰leaderæ‰èƒ½æ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘ç«‹å³å¼€å§‹&quot;</span>, processIndentify)<br>                <span class="hljs-comment">// åœ¨è¿™é‡Œå†™å…¥é€‰ä¸»æˆåŠŸçš„ä»£ç ï¼Œ</span><br>                <span class="hljs-comment">// å°±åƒæŠ¢åˆ†å¸ƒå¼é”ä¸€æ ·ï¼Œå½“å‰è¿›ç¨‹é€‰ä¸¾æˆåŠŸçš„æ—¶å€™ï¼Œè¿™çš„ä»£ç å°±ä¼šè¢«æ‰§è¡Œï¼Œ</span><br>                <span class="hljs-comment">// æ‰€ä»¥ï¼Œåœ¨è¿™é‡Œå¡«å†™æŠ¢é”æˆåŠŸçš„ä¸šåŠ¡é€»è¾‘å§ï¼Œæœ¬ä¾‹ä¸­å°±æ˜¯ç›‘å¬serviceå˜åŒ–ï¼Œç„¶åä¿®æ”¹podçš„label</span><br>                CreateAndStartController(ctx, clientset, &amp;v1.Service&#123;&#125;, <span class="hljs-string">&quot;services&quot;</span>, NAMESPACE, stop)<br>            &#125;,<br>            OnStoppedLeading: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>                <span class="hljs-comment">// å¤±å»äº†leaderæ—¶çš„é€»è¾‘</span><br>                klog.Infof(<span class="hljs-string">&quot;[%s]å¤±å»leaderèº«ä»½ï¼Œä¸å†æ˜¯leaderäº†&quot;</span>, processIndentify)<br>                os.Exit(<span class="hljs-number">0</span>)<br>            &#125;,<br>            OnNewLeader: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(identity <span class="hljs-type">string</span>)</span></span> &#123;<br>                <span class="hljs-comment">// æ”¶åˆ°é€šçŸ¥ï¼ŒçŸ¥é“æœ€ç»ˆçš„é€‰ä¸¾ç»“æœ</span><br>                <span class="hljs-keyword">if</span> identity == processIndentify &#123;<br>                    klog.Infof(<span class="hljs-string">&quot;[%s]é€‰ä¸»ç»“æœå‡ºæ¥äº†ï¼Œå½“å‰è¿›ç¨‹å°±æ˜¯leader&quot;</span>, processIndentify)<br>                    <span class="hljs-comment">// I just got the lock</span><br>                    <span class="hljs-keyword">return</span><br>                &#125;<br>                klog.Infof(<span class="hljs-string">&quot;[%s]é€‰ä¸»ç»“æœå‡ºæ¥äº†ï¼Œleaderæ˜¯ : [%s]&quot;</span>, processIndentify, identity)<br>            &#125;,<br>        &#125;,<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å®æˆ˜ï¼šéƒ¨ç½²serviceå’Œdeployment"><a href="#å®æˆ˜ï¼šéƒ¨ç½²serviceå’Œdeployment" class="headerlink" title="å®æˆ˜ï¼šéƒ¨ç½²serviceå’Œdeployment"></a>å®æˆ˜ï¼šéƒ¨ç½²serviceå’Œdeployment</h4><p>â€¢é¦–å…ˆè¯·å‡†å¤‡å¥½k8sç¯å¢ƒï¼Œè¿™åœ¨ã€Šclient-goå®æˆ˜ä¹‹å…­:æ—¶éš”ä¸¤å¹´ï¼Œåˆ·æ–°ç‰ˆæœ¬ç»§ç»­å®æˆ˜ã€‹é‡Œé¢å·²æœ‰è¯¦ç»†è¯´æ˜â€¢ç„¶åæŠŠæœ¬æ¬¡å®æˆ˜æ‰€éœ€çš„serviceå’Œdeploymentéƒ¨ç½²å¥½ï¼Œ- æ‰€æœ‰è¦éƒ¨ç½²çš„å†…å®¹æˆ‘éƒ½é›†ä¸­åœ¨è¿™ä¸ªåä¸ºnginx-deployment-service.yamlè„šæœ¬ä¸­äº†</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">client-go-tutorials</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-deployment</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-app</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">front-end</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-app</span><br>      <span class="hljs-attr">type:</span> <span class="hljs-string">front-end</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-app</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">front-end</span><br>        <span class="hljs-comment"># è¿™æ˜¯ç¬¬ä¸€ä¸ªä¸šåŠ¡è‡ªå®šä¹‰labelï¼ŒæŒ‡å®šäº†mysqlçš„è¯­è¨€ç±»å‹æ˜¯cè¯­è¨€</span><br>        <span class="hljs-attr">language:</span> <span class="hljs-string">c</span><br>        <span class="hljs-comment"># è¿™æ˜¯ç¬¬äºŒä¸ªä¸šåŠ¡è‡ªå®šä¹‰labelï¼ŒæŒ‡å®šäº†è¿™ä¸ªpodå±äºå“ªä¸€ç±»æœåŠ¡ï¼Œnginxå±äºwebç±»</span><br>        <span class="hljs-attr">business-service-type:</span> <span class="hljs-string">web</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-container</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:latest</span><br>          <span class="hljs-attr">resources:</span><br>            <span class="hljs-attr">limits:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;0.5&quot;</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">128Mi</span><br>            <span class="hljs-attr">requests:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-string">&quot;0.1&quot;</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">64Mi</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">client-go-tutorials</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-service</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-app</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">front-end</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">80</span><br>      <span class="hljs-attr">nodePort:</span> <span class="hljs-number">30011</span><br></code></pre></td></tr></table></figure><p>â€¢å…ˆæ‰§è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºnamespace</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl create namespace client-go-tutorials<br></code></pre></td></tr></table></figure><p>â€¢å†æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å³å¯å®Œæˆèµ„æºçš„åˆ›å»º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl apply -f nginx-deployment-service.yaml<br></code></pre></td></tr></table></figure><p>â€¢æ¥æŸ¥çœ‹ä¸€ä¸‹èµ„æºæƒ…å†µï¼Œå¦‚ä¸‹å›¾ï¼Œserviceå’Œpodéƒ½åˆ›å»ºå¥½äº†ï¼Œå‡†å¤‡å·¥ä½œå®Œæˆï¼Œå¯ä»¥å¼€å§‹ç¼–ç äº†</p><p><img src="/2025/03/27/k8s-%E9%80%89%E4%B8%BB-%E5%AE%9E%E6%88%98%E9%AA%8C%E8%AF%81/73fa79a5cf8315f15417361895009780.png" alt="Image 36: åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><h4 id="ç¼–ç ï¼šå‡†å¤‡å·¥ç¨‹"><a href="#ç¼–ç ï¼šå‡†å¤‡å·¥ç¨‹" class="headerlink" title="ç¼–ç ï¼šå‡†å¤‡å·¥ç¨‹"></a>ç¼–ç ï¼šå‡†å¤‡å·¥ç¨‹</h4><p>â€¢æ‰§è¡Œå‘½ä»¤åä¸ºgo mod init leader-tutorialsï¼Œæ–°å»ºmoduleâ€¢ç¡®ä¿æ‚¨çš„goproxyæ˜¯æ­£å¸¸çš„â€¢æ‰§è¡Œå‘½ä»¤go get k8s.io&#x2F;<a href="mailto:&#x63;&#x6c;&#105;&#101;&#x6e;&#116;&#45;&#103;&#111;&#64;&#118;&#x30;&#46;&#x32;&#50;&#46;&#x38;">&#x63;&#x6c;&#105;&#101;&#x6e;&#116;&#45;&#103;&#111;&#64;&#118;&#x30;&#46;&#x32;&#50;&#46;&#x38;</a>ï¼Œä¸‹è½½client-goçš„æŒ‡å®šç‰ˆæœ¬â€¢ç°åœ¨å·¥ç¨‹å·²ç»å‡†å¤‡å¥½äº†ï¼Œæ¥ç€å°±æ˜¯å…·ä½“çš„ç¼–ç </p><h4 id="ç¼–ç ï¼šæ¢³ç†"><a href="#ç¼–ç ï¼šæ¢³ç†" class="headerlink" title="ç¼–ç ï¼šæ¢³ç†"></a>ç¼–ç ï¼šæ¢³ç†</h4><p>â€¢å’±ä»¬æŒ‰ç…§å¼€å‘é¡ºåºå¼€å§‹å†™ä»£ç ï¼Œå¦‚æœæ‚¨çœ‹è¿‡æ¬£å®¸çš„ã€Šclient-goå®æˆ˜ã€‹ç³»åˆ—ï¼Œæ­¤åˆ»å¯¹ä½¿ç”¨client-goå¼€å‘ç®€æ˜“ç‰ˆcontrolleråº”è¯¥å¾ˆç†Ÿæ‚‰äº†ï¼Œè¿™é‡Œå†ç®€å•æä¸€ä¸‹å¼€å‘çš„æµç¨‹</p><p>1.å°†controllerå®Œæ•´çš„å†™å‡ºæ¥ï¼ŒåŠŸèƒ½æ˜¯ç›‘å¬serviceï¼Œä¸€æ—¦æœ‰å˜åŒ–å°±æ›´æ–°podçš„label2.åœ¨ä¸»æ§é€»è¾‘ä¸­ï¼Œæ ¹æ®é€‰ä¸»ç»“æœå†³å®šæ˜¯å¦å¯åŠ¨æ­¥éª¤1ä¸­çš„controller</p><p>â€¢ä¸‹é¢å¼€å§‹å†™ä»£ç </p><h4 id="ç¼–ç ï¼šcontroller"><a href="#ç¼–ç ï¼šcontroller" class="headerlink" title="ç¼–ç ï¼šcontroller"></a>ç¼–ç ï¼šcontroller</h4><p>â€¢æ–°å»ºcontroller.goæ–‡ä»¶â€¢åœ¨controller.goä¸­å¢åŠ å¸¸é‡å’Œæ•°æ®ç»“æ„çš„å®šä¹‰</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;context&quot;</span><br>    <span class="hljs-string">&quot;encoding/json&quot;</span><br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;time&quot;</span><br><br>    <span class="hljs-string">&quot;k8s.io/klog/v2&quot;</span><br><br>    metav1 <span class="hljs-string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span><br>    <span class="hljs-string">&quot;k8s.io/apimachinery/pkg/fields&quot;</span><br>    objectruntime <span class="hljs-string">&quot;k8s.io/apimachinery/pkg/runtime&quot;</span><br>    <span class="hljs-string">&quot;k8s.io/apimachinery/pkg/types&quot;</span><br>    <span class="hljs-string">&quot;k8s.io/apimachinery/pkg/util/runtime&quot;</span><br>    <span class="hljs-string">&quot;k8s.io/apimachinery/pkg/util/wait&quot;</span><br>    <span class="hljs-string">&quot;k8s.io/client-go/kubernetes&quot;</span><br>    <span class="hljs-string">&quot;k8s.io/client-go/tools/cache&quot;</span><br>    <span class="hljs-string">&quot;k8s.io/client-go/util/workqueue&quot;</span><br>)<br><br><span class="hljs-keyword">const</span> (<br>    LABLE_SERVICE_UPDATE_TIME = <span class="hljs-string">&quot;service-update-time&quot;</span> <span class="hljs-comment">// è¿™ä¸ªlabelç”¨æ¥è®°å½•serviceçš„æ›´æ–°æ—¶é—´</span><br>)<br><br><span class="hljs-comment">// è‡ªå®šä¹‰controlleræ•°æ®ç»“æ„ï¼ŒåµŒå…¥äº†çœŸå®çš„æ§åˆ¶å™¨</span><br><span class="hljs-keyword">type</span> Controller <span class="hljs-keyword">struct</span> &#123;<br>    ctx       context.Context<br>    clientset *kubernetes.Clientset<br>    <span class="hljs-comment">// æœ¬åœ°ç¼“å­˜ï¼Œå…³æ³¨çš„å¯¹è±¡éƒ½ä¼šåŒæ­¥åˆ°è¿™é‡Œ</span><br>    indexer cache.Indexer<br>    <span class="hljs-comment">// æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç”¨æ¥è§¦å‘å¯¹çœŸå®å¯¹è±¡çš„å¤„ç†äº‹ä»¶</span><br>    queue workqueue.RateLimitingInterface<br>    <span class="hljs-comment">// å®é™…è¿è¡Œè¿è¡Œçš„æ§åˆ¶å™¨</span><br>    informer cache.Controller<br>&#125;<br></code></pre></td></tr></table></figure><p>â€¢ç„¶åæ˜¯controllerçš„å¥—è·¯ä»£ç ï¼Œä¸»è¦æ˜¯ä»é˜Ÿåˆ—ä¸­ä¸æ–­è·å–æ•°æ®å¹¶å¤„ç†çš„é€»è¾‘</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// processNextItem ä¸é—´æ–­ä»é˜Ÿåˆ—ä¸­å–å¾—æ•°æ®å¹¶å¤„ç†</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Controller)</span></span> processNextItem() <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-comment">// æ³¨æ„ï¼Œé˜Ÿåˆ—é‡Œé¢ä¸æ˜¯å¯¹è±¡ï¼Œè€Œæ˜¯keyï¼Œè¿™æ˜¯ä¸ªé˜»å¡é˜Ÿåˆ—ï¼Œä¼šä¸€ç›´ç­‰å¾…</span><br>    key, quit := c.queue.Get()<br>    <span class="hljs-keyword">if</span> quit &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>    &#125;<br>    <span class="hljs-comment">// Tell the queue that we are done with processing this key. This unblocks the key for other workers</span><br>    <span class="hljs-comment">// This allows safe parallel processing because two pods with the same key are never processed in</span><br>    <span class="hljs-comment">// parallel.</span><br>    <span class="hljs-keyword">defer</span> c.queue.Done(key)<br><br>    <span class="hljs-comment">// æ³¨æ„ï¼Œè¿™é‡Œçš„syncToStdoutåº”è¯¥æ˜¯ä¸šåŠ¡ä»£ç ï¼Œå¤„ç†å¯¹è±¡å˜åŒ–çš„äº‹ä»¶</span><br>    err := c.updatePodsLabel(key.(<span class="hljs-type">string</span>))<br><br>    <span class="hljs-comment">// å¦‚æœå‰é¢çš„ä¸šåŠ¡é€»è¾‘é‡åˆ°äº†é”™è¯¯ï¼Œå°±åœ¨æ­¤å¤„ç†</span><br>    c.handleErr(err, key)<br><br>    <span class="hljs-comment">// å¤–é¢çš„è°ƒç”¨é€»è¾‘æ˜¯ï¼šè¿”å›trueå°±ç»§ç»­è°ƒç”¨processNextItemæ–¹æ³•</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><br><span class="hljs-comment">// runWorker è¿™æ˜¯ä¸ªæ— é™å¾ªç¯ï¼Œä¸æ–­åœ°ä»é˜Ÿåˆ—å–å‡ºæ•°æ®å¤„ç†</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Controller)</span></span> runWorker() &#123;<br>    <span class="hljs-keyword">for</span> c.processNextItem() &#123;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// handleErr å¦‚æœå‰é¢çš„ä¸šåŠ¡é€»è¾‘æ‰§è¡Œå‡ºç°é”™è¯¯ï¼Œå°±åœ¨æ­¤é›†ä¸­å¤„ç†é”™è¯¯ï¼Œæœ¬ä¾‹ä¸­ä¸»è¦æ˜¯é‡è¯•æ¬¡æ•°çš„æ§åˆ¶</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Controller)</span></span> handleErr(err <span class="hljs-type">error</span>, key <span class="hljs-keyword">interface</span>&#123;&#125;) &#123;<br>    <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-comment">// Forget about the #AddRateLimited history of the key on every successful synchronization.</span><br>        <span class="hljs-comment">// This ensures that future processing of updates for this key is not delayed because of</span><br>        <span class="hljs-comment">// an outdated error history.</span><br>        c.queue.Forget(key)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    <span class="hljs-comment">// å¦‚æœé‡è¯•æ¬¡æ•°æœªè¶…è¿‡5æ¬¡ï¼Œå°±ç»§ç»­é‡è¯•</span><br>    <span class="hljs-keyword">if</span> c.queue.NumRequeues(key) &lt; <span class="hljs-number">5</span> &#123;<br>        klog.Infof(<span class="hljs-string">&quot;Error syncing pod %v: %v&quot;</span>, key, err)<br><br>        <span class="hljs-comment">// Re-enqueue the key rate limited. Based on the rate limiter on the</span><br>        <span class="hljs-comment">// queue and the re-enqueue history, the key will be processed later again.</span><br>        c.queue.AddRateLimited(key)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    <span class="hljs-comment">// ä»£ç èµ°åˆ°è¿™é‡Œï¼Œæ„å‘³ç€æœ‰é”™è¯¯å¹¶ä¸”é‡è¯•è¶…è¿‡äº†5æ¬¡ï¼Œåº”è¯¥ç«‹å³ä¸¢å¼ƒ</span><br>    c.queue.Forget(key)<br>    <span class="hljs-comment">// è¿™ç§è¿ç»­äº”æ¬¡é‡è¯•è¿˜æœªæˆåŠŸçš„é”™è¯¯ï¼Œäº¤ç»™å…¨å±€å¤„ç†é€»è¾‘</span><br>    runtime.HandleError(err)<br>    klog.Infof(<span class="hljs-string">&quot;Dropping pod %q out of the queue: %v&quot;</span>, key, err)<br>&#125;<br><br><span class="hljs-comment">// Run å¼€å§‹å¸¸è§„çš„æ§åˆ¶å™¨æ¨¡å¼ï¼ˆæŒç»­å“åº”èµ„æºå˜åŒ–äº‹ä»¶ï¼‰</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Controller)</span></span> Run(threadiness <span class="hljs-type">int</span>, stopCh <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;) &#123;<br>    <span class="hljs-keyword">defer</span> runtime.HandleCrash()<br><br>    <span class="hljs-comment">// Let the workers stop when we are done</span><br>    <span class="hljs-keyword">defer</span> c.queue.ShutDown()<br>    klog.Info(<span class="hljs-string">&quot;Starting Pod controller&quot;</span>)<br><br>    <span class="hljs-keyword">go</span> c.informer.Run(stopCh)<br><br>    <span class="hljs-comment">// Wait for all involved caches to be synced, before processing items from the queue is started</span><br>    <span class="hljs-comment">// åˆšå¼€å§‹å¯åŠ¨ï¼Œä»api-serverä¸€æ¬¡æ€§å…¨é‡åŒæ­¥æ‰€æœ‰æ•°æ®</span><br>    <span class="hljs-keyword">if</span> !cache.WaitForCacheSync(stopCh, c.informer.HasSynced) &#123;<br>        runtime.HandleError(fmt.Errorf(<span class="hljs-string">&quot;timed out waiting for caches to sync&quot;</span>))<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    <span class="hljs-comment">// æ”¯æŒå¤šä¸ªçº¿ç¨‹å¹¶è¡Œä»é˜Ÿåˆ—ä¸­å–å¾—æ•°æ®è¿›è¡Œå¤„ç†</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; threadiness; i++ &#123;<br>        <span class="hljs-keyword">go</span> wait.Until(c.runWorker, time.Second, stopCh)<br>    &#125;<br><br>    &lt;-stopCh<br>    klog.Info(<span class="hljs-string">&quot;Stopping Pod controller&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>â€¢ä»ä¸Šè¿°ä»£ç å¯è§ï¼Œç›‘å¬çš„èµ„æºå‘ç”Ÿå˜åŒ–æ—¶ï¼Œè°ƒç”¨çš„æ˜¯updatePodsLabelæ–¹æ³•ï¼Œæ­¤æ–¹æ³•çš„ä½œç”¨å°±æ˜¯æŸ¥æ‰¾è¯¥namespaceä¸‹çš„æ‰€æœ‰podï¼Œä¾æ¬¡ç”¨patchçš„æ–¹å¼æ›´æ–°podçš„label</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// updatePodsLabel è¿™æ˜¯ä¸šåŠ¡é€»è¾‘ä»£ç ï¼Œä¸€æ—¦serviceå‘ç”Ÿå˜åŒ–ï¼Œå°±ä¿®æ”¹podçš„labelï¼Œå°†serviceçš„å˜åŒ–äº‹ä»¶è®°å½•è¿›å»</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Controller)</span></span> updatePodsLabel(key <span class="hljs-type">string</span>) <span class="hljs-type">error</span> &#123;<br>    <span class="hljs-comment">// å¼€å§‹è¿›å…¥controllerçš„ä¸šåŠ¡é€»è¾‘</span><br>    klog.Infof(<span class="hljs-string">&quot;[%s]è¿™é‡Œæ˜¯controllerçš„ä¸šåŠ¡é€»è¾‘ï¼Œkey [%s]&quot;</span>, processIndentify, key)<br>    <span class="hljs-comment">// ä»æœ¬åœ°ç¼“å­˜ä¸­å–å‡ºå®Œæ•´çš„å¯¹è±¡</span><br>    _, exists, err := c.indexer.GetByKey(key)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        klog.Errorf(<span class="hljs-string">&quot;[%s]æ ¹æ®key[%s]ä»æœ¬åœ°ç¼“å­˜è·å–å¯¹è±¡å¤±è´¥ : %v&quot;</span>, processIndentify, key, err)<br>        <span class="hljs-keyword">return</span> err<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> !exists &#123;<br>        klog.Infof(<span class="hljs-string">&quot;[%s]å¯¹è±¡ä¸å­˜åœ¨ï¼Œkey [%s]ï¼Œè¿™æ˜¯ä¸ªåˆ é™¤äº‹ä»¶&quot;</span>, processIndentify, key)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        klog.Infof(<span class="hljs-string">&quot;[%s]å¯¹è±¡å­˜åœ¨ï¼Œkey [%s]ï¼Œè¿™æ˜¯ä¸ªæ–°å¢æˆ–ä¿®æ”¹äº‹ä»¶&quot;</span>, processIndentify, key)<br>    &#125;<br><br>    <span class="hljs-comment">// ä»£ç èµ°åˆ°è¿™é‡Œï¼Œè¡¨ç¤ºç›‘å¬çš„å¯¹è±¡å‘ç”Ÿäº†å˜åŒ–ï¼Œ</span><br>    <span class="hljs-comment">// æŒ‰ç…§ä¸šåŠ¡è®¾å®šï¼Œéœ€è¦ä¿®æ”¹podçš„æŒ‡å®šlabel,</span><br>    <span class="hljs-comment">// å‡†å¤‡å¥½æ“ä½œpodçš„æ¥å£</span><br>    podInterface := c.clientset.CoreV1().Pods(NAMESPACE)<br><br>    <span class="hljs-comment">// è¿œç¨‹å–å¾—æœ€æ–°çš„podåˆ—è¡¨</span><br>    pods, err := podInterface.List(c.ctx, metav1.ListOptions&#123;&#125;)<br><br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        klog.Errorf(<span class="hljs-string">&quot;[%s]è¿œç¨‹è·å–podåˆ—è¡¨å¤±è´¥ : %v&quot;</span>, processIndentify, err)<br>        <span class="hljs-keyword">return</span> err<br>    &#125;<br><br>    <span class="hljs-comment">// å°†serviceçš„å˜åŒ–æ—¶é—´å†™å…¥podçš„æŒ‡å®šlabelï¼Œè¿™é‡Œå…ˆè·å–å½“å‰æ—¶é—´</span><br>    updateTime := time.Now().Format(<span class="hljs-string">&quot;20060102150405&quot;</span>)<br>    <span class="hljs-comment">// å‡†å¤‡patchå¯¹è±¡</span><br>    patchData := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<br>        <span class="hljs-string">&quot;metadata&quot;</span>: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<br>            <span class="hljs-string">&quot;labels&quot;</span>: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<br>                LABLE_SERVICE_UPDATE_TIME: updateTime,<br>            &#125;,<br>        &#125;,<br>    &#125;<br><br>    <span class="hljs-comment">// è½¬ä¸ºbyteæ•°ç»„ï¼Œç¨åæ›´æ–°podçš„æ—¶å€™ï¼Œå°±ç”¨è¿™ä¸ªæ•°ç»„è¿›è¡Œpatchæ›´æ–°</span><br>    patchByte, _ := json.Marshal(patchData)<br><br>    <span class="hljs-comment">// éå†æ‰€æœ‰podï¼Œé€ä¸ªæ›´æ–°label</span><br>    <span class="hljs-keyword">for</span> _, pod := <span class="hljs-keyword">range</span> pods.Items &#123;<br>        podName := pod.Name<br>        klog.Infof(<span class="hljs-string">&quot;[%s]æ­£åœ¨æ›´æ–°pod [%s]&quot;</span>, processIndentify, podName)<br><br>        _, err := podInterface.Patch(c.ctx, podName, types.MergePatchType, patchByte, metav1.PatchOptions&#123;&#125;)<br><br>        <span class="hljs-comment">// å¤±è´¥å°±è¿”å›ï¼Œä¼šå¯¼è‡´æ•´ä½“é‡è¯•</span><br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            klog.Infof(<span class="hljs-string">&quot;[%s]æ›´æ–°pod [%s]å¤±è´¥, %v&quot;</span>, processIndentify, podName, err)<br>            <span class="hljs-keyword">return</span> err<br>        &#125;<br><br>        klog.Infof(<span class="hljs-string">&quot;[%s]æ›´æ–°pod [%s]æˆåŠŸ&quot;</span>, processIndentify, podName)<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>â€¢åˆ°è¿™é‡Œï¼Œcontrollerçš„ä»£ç å·²ç»å†™å¾—ä¸ƒä¸ƒå…«å…«äº†ï¼Œè¿˜å‰©åˆ›å»ºcontrollerå¯¹è±¡ä»¥åŠè¿è¡Œinformerçš„ä»£ç ï¼Œè¿™é‡Œå°†å®ƒä»¬é›†ä¸­å°è£…åœ¨ä¸€ä¸ªæ–¹æ³•ä¸­ï¼Œä¸€æ—¦è¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨ï¼Œå°±æ„å‘³ç€controllerä¼šè¢«åˆ›å»ºï¼Œç„¶åç›‘å¬serviceå˜åŒ–å†æ›´æ–°podçš„labelçš„é€»è¾‘å°±ä¼šè¢«æ‰§è¡Œ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// CreateAndStartController ä¸ºäº†ä¾¿äºå¤–éƒ¨ä½¿ç”¨ï¼Œè¿™é‡Œå°†controllerçš„åˆ›å»ºå’Œå¯åŠ¨å°è£…åœ¨ä¸€èµ·</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CreateAndStartController</span><span class="hljs-params">(ctx context.Context, clientset *kubernetes.Clientset, objType objectruntime.Object, resource <span class="hljs-type">string</span>, namespace <span class="hljs-type">string</span>, stopCh <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)</span></span> &#123;<br>    <span class="hljs-comment">// ListWatcherç”¨äºè·å–æ•°æ®å¹¶ç›‘å¬èµ„æºçš„äº‹ä»¶</span><br>    podListWatcher := cache.NewListWatchFromClient(clientset.CoreV1().RESTClient(), resource, NAMESPACE, fields.Everything())<br><br>    <span class="hljs-comment">// é™é€Ÿé˜Ÿåˆ—ï¼Œé‡Œé¢å­˜çš„æ˜¯æœ‰äº‹ä»¶å‘ç”Ÿçš„å¯¹è±¡çš„èº«ä»½ä¿¡æ¯ï¼Œè€Œéå¯¹è±¡æœ¬èº«</span><br>    queue := workqueue.NewRateLimitingQueue(workqueue.DefaultControllerRateLimiter())<br><br>    <span class="hljs-comment">// åˆ›å»ºæœ¬åœ°ç¼“å­˜å¹¶å¯¹æŒ‡å®šç±»å‹çš„èµ„æºå¼€å§‹ç›‘å¬</span><br>    <span class="hljs-comment">// æ³¨æ„ï¼Œå¦‚æœä¸šåŠ¡ä¸Šæœ‰å¿…è¦ï¼Œå…¶å®å¯ä»¥å°†æ–°å¢ã€ä¿®æ”¹ã€åˆ é™¤ç­‰äº‹ä»¶æ”¾å…¥ä¸åŒé˜Ÿåˆ—ï¼Œç„¶ååˆ†åˆ«åšé’ˆå¯¹æ€§å¤„ç†ï¼Œ</span><br>    <span class="hljs-comment">// ä½†æ˜¯ï¼Œcontrollerå¯¹åº”çš„æ¨¡å¼ï¼Œä¸»è¦æ˜¯è®©statusä¸specè¾¾æˆä¸€è‡´ï¼Œä¹Ÿå°±æ˜¯è¯´å¢åˆ æ”¹ç­‰äº‹ä»¶ï¼Œå¯¹åº”çš„éƒ½æ˜¯æŸ¥åˆ°å®é™…æƒ…å†µï¼Œä»¤å…¶ä¸æœŸæœ›æƒ…å†µä¿æŒä¸€è‡´ï¼Œ</span><br>    <span class="hljs-comment">// å› æ­¤ï¼Œå¤šæ•°æƒ…å†µä¸‹å¢åˆ æ”¹ç”¨ä¸€ä¸ªé˜Ÿåˆ—å³å¯ï¼Œé‡Œé¢æ”¾å…¥å˜åŒ–çš„å¯¹è±¡çš„èº«ä»½ï¼Œè‡³äºå¤„ç†æ–¹å¼åªæœ‰ä¸€ç§ï¼šæŸ¥åˆ°å®é™…æƒ…å†µï¼Œä»¤å…¶ä¸æœŸæœ›æƒ…å†µä¿æŒä¸€è‡´</span><br>    indexer, informer := cache.NewIndexerInformer(podListWatcher, objType, <span class="hljs-number">0</span>, cache.ResourceEventHandlerFuncs&#123;<br>        AddFunc: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(obj <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>            key, err := cache.MetaNamespaceKeyFunc(obj)<br>            <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br>                <span class="hljs-comment">// å†æ¬¡æ³¨æ„ï¼šè¿™é‡Œæ”¾å…¥é˜Ÿåˆ—çš„å¹¶éå¯¹è±¡ï¼Œè€Œæ˜¯å¯¹è±¡çš„èº«ä»½ï¼Œä½œç”¨æ˜¯ä»…ä»…å‘ŠçŸ¥æ¶ˆè´¹æ–¹ï¼Œè¯¥å¯¹è±¡æœ‰å˜åŒ–ï¼Œ</span><br>                <span class="hljs-comment">// è‡³äºæœ‰ä»€ä¹ˆå˜åŒ–ï¼Œéœ€è¦æ¶ˆè´¹æ–¹è‡ªè¡Œåˆ¤æ–­ï¼Œç„¶åå†åšé’ˆå¯¹æ€§å¤„ç†</span><br>                queue.Add(key)<br>            &#125;<br>        &#125;,<br>        UpdateFunc: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(old <span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-built_in">new</span> <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>            key, err := cache.MetaNamespaceKeyFunc(<span class="hljs-built_in">new</span>)<br>            <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br>                queue.Add(key)<br>            &#125;<br>        &#125;,<br>        DeleteFunc: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(obj <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>            key, err := cache.DeletionHandlingMetaNamespaceKeyFunc(obj)<br>            <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br>                queue.Add(key)<br>            &#125;<br>        &#125;,<br>    &#125;, cache.Indexers&#123;&#125;)<br><br>    controller := &amp;Controller&#123;<br>        ctx:       ctx,<br>        clientset: clientset,<br>        informer:  informer,<br>        indexer:   indexer,<br>        queue:     queue,<br>    &#125;<br><br>    <span class="hljs-keyword">go</span> controller.Run(<span class="hljs-number">1</span>, stopCh)<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ç¼–ç ï¼šä¸»æ§ç¨‹åºï¼ˆé€‰ä¸»é€»è¾‘ä¹Ÿåœ¨é‡Œé¢ï¼‰"><a href="#ç¼–ç ï¼šä¸»æ§ç¨‹åºï¼ˆé€‰ä¸»é€»è¾‘ä¹Ÿåœ¨é‡Œé¢ï¼‰" class="headerlink" title="ç¼–ç ï¼šä¸»æ§ç¨‹åºï¼ˆé€‰ä¸»é€»è¾‘ä¹Ÿåœ¨é‡Œé¢ï¼‰"></a>ç¼–ç ï¼šä¸»æ§ç¨‹åºï¼ˆé€‰ä¸»é€»è¾‘ä¹Ÿåœ¨é‡Œé¢ï¼‰</h4><p>â€¢æœ¬æ–‡æ˜¯è®²é€‰ä¸»(leader-election)çš„ï¼Œå‰é¢åšäº†è¿™ä¹ˆå¤šé“ºå«ï¼Œä¸»è§’è¯¥ä¸Šåœºäº†ï¼Œæ–°å»ºmain.goæ–‡ä»¶â€¢å®šä¹‰å¸¸é‡ï¼Œä»¥åŠå…¨å±€å˜é‡</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;context&quot;</span><br>    <span class="hljs-string">&quot;flag&quot;</span><br>    <span class="hljs-string">&quot;os&quot;</span><br>    <span class="hljs-string">&quot;path/filepath&quot;</span><br>    <span class="hljs-string">&quot;time&quot;</span><br><br>    <span class="hljs-string">&quot;github.com/google/uuid&quot;</span><br>    v1 <span class="hljs-string">&quot;k8s.io/api/core/v1&quot;</span><br>    metav1 <span class="hljs-string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span><br><br>    <span class="hljs-string">&quot;k8s.io/client-go/kubernetes&quot;</span><br>    <span class="hljs-string">&quot;k8s.io/client-go/tools/clientcmd&quot;</span><br>    <span class="hljs-string">&quot;k8s.io/client-go/tools/leaderelection&quot;</span><br>    <span class="hljs-string">&quot;k8s.io/client-go/tools/leaderelection/resourcelock&quot;</span><br>    <span class="hljs-string">&quot;k8s.io/client-go/util/homedir&quot;</span><br>    <span class="hljs-string">&quot;k8s.io/klog/v2&quot;</span><br>)<br><br><span class="hljs-keyword">const</span> (<br>    NAMESPACE = <span class="hljs-string">&quot;client-go-tutorials&quot;</span><br>)<br><br><span class="hljs-comment">// ç”¨äºè¡¨æ˜å½“å‰è¿›ç¨‹èº«ä»½çš„å…¨å±€å˜é‡ï¼Œç›®å‰ç”¨çš„æ˜¯uuid</span><br><span class="hljs-keyword">var</span> processIndentify <span class="hljs-type">string</span><br></code></pre></td></tr></table></figure><p>â€¢å…ˆæŠŠå¥—è·¯çš„ä»£ç å†™äº†ï¼Œå°±æ˜¯client-goåˆå§‹åŒ–çš„é‚£éƒ¨åˆ†ï¼Œä»¥åŠmainæ–¹æ³•ï¼Œé‡Œé¢æ˜¯æ•´ä¸ªç¨‹åºçš„å¯åŠ¨å’Œä¸šåŠ¡è°ƒç”¨æµç¨‹ï¼Œå¯è§é€‰ä¸»æœ‰å…³çš„ä»£ç éƒ½æ”¾åœ¨åä¸ºstartLeaderElectionçš„æ–¹æ³•ä¸­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// initOrDie clientæœ‰å…³çš„åˆå§‹åŒ–æ“ä½œ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initOrDie</span><span class="hljs-params">()</span></span> *kubernetes.Clientset &#123;<br>    klog.Infof(<span class="hljs-string">&quot;[%s]å¼€å§‹åˆå§‹åŒ–kuberneteså®¢æˆ·ç«¯ç›¸å…³å¯¹è±¡&quot;</span>, processIndentify)<br>    <span class="hljs-keyword">var</span> kubeconfig *<span class="hljs-type">string</span><br>    <span class="hljs-keyword">var</span> master <span class="hljs-type">string</span><br><br>    <span class="hljs-comment">// è¯•å›¾å–åˆ°å½“å‰è´¦å·çš„å®¶ç›®å½•</span><br>    <span class="hljs-keyword">if</span> home := homedir.HomeDir(); home != <span class="hljs-string">&quot;&quot;</span> &#123;<br>        <span class="hljs-comment">// å¦‚æœèƒ½å–åˆ°ï¼Œå°±æŠŠå®¶ç›®å½•ä¸‹çš„.kube/configä½œä¸ºé»˜è®¤é…ç½®æ–‡ä»¶</span><br>        kubeconfig = flag.String(<span class="hljs-string">&quot;kubeconfig&quot;</span>, filepath.Join(home, <span class="hljs-string">&quot;.kube&quot;</span>, <span class="hljs-string">&quot;config&quot;</span>), <span class="hljs-string">&quot;(optional) absolute path to the kubeconfig file&quot;</span>)<br>        master = <span class="hljs-string">&quot;&quot;</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// å¦‚æœå–ä¸åˆ°ï¼Œå°±æ²¡æœ‰é»˜è®¤é…ç½®æ–‡ä»¶ï¼Œå¿…é¡»é€šè¿‡kubeconfigå‚æ•°æ¥æŒ‡å®š</span><br>        flag.StringVar(kubeconfig, <span class="hljs-string">&quot;kubeconfig&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;absolute path to the kubeconfig file&quot;</span>)<br>        flag.StringVar(&amp;master, <span class="hljs-string">&quot;master&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;master url&quot;</span>)<br>        flag.Parse()<br>    &#125;<br><br>    config, err := clientcmd.BuildConfigFromFlags(master, *kubeconfig)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        klog.Fatal(err)<br>    &#125;<br><br>    clientset, err := kubernetes.NewForConfig(config)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        klog.Fatal(err)<br>    &#125;<br>    klog.Infof(<span class="hljs-string">&quot;[%s]kuberneteså®¢æˆ·ç«¯ç›¸å…³å¯¹è±¡åˆ›å»ºæˆåŠŸ&quot;</span>, processIndentify)<br>    <span class="hljs-keyword">return</span> clientset<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">// ä¸€æ¬¡æ€§ç¡®å®šå½“å‰è¿›ç¨‹èº«ä»½</span><br>    processIndentify = uuid.New().String()<br><br>    <span class="hljs-comment">// å‡†å¤‡ä¸€ä¸ªå¸¦cancelçš„contextï¼Œè¿™æ ·åœ¨ä¸»ç¨‹åºé€€å‡ºçš„æ—¶å€™ï¼Œå¯ä»¥å°†åœæ­¢çš„ä¿¡å·ä¼ é€’ç»™ä¸šåŠ¡</span><br>    ctx, cancel := context.WithCancel(context.Background())<br>    <span class="hljs-comment">// è¿™ä¸ªæ˜¯ç”¨æ¥åœæ­¢controllerçš„</span><br>    stop := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)<br><br>    <span class="hljs-comment">// ä¸»ç¨‹åºç»“æŸçš„æ—¶å€™ï¼Œä¸‹é¢çš„æ“ä½œå¯ä»¥å°†ä¸šåŠ¡é€»è¾‘éƒ½åœæ‰</span><br>    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        <span class="hljs-built_in">close</span>(stop)<br>        cancel()<br>    &#125;()<br><br>    <span class="hljs-comment">// åˆå§‹åŒ–clientSeté…ç½®ï¼Œå› ä¸ºæ˜¯å¯åŠ¨é˜¶æ®µï¼Œæ‰€ä»¥å¿…é¡»åˆå§‹åŒ–æˆåŠŸï¼Œå¦åˆ™è¿›ç¨‹é€€å‡º</span><br>    clientset := initOrDie()<br><br>    <span class="hljs-comment">// åœ¨ä¸€ä¸ªæ–°çš„åç¨‹ä¸­æ‰§è¡Œé€‰ä¸»é€»è¾‘ï¼Œä»¥åŠé€‰ä¸»æˆåŠŸçš„åçš„é€»è¾‘</span><br>    <span class="hljs-keyword">go</span> startLeaderElection(ctx, clientset, stop)<br><br>    <span class="hljs-comment">// è¿™é‡Œå¯ä»¥ç»§ç»­åšå…¶ä»–äº‹æƒ…</span><br>    klog.Infof(<span class="hljs-string">&quot;é€‰ä¸»çš„åç¨‹å·²ç»åœ¨è¿è¡Œï¼Œæ¥ä¸‹æ¥å¯ä»¥æ‰§è¡Œå…¶ä»–ä¸šåŠ¡ [%s]&quot;</span>, processIndentify)<br><br>    <span class="hljs-keyword">select</span> &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>â€¢æœ€åæ˜¯é€‰ä¸»çš„ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œå…ˆåˆ›å»ºé”å¯¹è±¡ï¼Œå°±åƒåˆ†å¸ƒå¼é”ä¸€æ ·ï¼Œæ€»è¦æœ‰ä¸ªkeyï¼Œç„¶åæ‰§è¡Œleaderelection.RunOrDieæ–¹æ³•å‚ä¸é€‰ä¸»ï¼Œä¸€æ—¦æœ‰äº†ç»“æœï¼ŒOnNewLeaderæ–¹æ³•ä¼šè¢«å›è°ƒï¼Œè¿™æ—¶å€™é€šè¿‡è‡ªèº«idå’Œleaderçš„idæ¯”è¾ƒå°±çŸ¥é“æ˜¯ä¸æ˜¯è‡ªå·±äº†ï¼Œå¦å¤–ï¼Œå½“OnStartedLeadingè¢«æ‰§è¡Œçš„æ—¶å€™ï¼Œå°±æ„å‘³ç€å½“å‰è¿›ç¨‹å°±æ˜¯leaderï¼Œå¹¶ä¸”å¯ä»¥ç«‹å³å¼€å§‹æ‰§è¡Œåªæœ‰leaderæ‰èƒ½åšçš„äº‹æƒ…äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// startLeaderElection é€‰ä¸»çš„æ ¸å¿ƒé€»è¾‘ä»£ç </span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">startLeaderElection</span><span class="hljs-params">(ctx context.Context, clientset *kubernetes.Clientset, stop <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)</span></span> &#123;<br>    klog.Infof(<span class="hljs-string">&quot;[%s]åˆ›å»ºé€‰ä¸»æ‰€éœ€çš„é”å¯¹è±¡&quot;</span>, processIndentify)<br>    <span class="hljs-comment">// åˆ›å»ºé”å¯¹è±¡</span><br>    lock := &amp;resourcelock.LeaseLock&#123;<br>        LeaseMeta: metav1.ObjectMeta&#123;<br>            Name:      <span class="hljs-string">&quot;leader-tutorials&quot;</span>,<br>            Namespace: NAMESPACE,<br>        &#125;,<br>        Client: clientset.CoordinationV1(),<br>        LockConfig: resourcelock.ResourceLockConfig&#123;<br>            Identity: processIndentify,<br>        &#125;,<br>    &#125;<br>    klog.Infof(<span class="hljs-string">&quot;[%s]å¼€å§‹é€‰ä¸»&quot;</span>, processIndentify)<br>    <span class="hljs-comment">// å¯åŠ¨é€‰ä¸»æ“ä½œ</span><br>    leaderelection.RunOrDie(ctx, leaderelection.LeaderElectionConfig&#123;<br>        Lock:            lock,<br>        ReleaseOnCancel: <span class="hljs-literal">true</span>,<br>        LeaseDuration:   <span class="hljs-number">10</span> * time.Second,<br>        RenewDeadline:   <span class="hljs-number">5</span> * time.Second,<br>        RetryPeriod:     <span class="hljs-number">2</span> * time.Second,<br>        Callbacks: leaderelection.LeaderCallbacks&#123;<br>            OnStartedLeading: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context)</span></span> &#123;<br>                klog.Infof(<span class="hljs-string">&quot;[%s]å½“å‰è¿›ç¨‹æ˜¯leaderï¼Œåªæœ‰leaderæ‰èƒ½æ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘ç«‹å³å¼€å§‹&quot;</span>, processIndentify)<br>                <span class="hljs-comment">// åœ¨è¿™é‡Œå†™å…¥é€‰ä¸»æˆåŠŸçš„ä»£ç ï¼Œ</span><br>                <span class="hljs-comment">// å°±åƒæŠ¢åˆ†å¸ƒå¼é”ä¸€æ ·ï¼Œå½“å‰è¿›ç¨‹é€‰ä¸¾æˆåŠŸçš„æ—¶å€™ï¼Œè¿™çš„ä»£ç å°±ä¼šè¢«æ‰§è¡Œï¼Œ</span><br>                <span class="hljs-comment">// æ‰€ä»¥ï¼Œåœ¨è¿™é‡Œå¡«å†™æŠ¢é”æˆåŠŸçš„ä¸šåŠ¡é€»è¾‘å§ï¼Œæœ¬ä¾‹ä¸­å°±æ˜¯ç›‘å¬serviceå˜åŒ–ï¼Œç„¶åä¿®æ”¹podçš„label</span><br>                CreateAndStartController(ctx, clientset, &amp;v1.Service&#123;&#125;, <span class="hljs-string">&quot;services&quot;</span>, NAMESPACE, stop)<br>            &#125;,<br>            OnStoppedLeading: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>                <span class="hljs-comment">// å¤±å»äº†leaderæ—¶çš„é€»è¾‘</span><br>                klog.Infof(<span class="hljs-string">&quot;[%s]å¤±å»leaderèº«ä»½ï¼Œä¸å†æ˜¯leaderäº†&quot;</span>, processIndentify)<br>                os.Exit(<span class="hljs-number">0</span>)<br>            &#125;,<br>            OnNewLeader: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(identity <span class="hljs-type">string</span>)</span></span> &#123;<br>                <span class="hljs-comment">// æ”¶åˆ°é€šçŸ¥ï¼ŒçŸ¥é“æœ€ç»ˆçš„é€‰ä¸¾ç»“æœ</span><br>                <span class="hljs-keyword">if</span> identity == processIndentify &#123;<br>                    klog.Infof(<span class="hljs-string">&quot;[%s]é€‰ä¸»ç»“æœå‡ºæ¥äº†ï¼Œå½“å‰è¿›ç¨‹å°±æ˜¯leader&quot;</span>, processIndentify)<br>                    <span class="hljs-comment">// I just got the lock</span><br>                    <span class="hljs-keyword">return</span><br>                &#125;<br>                klog.Infof(<span class="hljs-string">&quot;[%s]é€‰ä¸»ç»“æœå‡ºæ¥äº†ï¼Œleaderæ˜¯ : [%s]&quot;</span>, processIndentify, identity)<br>            &#125;,<br>        &#125;,<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><p>â€¢ä¸Šè¿°ä»£ç ä¸­ï¼Œè¯·æ³¨æ„LeaderElectionConfigå¯¹è±¡çš„å‡ ä¸ªé‡è¦å­—æ®µï¼Œä¾‹å¦‚LeaseDurationã€RenewDeadlineã€RetryPeriodè¿™äº›ï¼Œæ˜¯å’Œé€‰ä¸»æ—¶å€™çš„ç»­ç§Ÿã€è¶…æ—¶ã€é‡è¯•ç›¸å…³ï¼Œéœ€è¦æŒ‰ç…§æ‚¨çš„å®é™…ç½‘ç»œæƒ…å†µè¿›è¡Œè°ƒæ•´â€¢ç°åœ¨ä»£ç å†™å®Œäº†ï¼Œå¯ä»¥å¼€å§‹éªŒè¯äº†</p><h4 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h4><p>â€¢è¿™é‡Œæ‹ä¸€ä¸‹éªŒè¯çš„æ­¥éª¤</p><p>1.æ„å»ºé¡¹ç›®ï¼Œç”Ÿäº§äºŒè¿›åˆ¶æ–‡ä»¶2.æ‰§è¡Œæ­¤äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯åŠ¨ä¸‰ä¸ªè¿›ç¨‹3.è§‚å¯Ÿæ—¥å¿—ï¼Œåº”è¯¥æœ‰ä¸€ä¸ªè¿›ç¨‹é€‰ä¸¾æˆåŠŸï¼Œå¦å¤–ä¸¤ä¸ªåªä¼šåœ¨æ—¥å¿—è¾“å‡ºé€‰ä¸»ç»“æœ4.ä¿®æ”¹serviceèµ„æºï¼Œå†å»è§‚å¯Ÿæ—¥å¿—ï¼Œå‘ç°leaderè¿›ç¨‹ä¼šè¾“å‡ºæ—¥å¿—ï¼Œå†æ£€æŸ¥podçš„labelï¼Œå‘ç°å·²ç»ä¿®æ”¹5.ç”¨ctrl+Cå‘½ä»¤å°†leaderè¿›ç¨‹é€€å‡ºï¼Œå¯è§å¦å¤–ä¸¤ä¸ªè¿›ç¨‹ä¼šæœ‰ä¸€ä¸ªæˆä¸ºæ–°çš„leader6.å†æ¬¡ä¿®æ”¹serviceèµ„æºï¼Œæ–°çš„leaderä¼šè´Ÿè´£æ›´æ–°podçš„label</p><p>â€¢æ¥ä¸‹æ¥å¼€å§‹æ“ä½œ</p><p>1.æ‰§è¡Œå‘½ä»¤go buildï¼Œå¯¹å½“å‰å·¥ç¨‹è¿›è¡Œç¼–è¯‘æ„å»ºï¼Œå¾—åˆ°äºŒè¿›åˆ¶æ–‡ä»¶leader-tutorials2.æ‰“å¼€ä¸‰ä¸ªç»ˆç«¯çª—å£ï¼Œè¾“å…¥åŒæ ·çš„å‘½ä»¤.&#x2F;leader-tutorialsï¼Œé€‰ä¸»æˆåŠŸçš„è¿›ç¨‹æ—¥å¿—å¦‚ä¸‹ï¼Œä¹‹å‰æ“ä½œè¿‡çš„æ®‹ç•™ï¼Œæ‰€ä»¥æ²¡æœ‰ä¸€å¼€å§‹å°±é€‰ä¸»æˆåŠŸï¼Œè€Œæ˜¯ç­‰äº†å‡ ç§’åæ‰æˆä¸ºleaderï¼Œä¸€æ—¦æˆä¸ºleaderï¼Œå…¨é‡åŒæ­¥serviceä¼šè§¦å‘ä¸€æ¬¡podçš„æ›´æ–°æ“ä½œ</p><p><img src="/2025/03/27/k8s-%E9%80%89%E4%B8%BB-%E5%AE%9E%E6%88%98%E9%AA%8C%E8%AF%81/cf656b2b31af8deecf6f3006945138e9.png" alt="Image 44: åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>â€¢å†å»çœ‹å¦å¤–ä¸¤ä¸ªè¿›ç¨‹çš„æ—¥å¿—ï¼Œå¯è§å·²ç»è¯†åˆ«åˆ°leaderçš„èº«ä»½ï¼Œäºæ˜¯å°±æ²¡æœ‰æ‰§è¡Œcontrollerçš„é€»è¾‘</p><p><img src="/2025/03/27/k8s-%E9%80%89%E4%B8%BB-%E5%AE%9E%E6%88%98%E9%AA%8C%E8%AF%81/aca4a7a4b411ea9367898a8bf8243fe0.png" alt="Image 45: åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>â€¢ç°åœ¨å»ä¿®æ”¹serviceï¼Œç”¨å‘½ä»¤kubectl edit service nginx-service -n client-go-tutorialsç¼–è¾‘ï¼Œæˆ‘è¿™é‡Œæ˜¯ç»™serviceå¢åŠ äº†ä¸€ä¸ªlabelï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="/2025/03/27/k8s-%E9%80%89%E4%B8%BB-%E5%AE%9E%E6%88%98%E9%AA%8C%E8%AF%81/baf02a2ee6822724c9eef9c0afad8fc9.png" alt="Image 46: åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>â€¢æ­¤åˆ»ï¼Œleaderè¿›ç¨‹ä¼šç›‘å¬åˆ°serviceå˜åŒ–ï¼Œä¸‹å›¾é»„è‰²ç®­å¤´ä»¥ä¸‹çš„å†…å®¹å°±æ˜¯å¤„ç†podçš„æ—¥å¿—<br><img src="/2025/03/27/k8s-%E9%80%89%E4%B8%BB-%E5%AE%9E%E6%88%98%E9%AA%8C%E8%AF%81/c9616846888ce5759fb84403e098f77f.png" alt="Image 47: åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>â€¢å»çœ‹å¦å¤–ä¸¤ä¸ªè¿›ç¨‹çš„æ—¥å¿—ï¼Œä¸ä¼šæœ‰ä»»ä½•å˜åŒ–ï¼Œå› ä¸ºcontrolleréƒ½æ²¡æœ‰â€¢æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹podçš„ä¿®æ”¹æƒ…å†µ(æ³¨æ„podçš„åå­—è¦ä»æ‚¨è‡ªå·±çš„ç¯å¢ƒå¤åˆ¶)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">kubectl describe pod nginx-deployment-78f6b696d9-cr47w -n client-go-tutorials<br></code></pre></td></tr></table></figure><p>â€¢å¯ä»¥çœ‹åˆ°podçš„labelæœ‰å˜åŒ–ï¼Œå¦‚ä¸‹å›¾é»„è‰²ç®­å¤´æ‰€ç¤ºï¼Œè¿™å’Œä¸Šé¢çš„leaderæ—¥å¿—çš„æ—¶é—´æ˜¯ä¸€è‡´çš„</p><p><img src="/2025/03/27/k8s-%E9%80%89%E4%B8%BB-%E5%AE%9E%E6%88%98%E9%AA%8C%E8%AF%81/818ef75c8437ca25ac96894630b5b080.png" alt="Image 48: åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>â€¢ç›®å‰leaderè¿›ç¨‹å·¥ä½œæ­£å¸¸ï¼Œå†æ¥è¯•è¯•leaderè¿›ç¨‹é€€å‡ºåçš„æƒ…å†µï¼Œç”¨ctrl+Cç»ˆæ­¢leaderè¿›ç¨‹â€¢å†å»çœ‹å¦å¤–ä¸¤ä¸ªè¿›ç¨‹çš„æ—¥å¿—ï¼Œå‘ç°å…¶ä¸­ä¸€ä¸ªæˆåŠŸæˆä¸ºæ–°çš„leader<br><img src="/2025/03/27/k8s-%E9%80%89%E4%B8%BB-%E5%AE%9E%E6%88%98%E9%AA%8C%E8%AF%81/56e49cc164c374ce25a764dc04a04f50.png" alt="Image 49: åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>â€¢éªŒè¯å®Œæˆï¼Œéƒ½ç¬¦åˆé¢„æœŸâ€¢è‡³æ­¤ï¼Œclient-goçš„é€‰ä¸»åŠŸèƒ½å®æˆ˜å°±å®Œæˆäº†ï¼Œå¦‚æœæ‚¨åœ¨å¯»æ‰¾kubernetesåŸç”Ÿçš„åˆ†å¸ƒå¼é”æ–¹æ¡ˆï¼Œå¸Œæœ›æœ¬ç¯‡èƒ½ç»™æ‚¨ä¸€äº›å‚è€ƒ</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>k8s-é€‰ä¸»</title>
    <link href="/2025/03/27/k8s-%E9%80%89%E4%B8%BB/"/>
    <url>/2025/03/27/k8s-%E9%80%89%E4%B8%BB/</url>
    
    <content type="html"><![CDATA[<h1 id="k8s-é€‰ä¸»"><a href="#k8s-é€‰ä¸»" class="headerlink" title="k8s-é€‰ä¸»"></a>k8s-é€‰ä¸»</h1><p>é€‰ä¸»æ˜¯ä¸ºäº†åœ¨å¤šå‰¯æœ¬çš„æƒ…å†µä¸‹ï¼Œé¿å…åŒä¸€ä¸ªæ“ä½œè¢«æ‰€æœ‰å‰¯æœ¬åˆ†åˆ«æ‰§è¡Œä¸€æ¬¡ï¼ˆå®é™…åªéœ€è¦æ‰§è¡Œä¸€æ¬¡ï¼‰ã€‚</p><p>æ‰€ä»¥å°†åªéœ€è¦æ‰§è¡Œä¸€æ¬¡çš„é€»è¾‘å°è£…è¿›ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨æ‰§è¡Œè¿™ä¸ªå‡½æ•°ä¹‹å‰ï¼Œå…ˆè¿›è¡Œé€‰ä¸»ï¼Œåªæœ‰æˆä¸ºleaderçš„å‰¯æœ¬æ‰ä¼šæ‰§è¡Œè¯¥å‡½æ•°ã€‚</p><p>å®é™…åº”ç”¨ä¸­ï¼Œå¯ä»¥å°†è‡ªå®šä¹‰çš„controlleré€»è¾‘å°è£…èµ·æ¥ï¼Œåªåœ¨é€‰ä¸»æˆåŠŸçš„å‰¯æœ¬é‡Œè¿è¡Œcontrollerã€‚å…¶ä½™çš„å‰¯æœ¬ä»€ä¹ˆä¹Ÿä¸åšï¼Œåªæ˜¯å¾…å‘½è€Œå·²ã€‚è¿™æ ·åœ¨leaderæŒ‚äº†ä¹‹åï¼Œèƒ½å¿«é€Ÿçš„åˆ‡æ¢leaderï¼Œä¿è¯ä¸šåŠ¡é€»è¾‘å¿«é€Ÿæ¢å¤ã€‚</p><p>è½¬è‡ªï¼š<a href="https://qiankunli.github.io/2021/01/13/kubernetes_leader_election.html">https://qiankunli.github.io/2021/01/13/kubernetes_leader_election.html</a></p><p>å‡è®¾run æ˜¯çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘ï¼ŒåŠ å…¥é€‰ä¸»é€»è¾‘ä¹‹åï¼Œå°†runæŒ‚åœ¨ <code>election.RunOrDie</code> çš„ OnStartedLeading å›è°ƒä¸Šã€‚</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs dts">election.RunOrDie(election.LeaderElectionConfig<span class="hljs-punctuation">&#123;</span><br><span class="hljs-symbol">Lock:</span>          rl,<br><span class="hljs-symbol">LeaseDuration:</span> leaseDuration,<br><span class="hljs-symbol">RenewDeadline:</span> renewDuration,<br><span class="hljs-symbol">RetryPeriod:</span>   retryPeriod,<br><span class="hljs-symbol">Callbacks:</span> election.LeaderCallbacks<span class="hljs-punctuation">&#123;</span><br><span class="hljs-symbol">OnStartedLeading:</span> run,<span class="hljs-comment">// ä¸šåŠ¡é€»è¾‘</span><br><span class="hljs-symbol">OnStoppedLeading:</span> func() <span class="hljs-punctuation">&#123;</span><br>log.Fatalf(<span class="hljs-string">&quot;leader election lost&quot;</span>)<br><span class="hljs-punctuation">&#125;</span>,<br><span class="hljs-punctuation">&#125;</span>,<br><span class="hljs-punctuation">&#125;</span>)<br><span class="hljs-comment">// ç¬”è€…è§‰å¾—åº”è¯¥å‡½æ•°å°è£…ä¸‹ï¼Œç›´æ¥ election.RunOrDie(rl,leaseDuration,renewDuration,retryPeriod,run)</span><br></code></pre></td></tr></table></figure><h2 id="é€‰ä¸»åŸç†"><a href="#é€‰ä¸»åŸç†" class="headerlink" title="é€‰ä¸»åŸç†"></a>é€‰ä¸»åŸç†</h2><p><strong>leaderelection ä¸»è¦æ˜¯åˆ©ç”¨äº†k8s APIæ“ä½œçš„åŸå­æ€§å®ç°äº†ä¸€ä¸ªåˆ†å¸ƒå¼é”</strong>ï¼Œåœ¨ä¸æ–­çš„ç«äº‰ä¸­è¿›è¡Œé€‰ä¸¾ã€‚é€‰ä¸­ä¸ºleaderçš„å®ä½“æ‰ä¼šæ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡ä»£ç ã€‚</p><p>ä»£ç ç»“æ„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go">k8s.io/client-<span class="hljs-keyword">go</span>/tools/leaderelection<br>    /resourcelock<br>        /configmaplock.<span class="hljs-keyword">go</span><br>        /endpointslock.<span class="hljs-keyword">go</span><br>        /<span class="hljs-keyword">interface</span>.<span class="hljs-keyword">go</span>  <span class="hljs-comment">// å®šä¹‰äº†é”çš„æ“ä½œæ¥å£</span><br>        /leaselock.<span class="hljs-keyword">go</span><br>    /leaderelection.<span class="hljs-keyword">go</span><br>    /metrics.<span class="hljs-keyword">go</span><br></code></pre></td></tr></table></figure><p><img src="/2025/03/27/k8s-%E9%80%89%E4%B8%BB/leader_election.png" alt="img"></p><h3 id="ä¹è§‚é”"><a href="#ä¹è§‚é”" class="headerlink" title="ä¹è§‚é”"></a>ä¹è§‚é”</h3><p><a href="http://www.xuyasong.com/?p=2037">K8S ä¸­ scheduler ç»„ä»¶çš„é€‰ä¸»é€»è¾‘</a>é”çš„å­˜åœ¨å½¢å¼ï¼šconfigmap&#x2F;endpoint çš„annotation ä¸Šï¼Œkey &#x3D; <code>control-plane.alpha.kubernetes.io/leader</code>ï¼Œ å€¼å¯¹åº”äº† LeaderElectionRecord structï¼Œè®°å½•äº†å½“å‰leader çš„Identity ä»¥åŠrenewTime</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">apiVersion</span>: v1<br><span class="hljs-attribute">kind</span>: Endpoints<br><span class="hljs-attribute">metadata</span>:<br>  <span class="hljs-attribute">annotations</span>:<br>    <span class="hljs-attribute">control</span>-plane.alpha.kubernetes.io/leader: &#x27;&#123;<span class="hljs-string">&quot;holderIdentity&quot;</span>:<span class="hljs-string">&quot;instance-o24xykos-3_1ad55d32-2abe-49f7-9d68-33ec5eadb906&quot;</span>,<span class="hljs-string">&quot;leaseDurationSeconds&quot;</span>:<span class="hljs-number">15</span>,<span class="hljs-string">&quot;acquireTime&quot;</span>:<span class="hljs-string">&quot;2020-04-23T06:45:07Z&quot;</span>,<span class="hljs-string">&quot;renewTime&quot;</span>:<span class="hljs-string">&quot;2020-04-25T07:55:58Z&quot;</span>,<span class="hljs-string">&quot;leaderTransitions&quot;</span>:<span class="hljs-number">1</span>&#125;&#x27;<br>  <span class="hljs-attribute">creationTimestamp</span>: <span class="hljs-string">&quot;2020-04-22T12:05:29Z&quot;</span><br>  <span class="hljs-attribute">name</span>: kube-scheduler<br>  <span class="hljs-attribute">namespace</span>: kube-system<br>  <span class="hljs-attribute">resourceVersion</span>: <span class="hljs-string">&quot;467853&quot;</span><br>  <span class="hljs-attribute">selfLink</span>: /api/v1/namespaces/kube-system/endpoints/kube-scheduler<br>  <span class="hljs-attribute">uid</span>: f3535807-<span class="hljs-number">0575</span>-<span class="hljs-number">483</span>f-<span class="hljs-number">8471</span>-f8d4fd9eeac6<br></code></pre></td></tr></table></figure><p>â€œé”â€å³annotation value è®°å½•äº† leader çš„ä¸€äº›ä¿¡æ¯</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs subunit">&#123;<br>    &quot;holderIdentity&quot;: &quot;instance-o24xykos<span class="hljs-string">-3</span>_1ad55d32<span class="hljs-string">-2</span>abe<span class="hljs-string">-49</span>f7<span class="hljs-string">-9</span>d68<span class="hljs-string">-33</span>ec5eadb906&quot;, <br>    &quot;leaseDurationSeconds&quot;: 15, <br>    &quot;acquireTime&quot;: &quot;2020<span class="hljs-string">-04</span><span class="hljs-string">-23</span>T06:45:07Z&quot;, <br>    &quot;renewTime&quot;: &quot;2020<span class="hljs-string">-04</span><span class="hljs-string">-25</span>T07:55:58Z&quot;, <br>    &quot;leaderTransitions&quot;: 1<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»£ç ä½“ç°</p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs elm">// k8s.io/client-go/tools/leaderelection/resourcelock/interface.go<br><span class="hljs-keyword">type</span> <span class="hljs-type">Interface</span> interface &#123;<br>// <span class="hljs-type">Get</span> returns the <span class="hljs-type">LeaderElectionRecord</span><br><span class="hljs-type">Get</span>() (*<span class="hljs-type">LeaderElectionRecord</span>, error)<br>// <span class="hljs-type">Create</span> attempts to create a <span class="hljs-type">LeaderElectionRecord</span><br><span class="hljs-type">Create</span>(ler <span class="hljs-type">LeaderElectionRecord</span>) error<br>// <span class="hljs-type">Update</span> will update and existing <span class="hljs-type">LeaderElectionRecord</span><br>    <span class="hljs-type">Update</span>(ler <span class="hljs-type">LeaderElectionRecord</span>) error<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>kubernetes çš„ update æ˜¯åŸå­çš„ã€å®‰å…¨çš„</strong>ï¼šKubernetes é€šè¿‡å®šä¹‰èµ„æºç‰ˆæœ¬å­—æ®µå®ç°äº†ä¹è§‚å¹¶å‘æ§åˆ¶ï¼Œèµ„æºç‰ˆæœ¬ (ResourceVersion)å­—æ®µåŒ…å«åœ¨ Kubernetes å¯¹è±¡çš„å…ƒæ•°æ® (Metadata)ä¸­ã€‚è¿™ä¸ªå­—ç¬¦ä¸²æ ¼å¼çš„å­—æ®µæ ‡è¯†äº†å¯¹è±¡çš„å†…éƒ¨ç‰ˆæœ¬å·ï¼Œå…¶å–å€¼æ¥è‡ª etcd çš„ modifiedindexï¼Œä¸”å½“å¯¹è±¡è¢«ä¿®æ”¹æ—¶ï¼Œè¯¥å­—æ®µå°†éšä¹‹è¢«ä¿®æ”¹ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯è¯¥å­—æ®µç”±æœåŠ¡ç«¯ç»´æŠ¤</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-built_in">type</span> ObjectMeta <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">// An opaque value that represents the internal version of this object that can be used by clients to determine when objects have changed. May be used for optimistic concurrency, change detection, and the watch operation on a   resource or set of resources.Clients must treat these values as opaque and passed unmodified   back to the server.They may only be valid for a particular resource or set of resources.</span><br>    <span class="hljs-comment">// Populated by the system.Read-only.</span><br>    ResourceVersion <span class="hljs-keyword">string</span><br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ‰€è°“çš„é€‰ä¸»ï¼Œå°±æ˜¯çœ‹å“ªä¸ªfollowerèƒ½å°†è‡ªå·±çš„ä¿¡æ¯æ›´æ–°åˆ° object çš„annotation ä¸Š</strong>ã€‚</p><h3 id="é€‰ä¸»é€»è¾‘"><a href="#é€‰ä¸»é€»è¾‘" class="headerlink" title="é€‰ä¸»é€»è¾‘"></a>é€‰ä¸»é€»è¾‘</h3><ol><li>leader æ¯éš”RetryPeriodæ—¶é—´ä¼šé€šè¿‡tryAcquireOrRenewç»­çº¦, å¦‚æœç»­çº¦å¤±è´¥, è¿˜ä¼šè¿›è¡Œå†æ¬¡å°è¯•. ä¸€ç›´åˆ°å°è¯•çš„æ€»æ—¶é—´è¶…è¿‡RenewDeadlineåè¯¥clientå°±ä¼šå¤±å»leadership.</li><li>follower è·å¾—leadershipéœ€è¦çš„ç­‰å¾…LeaseDuration æ—¶é—´.</li></ol><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">// client-go/tools/leaderelection/leaderelection.go</span><br>func <span class="hljs-built_in">RunOrDie</span>(ctx context<span class="hljs-selector-class">.Context</span>, lec LeaderElectionConfig) &#123;<br>le, err := <span class="hljs-built_in">NewLeaderElector</span>(lec)<br><span class="hljs-keyword">if</span> err != nil &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br><span class="hljs-keyword">if</span> lec<span class="hljs-selector-class">.WatchDog</span> != nil &#123;<br>lec<span class="hljs-selector-class">.WatchDog</span><span class="hljs-selector-class">.SetLeaderElection</span>(le)<br>&#125;<br>le<span class="hljs-selector-class">.Run</span>(ctx)<br>&#125;<br><span class="hljs-comment">// ç­‰å¾…ï¼Œç›´åˆ°ctx å–æ¶ˆ/æˆä¸ºleaderå†å¤±å»leader åè¿”å›</span><br>func (le *LeaderElector) <span class="hljs-built_in">Run</span>(ctx context.Context) &#123;<br>defer <span class="hljs-built_in">func</span>() &#123;<br>runtime<span class="hljs-selector-class">.HandleCrash</span>()<br>le<span class="hljs-selector-class">.config</span><span class="hljs-selector-class">.Callbacks</span><span class="hljs-selector-class">.OnStoppedLeading</span>()<br>    &#125;()<br>    <span class="hljs-comment">// ç­‰å¾…ï¼Œé™¤éæˆä¸ºleaderï¼ˆè¿”å›trueï¼‰ æˆ–è€…ctx å–æ¶ˆï¼ˆè¿”å›falseï¼‰</span><br><span class="hljs-keyword">if</span> !le<span class="hljs-selector-class">.acquire</span>(ctx) &#123;<br>return <br>&#125;<br>ctx, cancel := context<span class="hljs-selector-class">.WithCancel</span>(ctx)<br>defer <span class="hljs-built_in">cancel</span>()<br>    go le<span class="hljs-selector-class">.config</span><span class="hljs-selector-class">.Callbacks</span><span class="hljs-selector-class">.OnStartedLeading</span>(ctx)<span class="hljs-comment">// æ‰§è¡Œä¸šåŠ¡æ–¹æ³•</span><br>    <span class="hljs-comment">// æˆä¸ºleaderåå‘¨æœŸæ€§ç»­æœŸï¼Œå¦‚æœctx å–æ¶ˆæˆ–å¤±å»leader åˆ™ç«‹å³è¿”å›</span><br>le<span class="hljs-selector-class">.renew</span>(ctx)<br>&#125;<br></code></pre></td></tr></table></figure><p>é€‰ä¸»æ ¸å¿ƒé€»è¾‘</p><ol><li>æ²¡æœ‰lockï¼ŒæŠ¢å &#x2F;Create</li><li>å·²æœ‰lockï¼Œä½†æ˜¯åˆ«äººçš„ï¼Œç§Ÿçº¦æ²¡è¿‡æœŸåˆ™é€€å‡º å†è¯•ï¼Œè¿‡æœŸåˆ™æŠ¢å &#x2F;Update</li><li>å·²æœ‰lockï¼Œè‡ªå·±çš„ï¼Œç»­æœŸ&#x2F;Update</li></ol><p>å‡½æ•°è¿”å› True è¯´æ˜æœ¬ goroutine å·²æˆåŠŸæŠ¢å åˆ°é”ï¼Œè·å¾—ç§Ÿçº¦åˆåŒï¼Œæˆä¸º leader</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(le *LeaderElector)</span></span> tryAcquireOrRenew() <span class="hljs-type">bool</span> &#123;<br>now := metav1.Now()<br>leaderElectionRecord := rl.LeaderElectionRecord&#123;...&#125;<br><span class="hljs-comment">// 1. obtain or create the ElectionRecord</span><br>oldLeaderElectionRecord, err := le.config.Lock.Get()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-comment">// è·å–é”ä¿¡æ¯å¤±è´¥åˆ™ç›´æ¥è¿”å›</span><br><span class="hljs-keyword">if</span> !errors.IsNotFound(err) &#123;<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>&#125;<br>        <span class="hljs-comment">// é”ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œåˆ›å»ºå¤±è´¥åˆ™è¿”å›</span><br><span class="hljs-keyword">if</span> err = le.config.Lock.Create(leaderElectionRecord); err != <span class="hljs-literal">nil</span> &#123;<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>&#125;<br>        <span class="hljs-comment">// åˆ›å»ºlockæˆåŠŸ å³ç¬¬ä¸€æ¬¡é€‰ä¸»æŠ¢å leader æˆåŠŸï¼Œåˆ™è¿”å›</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><span class="hljs-comment">// 2. Record obtained, check the Identity &amp; Time</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(oldLeaderElectionRecord.HolderIdentity) &gt; <span class="hljs-number">0</span> &amp;&amp; le.observedTime.Add(le.config.LeaseDuration).After(now.Time) &amp;&amp;!le.IsLeader() &#123; <span class="hljs-comment">// å…¶ä»–leader æœªè¿‡æœŸ</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-comment">// 3. We&#x27;re going to try to update. The leaderElectionRecord is set to it&#x27;s default</span><br><span class="hljs-comment">// here. Let&#x27;s correct it before updating.</span><br><span class="hljs-keyword">if</span> le.IsLeader() &#123;<br>leaderElectionRecord.AcquireTime = oldLeaderElectionRecord.AcquireTime<br>leaderElectionRecord.LeaderTransitions = oldLeaderElectionRecord.LeaderTransitions<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>leaderElectionRecord.LeaderTransitions = oldLeaderElectionRecord.LeaderTransitions + <span class="hljs-number">1</span><br>&#125;<br><span class="hljs-comment">// update the lock itself</span><br><span class="hljs-keyword">if</span> err = le.config.Lock.Update(leaderElectionRecord); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>    &#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡LeaderCallbacks æ„ŸçŸ¥leader çŠ¶æ€å˜åŒ–ã€‚å›è°ƒOnStartedLeading å’Œ OnNewLeader éƒ½ä¼šå¦èµ·åç¨‹æ‰§è¡Œã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> LeaderCallbacks <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">// OnStartedLeading is called when a LeaderElector client starts leading</span><br>    <span class="hljs-comment">// å½“é€‰ä¸»é€»è¾‘é€€å‡ºæ—¶ï¼Œä¼šé€šè¿‡ context ä¼ ç»™OnStartedLeading</span><br>OnStartedLeading <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(context.Context)</span></span><br><span class="hljs-comment">// OnStoppedLeading is called when a LeaderElector client stops leading</span><br>OnStoppedLeading <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span><br><span class="hljs-comment">// OnNewLeader is called when the client observes a leader that is not the previously observed leader. This includes the first observed leader when the client starts.</span><br>OnNewLeader <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(identity <span class="hljs-type">string</span>)</span></span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="åº”ç”¨ç¤ºä¾‹"><a href="#åº”ç”¨ç¤ºä¾‹" class="headerlink" title="åº”ç”¨ç¤ºä¾‹"></a>åº”ç”¨ç¤ºä¾‹</h2><p>k8s scheduler è°ƒåº¦å™¨çš„æ‰§è¡Œå…¥å£æ˜¯ <code>sched.Run</code></p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-comment">// k8s.io/kubernetes/cmd/kube-scheduler/app/server.go</span><br>func <span class="hljs-keyword">Run</span>(ctx context.Context, <span class="hljs-keyword">cc</span> schedulerserverconfig.CompletedConfig, outOfTreeRegistryOptions ...Option) <span class="hljs-keyword">error</span> &#123;<br>    ...<br>    <span class="hljs-comment">// If leader election is enabled, runCommand via LeaderElector until done and exit.</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">cc</span>.LeaderElection != nil &#123;<br>        <span class="hljs-keyword">cc</span>.LeaderElection.Callbacks = leaderelection.LeaderCallbacks&#123;<br>            OnStartedLeading: sched.<span class="hljs-keyword">Run</span>,    <span class="hljs-comment">// æœ¬èŠ‚ç‚¹æˆä¸ºleaderæ—¶è¿è¡Œ</span><br>            OnStoppedLeading: func() &#123;<br>                klog.Fatalf(<span class="hljs-string">&quot;leaderelection lost&quot;</span>)<br>            &#125;,<br>        &#125;<br>        leaderElector, <span class="hljs-keyword">err</span> := leaderelection.NewLeaderElector(*<span class="hljs-keyword">cc</span>.LeaderElection)<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">err</span> != nil &#123;<br>            <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;couldn&#x27;t create leader elector: %v&quot;</span>, <span class="hljs-keyword">err</span>)<br>        &#125;<br>        leaderElector.<span class="hljs-keyword">Run</span>(ctx)<br>        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;lost lease&quot;</span>)<br>    &#125;<br>    <span class="hljs-comment">// å¦‚æœæœªå¼€å¯é€‰ä¸»</span><br>    sched.<span class="hljs-keyword">Run</span>(ctx)<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;finished without leader elect&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>k8s controller-manager çš„é€‰ä¸»é€»è¾‘</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">// Run runs the KubeControllerManagerOptions.  This should never exit.</span><br>func <span class="hljs-built_in">Run</span>(c *config<span class="hljs-selector-class">.CompletedConfig</span>, stopCh &lt;-chan struct&#123;&#125;) error &#123;<br>    ...<br>    run := <span class="hljs-built_in">func</span>(ctx context.Context) &#123;<br>        ...<br>    &#125;<br>    ...<br>    rl, err := resourcelock<span class="hljs-selector-class">.New</span>(c<span class="hljs-selector-class">.ComponentConfig</span><span class="hljs-selector-class">.Generic</span><span class="hljs-selector-class">.LeaderElection</span><span class="hljs-selector-class">.ResourceLock</span>,...)<br><span class="hljs-keyword">if</span> err != nil &#123;<br>klog<span class="hljs-selector-class">.Fatalf</span>(<span class="hljs-string">&quot;error creating lock: %v&quot;</span>, err)<br>    &#125;<br>    leaderelection<span class="hljs-selector-class">.RunOrDie</span>(context<span class="hljs-selector-class">.TODO</span>(), leaderelection.LeaderElectionConfig&#123;<br>Lock:          rl,<br>LeaseDuration: c<span class="hljs-selector-class">.ComponentConfig</span><span class="hljs-selector-class">.Generic</span><span class="hljs-selector-class">.LeaderElection</span><span class="hljs-selector-class">.LeaseDuration</span><span class="hljs-selector-class">.Duration</span>,<br>RenewDeadline: c<span class="hljs-selector-class">.ComponentConfig</span><span class="hljs-selector-class">.Generic</span><span class="hljs-selector-class">.LeaderElection</span><span class="hljs-selector-class">.RenewDeadline</span><span class="hljs-selector-class">.Duration</span>,<br>RetryPeriod:   c<span class="hljs-selector-class">.ComponentConfig</span><span class="hljs-selector-class">.Generic</span><span class="hljs-selector-class">.LeaderElection</span><span class="hljs-selector-class">.RetryPeriod</span><span class="hljs-selector-class">.Duration</span>,<br>Callbacks: leaderelection.LeaderCallbacks&#123;<br>OnStartedLeading: run,<br>OnStoppedLeading: <span class="hljs-built_in">func</span>() &#123;<br>klog<span class="hljs-selector-class">.Fatalf</span>(<span class="hljs-string">&quot;leaderelection lost&quot;</span>)<br>&#125;,<br>&#125;,<br>WatchDog: electionChecker,<br>Name:     <span class="hljs-string">&quot;kube-controller-manager&quot;</span>,<br>    &#125;)<br>    <span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;unreachable&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>controller-runtime æ˜¯k8s ä¸ºæ”¯æŒè‡ªå®šä¹‰Controller å†™çš„å…¬å…±åº“ï¼Œå…¥å£ä»£ç å³ä¸º<code>Controller.Start</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(cm *controllerManager)</span></span> Start(stop &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;) <span class="hljs-type">error</span> &#123;<br>    ...<br>    <span class="hljs-comment">// å¯åŠ¨ä¸ç”¨é€‰ä¸»çš„ä»»åŠ¡</span><br>    <span class="hljs-keyword">go</span> cm.startNonLeaderElectionRunnables()<br><span class="hljs-keyword">if</span> cm.resourceLock != <span class="hljs-literal">nil</span> &#123; <span class="hljs-comment">// å¦‚æœresourceLock ä¸ä¸ºç©ºï¼Œ è¡¨ç¤ºéœ€è¦é€‰ä¸»ï¼Œå¯åŠ¨é€‰ä¸»é€»è¾‘</span><br>err := cm.startLeaderElection()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<span class="hljs-keyword">return</span> err&#125;<br>&#125; <br>    ...<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(cm *controllerManager)</span></span> startLeaderElection() (err <span class="hljs-type">error</span>) &#123;<br>l, err := leaderelection.NewLeaderElector(leaderelection.LeaderElectionConfig&#123;<br>Lock:          cm.resourceLock,<br>Callbacks: leaderelection.LeaderCallbacks&#123;<br>OnStartedLeading: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(_ context.Context)</span></span> &#123;<br>cm.startLeaderElectionRunnables()   <span class="hljs-comment">// å¯åŠ¨éœ€è¦é€‰ä¸»çš„ä»»åŠ¡</span><br>&#125;,<br>OnStoppedLeading: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>cm.errSignal.SignalError(fmt.Errorf(<span class="hljs-string">&quot;leader election lost&quot;</span>))<br>&#125;,<br>&#125;,<br>&#125;)<br>ctx, cancel := context.WithCancel(context.Background())<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-cm.internalStop:<br>cancel()<br><span class="hljs-keyword">case</span> &lt;-ctx.Done():<br>&#125;<br>&#125;()<br><span class="hljs-comment">// Start the leader elector process</span><br><span class="hljs-keyword">go</span> l.Run(ctx)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä»ç¤ºä¾‹ä¸­å¯ä»¥çœ‹åˆ°</p><ol><li>é€‰ä¸»ä¸€èˆ¬æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œæˆä¸ºleader åå³æ‰§è¡Œæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œæˆ–è€…è¯´ä¸šåŠ¡é€»è¾‘ç”±OnStartedLeading è§¦å‘ã€‚</li><li>å¦‚æœæˆä¸ºleader åå¤±å»leaderï¼Œåˆ™ä¸»åç¨‹æ‰§è¡Œç»“æŸã€‚</li></ol><p>scheduler å’Œ controller-manager éƒ¨ç½²åœ¨å®¹å™¨ä¸­ï¼Œæ‰€ä»¥ä¸»åç¨‹æ‰§è¡Œç»“æŸåï¼Œä¸€èˆ¬ä¼šè‡ªåŠ¨é‡å¯ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>golangå®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹</title>
    <link href="/2025/03/25/golang%E5%AE%9E%E7%8E%B0%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9E%8B/"/>
    <url>/2025/03/25/golang%E5%AE%9E%E7%8E%B0%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="golangå®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹"><a href="#golangå®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹" class="headerlink" title="golangå®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹"></a>golangå®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹</h1><p>ä½¿ç”¨contextå®ç°ä¼˜é›…é€€å‡º</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;context&quot;</span><br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;math/rand&quot;</span><br><span class="hljs-string">&quot;sync&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">producer</span><span class="hljs-params">(ctx context.Context, id <span class="hljs-type">int</span>, jobs <span class="hljs-keyword">chan</span>&lt;- <span class="hljs-type">int</span>)</span></span> &#123;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; ; i++ &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-ctx.Done():<br>fmt.Printf(<span class="hljs-string">&quot;Producer %d exiting\n&quot;</span>, id)<br><span class="hljs-keyword">return</span><br><span class="hljs-keyword">default</span>:<br>time.Sleep(time.Duration(rand.Intn(<span class="hljs-number">500</span>)) * time.Millisecond)<br>job := id*<span class="hljs-number">100</span> + i<br>jobs &lt;- job<br>fmt.Printf(<span class="hljs-string">&quot;Producer %d produced job %d\n&quot;</span>, id, job)<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">consumer</span><span class="hljs-params">(ctx context.Context, id <span class="hljs-type">int</span>, jobs &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)</span></span> &#123;<br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-ctx.Done():<br>fmt.Printf(<span class="hljs-string">&quot;Consumer %d exiting\n&quot;</span>, id)<br><span class="hljs-keyword">return</span><br><span class="hljs-keyword">case</span> job, ok := &lt;-jobs:<br><span class="hljs-keyword">if</span> !ok &#123;<br>fmt.Printf(<span class="hljs-string">&quot;Consumer %d: channel closed\n&quot;</span>, id)<br><span class="hljs-keyword">return</span><br>&#125;<br>time.Sleep(time.Duration(rand.Intn(<span class="hljs-number">1000</span>)) * time.Millisecond)<br>fmt.Printf(<span class="hljs-string">&quot;Consumer %d processed job %d\n&quot;</span>, id, job)<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>rand.Seed(time.Now().UnixNano())<br><br><span class="hljs-keyword">const</span> numProducers = <span class="hljs-number">3</span><br><span class="hljs-keyword">const</span> numConsumers = <span class="hljs-number">2</span><br><br>jobs := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, <span class="hljs-number">10</span>)<br>ctx, cancel := context.WithCancel(context.Background())<br><br><span class="hljs-comment">// å¯åŠ¨ç”Ÿäº§è€…</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt;= numProducers; i++ &#123;<br><span class="hljs-keyword">go</span> producer(ctx, i, jobs)<br>&#125;<br><br><span class="hljs-comment">// å¯åŠ¨æ¶ˆè´¹è€…</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt;= numConsumers; i++ &#123;<br><span class="hljs-keyword">go</span> consumer(ctx, i, jobs)<br>&#125;<br><br><span class="hljs-comment">// è¿è¡Œä¸€æ®µæ—¶é—´ååœæ­¢</span><br>time.Sleep(<span class="hljs-number">5</span> * time.Second)<br>fmt.Println(<span class="hljs-string">&quot;Stopping producers and consumers...&quot;</span>)<br>cancel() <span class="hljs-comment">// å‘é€åœæ­¢ä¿¡å·</span><br><span class="hljs-built_in">close</span>(jobs) <span class="hljs-comment">// å…³é—­channel</span><br><br><span class="hljs-comment">// ç­‰å¾…ä¸€æ®µæ—¶é—´è®©goroutineé€€å‡º</span><br>time.Sleep(<span class="hljs-number">1</span> * time.Second)<br>fmt.Println(<span class="hljs-string">&quot;All done&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Golang GC</title>
    <link href="/2025/03/25/Golang-GC/"/>
    <url>/2025/03/25/Golang-GC/</url>
    
    <content type="html"><![CDATA[<h1 id="Golang-GC"><a href="#Golang-GC" class="headerlink" title="Golang GC"></a>Golang GC</h1><p>è½¬è‡ª: <a href="https://www.yuque.com/aceld/golang/zhzanb">https://www.yuque.com/aceld/golang/zhzanb</a></p><p>æœ¬èŠ‚ä¸ºé‡ç‚¹ç« èŠ‚</p><p><img src="/2025/03/25/Golang-GC/1650786480776-52768cf0-0457-4875-a390-543ed516861f.webp" alt="Image 1: æ ‡é¢˜.jpeg"></p><p>è§†é¢‘é“¾æ¥åœ°å€ï¼š<a href="https://www.bilibili.com/video/BV1wz4y1y7Kd">https://www.bilibili.com/video/BV1wz4y1y7Kd</a></p><p>åƒåœ¾å›æ”¶(Garbage Collectionï¼Œç®€ç§°GC)æ˜¯ç¼–ç¨‹è¯­è¨€ä¸­æä¾›çš„è‡ªåŠ¨çš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œè‡ªåŠ¨é‡Šæ”¾ä¸éœ€è¦çš„å†…å­˜å¯¹è±¡ï¼Œè®©å‡ºå­˜å‚¨å™¨èµ„æºã€‚GCè¿‡ç¨‹ä¸­æ— éœ€ç¨‹åºå‘˜æ‰‹åŠ¨æ‰§è¡Œã€‚GCæœºåˆ¶åœ¨ç°ä»£å¾ˆå¤šç¼–ç¨‹è¯­è¨€éƒ½æ”¯æŒï¼ŒGCèƒ½åŠ›çš„æ€§èƒ½ä¸ä¼˜åŠ£ä¹Ÿæ˜¯ä¸åŒè¯­è¨€ä¹‹é—´å¯¹æ¯”åº¦æŒ‡æ ‡ä¹‹ä¸€ã€‚</p><p>Golangåœ¨GCçš„æ¼”è¿›è¿‡ç¨‹ä¸­ä¹Ÿç»å†äº†å¾ˆå¤šæ¬¡å˜é©ï¼Œæœ¬æ–‡å°†æŒ‰ç…§ä¸€ä¸‹é¡ºåºä»‹ç»ï¼š</p><ul><li>Go V1.3ä¹‹å‰çš„æ ‡è®°-æ¸…é™¤(mark and sweep)ç®—æ³•ï¼Œç¼ºç‚¹</li><li>Go V1.5çš„ä¸‰è‰²å¹¶å‘æ ‡è®°æ³•</li><li>Go V1.5çš„ä¸‰è‰²æ ‡è®°ä¸ºä»€ä¹ˆéœ€è¦STW</li></ul><p>â—Go V1.5çš„ä¸‰è‰²å¹¶å‘æ ‡è®°æ³•<br>â—Go V1.5çš„ä¸‰è‰²æ ‡è®°ä¸ºä»€ä¹ˆéœ€è¦STW<br>â—Go V1.5çš„ä¸‰è‰²æ ‡è®°ä¸ºä»€ä¹ˆéœ€è¦å±éšœæœºåˆ¶(â€œå¼º-å¼±â€ ä¸‰è‰²ä¸å˜å¼ã€æ’å…¥å±éšœã€åˆ é™¤å±éšœ )<br>â—Go V1.8æ··åˆå†™å±éšœæœºåˆ¶<br>â—Go V1.8æ··åˆå†™å±éšœæœºåˆ¶çš„å…¨åœºæ™¯åˆ†æ</p><h2 id="ä¸€ã€Go-V1-3ä¹‹å‰çš„æ ‡è®°-æ¸…é™¤-mark-and-sweep-ç®—æ³•"><a href="#ä¸€ã€Go-V1-3ä¹‹å‰çš„æ ‡è®°-æ¸…é™¤-mark-and-sweep-ç®—æ³•" class="headerlink" title="ä¸€ã€Go V1.3ä¹‹å‰çš„æ ‡è®°-æ¸…é™¤(mark and sweep)ç®—æ³•"></a>ä¸€ã€Go V1.3ä¹‹å‰çš„æ ‡è®°-æ¸…é™¤(mark and sweep)ç®—æ³•</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹åœ¨Golang1.3ä¹‹å‰çš„æ—¶å€™ä¸»è¦ç”¨çš„æ™®é€šçš„æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼Œæ­¤ç®—æ³•ä¸»è¦æœ‰ä¸¤ä¸ªä¸»è¦çš„æ­¥éª¤ï¼š</p><p>â—æ ‡è®°(Mark phase)<br>â—æ¸…é™¤(Sweep phase)</p><p>1 æ ‡è®°æ¸…é™¤ç®—æ³•çš„å…·ä½“æ­¥éª¤</p><p>ç¬¬ä¸€æ­¥ï¼Œæš‚åœç¨‹åºä¸šåŠ¡é€»è¾‘, åˆ†ç±»å‡ºå¯è¾¾å’Œä¸å¯è¾¾çš„å¯¹è±¡ï¼Œç„¶ååšä¸Šæ ‡è®°ã€‚</p><p><img src="/2025/03/25/Golang-GC/1650787873045-d038fe47-4898-4b07-9e16-007bebb6fb9c.webp" alt="Image 2: 44-GC1.png"></p><p>å›¾ä¸­è¡¨ç¤ºæ˜¯ç¨‹åºä¸å¯¹è±¡çš„å¯è¾¾å…³ç³»ï¼Œç›®å‰ç¨‹åºçš„å¯è¾¾å¯¹è±¡æœ‰å¯¹è±¡1-2-3ï¼Œå¯¹è±¡4-7ç­‰äº”ä¸ªå¯¹è±¡ã€‚</p><p>ç¬¬äºŒæ­¥, å¼€å§‹æ ‡è®°ï¼Œç¨‹åºæ‰¾å‡ºå®ƒæ‰€æœ‰å¯è¾¾çš„å¯¹è±¡ï¼Œå¹¶åšä¸Šæ ‡è®°ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/2025/03/25/Golang-GC/1650787891194-883ec541-5f13-4934-9274-080e5f44cf5e.webp" alt="Image 3: 42-GC2.png"></p><p>æ‰€ä»¥å¯¹è±¡1-2-3ã€å¯¹è±¡4-7ç­‰äº”ä¸ªå¯¹è±¡è¢«åšä¸Šæ ‡è®°ã€‚</p><p>ç¬¬ä¸‰æ­¥,  æ ‡è®°å®Œäº†ä¹‹åï¼Œç„¶åå¼€å§‹æ¸…é™¤æœªæ ‡è®°çš„å¯¹è±¡. ç»“æœå¦‚ä¸‹ã€‚</p><p><img src="/2025/03/25/Golang-GC/1650787913616-ecf21ee2-c247-4401-9d3e-5e2fa278726f.webp" alt="Image 4: 45-GC3.png"></p><p>æ“ä½œéå¸¸ç®€å•ï¼Œä½†æ˜¯æœ‰ä¸€ç‚¹éœ€è¦é¢å¤–æ³¨æ„ï¼šmark and sweepç®—æ³•åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œéœ€è¦ç¨‹åºæš‚åœï¼å³ STW(stop the world)ï¼ŒSTWçš„è¿‡ç¨‹ä¸­ï¼ŒCPUä¸æ‰§è¡Œç”¨æˆ·ä»£ç ï¼Œå…¨éƒ¨ç”¨äºåƒåœ¾å›æ”¶ï¼Œè¿™ä¸ªè¿‡ç¨‹çš„å½±å“å¾ˆå¤§ï¼Œæ‰€ä»¥STWä¹Ÿæ˜¯ä¸€äº›å›æ”¶æœºåˆ¶æœ€å¤§çš„éš¾é¢˜å’Œå¸Œæœ›ä¼˜åŒ–çš„ç‚¹ã€‚æ‰€ä»¥åœ¨æ‰§è¡Œç¬¬ä¸‰æ­¥çš„è¿™æ®µæ—¶é—´ï¼Œç¨‹åºä¼šæš‚å®šåœæ­¢ä»»ä½•å·¥ä½œï¼Œå¡åœ¨é‚£ç­‰å¾…å›æ”¶æ‰§è¡Œå®Œæ¯•ã€‚</p><p>ç¬¬å››æ­¥, åœæ­¢æš‚åœï¼Œè®©ç¨‹åºç»§ç»­è·‘ã€‚ç„¶åå¾ªç¯é‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œç›´åˆ°processç¨‹åºç”Ÿå‘½å‘¨æœŸç»“æŸã€‚</p><p>ä»¥ä¸Šä¾¿æ˜¯æ ‡è®°-æ¸…é™¤ï¼ˆmark and sweepï¼‰å›æ”¶çš„ç®—æ³•ã€‚</p><h2 id="äºŒã€-æ ‡è®°-æ¸…é™¤-mark-and-sweep-çš„ç¼ºç‚¹"><a href="#äºŒã€-æ ‡è®°-æ¸…é™¤-mark-and-sweep-çš„ç¼ºç‚¹" class="headerlink" title="äºŒã€ æ ‡è®°-æ¸…é™¤(mark and sweep)çš„ç¼ºç‚¹"></a>äºŒã€ æ ‡è®°-æ¸…é™¤(mark and sweep)çš„ç¼ºç‚¹</h2><p>æ ‡è®°æ¸…é™¤ç®—æ³•æ˜äº†ï¼Œè¿‡ç¨‹é²œæ˜å¹²è„†ï¼Œä½†æ˜¯ä¹Ÿæœ‰éå¸¸ä¸¥é‡çš„é—®é¢˜ã€‚</p><p>â—STWï¼Œstop the worldï¼›è®©ç¨‹åºæš‚åœï¼Œç¨‹åºå‡ºç°å¡é¡¿ (é‡è¦é—®é¢˜)ï¼›<br>â—æ ‡è®°éœ€è¦æ‰«ææ•´ä¸ªheapï¼›<br>â—æ¸…é™¤æ•°æ®ä¼šäº§ç”Ÿheapç¢ç‰‡ã€‚</p><p>Go V1.3ç‰ˆæœ¬ä¹‹å‰å°±æ˜¯ä»¥ä¸Šæ¥å®æ–½çš„,  åœ¨æ‰§è¡ŒGCçš„åŸºæœ¬æµç¨‹å°±æ˜¯é¦–å…ˆå¯åŠ¨STWæš‚åœï¼Œç„¶åæ‰§è¡Œæ ‡è®°ï¼Œå†æ‰§è¡Œæ•°æ®å›æ”¶ï¼Œæœ€ååœæ­¢STWï¼Œå¦‚å›¾æ‰€ç¤ºã€‚</p><p><img src="/2025/03/25/Golang-GC/1650787936233-9002040d-220b-4af6-8e51-75d7887569b4.webp" alt="Image 5: 53-STW1.png"></p><p>ä»ä¸Šå›¾æ¥çœ‹ï¼Œå…¨éƒ¨çš„GCæ—¶é—´éƒ½æ˜¯åŒ…è£¹åœ¨STWèŒƒå›´ä¹‹å†…çš„ï¼Œè¿™æ ·è²Œä¼¼ç¨‹åºæš‚åœçš„æ—¶é—´è¿‡é•¿ï¼Œå½±å“ç¨‹åºçš„è¿è¡Œæ€§èƒ½ã€‚æ‰€ä»¥Go V1.3 åšäº†ç®€å•çš„ä¼˜åŒ–,å°†STWçš„æ­¥éª¤æå‰, å‡å°‘STWæš‚åœçš„æ—¶é—´èŒƒå›´.å¦‚ä¸‹æ‰€ç¤º</p><p><img src="/2025/03/25/Golang-GC/1650788071197-26a29703-0fb5-43f4-afc5-87a35fc78a4b.webp" alt="Image 6: 54-STW2.png"></p><p>ä¸Šå›¾ä¸»è¦æ˜¯å°†STWçš„æ­¥éª¤æå‰äº†ä¸€æ­¥ï¼Œå› ä¸ºåœ¨Sweepæ¸…é™¤çš„æ—¶å€™ï¼Œå¯ä»¥ä¸éœ€è¦STWåœæ­¢ï¼Œå› ä¸ºè¿™äº›å¯¹è±¡å·²ç»æ˜¯ä¸å¯è¾¾å¯¹è±¡äº†ï¼Œä¸ä¼šå‡ºç°å›æ”¶å†™å†²çªç­‰é—®é¢˜ã€‚</p><p>ä½†æ˜¯æ— è®ºæ€ä¹ˆä¼˜åŒ–ï¼ŒGo V1.3éƒ½é¢ä¸´è¿™ä¸ªä¸€ä¸ªé‡è¦é—®é¢˜ï¼Œå°±æ˜¯mark-and-sweep ç®—æ³•ä¼šæš‚åœæ•´ä¸ªç¨‹åº ã€‚</p><p>Goæ˜¯å¦‚ä½•é¢å¯¹å¹¶è¿™ä¸ªé—®é¢˜çš„å‘¢ï¼Ÿæ¥ä¸‹æ¥G V1.5ç‰ˆæœ¬ å°±ç”¨ä¸‰è‰²å¹¶å‘æ ‡è®°æ³•æ¥ä¼˜åŒ–è¿™ä¸ªé—®é¢˜.</p><h2 id="ä¸‰ã€Go-V1-5çš„ä¸‰è‰²å¹¶å‘æ ‡è®°æ³•"><a href="#ä¸‰ã€Go-V1-5çš„ä¸‰è‰²å¹¶å‘æ ‡è®°æ³•" class="headerlink" title="ä¸‰ã€Go V1.5çš„ä¸‰è‰²å¹¶å‘æ ‡è®°æ³•"></a>ä¸‰ã€Go V1.5çš„ä¸‰è‰²å¹¶å‘æ ‡è®°æ³•</h2><p>Golangä¸­çš„åƒåœ¾å›æ”¶ä¸»è¦åº”ç”¨ä¸‰è‰²æ ‡è®°æ³•ï¼ŒGCè¿‡ç¨‹å’Œå…¶ä»–ç”¨æˆ·goroutineå¯å¹¶å‘è¿è¡Œï¼Œä½†éœ€è¦ä¸€å®šæ—¶é—´çš„STW(stop the world)ï¼Œæ‰€è°“ä¸‰è‰²æ ‡è®°æ³•å®é™…ä¸Šå°±æ˜¯é€šè¿‡ä¸‰ä¸ªé˜¶æ®µçš„æ ‡è®°æ¥ç¡®å®šæ¸…æ¥šçš„å¯¹è±¡éƒ½æœ‰å“ªäº›ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…·ä½“çš„è¿‡ç¨‹ã€‚</p><p>ç¬¬ä¸€æ­¥ , æ¯æ¬¡æ–°åˆ›å»ºçš„å¯¹è±¡ï¼Œé»˜è®¤çš„é¢œè‰²éƒ½æ˜¯æ ‡è®°ä¸ºâ€œç™½è‰²â€ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚</p><p><img src="/2025/03/25/Golang-GC/1651035738281-051f7a89-e07f-418c-ad0e-7cb94ef1a3b8.webp" alt="Image 7: 46-GC4.png"></p><p>ä¸Šå›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬çš„ç¨‹åºå¯æŠµè¾¾çš„å†…å­˜å¯¹è±¡å…³ç³»å¦‚å·¦å›¾æ‰€ç¤ºï¼Œå³è¾¹çš„æ ‡è®°è¡¨ï¼Œæ˜¯ç”¨æ¥è®°å½•ç›®å‰æ¯ä¸ªå¯¹è±¡çš„æ ‡è®°é¢œè‰²åˆ†ç±»ã€‚è¿™é‡Œé¢éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ‰€è°“â€œç¨‹åºâ€ï¼Œåˆ™æ˜¯ä¸€äº›å¯¹è±¡çš„æ ¹èŠ‚ç‚¹é›†åˆã€‚æ‰€ä»¥æˆ‘ä»¬å¦‚æœå°†â€œç¨‹åºâ€å±•å¼€ï¼Œä¼šå¾—åˆ°ç±»ä¼¼å¦‚ä¸‹çš„è¡¨ç°å½¢å¼ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚</p><p><img src="/2025/03/25/Golang-GC/1651035821416-b0ad644e-ef8e-440a-bbf4-b9e24a7e0257.webp" alt="Image 8: 47-GC5.jpeg"></p><p>ç¬¬äºŒæ­¥, æ¯æ¬¡GCå›æ”¶å¼€å§‹, ä¼šä»æ ¹èŠ‚ç‚¹å¼€å§‹éå†æ‰€æœ‰å¯¹è±¡ï¼ŒæŠŠéå†åˆ°çš„å¯¹è±¡ä»ç™½è‰²é›†åˆæ”¾å…¥â€œç°è‰²â€é›†åˆå¦‚å›¾æ‰€ç¤ºã€‚</p><p><img src="/2025/03/25/Golang-GC/1651035842467-7341846f-6dee-4f8b-ad37-dc9723aa6407.webp" alt="Image 9: 48-GC6.jpeg"></p><p>è¿™é‡Œ è¦æ³¨æ„çš„æ˜¯ï¼Œæœ¬æ¬¡éå†æ˜¯ä¸€æ¬¡éå†ï¼Œéé€’å½’å½¢å¼ï¼Œæ˜¯ä»ç¨‹åºæŠ½æ¬¡å¯æŠµè¾¾çš„å¯¹è±¡éå†ä¸€å±‚ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå½“å‰å¯æŠµè¾¾çš„å¯¹è±¡æ˜¯å¯¹è±¡1å’Œå¯¹è±¡4ï¼Œé‚£ä¹ˆè‡ªç„¶æœ¬è½®éå†ç»“æŸï¼Œå¯¹è±¡1å’Œå¯¹è±¡4å°±ä¼šè¢«æ ‡è®°ä¸ºç°è‰²ï¼Œç°è‰²æ ‡è®°è¡¨å°±ä¼šå¤šå‡ºè¿™ä¸¤ä¸ªå¯¹è±¡ã€‚</p><p>ç¬¬ä¸‰æ­¥, éå†ç°è‰²é›†åˆï¼Œå°†ç°è‰²å¯¹è±¡å¼•ç”¨çš„å¯¹è±¡ä»ç™½è‰²é›†åˆæ”¾å…¥ç°è‰²é›†åˆï¼Œä¹‹åå°†æ­¤ç°è‰²å¯¹è±¡æ”¾å…¥é»‘è‰²é›†åˆï¼Œå¦‚å›¾æ‰€ç¤ºã€‚</p><p><img src="/2025/03/25/Golang-GC/1651035859950-96053775-24f7-4bdc-a1fb-295747055b3e.webp" alt="Image 10: 49-GC7.jpeg"></p><p>è¿™ä¸€æ¬¡éå†æ˜¯åªæ‰«æç°è‰²å¯¹è±¡ï¼Œå°†ç°è‰²å¯¹è±¡çš„ç¬¬ä¸€å±‚éå†å¯æŠµè¾¾çš„å¯¹è±¡ç”±ç™½è‰²å˜ä¸ºç°è‰²ï¼Œå¦‚ï¼šå¯¹è±¡2ã€å¯¹è±¡7. è€Œä¹‹å‰çš„ç°è‰²å¯¹è±¡1å’Œå¯¹è±¡4åˆ™ä¼šè¢«æ ‡è®°ä¸ºé»‘è‰²ï¼ŒåŒæ—¶ç”±ç°è‰²æ ‡è®°è¡¨ç§»åŠ¨åˆ°é»‘è‰²æ ‡è®°è¡¨ä¸­ã€‚</p><p>ç¬¬å››æ­¥, é‡å¤ç¬¬ä¸‰æ­¥, ç›´åˆ°ç°è‰²ä¸­æ— ä»»ä½•å¯¹è±¡ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚</p><p><img src="/2025/03/25/Golang-GC/1651035907012-927d6cbc-686b-4f81-a1de-097ac7598a8e.webp" alt="Image 11: 50-GC8.jpeg"></p><p><img src="/2025/03/25/Golang-GC/1651035916208-9c293dc0-8988-4180-a9b7-412e2599af0e.webp" alt="Image 12: 51-GC9.jpeg"></p><p>å½“æˆ‘ä»¬å…¨éƒ¨çš„å¯è¾¾å¯¹è±¡éƒ½éå†å®Œåï¼Œç°è‰²æ ‡è®°è¡¨å°†ä¸å†å­˜åœ¨ç°è‰²å¯¹è±¡ï¼Œç›®å‰å…¨éƒ¨å†…å­˜çš„æ•°æ®åªæœ‰ä¸¤ç§é¢œè‰²ï¼Œé»‘è‰²å’Œç™½è‰²ã€‚é‚£ä¹ˆé»‘è‰²å¯¹è±¡å°±æ˜¯æˆ‘ä»¬ç¨‹åºé€»è¾‘å¯è¾¾ï¼ˆéœ€è¦çš„ï¼‰å¯¹è±¡ï¼Œè¿™äº›æ•°æ®æ˜¯ç›®å‰æ”¯æ’‘ç¨‹åºæ­£å¸¸ä¸šåŠ¡è¿è¡Œçš„ï¼Œæ˜¯åˆæ³•çš„æœ‰ç”¨æ•°æ®ï¼Œä¸å¯åˆ é™¤ï¼Œç™½è‰²çš„å¯¹è±¡æ˜¯å…¨éƒ¨ä¸å¯è¾¾å¯¹è±¡ï¼Œç›®å‰ç¨‹åºé€»è¾‘å¹¶ä¸ä¾èµ–ä»–ä»¬ï¼Œé‚£ä¹ˆç™½è‰²å¯¹è±¡å°±æ˜¯å†…å­˜ä¸­ç›®å‰çš„åƒåœ¾æ•°æ®ï¼Œéœ€è¦è¢«æ¸…é™¤ã€‚</p><p>ç¬¬äº”æ­¥: å›æ”¶æ‰€æœ‰çš„ç™½è‰²æ ‡è®°è¡¨çš„å¯¹è±¡. ä¹Ÿå°±æ˜¯å›æ”¶åƒåœ¾ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚ ä»¥ä¸Šæˆ‘ä»¬å°†å…¨éƒ¨çš„ç™½è‰²å¯¹è±¡è¿›è¡Œåˆ é™¤å›æ”¶ï¼Œ</p><p><img src="/2025/03/25/Golang-GC/1651035960263-e50436a6-4a3c-48f9-82cb-bb5729d71116.webp" alt="Image 13: 52-GC10.jpeg"></p><p>å‰©ä¸‹çš„å°±æ˜¯å…¨éƒ¨ä¾èµ–çš„é»‘è‰²å¯¹è±¡ã€‚</p><p>ä»¥ä¸Šä¾¿æ˜¯ä¸‰è‰²å¹¶å‘æ ‡è®°æ³•ï¼Œä¸éš¾çœ‹å‡ºï¼Œæˆ‘ä»¬ä¸Šé¢å·²ç»æ¸…æ¥šçš„ä½“ç°ä¸‰è‰²çš„ç‰¹æ€§ã€‚ä½†æ˜¯è¿™é‡Œé¢å¯èƒ½ä¼šæœ‰å¾ˆå¤šå¹¶å‘æµç¨‹å‡ä¼šè¢«æ‰«æï¼Œæ‰§è¡Œå¹¶å‘æµç¨‹çš„å†…å­˜å¯èƒ½ç›¸äº’ä¾èµ–ï¼Œä¸ºäº†åœ¨GCè¿‡ç¨‹ä¸­ä¿è¯æ•°æ®çš„å®‰å…¨ï¼Œæˆ‘ä»¬åœ¨å¼€å§‹ä¸‰è‰²æ ‡è®°ä¹‹å‰å°±ä¼šåŠ ä¸ŠSTWï¼Œåœ¨æ‰«æç¡®å®šé»‘ç™½å¯¹è±¡ä¹‹åå†æ”¾å¼€STWã€‚ä½†æ˜¯å¾ˆæ˜æ˜¾è¿™æ ·çš„GCæ‰«æçš„æ€§èƒ½å®åœ¨æ˜¯å¤ªä½äº†ã€‚</p><p>é‚£ä¹ˆGoæ˜¯å¦‚ä½•è§£å†³æ ‡è®°-æ¸…é™¤(mark and sweep)ç®—æ³•ä¸­çš„å¡é¡¿(stwï¼Œstop the world)é—®é¢˜çš„å‘¢ï¼Ÿ</p><h2 id="å››ã€æ²¡æœ‰STWçš„ä¸‰è‰²æ ‡è®°æ³•"><a href="#å››ã€æ²¡æœ‰STWçš„ä¸‰è‰²æ ‡è®°æ³•" class="headerlink" title="å››ã€æ²¡æœ‰STWçš„ä¸‰è‰²æ ‡è®°æ³•"></a>å››ã€æ²¡æœ‰STWçš„ä¸‰è‰²æ ‡è®°æ³•</h2><p>å…ˆæŠ›ç –å¼•ç‰ï¼Œæˆ‘ä»¬åŠ å…¥å¦‚æœæ²¡æœ‰STWï¼Œé‚£ä¹ˆä¹Ÿå°±ä¸ä¼šå†å­˜åœ¨æ€§èƒ½ä¸Šçš„é—®é¢˜ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å‡è®¾å¦‚æœä¸‰è‰²æ ‡è®°æ³•ä¸åŠ å…¥STWä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…ï¼Ÿ æˆ‘ä»¬è¿˜æ˜¯åŸºäºä¸Šè¿°çš„ä¸‰è‰²å¹¶å‘æ ‡è®°æ³•æ¥è¯´, ä»–æ˜¯ä¸€å®šè¦ä¾èµ–STWçš„. å› ä¸ºå¦‚æœä¸æš‚åœç¨‹åº, ç¨‹åºçš„é€»è¾‘æ”¹å˜å¯¹è±¡å¼•ç”¨å…³ç³», è¿™ç§åŠ¨ä½œå¦‚æœåœ¨æ ‡è®°é˜¶æ®µåšäº†ä¿®æ”¹ï¼Œä¼šå½±å“æ ‡è®°ç»“æœçš„æ­£ç¡®æ€§ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä¸€ä¸ªåœºæ™¯ï¼Œå¦‚æœä¸‰è‰²æ ‡è®°æ³•, æ ‡è®°è¿‡ç¨‹ä¸ä½¿ç”¨STWå°†ä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…?</p><p>æˆ‘ä»¬æŠŠåˆå§‹çŠ¶æ€è®¾ç½®ä¸ºå·²ç»ç»å†äº†ç¬¬ä¸€è½®æ‰«æï¼Œç›®å‰é»‘è‰²çš„æœ‰å¯¹è±¡1å’Œå¯¹è±¡4ï¼Œ ç°è‰²çš„æœ‰å¯¹è±¡2å’Œå¯¹è±¡7ï¼Œå…¶ä»–çš„ä¸ºç™½è‰²å¯¹è±¡ï¼Œä¸”å¯¹è±¡2æ˜¯é€šè¿‡æŒ‡é’ˆpæŒ‡å‘å¯¹è±¡3çš„ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚</p><p><img src="/2025/03/25/Golang-GC/1651035994109-83972e84-be65-4950-b9bf-a48b676856a5.webp" alt="Image 14: 55-ä¸‰è‰²æ ‡è®°é—®é¢˜1.jpeg"></p><p>ç°åœ¨å¦‚ä½•ä¸‰è‰²æ ‡è®°è¿‡ç¨‹ä¸å¯åŠ¨STWï¼Œé‚£ä¹ˆåœ¨GCæ‰«æè¿‡ç¨‹ä¸­ï¼Œä»»æ„çš„å¯¹è±¡å‡å¯èƒ½å‘ç”Ÿè¯»å†™æ“ä½œï¼Œå¦‚å›¾æ‰€ç¤ºï¼Œåœ¨è¿˜æ²¡æœ‰æ‰«æåˆ°å¯¹è±¡2çš„æ—¶å€™ï¼Œå·²ç»æ ‡è®°ä¸ºé»‘è‰²çš„å¯¹è±¡4ï¼Œæ­¤æ—¶åˆ›å»ºæŒ‡é’ˆqï¼Œå¹¶ä¸”æŒ‡å‘ç™½è‰²çš„å¯¹è±¡3ã€‚</p><p><img src="/2025/03/25/Golang-GC/1651036029588-29e317e6-8f92-41ca-a28e-65153913d227.webp" alt="Image 15: 56-ä¸‰è‰²æ ‡è®°é—®é¢˜2.jpeg"></p><p>ä¸æ­¤åŒæ—¶ç°è‰²çš„å¯¹è±¡2å°†æŒ‡é’ˆpç§»é™¤ï¼Œé‚£ä¹ˆç™½è‰²çš„å¯¹è±¡3å®åˆ™å°±æ˜¯è¢«æŒ‚åœ¨äº†å·²ç»æ‰«æå®Œæˆçš„é»‘è‰²çš„å¯¹è±¡4ä¸‹ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚</p><p><img src="/2025/03/25/Golang-GC/1651036292354-f70d8185-66a2-4478-9036-b4de940285c5.webp" alt="Image 16: 57-ä¸‰è‰²æ ‡è®°é—®é¢˜3.jpeg"></p><p>ç„¶åæˆ‘ä»¬æ­£å¸¸æŒ‡å‘ä¸‰è‰²æ ‡è®°çš„ç®—æ³•é€»è¾‘ï¼Œå°†æ‰€æœ‰ç°è‰²çš„å¯¹è±¡æ ‡è®°ä¸ºé»‘è‰²ï¼Œé‚£ä¹ˆå¯¹è±¡2å’Œå¯¹è±¡7å°±è¢«æ ‡è®°æˆäº†é»‘è‰²ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚</p><p><img src="/2025/03/25/Golang-GC/1651036347628-d63c17c4-7cee-4149-8ce9-13cc11bbd343.webp" alt="Image 17: 58-ä¸‰è‰²æ ‡è®°é—®é¢˜4.jpeg"></p><p>é‚£ä¹ˆå°±æ‰§è¡Œäº†ä¸‰è‰²æ ‡è®°çš„æœ€åä¸€æ­¥ï¼Œå°†æ‰€æœ‰ç™½è‰²å¯¹è±¡å½“åšåƒåœ¾è¿›è¡Œå›æ”¶ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚</p><p><img src="/2025/03/25/Golang-GC/1651036362636-5a98e196-e1cd-49fc-9542-1cb0772a41c4.webp" alt="Image 18: 59-ä¸‰è‰²æ ‡è®°é—®é¢˜5.jpeg"></p><p>ä½†æ˜¯æœ€åæˆ‘ä»¬æ‰å‘ç°ï¼Œæœ¬æ¥æ˜¯å¯¹è±¡4åˆæ³•å¼•ç”¨çš„å¯¹è±¡3ï¼Œå´è¢«GCç»™â€œè¯¯æ€â€å›æ”¶æ‰äº†ã€‚</p><p>å¯ä»¥çœ‹å‡ºï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼Œåœ¨ä¸‰è‰²æ ‡è®°æ³•ä¸­ï¼Œæ˜¯ä¸å¸Œæœ›è¢«å‘ç”Ÿçš„ã€‚</p><p>â—æ¡ä»¶1: ä¸€ä¸ªç™½è‰²å¯¹è±¡è¢«é»‘è‰²å¯¹è±¡å¼•ç”¨(ç™½è‰²è¢«æŒ‚åœ¨é»‘è‰²ä¸‹)<br>â—æ¡ä»¶2: ç°è‰²å¯¹è±¡ä¸å®ƒä¹‹é—´çš„å¯è¾¾å…³ç³»çš„ç™½è‰²å¯¹è±¡é­åˆ°ç ´å(ç°è‰²åŒæ—¶ä¸¢äº†è¯¥ç™½è‰²) å¦‚æœå½“ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶åŒæ—¶æ»¡è¶³æ—¶ï¼Œå°±ä¼šå‡ºç°å¯¹è±¡ä¸¢å¤±ç°è±¡!</p><p>å¹¶ä¸”ï¼Œå¦‚å›¾æ‰€ç¤ºçš„åœºæ™¯ä¸­ï¼Œå¦‚æœç¤ºä¾‹ä¸­çš„ç™½è‰²å¯¹è±¡3è¿˜æœ‰å¾ˆå¤šä¸‹æ¸¸å¯¹è±¡çš„è¯, ä¹Ÿä¼šä¸€å¹¶éƒ½æ¸…ç†æ‰ã€‚</p><p>ä¸ºäº†é˜²æ­¢è¿™ç§ç°è±¡çš„å‘ç”Ÿï¼Œæœ€ç®€å•çš„æ–¹å¼å°±æ˜¯STWï¼Œç›´æ¥ç¦æ­¢æ‰å…¶ä»–ç”¨æˆ·ç¨‹åºå¯¹å¯¹è±¡å¼•ç”¨å…³ç³»çš„å¹²æ‰°ï¼Œä½†æ˜¯STWçš„è¿‡ç¨‹æœ‰æ˜æ˜¾çš„èµ„æºæµªè´¹ï¼Œå¯¹æ‰€æœ‰çš„ç”¨æˆ·ç¨‹åºéƒ½æœ‰å¾ˆå¤§å½±å“ã€‚é‚£ä¹ˆæ˜¯å¦å¯ä»¥åœ¨ä¿è¯å¯¹è±¡ä¸ä¸¢å¤±çš„æƒ…å†µä¸‹åˆç†çš„å°½å¯èƒ½çš„æé«˜GCæ•ˆç‡ï¼Œå‡å°‘STWæ—¶é—´å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œæˆ‘ä»¬åªè¦ä½¿ç”¨ä¸€ç§æœºåˆ¶ï¼Œå°è¯•å»ç ´åä¸Šé¢çš„ä¸¤ä¸ªå¿…è¦æ¡ä»¶å°±å¯ä»¥äº†ã€‚</p><h2 id="äº”ã€å±éšœæœºåˆ¶"><a href="#äº”ã€å±éšœæœºåˆ¶" class="headerlink" title="äº”ã€å±éšœæœºåˆ¶"></a>äº”ã€å±éšœæœºåˆ¶</h2><p>æˆ‘ä»¬è®©GCå›æ”¶å™¨ï¼Œæ»¡è¶³ä¸‹é¢ä¸¤ç§æƒ…å†µä¹‹ä¸€æ—¶ï¼Œå³å¯ä¿å¯¹è±¡ä¸ä¸¢å¤±ã€‚  è¿™ä¸¤ç§æ–¹å¼å°±æ˜¯â€œå¼ºä¸‰è‰²ä¸å˜å¼â€å’Œâ€œå¼±ä¸‰è‰²ä¸å˜å¼â€ã€‚</p><p>(1) â€œå¼º-å¼±â€ ä¸‰è‰²ä¸å˜å¼</p><p>â—å¼ºä¸‰è‰²ä¸å˜å¼</p><p>ä¸å­˜åœ¨é»‘è‰²å¯¹è±¡å¼•ç”¨åˆ°ç™½è‰²å¯¹è±¡çš„æŒ‡é’ˆã€‚</p><p><img src="/2025/03/25/Golang-GC/1651036383192-cb6b9fe9-4946-47da-bb9a-643f0c38a654.webp" alt="Image 19: 60-ä¸‰è‰²æ ‡è®°é—®é¢˜6.jpeg"></p><p>å¼ºä¸‰è‰²ä¸å˜è‰²å®é™…ä¸Šæ˜¯å¼ºåˆ¶æ€§çš„ä¸å…è®¸é»‘è‰²å¯¹è±¡å¼•ç”¨ç™½è‰²å¯¹è±¡ï¼Œè¿™æ ·å°±ä¸ä¼šå‡ºç°æœ‰ç™½è‰²å¯¹è±¡è¢«è¯¯åˆ çš„æƒ…å†µã€‚</p><p>â—å¼±ä¸‰è‰²ä¸å˜å¼</p><p>æ‰€æœ‰è¢«é»‘è‰²å¯¹è±¡å¼•ç”¨çš„ç™½è‰²å¯¹è±¡éƒ½å¤„äºç°è‰²ä¿æŠ¤çŠ¶æ€ã€‚</p><p><img src="/2025/03/25/Golang-GC/1651036404003-e0ea569e-7a8a-4d9f-a08f-4bb9ed5c64ed.webp" alt="Image 20: 61-ä¸‰è‰²æ ‡è®°é—®é¢˜7.jpeg"></p><p>å¼±ä¸‰è‰²ä¸å˜å¼å¼ºè°ƒï¼Œé»‘è‰²å¯¹è±¡å¯ä»¥å¼•ç”¨ç™½è‰²å¯¹è±¡ï¼Œä½†æ˜¯è¿™ä¸ªç™½è‰²å¯¹è±¡å¿…é¡»å­˜åœ¨å…¶ä»–ç°è‰²å¯¹è±¡å¯¹å®ƒçš„å¼•ç”¨ï¼Œæˆ–è€…å¯è¾¾å®ƒçš„é“¾è·¯ä¸Šæ¸¸å­˜åœ¨ç°è‰²å¯¹è±¡ã€‚ è¿™æ ·å®åˆ™æ˜¯é»‘è‰²å¯¹è±¡å¼•ç”¨ç™½è‰²å¯¹è±¡ï¼Œç™½è‰²å¯¹è±¡å¤„äºä¸€ä¸ªå±é™©è¢«åˆ é™¤çš„çŠ¶æ€ï¼Œä½†æ˜¯ä¸Šæ¸¸ç°è‰²å¯¹è±¡çš„å¼•ç”¨ï¼Œå¯ä»¥ä¿æŠ¤è¯¥ç™½è‰²å¯¹è±¡ï¼Œä½¿å…¶å®‰å…¨ã€‚</p><p>ä¸ºäº†éµå¾ªä¸Šè¿°çš„ä¸¤ä¸ªæ–¹å¼ï¼ŒGCç®—æ³•æ¼”è¿›åˆ°ä¸¤ç§å±éšœæ–¹å¼ï¼Œä»–ä»¬â€œæ’å…¥å±éšœâ€, â€œåˆ é™¤å±éšœâ€ã€‚</p><p>(2)  æ’å…¥å±éšœ</p><p>å…·ä½“æ“ä½œ: åœ¨Aå¯¹è±¡å¼•ç”¨Bå¯¹è±¡çš„æ—¶å€™ï¼ŒBå¯¹è±¡è¢«æ ‡è®°ä¸ºç°è‰²ã€‚(å°†BæŒ‚åœ¨Aä¸‹æ¸¸ï¼ŒBå¿…é¡»è¢«æ ‡è®°ä¸ºç°è‰²)</p><p>æ»¡è¶³: å¼ºä¸‰è‰²ä¸å˜å¼. (ä¸å­˜åœ¨é»‘è‰²å¯¹è±¡å¼•ç”¨ç™½è‰²å¯¹è±¡çš„æƒ…å†µäº†ï¼Œ å› ä¸ºç™½è‰²ä¼šå¼ºåˆ¶å˜æˆç°è‰²)</p><p>ä¼ªç å¦‚ä¸‹:</p><p>åœºæ™¯ï¼š</p><p>è¿™æ®µä¼ªç é€»è¾‘å°±æ˜¯å†™å±éšœ,. æˆ‘ä»¬çŸ¥é“,é»‘è‰²å¯¹è±¡çš„å†…å­˜æ§½æœ‰ä¸¤ç§ä½ç½®, æ ˆå’Œå †. æ ˆç©ºé—´çš„ç‰¹ç‚¹æ˜¯å®¹é‡å°,ä½†æ˜¯è¦æ±‚ç›¸åº”é€Ÿåº¦å¿«,å› ä¸ºå‡½æ•°è°ƒç”¨å¼¹å‡ºé¢‘ç¹ä½¿ç”¨, æ‰€ä»¥â€œæ’å…¥å±éšœâ€æœºåˆ¶,åœ¨æ ˆç©ºé—´çš„å¯¹è±¡æ“ä½œä¸­ä¸ä½¿ç”¨. è€Œä»…ä»…ä½¿ç”¨åœ¨å †ç©ºé—´å¯¹è±¡çš„æ“ä½œä¸­.</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç”¨å‡ å¼ å›¾ï¼Œæ¥æ¨¡æ‹Ÿæ•´ä¸ªä¸€ä¸ªè¯¦ç»†çš„è¿‡ç¨‹ï¼Œ å¸Œæœ›æ‚¨èƒ½å¤Ÿæ›´å¯è§‚çš„çœ‹æ¸…æ™°æ•´ä½“æµç¨‹ã€‚</p><p><img src="/2025/03/25/Golang-GC/1651036442131-91f36e55-5c94-4931-a140-58ff5627c681.webp" alt="Image 21: 62-ä¸‰è‰²æ ‡è®°æ’å…¥å†™å±éšœ1.jpeg"></p><p><img src="/2025/03/25/Golang-GC/1651036449149-2fb53d7c-d351-4305-84a8-7a1b51806ce4.webp" alt="Image 22: 63-ä¸‰è‰²æ ‡è®°æ’å…¥å†™å±éšœ2.jpeg"></p><p><img src="/2025/03/25/Golang-GC/1651036456806-6b1aeb27-831d-43d9-a79e-4dad49fea07d.webp" alt="Image 23: 64-ä¸‰è‰²æ ‡è®°æ’å…¥å†™å±éšœ3.jpeg"></p><p><img src="/2025/03/25/Golang-GC/1651036465710-e260440e-b53d-4f76-a826-842e28666efe.webp" alt="Image 24: 65-ä¸‰è‰²æ ‡è®°æ’å…¥å†™å±éšœ4.jpeg"></p><p><img src="/2025/03/25/Golang-GC/1651036474130-755abe1f-d070-47e6-93cf-7aa129489206.webp" alt="Image 25: 66-ä¸‰è‰²æ ‡è®°æ’å…¥å†™å±éšœ5.jpeg"></p><p><img src="/2025/03/25/Golang-GC/1651036481384-c4e44929-09e4-4a05-81bb-b5e9ed195982.webp" alt="Image 26: 67-ä¸‰è‰²æ ‡è®°æ’å…¥å†™å±éšœ6.jpeg"></p><p>ä½†æ˜¯å¦‚æœæ ˆä¸æ·»åŠ ,å½“å…¨éƒ¨ä¸‰è‰²æ ‡è®°æ‰«æä¹‹å,æ ˆä¸Šæœ‰å¯èƒ½ä¾ç„¶å­˜åœ¨ç™½è‰²å¯¹è±¡è¢«å¼•ç”¨çš„æƒ…å†µ(å¦‚ä¸Šå›¾çš„å¯¹è±¡9).  æ‰€ä»¥è¦å¯¹æ ˆé‡æ–°è¿›è¡Œä¸‰è‰²æ ‡è®°æ‰«æ, ä½†è¿™æ¬¡ä¸ºäº†å¯¹è±¡ä¸ä¸¢å¤±, è¦å¯¹æœ¬æ¬¡æ ‡è®°æ‰«æå¯åŠ¨STWæš‚åœ. ç›´åˆ°æ ˆç©ºé—´çš„ä¸‰è‰²æ ‡è®°ç»“æŸ.</p><p><img src="/2025/03/25/Golang-GC/1651036522462-5e0c1ea9-e136-45c8-9648-bf691b270431.webp" alt="Image 27: 68-ä¸‰è‰²æ ‡è®°æ’å…¥å†™å±éšœ7.jpeg"></p><p><img src="/2025/03/25/Golang-GC/1651036531031-d37d4239-9b13-4d0e-a9cc-d7bc230d56a8.webp" alt="Image 28: 69-ä¸‰è‰²æ ‡è®°æ’å…¥å†™å±éšœ9.jpeg"></p><p><img src="/2025/03/25/Golang-GC/1651036538543-d84895c0-451d-4c49-9c67-f77dcf5a3ae9.webp" alt="Image 29: 70-ä¸‰è‰²æ ‡è®°æ’å…¥å†™å±éšœ10.jpeg"></p><p>æœ€åå°†æ ˆå’Œå †ç©ºé—´ æ‰«æå‰©ä½™çš„å…¨éƒ¨ ç™½è‰²èŠ‚ç‚¹æ¸…é™¤.  è¿™æ¬¡STWå¤§çº¦çš„æ—¶é—´åœ¨10~100msé—´.</p><p><img src="/2025/03/25/Golang-GC/1651036559017-4564c417-9059-415c-aa81-d9504ac4e00b.webp" alt="Image 30: 71-ä¸‰è‰²æ ‡è®°æ’å…¥å†™å±éšœ11.jpeg"></p><p>(3)  åˆ é™¤å±éšœ</p><p>å…·ä½“æ“ä½œ: è¢«åˆ é™¤çš„å¯¹è±¡ï¼Œå¦‚æœè‡ªèº«ä¸ºç°è‰²æˆ–è€…ç™½è‰²ï¼Œé‚£ä¹ˆè¢«æ ‡è®°ä¸ºç°è‰²ã€‚</p><p>æ»¡è¶³: å¼±ä¸‰è‰²ä¸å˜å¼. (ä¿æŠ¤ç°è‰²å¯¹è±¡åˆ°ç™½è‰²å¯¹è±¡çš„è·¯å¾„ä¸ä¼šæ–­)</p><p>ä¼ªä»£ç ï¼š</p><p>åœºæ™¯ï¼š</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç”¨å‡ å¼ å›¾ï¼Œæ¥æ¨¡æ‹Ÿæ•´ä¸ªä¸€ä¸ªè¯¦ç»†çš„è¿‡ç¨‹ï¼Œ å¸Œæœ›æ‚¨èƒ½å¤Ÿæ›´å¯è§‚çš„çœ‹æ¸…æ™°æ•´ä½“æµç¨‹ã€‚</p><p><img src="/2025/03/25/Golang-GC/1651036621717-80ea507c-99a9-4e61-9bde-b4cd33f478f4.webp" alt="Image 31: 72-ä¸‰è‰²æ ‡è®°åˆ é™¤å†™å±éšœ1.jpeg"></p><p><img src="/2025/03/25/Golang-GC/1651036629775-bc69d08e-c270-46ad-b82b-5ad0d0bdcb64.webp" alt="Image 32: 73-ä¸‰è‰²æ ‡è®°åˆ é™¤å†™å±éšœ2.jpeg"></p><p><img src="/2025/03/25/Golang-GC/1651036637089-52a0fc99-7805-40d0-aee7-4124017e90c8.webp" alt="Image 33: 74-ä¸‰è‰²æ ‡è®°åˆ é™¤å†™å±éšœ3.jpeg"></p><p><img src="/2025/03/25/Golang-GC/1651036644794-05a69ec6-70c9-44c7-9493-44028ba4df7f.webp" alt="Image 34: 75-ä¸‰è‰²æ ‡è®°åˆ é™¤å†™å±éšœ4.jpeg"></p><p><img src="/2025/03/25/Golang-GC/1651036653171-57e34942-2091-4d76-83f3-0b084ebd577d.webp" alt="Image 35: 76-ä¸‰è‰²æ ‡è®°åˆ é™¤å†™å±éšœ5.jpeg"></p><p><img src="/2025/03/25/Golang-GC/1651036660503-4f49f494-8ede-45dd-8a4c-bfa5499b307a.webp" alt="Image 36: 77-ä¸‰è‰²æ ‡è®°åˆ é™¤å†™å±éšœ6.jpeg"></p><p><img src="/2025/03/25/Golang-GC/1651036668136-8592bd0f-2210-48d9-b43d-7c4a2e16a287.webp" alt="Image 37: 78-ä¸‰è‰²æ ‡è®°åˆ é™¤å†™å±éšœ7.jpeg"></p><p>è¿™ç§æ–¹å¼çš„å›æ”¶ç²¾åº¦ä½ï¼Œä¸€ä¸ªå¯¹è±¡å³ä½¿è¢«åˆ é™¤äº†æœ€åä¸€ä¸ªæŒ‡å‘å®ƒçš„æŒ‡é’ˆä¹Ÿä¾æ—§å¯ä»¥æ´»è¿‡è¿™ä¸€è½®ï¼Œåœ¨ä¸‹ä¸€è½®GCä¸­è¢«æ¸…ç†æ‰ã€‚</p><h2 id="å…­ã€Go-V1-8çš„æ··åˆå†™å±éšœ-hybrid-write-barrier-æœºåˆ¶"><a href="#å…­ã€Go-V1-8çš„æ··åˆå†™å±éšœ-hybrid-write-barrier-æœºåˆ¶" class="headerlink" title="å…­ã€Go V1.8çš„æ··åˆå†™å±éšœ(hybrid write barrier)æœºåˆ¶"></a>å…­ã€Go V1.8çš„æ··åˆå†™å±éšœ(hybrid write barrier)æœºåˆ¶</h2><p>æ’å…¥å†™å±éšœå’Œåˆ é™¤å†™å±éšœçš„çŸ­æ¿ï¼š</p><p>â— æ’å…¥å†™å±éšœï¼šç»“æŸæ—¶éœ€è¦STWæ¥é‡æ–°æ‰«ææ ˆï¼Œæ ‡è®°æ ˆä¸Šå¼•ç”¨çš„ç™½è‰²å¯¹è±¡çš„å­˜æ´»ï¼›â— åˆ é™¤å†™å±éšœï¼šå›æ”¶ç²¾åº¦ä½ï¼ŒGCå¼€å§‹æ—¶STWæ‰«æå †æ ˆæ¥è®°å½•åˆå§‹å¿«ç…§ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šä¿æŠ¤å¼€å§‹æ—¶åˆ»çš„æ‰€æœ‰å­˜æ´»å¯¹è±¡ã€‚<br>Go V1.8ç‰ˆæœ¬å¼•å…¥äº†æ··åˆå†™å±éšœæœºåˆ¶ï¼ˆhybrid write barrierï¼‰ï¼Œé¿å…äº†å¯¹æ ˆre-scançš„è¿‡ç¨‹ï¼Œæå¤§çš„å‡å°‘äº†STWçš„æ—¶é—´ã€‚ç»“åˆäº†ä¸¤è€…çš„ä¼˜ç‚¹ã€‚<br>(1) æ··åˆå†™å±éšœè§„åˆ™</p><p>å…·ä½“æ“ä½œ:</p><p>1ã€GCå¼€å§‹å°†æ ˆä¸Šçš„å¯¹è±¡å…¨éƒ¨æ‰«æå¹¶æ ‡è®°ä¸ºé»‘è‰²(ä¹‹åä¸å†è¿›è¡Œç¬¬äºŒæ¬¡é‡å¤æ‰«æï¼Œæ— éœ€STW)ï¼Œ</p><p>2ã€GCæœŸé—´ï¼Œä»»ä½•åœ¨æ ˆä¸Šåˆ›å»ºçš„æ–°å¯¹è±¡ï¼Œå‡ä¸ºé»‘è‰²ã€‚</p><p>3ã€è¢«åˆ é™¤çš„å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ã€‚</p><p>4ã€è¢«æ·»åŠ çš„å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ã€‚</p><p>æ»¡è¶³: å˜å½¢çš„å¼±ä¸‰è‰²ä¸å˜å¼.</p><p>ä¼ªä»£ç ï¼š</p><p>è¿™é‡Œæˆ‘ä»¬æ³¨æ„ï¼Œ å±éšœæŠ€æœ¯æ˜¯ä¸åœ¨æ ˆä¸Šåº”ç”¨çš„ï¼Œå› ä¸ºè¦ä¿è¯æ ˆçš„è¿è¡Œæ•ˆç‡ã€‚</p><p>(2) æ··åˆå†™å±éšœçš„å…·ä½“åœºæ™¯åˆ†æ</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç”¨å‡ å¼ å›¾ï¼Œæ¥æ¨¡æ‹Ÿæ•´ä¸ªä¸€ä¸ªè¯¦ç»†çš„è¿‡ç¨‹ï¼Œ å¸Œæœ›æ‚¨èƒ½å¤Ÿæ›´å¯è§‚çš„çœ‹æ¸…æ™°æ•´ä½“æµç¨‹ã€‚</p><p>æ³¨æ„æ··åˆå†™å±éšœæ˜¯Gcçš„ä¸€ç§å±éšœæœºåˆ¶ï¼Œæ‰€ä»¥åªæ˜¯å½“ç¨‹åºæ‰§è¡ŒGCçš„æ—¶å€™ï¼Œæ‰ä¼šè§¦å‘è¿™ç§æœºåˆ¶ã€‚</p><p>GCå¼€å§‹ï¼šæ‰«ææ ˆåŒºï¼Œå°†å¯è¾¾å¯¹è±¡å…¨éƒ¨æ ‡è®°ä¸ºé»‘</p><p><img src="/2025/03/25/Golang-GC/1651036708530-f7c50de5-6a63-45dc-baef-f53b1b42eb62.webp" alt="Image 38: 79-ä¸‰è‰²æ ‡è®°æ··åˆå†™å±éšœ1.jpeg"></p><p><img src="/2025/03/25/Golang-GC/1651036716310-65729a9c-d8df-40ce-9c2b-d35228278791.webp" alt="Image 39: 80-ä¸‰è‰²æ ‡è®°æ··åˆå†™å±éšœ2.jpeg"></p><p>åœºæ™¯ä¸€ï¼š å¯¹è±¡è¢«ä¸€ä¸ªå †å¯¹è±¡åˆ é™¤å¼•ç”¨ï¼Œæˆä¸ºæ ˆå¯¹è±¡çš„ä¸‹æ¸¸</p><p>ä¼ªä»£ç </p><p><img src="/2025/03/25/Golang-GC/1651036737874-a2f71441-c4f9-4f74-8c8a-c5a53bd35d4c.webp" alt="Image 40: 81-ä¸‰è‰²æ ‡è®°æ··åˆå†™å±éšœ3.jpeg"></p><p><img src="/2025/03/25/Golang-GC/1651036745104-24b7bf17-27b9-4531-97b7-48c5b7e64fac.webp" alt="Image 41: 82-ä¸‰è‰²æ ‡è®°æ··åˆå†™å±éšœ4.jpeg"></p><p>åœºæ™¯äºŒï¼š å¯¹è±¡è¢«ä¸€ä¸ªæ ˆå¯¹è±¡åˆ é™¤å¼•ç”¨ï¼Œæˆä¸ºå¦ä¸€ä¸ªæ ˆå¯¹è±¡çš„ä¸‹æ¸¸</p><p>ä¼ªä»£ç </p><p><img src="/2025/03/25/Golang-GC/1651036778055-bda31c21-45dc-4602-9241-11a33b6393a6.webp" alt="Image 42: 83-ä¸‰è‰²æ ‡è®°æ··åˆå†™å±éšœ5.jpeg"></p><p><img src="/2025/03/25/Golang-GC/1651036785024-0edb665e-7b4b-46e3-b8cf-1d4ff02e73cd.webp" alt="Image 43: 84-ä¸‰è‰²æ ‡è®°æ··åˆå†™å±éšœ6.jpeg"></p><p><img src="/2025/03/25/Golang-GC/1651036791814-78eed337-a9ac-42d9-bcd8-99a21c01111c.webp" alt="Image 44: 85-ä¸‰è‰²æ ‡è®°æ··åˆå†™å±éšœ7.jpeg"></p><p>åœºæ™¯ä¸‰ï¼šå¯¹è±¡è¢«ä¸€ä¸ªå †å¯¹è±¡åˆ é™¤å¼•ç”¨ï¼Œæˆä¸ºå¦ä¸€ä¸ªå †å¯¹è±¡çš„ä¸‹æ¸¸</p><p>ä¼ªä»£ç </p><p><img src="/2025/03/25/Golang-GC/1651036826144-893174fb-0111-4838-9f7d-38fe2f89648a.webp" alt="Image 45: 86-ä¸‰è‰²æ ‡è®°æ··åˆå†™å±éšœ8.jpeg"></p><p><img src="/2025/03/25/Golang-GC/1651036833484-a18064d9-1329-42d7-8687-8a029542e85e.webp" alt="Image 46: 87-ä¸‰è‰²æ ‡è®°æ··åˆå†™å±éšœ9.jpeg"></p><p><img src="/2025/03/25/Golang-GC/1651036840569-f50df9db-5219-48fe-83ff-c3545ed4dec4.webp" alt="Image 47: 88-ä¸‰è‰²æ ‡è®°æ··åˆå†™å±éšœ10.jpeg"></p><p>åœºæ™¯å››ï¼šå¯¹è±¡ä»ä¸€ä¸ªæ ˆå¯¹è±¡åˆ é™¤å¼•ç”¨ï¼Œæˆä¸ºå¦ä¸€ä¸ªå †å¯¹è±¡çš„ä¸‹æ¸¸</p><p>ä¼ªä»£ç </p><p><img src="/2025/03/25/Golang-GC/1651036859560-21a75ea4-ee66-46ae-81bc-ce4e697c3814.webp" alt="Image 48: 89-ä¸‰è‰²æ ‡è®°æ··åˆå†™å±éšœ11.jpeg"></p><p><img src="/2025/03/25/Golang-GC/1651036864959-929ec428-e8d8-48a9-aaeb-e2589723ec62.webp" alt="Image 49: 90-ä¸‰è‰²æ ‡è®°æ··åˆå†™å±éšœ12.jpeg"></p><p><img src="/2025/03/25/Golang-GC/1651036876957-976a0ac6-6c82-4eca-88f3-10180782281c.webp" alt="Image 50: 91-ä¸‰è‰²æ ‡è®°æ··åˆå†™å±éšœ13.jpeg"></p><p>Golangä¸­çš„æ··åˆå†™å±éšœæ»¡è¶³å¼±ä¸‰è‰²ä¸å˜å¼ï¼Œç»“åˆäº†åˆ é™¤å†™å±éšœå’Œæ’å…¥å†™å±éšœçš„ä¼˜ç‚¹ï¼Œåªéœ€è¦åœ¨å¼€å§‹æ—¶å¹¶å‘æ‰«æå„ä¸ªgoroutineçš„æ ˆï¼Œä½¿å…¶å˜é»‘å¹¶ä¸€ç›´ä¿æŒï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸éœ€è¦STWï¼Œè€Œæ ‡è®°ç»“æŸåï¼Œå› ä¸ºæ ˆåœ¨æ‰«æåå§‹ç»ˆæ˜¯é»‘è‰²çš„ï¼Œä¹Ÿæ— éœ€å†è¿›è¡Œre-scanæ“ä½œäº†ï¼Œå‡å°‘äº†STWçš„æ—¶é—´ã€‚</p><h2 id="ä¸ƒã€æ€»ç»“"><a href="#ä¸ƒã€æ€»ç»“" class="headerlink" title="ä¸ƒã€æ€»ç»“"></a>ä¸ƒã€æ€»ç»“</h2><p>ä»¥ä¸Šä¾¿æ˜¯Golangçš„GCå…¨éƒ¨çš„æ ‡è®°-æ¸…é™¤é€»è¾‘åŠåœºæ™¯æ¼”ç¤ºå…¨è¿‡ç¨‹ã€‚</p><p>GoV1.3- æ™®é€šæ ‡è®°æ¸…é™¤æ³•ï¼Œæ•´ä½“è¿‡ç¨‹éœ€è¦å¯åŠ¨STWï¼Œæ•ˆç‡æä½ã€‚</p><p>GoV1.5- ä¸‰è‰²æ ‡è®°æ³•ï¼Œ å †ç©ºé—´å¯åŠ¨å†™å±éšœï¼Œæ ˆç©ºé—´ä¸å¯åŠ¨ï¼Œå…¨éƒ¨æ‰«æä¹‹åï¼Œéœ€è¦é‡æ–°æ‰«æä¸€æ¬¡æ ˆ(éœ€è¦STW)ï¼Œæ•ˆç‡æ™®é€š</p><p>GoV1.8-ä¸‰è‰²æ ‡è®°æ³•ï¼Œæ··åˆå†™å±éšœæœºåˆ¶ï¼Œ æ ˆç©ºé—´ä¸å¯åŠ¨ï¼Œå †ç©ºé—´å¯åŠ¨ã€‚æ•´ä¸ªè¿‡ç¨‹å‡ ä¹ä¸éœ€è¦STWï¼Œæ•ˆç‡è¾ƒé«˜ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ä½ è§‰å¾—æ€ä¹ˆæ ·æ‰æ˜¯å¥½äº§å“</title>
    <link href="/2025/03/25/%E4%BD%A0%E8%A7%89%E5%BE%97%E6%80%8E%E4%B9%88%E6%A0%B7%E6%89%8D%E6%98%AF%E5%A5%BD%E4%BA%A7%E5%93%81/"/>
    <url>/2025/03/25/%E4%BD%A0%E8%A7%89%E5%BE%97%E6%80%8E%E4%B9%88%E6%A0%B7%E6%89%8D%E6%98%AF%E5%A5%BD%E4%BA%A7%E5%93%81/</url>
    
    <content type="html"><![CDATA[<h1 id="å¦‚ä½•å›ç­”â€ä½ è§‰å¾—æ€ä¹ˆæ ·æ‰æ˜¯å¥½äº§å“â€çš„é¢è¯•é—®é¢˜"><a href="#å¦‚ä½•å›ç­”â€ä½ è§‰å¾—æ€ä¹ˆæ ·æ‰æ˜¯å¥½äº§å“â€çš„é¢è¯•é—®é¢˜" class="headerlink" title="å¦‚ä½•å›ç­”â€ä½ è§‰å¾—æ€ä¹ˆæ ·æ‰æ˜¯å¥½äº§å“â€çš„é¢è¯•é—®é¢˜"></a>å¦‚ä½•å›ç­”â€ä½ è§‰å¾—æ€ä¹ˆæ ·æ‰æ˜¯å¥½äº§å“â€çš„é¢è¯•é—®é¢˜</h1><p>åœ¨ç¨‹åºå‘˜é¢è¯•ä¸­è¢«é—®åˆ°â€ä½ è§‰å¾—æ€ä¹ˆæ ·æ‰æ˜¯å¥½äº§å“â€æ—¶ï¼Œè¿™æ˜¯ä¸€ä¸ªå±•ç¤ºä½ æŠ€æœ¯æ€ç»´ä¸äº§å“æ€ç»´ç»“åˆèƒ½åŠ›çš„å¥½æœºä¼šã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç»“æ„åŒ–çš„å›ç­”æ¡†æ¶ï¼š</p><h2 id="1-ä»ç”¨æˆ·è§’åº¦å‡ºå‘"><a href="#1-ä»ç”¨æˆ·è§’åº¦å‡ºå‘" class="headerlink" title="1. ä»ç”¨æˆ·è§’åº¦å‡ºå‘"></a>1. ä»ç”¨æˆ·è§’åº¦å‡ºå‘</h2><p>â€œæˆ‘è®¤ä¸ºä¸€ä¸ªå¥½äº§å“é¦–å…ˆè¦è§£å†³çœŸå®ç”¨æˆ·çš„ç—›ç‚¹ã€‚å®ƒåº”è¯¥ï¼š</p><ul><li>æ»¡è¶³ç›®æ ‡ç”¨æˆ·çš„æ ¸å¿ƒéœ€æ±‚ï¼ˆåˆšéœ€ï¼‰</li><li>æä¾›ç®€å•ç›´è§‚çš„ç”¨æˆ·ä½“éªŒ</li><li>åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­è®©ç”¨æˆ·æ„Ÿåˆ°æ„‰æ‚¦è€Œä¸æ˜¯æŒ«è´¥</li></ul><p>æ¯”å¦‚Slackä¹‹æ‰€ä»¥æˆåŠŸï¼Œå°±æ˜¯å› ä¸ºå®ƒè§£å†³äº†å›¢é˜Ÿæ²Ÿé€šä¸­çš„ä¿¡æ¯ç¢ç‰‡åŒ–é—®é¢˜ï¼Œè€Œä¸”ä½¿ç”¨èµ·æ¥éå¸¸ç›´è§‚ã€‚â€</p><h2 id="2-åŠ å…¥æŠ€æœ¯è§†è§’"><a href="#2-åŠ å…¥æŠ€æœ¯è§†è§’" class="headerlink" title="2. åŠ å…¥æŠ€æœ¯è§†è§’"></a>2. åŠ å…¥æŠ€æœ¯è§†è§’</h2><p>â€œä»æŠ€æœ¯å®ç°è§’åº¦çœ‹ï¼Œå¥½äº§å“è¿˜åº”è¯¥å…·å¤‡ï¼š</p><ul><li><strong>ç¨³å®šæ€§</strong>ï¼šå°‘å´©æºƒã€å°‘bug</li><li><strong>æ€§èƒ½</strong>ï¼šå“åº”å¿«é€Ÿï¼Œä¸å¡é¡¿</li><li><strong>å¯æ‰©å±•æ€§</strong>ï¼šèƒ½éšç€ç”¨æˆ·å¢é•¿è€Œæ‰©å±•</li><li><strong>å®‰å…¨æ€§</strong>ï¼šä¿æŠ¤ç”¨æˆ·æ•°æ®å’Œéšç§</li></ul><p>ä¾‹å¦‚å¾®ä¿¡åœ¨ä¿è¯æµ·é‡ç”¨æˆ·åŒæ—¶åœ¨çº¿æ—¶çš„ç¨³å®šæ€§è¡¨ç°å°±éå¸¸å‡ºè‰²ã€‚â€</p><h2 id="3-å•†ä¸šå¯æŒç»­æ€§"><a href="#3-å•†ä¸šå¯æŒç»­æ€§" class="headerlink" title="3. å•†ä¸šå¯æŒç»­æ€§"></a>3. å•†ä¸šå¯æŒç»­æ€§</h2><p>â€œå¥½äº§å“è¿˜éœ€è¦å…·å¤‡å•†ä¸šå¯æŒç»­æ€§ï¼š</p><ul><li>æœ‰æ¸…æ™°çš„ç›ˆåˆ©æ¨¡å¼</li><li>ç”¨æˆ·è·å–æˆæœ¬(CA)ä½äºç”¨æˆ·ç”Ÿå‘½å‘¨æœŸä»·å€¼(LTV)</li><li>èƒ½å½¢æˆç«äº‰å£å’</li></ul><p>åƒNotioné€šè¿‡å…è´¹å¢å€¼æ¨¡å¼(Freemium)æ—¢è·å¾—äº†å¤§é‡ç”¨æˆ·ï¼Œåˆå®ç°äº†ç›ˆåˆ©ã€‚â€</p><h2 id="4-æ•°æ®é©±åŠ¨è¿­ä»£"><a href="#4-æ•°æ®é©±åŠ¨è¿­ä»£" class="headerlink" title="4. æ•°æ®é©±åŠ¨è¿­ä»£"></a>4. æ•°æ®é©±åŠ¨è¿­ä»£</h2><p>â€œçœŸæ­£çš„å¥½äº§å“ä¼šï¼š</p><ul><li>å»ºç«‹å®Œå–„çš„æ•°æ®æŒ‡æ ‡ä½“ç³»</li><li>é€šè¿‡A&#x2F;Bæµ‹è¯•æŒç»­ä¼˜åŒ–</li><li>æ ¹æ®ç”¨æˆ·åé¦ˆå¿«é€Ÿè¿­ä»£</li></ul><p>æ¯”å¦‚æŠ–éŸ³çš„æ¨èç®—æ³•å°±æ˜¯é€šè¿‡æŒç»­çš„æ•°æ®åˆ†æå’Œä¼˜åŒ–ï¼Œæ‰è¾¾åˆ°å¦‚æ­¤ç²¾å‡†çš„ä¸ªæ€§åŒ–æ¨èã€‚â€</p><h2 id="5-ç»“åˆåº”è˜å…¬å¸äº§å“"><a href="#5-ç»“åˆåº”è˜å…¬å¸äº§å“" class="headerlink" title="5. ç»“åˆåº”è˜å…¬å¸äº§å“"></a>5. ç»“åˆåº”è˜å…¬å¸äº§å“</h2><p>â€œç‰¹åˆ«æ˜¯å¯¹äºè´µå…¬å¸çš„äº§å“[XXX]ï¼Œæˆ‘è®¤ä¸ºå®ƒå¾ˆå¥½åœ°ä½“ç°äº†è¿™äº›ç‰¹è´¨ï¼Œæ¯”å¦‚â€¦[å…·ä½“ä¸¾ä¾‹]ã€‚å¦‚æœæˆ‘æœ‰æœºä¼šåŠ å…¥ï¼Œæˆ‘å¸Œæœ›èƒ½åœ¨[æŸä¸ªæŠ€æœ¯æ–¹é¢]åšå‡ºè´¡çŒ®ï¼Œå¸®åŠ©äº§å“å˜å¾—æ›´å¥½ã€‚â€</p><h2 id="å›ç­”æŠ€å·§"><a href="#å›ç­”æŠ€å·§" class="headerlink" title="å›ç­”æŠ€å·§"></a>å›ç­”æŠ€å·§</h2><ol><li><strong>ç»“æ„åŒ–è¡¨è¾¾</strong>ï¼šä½¿ç”¨æ¸…æ™°çš„é€»è¾‘æ¡†æ¶(å¦‚ä¸Šè¿°å‡ ç‚¹)</li><li><strong>ä¸¾ä¾‹è¯´æ˜</strong>ï¼šå¼•ç”¨çŸ¥åäº§å“æˆ–è¯¥å…¬å¸äº§å“ä¸ºä¾‹</li><li><strong>å±•ç°æŠ€æœ¯æ·±åº¦</strong>ï¼šä½œä¸ºç¨‹åºå‘˜ï¼Œè¦å±•ç¤ºä½ ä»æŠ€æœ¯è§’åº¦å¯¹äº§å“çš„ç†è§£</li><li><strong>é€‚åº¦è°¦è™š</strong>ï¼šâ€è¿™æ˜¯æˆ‘ç›®å‰çš„ç†è§£ï¼Œå½“ç„¶å¥½äº§å“çš„æ ‡å‡†å¯èƒ½è¿˜æœ‰å¾ˆå¤šâ€¦â€</li><li><strong>å…³è”å²—ä½</strong>ï¼šæœ€åå¯ä»¥å…³è”åˆ°ä½ åº”è˜çš„å²—ä½å¦‚ä½•å¸®åŠ©æ‰“é€ å¥½äº§å“</li></ol><p>è®°ä½ï¼Œé¢è¯•å®˜é—®è¿™ä¸ªé—®é¢˜ä¸ä»…æ˜¯è€ƒå¯Ÿä½ çš„äº§å“æ€ç»´ï¼Œä¹Ÿåœ¨è§‚å¯Ÿä½ çš„æ²Ÿé€šè¡¨è¾¾èƒ½åŠ›å’Œé€»è¾‘æ€ç»´èƒ½åŠ›ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Golang GMPæ¨¡å‹</title>
    <link href="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/"/>
    <url>/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="Golang-GMPæ¨¡å‹"><a href="#Golang-GMPæ¨¡å‹" class="headerlink" title="Golang GMPæ¨¡å‹"></a>Golang GMPæ¨¡å‹</h1><p>è½¬è‡ªï¼š<a href="https://www.yuque.com/aceld/golang/srxd6d">https://www.yuque.com/aceld/golang/srxd6d</a></p><p>æœ¬èŠ‚ä¸ºé‡ç‚¹ç« èŠ‚ æœ¬ç« èŠ‚å«è§†é¢‘ç‰ˆ:</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650775952013-f19f9c96-b995-42d6-bc9c-8b1e73b602d8.webp" alt="Image 1: GPMå°é¢.png"></p><p>è§†é¢‘é“¾æ¥åœ°å€ï¼š<a href="https://www.bilibili.com/video/BV19r4y1w7Nx">https://www.bilibili.com/video/BV19r4y1w7Nx</a></p><h2 id="ä¸€ã€Golangâ€œè°ƒåº¦å™¨â€çš„ç”±æ¥ï¼Ÿ"><a href="#ä¸€ã€Golangâ€œè°ƒåº¦å™¨â€çš„ç”±æ¥ï¼Ÿ" class="headerlink" title="ä¸€ã€Golangâ€œè°ƒåº¦å™¨â€çš„ç”±æ¥ï¼Ÿ"></a>ä¸€ã€Golangâ€œè°ƒåº¦å™¨â€çš„ç”±æ¥ï¼Ÿ</h2><h3 id="1-å•è¿›ç¨‹æ—¶ä»£ä¸éœ€è¦è°ƒåº¦å™¨"><a href="#1-å•è¿›ç¨‹æ—¶ä»£ä¸éœ€è¦è°ƒåº¦å™¨" class="headerlink" title="(1) å•è¿›ç¨‹æ—¶ä»£ä¸éœ€è¦è°ƒåº¦å™¨"></a>(1) å•è¿›ç¨‹æ—¶ä»£ä¸éœ€è¦è°ƒåº¦å™¨</h3><p>æˆ‘ä»¬çŸ¥é“ï¼Œä¸€åˆ‡çš„è½¯ä»¶éƒ½æ˜¯è·‘åœ¨æ“ä½œç³»ç»Ÿä¸Šï¼ŒçœŸæ­£ç”¨æ¥å¹²æ´»(è®¡ç®—)çš„æ˜¯CPUã€‚æ—©æœŸçš„æ“ä½œç³»ç»Ÿæ¯ä¸ªç¨‹åºå°±æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œç›´åˆ°ä¸€ä¸ªç¨‹åºè¿è¡Œå®Œï¼Œæ‰èƒ½è¿›è¡Œä¸‹ä¸€ä¸ªè¿›ç¨‹ï¼Œå°±æ˜¯â€œå•è¿›ç¨‹æ—¶ä»£â€</p><p>ä¸€åˆ‡çš„ç¨‹åºåªèƒ½ä¸²è¡Œå‘ç”Ÿã€‚</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776039816-a8a5efb6-06be-4984-bfb0-7565c14b0a61.webp" alt="Image 2: 5-å•è¿›ç¨‹æ“ä½œç³»ç»Ÿ.png"></p><p>æ—©æœŸçš„å•è¿›ç¨‹æ“ä½œç³»ç»Ÿï¼Œé¢ä¸´2ä¸ªé—®é¢˜ï¼š</p><p>1.å•ä¸€çš„æ‰§è¡Œæµç¨‹ï¼Œè®¡ç®—æœºåªèƒ½ä¸€ä¸ªä»»åŠ¡ä¸€ä¸ªä»»åŠ¡å¤„ç†ã€‚</p><p>2.è¿›ç¨‹é˜»å¡æ‰€å¸¦æ¥çš„CPUæ—¶é—´æµªè´¹ã€‚</p><p>é‚£ä¹ˆèƒ½ä¸èƒ½æœ‰å¤šä¸ªè¿›ç¨‹æ¥å®è§‚ä¸€èµ·æ¥æ‰§è¡Œå¤šä¸ªä»»åŠ¡å‘¢ï¼Ÿ</p><p>åæ¥æ“ä½œç³»ç»Ÿå°±å…·æœ‰äº†æœ€æ—©çš„å¹¶å‘èƒ½åŠ›ï¼šå¤šè¿›ç¨‹å¹¶å‘ï¼Œå½“ä¸€ä¸ªè¿›ç¨‹é˜»å¡çš„æ—¶å€™ï¼Œåˆ‡æ¢åˆ°å¦å¤–ç­‰å¾…æ‰§è¡Œçš„è¿›ç¨‹ï¼Œè¿™æ ·å°±èƒ½å°½é‡æŠŠCPUåˆ©ç”¨èµ·æ¥ï¼ŒCPUå°±ä¸æµªè´¹äº†ã€‚</p><h3 id="2-å¤šè¿›ç¨‹-çº¿ç¨‹æ—¶ä»£æœ‰äº†è°ƒåº¦å™¨éœ€æ±‚"><a href="#2-å¤šè¿›ç¨‹-çº¿ç¨‹æ—¶ä»£æœ‰äº†è°ƒåº¦å™¨éœ€æ±‚" class="headerlink" title="(2)å¤šè¿›ç¨‹&#x2F;çº¿ç¨‹æ—¶ä»£æœ‰äº†è°ƒåº¦å™¨éœ€æ±‚"></a>(2)å¤šè¿›ç¨‹&#x2F;çº¿ç¨‹æ—¶ä»£æœ‰äº†è°ƒåº¦å™¨éœ€æ±‚</h3><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776059361-384f6fb5-e2b1-4f99-8701-f57694aa8ecb.webp" alt="Image 3: 6-å¤šè¿›ç¨‹æ“ä½œç³»ç»Ÿ.png"></p><p>åœ¨å¤šè¿›ç¨‹&#x2F;å¤šçº¿ç¨‹çš„æ“ä½œç³»ç»Ÿä¸­ï¼Œå°±è§£å†³äº†é˜»å¡çš„é—®é¢˜ï¼Œå› ä¸ºä¸€ä¸ªè¿›ç¨‹é˜»å¡cpuå¯ä»¥ç«‹åˆ»åˆ‡æ¢åˆ°å…¶ä»–è¿›ç¨‹ä¸­å»æ‰§è¡Œï¼Œè€Œä¸”è°ƒåº¦cpuçš„ç®—æ³•å¯ä»¥ä¿è¯åœ¨è¿è¡Œçš„è¿›ç¨‹éƒ½å¯ä»¥è¢«åˆ†é…åˆ°cpuçš„è¿è¡Œæ—¶é—´ç‰‡ã€‚è¿™æ ·ä»å®è§‚æ¥çœ‹ï¼Œä¼¼ä¹å¤šä¸ªè¿›ç¨‹æ˜¯åœ¨åŒæ—¶è¢«è¿è¡Œã€‚</p><p>ä½†æ–°çš„é—®é¢˜å°±åˆå‡ºç°äº†ï¼Œè¿›ç¨‹æ‹¥æœ‰å¤ªå¤šçš„èµ„æºï¼Œè¿›ç¨‹çš„åˆ›å»ºã€åˆ‡æ¢ã€é”€æ¯ï¼Œéƒ½ä¼šå ç”¨å¾ˆé•¿çš„æ—¶é—´ï¼ŒCPUè™½ç„¶åˆ©ç”¨èµ·æ¥äº†ï¼Œä½†å¦‚æœè¿›ç¨‹è¿‡å¤šï¼ŒCPUæœ‰å¾ˆå¤§çš„ä¸€éƒ¨åˆ†éƒ½è¢«ç”¨æ¥è¿›è¡Œè¿›ç¨‹è°ƒåº¦äº†ã€‚</p><p>æ€ä¹ˆæ‰èƒ½æé«˜CPUçš„åˆ©ç”¨ç‡å‘¢ï¼Ÿ</p><p>ä½†æ˜¯å¯¹äºLinuxæ“ä½œç³»ç»Ÿæ¥è®²ï¼Œcpuå¯¹è¿›ç¨‹çš„æ€åº¦å’Œçº¿ç¨‹çš„æ€åº¦æ˜¯ä¸€æ ·çš„ã€‚</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776077730-2a6860a3-0466-4df9-925d-9ecd5cb9ad7d.webp" alt="Image 4: 7-cpuåˆ‡æ¢æµªè´¹æˆæœ¬.png"></p><p>å¾ˆæ˜æ˜¾ï¼ŒCPUè°ƒåº¦åˆ‡æ¢çš„æ˜¯è¿›ç¨‹å’Œçº¿ç¨‹ã€‚å°½ç®¡çº¿ç¨‹çœ‹èµ·æ¥å¾ˆç¾å¥½ï¼Œä½†å®é™…ä¸Šå¤šçº¿ç¨‹å¼€å‘è®¾è®¡ä¼šå˜å¾—æ›´åŠ å¤æ‚ï¼Œè¦è€ƒè™‘å¾ˆå¤šåŒæ­¥ç«äº‰ç­‰é—®é¢˜ï¼Œå¦‚é”ã€ç«äº‰å†²çªç­‰ã€‚</p><h3 id="3-åç¨‹æ¥æé«˜CPUåˆ©ç”¨ç‡"><a href="#3-åç¨‹æ¥æé«˜CPUåˆ©ç”¨ç‡" class="headerlink" title="(3) åç¨‹æ¥æé«˜CPUåˆ©ç”¨ç‡"></a>(3) åç¨‹æ¥æé«˜CPUåˆ©ç”¨ç‡</h3><p>å¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹å·²ç»æé«˜äº†ç³»ç»Ÿçš„å¹¶å‘èƒ½åŠ›ï¼Œä½†æ˜¯åœ¨å½“ä»Šäº’è”ç½‘é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œä¸ºæ¯ä¸ªä»»åŠ¡éƒ½åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ˜¯ä¸ç°å®çš„ï¼Œå› ä¸ºä¼šæ¶ˆè€—å¤§é‡çš„å†…å­˜(è¿›ç¨‹è™šæ‹Ÿå†…å­˜ä¼šå ç”¨4GB[32ä½æ“ä½œç³»ç»Ÿ], è€Œçº¿ç¨‹ä¹Ÿè¦å¤§çº¦4MB)ã€‚</p><p>å¤§é‡çš„è¿›ç¨‹&#x2F;çº¿ç¨‹å‡ºç°äº†æ–°çš„é—®é¢˜</p><p>â—é«˜å†…å­˜å ç”¨<br>â—è°ƒåº¦çš„é«˜æ¶ˆè€—CPU</p><p>å¥½äº†ï¼Œç„¶åå·¥ç¨‹å¸ˆä»¬å°±å‘ç°ï¼Œå…¶å®ä¸€ä¸ªçº¿ç¨‹åˆ†ä¸º<strong>â€œå†…æ ¸æ€â€œçº¿ç¨‹å’Œâ€ç”¨æˆ·æ€â€œçº¿ç¨‹</strong>ã€‚</p><p><strong>ä¸€ä¸ªâ€œç”¨æˆ·æ€çº¿ç¨‹â€å¿…é¡»è¦ç»‘å®šä¸€ä¸ªâ€œå†…æ ¸æ€çº¿ç¨‹â€</strong>ï¼Œä½†æ˜¯**CPUå¹¶ä¸çŸ¥é“æœ‰â€œç”¨æˆ·æ€çº¿ç¨‹â€çš„å­˜åœ¨ï¼Œå®ƒåªçŸ¥é“å®ƒè¿è¡Œçš„æ˜¯ä¸€ä¸ªâ€œå†…æ ¸æ€çº¿ç¨‹â€(Linuxçš„PCBè¿›ç¨‹æ§åˆ¶å—)**ã€‚</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776112186-eff4e8b8-8742-44cd-a828-db1653649ee7.webp" alt="Image 5: 8-çº¿ç¨‹çš„å†…æ ¸å’Œç”¨æˆ·æ€.png"></p><p>è¿™æ ·ï¼Œæˆ‘ä»¬å†å»ç»†åŒ–å»åˆ†ç±»ä¸€ä¸‹ï¼Œå†…æ ¸çº¿ç¨‹ä¾ç„¶å«â€œçº¿ç¨‹(thread)â€ï¼Œç”¨æˆ·çº¿ç¨‹å«â€œåç¨‹(co-routine)â€.</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776128796-5b795bfb-3289-4f6b-85a0-f24399dfc79c.webp" alt="Image 6: 9-åç¨‹å’Œçº¿ç¨‹.png"></p><p>çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±è¦å¼€è„‘æ´äº†ï¼Œæ—¢ç„¶ä¸€ä¸ªåç¨‹(co-routine)å¯ä»¥ç»‘å®šä¸€ä¸ªçº¿ç¨‹(thread)ï¼Œé‚£ä¹ˆèƒ½ä¸èƒ½å¤šä¸ªåç¨‹(co-routine)ç»‘å®šä¸€ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹(thread)ä¸Šå‘¢ã€‚</p><p>ä¹‹åï¼Œæˆ‘ä»¬å°±çœ‹åˆ°äº†æœ‰3ä¸­åç¨‹å’Œçº¿ç¨‹çš„æ˜ å°„å…³ç³»ï¼š</p><p>N:1å…³ç³»</p><p>Nä¸ªåç¨‹ç»‘å®š1ä¸ªçº¿ç¨‹ï¼Œä¼˜ç‚¹å°±æ˜¯åç¨‹åœ¨ç”¨æˆ·æ€çº¿ç¨‹å³å®Œæˆåˆ‡æ¢ï¼Œä¸ä¼šé™·å…¥åˆ°å†…æ ¸æ€ï¼Œè¿™ç§åˆ‡æ¢éå¸¸çš„è½»é‡å¿«é€Ÿã€‚ä½†ä¹Ÿæœ‰å¾ˆå¤§çš„ç¼ºç‚¹ï¼Œ1ä¸ªè¿›ç¨‹çš„æ‰€æœ‰åç¨‹éƒ½ç»‘å®šåœ¨1ä¸ªçº¿ç¨‹ä¸Š</p><p>ç¼ºç‚¹ï¼š</p><p>â—æŸä¸ªç¨‹åºç”¨ä¸äº†ç¡¬ä»¶çš„å¤šæ ¸åŠ é€Ÿèƒ½åŠ›<br>â—ä¸€æ—¦æŸåç¨‹é˜»å¡ï¼Œé€ æˆçº¿ç¨‹é˜»å¡ï¼Œæœ¬è¿›ç¨‹çš„å…¶ä»–åç¨‹éƒ½æ— æ³•æ‰§è¡Œäº†ï¼Œæ ¹æœ¬å°±æ²¡æœ‰å¹¶å‘çš„èƒ½åŠ›äº†ã€‚</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776145617-04763b3d-1b15-42c7-9653-cde21bcc98bc.webp" alt="Image 7: 10-N-1å…³ç³».png"></p><p>1:1 å…³ç³»</p><p>1ä¸ªåç¨‹ç»‘å®š1ä¸ªçº¿ç¨‹ï¼Œè¿™ç§æœ€å®¹æ˜“å®ç°ã€‚åç¨‹çš„è°ƒåº¦éƒ½ç”±CPUå®Œæˆäº†ï¼Œä¸å­˜åœ¨N:1ç¼ºç‚¹ï¼Œ</p><p>ç¼ºç‚¹ï¼š</p><p>â—åç¨‹çš„åˆ›å»ºã€åˆ é™¤å’Œåˆ‡æ¢çš„ä»£ä»·éƒ½ç”±CPUå®Œæˆï¼Œæœ‰ç‚¹ç•¥æ˜¾æ˜‚è´µäº†ã€‚</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776180139-043037ed-cb5b-4c24-9fcf-691a05db17f9.webp" alt="Image 8: 11-1-1.png"></p><p>M:Nå…³ç³»</p><p>Mä¸ªåç¨‹ç»‘å®šNä¸ªçº¿ç¨‹ï¼Œæ˜¯N:1å’Œ1:1ç±»å‹çš„ç»“åˆï¼Œå…‹æœäº†ä»¥ä¸Š2ç§æ¨¡å‹çš„ç¼ºç‚¹ï¼Œä½†å®ç°èµ·æ¥æœ€ä¸ºå¤æ‚ã€‚</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776193242-4fecd540-5cbb-4f2d-8121-5312dbc6958a.webp" alt="Image 9: 12-m-n.png"></p><p>åç¨‹è·Ÿçº¿ç¨‹æ˜¯æœ‰åŒºåˆ«çš„ï¼Œçº¿ç¨‹ç”±CPUè°ƒåº¦æ˜¯æŠ¢å å¼çš„ï¼Œåç¨‹ç”±ç”¨æˆ·æ€è°ƒåº¦æ˜¯åä½œå¼çš„ï¼Œä¸€ä¸ªåç¨‹è®©å‡ºCPUåï¼Œæ‰æ‰§è¡Œä¸‹ä¸€ä¸ªåç¨‹ã€‚</p><h3 id="4-Goè¯­è¨€çš„åç¨‹goroutine"><a href="#4-Goè¯­è¨€çš„åç¨‹goroutine" class="headerlink" title="(4) Goè¯­è¨€çš„åç¨‹goroutine"></a>(4) Goè¯­è¨€çš„åç¨‹goroutine</h3><p>Goä¸ºäº†æä¾›æ›´å®¹æ˜“ä½¿ç”¨çš„å¹¶å‘æ–¹æ³•ï¼Œä½¿ç”¨äº†goroutineå’Œchannelã€‚goroutineæ¥è‡ªåç¨‹çš„æ¦‚å¿µï¼Œè®©ä¸€ç»„å¯å¤ç”¨çš„å‡½æ•°è¿è¡Œåœ¨ä¸€ç»„çº¿ç¨‹ä¹‹ä¸Šï¼Œå³ä½¿æœ‰åç¨‹é˜»å¡ï¼Œè¯¥çº¿ç¨‹çš„å…¶ä»–åç¨‹ä¹Ÿå¯ä»¥è¢«runtimeè°ƒåº¦ï¼Œè½¬ç§»åˆ°å…¶ä»–å¯è¿è¡Œçš„çº¿ç¨‹ä¸Šã€‚æœ€å…³é”®çš„æ˜¯ï¼Œç¨‹åºå‘˜çœ‹ä¸åˆ°è¿™äº›åº•å±‚çš„ç»†èŠ‚ï¼Œè¿™å°±é™ä½äº†ç¼–ç¨‹çš„éš¾åº¦ï¼Œæä¾›äº†æ›´å®¹æ˜“çš„å¹¶å‘ã€‚</p><p>Goä¸­ï¼Œåç¨‹è¢«ç§°ä¸ºgoroutineï¼Œå®ƒéå¸¸è½»é‡ï¼Œä¸€ä¸ªgoroutineåªå å‡ KBï¼Œå¹¶ä¸”è¿™å‡ KBå°±è¶³å¤Ÿgoroutineè¿è¡Œå®Œï¼Œè¿™å°±èƒ½åœ¨æœ‰é™çš„å†…å­˜ç©ºé—´å†…æ”¯æŒå¤§é‡goroutineï¼Œæ”¯æŒäº†æ›´å¤šçš„å¹¶å‘ã€‚è™½ç„¶ä¸€ä¸ªgoroutineçš„æ ˆåªå å‡ KBï¼Œä½†å®é™…æ˜¯å¯ä¼¸ç¼©çš„ï¼Œå¦‚æœéœ€è¦æ›´å¤šå†…å®¹ï¼Œruntimeä¼šè‡ªåŠ¨ä¸ºgoroutineåˆ†é…ã€‚</p><p>Goroutineç‰¹ç‚¹ï¼š</p><p>â—å ç”¨å†…å­˜æ›´å°ï¼ˆå‡ kbï¼‰<br>â—è°ƒåº¦æ›´çµæ´»(runtimeè°ƒåº¦)</p><h3 id="5-è¢«åºŸå¼ƒçš„goroutineè°ƒåº¦å™¨"><a href="#5-è¢«åºŸå¼ƒçš„goroutineè°ƒåº¦å™¨" class="headerlink" title="(5) è¢«åºŸå¼ƒçš„goroutineè°ƒåº¦å™¨"></a>(5) è¢«åºŸå¼ƒçš„goroutineè°ƒåº¦å™¨</h3><p>å¥½äº†ï¼Œæ—¢ç„¶æˆ‘ä»¬çŸ¥é“äº†åç¨‹å’Œçº¿ç¨‹çš„å…³ç³»ï¼Œé‚£ä¹ˆæœ€å…³é”®çš„ä¸€ç‚¹å°±æ˜¯è°ƒåº¦åç¨‹çš„è°ƒåº¦å™¨çš„å®ç°äº†ã€‚</p><p>Goç›®å‰ä½¿ç”¨çš„è°ƒåº¦å™¨æ˜¯2012å¹´é‡æ–°è®¾è®¡çš„ï¼Œå› ä¸ºä¹‹å‰çš„è°ƒåº¦å™¨æ€§èƒ½å­˜åœ¨é—®é¢˜ï¼Œæ‰€ä»¥ä½¿ç”¨4å¹´å°±è¢«åºŸå¼ƒäº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹è¢«åºŸå¼ƒçš„è°ƒåº¦å™¨æ˜¯å¦‚ä½•è¿ä½œçš„ï¼Ÿ</p><p>å¤§éƒ¨åˆ†æ–‡ç« éƒ½æ˜¯ä¼šç”¨Gæ¥è¡¨ç¤ºGoroutineï¼Œç”¨Mæ¥è¡¨ç¤ºçº¿ç¨‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿä¼šç”¨è¿™ç§è¡¨è¾¾çš„å¯¹åº”å…³ç³»ã€‚</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776259684-6015cb7b-b33e-47f9-b241-185c57dc2745.webp" alt="Image 10: 13-gm.png"></p><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹è¢«åºŸå¼ƒçš„golangè°ƒåº¦å™¨æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776272668-ac680807-d927-4c10-9e1d-3960bdabd0e3.webp" alt="Image 11: 14-oldè°ƒåº¦å™¨.png"></p><p>Mæƒ³è¦æ‰§è¡Œã€æ”¾å›Géƒ½å¿…é¡»è®¿é—®å…¨å±€Gé˜Ÿåˆ—ï¼Œå¹¶ä¸”Mæœ‰å¤šä¸ªï¼Œå³å¤šçº¿ç¨‹è®¿é—®åŒä¸€èµ„æºéœ€è¦åŠ é”è¿›è¡Œä¿è¯äº’æ–¥&#x2F;åŒæ­¥ï¼Œæ‰€ä»¥å…¨å±€Gé˜Ÿåˆ—æ˜¯æœ‰äº’æ–¥é”è¿›è¡Œä¿æŠ¤çš„ã€‚</p><p>è€è°ƒåº¦å™¨æœ‰å‡ ä¸ªç¼ºç‚¹ï¼š</p><ol><li>åˆ›å»ºã€é”€æ¯ã€è°ƒåº¦Géƒ½éœ€è¦æ¯ä¸ªMè·å–é”ï¼Œè¿™å°±å½¢æˆäº†æ¿€çƒˆçš„é”ç«äº‰ã€‚</li><li>Mè½¬ç§»Gä¼šé€ æˆå»¶è¿Ÿå’Œé¢å¤–çš„ç³»ç»Ÿè´Ÿè½½ã€‚æ¯”å¦‚å½“Gä¸­åŒ…å«åˆ›å»ºæ–°åç¨‹çš„æ—¶å€™ï¼ŒMåˆ›å»ºäº†Gâ€™ï¼Œä¸ºäº†ç»§ç»­æ‰§è¡ŒGï¼Œéœ€è¦æŠŠGâ€™äº¤ç»™Mâ€™æ‰§è¡Œï¼Œä¹Ÿé€ æˆäº†å¾ˆå·®çš„å±€éƒ¨æ€§ï¼Œå› ä¸ºGâ€™å’ŒGæ˜¯ç›¸å…³çš„ï¼Œæœ€å¥½æ”¾åœ¨Mä¸Šæ‰§è¡Œï¼Œè€Œä¸æ˜¯å…¶ä»–Mâ€™ã€‚</li><li>ç³»ç»Ÿè°ƒç”¨(CPUåœ¨Mä¹‹é—´çš„åˆ‡æ¢)å¯¼è‡´é¢‘ç¹çš„çº¿ç¨‹é˜»å¡å’Œå–æ¶ˆé˜»å¡æ“ä½œå¢åŠ äº†ç³»ç»Ÿå¼€é”€ã€‚</li></ol><h2 id="äºŒã€Goroutineè°ƒåº¦å™¨çš„GMPæ¨¡å‹çš„è®¾è®¡æ€æƒ³"><a href="#äºŒã€Goroutineè°ƒåº¦å™¨çš„GMPæ¨¡å‹çš„è®¾è®¡æ€æƒ³" class="headerlink" title="äºŒã€Goroutineè°ƒåº¦å™¨çš„GMPæ¨¡å‹çš„è®¾è®¡æ€æƒ³"></a>äºŒã€Goroutineè°ƒåº¦å™¨çš„GMPæ¨¡å‹çš„è®¾è®¡æ€æƒ³</h2><p>é¢å¯¹ä¹‹å‰è°ƒåº¦å™¨çš„é—®é¢˜ï¼ŒGoè®¾è®¡äº†æ–°çš„è°ƒåº¦å™¨ã€‚</p><p>åœ¨æ–°è°ƒåº¦å™¨ä¸­ï¼Œé™¤äº†M(thread)å’ŒG(goroutine)ï¼Œåˆå¼•è¿›äº†P(Processor)ã€‚</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776288599-36c23cc6-3d25-4f6f-8f80-83bd43aa6dec.webp" alt="Image 12: 15-gmp.png"></p><p>Processorï¼Œå®ƒåŒ…å«äº†è¿è¡Œgoroutineçš„èµ„æºï¼Œå¦‚æœçº¿ç¨‹æƒ³è¿è¡Œgoroutineï¼Œå¿…é¡»å…ˆè·å–Pï¼ŒPä¸­è¿˜åŒ…å«äº†å¯è¿è¡Œçš„Gé˜Ÿåˆ—ã€‚</p><h3 id="1-GMPæ¨¡å‹"><a href="#1-GMPæ¨¡å‹" class="headerlink" title="(1) GMPæ¨¡å‹"></a>(1) GMPæ¨¡å‹</h3><p>åœ¨Goä¸­ï¼Œçº¿ç¨‹æ˜¯è¿è¡Œgoroutineçš„å®ä½“ï¼Œè°ƒåº¦å™¨çš„åŠŸèƒ½æ˜¯æŠŠå¯è¿è¡Œçš„goroutineåˆ†é…åˆ°å·¥ä½œçº¿ç¨‹ä¸Šã€‚</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776301442-fb76123c-8d0e-4375-af35-b5728a5b1bc7.webp" alt="Image 13: 16-GMP-è°ƒåº¦.png"></p><ol><li>å…¨å±€é˜Ÿåˆ—ï¼ˆGlobal Queueï¼‰ï¼šå­˜æ”¾ç­‰å¾…è¿è¡Œçš„Gã€‚</li><li>Pçš„æœ¬åœ°é˜Ÿåˆ—ï¼šåŒå…¨å±€é˜Ÿåˆ—ç±»ä¼¼ï¼Œå­˜æ”¾çš„ä¹Ÿæ˜¯ç­‰å¾…è¿è¡Œçš„Gï¼Œå­˜çš„æ•°é‡æœ‰é™ï¼Œä¸è¶…è¿‡256ä¸ªã€‚æ–°å»ºGâ€™æ—¶ï¼ŒGâ€™ä¼˜å…ˆåŠ å…¥åˆ°Pçš„æœ¬åœ°é˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™ä¼šæŠŠæœ¬åœ°é˜Ÿåˆ—ä¸­ä¸€åŠçš„Gç§»åŠ¨åˆ°å…¨å±€é˜Ÿåˆ—ã€‚</li><li>Påˆ—è¡¨ï¼šæ‰€æœ‰çš„Péƒ½åœ¨ç¨‹åºå¯åŠ¨æ—¶åˆ›å»ºï¼Œå¹¶ä¿å­˜åœ¨æ•°ç»„ä¸­ï¼Œæœ€å¤šæœ‰GOMAXPROCS(å¯é…ç½®)ä¸ªã€‚</li><li>Mï¼šçº¿ç¨‹æƒ³è¿è¡Œä»»åŠ¡å°±å¾—è·å–Pï¼Œä»Pçš„æœ¬åœ°é˜Ÿåˆ—è·å–Gï¼ŒPé˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼ŒMä¹Ÿä¼šå°è¯•ä»å…¨å±€é˜Ÿåˆ—æ‹¿ä¸€æ‰¹Gæ”¾åˆ°Pçš„æœ¬åœ°é˜Ÿåˆ—ï¼Œæˆ–ä»å…¶ä»–Pçš„æœ¬åœ°é˜Ÿåˆ—å·ä¸€åŠæ”¾åˆ°è‡ªå·±Pçš„æœ¬åœ°é˜Ÿåˆ—ã€‚Mè¿è¡ŒGï¼ŒGæ‰§è¡Œä¹‹åï¼ŒMä¼šä»Pè·å–ä¸‹ä¸€ä¸ªGï¼Œä¸æ–­é‡å¤ä¸‹å»ã€‚</li></ol><p>Goroutineè°ƒåº¦å™¨å’ŒOSè°ƒåº¦å™¨æ˜¯é€šè¿‡Mç»“åˆèµ·æ¥çš„ï¼Œ<strong>æ¯ä¸ªMéƒ½ä»£è¡¨äº†1ä¸ªå†…æ ¸çº¿ç¨‹</strong>ï¼ŒOSè°ƒåº¦å™¨è´Ÿè´£æŠŠå†…æ ¸çº¿ç¨‹åˆ†é…åˆ°CPUçš„æ ¸ä¸Šæ‰§è¡Œã€‚</p><p>æœ‰å…³På’ŒMçš„ä¸ªæ•°é—®é¢˜</p><p>1ã€Pçš„æ•°é‡ï¼š</p><p>â—ç”±å¯åŠ¨æ—¶ç¯å¢ƒå˜é‡$GOMAXPROCSæˆ–è€…æ˜¯ç”±runtimeçš„æ–¹æ³•GOMAXPROCS()å†³å®šã€‚è¿™æ„å‘³ç€åœ¨ç¨‹åºæ‰§è¡Œçš„ä»»æ„æ—¶åˆ»éƒ½åªæœ‰$GOMAXPROCSä¸ªgoroutineåœ¨åŒæ—¶è¿è¡Œã€‚</p><p>2ã€Mçš„æ•°é‡:</p><p>â—goè¯­è¨€æœ¬èº«çš„é™åˆ¶ï¼šgoç¨‹åºå¯åŠ¨æ—¶ï¼Œä¼šè®¾ç½®Mçš„æœ€å¤§æ•°é‡ï¼Œé»˜è®¤10000.ä½†æ˜¯å†…æ ¸å¾ˆéš¾æ”¯æŒè¿™ä¹ˆå¤šçš„çº¿ç¨‹æ•°ï¼Œæ‰€ä»¥è¿™ä¸ªé™åˆ¶å¯ä»¥å¿½ç•¥ã€‚<br>â—runtime&#x2F;debugä¸­çš„SetMaxThreadså‡½æ•°ï¼Œè®¾ç½®Mçš„æœ€å¤§æ•°é‡<br>â—ä¸€ä¸ªMé˜»å¡äº†ï¼Œä¼šåˆ›å»ºæ–°çš„Mã€‚</p><p>Mä¸Pçš„æ•°é‡æ²¡æœ‰ç»å¯¹å…³ç³»ï¼Œä¸€ä¸ªMé˜»å¡ï¼ŒPå°±ä¼šå»åˆ›å»ºæˆ–è€…åˆ‡æ¢å¦ä¸€ä¸ªMï¼Œæ‰€ä»¥ï¼Œå³ä½¿Pçš„é»˜è®¤æ•°é‡æ˜¯1ï¼Œä¹Ÿæœ‰å¯èƒ½ä¼šåˆ›å»ºå¾ˆå¤šä¸ªMå‡ºæ¥ã€‚</p><p>På’ŒMä½•æ—¶ä¼šè¢«åˆ›å»º</p><p>1ã€Pä½•æ—¶åˆ›å»ºï¼šåœ¨ç¡®å®šäº†Pçš„æœ€å¤§æ•°é‡nåï¼Œè¿è¡Œæ—¶ç³»ç»Ÿä¼šæ ¹æ®è¿™ä¸ªæ•°é‡åˆ›å»ºnä¸ªPã€‚</p><p>2ã€Mä½•æ—¶åˆ›å»ºï¼šæ²¡æœ‰è¶³å¤Ÿçš„Mæ¥å…³è”På¹¶è¿è¡Œå…¶ä¸­çš„å¯è¿è¡Œçš„Gã€‚æ¯”å¦‚æ‰€æœ‰çš„Mæ­¤æ—¶éƒ½é˜»å¡ä½äº†ï¼Œè€ŒPä¸­è¿˜æœ‰å¾ˆå¤šå°±ç»ªä»»åŠ¡ï¼Œå°±ä¼šå»å¯»æ‰¾ç©ºé—²çš„Mï¼Œè€Œæ²¡æœ‰ç©ºé—²çš„ï¼Œå°±ä¼šå»åˆ›å»ºæ–°çš„Mã€‚</p><h3 id="2-è°ƒåº¦å™¨çš„è®¾è®¡ç­–ç•¥"><a href="#2-è°ƒåº¦å™¨çš„è®¾è®¡ç­–ç•¥" class="headerlink" title="(2) è°ƒåº¦å™¨çš„è®¾è®¡ç­–ç•¥"></a>(2) è°ƒåº¦å™¨çš„è®¾è®¡ç­–ç•¥</h3><p>å¤ç”¨çº¿ç¨‹ï¼šé¿å…é¢‘ç¹çš„åˆ›å»ºã€é”€æ¯çº¿ç¨‹ï¼Œè€Œæ˜¯å¯¹çº¿ç¨‹çš„å¤ç”¨ã€‚</p><p>1ï¼‰work stealingæœºåˆ¶</p><p>å½“æœ¬çº¿ç¨‹æ— å¯è¿è¡Œçš„Gæ—¶ï¼Œå°è¯•ä»å…¶ä»–çº¿ç¨‹ç»‘å®šçš„På·å–Gï¼Œè€Œä¸æ˜¯é”€æ¯çº¿ç¨‹ã€‚</p><p>2ï¼‰hand offæœºåˆ¶</p><p>å½“æœ¬çº¿ç¨‹å› ä¸ºGè¿›è¡Œç³»ç»Ÿè°ƒç”¨é˜»å¡æ—¶ï¼Œçº¿ç¨‹é‡Šæ”¾ç»‘å®šçš„Pï¼ŒæŠŠPè½¬ç§»ç»™å…¶ä»–ç©ºé—²çš„çº¿ç¨‹æ‰§è¡Œã€‚</p><p>åˆ©ç”¨å¹¶è¡Œï¼šGOMAXPROCSè®¾ç½®Pçš„æ•°é‡ï¼Œæœ€å¤šæœ‰GOMAXPROCSä¸ªçº¿ç¨‹åˆ†å¸ƒåœ¨å¤šä¸ªCPUä¸ŠåŒæ—¶è¿è¡Œã€‚GOMAXPROCSä¹Ÿé™åˆ¶äº†å¹¶å‘çš„ç¨‹åº¦ï¼Œæ¯”å¦‚GOMAXPROCS &#x3D; æ ¸æ•°&#x2F;2ï¼Œåˆ™æœ€å¤šåˆ©ç”¨äº†ä¸€åŠçš„CPUæ ¸è¿›è¡Œå¹¶è¡Œã€‚</p><p>æŠ¢å ï¼šåœ¨coroutineä¸­è¦ç­‰å¾…ä¸€ä¸ªåç¨‹ä¸»åŠ¨è®©å‡ºCPUæ‰æ‰§è¡Œä¸‹ä¸€ä¸ªåç¨‹ï¼Œåœ¨Goä¸­ï¼Œä¸€ä¸ªgoroutineæœ€å¤šå ç”¨CPU 10msï¼Œé˜²æ­¢å…¶ä»–goroutineè¢«é¥¿æ­»ï¼Œè¿™å°±æ˜¯goroutineä¸åŒäºcoroutineçš„ä¸€ä¸ªåœ°æ–¹ã€‚</p><p>å…¨å±€Gé˜Ÿåˆ—ï¼šåœ¨æ–°çš„è°ƒåº¦å™¨ä¸­ä¾ç„¶æœ‰å…¨å±€Gé˜Ÿåˆ—ï¼Œå½“Pçš„æœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œä¼˜å…ˆä»å…¨å±€é˜Ÿåˆ—è·å–ï¼Œå¦‚æœå…¨å±€é˜Ÿåˆ—ä¸ºç©ºæ—¶åˆ™é€šè¿‡work stealingæœºåˆ¶ä»å…¶ä»–Pçš„æœ¬åœ°é˜Ÿåˆ—å·å–Gã€‚</p><h3 id="3-go-func-è°ƒåº¦æµç¨‹"><a href="#3-go-func-è°ƒåº¦æµç¨‹" class="headerlink" title="(3) go func()  è°ƒåº¦æµç¨‹"></a>(3) go func()  è°ƒåº¦æµç¨‹</h3><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776333419-50d3a922-bd53-4bff-b0b6-280e6abc5d74.webp" alt="Image 14: 18-go-funcè°ƒåº¦å‘¨æœŸ.jpeg"></p><p>ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥åˆ†æå‡ºå‡ ä¸ªç»“è®ºï¼š</p><p>1ã€æˆ‘ä»¬é€šè¿‡ go func()æ¥åˆ›å»ºä¸€ä¸ªgoroutineï¼›</p><p>2ã€æœ‰ä¸¤ä¸ªå­˜å‚¨Gçš„é˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯å±€éƒ¨è°ƒåº¦å™¨Pçš„æœ¬åœ°é˜Ÿåˆ—ã€ä¸€ä¸ªæ˜¯å…¨å±€Gé˜Ÿåˆ—ã€‚æ–°åˆ›å»ºçš„Gä¼šå…ˆä¿å­˜åœ¨Pçš„æœ¬åœ°é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœPçš„æœ¬åœ°é˜Ÿåˆ—å·²ç»æ»¡äº†å°±ä¼šä¿å­˜åœ¨å…¨å±€çš„é˜Ÿåˆ—ä¸­ï¼›</p><p>3ã€Gåªèƒ½è¿è¡Œåœ¨Mä¸­ï¼Œä¸€ä¸ªMå¿…é¡»æŒæœ‰ä¸€ä¸ªPï¼ŒMä¸Pæ˜¯1ï¼š1çš„å…³ç³»ã€‚Mä¼šä»Pçš„æœ¬åœ°é˜Ÿåˆ—å¼¹å‡ºä¸€ä¸ªå¯æ‰§è¡ŒçŠ¶æ€çš„Gæ¥æ‰§è¡Œï¼Œå¦‚æœPçš„æœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºï¼Œå°±ä¼šæƒ³å…¶ä»–çš„MPç»„åˆå·å–ä¸€ä¸ªå¯æ‰§è¡Œçš„Gæ¥æ‰§è¡Œï¼›</p><p>4ã€ä¸€ä¸ªMè°ƒåº¦Gæ‰§è¡Œçš„è¿‡ç¨‹æ˜¯ä¸€ä¸ªå¾ªç¯æœºåˆ¶ï¼›</p><p>5ã€å½“Mæ‰§è¡ŒæŸä¸€ä¸ªGæ—¶å€™å¦‚æœå‘ç”Ÿäº†syscallæˆ–åˆ™å…¶ä½™é˜»å¡æ“ä½œï¼ŒMä¼šé˜»å¡ï¼Œå¦‚æœå½“å‰æœ‰ä¸€äº›Gåœ¨ç­‰å¾…æ‰§è¡Œï¼Œruntimeä¼šæŠŠè¿™ä¸ªçº¿ç¨‹Mä»Pä¸­æ‘˜é™¤(detach)ï¼Œç„¶åå†åˆ›å»ºä¸€ä¸ªæ–°çš„æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹(å¦‚æœæœ‰ç©ºé—²çš„çº¿ç¨‹å¯ç”¨å°±å¤ç”¨ç©ºé—²çº¿ç¨‹)æ¥æœåŠ¡äºè¿™ä¸ªPï¼›</p><p>6ã€å½“Mç³»ç»Ÿè°ƒç”¨ç»“æŸæ—¶å€™ï¼Œè¿™ä¸ªGä¼šå°è¯•è·å–ä¸€ä¸ªç©ºé—²çš„Pæ‰§è¡Œï¼Œå¹¶æ”¾å…¥åˆ°è¿™ä¸ªPçš„æœ¬åœ°é˜Ÿåˆ—ã€‚å¦‚æœè·å–ä¸åˆ°Pï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹Må˜æˆä¼‘çœ çŠ¶æ€ï¼Œ åŠ å…¥åˆ°ç©ºé—²çº¿ç¨‹ä¸­ï¼Œç„¶åè¿™ä¸ªGä¼šè¢«æ”¾å…¥å…¨å±€é˜Ÿåˆ—ä¸­ã€‚</p><h3 id="4-è°ƒåº¦å™¨çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#4-è°ƒåº¦å™¨çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="(4) è°ƒåº¦å™¨çš„ç”Ÿå‘½å‘¨æœŸ"></a>(4) è°ƒåº¦å™¨çš„ç”Ÿå‘½å‘¨æœŸ</h3><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776346389-ab0ffa04-c707-4ec8-a810-0929533fd00c.webp" alt="Image 15: 17-pic-goè°ƒåº¦å™¨ç”Ÿå‘½å‘¨æœŸ.png"></p><p>ç‰¹æ®Šçš„M0å’ŒG0</p><p>M0</p><p>M0æ˜¯å¯åŠ¨ç¨‹åºåçš„ç¼–å·ä¸º0çš„ä¸»çº¿ç¨‹ï¼Œè¿™ä¸ªMå¯¹åº”çš„å®ä¾‹ä¼šåœ¨å…¨å±€å˜é‡runtime.m0ä¸­ï¼Œä¸éœ€è¦åœ¨heapä¸Šåˆ†é…ï¼ŒM0è´Ÿè´£æ‰§è¡Œåˆå§‹åŒ–æ“ä½œå’Œå¯åŠ¨ç¬¬ä¸€ä¸ªGï¼Œ åœ¨ä¹‹åM0å°±å’Œå…¶ä»–çš„Mä¸€æ ·äº†ã€‚</p><p>G0</p><p>G0æ˜¯æ¯æ¬¡å¯åŠ¨ä¸€ä¸ªMéƒ½ä¼šç¬¬ä¸€ä¸ªåˆ›å»ºçš„gourtineï¼ŒG0ä»…ç”¨äºè´Ÿè´£è°ƒåº¦çš„Gï¼ŒG0ä¸æŒ‡å‘ä»»ä½•å¯æ‰§è¡Œçš„å‡½æ•°, æ¯ä¸ªMéƒ½ä¼šæœ‰ä¸€ä¸ªè‡ªå·±çš„G0ã€‚åœ¨è°ƒåº¦æˆ–ç³»ç»Ÿè°ƒç”¨æ—¶ä¼šä½¿ç”¨G0çš„æ ˆç©ºé—´, å…¨å±€å˜é‡çš„G0æ˜¯M0çš„G0ã€‚</p><p>æˆ‘ä»¬æ¥è·Ÿè¸ªä¸€æ®µä»£ç </p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥é’ˆå¯¹ä¸Šé¢çš„ä»£ç å¯¹è°ƒåº¦å™¨é‡Œé¢çš„ç»“æ„åšä¸€ä¸ªåˆ†æã€‚</p><p>ä¹Ÿä¼šç»å†å¦‚ä¸Šå›¾æ‰€ç¤ºçš„è¿‡ç¨‹ï¼š</p><ol><li>runtimeåˆ›å»ºæœ€åˆçš„çº¿ç¨‹m0å’Œgoroutine g0ï¼Œå¹¶æŠŠ2è€…å…³è”ã€‚</li><li>è°ƒåº¦å™¨åˆå§‹åŒ–ï¼šåˆå§‹åŒ–m0ã€æ ˆã€åƒåœ¾å›æ”¶ï¼Œä»¥åŠåˆ›å»ºå’Œåˆå§‹åŒ–ç”±GOMAXPROCSä¸ªPæ„æˆçš„Påˆ—è¡¨ã€‚</li><li>ç¤ºä¾‹ä»£ç ä¸­çš„mainå‡½æ•°æ˜¯main.mainï¼Œruntimeä¸­ä¹Ÿæœ‰1ä¸ªmainå‡½æ•°â€”â€”runtime.mainï¼Œä»£ç ç»è¿‡ç¼–è¯‘åï¼Œruntime.mainä¼šè°ƒç”¨main.mainï¼Œç¨‹åºå¯åŠ¨æ—¶ä¼šä¸ºruntime.mainåˆ›å»ºgoroutineï¼Œç§°å®ƒä¸ºmain goroutineå§ï¼Œç„¶åæŠŠmain goroutineåŠ å…¥åˆ°Pçš„æœ¬åœ°é˜Ÿåˆ—ã€‚</li><li>å¯åŠ¨m0ï¼Œm0å·²ç»ç»‘å®šäº†Pï¼Œä¼šä»Pçš„æœ¬åœ°é˜Ÿåˆ—è·å–Gï¼Œè·å–åˆ°main goroutineã€‚</li><li>Gæ‹¥æœ‰æ ˆï¼ŒMæ ¹æ®Gä¸­çš„æ ˆä¿¡æ¯å’Œè°ƒåº¦ä¿¡æ¯è®¾ç½®è¿è¡Œç¯å¢ƒ</li><li>Mè¿è¡ŒG</li><li>Gé€€å‡ºï¼Œå†æ¬¡å›åˆ°Mè·å–å¯è¿è¡Œçš„Gï¼Œè¿™æ ·é‡å¤ä¸‹å»ï¼Œç›´åˆ°main.mainé€€å‡ºï¼Œruntime.mainæ‰§è¡ŒDeferå’ŒPanicå¤„ç†ï¼Œæˆ–è°ƒç”¨runtime.exité€€å‡ºç¨‹åºã€‚</li></ol><p>è°ƒåº¦å™¨çš„ç”Ÿå‘½å‘¨æœŸå‡ ä¹å æ»¡äº†ä¸€ä¸ªGoç¨‹åºçš„ä¸€ç”Ÿï¼Œruntime.mainçš„goroutineæ‰§è¡Œä¹‹å‰éƒ½æ˜¯ä¸ºè°ƒåº¦å™¨åšå‡†å¤‡å·¥ä½œï¼Œruntime.mainçš„goroutineè¿è¡Œï¼Œæ‰æ˜¯è°ƒåº¦å™¨çš„çœŸæ­£å¼€å§‹ï¼Œç›´åˆ°runtime.mainç»“æŸè€Œç»“æŸã€‚</p><h3 id="5-å¯è§†åŒ–GMPç¼–ç¨‹"><a href="#5-å¯è§†åŒ–GMPç¼–ç¨‹" class="headerlink" title="(5) å¯è§†åŒ–GMPç¼–ç¨‹"></a>(5) å¯è§†åŒ–GMPç¼–ç¨‹</h3><p>æœ‰2ç§æ–¹å¼å¯ä»¥æŸ¥çœ‹ä¸€ä¸ªç¨‹åºçš„GMPçš„æ•°æ®ã€‚</p><p>æ–¹å¼1ï¼šgo tool trace</p><p>traceè®°å½•äº†è¿è¡Œæ—¶çš„ä¿¡æ¯ï¼Œèƒ½æä¾›å¯è§†åŒ–çš„Webé¡µé¢ã€‚</p><p>ç®€å•æµ‹è¯•ä»£ç ï¼šmainå‡½æ•°åˆ›å»ºtraceï¼Œtraceä¼šè¿è¡Œåœ¨å•ç‹¬çš„goroutineä¸­ï¼Œç„¶åmainæ‰“å°â€Hello Worldâ€é€€å‡ºã€‚</p><p>trace.go</p><p>è¿è¡Œç¨‹åº</p><p>ä¼šå¾—åˆ°ä¸€ä¸ªtrace.outæ–‡ä»¶ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªå·¥å…·æ‰“å¼€ï¼Œæ¥åˆ†æè¿™ä¸ªæ–‡ä»¶ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡æµè§ˆå™¨æ‰“å¼€<a href="http://127.0.0.1:33479ç½‘å€ï¼Œç‚¹å‡»view">http://127.0.0.1:33479ç½‘å€ï¼Œç‚¹å‡»view</a> trace èƒ½å¤Ÿçœ‹è§å¯è§†åŒ–çš„è°ƒåº¦æµç¨‹ã€‚</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776395564-f4f1ba06-1af0-4842-a241-8ea7e56b0612.webp" alt="Image 16: 19-go-trace1.png"></p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776402701-9db41a28-ffc9-4702-8cd1-6670f8cd0d28.webp" alt="Image 17: 20-go-trace2.png"></p><p>Gä¿¡æ¯</p><p>ç‚¹å‡»Goroutinesé‚£ä¸€è¡Œå¯è§†åŒ–çš„æ•°æ®æ¡ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ä¸€äº›è¯¦ç»†çš„ä¿¡æ¯ã€‚</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776424129-7608477e-4b67-40f3-8782-a0eb346ef8eb.webp" alt="Image 18: 20-go-trace3.png"></p><p>ä¸€å…±æœ‰ä¸¤ä¸ªGåœ¨ç¨‹åºä¸­ï¼Œä¸€ä¸ªæ˜¯ç‰¹æ®Šçš„G0ï¼Œæ˜¯æ¯ä¸ªMå¿…é¡»æœ‰çš„ä¸€ä¸ªåˆå§‹åŒ–çš„Gï¼Œè¿™ä¸ªæˆ‘ä»¬ä¸å¿…è®¨è®ºã€‚</p><p>å…¶ä¸­G1åº”è¯¥å°±æ˜¯main goroutine(æ‰§è¡Œmainå‡½æ•°çš„åç¨‹)ï¼Œåœ¨ä¸€æ®µæ—¶é—´å†…å¤„äºå¯è¿è¡Œå’Œè¿è¡Œçš„çŠ¶æ€ã€‚</p><p>Mä¿¡æ¯</p><p>ç‚¹å‡»Threadsé‚£ä¸€è¡Œå¯è§†åŒ–çš„æ•°æ®æ¡ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ä¸€äº›è¯¦ç»†çš„ä¿¡æ¯ã€‚</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776444325-d259c370-0aa5-4650-a5fd-2449190c97a1.webp" alt="Image 19: 22-go-trace4.png"></p><p>ä¸€å…±æœ‰ä¸¤ä¸ªMåœ¨ç¨‹åºä¸­ï¼Œä¸€ä¸ªæ˜¯ç‰¹æ®Šçš„M0ï¼Œç”¨äºåˆå§‹åŒ–ä½¿ç”¨ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¸å¿…è®¨è®ºã€‚</p><p>Pä¿¡æ¯</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776459340-7053a162-0e39-4955-b0e6-d4714171be3a.webp" alt="Image 20: 23-go-trace5.png"></p><p>G1ä¸­è°ƒç”¨äº†main.mainï¼Œåˆ›å»ºäº†trace goroutine g18ã€‚G1è¿è¡Œåœ¨P1ä¸Šï¼ŒG18è¿è¡Œåœ¨P0ä¸Šã€‚</p><p>è¿™é‡Œæœ‰ä¸¤ä¸ªPï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œä¸€ä¸ªPå¿…é¡»ç»‘å®šä¸€ä¸ªMæ‰èƒ½è°ƒåº¦Gã€‚</p><p>æˆ‘ä»¬åœ¨æ¥çœ‹çœ‹ä¸Šé¢çš„Mä¿¡æ¯ã€‚</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776484643-1c8841a4-01a1-4948-a8a7-616678fb5317.webp" alt="Image 21: 24-go-trace6.png"></p><p>æˆ‘ä»¬ä¼šå‘ç°ï¼Œç¡®å®G18åœ¨P0ä¸Šè¢«è¿è¡Œçš„æ—¶å€™ï¼Œç¡®å®åœ¨Threadsè¡Œå¤šäº†ä¸€ä¸ªMçš„æ•°æ®ï¼Œç‚¹å‡»æŸ¥çœ‹å¦‚ä¸‹ï¼š</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776494915-1d38f0bf-cbd8-4958-ae55-1144a86e50a2.webp" alt="Image 22: 25-go-trace7.png"></p><p>å¤šäº†ä¸€ä¸ªM2åº”è¯¥å°±æ˜¯P0ä¸ºäº†æ‰§è¡ŒG18è€ŒåŠ¨æ€åˆ›å»ºçš„M2.</p><p>æ–¹å¼2ï¼šDebug trace</p><p>ç¼–è¯‘</p><p>é€šè¿‡Debugæ–¹å¼è¿è¡Œ</p><p>â—SCHEDï¼šè°ƒè¯•ä¿¡æ¯è¾“å‡ºæ ‡å¿—å­—ç¬¦ä¸²ï¼Œä»£è¡¨æœ¬è¡Œæ˜¯goroutineè°ƒåº¦å™¨çš„è¾“å‡ºï¼›<br>â—0msï¼šå³ä»ç¨‹åºå¯åŠ¨åˆ°è¾“å‡ºè¿™è¡Œæ—¥å¿—çš„æ—¶é—´ï¼›<br>â—gomaxprocs: Pçš„æ•°é‡ï¼Œæœ¬ä¾‹æœ‰2ä¸ªP, å› ä¸ºé»˜è®¤çš„Pçš„å±æ€§æ˜¯å’Œcpuæ ¸å¿ƒæ•°é‡é»˜è®¤ä¸€è‡´ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡GOMAXPROCSæ¥è®¾ç½®ï¼›<br>â—idleprocs: å¤„äºidleçŠ¶æ€çš„Pçš„æ•°é‡ï¼›é€šè¿‡gomaxprocså’Œidleprocsçš„å·®å€¼ï¼Œæˆ‘ä»¬å°±å¯çŸ¥é“æ‰§è¡Œgoä»£ç çš„Pçš„æ•°é‡ï¼›<br>â—threads: os threads&#x2F;Mçš„æ•°é‡ï¼ŒåŒ…å«schedulerä½¿ç”¨çš„mæ•°é‡ï¼ŒåŠ ä¸Šruntimeè‡ªç”¨çš„ç±»ä¼¼sysmonè¿™æ ·çš„threadçš„æ•°é‡ï¼›<br>â—spinningthreads: å¤„äºè‡ªæ—‹çŠ¶æ€çš„os threadæ•°é‡ï¼›<br>â—idlethread: å¤„äºidleçŠ¶æ€çš„os threadçš„æ•°é‡ï¼›<br>â—runqueue&#x3D;0ï¼š Schedulerå…¨å±€é˜Ÿåˆ—ä¸­Gçš„æ•°é‡ï¼›<br>â—[0 0]: åˆ†åˆ«ä¸º2ä¸ªPçš„local queueä¸­çš„Gçš„æ•°é‡ã€‚</p><p>ä¸‹ä¸€ç¯‡ï¼Œæˆ‘ä»¬æ¥ç»§ç»­è¯¦ç»†çš„åˆ†æGMPè°ƒåº¦åŸç†çš„ä¸€äº›åœºæ™¯é—®é¢˜ã€‚</p><h2 id="ä¸‰ã€Goè°ƒåº¦å™¨è°ƒåº¦åœºæ™¯è¿‡ç¨‹å…¨è§£æ"><a href="#ä¸‰ã€Goè°ƒåº¦å™¨è°ƒåº¦åœºæ™¯è¿‡ç¨‹å…¨è§£æ" class="headerlink" title="ä¸‰ã€Goè°ƒåº¦å™¨è°ƒåº¦åœºæ™¯è¿‡ç¨‹å…¨è§£æ"></a>ä¸‰ã€Goè°ƒåº¦å™¨è°ƒåº¦åœºæ™¯è¿‡ç¨‹å…¨è§£æ</h2><p>(1)åœºæ™¯1</p><p>Pæ‹¥æœ‰G1ï¼ŒM1è·å–Påå¼€å§‹è¿è¡ŒG1ï¼ŒG1ä½¿ç”¨go func()åˆ›å»ºäº†G2ï¼Œä¸ºäº†å±€éƒ¨æ€§G2ä¼˜å…ˆåŠ å…¥åˆ°Pçš„æœ¬åœ°é˜Ÿåˆ—ã€‚</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776522560-a33b69e2-2842-4132-8cbe-f2bad017bc7e.webp" alt="Image 23: 26-gmpåœºæ™¯1.png"></p><p>(2)åœºæ™¯2</p><p>G1è¿è¡Œå®Œæˆå(å‡½æ•°ï¼šgoexit)ï¼ŒMä¸Šè¿è¡Œçš„goroutineåˆ‡æ¢ä¸ºG0ï¼ŒG0è´Ÿè´£è°ƒåº¦æ—¶åç¨‹çš„åˆ‡æ¢ï¼ˆå‡½æ•°ï¼šscheduleï¼‰ã€‚ä»Pçš„æœ¬åœ°é˜Ÿåˆ—å–G2ï¼Œä»G0åˆ‡æ¢åˆ°G2ï¼Œå¹¶å¼€å§‹è¿è¡ŒG2(å‡½æ•°ï¼šexecute)ã€‚å®ç°äº†çº¿ç¨‹M1çš„å¤ç”¨ã€‚</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776536644-c6fba007-d952-4a22-8939-ca1a898a5c3c.webp" alt="Image 24: 27-gmpåœºæ™¯2.png"></p><p>(3)åœºæ™¯3</p><p>å‡è®¾æ¯ä¸ªPçš„æœ¬åœ°é˜Ÿåˆ—åªèƒ½å­˜3ä¸ªGã€‚G2è¦åˆ›å»ºäº†6ä¸ªGï¼Œå‰3ä¸ªGï¼ˆG3, G4, G5ï¼‰å·²ç»åŠ å…¥p1çš„æœ¬åœ°é˜Ÿåˆ—ï¼Œp1æœ¬åœ°é˜Ÿåˆ—æ»¡äº†ã€‚</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776549767-57ceac17-5504-46ac-af56-0dba59359e8b.webp" alt="Image 25: 28-gmpåœºæ™¯3.png"></p><p>(4)åœºæ™¯4</p><p>G2åœ¨åˆ›å»ºG7çš„æ—¶å€™ï¼Œå‘ç°P1çš„æœ¬åœ°é˜Ÿåˆ—å·²æ»¡ï¼Œéœ€è¦æ‰§è¡Œè´Ÿè½½å‡è¡¡(æŠŠP1ä¸­æœ¬åœ°é˜Ÿåˆ—ä¸­å‰ä¸€åŠçš„Gï¼Œè¿˜æœ‰æ–°åˆ›å»ºGè½¬ç§»åˆ°å…¨å±€é˜Ÿåˆ—)</p><p>ï¼ˆå®ç°ä¸­å¹¶ä¸ä¸€å®šæ˜¯æ–°çš„Gï¼Œå¦‚æœGæ˜¯G2ä¹‹åå°±æ‰§è¡Œçš„ï¼Œä¼šè¢«ä¿å­˜åœ¨æœ¬åœ°é˜Ÿåˆ—ï¼Œåˆ©ç”¨æŸä¸ªè€çš„Gæ›¿æ¢æ–°GåŠ å…¥å…¨å±€é˜Ÿåˆ—ï¼‰</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776570176-d9d5abd4-3a48-461c-a43c-6ef504c4038f.webp" alt="Image 26: 29-gmpåœºæ™¯4.png"></p><p>è¿™äº›Gè¢«è½¬ç§»åˆ°å…¨å±€é˜Ÿåˆ—æ—¶ï¼Œä¼šè¢«æ‰“ä¹±é¡ºåºã€‚æ‰€ä»¥G3,G4,G7è¢«è½¬ç§»åˆ°å…¨å±€é˜Ÿåˆ—ã€‚<br>(5)åœºæ™¯5</p><p>G2åˆ›å»ºG8æ—¶ï¼ŒP1çš„æœ¬åœ°é˜Ÿåˆ—æœªæ»¡ï¼Œæ‰€ä»¥G8ä¼šè¢«åŠ å…¥åˆ°P1çš„æœ¬åœ°é˜Ÿåˆ—ã€‚</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776584395-dfb9c26b-b0a8-4c17-b46e-649302df87d5.webp" alt="Image 27: 30-gmpåœºæ™¯5.png"></p><p>G8åŠ å…¥åˆ°P1ç‚¹æœ¬åœ°é˜Ÿåˆ—çš„åŸå› è¿˜æ˜¯å› ä¸ºP1æ­¤æ—¶åœ¨ä¸M1ç»‘å®šï¼Œè€ŒG2æ­¤æ—¶æ˜¯M1åœ¨æ‰§è¡Œã€‚æ‰€ä»¥G2åˆ›å»ºçš„æ–°çš„Gä¼šä¼˜å…ˆæ”¾ç½®åˆ°è‡ªå·±çš„Mç»‘å®šçš„Pä¸Šã€‚<br>(6)åœºæ™¯6</p><p>è§„å®šï¼šåœ¨åˆ›å»ºGæ—¶ï¼Œè¿è¡Œçš„Gä¼šå°è¯•å”¤é†’å…¶ä»–ç©ºé—²çš„På’ŒMç»„åˆå»æ‰§è¡Œã€‚</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776600276-58bdcec4-00e6-4f24-89c8-e4f01fd1d9fb.webp" alt="Image 28: 31-gmpåœºæ™¯6.png"></p><p>å‡å®šG2å”¤é†’äº†M2ï¼ŒM2ç»‘å®šäº†P2ï¼Œå¹¶è¿è¡ŒG0ï¼Œä½†P2æœ¬åœ°é˜Ÿåˆ—æ²¡æœ‰Gï¼ŒM2æ­¤æ—¶ä¸ºè‡ªæ—‹çº¿ç¨‹ï¼ˆæ²¡æœ‰Gä½†ä¸ºè¿è¡ŒçŠ¶æ€çš„çº¿ç¨‹ï¼Œä¸æ–­å¯»æ‰¾Gï¼‰ã€‚<br>(7)åœºæ™¯7</p><p>M2å°è¯•ä»å…¨å±€é˜Ÿåˆ—(ç®€ç§°â€œGQâ€)å–ä¸€æ‰¹Gæ”¾åˆ°P2çš„æœ¬åœ°é˜Ÿåˆ—ï¼ˆå‡½æ•°ï¼šfindrunnable()ï¼‰ã€‚M2ä»å…¨å±€é˜Ÿåˆ—å–çš„Gæ•°é‡ç¬¦åˆä¸‹é¢çš„å…¬å¼ï¼š</p><p>ç›¸å…³æºç å‚è€ƒ:</p><p>è‡³å°‘ä»å…¨å±€é˜Ÿåˆ—å–1ä¸ªgï¼Œä½†æ¯æ¬¡ä¸è¦ä»å…¨å±€é˜Ÿåˆ—ç§»åŠ¨å¤ªå¤šçš„gåˆ°pæœ¬åœ°é˜Ÿåˆ—ï¼Œç»™å…¶ä»–pç•™ç‚¹ã€‚è¿™æ˜¯ä»å…¨å±€é˜Ÿåˆ—åˆ°Pæœ¬åœ°é˜Ÿåˆ—çš„è´Ÿè½½å‡è¡¡ã€‚</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650776688586-9207de08-5203-403f-8857-42942e84dcb1.webp" alt="Image 29: 32-gmpåœºæ™¯7.001.jpeg"></p><p>å‡å®šæˆ‘ä»¬åœºæ™¯ä¸­ä¸€å…±æœ‰4ä¸ªPï¼ˆGOMAXPROCSè®¾ç½®ä¸º4ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…è®¸æœ€å¤šå°±èƒ½ç”¨4ä¸ªPæ¥ä¾›Mä½¿ç”¨ï¼‰ã€‚æ‰€ä»¥M2åªä»èƒ½ä»å…¨å±€é˜Ÿåˆ—å–1ä¸ªGï¼ˆå³G3ï¼‰ç§»åŠ¨P2æœ¬åœ°é˜Ÿåˆ—ï¼Œç„¶åå®Œæˆä»G0åˆ°G3çš„åˆ‡æ¢ï¼Œè¿è¡ŒG3ã€‚<br>(8)åœºæ™¯8</p><p>å‡è®¾G2ä¸€ç›´åœ¨M1ä¸Šè¿è¡Œï¼Œç»è¿‡2è½®åï¼ŒM2å·²ç»æŠŠG7ã€G4ä»å…¨å±€é˜Ÿåˆ—è·å–åˆ°äº†P2çš„æœ¬åœ°é˜Ÿåˆ—å¹¶å®Œæˆè¿è¡Œï¼Œå…¨å±€é˜Ÿåˆ—å’ŒP2çš„æœ¬åœ°é˜Ÿåˆ—éƒ½ç©ºäº†,å¦‚åœºæ™¯8å›¾çš„å·¦åŠéƒ¨åˆ†ã€‚</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650777780659-cef000df-3d46-4fd5-b0ed-3dc466bf1cd2.webp" alt="Image 30: 33-gmpåœºæ™¯8.png"></p><p>å…¨å±€é˜Ÿåˆ—å·²ç»æ²¡æœ‰Gï¼Œé‚£må°±è¦æ‰§è¡Œwork stealing(å·å–)ï¼šä»å…¶ä»–æœ‰Gçš„På“ªé‡Œå·å–ä¸€åŠGè¿‡æ¥ï¼Œæ”¾åˆ°è‡ªå·±çš„Pæœ¬åœ°é˜Ÿåˆ—ã€‚P2ä»P1çš„æœ¬åœ°é˜Ÿåˆ—å°¾éƒ¨å–ä¸€åŠçš„Gï¼Œæœ¬ä¾‹ä¸­ä¸€åŠåˆ™åªæœ‰1ä¸ªG8ï¼Œæ”¾åˆ°P2çš„æœ¬åœ°é˜Ÿåˆ—å¹¶æ‰§è¡Œã€‚<br>(9)åœºæ™¯9</p><p>G1æœ¬åœ°é˜Ÿåˆ—G5ã€G6å·²ç»è¢«å…¶ä»–Må·èµ°å¹¶è¿è¡Œå®Œæˆï¼Œå½“å‰M1å’ŒM2åˆ†åˆ«åœ¨è¿è¡ŒG2å’ŒG8ï¼ŒM3å’ŒM4æ²¡æœ‰goroutineå¯ä»¥è¿è¡Œï¼ŒM3å’ŒM4å¤„äºè‡ªæ—‹çŠ¶æ€ï¼Œå®ƒä»¬ä¸æ–­å¯»æ‰¾goroutineã€‚</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650777794441-a7ed7fc2-e495-4022-a3b6-581930e5acd0.webp" alt="Image 31: 34-gmpåœºæ™¯9.png"></p><p>ä¸ºä»€ä¹ˆè¦è®©m3å’Œm4è‡ªæ—‹ï¼Œè‡ªæ—‹æœ¬è´¨æ˜¯åœ¨è¿è¡Œï¼Œçº¿ç¨‹åœ¨è¿è¡Œå´æ²¡æœ‰æ‰§è¡ŒGï¼Œå°±å˜æˆäº†æµªè´¹CPU.  ä¸ºä»€ä¹ˆä¸é”€æ¯ç°åœºï¼Œæ¥èŠ‚çº¦CPUèµ„æºã€‚å› ä¸ºåˆ›å»ºå’Œé”€æ¯CPUä¹Ÿä¼šæµªè´¹æ—¶é—´ï¼Œæˆ‘ä»¬å¸Œæœ›å½“æœ‰æ–°goroutineåˆ›å»ºæ—¶ï¼Œç«‹åˆ»èƒ½æœ‰Mè¿è¡Œå®ƒï¼Œå¦‚æœé”€æ¯å†æ–°å»ºå°±å¢åŠ äº†æ—¶å»¶ï¼Œé™ä½äº†æ•ˆç‡ã€‚å½“ç„¶ä¹Ÿè€ƒè™‘äº†è¿‡å¤šçš„è‡ªæ—‹çº¿ç¨‹æ˜¯æµªè´¹CPUï¼Œæ‰€ä»¥ç³»ç»Ÿä¸­æœ€å¤šæœ‰GOMAXPROCSä¸ªè‡ªæ—‹çš„çº¿ç¨‹(å½“å‰ä¾‹å­ä¸­çš„GOMAXPROCS&#x3D;4ï¼Œæ‰€ä»¥ä¸€å…±4ä¸ªP)ï¼Œå¤šä½™çš„æ²¡äº‹åšçº¿ç¨‹ä¼šè®©ä»–ä»¬ä¼‘çœ ã€‚<br>(10)åœºæ™¯10</p><p>å‡å®šå½“å‰é™¤äº†M3å’ŒM4ä¸ºè‡ªæ—‹çº¿ç¨‹ï¼Œè¿˜æœ‰M5å’ŒM6ä¸ºç©ºé—²çš„çº¿ç¨‹(æ²¡æœ‰å¾—åˆ°Pçš„ç»‘å®šï¼Œæ³¨æ„æˆ‘ä»¬è¿™é‡Œæœ€å¤šå°±åªèƒ½å¤Ÿå­˜åœ¨4ä¸ªPï¼Œæ‰€ä»¥Pçš„æ•°é‡åº”è¯¥æ°¸è¿œæ˜¯M&gt;&#x3D;P, å¤§éƒ¨åˆ†éƒ½æ˜¯Måœ¨æŠ¢å éœ€è¦è¿è¡Œçš„P)ï¼ŒG8åˆ›å»ºäº†G9ï¼ŒG8è¿›è¡Œäº†é˜»å¡çš„ç³»ç»Ÿè°ƒç”¨ï¼ŒM2å’ŒP2ç«‹å³è§£ç»‘ï¼ŒP2ä¼šæ‰§è¡Œä»¥ä¸‹åˆ¤æ–­ï¼šå¦‚æœP2æœ¬åœ°é˜Ÿåˆ—æœ‰Gã€å…¨å±€é˜Ÿåˆ—æœ‰Gæˆ–æœ‰ç©ºé—²çš„Mï¼ŒP2éƒ½ä¼šç«‹é©¬å”¤é†’1ä¸ªMå’Œå®ƒç»‘å®šï¼Œå¦åˆ™P2åˆ™ä¼šåŠ å…¥åˆ°ç©ºé—²Påˆ—è¡¨ï¼Œç­‰å¾…Mæ¥è·å–å¯ç”¨çš„pã€‚æœ¬åœºæ™¯ä¸­ï¼ŒP2æœ¬åœ°é˜Ÿåˆ—æœ‰G9ï¼Œå¯ä»¥å’Œå…¶ä»–ç©ºé—²çš„çº¿ç¨‹M5ç»‘å®šã€‚</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650777810926-ca4030f3-f29a-4211-8722-677b229be440.webp" alt="Image 32: 35-gmpåœºæ™¯10.png"></p><p>(11)åœºæ™¯11</p><p>G8åˆ›å»ºäº†G9ï¼Œå‡å¦‚G8è¿›è¡Œäº†éé˜»å¡ç³»ç»Ÿè°ƒç”¨ã€‚</p><p><img src="/2025/03/24/Golang-GMP%E6%A8%A1%E5%9E%8B/1650777823944-25f0ea1a-3431-457e-b4cf-342654a953b6.webp" alt="Image 33: 36-gmpåœºæ™¯11.png"></p><p>M2å’ŒP2ä¼šè§£ç»‘ï¼Œä½†M2ä¼šè®°ä½P2ï¼Œç„¶åG8å’ŒM2è¿›å…¥ç³»ç»Ÿè°ƒç”¨çŠ¶æ€ã€‚å½“G8å’ŒM2é€€å‡ºç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œä¼šå°è¯•è·å–P2ï¼Œå¦‚æœæ— æ³•è·å–ï¼Œåˆ™è·å–ç©ºé—²çš„Pï¼Œå¦‚æœä¾ç„¶æ²¡æœ‰ï¼ŒG8ä¼šè¢«è®°ä¸ºå¯è¿è¡ŒçŠ¶æ€ï¼Œå¹¶åŠ å…¥åˆ°å…¨å±€é˜Ÿåˆ—,M2å› ä¸ºæ²¡æœ‰Pçš„ç»‘å®šè€Œå˜æˆä¼‘çœ çŠ¶æ€(é•¿æ—¶é—´ä¼‘çœ ç­‰å¾…GCå›æ”¶é”€æ¯)ã€‚</p><h2 id="å››ã€å°ç»“"><a href="#å››ã€å°ç»“" class="headerlink" title="å››ã€å°ç»“"></a>å››ã€å°ç»“</h2><p>æ€»ç»“ï¼ŒGoè°ƒåº¦å™¨å¾ˆè½»é‡ä¹Ÿå¾ˆç®€å•ï¼Œè¶³ä»¥æ’‘èµ·goroutineçš„è°ƒåº¦å·¥ä½œï¼Œå¹¶ä¸”è®©Goå…·æœ‰äº†åŸç”Ÿï¼ˆå¼ºå¤§ï¼‰å¹¶å‘çš„èƒ½åŠ›ã€‚Goè°ƒåº¦æœ¬è´¨æ˜¯æŠŠå¤§é‡çš„goroutineåˆ†é…åˆ°å°‘é‡çº¿ç¨‹ä¸Šå»æ‰§è¡Œï¼Œå¹¶åˆ©ç”¨å¤šæ ¸å¹¶è¡Œï¼Œå®ç°æ›´å¼ºå¤§çš„å¹¶å‘ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Go Map</title>
    <link href="/2025/03/22/go-map%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/"/>
    <url>/2025/03/22/go-map%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="Go-Map"><a href="#Go-Map" class="headerlink" title="Go Map"></a>Go Map</h1><p>map æ˜¯ä¸€ç§key-valueçš„é”®å€¼å¯¹å­˜å‚¨ç»“æ„ï¼Œå…¶ä¸­keyä¸èƒ½é‡å¤ï¼Œåº•å±‚ç”¨<a href="https://zhida.zhihu.com/search?content_id=198353368&content_type=Article&match_order=1&q=hash%E8%A1%A8&zhida_source=entity">hashè¡¨</a>å­˜å‚¨ã€‚</p><p>å¹³æ—¥é‡Œæˆ‘ä»¬ä¸€èˆ¬æ˜¯è¿™æ ·ä½¿ç”¨mapçš„ï¼š</p><blockquote><p>&#x2F;&#x2F; åˆ›å»º<br>&#x2F;&#x2F; map[KeyType]ValueType<br>var m map[int]int<br>m :&#x3D; make(map[int]int)<br>m :&#x3D; map[int]int{<br>1: 1,<br>2: 2,<br>}<br>&#x2F;&#x2F; è¯»å–<br>i :&#x3D; m[1]<br>v, ok :&#x3D; m[1]<br>â€‹<br>&#x2F;&#x2F; éå†<br>for key, value :&#x3D; range m {<br>println(â€œKey: â€œ, key, â€œValue: â€œ, value)<br>}<br>â€‹<br>&#x2F;&#x2F; åˆ é™¤<br>delete(m, 1)</p></blockquote><p>mapçš„æ•°æ®ç»“æ„åœ¨æºç ç»“æ„ä¸­çš„å…³é”®å­—æ®µå¦‚ä¸‹ï¼Œåœ¨<code>src/runtime/map.go</code>ä¸­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> hmap <span class="hljs-keyword">struct</span> &#123;<br>    count     <span class="hljs-type">int</span>    <span class="hljs-comment">// å…ƒç´ çš„ä¸ªæ•°</span><br>    B         <span class="hljs-type">uint8</span>  <span class="hljs-comment">// buckets æ•°ç»„çš„é•¿åº¦å°±æ˜¯ 2^B ä¸ª</span><br>    overflow <span class="hljs-type">uint16</span> <span class="hljs-comment">// æº¢å‡ºæ¡¶çš„æ•°é‡</span><br><br>    buckets    unsafe.Pointer <span class="hljs-comment">// 2^Bä¸ªæ¡¶å¯¹åº”çš„æ•°ç»„æŒ‡é’ˆ</span><br>    oldbuckets unsafe.Pointer  <span class="hljs-comment">// å‘ç”Ÿæ‰©å®¹æ—¶ï¼Œè®°å½•æ‰©å®¹å‰çš„bucketsæ•°ç»„æŒ‡é’ˆ</span><br><br>    extra *mapextra <span class="hljs-comment">//ç”¨äºä¿å­˜æº¢å‡ºæ¡¶çš„åœ°å€</span><br>&#125;<br><br><span class="hljs-keyword">type</span> mapextra <span class="hljs-keyword">struct</span> &#123;<br>    overflow    *[]*bmap<br>    oldoverflow *[]*bmap<br><br>    nextOverflow *bmap<br>&#125;<br><br><span class="hljs-keyword">type</span> bmap <span class="hljs-keyword">struct</span> &#123;<br>    tophash [bucketCnt]<span class="hljs-type">uint8</span><br>&#125;<br><br><span class="hljs-comment">//åœ¨ç¼–è¯‘æœŸé—´ä¼šäº§ç”Ÿæ–°çš„ç»“æ„ä½“</span><br><span class="hljs-keyword">type</span> bmap <span class="hljs-keyword">struct</span> &#123;<br>    tophash [<span class="hljs-number">8</span>]<span class="hljs-type">uint8</span> <span class="hljs-comment">//å­˜å‚¨å“ˆå¸Œå€¼çš„é«˜8ä½</span><br>    data    <span class="hljs-type">byte</span>[<span class="hljs-number">1</span>]  <span class="hljs-comment">//key valueæ•°æ®:key/key/key/.../value/value/value...</span><br>    overflow *bmap   <span class="hljs-comment">//æº¢å‡ºbucketçš„åœ°å€</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p>ä¸ºäº†ä¾¿äºç†è§£æºç çš„ç»“æ„ï¼Œæˆ‘ä»¬æç‚¼å…³é”®å­—æ®µå¹¶è½¬æ¢ä¸ºå›¾å½¢æ¨¡å¼ï¼š</p><p><img src="/2025/03/22/go-map%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/v2-a8fbef952441e788d882d0656c2cf091_1440w.jpg" alt="img"></p><p>åœ¨goçš„mapå®ç°ä¸­ï¼Œå®ƒçš„åº•å±‚ç»“æ„ä½“æ˜¯hmapï¼Œhmapé‡Œç»´æŠ¤ç€è‹¥å¹²ä¸ªbucketæ•°ç»„ (å³æ¡¶æ•°ç»„)ã€‚</p><p>Bucketæ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ éƒ½æ˜¯bmapç»“æ„ï¼Œä¹Ÿå³æ¯ä¸ªbucketï¼ˆæ¡¶ï¼‰éƒ½æ˜¯bmapç»“æ„ï¼Œã€psï¼šåæ–‡ä¸ºäº†è¯­ä¹‰ä¸€è‡´ï¼Œå’Œæ–¹ä¾¿ç†è§£ï¼Œå°±ä¸å†æbmapäº†ï¼Œç»Ÿä¸€å«ä½œæ¡¶ã€‘ æ¯ä¸ªæ¡¶ä¸­ä¿å­˜äº†8ä¸ªkvå¯¹ï¼Œå¦‚æœ8ä¸ªæ»¡äº†ï¼Œåˆæ¥äº†ä¸€ä¸ªkeyè½åœ¨äº†è¿™ä¸ªæ¡¶é‡Œï¼Œä¼šä½¿ç”¨overflowè¿æ¥ä¸‹ä¸€ä¸ªæ¡¶(æº¢å‡ºæ¡¶)ã€‚</p><h2 id="mapä¸­æ•°æ®æ“ä½œ"><a href="#mapä¸­æ•°æ®æ“ä½œ" class="headerlink" title="mapä¸­æ•°æ®æ“ä½œ"></a><strong>mapä¸­æ•°æ®æ“ä½œ</strong></h2><p>äº†è§£äº†mapçš„æ•°æ®ç»“æ„åï¼Œä¸‹é¢è®©æˆ‘ä»¬å­¦ä¹ ä¸€ä¸‹åœ¨mapä¸­å­˜å–æ•°æ®çš„è¿‡ç¨‹ï¼š</p><h3 id="GETè·å–æ•°æ®"><a href="#GETè·å–æ•°æ®" class="headerlink" title="GETè·å–æ•°æ®"></a><strong>GETè·å–æ•°æ®</strong></h3><p><strong>å‡è®¾å½“å‰ B&#x3D;4 å³æ¡¶æ•°é‡ä¸º2^B&#x3D;16ä¸ª</strong>ï¼Œè¦ä»mapä¸­è·å–k4å¯¹åº”çš„value</p><p><img src="/2025/03/22/go-map%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/v2-c289a260a1d233fd862d79eef50fdf76_1440w.jpg" alt="img"></p><p>img</p><p><strong>å‚è€ƒä¸Šå›¾ï¼Œk4çš„getæµç¨‹å¯ä»¥å½’çº³ä¸ºå¦‚ä¸‹å‡ æ­¥ï¼š</strong></p><p>â‘ <strong>è®¡ç®—k4çš„hashå€¼</strong>ã€‚[ç”±äºå½“å‰ä¸»æµæœºéƒ½æ˜¯64ä½æ“ä½œç³»ç»Ÿï¼Œæ‰€ä»¥è®¡ç®—ç»“æœæœ‰64ä¸ªæ¯”ç‰¹ä½]</p><p>â‘¡<strong>é€šè¿‡æœ€åçš„â€œBâ€ä½æ¥ç¡®å®šåœ¨å“ªå·æ¡¶</strong>ï¼Œæ­¤æ—¶Bä¸º4ï¼Œæ‰€ä»¥å–k4å¯¹åº”å“ˆå¸Œå€¼çš„å4ä½ï¼Œä¹Ÿå°±æ˜¯0101ï¼Œ0101ç”¨åè¿›åˆ¶è¡¨ç¤ºä¸º5ï¼Œæ‰€ä»¥åœ¨5å·æ¡¶ï¼‰</p><p>â‘¢<strong>æ ¹æ®k4å¯¹åº”çš„hashå€¼å‰8ä½å¿«é€Ÿç¡®å®šæ˜¯åœ¨è¿™ä¸ªæ¡¶çš„å“ªä¸ªä½ç½®</strong>ï¼ˆé¢å¤–è¯´æ˜ä¸€ä¸‹ï¼Œåœ¨bmapä¸­å­˜æ”¾äº†æ¯ä¸ªkeyå¯¹åº”çš„tophashï¼Œæ˜¯keyçš„å“ˆå¸Œå€¼å‰8ä½),ä¸€æ—¦å‘ç°å‰8ä½ä¸€è‡´ï¼Œåˆ™ä¼šæ‰§è¡Œä¸‹ä¸€æ­¥</p><p>â‘£<strong>å¯¹æ¯”keyå®Œæ•´çš„hashæ˜¯å¦åŒ¹é…</strong>ï¼Œå¦‚æœåŒ¹é…åˆ™è·å–å¯¹åº”value</p><p>â‘¤<strong>å¦‚æœéƒ½æ²¡æœ‰æ‰¾åˆ°ï¼Œå°±å»è¿æ¥çš„ä¸‹ä¸€ä¸ªæº¢å‡ºæ¡¶ä¸­æ‰¾</strong></p><p>æœ‰å¾ˆå¤šåŒå­¦ä¼šé—®è¿™é‡Œä¸ºä»€ä¹ˆè¦å¤šç»´æŠ¤ä¸€ä¸ªtophashï¼Œå³hashå‰8ä½ï¼Ÿ</p><p>è¿™æ˜¯å› ä¸ºtophashå¯ä»¥å¿«é€Ÿç¡®å®škeyæ˜¯å¦æ­£ç¡®ï¼Œä¹Ÿå¯ä»¥æŠŠå®ƒç†è§£æˆä¸€ç§ç¼“å­˜æªæ–½ï¼Œå¦‚æœå‰8ä½éƒ½ä¸å¯¹äº†ï¼Œåé¢å°±æ²¡æœ‰å¿…è¦æ¯”è¾ƒäº†ã€‚</p><h3 id="PUTå­˜æ”¾æ•°æ®"><a href="#PUTå­˜æ”¾æ•°æ®" class="headerlink" title="PUTå­˜æ”¾æ•°æ®"></a><strong>PUTå­˜æ”¾æ•°æ®</strong></h3><p><img src="/2025/03/22/go-map%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/v2-c289a260a1d233fd862d79eef50fdf76_1440w.jpg" alt="img"></p><p>img</p><p><strong>mapçš„èµ‹å€¼æµç¨‹å¯æ€»ç»“ä½å¦‚ä¸‹å‡ æ­¥ï¼š</strong></p><p>â‘ <strong>é€šè¿‡keyçš„hashå€¼åâ€œBâ€ä½ç¡®å®šæ˜¯å“ªä¸€ä¸ªæ¡¶</strong>ï¼Œå›¾ä¸­ç¤ºä¾‹ä¸º4å·æ¡¶ã€‚</p><p>â‘¡ éå†å½“å‰æ¡¶ï¼Œé€šè¿‡keyçš„tophashå’Œhashå€¼ï¼Œé˜²æ­¢keyé‡å¤ï¼Œç„¶å<strong>æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯ä»¥æ’å…¥çš„ä½ç½®</strong>ï¼Œå³ç©ºä½ç½®å¤„å­˜å‚¨æ•°æ®ã€‚</p><p>â‘¢å¦‚æœ<strong>å½“å‰æ¡¶å…ƒç´ å·²æ»¡ï¼Œä¼šé€šè¿‡overflowé“¾æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„æ¡¶</strong>ï¼Œæ¥å­˜å‚¨æ•°æ®ã€‚</p><p><strong>å…³äºhashå†²çª</strong>ï¼šå½“ä¸¤ä¸ªä¸åŒçš„ key è½åœ¨åŒä¸€ä¸ªæ¡¶ä¸­ï¼Œå°±æ˜¯å‘ç”Ÿäº†å“ˆå¸Œå†²çªã€‚å†²çªçš„è§£å†³æ‰‹æ®µæ˜¯é‡‡ç”¨é“¾è¡¨æ³•ï¼šåœ¨ æ¡¶ ä¸­ï¼Œä»å‰å¾€åæ‰¾åˆ°ç¬¬ä¸€ä¸ªç©ºä½è¿›è¡Œæ’å…¥ã€‚å¦‚æœ8ä¸ªkvæ»¡äº†ï¼Œé‚£ä¹ˆå½“å‰æ¡¶å°±ä¼šè¿æ¥åˆ°ä¸‹ä¸€ä¸ªæº¢å‡ºæ¡¶ï¼ˆbmapï¼‰ã€‚</p><h3 id="æ‰©å®¹"><a href="#æ‰©å®¹" class="headerlink" title="æ‰©å®¹"></a><strong>æ‰©å®¹</strong></h3><h3 id="æ‰©å®¹çš„æ–¹å¼"><a href="#æ‰©å®¹çš„æ–¹å¼" class="headerlink" title="æ‰©å®¹çš„æ–¹å¼"></a><strong>æ‰©å®¹çš„æ–¹å¼</strong></h3><p>æ‰©å®¹æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯ç­‰é‡æ‰©å®¹ï¼Œå¦ä¸€ç§æ˜¯2å€æ‰©å®¹</p><ul><li><strong>ç›¸åŒå®¹é‡æ‰©å®¹</strong></li></ul><p>ç”±äºmapä¸­ä¸æ–­çš„putå’Œdelete keyï¼Œæ¡¶ä¸­å¯èƒ½ä¼šå‡ºç°å¾ˆå¤šæ–­æ–­ç»­ç»­çš„ç©ºä½ï¼Œè¿™äº›ç©ºä½ä¼šå¯¼è‡´è¿æ¥çš„bmapæº¢å‡ºæ¡¶å¾ˆé•¿ï¼Œå¯¼è‡´æ‰«ææ—¶é—´è¾¹é•¿ã€‚è¿™ç§æ‰©å®¹å®é™…ä¸Šæ˜¯ä¸€ç§æ•´ç†ï¼ŒæŠŠåç½®ä½çš„æ•°æ®æ•´ç†åˆ°å‰é¢ã€‚<strong>è¿™ç§æƒ…å†µä¸‹ï¼Œå…ƒç´ ä¼šå‘ç”Ÿé‡æ’ï¼Œä½†ä¸ä¼šæ¢æ¡¶ã€‚</strong></p><p><img src="/2025/03/22/go-map%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/v2-2ecbb8a8c52d395061f67e41620b1504_1440w.jpg" alt="img"></p><p>img</p><ul><li><strong>2å€å®¹é‡æ‰©å®¹</strong></li></ul><p>è¿™ç§2å€æ‰©å®¹æ˜¯ç”±äºå½“å‰æ¡¶æ•°ç»„ç¡®å®ä¸å¤Ÿç”¨äº†ï¼Œ<strong>å‘ç”Ÿè¿™ç§æ‰©å®¹æ—¶ï¼Œå…ƒç´ ä¼šé‡æ’ï¼Œå¯èƒ½ä¼šå‘ç”Ÿæ¡¶è¿ç§»</strong>ã€‚</p><p>å¦‚å›¾ä¸­æ‰€ç¤ºï¼Œæ‰©å®¹å‰B&#x3D;2,æ‰©å®¹åB&#x3D;3ï¼Œå‡è®¾ä¸€å…ƒç´ keyçš„hashå€¼åä¸‰ä½ä¸º101ï¼Œé‚£ä¹ˆç”±ä¸Šæ–‡çš„ä»‹ç»å¯çŸ¥ï¼Œåœ¨æ‰©å®¹å‰ï¼Œç”±hashå€¼çš„åä¸¤ä½æ¥å†³å®šå‡ å·æ¡¶ï¼Œå³ 01 æ‰€ä»¥å…ƒç´ åœ¨1å·æ¡¶ã€‚ åœ¨æ‰©å®¹å‘ç”Ÿåï¼Œç”±hashå€¼å¾—åä¸‰ä½æ¥å†³å®šå‡ å·æ¡¶ï¼Œå³101æ‰€ä»¥å…ƒç´ ä¼šè¿ç§»åˆ°5å·æ¡¶ã€‚</p><p><img src="/2025/03/22/go-map%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/v2-d38e6d960012d58d4192f904985a4ca1_1440w.jpg" alt="img"></p><p>img</p><h2 id="å‘ç”Ÿæ‰©å®¹çš„æ¡ä»¶"><a href="#å‘ç”Ÿæ‰©å®¹çš„æ¡ä»¶" class="headerlink" title="å‘ç”Ÿæ‰©å®¹çš„æ¡ä»¶"></a><strong>å‘ç”Ÿæ‰©å®¹çš„æ¡ä»¶</strong></h2><p>é¦–å…ˆæˆ‘ä»¬äº†è§£ä¸‹**<a href="https://zhida.zhihu.com/search?content_id=198353368&content_type=Article&match_order=1&q=%E8%A3%85%E8%BD%BD%E5%9B%A0%E5%AD%90&zhida_source=entity">è£…è½½å› å­</a>(loadFactor)**çš„æ¦‚å¿µ</p><p>loadFactor:&#x3D;count &#x2F; (2^B) å³ è£…è½½å› å­ &#x3D; mapä¸­å…ƒç´ çš„ä¸ªæ•° &#x2F; mapä¸­å½“å‰æ¡¶çš„ä¸ªæ•°</p><p>é€šè¿‡è®¡ç®—å…¬å¼æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼Œ<strong>è£…è½½å› å­æ˜¯æŒ‡å½“å‰mapä¸­ï¼Œæ¯ä¸ªæ¡¶ä¸­çš„å¹³å‡å…ƒç´ ä¸ªæ•°ã€‚</strong></p><p><strong>æ‰©å®¹æ¡ä»¶1</strong>ï¼š<strong>è£…è½½å› å­ &gt; 6.5</strong> (æºç ä¸­å®šä¹‰çš„)</p><p>è¿™ä¸ªä¹Ÿéå¸¸å®¹æ˜“ç†è§£ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰æº¢å‡ºæ¡¶ï¼Œé‚£ä¹ˆä¸€ä¸ªæ¡¶ä¸­æœ€å¤šæœ‰8ä¸ªå…ƒç´ ï¼Œå½“å¹³å‡æ¯ä¸ªæ¡¶ä¸­çš„æ•°æ®è¶…è¿‡äº†6.5ä¸ªï¼Œé‚£å°±æ„å‘³ç€å½“å‰å®¹é‡è¦ä¸è¶³äº†ï¼Œå‘ç”Ÿæ‰©å®¹ã€‚</p><p><strong>æ‰©å®¹æ¡ä»¶2</strong>: <strong>æº¢å‡ºæ¡¶çš„æ•°é‡è¿‡å¤š</strong></p><p>å½“ B &lt; 15 æ—¶ï¼Œå¦‚æœoverflowçš„bucketæ•°é‡è¶…è¿‡ 2^Bã€‚</p><p>å½“ B &gt;&#x3D; 15 æ—¶ï¼Œoverflowçš„bucketæ•°é‡è¶…è¿‡ 2^15ã€‚</p><p>ç®€å•æ¥è®²ï¼Œæ–°åŠ å…¥keyçš„hashå€¼åBä½éƒ½ä¸€æ ·ï¼Œä½¿å¾—ä¸ªåˆ«æ¡¶ä¸€ç›´åœ¨æ’å…¥æ–°æ•°æ®ï¼Œè¿›è€Œå¯¼è‡´å®ƒçš„æº¢å‡ºæ¡¶é“¾æ¡è¶Šæ¥è¶Šé•¿ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œå½“mapåœ¨æ“ä½œæ•°æ®æ—¶ï¼Œæ‰«æé€Ÿåº¦å°±ä¼šå˜å¾—å¾ˆæ…¢ã€‚åŠæ—¶çš„æ‰©å®¹ï¼Œå¯ä»¥å¯¹è¿™äº›å…ƒç´ è¿›è¡Œé‡æ’ï¼Œä½¿å…ƒç´ åœ¨æ¡¶çš„ä½ç½®æ›´å¹³å‡ä¸€äº›ã€‚</p><p><strong>æ‰©å®¹æ—¶çš„ç»†èŠ‚</strong></p><ol><li>åœ¨æˆ‘ä»¬çš„hmapç»“æ„ä¸­æœ‰ä¸€ä¸ªoldbucketså—ï¼Œæ‰©å®¹åˆšå‘ç”Ÿæ—¶ï¼Œä¼šå…ˆå°†è€æ•°æ®å­˜åˆ°è¿™ä¸ªé‡Œé¢ã€‚</li><li>æ¯æ¬¡å¯¹mapè¿›è¡Œåˆ æ”¹æ“ä½œæ—¶ï¼Œä¼šè§¦å‘ä»oldbucketä¸­è¿ç§»åˆ°bucketçš„æ“ä½œã€éä¸€æ¬¡æ€§ï¼Œåˆ†å¤šæ¬¡ã€‘</li><li>åœ¨æ‰©å®¹æ²¡æœ‰å®Œå…¨è¿ç§»å®Œæˆä¹‹å‰ï¼Œæ¯æ¬¡getæˆ–è€…putéå†æ•°æ®æ—¶ï¼Œéƒ½ä¼šå…ˆéå†oldbucketsï¼Œç„¶åå†éå†bucketsã€‚</li></ol><h3 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a><strong>æ³¨æ„äº‹é¡¹</strong></h3><p><strong>mapæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„</strong></p><p>åœ¨åŒä¸€æ—¶é—´ç‚¹ï¼Œä¸¤ä¸ª <a href="https://zhida.zhihu.com/search?content_id=198353368&content_type=Article&match_order=1&q=goroutine&zhida_source=entity">goroutine</a> å¯¹åŒä¸€ä¸ªmapè¿›ï¨ˆè¯»å†™æ“ä½œæ˜¯ï¥§å®‰å…¨çš„ã€‚ä¸¾ä¸ªæ —å­ï¼š</p><p>æŸmapæ¡¶æ•°é‡ä¸º4ï¼Œå³B&#x3D;2ã€‚æ­¤æ—¶ goroutine1æ¥æ’å…¥key1ï¼Œ goroutine2æ¥è¯»å– key2. å¯èƒ½ä¼šå‘ç”Ÿå¦‚ä¸‹è¿‡ç¨‹ï¼š</p><p>â‘  goroutine2 è®¡ç®—key2çš„hashå€¼,B&#x3D;2ï¼Œå¹¶ç¡®å®šæ¡¶å·ä¸º1ã€‚</p><p>â‘¡ goroutine1æ·»åŠ key1ï¼Œè§¦å‘æ‰©å®¹æ¡ä»¶ã€‚</p><p>â‘¢ B&#x3D;B+1&#x3D;3, bucketsæ•°æ®è¿ç§»åˆ°oldbucketsã€‚</p><p>â‘£ goroutine2ä»æ¡¶1ä¸­éå†ï¼Œè·å–æ•°æ®å¤±è´¥ã€‚</p><p>åœ¨å·¥ä½œä¸­ï¼Œå½“æˆ‘ä»¬æ¶‰åŠåˆ°å¯¹ä¸€ä¸ªmapè¿›è¡Œå¹¶å‘è¯»å†™æ—¶ï¼Œä¸€èˆ¬é‡‡ç”¨çš„åšæ³•æ˜¯é‡‡ç”¨golangä¸­è‡ªå¸¦çš„<a href="https://zhida.zhihu.com/search?content_id=198353368&content_type=Article&match_order=1&q=mutex%E9%94%81&zhida_source=entity">mutexé”</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Resource <span class="hljs-keyword">struct</span> &#123;<br>    sync.RWMutex<br>    m <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    r := Resource&#123;m: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span>)&#125;<br><br>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; <span class="hljs-comment">//å¼€ä¸€ä¸ªgoroutineå†™map</span><br>        <span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">100</span>; j++ &#123;<br>            r.Lock()<br>            r.m[fmt.Sprintf(<span class="hljs-string">&quot;resource_%d&quot;</span>, j)] = j<br>            r.Unlock()<br>        &#125;<br>    &#125;()<br>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; <span class="hljs-comment">//å¼€ä¸€ä¸ªgoroutineè¯»map</span><br>        <span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">100</span>; j++ &#123;<br>            r.RLock()<br>            fmt.Println(r.m[fmt.Sprintf(<span class="hljs-string">&quot;resource_%d&quot;</span>, j)])<br>            r.RUnlock()<br>        &#125;<br>    &#125;()<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>å¯¹mapæ•°æ®è¿›è¡Œæ“ä½œæ—¶ä¸å¯å–åœ°å€</li></ul><p>å› ä¸ºéšç€mapå…ƒç´ çš„å¢é•¿ï¼Œmapåº•å±‚é‡æ–°åˆ†é…ç©ºé—´ä¼šå¯¼è‡´ä¹‹å‰çš„åœ°å€æ— æ•ˆã€‚</p><p>[<a href="https://zhuanlan.zhihu.com/p/495998623#ref_1">1]</a></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol><li><a href="https://zhuanlan.zhihu.com/p/495998623#ref_1_0">^</a>Map <a href="https://juejin.cn/post/7029679896183963678#heading-1">https://juejin.cn/post/7029679896183963678#heading-1</a></li></ol>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>æ’åºç®—æ³•</title>
    <link href="/2025/01/11/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/"/>
    <url>/2025/01/11/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<p><img src="/2025/01/11/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/1.jpg" alt="æ’åºç®—æ³•"></p><h2 id="å†’æ³¡æ’åº"><a href="#å†’æ³¡æ’åº" class="headerlink" title="å†’æ³¡æ’åº"></a>å†’æ³¡æ’åº</h2><h3 id="ç®—æ³•æ­¥éª¤"><a href="#ç®—æ³•æ­¥éª¤" class="headerlink" title="ç®—æ³•æ­¥éª¤"></a>ç®—æ³•æ­¥éª¤</h3><ol><li>æ¯”è¾ƒç›¸é‚»çš„å…ƒç´ ã€‚å¦‚æœç¬¬ä¸€ä¸ªæ¯”ç¬¬äºŒä¸ªå¤§ï¼Œå°±äº¤æ¢ä»–ä»¬ä¸¤ä¸ªã€‚</li><li>å¯¹æ¯ä¸€å¯¹ç›¸é‚»å…ƒç´ ä½œåŒæ ·çš„å·¥ä½œï¼Œä»å¼€å§‹ç¬¬ä¸€å¯¹åˆ°ç»“å°¾çš„æœ€åä¸€å¯¹ã€‚è¿™æ­¥åšå®Œåï¼Œæœ€åçš„å…ƒç´ ä¼šæ˜¯æœ€å¤§çš„æ•°ã€‚</li><li>é’ˆå¯¹æ‰€æœ‰çš„å…ƒç´ é‡å¤ä»¥ä¸Šçš„æ­¥éª¤ï¼Œé™¤äº†æœ€åä¸€ä¸ªã€‚</li><li>æŒç»­æ¯æ¬¡å¯¹è¶Šæ¥è¶Šå°‘çš„å…ƒç´ é‡å¤ä¸Šé¢çš„æ­¥éª¤ï¼Œç›´åˆ°æ²¡æœ‰ä»»ä½•ä¸€å¯¹æ•°å­—éœ€è¦æ¯”è¾ƒã€‚</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">bubbleSort</span><span class="hljs-params">(nums []<span class="hljs-type">int</span>)</span></span> []<span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(nums) &lt;= <span class="hljs-number">1</span> &#123;<br>        <span class="hljs-keyword">return</span> nums<br>    &#125;<br>    <span class="hljs-comment">// å†’æ³¡æ’åºæ ¸å¿ƒå®ç°ä»£ç </span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(nums); i++ &#123;<br>        flag := <span class="hljs-literal">false</span><br>        <span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; <span class="hljs-built_in">len</span>(nums) - i - <span class="hljs-number">1</span>; j++ &#123;<br>            <span class="hljs-keyword">if</span> nums[j] &gt; nums[j+<span class="hljs-number">1</span>] &#123;<br>                nums[j], nums[j+<span class="hljs-number">1</span>] = nums[j+<span class="hljs-number">1</span>], nums[j]<br>                flag = <span class="hljs-literal">true</span><br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> !flag &#123;<br>            <span class="hljs-keyword">break</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> nums<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    nums := []<span class="hljs-type">int</span>&#123;<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>&#125;<br>    nums = bubbleSort(nums)<br>    fmt.Println(nums)<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2025/01/11/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/2.webp" alt="å†’æ³¡æ’åº"></p><h2 id="å¿«é€Ÿæ’åº"><a href="#å¿«é€Ÿæ’åº" class="headerlink" title="å¿«é€Ÿæ’åº"></a>å¿«é€Ÿæ’åº</h2><h3 id="ç®—æ³•æ­¥éª¤-1"><a href="#ç®—æ³•æ­¥éª¤-1" class="headerlink" title="ç®—æ³•æ­¥éª¤"></a>ç®—æ³•æ­¥éª¤</h3><ol><li><p>ä»æ•°åˆ—ä¸­æŒ‘å‡ºä¸€ä¸ªå…ƒç´ ï¼Œç§°ä¸º â€œåŸºå‡†â€ï¼ˆpivotï¼‰;</p></li><li><p>é‡æ–°æ’åºæ•°åˆ—ï¼Œæ‰€æœ‰å…ƒç´ æ¯”åŸºå‡†å€¼å°çš„æ‘†æ”¾åœ¨åŸºå‡†å‰é¢ï¼Œæ‰€æœ‰å…ƒç´ æ¯”åŸºå‡†å€¼å¤§çš„æ‘†åœ¨åŸºå‡†çš„åé¢ï¼ˆç›¸åŒçš„æ•°å¯ä»¥åˆ°ä»»ä¸€è¾¹ï¼‰ã€‚åœ¨è¿™ä¸ªåˆ†åŒºé€€å‡ºä¹‹åï¼Œè¯¥åŸºå‡†å°±å¤„äºæ•°åˆ—çš„ä¸­é—´ä½ç½®ã€‚è¿™ä¸ªç§°ä¸ºåˆ†åŒºï¼ˆpartitionï¼‰æ“ä½œï¼›</p></li><li><p>é€’å½’åœ°ï¼ˆrecursiveï¼‰æŠŠå°äºåŸºå‡†å€¼å…ƒç´ çš„å­æ•°åˆ—å’Œå¤§äºåŸºå‡†å€¼å…ƒç´ çš„å­æ•°åˆ—æ’åºï¼›</p></li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">partition</span><span class="hljs-params">(list []<span class="hljs-type">int</span>, low, high <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    pivot := list[low] <span class="hljs-comment">//å¯¼è‡´ low ä½ç½®å€¼ä¸ºç©º</span><br>    <span class="hljs-keyword">for</span> low &lt; high &#123;<br>        <span class="hljs-comment">//highæŒ‡é’ˆå€¼ &gt;= pivot highæŒ‡é’ˆğŸ‘ˆç§»</span><br>        <span class="hljs-keyword">for</span> low &lt; high &amp;&amp; pivot &lt;= list[high] &#123;<br>            high--<br>        &#125;<br>        <span class="hljs-comment">//å¡«è¡¥lowä½ç½®ç©ºå€¼</span><br>        <span class="hljs-comment">//highæŒ‡é’ˆå€¼ &lt; pivot highå€¼ ç§»åˆ°lowä½ç½®</span><br>        <span class="hljs-comment">//high ä½ç½®å€¼ç©º</span><br>        list[low] = list[high]<br>        <span class="hljs-comment">//lowæŒ‡é’ˆå€¼ &lt;= pivot lowæŒ‡é’ˆğŸ‘‰ç§»</span><br>        <span class="hljs-keyword">for</span> low &lt; high &amp;&amp; pivot &gt;= list[low] &#123;<br>            low++<br>        &#125;<br>        <span class="hljs-comment">//å¡«è¡¥highä½ç½®ç©ºå€¼</span><br>        <span class="hljs-comment">//lowæŒ‡é’ˆå€¼ &gt; pivot lowå€¼ ç§»åˆ°highä½ç½®</span><br>        <span class="hljs-comment">//lowä½ç½®å€¼ç©º</span><br>        list[high] = list[low]<br>    &#125;<br>    <span class="hljs-comment">//pivot å¡«è¡¥ lowä½ç½®çš„ç©ºå€¼</span><br>    list[low] = pivot<br>    <span class="hljs-keyword">return</span> low<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">QuickSort</span><span class="hljs-params">(list []<span class="hljs-type">int</span>,low,high <span class="hljs-type">int</span>)</span></span>  &#123;<br>    <span class="hljs-keyword">if</span> high &gt; low&#123;<br>        <span class="hljs-comment">//ä½ç½®åˆ’åˆ†</span><br>        pivot := partition(list,low,high)<br>        <span class="hljs-comment">//å·¦è¾¹éƒ¨åˆ†æ’åº</span><br>        QuickSort(list,low,pivot<span class="hljs-number">-1</span>)<br>        <span class="hljs-comment">//å³è¾¹æ’åº</span><br>        QuickSort(list,pivot+<span class="hljs-number">1</span>,high)<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestQuickSort</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>    list := []<span class="hljs-type">int</span>&#123;<span class="hljs-number">2</span>,<span class="hljs-number">44</span>,<span class="hljs-number">4</span>,<span class="hljs-number">8</span>,<span class="hljs-number">33</span>,<span class="hljs-number">1</span>,<span class="hljs-number">22</span>,<span class="hljs-number">-11</span>,<span class="hljs-number">6</span>,<span class="hljs-number">34</span>,<span class="hljs-number">55</span>,<span class="hljs-number">54</span>,<span class="hljs-number">9</span>&#125;<br>    QuickSort(list,<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(list)<span class="hljs-number">-1</span>)<br>    t.Log(list)<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2025/01/11/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/quick_sort_partition_animation.gif" alt="å¿«é€Ÿæ’åº"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>æµè§ˆå™¨è¾“å…¥urlåå‘ç”Ÿäº†ä»€ä¹ˆ</title>
    <link href="/2025/01/11/%E6%B5%8F%E8%A7%88%E5%99%A8%E8%BE%93%E5%85%A5url%E5%90%8E%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88/"/>
    <url>/2025/01/11/%E6%B5%8F%E8%A7%88%E5%99%A8%E8%BE%93%E5%85%A5url%E5%90%8E%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88/</url>
    
    <content type="html"><![CDATA[<h2 id="æµè§ˆå™¨è¾“å…¥urlåå‘ç”Ÿäº†ä»€ä¹ˆ"><a href="#æµè§ˆå™¨è¾“å…¥urlåå‘ç”Ÿäº†ä»€ä¹ˆ" class="headerlink" title="æµè§ˆå™¨è¾“å…¥urlåå‘ç”Ÿäº†ä»€ä¹ˆ"></a>æµè§ˆå™¨è¾“å…¥urlåå‘ç”Ÿäº†ä»€ä¹ˆ</h2><h3 id="1-è¾“å…¥åœ°å€"><a href="#1-è¾“å…¥åœ°å€" class="headerlink" title="1. è¾“å…¥åœ°å€"></a>1. è¾“å…¥åœ°å€</h3><p>æµè§ˆå™¨ä»å†å²è®°å½•ï¼Œä¹¦ç­¾ä¸­æ™ºèƒ½åŒ¹é…urlï¼Œç”šè‡³ä»ç¼“å­˜ä¸­ç›´æ¥æŠŠç½‘é¡µå±•ç¤ºå‡ºæ¥ã€‚</p><h3 id="2-æµè§ˆå™¨æŸ¥æ‰¾åŸŸåå¯¹åº”çš„IPåœ°å€"><a href="#2-æµè§ˆå™¨æŸ¥æ‰¾åŸŸåå¯¹åº”çš„IPåœ°å€" class="headerlink" title="2. æµè§ˆå™¨æŸ¥æ‰¾åŸŸåå¯¹åº”çš„IPåœ°å€"></a>2. æµè§ˆå™¨æŸ¥æ‰¾åŸŸåå¯¹åº”çš„IPåœ°å€</h3><ol><li><p>æŸ¥æ‰¾æœ¬åœ°ç¡¬ç›˜çš„hostsæ–‡ä»¶ï¼Œå¦‚æœæœ‰çš„è¯ç›´æ¥ä½¿ç”¨hostsæ–‡ä»¶ä¸­çš„ipåœ°å€ã€‚</p></li><li><p>å¦‚æœhostsæ–‡ä»¶ä¸­æ²¡æœ‰ï¼Œåˆ™å‘æœ¬åœ°DNSæœåŠ¡å™¨å‘é€è¯·æ±‚ã€‚æœ¬åœ°DNSæœåŠ¡å™¨ä¸€èˆ¬æ˜¯ç½‘ç»œæ¥å…¥ä¾›åº”å•†æä¾›ï¼Œæ¯”å¦‚ä¸­å›½ç”µä¿¡ï¼Œä¸­å›½ç§»åŠ¨ã€‚</p></li><li><p>æœ¬åœ°DNSæœåŠ¡å™¨æŸ¥ç¼“å­˜ï¼Œæœ‰çš„è¯å°±ç›´æ¥è¿”å›ã€‚</p></li><li><p>æœ¬åœ°DNSæœåŠ¡å™¨ç¼“å­˜æ²¡æœ‰å‘½ä¸­çš„è¯ï¼Œå‘æ ¹æœåŠ¡å™¨æŸ¥è¯¢ã€‚</p></li><li><p>æ ¹æœåŠ¡å™¨æä¾›ä¸‹ä¸€å±‚çº§æœåŠ¡å™¨åœ°å€ã€‚</p></li><li><p>è¿­ä»£æŸ¥è¯¢ç›´åˆ°æŸ¥è¯¢åˆ°IPåœ°å€ã€‚</p></li><li><p>æœ¬åœ°DNSæœåŠ¡å™¨å‘æµè§ˆå™¨è¿”å›IPåœ°å€ï¼Œå¹¶å°†IPåœ°å€è®°å½•åœ¨è‡ªå·±çš„ç¼“å­˜ä¸­ï¼Œå·²å¤‡ä¸‹æ¬¡ä½¿ç”¨ã€‚</p></li></ol><h3 id="3-æµè§ˆå™¨è·ŸwebæœåŠ¡å™¨å»ºç«‹TCPè¿æ¥"><a href="#3-æµè§ˆå™¨è·ŸwebæœåŠ¡å™¨å»ºç«‹TCPè¿æ¥" class="headerlink" title="3. æµè§ˆå™¨è·ŸwebæœåŠ¡å™¨å»ºç«‹TCPè¿æ¥"></a>3. æµè§ˆå™¨è·ŸwebæœåŠ¡å™¨å»ºç«‹TCPè¿æ¥</h3><p>é€šè¿‡TCPä¸‰æ¬¡æ¡æ‰‹ï¼Œå»ºç«‹è¿æ¥ã€‚</p><h3 id="4-æµè§ˆå™¨å‘é€HTTPè¯·æ±‚"><a href="#4-æµè§ˆå™¨å‘é€HTTPè¯·æ±‚" class="headerlink" title="4. æµè§ˆå™¨å‘é€HTTPè¯·æ±‚"></a>4. æµè§ˆå™¨å‘é€HTTPè¯·æ±‚</h3><p>è¯·æ±‚ä¿¡æ¯åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>è¯·æ±‚æ–¹æ³•URIåè®®&#x2F;ç‰ˆæœ¬</li><li>è¯·æ±‚å¤´(Request Header)</li><li>è¯·æ±‚æ­£æ–‡</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">GET</span>/sample.jspHTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">Accept</span>:image/gif.image/jpeg,*/*<br><span class="hljs-attribute">Accept</span>-Language:zh-cn<br><span class="hljs-attribute">Connection</span>:Keep-Alive<br><span class="hljs-attribute">Host</span>:localhost<br><span class="hljs-attribute">User</span>-Agent:Mozila/<span class="hljs-number">4</span>.<span class="hljs-number">0</span>(compatible;MSIE5.<span class="hljs-number">01</span>;Window NT5.<span class="hljs-number">0</span>)<br><span class="hljs-attribute">Accept</span>-Encoding:gzip,deflate<br><br><span class="hljs-attribute">username</span>=jinqiao&amp;password=<span class="hljs-number">1234</span><br></code></pre></td></tr></table></figure><h3 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h3><p>TCPä¸‰æ¬¡æ¡æ‰‹</p><ol><li><p>ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼š</p><p>å®¢æˆ·ç«¯ç”Ÿæˆæ•°æ®åŒ…ï¼š</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">SYN</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span><br><span class="hljs-attribute">seq</span> <span class="hljs-operator">=</span> J (éšæœºç”Ÿæˆä¸€ä¸ªæ•°J)<br></code></pre></td></tr></table></figure><p>å‘é€å‡ºæ•°æ®åŒ…åï¼Œå®¢æˆ·ç«¯è¿›å…¥SYN_SENTçŠ¶æ€ï¼Œç­‰å¾…æœåŠ¡ç«¯ç¡®è®¤ã€‚</p></li><li><p>ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼š</p><p>æœåŠ¡ç«¯æ”¶åˆ°æ•°æ®åŒ…ï¼Œç”Ÿæˆè¿”å›æ•°æ®åŒ…ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">SYN</span> = <span class="hljs-number">1</span><br><span class="hljs-attr">seq</span> = K (éšæœºç”Ÿæˆä¸€ä¸ªæ•°K)<br><span class="hljs-attr">ACK</span> = <span class="hljs-number">1</span><br><span class="hljs-attr">ack</span> = J + <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>å‘é€å‡ºæ•°æ®åŒ…åï¼ŒæœåŠ¡ç«¯è¿›å…¥SYN_RCVDçŠ¶æ€ã€‚</p></li><li><p>ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼š</p><p>å®¢æˆ·ç«¯æ”¶åˆ°æ•°æ®åŒ…ï¼Œæ£€æŸ¥ackæ˜¯å¦ä¸ºJ+1ï¼ŒACKæ˜¯å¦ä¸º1ã€‚è‹¥æ­£ç¡®ï¼Œåˆ™ç”Ÿæˆæ•°æ®åŒ…ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">ACK</span> = <span class="hljs-number">1</span><br><span class="hljs-attr">ack</span> = K + <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>å°†æ•°æ®åŒ…å‘å‡ºï¼Œå®¢æˆ·ç«¯è¿›å…¥ESTABLISHEDçŠ¶æ€ã€‚</p><p>æœåŠ¡ç«¯æ”¶åˆ°æ•°æ®åŒ…åï¼Œæ£€æŸ¥ackæ˜¯å¦ä¸ºK+1ï¼ŒACKæ˜¯å¦ä¸º1ã€‚è‹¥æ­£ç¡®ï¼ŒæœåŠ¡ç«¯è¿›å…¥ESTABLISHEDçŠ¶æ€ã€‚</p></li><li><p>å®Œæˆä¸‰æ¬¡æ¡æ‰‹ï¼Œå¼€å§‹ä¼ è¾“æ•°æ®ã€‚</p></li></ol><p><img src="/2025/01/11/%E6%B5%8F%E8%A7%88%E5%99%A8%E8%BE%93%E5%85%A5url%E5%90%8E%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88/TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.drawio.png" alt="TCP ä¸‰æ¬¡æ¡æ‰‹"></p><p>ä¸ºä»€ä¹ˆéœ€è¦ä¸‰æ¬¡æ¡æ‰‹</p><p>ä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢æœåŠ¡ç«¯ä¸€ç›´ç­‰å¾…ï¼Œæµªè´¹èµ„æºã€‚</p><p>å‡è®¾æ²¡æœ‰ä¸‰æ¬¡æ¡æ‰‹ï¼Œå®¢æˆ·ç«¯å‘å‡ºçš„è¿æ¥è¯·æ±‚åœ¨ç½‘ç»œä¸­æ»ç•™äº†ï¼Œå®¢æˆ·ç«¯è¶…æ—¶å·²ç»é‡Šæ”¾äº†è¿æ¥ã€‚æœåŠ¡ç«¯æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå‘å‡ºç¡®è®¤ã€‚ç¡®è®¤å‘å‡ºåè¿æ¥å°±å»ºç«‹äº†ï¼ŒæœåŠ¡ç«¯å°±ä¼šä¸€ç›´ç­‰å¾…å®¢æˆ·ç«¯å‘æ¥æ•°æ®ï¼Œè€Œå®¢æˆ·ç«¯å®é™…å·²ç»é‡Šæ”¾äº†è¿æ¥ï¼Œæ”¶åˆ°ç¡®è®¤åä¸ä¼šç†ç¬ï¼Œè¿™å°†å¯¼è‡´æœåŠ¡ç«¯æµªè´¹èµ„æºã€‚</p><p>TCPå››æ¬¡æŒ¥æ‰‹</p><ol><li><p>ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ï¼š</p><p>å®¢æˆ·ç«¯å‘é€FINï¼Œç”¨æ¥å…³é—­å®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯çš„æ•°æ®ä¼ è¾“ï¼Œå®¢æˆ·ç«¯è¿›å…¥FIN_WAIT_1çŠ¶æ€</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">FIN</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span><br><span class="hljs-attribute">seq</span> <span class="hljs-operator">=</span> x<br><span class="hljs-attribute">ack</span> <span class="hljs-operator">=</span> y<br></code></pre></td></tr></table></figure></li><li><p>ç¬¬äºŒæ¬¡æŒ¥æ‰‹ï¼š</p><p>æœåŠ¡ç«¯æ”¶åˆ°FINï¼Œå‘é€ä¸€ä¸ªACKç»™å®¢æˆ·ç«¯ï¼ŒæœåŠ¡ç«¯è¿›å…¥CLOSE_WAITçŠ¶æ€ã€‚</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">ACK</span> = <span class="hljs-number">1</span><br><span class="hljs-attr">seq</span> = y<br><span class="hljs-attr">ack</span> = x + <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯æ”¶åˆ°ACKï¼Œè¿›å…¥FIN_WAIT_2çŠ¶æ€ã€‚</p></li><li><p>ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ï¼š</p><p>æœåŠ¡ç«¯å¤„ç†å®Œå‰©ä½™æ•°æ®åï¼Œä¹Ÿå‘å®¢æˆ·ç«¯å‘é€FINï¼ŒæœåŠ¡ç«¯è¿›å…¥LAST_ACKçŠ¶æ€ã€‚</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">FIN</span> = <span class="hljs-number">1</span><br><span class="hljs-attr">seq</span> = y<br><span class="hljs-attr">ack</span> = x + <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure></li><li><p>ç¬¬å››æ¬¡æŒ¥æ‰‹ï¼š</p><p>å®¢æˆ·ç«¯æ”¶åˆ°FINï¼Œå‘é€ä¸€ä¸ªACKç»™æœåŠ¡ç«¯ï¼Œå®¢æˆ·ç«¯è¿›å…¥TIME_WAITçŠ¶æ€ã€‚</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">ACK</span> = <span class="hljs-number">1</span><br><span class="hljs-attr">seq</span> = x + <span class="hljs-number">1</span><br><span class="hljs-attr">ack</span> = y + <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>æœåŠ¡ç«¯æ”¶åˆ°ACKï¼Œè¿›å…¥CLOSEçŠ¶æ€ã€‚</p><p><img src="/2025/01/11/%E6%B5%8F%E8%A7%88%E5%99%A8%E8%BE%93%E5%85%A5url%E5%90%8E%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88/format,png-20230309230614791.png" alt="å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­è¿æ¥ â€”â€” TCP å››æ¬¡æŒ¥æ‰‹"></p></li></ol>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Goè¯­è¨€ä¸­çš„byteç±»å‹å’Œruneç±»å‹</title>
    <link href="/2025/01/11/Go%E8%AF%AD%E8%A8%80%E4%B8%AD%E7%9A%84byte%E7%B1%BB%E5%9E%8B%E5%92%8Crune%E7%B1%BB%E5%9E%8B/"/>
    <url>/2025/01/11/Go%E8%AF%AD%E8%A8%80%E4%B8%AD%E7%9A%84byte%E7%B1%BB%E5%9E%8B%E5%92%8Crune%E7%B1%BB%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<p>è½¬è½½ï¼š<a href="https://www.cnblogs.com/wjaaron/p/14822799.html">https://www.cnblogs.com/wjaaron/p/14822799.html</a></p><p>Go è¯­è¨€ä¸­å®šä¹‰å­—ç¬¦ä¸²è¦ç”¨åŒå¼•å·ï¼Œè€Œä¸æ˜¯å•å¼•å·ï¼Œå•å¼•å·ä¸­åªèƒ½åŒ…å«ä¸€ä¸ªå…ƒç´ ï¼Œè¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ã€‚</p><p>Goè¯­è¨€ä¸­å­—ç¬¦æœ‰ä¸¤ç§ç±»å‹ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><p>uint8 ç±»å‹ï¼Œæˆ–è€…å« byte å‹ï¼Œä»£è¡¨äº† ASCII ç çš„ä¸€ä¸ªå­—ç¬¦<br>rune ç±»å‹ï¼Œä»£è¡¨ä¸€ä¸ª UTF-8 å­—ç¬¦<br>äº†è§£ç¼–ç çŸ¥è¯†çš„åº”è¯¥çŸ¥é“ï¼ŒASCII ç¼–ç å­—ç¬¦æ˜¯1ä¸ªå­—èŠ‚çš„ï¼Œè€Œ UTF-8 æ˜¯å¯å˜é•¿çš„ç¼–ç ï¼Œå½“è¦è¡¨ç¤ºä¸­æ–‡ç­‰é ASCll ç¼–ç çš„å­—ç¬¦æ—¶ï¼Œéœ€è¦ä½¿ç”¨ UTF-8 ç¼–ç æ¥ä¿è¯ä¸ä¼šä¹±ç ã€‚å…³äºå­—ç¬¦ç¼–ç ç›¸å…³çŸ¥è¯†ï¼Œæ¨èçœ‹è¿™ç¯‡å»–é›ªå³°çš„ä»‹ç» å­—ç¬¦ç¼–ç </p><p>å‡å¦‚æˆ‘ä»¬è¦éå†è¾“å‡ºä¸€ä¸ªåŒ…å«ä¸­æ–‡çš„å­—ç¬¦ä¸²æ—¶ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br> str := <span class="hljs-string">&quot;hello ä¸–ç•Œ&quot;</span><br> <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(str); i++ &#123;<br>  fmt.Println(str[i])<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç çš„æ‰“å°ç»“æœæ˜¯ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs">104<br>101<br>108<br>108<br>111<br>32<br>228<br>184<br>150<br>231<br>149<br>140<br></code></pre></td></tr></table></figure><p>Go è¯­è¨€å­—ç¬¦ä¸²å­˜å‚¨çš„å…¶å®æ˜¯ç±»å‹ä¸º byte çš„åªè¯»åˆ‡ç‰‡ï¼Œæˆ–è€…è¯´ä¸€ä¸ªå­—ç¬¦ä¸²å°±æ˜¯ä¸€å †å­—èŠ‚ã€‚åœ¨ UTF-8 ç¼–ç ä¸­ä¸€ä¸ªè‹±æ–‡å­—ç¬¦å¯ä»¥ç”¨ä¸€ä¸ªå­—èŠ‚å­˜å‚¨ï¼Œä¸€ä¸ªä¸­æ–‡å­—ç¬¦éœ€è¦ä¸‰ä¸ªæˆ–å››ä¸ªå­—èŠ‚å­˜å‚¨ï¼Œè€Œ ASCII ç ç¬¦å·åªæœ‰ 128 ä¸ªï¼Œå¤§äº 128 çš„éƒ½ä¸åœ¨èŒƒå›´å†…ã€‚ä¸Šè¿°ä»£ç çš„éå†æ–¹å¼å°±æ˜¯ä»¥ ASCII ç±»å‹æ¥è¯»å­—ç¬¦çš„ã€‚</p><p>å¯ä»¥çœ‹åˆ°è¾“å‡ºç»“æœä¸­çš„å‰ 6 ä¸ªéƒ½æ˜¯åœ¨ ASCII è¡¨ä¸­çš„ï¼Œä½†æ˜¯å 6 ä¸ªå°±ä¸åœ¨è¡¨ä¸­äº†ï¼Œåé¢ 6 ä¸ªçš„æ¯ä¸€ä¸ªå­—èŠ‚éƒ½ä¸èƒ½å•ç‹¬è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œè€Œæ˜¯ç”¨ 3 ä¸ªåœ¨ä¸€èµ·æ‰èƒ½è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œæ˜æ˜¾è¶…å‡ºäº† ASCII è¡¨çš„èŒƒå›´ï¼Œæ‰€ä»¥å½“æ‰“å°å…·ä½“å­—ç¬¦æ—¶å°±ä¼šä¹±ç ï¼Œæ¯”å¦‚æˆ‘ä»¬ç°åœ¨æ¥æ‰“å°æ¯ä¸€ä¸ªçœŸå®å­—ç¬¦ï¼Œéœ€è¦ä½¿ç”¨åˆ°å ä½ç¬¦ %cï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br> str := <span class="hljs-string">&quot;hello ä¸–ç•Œ&quot;</span><br> <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(str); i++ &#123;<br>  fmt.Printf(<span class="hljs-string">&quot;%c&quot;</span>, str[i]) <span class="hljs-comment">// hello Ã¤Â¸Ã§</span><br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœä¸ºï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">hello Ã¤Â¸Ã§<br></code></pre></td></tr></table></figure><p>æ˜æ˜¾ä¹±ç äº†ã€‚è§£é‡Šè¿™ä¹ˆå¤šå°±æ˜¯ä¸ºäº†è¯´æ˜å¦‚æœå­—ç¬¦ä¸²ä¸­æœ‰é ASCII ç çš„å­—ç¬¦æ—¶ï¼Œå°±ä¸èƒ½ä½¿ç”¨ byte æ¥è¡¨ç¤ºå­—ç¬¦ï¼Œéœ€è¦ä½¿ç”¨ rune ç±»å‹æ¥è¡¨ç¤ºã€‚</p><p>ä½¿ç”¨ rune ç±»å‹æ¥éå†å­—ç¬¦ä¸²<br>åœ¨ Go ä¸­ï¼Œæœ‰ä¸€ä¸ªéå†æ–¹å¼æ˜¯ rangeï¼Œå®ƒé»˜è®¤å°±æ˜¯ä»¥ UTF-8 ç¼–ç å½¢å¼å»è¯»æ¯ä¸€ä¸ªå­—ç¬¦ã€‚å½“æ¶‰åŠåˆ°çš„å­—ç¬¦ä¸²ä¸­å«æœ‰éè‹±æ–‡å­—ç¬¦æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ range æ¥éå†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br> str := <span class="hljs-string">&quot;hello ä¸–ç•Œ&quot;</span><br> <span class="hljs-keyword">for</span> _, r := <span class="hljs-keyword">range</span> str &#123;<br>  fmt.Println(r)<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœä¸ºï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">104<br>101<br>108<br>108<br>111<br>32<br>19990<br>30028<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶è¾“å‡ºçš„å­—èŠ‚ç¼–ç å°±æ˜¯ UTF-8 ç¼–ç å·ï¼ŒUTF-8 ç¼–ç æ˜¯åŒ…å« ASCII ç¼–ç çš„ï¼Œæ‰€ä»¥å‰ 6 ä¸ªç¼–å·è¿˜æ˜¯ä¸€æ ·çš„ï¼Œåé¢ä¸¤ä¸ªç¼–å·åˆ†åˆ«ä»£è¡¨ä¸–ï¼Œç•Œã€‚</p><p>ä¿®æ”¹å­—ç¬¦ä¸²<br>Go è¯­è¨€ä¸­å¯¹å­—ç¬¦ä¸²çš„ä¿®æ”¹å…¶å®ä¸æ˜¯å¯¹å­—ç¬¦ä¸²æœ¬èº«çš„ä¿®æ”¹ï¼Œè€Œæ˜¯å¤åˆ¶å­—ç¬¦ä¸²ï¼ŒåŒæ—¶ä¿®æ”¹å€¼ï¼Œå³é‡æ–°åˆ†é…æ¥å†…å­˜ï¼Œéœ€è¦å…ˆå°†å­—ç¬¦ä¸²è½¬åŒ–æˆæ•°ç»„ï¼Œ[]byte æˆ– []runeï¼Œç„¶åå†è½¬æ¢æˆ string å‹ã€‚</p><p>é‚£ä¹ˆæˆ‘è¦è¯´çš„ä¹Ÿå¾ˆæ˜æ˜¾äº†ï¼Œå°±æ˜¯è¦åŒºåˆ«ä½¿ç”¨ []byte æˆ– []runeã€‚</p><p>å¯¹äºå…¨æ˜¯ASCIIç¼–ç çš„å­—ç¬¦ä¸²ï¼Œä½¿ç”¨ []byte å³å¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br> str := <span class="hljs-string">&quot;abc&quot;</span><br> s2 := []<span class="hljs-type">byte</span>(str)<br> s2[<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;b&#x27;</span><br> fmt.Println(<span class="hljs-type">string</span>(s2)) <span class="hljs-comment">//bbc</span><br>&#125;<br></code></pre></td></tr></table></figure><p>&#x2F;&#x2F; string()è¡¨ç¤ºå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œè½¬æ¢ä¸ºå­—ç¬¦ä¸²<br>å¯¹äºåŒ…å«ä¸­æ–‡ç­‰å­—ç¬¦çš„å­—ç¬¦ä¸²æ—¶ï¼Œé‚£å°±è¦ç”¨ []rune äº†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    str:=<span class="hljs-string">&quot;ç™½çŒ«&quot;</span><br>    s2:=[]<span class="hljs-type">rune</span>(str)<br>    s2[<span class="hljs-number">0</span>]=<span class="hljs-string">&#x27;é»‘&#x27;</span><br>    fmt.Println(<span class="hljs-type">string</span>(s2)) <span class="hljs-comment">//é»‘çŒ«</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ€»ç»“<br>åœ¨å¤„ç†å­—ç¬¦æ—¶ï¼Œè¦è€ƒè™‘å­—ç¬¦çš„ç¼–ç èŒƒå›´ï¼Œç„¶åæ ¹æ®éœ€è¦ä½¿ç”¨ byte ç±»å‹æˆ– runeç±»å‹ã€‚</p><p>byte ç±»å‹åªèƒ½æ­£å¸¸è¾“å‡º ASCII ç¼–ç èŒƒå›´çš„å­—ç¬¦ï¼›rune ç±»å‹å¯ä»¥è¾“å‡º UTF-8 ç¼–ç èŒƒå›´çš„å­—ç¬¦ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>golangå¹¶å‘ç¼–ç¨‹</title>
    <link href="/2024/12/08/golang%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"/>
    <url>/2024/12/08/golang%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h2 id="goroutineçš„ä½¿ç”¨"><a href="#goroutineçš„ä½¿ç”¨" class="headerlink" title="goroutineçš„ä½¿ç”¨"></a>goroutineçš„ä½¿ç”¨</h2><p>åœ¨Goè¯­è¨€ç¼–ç¨‹ä¸­ä½ ä¸éœ€è¦å»è‡ªå·±å†™è¿›ç¨‹ã€çº¿ç¨‹ã€åç¨‹ï¼Œä½ çš„æŠ€èƒ½åŒ…é‡Œåªæœ‰ä¸€ä¸ªæŠ€èƒ½â€“goroutineï¼Œå½“ä½ éœ€è¦è®©æŸä¸ªä»»åŠ¡å¹¶å‘æ‰§è¡Œçš„æ—¶å€™ï¼Œä½ åªéœ€è¦æŠŠè¿™ä¸ªä»»åŠ¡åŒ…è£…æˆä¸€ä¸ªå‡½æ•°ï¼Œå¼€å¯ä¸€ä¸ªgoroutineå»æ‰§è¡Œè¿™ä¸ªå‡½æ•°å°±å¯ä»¥äº†ï¼Œå°±æ˜¯è¿™ä¹ˆç®€å•ç²—æš´ã€‚<br>Goè¯­è¨€ä¸­ä½¿ç”¨goroutineéå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨è°ƒç”¨å‡½æ•°çš„æ—¶å€™åœ¨å‰é¢åŠ ä¸Šgoå…³é”®å­—ï¼Œå°±å¯ä»¥ä¸ºä¸€ä¸ªå‡½æ•°åˆ›å»ºä¸€ä¸ªgoroutineã€‚<br>ä¸€ä¸ªgoroutineå¿…å®šå¯¹åº”ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥åˆ›å»ºå¤šä¸ªgoroutineå»æ‰§è¡Œç›¸åŒçš„å‡½æ•°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">hello</span><span class="hljs-params">()</span></span> &#123;<br>    fmt.Println(<span class="hljs-string">&quot;Hello Goroutine!&quot;</span>)<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">go</span> hello() <span class="hljs-comment">// å¯åŠ¨å¦å¤–ä¸€ä¸ªgoroutineå»æ‰§è¡Œhelloå‡½æ•°</span><br>    fmt.Println(<span class="hljs-string">&quot;main goroutine done!&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å¯åŠ¨å¤šä¸ªgoroutine"><a href="#å¯åŠ¨å¤šä¸ªgoroutine" class="headerlink" title="å¯åŠ¨å¤šä¸ªgoroutine"></a>å¯åŠ¨å¤šä¸ªgoroutine</h2><p>åœ¨Goè¯­è¨€ä¸­å®ç°å¹¶å‘å°±æ˜¯è¿™æ ·ç®€å•ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¯åŠ¨å¤šä¸ªgoroutineã€‚è®©æˆ‘ä»¬å†æ¥ä¸€ä¸ªä¾‹å­ï¼š ï¼ˆè¿™é‡Œä½¿ç”¨äº†sync.WaitGroupæ¥å®ç°goroutineçš„åŒæ­¥ï¼‰</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> wg sync.WaitGroup<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">hello</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> &#123;<br>    <span class="hljs-keyword">defer</span> wg.Done() <span class="hljs-comment">// goroutineç»“æŸå°±ç™»è®°-1</span><br>    fmt.Println(<span class="hljs-string">&quot;Hello Goroutine!&quot;</span>, i)<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>        wg.Add(<span class="hljs-number">1</span>) <span class="hljs-comment">// å¯åŠ¨ä¸€ä¸ªgoroutineå°±ç™»è®°+1</span><br>        <span class="hljs-keyword">go</span> hello(i)<br>    &#125;<br>    wg.Wait() <span class="hljs-comment">// ç­‰å¾…æ‰€æœ‰ç™»è®°çš„goroutineéƒ½ç»“æŸ</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å¤šæ¬¡æ‰§è¡Œä¸Šé¢çš„ä»£ç ï¼Œä¼šå‘ç°æ¯æ¬¡æ‰“å°çš„æ•°å­—çš„é¡ºåºéƒ½ä¸ä¸€è‡´ã€‚è¿™æ˜¯å› ä¸º10ä¸ªgoroutineæ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œè€Œgoroutineçš„è°ƒåº¦æ˜¯éšæœºçš„ã€‚</p><h2 id="æ³¨æ„é€€å‡º"><a href="#æ³¨æ„é€€å‡º" class="headerlink" title="æ³¨æ„é€€å‡º"></a>æ³¨æ„é€€å‡º</h2><p>å½“main()å‡½æ•°è¿”å›çš„æ—¶å€™è¯¥goroutineå°±ç»“æŸäº†ï¼Œæ‰€æœ‰åœ¨main()å‡½æ•°ä¸­å¯åŠ¨çš„goroutineä¼šä¸€åŒç»“æŸï¼Œmainå‡½æ•°æ‰€åœ¨çš„goroutineå°±åƒæ˜¯æƒåˆ©çš„æ¸¸æˆä¸­çš„å¤œç‹ï¼Œå…¶ä»–çš„goroutineéƒ½æ˜¯å¼‚é¬¼ï¼Œå¤œç‹ä¸€æ­»å®ƒè½¬åŒ–çš„é‚£äº›å¼‚é¬¼ä¹Ÿå°±å…¨éƒ¨GGäº†ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>å¤§çº²</title>
    <link href="/2024/12/05/%E5%A4%A7%E7%BA%B2/"/>
    <url>/2024/12/05/%E5%A4%A7%E7%BA%B2/</url>
    
    <content type="html"><![CDATA[<h2 id="Go"><a href="#Go" class="headerlink" title="Go"></a>Go</h2><ol><li>ä¸ºä»€ä¹ˆå¯¹slice appendæ—¶ï¼Œè¦ç”¨åŸæ¥çš„å˜é‡æ¥æ¥æ”¶<br>s &#x3D; append(s, 1)</li></ol><p>å› ä¸ºappendæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°çš„ä¼ å‚æ˜¯å€¼æ‹·è´ï¼Œä¼ è¿›å»çš„såœ¨å‡½æ•°å†…éƒ¨å·²ç»æ˜¯å¦ä¸€ä¸ªsäº†ï¼Œè€Œå‡½æ•°å¤–éƒ¨åŸæ¥çš„s.lenå¹¶ä¸ä¼šè¢«æ”¹å˜ï¼Œæ‰€ä»¥è¦ç”¨å‡½æ•°è¿”å›çš„æ–°sæ¥è¦†ç›–åŸæ¥çš„s</p><p>goå†…å­˜ç®¡ç†<br>goåç¨‹åŸç†<br>goå¹¶å‘ç¼–ç¨‹<br>goç½‘ç»œç¼–ç¨‹</p><p>ginæ¡†æ¶</p><p>contextåŒ…</p><p>channelåº•å±‚åŸç†</p><p>å®ç°M:Nç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼ŒåŒæ–¹å‡è®¾ç½®è¶…æ—¶5sä¸¢å¼ƒæœºåˆ¶</p><p>å®ç°é«˜å¹¶å‘é˜»å¡å¼Map</p><p>sync.Cond</p><p>sync.Once<br>sync.MapåŸç†</p><p>goåç¨‹å¦‚ä½•é€€å‡ºçš„</p><p>makeå’Œnewçš„åŒºåˆ«</p><h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><p>namespace</p><p>cgroups</p><p>å¸¸è§å‘½ä»¤</p><p>æŸ¥çœ‹æ—¥å¿—çš„ç›¸å…³å‘½ä»¤</p><h2 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h2><h2 id="k8s"><a href="#k8s" class="headerlink" title="k8s"></a>k8s</h2><p>list-watch åº•å±‚åŸç†</p><p>helm chart</p><p>podåˆ›å»ºå…¨é“¾è·¯åˆ†æ</p><p>k8sé›†ç¾¤éƒ¨ç½²å®æˆ˜</p><p>drain</p><p>kube-apiserver ç¼“å­˜æœºåˆ¶</p><p>etcd</p><p>podéƒ½æœ‰å“ªäº›çŠ¶æ€</p><p>åˆ†å¸ƒå¼è®­ç»ƒ</p><p>tensorflowå¦‚ä½•æ”¯æŒåˆ†å¸ƒå¼è®­ç»ƒ</p><p>å¦‚ä½•ä½¿ç”¨dockerè¿›è¡Œæœºå™¨å­¦ä¹ è®­ç»ƒ</p><p>å¦‚ä½•ä½¿ç”¨k8sè¿›è¡Œæœºå™¨å­¦ä¹ è®­ç»ƒ</p><p>kubeletæ˜¯å¦‚ä½•æŠŠpodæ‹‰èµ·æ¥çš„</p><p>Dockerfile</p><p>scheduleræ˜¯å¦‚ä½•è°ƒåº¦podçš„</p><h2 id="ç½‘ç»œ"><a href="#ç½‘ç»œ" class="headerlink" title="ç½‘ç»œ"></a>ç½‘ç»œ</h2><p>socketç¼–ç¨‹</p><h2 id="å‰ç«¯"><a href="#å‰ç«¯" class="headerlink" title="å‰ç«¯"></a>å‰ç«¯</h2><h2 id="ç®—æ³•é¢˜"><a href="#ç®—æ³•é¢˜" class="headerlink" title="ç®—æ³•é¢˜"></a>ç®—æ³•é¢˜</h2>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>æµ‹è¯•æ–‡ç« </title>
    <link href="/2024/10/21/%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0/"/>
    <url>/2024/10/21/%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0/</url>
    
    <content type="html"><![CDATA[<p>æµ‹è¯•æ–‡ç« å›¾ç‰‡ï¼š<br><img src="/2024/10/21/%E6%B5%8B%E8%AF%95%E6%96%87%E7%AB%A0/test.jpg" alt="æµ‹è¯•"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2024/10/20/hello-world/"/>
    <url>/2024/10/20/hello-world/</url>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo new <span class="hljs-string">&quot;My New Post&quot;</span><br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo server<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo generate<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo deploy<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
